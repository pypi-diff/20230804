# Comparing `tmp/skypilot-nightly-1.0.0.dev20230802.tar.gz` & `tmp/skypilot-nightly-1.0.0.dev20230803.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "skypilot-nightly-1.0.0.dev20230802.tar", last modified: Wed Aug  2 10:40:55 2023, max compression
+gzip compressed data, was "skypilot-nightly-1.0.0.dev20230803.tar", last modified: Thu Aug  3 10:40:48 2023, max compression
```

## Comparing `skypilot-nightly-1.0.0.dev20230802.tar` & `skypilot-nightly-1.0.0.dev20230803.tar`

### file list

```diff
@@ -1,228 +1,241 @@
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.788892 skypilot-nightly-1.0.0.dev20230802/
--rw-r--r--   0 runner    (1001) docker     (123)    12170 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/LICENSE
--rw-r--r--   0 runner    (1001) docker     (123)      647 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/MANIFEST.in
--rw-r--r--   0 runner    (1001) docker     (123)     9467 2023-08-02 10:40:55.788892 skypilot-nightly-1.0.0.dev20230802/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (123)     8684 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/README.md
--rw-r--r--   0 runner    (1001) docker     (123)      519 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/pyproject.toml
--rw-r--r--   0 runner    (1001) docker     (123)       38 2023-08-02 10:40:55.788892 skypilot-nightly-1.0.0.dev20230802/setup.cfg
--rw-r--r--   0 runner    (1001) docker     (123)     8611 2023-08-02 10:40:46.000000 skypilot-nightly-1.0.0.dev20230802/setup.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.760892 skypilot-nightly-1.0.0.dev20230802/sky/
--rw-r--r--   0 runner    (1001) docker     (123)     2105 2023-08-02 10:40:46.000000 skypilot-nightly-1.0.0.dev20230802/sky/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.760892 skypilot-nightly-1.0.0.dev20230802/sky/adaptors/
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/adaptors/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     2607 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/adaptors/aws.py
--rw-r--r--   0 runner    (1001) docker     (123)      989 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/adaptors/azure.py
--rw-r--r--   0 runner    (1001) docker     (123)     7726 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/adaptors/cloudflare.py
--rw-r--r--   0 runner    (1001) docker     (123)      852 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/adaptors/docker.py
--rw-r--r--   0 runner    (1001) docker     (123)     2193 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/adaptors/gcp.py
--rw-r--r--   0 runner    (1001) docker     (123)     5442 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/adaptors/ibm.py
--rw-r--r--   0 runner    (1001) docker     (123)     2054 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/adaptors/oci.py
--rw-r--r--   0 runner    (1001) docker     (123)    15692 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/authentication.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.764892 skypilot-nightly-1.0.0.dev20230802/sky/backends/
--rw-r--r--   0 runner    (1001) docker     (123)      414 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/backends/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     5693 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/backends/backend.py
--rw-r--r--   0 runner    (1001) docker     (123)   114861 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/backends/backend_utils.py
--rw-r--r--   0 runner    (1001) docker     (123)   202769 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/backends/cloud_vm_ray_backend.py
--rw-r--r--   0 runner    (1001) docker     (123)     8321 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/backends/docker_utils.py
--rw-r--r--   0 runner    (1001) docker     (123)    16448 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/backends/local_docker_backend.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.764892 skypilot-nightly-1.0.0.dev20230802/sky/backends/monkey_patches/
--rw-r--r--   0 runner    (1001) docker     (123)     3410 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/backends/monkey_patches/monkey_patch_ray_up.py
--rw-r--r--   0 runner    (1001) docker     (123)    24422 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/backends/onprem_utils.py
--rw-r--r--   0 runner    (1001) docker     (123)     5903 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/backends/wheel_utils.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.764892 skypilot-nightly-1.0.0.dev20230802/sky/benchmark/
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/benchmark/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     8723 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/benchmark/benchmark_state.py
--rw-r--r--   0 runner    (1001) docker     (123)    24638 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/benchmark/benchmark_utils.py
--rw-r--r--   0 runner    (1001) docker     (123)     3814 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/check.py
--rw-r--r--   0 runner    (1001) docker     (123)   169547 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/cli.py
--rw-r--r--   0 runner    (1001) docker     (123)    11758 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/cloud_stores.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.764892 skypilot-nightly-1.0.0.dev20230802/sky/clouds/
--rw-r--r--   0 runner    (1001) docker     (123)      701 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)    39211 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/aws.py
--rw-r--r--   0 runner    (1001) docker     (123)    25872 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/azure.py
--rw-r--r--   0 runner    (1001) docker     (123)    26825 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/cloud.py
--rw-r--r--   0 runner    (1001) docker     (123)    46013 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/gcp.py
--rw-r--r--   0 runner    (1001) docker     (123)    20574 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/ibm.py
--rw-r--r--   0 runner    (1001) docker     (123)    12103 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/lambda_cloud.py
--rw-r--r--   0 runner    (1001) docker     (123)     7989 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/local.py
--rw-r--r--   0 runner    (1001) docker     (123)    24397 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/oci.py
--rw-r--r--   0 runner    (1001) docker     (123)    14994 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/scp.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.768892 skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/
--rw-r--r--   0 runner    (1001) docker     (123)    12366 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)    11756 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/aws_catalog.py
--rw-r--r--   0 runner    (1001) docker     (123)     7050 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/azure_catalog.py
--rw-r--r--   0 runner    (1001) docker     (123)    23189 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/common.py
--rw-r--r--   0 runner    (1001) docker     (123)     1500 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/config.py
--rw-r--r--   0 runner    (1001) docker     (123)      282 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/constants.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.768892 skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/data_fetchers/
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/data_fetchers/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)    20092 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/data_fetchers/fetch_aws.py
--rw-r--r--   0 runner    (1001) docker     (123)     8679 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/data_fetchers/fetch_azure.py
--rw-r--r--   0 runner    (1001) docker     (123)    18557 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py
--rw-r--r--   0 runner    (1001) docker     (123)     4198 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py
--rw-r--r--   0 runner    (1001) docker     (123)    21163 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/gcp_catalog.py
--rw-r--r--   0 runner    (1001) docker     (123)     4656 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/ibm_catalog.py
--rw-r--r--   0 runner    (1001) docker     (123)     5414 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/lambda_catalog.py
--rw-r--r--   0 runner    (1001) docker     (123)     7582 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/oci_catalog.py
--rw-r--r--   0 runner    (1001) docker     (123)     5484 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/scp_catalog.py
--rw-r--r--   0 runner    (1001) docker     (123)    40110 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/core.py
--rw-r--r--   0 runner    (1001) docker     (123)     2502 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/dag.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.768892 skypilot-nightly-1.0.0.dev20230802/sky/data/
--rw-r--r--   0 runner    (1001) docker     (123)      128 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/data/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     7384 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/data/data_transfer.py
--rw-r--r--   0 runner    (1001) docker     (123)    21399 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/data/data_utils.py
--rw-r--r--   0 runner    (1001) docker     (123)     3251 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/data/mounting_utils.py
--rw-r--r--   0 runner    (1001) docker     (123)   110767 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/data/storage.py
--rw-r--r--   0 runner    (1001) docker     (123)     6807 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/data/storage_utils.py
--rw-r--r--   0 runner    (1001) docker     (123)     6111 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/exceptions.py
--rw-r--r--   0 runner    (1001) docker     (123)    41456 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/execution.py
--rw-r--r--   0 runner    (1001) docker     (123)    26274 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/global_user_state.py
--rw-r--r--   0 runner    (1001) docker     (123)    43765 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/optimizer.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.768892 skypilot-nightly-1.0.0.dev20230802/sky/provision/
--rw-r--r--   0 runner    (1001) docker     (123)     2111 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/provision/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.768892 skypilot-nightly-1.0.0.dev20230802/sky/provision/aws/
--rw-r--r--   0 runner    (1001) docker     (123)      186 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/provision/aws/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     6744 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/provision/aws/instance.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.772892 skypilot-nightly-1.0.0.dev20230802/sky/provision/gcp/
--rw-r--r--   0 runner    (1001) docker     (123)      127 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/provision/gcp/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     6361 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/provision/gcp/instance.py
--rw-r--r--   0 runner    (1001) docker     (123)     9598 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/provision/gcp/instance_utils.py
--rw-r--r--   0 runner    (1001) docker     (123)    46508 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/resources.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.772892 skypilot-nightly-1.0.0.dev20230802/sky/setup_files/
--rw-r--r--   0 runner    (1001) docker     (123)      647 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/setup_files/MANIFEST.in
--rw-r--r--   0 runner    (1001) docker     (123)     8611 2023-08-02 10:40:46.000000 skypilot-nightly-1.0.0.dev20230802/sky/setup_files/setup.py
--rw-r--r--   0 runner    (1001) docker     (123)     3216 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/sky_logging.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.772892 skypilot-nightly-1.0.0.dev20230802/sky/skylet/
--rw-r--r--   0 runner    (1001) docker     (123)    12568 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/LICENSE
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     1203 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/attempt_skylet.py
--rw-r--r--   0 runner    (1001) docker     (123)     4378 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/autostop_lib.py
--rw-r--r--   0 runner    (1001) docker     (123)     1887 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/configs.py
--rw-r--r--   0 runner    (1001) docker     (123)     3101 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/constants.py
--rw-r--r--   0 runner    (1001) docker     (123)    10619 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/events.py
--rw-r--r--   0 runner    (1001) docker     (123)    32722 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/job_lib.py
--rw-r--r--   0 runner    (1001) docker     (123)    19585 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/log_lib.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.756892 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.772892 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/aws/
--rw-r--r--   0 runner    (1001) docker     (123)      110 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/aws/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.772892 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/aws/cloudwatch/
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/aws/cloudwatch/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)    32698 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/aws/cloudwatch/cloudwatch_helper.py
--rw-r--r--   0 runner    (1001) docker     (123)    53219 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/aws/config.py
--rw-r--r--   0 runner    (1001) docker     (123)    29406 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/aws/node_provider.py
--rw-r--r--   0 runner    (1001) docker     (123)     5917 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/aws/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.772892 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/azure/
--rw-r--r--   0 runner    (1001) docker     (123)       97 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/azure/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     4344 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/azure/azure-config-template.json
--rw-r--r--   0 runner    (1001) docker     (123)    10633 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/azure/azure-vm-template.json
--rw-r--r--   0 runner    (1001) docker     (123)     5020 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/azure/config.py
--rw-r--r--   0 runner    (1001) docker     (123)    17469 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/azure/node_provider.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.776892 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/gcp/
--rw-r--r--   0 runner    (1001) docker     (123)       91 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/gcp/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)    37475 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/gcp/config.py
--rw-r--r--   0 runner    (1001) docker     (123)     4118 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/gcp/constants.py
--rw-r--r--   0 runner    (1001) docker     (123)    26192 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/gcp/node.py
--rw-r--r--   0 runner    (1001) docker     (123)    14292 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/gcp/node_provider.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.776892 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/ibm/
--rw-r--r--   0 runner    (1001) docker     (123)       94 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/ibm/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)    38280 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/ibm/node_provider.py
--rw-r--r--   0 runner    (1001) docker     (123)     1292 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/ibm/utils.py
--rw-r--r--   0 runner    (1001) docker     (123)    34628 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/ibm/vpc_provider.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.776892 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/lambda_cloud/
--rw-r--r--   0 runner    (1001) docker     (123)      112 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/lambda_cloud/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     9766 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/lambda_cloud/lambda_utils.py
--rw-r--r--   0 runner    (1001) docker     (123)    13650 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/lambda_cloud/node_provider.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.776892 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/oci/
--rw-r--r--   0 runner    (1001) docker     (123)       91 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/oci/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     4234 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/oci/config.py
--rw-r--r--   0 runner    (1001) docker     (123)    20136 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/oci/node_provider.py
--rw-r--r--   0 runner    (1001) docker     (123)    17048 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/oci/query_helper.py
--rw-r--r--   0 runner    (1001) docker     (123)      508 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/oci/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.776892 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/scp/
--rw-r--r--   0 runner    (1001) docker     (123)       91 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/scp/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     4683 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/scp/config.py
--rw-r--r--   0 runner    (1001) docker     (123)    22219 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/scp/node_provider.py
--rw-r--r--   0 runner    (1001) docker     (123)    15481 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/scp/scp_utils.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.780892 skypilot-nightly-1.0.0.dev20230802/sky/skylet/ray_patches/
--rw-r--r--   0 runner    (1001) docker     (123)     2904 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/ray_patches/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)      294 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/ray_patches/autoscaler.py.patch
--rw-r--r--   0 runner    (1001) docker     (123)      391 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/ray_patches/cli.py.patch
--rw-r--r--   0 runner    (1001) docker     (123)      224 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/ray_patches/command_runner.py.patch
--rw-r--r--   0 runner    (1001) docker     (123)      345 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/ray_patches/job_head.py.patch
--rw-r--r--   0 runner    (1001) docker     (123)      528 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/ray_patches/log_monitor.py.patch
--rw-r--r--   0 runner    (1001) docker     (123)      658 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/ray_patches/resource_demand_scheduler.py.patch
--rw-r--r--   0 runner    (1001) docker     (123)      289 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/ray_patches/updater.py.patch
--rw-r--r--   0 runner    (1001) docker     (123)      565 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/ray_patches/worker.py.patch
--rw-r--r--   0 runner    (1001) docker     (123)      788 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/skylet.py
--rw-r--r--   0 runner    (1001) docker     (123)     2649 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/subprocess_daemon.py
--rw-r--r--   0 runner    (1001) docker     (123)     5654 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skypilot_config.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.780892 skypilot-nightly-1.0.0.dev20230802/sky/spot/
--rw-r--r--   0 runner    (1001) docker     (123)     1356 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/spot/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)      881 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/spot/constants.py
--rw-r--r--   0 runner    (1001) docker     (123)    26791 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/spot/controller.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.780892 skypilot-nightly-1.0.0.dev20230802/sky/spot/dashboard/
--rw-r--r--   0 runner    (1001) docker     (123)     2294 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/spot/dashboard/dashboard.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.780892 skypilot-nightly-1.0.0.dev20230802/sky/spot/dashboard/static/
--rw-r--r--   0 runner    (1001) docker     (123)    15086 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/spot/dashboard/static/favicon.ico
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.780892 skypilot-nightly-1.0.0.dev20230802/sky/spot/dashboard/templates/
--rw-r--r--   0 runner    (1001) docker     (123)     6247 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/spot/dashboard/templates/index.html
--rw-r--r--   0 runner    (1001) docker     (123)    21311 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/spot/recovery_strategy.py
--rw-r--r--   0 runner    (1001) docker     (123)    22484 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/spot/spot_state.py
--rw-r--r--   0 runner    (1001) docker     (123)    34333 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/spot/spot_utils.py
--rw-r--r--   0 runner    (1001) docker     (123)     1457 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/status_lib.py
--rw-r--r--   0 runner    (1001) docker     (123)    39296 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/task.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.784892 skypilot-nightly-1.0.0.dev20230802/sky/templates/
--rw-r--r--   0 runner    (1001) docker     (123)    10985 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/templates/aws-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (123)     8870 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/templates/azure-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (123)    11988 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/templates/gcp-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (123)      505 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/templates/gcp-tpu-create.sh.j2
--rw-r--r--   0 runner    (1001) docker     (123)      328 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/templates/gcp-tpu-delete.sh.j2
--rw-r--r--   0 runner    (1001) docker     (123)     7215 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/templates/ibm-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (123)     6309 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/templates/lambda-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (123)     1176 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/templates/local-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (123)     7593 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/templates/oci-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (123)     6178 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/templates/scp-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (123)     2185 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/templates/spot-controller.yaml.j2
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.784892 skypilot-nightly-1.0.0.dev20230802/sky/usage/
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/usage/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)      633 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/usage/constants.py
--rw-r--r--   0 runner    (1001) docker     (123)    17294 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/usage/usage_lib.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.784892 skypilot-nightly-1.0.0.dev20230802/sky/utils/
--rw-r--r--   0 runner    (1001) docker     (123)       25 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/utils/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     2806 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/utils/accelerator_registry.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.784892 skypilot-nightly-1.0.0.dev20230802/sky/utils/cli_utils/
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/utils/cli_utils/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)    15219 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/utils/cli_utils/status_utils.py
--rw-r--r--   0 runner    (1001) docker     (123)    14688 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/utils/command_runner.py
--rw-r--r--   0 runner    (1001) docker     (123)    12344 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/utils/common_utils.py
--rw-r--r--   0 runner    (1001) docker     (123)     2941 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/utils/dag_utils.py
--rw-r--r--   0 runner    (1001) docker     (123)     2777 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/utils/db_utils.py
--rw-r--r--   0 runner    (1001) docker     (123)      852 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/utils/env_options.py
--rw-r--r--   0 runner    (1001) docker     (123)     4962 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/utils/log_utils.py
--rw-r--r--   0 runner    (1001) docker     (123)     7208 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/utils/schemas.py
--rw-r--r--   0 runner    (1001) docker     (123)     5774 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/utils/subprocess_utils.py
--rw-r--r--   0 runner    (1001) docker     (123)     3965 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/utils/timeline.py
--rw-r--r--   0 runner    (1001) docker     (123)     2737 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/utils/tpu_utils.py
--rw-r--r--   0 runner    (1001) docker     (123)     1125 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/utils/ux_utils.py
--rw-r--r--   0 runner    (1001) docker     (123)      701 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/utils/validator.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.784892 skypilot-nightly-1.0.0.dev20230802/skypilot_nightly.egg-info/
--rw-r--r--   0 runner    (1001) docker     (123)     9467 2023-08-02 10:40:55.000000 skypilot-nightly-1.0.0.dev20230802/skypilot_nightly.egg-info/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (123)     5790 2023-08-02 10:40:55.000000 skypilot-nightly-1.0.0.dev20230802/skypilot_nightly.egg-info/SOURCES.txt
--rw-r--r--   0 runner    (1001) docker     (123)        1 2023-08-02 10:40:55.000000 skypilot-nightly-1.0.0.dev20230802/skypilot_nightly.egg-info/dependency_links.txt
--rw-r--r--   0 runner    (1001) docker     (123)       36 2023-08-02 10:40:55.000000 skypilot-nightly-1.0.0.dev20230802/skypilot_nightly.egg-info/entry_points.txt
--rw-r--r--   0 runner    (1001) docker     (123)     1472 2023-08-02 10:40:55.000000 skypilot-nightly-1.0.0.dev20230802/skypilot_nightly.egg-info/requires.txt
--rw-r--r--   0 runner    (1001) docker     (123)        4 2023-08-02 10:40:55.000000 skypilot-nightly-1.0.0.dev20230802/skypilot_nightly.egg-info/top_level.txt
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.788892 skypilot-nightly-1.0.0.dev20230802/tests/
--rw-r--r--   0 runner    (1001) docker     (123)     4730 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/tests/test_cli.py
--rw-r--r--   0 runner    (1001) docker     (123)     5061 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/tests/test_config.py
--rw-r--r--   0 runner    (1001) docker     (123)      260 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/tests/test_global_user_state.py
--rw-r--r--   0 runner    (1001) docker     (123)     5943 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/tests/test_jobs.py
--rw-r--r--   0 runner    (1001) docker     (123)     3620 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/tests/test_list_accelerators.py
--rw-r--r--   0 runner    (1001) docker     (123)    14008 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/tests/test_onprem.py
--rw-r--r--   0 runner    (1001) docker     (123)    22937 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/tests/test_optimizer_dryruns.py
--rw-r--r--   0 runner    (1001) docker     (123)     4663 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/tests/test_optimizer_random_dag.py
--rw-r--r--   0 runner    (1001) docker     (123)       94 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/tests/test_pycryptodome_version.py
--rw-r--r--   0 runner    (1001) docker     (123)   140883 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/tests/test_smoke.py
--rw-r--r--   0 runner    (1001) docker     (123)     7215 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/tests/test_spot.py
--rw-r--r--   0 runner    (1001) docker     (123)     4048 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/tests/test_storage.py
--rw-r--r--   0 runner    (1001) docker     (123)     1070 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/tests/test_wheels.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-03 10:40:48.280140 skypilot-nightly-1.0.0.dev20230803/
+-rw-r--r--   0 runner    (1001) docker     (123)    12170 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/LICENSE
+-rw-r--r--   0 runner    (1001) docker     (123)      720 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/MANIFEST.in
+-rw-r--r--   0 runner    (1001) docker     (123)     9591 2023-08-03 10:40:48.280140 skypilot-nightly-1.0.0.dev20230803/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (123)     8781 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/README.md
+-rw-r--r--   0 runner    (1001) docker     (123)      519 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/pyproject.toml
+-rw-r--r--   0 runner    (1001) docker     (123)       38 2023-08-03 10:40:48.280140 skypilot-nightly-1.0.0.dev20230803/setup.cfg
+-rw-r--r--   0 runner    (1001) docker     (123)     8645 2023-08-03 10:40:36.000000 skypilot-nightly-1.0.0.dev20230803/setup.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-03 10:40:48.240140 skypilot-nightly-1.0.0.dev20230803/sky/
+-rw-r--r--   0 runner    (1001) docker     (123)     2154 2023-08-03 10:40:36.000000 skypilot-nightly-1.0.0.dev20230803/sky/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-03 10:40:48.240140 skypilot-nightly-1.0.0.dev20230803/sky/adaptors/
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/adaptors/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2607 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/adaptors/aws.py
+-rw-r--r--   0 runner    (1001) docker     (123)      989 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/adaptors/azure.py
+-rw-r--r--   0 runner    (1001) docker     (123)     7726 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/adaptors/cloudflare.py
+-rw-r--r--   0 runner    (1001) docker     (123)      852 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/adaptors/docker.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2193 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/adaptors/gcp.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5442 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/adaptors/ibm.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3964 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/adaptors/kubernetes.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2054 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/adaptors/oci.py
+-rw-r--r--   0 runner    (1001) docker     (123)    16982 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/authentication.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-03 10:40:48.244140 skypilot-nightly-1.0.0.dev20230803/sky/backends/
+-rw-r--r--   0 runner    (1001) docker     (123)      414 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/backends/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5693 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/backends/backend.py
+-rw-r--r--   0 runner    (1001) docker     (123)   116682 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/backends/backend_utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)   207126 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/backends/cloud_vm_ray_backend.py
+-rw-r--r--   0 runner    (1001) docker     (123)     8321 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/backends/docker_utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)    16448 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/backends/local_docker_backend.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-03 10:40:48.244140 skypilot-nightly-1.0.0.dev20230803/sky/backends/monkey_patches/
+-rw-r--r--   0 runner    (1001) docker     (123)     3410 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/backends/monkey_patches/monkey_patch_ray_up.py
+-rw-r--r--   0 runner    (1001) docker     (123)    24438 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/backends/onprem_utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5903 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/backends/wheel_utils.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-03 10:40:48.244140 skypilot-nightly-1.0.0.dev20230803/sky/benchmark/
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/benchmark/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     8723 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/benchmark/benchmark_state.py
+-rw-r--r--   0 runner    (1001) docker     (123)    24638 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/benchmark/benchmark_utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3814 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/check.py
+-rw-r--r--   0 runner    (1001) docker     (123)   173874 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/cli.py
+-rw-r--r--   0 runner    (1001) docker     (123)    11758 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/cloud_stores.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-03 10:40:48.248140 skypilot-nightly-1.0.0.dev20230803/sky/clouds/
+-rw-r--r--   0 runner    (1001) docker     (123)      764 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/clouds/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)    39211 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/clouds/aws.py
+-rw-r--r--   0 runner    (1001) docker     (123)    25872 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/clouds/azure.py
+-rw-r--r--   0 runner    (1001) docker     (123)    26964 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/clouds/cloud.py
+-rw-r--r--   0 runner    (1001) docker     (123)    46013 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/clouds/gcp.py
+-rw-r--r--   0 runner    (1001) docker     (123)    20574 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/clouds/ibm.py
+-rw-r--r--   0 runner    (1001) docker     (123)    16936 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/clouds/kubernetes.py
+-rw-r--r--   0 runner    (1001) docker     (123)    12103 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/clouds/lambda_cloud.py
+-rw-r--r--   0 runner    (1001) docker     (123)     7989 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/clouds/local.py
+-rw-r--r--   0 runner    (1001) docker     (123)    24397 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/clouds/oci.py
+-rw-r--r--   0 runner    (1001) docker     (123)    14994 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/clouds/scp.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-03 10:40:48.248140 skypilot-nightly-1.0.0.dev20230803/sky/clouds/service_catalog/
+-rw-r--r--   0 runner    (1001) docker     (123)    12366 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/clouds/service_catalog/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)    11756 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/clouds/service_catalog/aws_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (123)     7050 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/clouds/service_catalog/azure_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (123)    23189 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/clouds/service_catalog/common.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1500 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/clouds/service_catalog/config.py
+-rw-r--r--   0 runner    (1001) docker     (123)      282 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/clouds/service_catalog/constants.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-03 10:40:48.252140 skypilot-nightly-1.0.0.dev20230803/sky/clouds/service_catalog/data_fetchers/
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/clouds/service_catalog/data_fetchers/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)    20092 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/clouds/service_catalog/data_fetchers/fetch_aws.py
+-rw-r--r--   0 runner    (1001) docker     (123)     8679 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/clouds/service_catalog/data_fetchers/fetch_azure.py
+-rw-r--r--   0 runner    (1001) docker     (123)    18557 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py
+-rw-r--r--   0 runner    (1001) docker     (123)     4198 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py
+-rw-r--r--   0 runner    (1001) docker     (123)    21163 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/clouds/service_catalog/gcp_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (123)     4656 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/clouds/service_catalog/ibm_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5414 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/clouds/service_catalog/lambda_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (123)     7582 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/clouds/service_catalog/oci_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5484 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/clouds/service_catalog/scp_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (123)    40110 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/core.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2502 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/dag.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-03 10:40:48.252140 skypilot-nightly-1.0.0.dev20230803/sky/data/
+-rw-r--r--   0 runner    (1001) docker     (123)      128 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/data/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     7384 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/data/data_transfer.py
+-rw-r--r--   0 runner    (1001) docker     (123)    21399 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/data/data_utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3251 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/data/mounting_utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)   110767 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/data/storage.py
+-rw-r--r--   0 runner    (1001) docker     (123)     6807 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/data/storage_utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)     6111 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/exceptions.py
+-rw-r--r--   0 runner    (1001) docker     (123)    41456 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/execution.py
+-rw-r--r--   0 runner    (1001) docker     (123)    26274 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/global_user_state.py
+-rw-r--r--   0 runner    (1001) docker     (123)    43765 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/optimizer.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-03 10:40:48.252140 skypilot-nightly-1.0.0.dev20230803/sky/provision/
+-rw-r--r--   0 runner    (1001) docker     (123)     2111 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/provision/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-03 10:40:48.252140 skypilot-nightly-1.0.0.dev20230803/sky/provision/aws/
+-rw-r--r--   0 runner    (1001) docker     (123)      186 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/provision/aws/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     6744 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/provision/aws/instance.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-03 10:40:48.252140 skypilot-nightly-1.0.0.dev20230803/sky/provision/gcp/
+-rw-r--r--   0 runner    (1001) docker     (123)      127 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/provision/gcp/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     6361 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/provision/gcp/instance.py
+-rw-r--r--   0 runner    (1001) docker     (123)     9598 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/provision/gcp/instance_utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)    46508 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/resources.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-03 10:40:48.252140 skypilot-nightly-1.0.0.dev20230803/sky/setup_files/
+-rw-r--r--   0 runner    (1001) docker     (123)      720 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/setup_files/MANIFEST.in
+-rw-r--r--   0 runner    (1001) docker     (123)     8645 2023-08-03 10:40:36.000000 skypilot-nightly-1.0.0.dev20230803/sky/setup_files/setup.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3216 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/sky_logging.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-03 10:40:48.256140 skypilot-nightly-1.0.0.dev20230803/sky/skylet/
+-rw-r--r--   0 runner    (1001) docker     (123)    12568 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/LICENSE
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1203 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/attempt_skylet.py
+-rw-r--r--   0 runner    (1001) docker     (123)     4378 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/autostop_lib.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1887 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/configs.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3101 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/constants.py
+-rw-r--r--   0 runner    (1001) docker     (123)    10619 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/events.py
+-rw-r--r--   0 runner    (1001) docker     (123)    32722 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/job_lib.py
+-rw-r--r--   0 runner    (1001) docker     (123)    19585 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/log_lib.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-03 10:40:48.232139 skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-03 10:40:48.256140 skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/aws/
+-rw-r--r--   0 runner    (1001) docker     (123)      110 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/aws/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-03 10:40:48.256140 skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/aws/cloudwatch/
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/aws/cloudwatch/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)    32698 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/aws/cloudwatch/cloudwatch_helper.py
+-rw-r--r--   0 runner    (1001) docker     (123)    53219 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/aws/config.py
+-rw-r--r--   0 runner    (1001) docker     (123)    29406 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/aws/node_provider.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5917 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/aws/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-03 10:40:48.260140 skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/azure/
+-rw-r--r--   0 runner    (1001) docker     (123)       97 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/azure/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     4344 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/azure/azure-config-template.json
+-rw-r--r--   0 runner    (1001) docker     (123)    10633 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/azure/azure-vm-template.json
+-rw-r--r--   0 runner    (1001) docker     (123)     5020 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/azure/config.py
+-rw-r--r--   0 runner    (1001) docker     (123)    17469 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/azure/node_provider.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-03 10:40:48.260140 skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/gcp/
+-rw-r--r--   0 runner    (1001) docker     (123)       91 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/gcp/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)    37472 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/gcp/config.py
+-rw-r--r--   0 runner    (1001) docker     (123)     4118 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/gcp/constants.py
+-rw-r--r--   0 runner    (1001) docker     (123)    26192 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/gcp/node.py
+-rw-r--r--   0 runner    (1001) docker     (123)    14292 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/gcp/node_provider.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-03 10:40:48.260140 skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/ibm/
+-rw-r--r--   0 runner    (1001) docker     (123)       94 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/ibm/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)    38280 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/ibm/node_provider.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1292 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/ibm/utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)    34628 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/ibm/vpc_provider.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-03 10:40:48.260140 skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/kubernetes/
+-rw-r--r--   0 runner    (1001) docker     (123)      159 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/kubernetes/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)    11154 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/kubernetes/config.py
+-rw-r--r--   0 runner    (1001) docker     (123)    13611 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/kubernetes/node_provider.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3560 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/kubernetes/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-03 10:40:48.260140 skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/lambda_cloud/
+-rw-r--r--   0 runner    (1001) docker     (123)      112 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/lambda_cloud/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     9766 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/lambda_cloud/lambda_utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)    13650 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/lambda_cloud/node_provider.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-03 10:40:48.264140 skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/oci/
+-rw-r--r--   0 runner    (1001) docker     (123)       91 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/oci/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     4234 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/oci/config.py
+-rw-r--r--   0 runner    (1001) docker     (123)    20136 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/oci/node_provider.py
+-rw-r--r--   0 runner    (1001) docker     (123)    17048 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/oci/query_helper.py
+-rw-r--r--   0 runner    (1001) docker     (123)      508 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/oci/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-03 10:40:48.264140 skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/scp/
+-rw-r--r--   0 runner    (1001) docker     (123)       91 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/scp/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     4683 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/scp/config.py
+-rw-r--r--   0 runner    (1001) docker     (123)    22219 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/scp/node_provider.py
+-rw-r--r--   0 runner    (1001) docker     (123)    15481 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/scp/scp_utils.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-03 10:40:48.264140 skypilot-nightly-1.0.0.dev20230803/sky/skylet/ray_patches/
+-rw-r--r--   0 runner    (1001) docker     (123)     2904 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/ray_patches/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)      294 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/ray_patches/autoscaler.py.patch
+-rw-r--r--   0 runner    (1001) docker     (123)      391 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/ray_patches/cli.py.patch
+-rw-r--r--   0 runner    (1001) docker     (123)      224 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/ray_patches/command_runner.py.patch
+-rw-r--r--   0 runner    (1001) docker     (123)      345 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/ray_patches/job_head.py.patch
+-rw-r--r--   0 runner    (1001) docker     (123)      528 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/ray_patches/log_monitor.py.patch
+-rw-r--r--   0 runner    (1001) docker     (123)      658 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/ray_patches/resource_demand_scheduler.py.patch
+-rw-r--r--   0 runner    (1001) docker     (123)      289 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/ray_patches/updater.py.patch
+-rw-r--r--   0 runner    (1001) docker     (123)      565 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/ray_patches/worker.py.patch
+-rw-r--r--   0 runner    (1001) docker     (123)      788 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/skylet.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2649 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skylet/subprocess_daemon.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5654 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/skypilot_config.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-03 10:40:48.268140 skypilot-nightly-1.0.0.dev20230803/sky/spot/
+-rw-r--r--   0 runner    (1001) docker     (123)     1356 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/spot/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)      881 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/spot/constants.py
+-rw-r--r--   0 runner    (1001) docker     (123)    26791 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/spot/controller.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-03 10:40:48.268140 skypilot-nightly-1.0.0.dev20230803/sky/spot/dashboard/
+-rw-r--r--   0 runner    (1001) docker     (123)     2294 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/spot/dashboard/dashboard.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-03 10:40:48.268140 skypilot-nightly-1.0.0.dev20230803/sky/spot/dashboard/static/
+-rw-r--r--   0 runner    (1001) docker     (123)    15086 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/spot/dashboard/static/favicon.ico
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-03 10:40:48.268140 skypilot-nightly-1.0.0.dev20230803/sky/spot/dashboard/templates/
+-rw-r--r--   0 runner    (1001) docker     (123)     6247 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/spot/dashboard/templates/index.html
+-rw-r--r--   0 runner    (1001) docker     (123)    21311 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/spot/recovery_strategy.py
+-rw-r--r--   0 runner    (1001) docker     (123)    22484 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/spot/spot_state.py
+-rw-r--r--   0 runner    (1001) docker     (123)    34333 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/spot/spot_utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1457 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/status_lib.py
+-rw-r--r--   0 runner    (1001) docker     (123)    39296 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/task.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-03 10:40:48.272140 skypilot-nightly-1.0.0.dev20230803/sky/templates/
+-rw-r--r--   0 runner    (1001) docker     (123)    10985 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/templates/aws-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (123)     8870 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/templates/azure-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (123)    11988 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/templates/gcp-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (123)      505 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/templates/gcp-tpu-create.sh.j2
+-rw-r--r--   0 runner    (1001) docker     (123)      328 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/templates/gcp-tpu-delete.sh.j2
+-rw-r--r--   0 runner    (1001) docker     (123)     7215 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/templates/ibm-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (123)    15341 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/templates/kubernetes-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (123)     6309 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/templates/lambda-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (123)     1176 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/templates/local-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (123)     7593 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/templates/oci-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (123)     6178 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/templates/scp-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (123)     2185 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/templates/spot-controller.yaml.j2
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-03 10:40:48.272140 skypilot-nightly-1.0.0.dev20230803/sky/usage/
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/usage/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)      633 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/usage/constants.py
+-rw-r--r--   0 runner    (1001) docker     (123)    17294 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/usage/usage_lib.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-03 10:40:48.276140 skypilot-nightly-1.0.0.dev20230803/sky/utils/
+-rw-r--r--   0 runner    (1001) docker     (123)       95 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/utils/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2806 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/utils/accelerator_registry.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-03 10:40:48.276140 skypilot-nightly-1.0.0.dev20230803/sky/utils/cli_utils/
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/utils/cli_utils/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)    15219 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/utils/cli_utils/status_utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)    15075 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/utils/command_runner.py
+-rw-r--r--   0 runner    (1001) docker     (123)    12344 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/utils/common_utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2941 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/utils/dag_utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2777 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/utils/db_utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)      852 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/utils/env_options.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-03 10:40:48.276140 skypilot-nightly-1.0.0.dev20230803/sky/utils/kubernetes/
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/utils/kubernetes/__init__.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)     1788 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/utils/kubernetes/create_cluster.sh
+-rwxr-xr-x   0 runner    (1001) docker     (123)      927 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/utils/kubernetes/delete_cluster.sh
+-rw-r--r--   0 runner    (1001) docker     (123)     2417 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/utils/kubernetes/generate_kind_config.py
+-rw-r--r--   0 runner    (1001) docker     (123)     4962 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/utils/log_utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)     7208 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/utils/schemas.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5774 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/utils/subprocess_utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3965 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/utils/timeline.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2737 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/utils/tpu_utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1125 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/utils/ux_utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)      701 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/sky/utils/validator.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-03 10:40:48.276140 skypilot-nightly-1.0.0.dev20230803/skypilot_nightly.egg-info/
+-rw-r--r--   0 runner    (1001) docker     (123)     9591 2023-08-03 10:40:48.000000 skypilot-nightly-1.0.0.dev20230803/skypilot_nightly.egg-info/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (123)     6210 2023-08-03 10:40:48.000000 skypilot-nightly-1.0.0.dev20230803/skypilot_nightly.egg-info/SOURCES.txt
+-rw-r--r--   0 runner    (1001) docker     (123)        1 2023-08-03 10:40:48.000000 skypilot-nightly-1.0.0.dev20230803/skypilot_nightly.egg-info/dependency_links.txt
+-rw-r--r--   0 runner    (1001) docker     (123)       36 2023-08-03 10:40:48.000000 skypilot-nightly-1.0.0.dev20230803/skypilot_nightly.egg-info/entry_points.txt
+-rw-r--r--   0 runner    (1001) docker     (123)     1508 2023-08-03 10:40:48.000000 skypilot-nightly-1.0.0.dev20230803/skypilot_nightly.egg-info/requires.txt
+-rw-r--r--   0 runner    (1001) docker     (123)        4 2023-08-03 10:40:48.000000 skypilot-nightly-1.0.0.dev20230803/skypilot_nightly.egg-info/top_level.txt
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-03 10:40:48.280140 skypilot-nightly-1.0.0.dev20230803/tests/
+-rw-r--r--   0 runner    (1001) docker     (123)     4730 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/tests/test_cli.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5061 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/tests/test_config.py
+-rw-r--r--   0 runner    (1001) docker     (123)      260 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/tests/test_global_user_state.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5943 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/tests/test_jobs.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3620 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/tests/test_list_accelerators.py
+-rw-r--r--   0 runner    (1001) docker     (123)    14008 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/tests/test_onprem.py
+-rw-r--r--   0 runner    (1001) docker     (123)    22937 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/tests/test_optimizer_dryruns.py
+-rw-r--r--   0 runner    (1001) docker     (123)     4663 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/tests/test_optimizer_random_dag.py
+-rw-r--r--   0 runner    (1001) docker     (123)       94 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/tests/test_pycryptodome_version.py
+-rw-r--r--   0 runner    (1001) docker     (123)   145911 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/tests/test_smoke.py
+-rw-r--r--   0 runner    (1001) docker     (123)     7215 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/tests/test_spot.py
+-rw-r--r--   0 runner    (1001) docker     (123)     4048 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/tests/test_storage.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1070 2023-08-03 10:40:27.000000 skypilot-nightly-1.0.0.dev20230803/tests/test_wheels.py
```

### Comparing `skypilot-nightly-1.0.0.dev20230802/LICENSE` & `skypilot-nightly-1.0.0.dev20230803/LICENSE`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/MANIFEST.in` & `skypilot-nightly-1.0.0.dev20230803/MANIFEST.in`

 * *Files 14% similar despite different names*

```diff
@@ -3,16 +3,18 @@
 include sky/setup_files/*
 include sky/skylet/*.sh
 include sky/skylet/LICENSE
 include sky/skylet/providers/aws/*
 include sky/skylet/providers/aws/cloudwatch/*
 include sky/skylet/providers/azure/*
 include sky/skylet/providers/gcp/*
-include sky/skylet/providers/lambda_cloud/*
 include sky/skylet/providers/ibm/*
-include sky/skylet/providers/scp/*
+include sky/skylet/providers/kubernetes/*
+include sky/skylet/providers/lambda_cloud/*
 include sky/skylet/providers/oci/*
+include sky/skylet/providers/scp/*
 include sky/skylet/ray_patches/*.patch
 include sky/spot/dashboard/*
 include sky/spot/dashboard/templates/*
 include sky/spot/dashboard/static/*
 include sky/templates/*
+include sky/utils/kubernetes/*
```

### Comparing `skypilot-nightly-1.0.0.dev20230802/PKG-INFO` & `skypilot-nightly-1.0.0.dev20230803/PKG-INFO`

 * *Files 4% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: skypilot-nightly
-Version: 1.0.0.dev20230802
+Version: 1.0.0.dev20230803
 Summary: SkyPilot: An intercloud broker for the clouds
 Author: SkyPilot Team
 License: Apache 2.0
 Project-URL: Homepage, https://github.com/skypilot-org/skypilot
 Project-URL: Issues, https://github.com/skypilot-org/skypilot/issues
 Project-URL: Discussion, https://github.com/skypilot-org/skypilot/discussions
 Project-URL: Documentation, https://skypilot.readthedocs.io/en/latest/
@@ -22,14 +22,15 @@
 Provides-Extra: gcp
 Provides-Extra: ibm
 Provides-Extra: docker
 Provides-Extra: lambda
 Provides-Extra: cloudflare
 Provides-Extra: scp
 Provides-Extra: oci
+Provides-Extra: kubernetes
 Provides-Extra: all
 License-File: LICENSE
 
 <p align="center">
   <img alt="SkyPilot" src="https://raw.githubusercontent.com/skypilot-org/skypilot/master/docs/source/images/skypilot-wide-light-1k.png" width=55%>
 </p>
 
@@ -51,20 +52,20 @@
 
 <h3 align="center">
     Run LLMs and AI on Any Cloud
 </h3>
 
 ----
 :fire: *News* :fire:
-- [July, 2023] Self-Hosted **LLaMA 2 Chatbot** on Any Cloud: [**example**](./llm/llama-2/)
+- [Aug, 2023] New cookbook: Finetuning Llama 2 in your own cloud environment, privately: [**example**](./llm/vicuna-llama-2/), [**blog post**](https://blog.skypilot.co/finetuning-llama2-operational-guide/)
+- [July, 2023] Self-Hosted **Llama-2 Chatbot** on Any Cloud: [**example**](./llm/llama-2/)
 - [June, 2023] Serving LLM **24x Faster On the Cloud** with vLLM and SkyPilot: [**example**](./llm/vllm/), [**blog post**](https://blog.skypilot.co/serving-llm-24x-faster-on-the-cloud-with-vllm-and-skypilot/)
 - [June, 2023] [**Two new clouds supported**](https://skypilot.readthedocs.io/en/latest/getting-started/installation.html): Samsung SCP and Oracle OCI!
 - [April, 2023] **[**SkyPilot YAMLs released**](./llm/vicuna/) for finetuning & serving the Vicuna model with a single command**!
 - [March, 2023] **[Vicuna LLM chatbot](https://lmsys.org/blog/2023-03-30-vicuna/) trained** [**using SkyPilot**](./llm/vicuna/) **for $300 on spot instances!** 
-- [March, 2023] Serve your own LLaMA LLM chatbot (not finetuned) on any cloud: [**example**](./llm/llama-chatbots/), [**repo**](https://github.com/skypilot-org/sky-llama)
 ----
 
 SkyPilot is a framework for running LLMs, AI, and batch jobs on any cloud, offering maximum cost savings, highest GPU availability, and managed execution.
 
 SkyPilot **abstracts away cloud infra burdens**:
 - Launch jobs & clusters on any cloud 
 - Easy scale-out: queue and run many jobs, automatically managed
@@ -152,15 +153,16 @@
 Refer to [Quickstart](https://skypilot.readthedocs.io/en/latest/getting-started/quickstart.html) to get started with SkyPilot.
 
 ## More Information
 To learn more, see our [Documentation](https://skypilot.readthedocs.io/en/latest/) and [Tutorials](https://github.com/skypilot-org/skypilot-tutorial).
 
 Runnable examples:
 - LLMs on SkyPilot
-  - [Self-Hosted LLaMA 2 Chatbot](./llm/llama-2/)
+  - [Train Your Own Vicuna on Llama-2](./llm/vicuna-llama-2/)
+  - [Self-Hosted Llama-2 Chatbot](./llm/llama-2/)
   - [Vicuna chatbots: Training & Serving](./llm/vicuna/) (from official Vicuna team)
   - [vLLM: Serving LLM 24x Faster On the Cloud](./llm/vllm/) (from official vLLM team)
   - [QLoRA](https://github.com/artidoro/qlora/pull/132)
   - [LLaMA-LoRA-Tuner](https://github.com/zetavg/LLaMA-LoRA-Tuner#run-on-a-cloud-service-via-skypilot)
   - [Tabby: Self-hosted AI coding assistant](https://github.com/TabbyML/tabby/blob/bed723fcedb44a6b867ce22a7b1f03d2f3531c1e/experimental/eval/skypilot.yaml)
   - [LocalGPT](./llm/localgpt)
   - Add yours here & see more in [`llm/`](./llm)!
```

#### html2text {}

```diff
@@ -1,56 +1,56 @@
-Metadata-Version: 2.1 Name: skypilot-nightly Version: 1.0.0.dev20230802
+Metadata-Version: 2.1 Name: skypilot-nightly Version: 1.0.0.dev20230803
 Summary: SkyPilot: An intercloud broker for the clouds Author: SkyPilot Team
 License: Apache 2.0 Project-URL: Homepage, https://github.com/skypilot-org/
 skypilot Project-URL: Issues, https://github.com/skypilot-org/skypilot/issues
 Project-URL: Discussion, https://github.com/skypilot-org/skypilot/discussions
 Project-URL: Documentation, https://skypilot.readthedocs.io/en/latest/
 Classifier: Programming Language :: Python :: 3.7 Classifier: Programming
 Language :: Python :: 3.8 Classifier: Programming Language :: Python :: 3.9
 Classifier: Programming Language :: Python :: 3.10 Classifier: License :: OSI
 Approved :: Apache Software License Classifier: Operating System :: OS
 Independent Classifier: Topic :: Software Development :: Libraries :: Python
 Modules Classifier: Topic :: System :: Distributed Computing Description-
 Content-Type: text/markdown Provides-Extra: aws Provides-Extra: azure Provides-
 Extra: gcp Provides-Extra: ibm Provides-Extra: docker Provides-Extra: lambda
 Provides-Extra: cloudflare Provides-Extra: scp Provides-Extra: oci Provides-
-Extra: all License-File: LICENSE
+Extra: kubernetes Provides-Extra: all License-File: LICENSE
                                   [SkyPilot]
                  [Documentation] [GitHub_Release] [Join_Slack]
                     **** Run LLMs and AI on Any Cloud ****
----- :fire: *News* :fire: - [July, 2023] Self-Hosted **LLaMA 2 Chatbot** on Any
-Cloud: [**example**](./llm/llama-2/) - [June, 2023] Serving LLM **24x Faster On
-the Cloud** with vLLM and SkyPilot: [**example**](./llm/vllm/), [**blog post**]
-(https://blog.skypilot.co/serving-llm-24x-faster-on-the-cloud-with-vllm-and-
-skypilot/) - [June, 2023] [**Two new clouds supported**](https://
-skypilot.readthedocs.io/en/latest/getting-started/installation.html): Samsung
-SCP and Oracle OCI! - [April, 2023] **[**SkyPilot YAMLs released**](./llm/
-vicuna/) for finetuning & serving the Vicuna model with a single command**! -
-[March, 2023] **[Vicuna LLM chatbot](https://lmsys.org/blog/2023-03-30-vicuna/
-) trained** [**using SkyPilot**](./llm/vicuna/) **for $300 on spot instances!**
-- [March, 2023] Serve your own LLaMA LLM chatbot (not finetuned) on any cloud:
-[**example**](./llm/llama-chatbots/), [**repo**](https://github.com/skypilot-
-org/sky-llama) ---- SkyPilot is a framework for running LLMs, AI, and batch
-jobs on any cloud, offering maximum cost savings, highest GPU availability, and
-managed execution. SkyPilot **abstracts away cloud infra burdens**: - Launch
-jobs & clusters on any cloud - Easy scale-out: queue and run many jobs,
-automatically managed - Easy access to object stores (S3, GCS, R2) SkyPilot
-**maximizes GPU availability for your jobs**: * Provision in all zones/regions/
-clouds you have access to ([the _Sky_](https://arxiv.org/abs/2205.07147)), with
-automatic failover SkyPilot **cuts your cloud costs**: * [Managed Spot](https:/
-/skypilot.readthedocs.io/en/latest/examples/spot-jobs.html): 3-6x cost savings
-using spot VMs, with auto-recovery from preemptions * Optimizer: 2x cost
-savings by auto-picking the cheapest VM/zone/region/cloud * [Autostop](https://
-skypilot.readthedocs.io/en/latest/reference/auto-stop.html): hands-free cleanup
-of idle clusters SkyPilot supports your existing GPU, TPU, and CPU workloads,
-with no code changes. Install with pip or [from source](https://
-skypilot.readthedocs.io/en/latest/getting-started/installation.html): ``` pip
-install "skypilot[aws,gcp,azure,ibm,oci,scp,lambda]" # choose your clouds ```
-Current supported providers (AWS, Azure, GCP, Lambda Cloud, IBM, Samsung, OCI,
-Cloudflare):
+---- :fire: *News* :fire: - [Aug, 2023] New cookbook: Finetuning Llama 2 in
+your own cloud environment, privately: [**example**](./llm/vicuna-llama-2/),
+[**blog post**](https://blog.skypilot.co/finetuning-llama2-operational-guide/
+) - [July, 2023] Self-Hosted **Llama-2 Chatbot** on Any Cloud: [**example**](./
+llm/llama-2/) - [June, 2023] Serving LLM **24x Faster On the Cloud** with vLLM
+and SkyPilot: [**example**](./llm/vllm/), [**blog post**](https://
+blog.skypilot.co/serving-llm-24x-faster-on-the-cloud-with-vllm-and-skypilot/) -
+[June, 2023] [**Two new clouds supported**](https://skypilot.readthedocs.io/en/
+latest/getting-started/installation.html): Samsung SCP and Oracle OCI! -
+[April, 2023] **[**SkyPilot YAMLs released**](./llm/vicuna/) for finetuning &
+serving the Vicuna model with a single command**! - [March, 2023] **[Vicuna LLM
+chatbot](https://lmsys.org/blog/2023-03-30-vicuna/) trained** [**using
+SkyPilot**](./llm/vicuna/) **for $300 on spot instances!** ---- SkyPilot is a
+framework for running LLMs, AI, and batch jobs on any cloud, offering maximum
+cost savings, highest GPU availability, and managed execution. SkyPilot
+**abstracts away cloud infra burdens**: - Launch jobs & clusters on any cloud -
+Easy scale-out: queue and run many jobs, automatically managed - Easy access to
+object stores (S3, GCS, R2) SkyPilot **maximizes GPU availability for your
+jobs**: * Provision in all zones/regions/clouds you have access to ([the _Sky_]
+(https://arxiv.org/abs/2205.07147)), with automatic failover SkyPilot **cuts
+your cloud costs**: * [Managed Spot](https://skypilot.readthedocs.io/en/latest/
+examples/spot-jobs.html): 3-6x cost savings using spot VMs, with auto-recovery
+from preemptions * Optimizer: 2x cost savings by auto-picking the cheapest VM/
+zone/region/cloud * [Autostop](https://skypilot.readthedocs.io/en/latest/
+reference/auto-stop.html): hands-free cleanup of idle clusters SkyPilot
+supports your existing GPU, TPU, and CPU workloads, with no code changes.
+Install with pip or [from source](https://skypilot.readthedocs.io/en/latest/
+getting-started/installation.html): ``` pip install "skypilot
+[aws,gcp,azure,ibm,oci,scp,lambda]" # choose your clouds ``` Current supported
+providers (AWS, Azure, GCP, Lambda Cloud, IBM, Samsung, OCI, Cloudflare):
                                   [SkyPilot]
 ## Getting Started You can find our documentation [here](https://
 skypilot.readthedocs.io/en/latest/). - [Installation](https://
 skypilot.readthedocs.io/en/latest/getting-started/installation.html) -
 [Quickstart](https://skypilot.readthedocs.io/en/latest/getting-started/
 quickstart.html) - [CLI reference](https://skypilot.readthedocs.io/en/latest/
 reference/cli.html) ## SkyPilot in 1 Minute A SkyPilot task specifies: resource
@@ -76,33 +76,34 @@
 commands to prepare the VM for running the task 5. Run the task's `run`
 commands
                                 [SkyPilot Demo]
 Refer to [Quickstart](https://skypilot.readthedocs.io/en/latest/getting-
 started/quickstart.html) to get started with SkyPilot. ## More Information To
 learn more, see our [Documentation](https://skypilot.readthedocs.io/en/latest/
 ) and [Tutorials](https://github.com/skypilot-org/skypilot-tutorial). Runnable
-examples: - LLMs on SkyPilot - [Self-Hosted LLaMA 2 Chatbot](./llm/llama-2/) -
-[Vicuna chatbots: Training & Serving](./llm/vicuna/) (from official Vicuna
-team) - [vLLM: Serving LLM 24x Faster On the Cloud](./llm/vllm/) (from official
-vLLM team) - [QLoRA](https://github.com/artidoro/qlora/pull/132) - [LLaMA-LoRA-
-Tuner](https://github.com/zetavg/LLaMA-LoRA-Tuner#run-on-a-cloud-service-via-
-skypilot) - [Tabby: Self-hosted AI coding assistant](https://github.com/
-TabbyML/tabby/blob/bed723fcedb44a6b867ce22a7b1f03d2f3531c1e/experimental/eval/
-skypilot.yaml) - [LocalGPT](./llm/localgpt) - Add yours here & see more in
-[`llm/`](./llm)! - Framework examples: [PyTorch DDP](https://github.com/
-skypilot-org/skypilot/blob/master/examples/resnet_distributed_torch.yaml),
-[DeepSpeed](./examples/deepspeed-multinode/sky.yaml), [JAX/Flax on TPU](https:/
-/github.com/skypilot-org/skypilot/blob/master/examples/tpu/tpuvm_mnist.yaml),
-[Stable Diffusion](https://github.com/skypilot-org/skypilot/tree/master/
-examples/stable_diffusion), [Detectron2](https://github.com/skypilot-org/
-skypilot/blob/master/examples/detectron2_docker.yaml), [Distributed](https://
-github.com/skypilot-org/skypilot/blob/master/examples/
-resnet_distributed_tf_app.py) [TensorFlow](https://github.com/skypilot-org/
-skypilot/blob/master/examples/resnet_app_storage.yaml), [programmatic grid
-search](https://github.com/skypilot-org/skypilot/blob/master/examples/
+examples: - LLMs on SkyPilot - [Train Your Own Vicuna on Llama-2](./llm/vicuna-
+llama-2/) - [Self-Hosted Llama-2 Chatbot](./llm/llama-2/) - [Vicuna chatbots:
+Training & Serving](./llm/vicuna/) (from official Vicuna team) - [vLLM: Serving
+LLM 24x Faster On the Cloud](./llm/vllm/) (from official vLLM team) - [QLoRA]
+(https://github.com/artidoro/qlora/pull/132) - [LLaMA-LoRA-Tuner](https://
+github.com/zetavg/LLaMA-LoRA-Tuner#run-on-a-cloud-service-via-skypilot) -
+[Tabby: Self-hosted AI coding assistant](https://github.com/TabbyML/tabby/blob/
+bed723fcedb44a6b867ce22a7b1f03d2f3531c1e/experimental/eval/skypilot.yaml) -
+[LocalGPT](./llm/localgpt) - Add yours here & see more in [`llm/`](./llm)! -
+Framework examples: [PyTorch DDP](https://github.com/skypilot-org/skypilot/
+blob/master/examples/resnet_distributed_torch.yaml), [DeepSpeed](./examples/
+deepspeed-multinode/sky.yaml), [JAX/Flax on TPU](https://github.com/skypilot-
+org/skypilot/blob/master/examples/tpu/tpuvm_mnist.yaml), [Stable Diffusion]
+(https://github.com/skypilot-org/skypilot/tree/master/examples/
+stable_diffusion), [Detectron2](https://github.com/skypilot-org/skypilot/blob/
+master/examples/detectron2_docker.yaml), [Distributed](https://github.com/
+skypilot-org/skypilot/blob/master/examples/resnet_distributed_tf_app.py)
+[TensorFlow](https://github.com/skypilot-org/skypilot/blob/master/examples/
+resnet_app_storage.yaml), [programmatic grid search](https://github.com/
+skypilot-org/skypilot/blob/master/examples/
 huggingface_glue_imdb_grid_search_app.py), [Docker](https://github.com/
 skypilot-org/skypilot/blob/master/examples/docker/echo_app.yaml), and [many
 more (`examples/`)](./examples). Follow updates: - [Twitter](https://
 twitter.com/skypilot_org) - [Slack](http://slack.skypilot.co) - [SkyPilot Blog]
 (https://blog.skypilot.co/) ([Introductory blog post](https://blog.skypilot.co/
 introducing-skypilot/)) Read the research: - [SkyPilot paper](https://
 www.usenix.org/system/files/nsdi23-yang-zongheng.pdf) and [talk](https://
```

### Comparing `skypilot-nightly-1.0.0.dev20230802/README.md` & `skypilot-nightly-1.0.0.dev20230803/README.md`

 * *Files 6% similar despite different names*

```diff
@@ -23,20 +23,20 @@
 
 <h3 align="center">
     Run LLMs and AI on Any Cloud
 </h3>
 
 ----
 :fire: *News* :fire:
-- [July, 2023] Self-Hosted **LLaMA 2 Chatbot** on Any Cloud: [**example**](./llm/llama-2/)
+- [Aug, 2023] New cookbook: Finetuning Llama 2 in your own cloud environment, privately: [**example**](./llm/vicuna-llama-2/), [**blog post**](https://blog.skypilot.co/finetuning-llama2-operational-guide/)
+- [July, 2023] Self-Hosted **Llama-2 Chatbot** on Any Cloud: [**example**](./llm/llama-2/)
 - [June, 2023] Serving LLM **24x Faster On the Cloud** with vLLM and SkyPilot: [**example**](./llm/vllm/), [**blog post**](https://blog.skypilot.co/serving-llm-24x-faster-on-the-cloud-with-vllm-and-skypilot/)
 - [June, 2023] [**Two new clouds supported**](https://skypilot.readthedocs.io/en/latest/getting-started/installation.html): Samsung SCP and Oracle OCI!
 - [April, 2023] **[**SkyPilot YAMLs released**](./llm/vicuna/) for finetuning & serving the Vicuna model with a single command**!
 - [March, 2023] **[Vicuna LLM chatbot](https://lmsys.org/blog/2023-03-30-vicuna/) trained** [**using SkyPilot**](./llm/vicuna/) **for $300 on spot instances!** 
-- [March, 2023] Serve your own LLaMA LLM chatbot (not finetuned) on any cloud: [**example**](./llm/llama-chatbots/), [**repo**](https://github.com/skypilot-org/sky-llama)
 ----
 
 SkyPilot is a framework for running LLMs, AI, and batch jobs on any cloud, offering maximum cost savings, highest GPU availability, and managed execution.
 
 SkyPilot **abstracts away cloud infra burdens**:
 - Launch jobs & clusters on any cloud 
 - Easy scale-out: queue and run many jobs, automatically managed
@@ -127,15 +127,16 @@
 Refer to [Quickstart](https://skypilot.readthedocs.io/en/latest/getting-started/quickstart.html) to get started with SkyPilot.
 
 ## More Information
 To learn more, see our [Documentation](https://skypilot.readthedocs.io/en/latest/) and [Tutorials](https://github.com/skypilot-org/skypilot-tutorial).
 
 Runnable examples:
 - LLMs on SkyPilot
-  - [Self-Hosted LLaMA 2 Chatbot](./llm/llama-2/)
+  - [Train Your Own Vicuna on Llama-2](./llm/vicuna-llama-2/)
+  - [Self-Hosted Llama-2 Chatbot](./llm/llama-2/)
   - [Vicuna chatbots: Training & Serving](./llm/vicuna/) (from official Vicuna team)
   - [vLLM: Serving LLM 24x Faster On the Cloud](./llm/vllm/) (from official vLLM team)
   - [QLoRA](https://github.com/artidoro/qlora/pull/132)
   - [LLaMA-LoRA-Tuner](https://github.com/zetavg/LLaMA-LoRA-Tuner#run-on-a-cloud-service-via-skypilot)
   - [Tabby: Self-hosted AI coding assistant](https://github.com/TabbyML/tabby/blob/bed723fcedb44a6b867ce22a7b1f03d2f3531c1e/experimental/eval/skypilot.yaml)
   - [LocalGPT](./llm/localgpt)
   - Add yours here & see more in [`llm/`](./llm)!
```

#### html2text {}

```diff
@@ -1,40 +1,40 @@
                                    [SkyPilot]
                  [Documentation] [GitHub_Release] [Join_Slack]
                     **** Run LLMs and AI on Any Cloud ****
----- :fire: *News* :fire: - [July, 2023] Self-Hosted **LLaMA 2 Chatbot** on Any
-Cloud: [**example**](./llm/llama-2/) - [June, 2023] Serving LLM **24x Faster On
-the Cloud** with vLLM and SkyPilot: [**example**](./llm/vllm/), [**blog post**]
-(https://blog.skypilot.co/serving-llm-24x-faster-on-the-cloud-with-vllm-and-
-skypilot/) - [June, 2023] [**Two new clouds supported**](https://
-skypilot.readthedocs.io/en/latest/getting-started/installation.html): Samsung
-SCP and Oracle OCI! - [April, 2023] **[**SkyPilot YAMLs released**](./llm/
-vicuna/) for finetuning & serving the Vicuna model with a single command**! -
-[March, 2023] **[Vicuna LLM chatbot](https://lmsys.org/blog/2023-03-30-vicuna/
-) trained** [**using SkyPilot**](./llm/vicuna/) **for $300 on spot instances!**
-- [March, 2023] Serve your own LLaMA LLM chatbot (not finetuned) on any cloud:
-[**example**](./llm/llama-chatbots/), [**repo**](https://github.com/skypilot-
-org/sky-llama) ---- SkyPilot is a framework for running LLMs, AI, and batch
-jobs on any cloud, offering maximum cost savings, highest GPU availability, and
-managed execution. SkyPilot **abstracts away cloud infra burdens**: - Launch
-jobs & clusters on any cloud - Easy scale-out: queue and run many jobs,
-automatically managed - Easy access to object stores (S3, GCS, R2) SkyPilot
-**maximizes GPU availability for your jobs**: * Provision in all zones/regions/
-clouds you have access to ([the _Sky_](https://arxiv.org/abs/2205.07147)), with
-automatic failover SkyPilot **cuts your cloud costs**: * [Managed Spot](https:/
-/skypilot.readthedocs.io/en/latest/examples/spot-jobs.html): 3-6x cost savings
-using spot VMs, with auto-recovery from preemptions * Optimizer: 2x cost
-savings by auto-picking the cheapest VM/zone/region/cloud * [Autostop](https://
-skypilot.readthedocs.io/en/latest/reference/auto-stop.html): hands-free cleanup
-of idle clusters SkyPilot supports your existing GPU, TPU, and CPU workloads,
-with no code changes. Install with pip or [from source](https://
-skypilot.readthedocs.io/en/latest/getting-started/installation.html): ``` pip
-install "skypilot[aws,gcp,azure,ibm,oci,scp,lambda]" # choose your clouds ```
-Current supported providers (AWS, Azure, GCP, Lambda Cloud, IBM, Samsung, OCI,
-Cloudflare):
+---- :fire: *News* :fire: - [Aug, 2023] New cookbook: Finetuning Llama 2 in
+your own cloud environment, privately: [**example**](./llm/vicuna-llama-2/),
+[**blog post**](https://blog.skypilot.co/finetuning-llama2-operational-guide/
+) - [July, 2023] Self-Hosted **Llama-2 Chatbot** on Any Cloud: [**example**](./
+llm/llama-2/) - [June, 2023] Serving LLM **24x Faster On the Cloud** with vLLM
+and SkyPilot: [**example**](./llm/vllm/), [**blog post**](https://
+blog.skypilot.co/serving-llm-24x-faster-on-the-cloud-with-vllm-and-skypilot/) -
+[June, 2023] [**Two new clouds supported**](https://skypilot.readthedocs.io/en/
+latest/getting-started/installation.html): Samsung SCP and Oracle OCI! -
+[April, 2023] **[**SkyPilot YAMLs released**](./llm/vicuna/) for finetuning &
+serving the Vicuna model with a single command**! - [March, 2023] **[Vicuna LLM
+chatbot](https://lmsys.org/blog/2023-03-30-vicuna/) trained** [**using
+SkyPilot**](./llm/vicuna/) **for $300 on spot instances!** ---- SkyPilot is a
+framework for running LLMs, AI, and batch jobs on any cloud, offering maximum
+cost savings, highest GPU availability, and managed execution. SkyPilot
+**abstracts away cloud infra burdens**: - Launch jobs & clusters on any cloud -
+Easy scale-out: queue and run many jobs, automatically managed - Easy access to
+object stores (S3, GCS, R2) SkyPilot **maximizes GPU availability for your
+jobs**: * Provision in all zones/regions/clouds you have access to ([the _Sky_]
+(https://arxiv.org/abs/2205.07147)), with automatic failover SkyPilot **cuts
+your cloud costs**: * [Managed Spot](https://skypilot.readthedocs.io/en/latest/
+examples/spot-jobs.html): 3-6x cost savings using spot VMs, with auto-recovery
+from preemptions * Optimizer: 2x cost savings by auto-picking the cheapest VM/
+zone/region/cloud * [Autostop](https://skypilot.readthedocs.io/en/latest/
+reference/auto-stop.html): hands-free cleanup of idle clusters SkyPilot
+supports your existing GPU, TPU, and CPU workloads, with no code changes.
+Install with pip or [from source](https://skypilot.readthedocs.io/en/latest/
+getting-started/installation.html): ``` pip install "skypilot
+[aws,gcp,azure,ibm,oci,scp,lambda]" # choose your clouds ``` Current supported
+providers (AWS, Azure, GCP, Lambda Cloud, IBM, Samsung, OCI, Cloudflare):
                                    [SkyPilot]
 ## Getting Started You can find our documentation [here](https://
 skypilot.readthedocs.io/en/latest/). - [Installation](https://
 skypilot.readthedocs.io/en/latest/getting-started/installation.html) -
 [Quickstart](https://skypilot.readthedocs.io/en/latest/getting-started/
 quickstart.html) - [CLI reference](https://skypilot.readthedocs.io/en/latest/
 reference/cli.html) ## SkyPilot in 1 Minute A SkyPilot task specifies: resource
@@ -60,33 +60,34 @@
 commands to prepare the VM for running the task 5. Run the task's `run`
 commands
                                 [SkyPilot Demo]
 Refer to [Quickstart](https://skypilot.readthedocs.io/en/latest/getting-
 started/quickstart.html) to get started with SkyPilot. ## More Information To
 learn more, see our [Documentation](https://skypilot.readthedocs.io/en/latest/
 ) and [Tutorials](https://github.com/skypilot-org/skypilot-tutorial). Runnable
-examples: - LLMs on SkyPilot - [Self-Hosted LLaMA 2 Chatbot](./llm/llama-2/) -
-[Vicuna chatbots: Training & Serving](./llm/vicuna/) (from official Vicuna
-team) - [vLLM: Serving LLM 24x Faster On the Cloud](./llm/vllm/) (from official
-vLLM team) - [QLoRA](https://github.com/artidoro/qlora/pull/132) - [LLaMA-LoRA-
-Tuner](https://github.com/zetavg/LLaMA-LoRA-Tuner#run-on-a-cloud-service-via-
-skypilot) - [Tabby: Self-hosted AI coding assistant](https://github.com/
-TabbyML/tabby/blob/bed723fcedb44a6b867ce22a7b1f03d2f3531c1e/experimental/eval/
-skypilot.yaml) - [LocalGPT](./llm/localgpt) - Add yours here & see more in
-[`llm/`](./llm)! - Framework examples: [PyTorch DDP](https://github.com/
-skypilot-org/skypilot/blob/master/examples/resnet_distributed_torch.yaml),
-[DeepSpeed](./examples/deepspeed-multinode/sky.yaml), [JAX/Flax on TPU](https:/
-/github.com/skypilot-org/skypilot/blob/master/examples/tpu/tpuvm_mnist.yaml),
-[Stable Diffusion](https://github.com/skypilot-org/skypilot/tree/master/
-examples/stable_diffusion), [Detectron2](https://github.com/skypilot-org/
-skypilot/blob/master/examples/detectron2_docker.yaml), [Distributed](https://
-github.com/skypilot-org/skypilot/blob/master/examples/
-resnet_distributed_tf_app.py) [TensorFlow](https://github.com/skypilot-org/
-skypilot/blob/master/examples/resnet_app_storage.yaml), [programmatic grid
-search](https://github.com/skypilot-org/skypilot/blob/master/examples/
+examples: - LLMs on SkyPilot - [Train Your Own Vicuna on Llama-2](./llm/vicuna-
+llama-2/) - [Self-Hosted Llama-2 Chatbot](./llm/llama-2/) - [Vicuna chatbots:
+Training & Serving](./llm/vicuna/) (from official Vicuna team) - [vLLM: Serving
+LLM 24x Faster On the Cloud](./llm/vllm/) (from official vLLM team) - [QLoRA]
+(https://github.com/artidoro/qlora/pull/132) - [LLaMA-LoRA-Tuner](https://
+github.com/zetavg/LLaMA-LoRA-Tuner#run-on-a-cloud-service-via-skypilot) -
+[Tabby: Self-hosted AI coding assistant](https://github.com/TabbyML/tabby/blob/
+bed723fcedb44a6b867ce22a7b1f03d2f3531c1e/experimental/eval/skypilot.yaml) -
+[LocalGPT](./llm/localgpt) - Add yours here & see more in [`llm/`](./llm)! -
+Framework examples: [PyTorch DDP](https://github.com/skypilot-org/skypilot/
+blob/master/examples/resnet_distributed_torch.yaml), [DeepSpeed](./examples/
+deepspeed-multinode/sky.yaml), [JAX/Flax on TPU](https://github.com/skypilot-
+org/skypilot/blob/master/examples/tpu/tpuvm_mnist.yaml), [Stable Diffusion]
+(https://github.com/skypilot-org/skypilot/tree/master/examples/
+stable_diffusion), [Detectron2](https://github.com/skypilot-org/skypilot/blob/
+master/examples/detectron2_docker.yaml), [Distributed](https://github.com/
+skypilot-org/skypilot/blob/master/examples/resnet_distributed_tf_app.py)
+[TensorFlow](https://github.com/skypilot-org/skypilot/blob/master/examples/
+resnet_app_storage.yaml), [programmatic grid search](https://github.com/
+skypilot-org/skypilot/blob/master/examples/
 huggingface_glue_imdb_grid_search_app.py), [Docker](https://github.com/
 skypilot-org/skypilot/blob/master/examples/docker/echo_app.yaml), and [many
 more (`examples/`)](./examples). Follow updates: - [Twitter](https://
 twitter.com/skypilot_org) - [Slack](http://slack.skypilot.co) - [SkyPilot Blog]
 (https://blog.skypilot.co/) ([Introductory blog post](https://blog.skypilot.co/
 introducing-skypilot/)) Read the research: - [SkyPilot paper](https://
 www.usenix.org/system/files/nsdi23-yang-zongheng.pdf) and [talk](https://
```

### Comparing `skypilot-nightly-1.0.0.dev20230802/pyproject.toml` & `skypilot-nightly-1.0.0.dev20230803/pyproject.toml`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/setup.py` & `skypilot-nightly-1.0.0.dev20230803/setup.py`

 * *Files 1% similar despite different names*

```diff
@@ -153,14 +153,15 @@
         'ibm-cloud-sdk-core', 'ibm-vpc', 'ibm-platform-services', 'ibm-cos-sdk'
     ],
     'docker': ['docker'],
     'lambda': [],
     'cloudflare': aws_dependencies,
     'scp': [],
     'oci': ['oci'],
+    'kubernetes': ['kubernetes'],
 }
 
 extras_require['all'] = sum(extras_require.values(), [])
 
 # Install aws requirements by default, as it is the most common cloud provider,
 # and the installation is quick.
 install_requires += extras_require['aws']
```

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/__init__.py` & `skypilot-nightly-1.0.0.dev20230803/sky/__init__.py`

 * *Files 6% similar despite different names*

```diff
@@ -1,13 +1,13 @@
 """The SkyPilot package."""
 import os
 
 # Replaced with the current commit when building the wheels.
-__commit__ = '4d51a89d6c08c7ddf972bdfd51a9f18485842caa'
-__version__ = '1.0.0-dev20230802'
+__commit__ = '6f52a0bf21a2f538fe8cc71d43d823f82d2b4bc4'
+__version__ = '1.0.0-dev20230803'
 __root_dir__ = os.path.dirname(os.path.abspath(__file__))
 
 # Keep this order to avoid cyclic imports
 from sky import backends
 from sky import benchmark
 from sky import clouds
 from sky.clouds.service_catalog import list_accelerators
@@ -28,27 +28,29 @@
 IBM = clouds.IBM
 AWS = clouds.AWS
 Azure = clouds.Azure
 GCP = clouds.GCP
 Lambda = clouds.Lambda
 SCP = clouds.SCP
 Local = clouds.Local
+Kubernetes = clouds.Kubernetes
 OCI = clouds.OCI
 optimize = Optimizer.optimize
 
 __all__ = [
     '__version__',
-    'IBM',
     'AWS',
     'Azure',
     'GCP',
+    'IBM',
+    'Kubernetes',
     'Lambda',
-    'SCP',
     'Local',
     'OCI',
+    'SCP',
     'Optimizer',
     'OptimizeTarget',
     'backends',
     'benchmark',
     'list_accelerators',
     '__root_dir__',
     'Storage',
```

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/adaptors/aws.py` & `skypilot-nightly-1.0.0.dev20230803/sky/adaptors/aws.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/adaptors/azure.py` & `skypilot-nightly-1.0.0.dev20230803/sky/adaptors/azure.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/adaptors/cloudflare.py` & `skypilot-nightly-1.0.0.dev20230803/sky/adaptors/cloudflare.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/adaptors/docker.py` & `skypilot-nightly-1.0.0.dev20230803/sky/adaptors/docker.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/adaptors/gcp.py` & `skypilot-nightly-1.0.0.dev20230803/sky/adaptors/gcp.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/adaptors/ibm.py` & `skypilot-nightly-1.0.0.dev20230803/sky/adaptors/ibm.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/adaptors/oci.py` & `skypilot-nightly-1.0.0.dev20230803/sky/adaptors/oci.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/authentication.py` & `skypilot-nightly-1.0.0.dev20230803/sky/authentication.py`

 * *Files 6% similar despite different names*

```diff
@@ -369,7 +369,37 @@
 
 
 def setup_scp_authentication(config: Dict[str, Any]) -> Dict[str, Any]:
     _, public_key_path = get_or_generate_keys()
     with open(public_key_path, 'r') as f:
         public_key = f.read().strip()
     return _replace_ssh_info_in_config(config, public_key)
+
+
+def setup_kubernetes_authentication(config: Dict[str, Any]) -> Dict[str, Any]:
+    get_or_generate_keys()
+
+    # Run kubectl command to add the public key to the cluster.
+    public_key_path = os.path.expanduser(PUBLIC_SSH_KEY_PATH)
+    key_label = clouds.Kubernetes.SKY_SSH_KEY_SECRET_NAME
+    cmd = f'kubectl create secret generic {key_label} ' \
+          f'--from-file=ssh-publickey={public_key_path}'
+    try:
+        subprocess.check_output(cmd, stderr=subprocess.STDOUT, shell=True)
+    except subprocess.CalledProcessError as e:
+        output = e.output.decode('utf-8')
+        suffix = f'\nError message: {output}'
+        if 'already exists' in output:
+            logger.debug(
+                f'Key {key_label} already exists in the cluster, using it...')
+        elif any(err in output for err in ['connection refused', 'timeout']):
+            with ux_utils.print_exception_no_traceback():
+                raise ConnectionError(
+                    'Failed to connect to the cluster. Check if your '
+                    'cluster is running, your kubeconfig is correct '
+                    'and you can connect to it using: '
+                    f'kubectl get namespaces.{suffix}') from e
+        else:
+            logger.error(suffix)
+            raise
+
+    return config
```

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/backends/backend.py` & `skypilot-nightly-1.0.0.dev20230803/sky/backends/backend.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/backends/backend_utils.py` & `skypilot-nightly-1.0.0.dev20230803/sky/backends/backend_utils.py`

 * *Files 2% similar despite different names*

```diff
@@ -397,15 +397,15 @@
     ssh_conf_path = '~/.ssh/config'
     ssh_conf_lock_path = os.path.expanduser('~/.sky/ssh_config.lock')
     ssh_multinode_path = SKY_USER_FILE_PATH + '/ssh/{}'
 
     @classmethod
     def _get_generated_config(cls, autogen_comment: str, host_name: str,
                               ip: str, username: str, ssh_key_path: str,
-                              proxy_command: Optional[str]):
+                              proxy_command: Optional[str], port: int):
         if proxy_command is not None:
             proxy = f'ProxyCommand {proxy_command}'
         else:
             proxy = ''
         # StrictHostKeyChecking=no skips the host key check for the first
         # time. UserKnownHostsFile=/dev/null and GlobalKnownHostsFile/dev/null
         # prevent the host key from being added to the known_hosts file and
@@ -419,28 +419,24 @@
               User {username}
               IdentityFile {ssh_key_path}
               IdentitiesOnly yes
               ForwardAgent yes
               StrictHostKeyChecking no
               UserKnownHostsFile=/dev/null
               GlobalKnownHostsFile=/dev/null
-              Port 22
+              Port {port}
               {proxy}
             """.rstrip())
         codegen = codegen + '\n'
         return codegen
 
     @classmethod
     @timeline.FileLockEvent(ssh_conf_lock_path)
-    def add_cluster(
-        cls,
-        cluster_name: str,
-        ips: List[str],
-        auth_config: Dict[str, str],
-    ):
+    def add_cluster(cls, cluster_name: str, ips: List[str],
+                    auth_config: Dict[str, str], ports: List[int]):
         """Add authentication information for cluster to local SSH config file.
 
         If a host with `cluster_name` already exists and the configuration was
         not added by sky, then `ip` is used to identify the host instead in the
         file.
 
         If a host with `cluster_name` already exists and the configuration was
@@ -448,14 +444,15 @@
         overwritten.
 
         Args:
             cluster_name: Cluster name (see `sky status`)
             ips: List of public IP addresses in the cluster. First IP is head
               node.
             auth_config: read_yaml(handle.cluster_yaml)['auth']
+            ports: List of port numbers for SSH corresponding to ips
         """
         username = auth_config['ssh_user']
         key_path = os.path.expanduser(auth_config['ssh_private_key'])
         host_name = cluster_name
         sky_autogen_comment = ('# Added by sky (use `sky stop/down '
                                f'{cluster_name}` to remove)')
         overwrite = False
@@ -488,16 +485,18 @@
         else:
             config = ['\n']
             with open(config_path, 'w') as f:
                 f.writelines(config)
             os.chmod(config_path, 0o644)
 
         proxy_command = auth_config.get('ssh_proxy_command', None)
+        head_port = ports[0]
         codegen = cls._get_generated_config(sky_autogen_comment, host_name, ip,
-                                            username, key_path, proxy_command)
+                                            username, key_path, proxy_command,
+                                            head_port)
 
         # Add (or overwrite) the new config.
         if overwrite:
             assert overwrite_begin_idx is not None
             updated_lines = codegen.splitlines(keepends=True) + ['\n']
             config[overwrite_begin_idx:overwrite_begin_idx +
                    len(updated_lines)] = updated_lines
@@ -588,37 +587,53 @@
             if line.strip() in host_lines:
                 idx = host_lines.index(line.strip())
                 prev_line = config[i - 1] if i > 0 else ''
                 logger.warning(f'{cls.ssh_conf_path} contains '
                                f'host named {worker_names[idx]}.')
                 host_name = external_worker_ips[idx]
                 logger.warning(f'Using {host_name} to identify host instead.')
+                # TODO(romilb): Update port number when k8s supports multinode
                 codegens[idx] = cls._get_generated_config(
-                    sky_autogen_comment, host_name, external_worker_ips[idx],
-                    username, key_path, proxy_command)
+                    sky_autogen_comment,
+                    host_name,
+                    external_worker_ips[idx],
+                    username,
+                    key_path,
+                    proxy_command,
+                    port=22)
 
         # All workers go to SKY_USER_FILE_PATH/ssh/{cluster_name}
         for i, line in enumerate(extra_config):
             if line.strip() in host_lines:
                 idx = host_lines.index(line.strip())
                 prev_line = extra_config[i - 1] if i > 0 else ''
                 if prev_line.strip().startswith(sky_autogen_comment):
                     host_name = worker_names[idx]
                     overwrites[idx] = True
                     overwrite_begin_idxs[idx] = i - 1
+                # TODO(romilb): Update port number when k8s supports multinode
                 codegens[idx] = cls._get_generated_config(
-                    sky_autogen_comment, host_name, external_worker_ips[idx],
-                    username, key_path, proxy_command)
+                    sky_autogen_comment,
+                    host_name,
+                    external_worker_ips[idx],
+                    username,
+                    key_path,
+                    proxy_command,
+                    port=22)
 
         # This checks if all codegens have been created.
         for idx, ip in enumerate(external_worker_ips):
             if not codegens[idx]:
-                codegens[idx] = cls._get_generated_config(
-                    sky_autogen_comment, worker_names[idx], ip, username,
-                    key_path, proxy_command)
+                codegens[idx] = cls._get_generated_config(sky_autogen_comment,
+                                                          worker_names[idx],
+                                                          ip,
+                                                          username,
+                                                          key_path,
+                                                          proxy_command,
+                                                          port=22)
 
         for idx in range(len(external_worker_ips)):
             # Add (or overwrite) the new config.
             overwrite = overwrites[idx]
             overwrite_begin_idx = overwrite_begin_idxs[idx]
             codegen = codegens[idx]
             assert codegen is not None, (codegens, idx)
@@ -1064,14 +1079,16 @@
         config = auth.setup_aws_authentication(config)
     elif isinstance(cloud, clouds.GCP):
         config = auth.setup_gcp_authentication(config)
     elif isinstance(cloud, clouds.Azure):
         config = auth.setup_azure_authentication(config)
     elif isinstance(cloud, clouds.Lambda):
         config = auth.setup_lambda_authentication(config)
+    elif isinstance(cloud, clouds.Kubernetes):
+        config = auth.setup_kubernetes_authentication(config)
     elif isinstance(cloud, clouds.IBM):
         config = auth.setup_ibm_authentication(config)
     elif isinstance(cloud, clouds.SCP):
         config = auth.setup_scp_authentication(config)
     elif isinstance(cloud, clouds.OCI):
         config = auth.setup_oci_authentication(config)
     else:
@@ -1588,14 +1605,36 @@
     head_ip = handle.head_ip
     if head_ip is not None:
         return head_ip
     head_ip = _query_head_ip_with_retries(handle.cluster_yaml, max_attempts)
     return head_ip
 
 
+@timeline.event
+def get_head_ssh_port(
+    handle: 'cloud_vm_ray_backend.CloudVmRayResourceHandle',
+    use_cache: bool = True,
+    max_attempts: int = 1,
+) -> int:
+    """Returns the ip of the head node."""
+    del max_attempts  # Unused.
+    # Use port 22 for everything except Kubernetes
+    # TODO(romilb): Add a get port method to the cloud classes.
+    head_ssh_port = 22
+    if not isinstance(handle.launched_resources.cloud, clouds.Kubernetes):
+        return head_ssh_port
+    else:
+        if use_cache and handle.head_ssh_port is not None:
+            head_ssh_port = handle.head_ssh_port
+        else:
+            svc_name = f'{handle.get_cluster_name()}-ray-head-ssh'
+            head_ssh_port = clouds.Kubernetes.get_port(svc_name)
+    return head_ssh_port
+
+
 def check_network_connection():
     # Tolerate 3 retries as it is observed that connections can fail.
     adapter = adapters.HTTPAdapter(max_retries=retry_lib.Retry(total=3))
     http = requests.Session()
     http.mount('https://', adapter)
     http.mount('http://', adapter)
     for i, ip in enumerate(_TEST_IP_LIST):
@@ -1879,15 +1918,16 @@
             # triggered.
             if external_ips is None or len(external_ips) == 0:
                 raise exceptions.FetchIPError(
                     reason=exceptions.FetchIPError.Reason.HEAD)
             # Check if ray cluster status is healthy.
             ssh_credentials = ssh_credential_from_yaml(handle.cluster_yaml)
             runner = command_runner.SSHCommandRunner(external_ips[0],
-                                                     **ssh_credentials)
+                                                     **ssh_credentials,
+                                                     port=handle.head_ssh_port)
             rc, output, _ = runner.run(RAY_STATUS_WITH_SKY_RAY_PORT_COMMAND,
                                        stream_logs=False,
                                        require_outputs=True,
                                        separate_stderr=True)
             if rc:
                 raise exceptions.FetchIPError(
                     reason=exceptions.FetchIPError.Reason.HEAD)
```

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/backends/cloud_vm_ray_backend.py` & `skypilot-nightly-1.0.0.dev20230803/sky/backends/cloud_vm_ray_backend.py`

 * *Files 1% similar despite different names*

```diff
@@ -137,14 +137,15 @@
         clouds.Azure: 'azure-ray.yml.j2',
         clouds.GCP: 'gcp-ray.yml.j2',
         clouds.Lambda: 'lambda-ray.yml.j2',
         clouds.IBM: 'ibm-ray.yml.j2',
         clouds.Local: 'local-ray.yml.j2',
         clouds.SCP: 'scp-ray.yml.j2',
         clouds.OCI: 'oci-ray.yml.j2',
+        clouds.Kubernetes: 'kubernetes-ray.yml.j2',
     }
     return cloud_to_template[type(cloud)]
 
 
 def write_ray_up_script_with_patched_launch_hash_fn(
     cluster_config_path: str,
     ray_up_kwargs: Dict[str, bool],
@@ -927,14 +928,42 @@
         for e in errors:
             if e.find('Regions with capacity available:') != -1:
                 for r in clouds.Lambda.regions():
                     if e.find(r.name) == -1:
                         self._blocked_resources.add(
                             launchable_resources.copy(region=r.name, zone=None))
 
+    def _update_blocklist_on_kubernetes_error(
+            self, launchable_resources: 'resources_lib.Resources', region,
+            zones, stdout, stderr):
+        del zones  # Unused.
+        style = colorama.Style
+        stdout_splits = stdout.split('\n')
+        stderr_splits = stderr.split('\n')
+        errors = [
+            s.strip()
+            for s in stdout_splits + stderr_splits
+            if 'KubernetesError:' in s.strip()
+        ]
+        if not errors:
+            logger.info('====== stdout ======')
+            for s in stdout_splits:
+                print(s)
+            logger.info('====== stderr ======')
+            for s in stderr_splits:
+                print(s)
+            with ux_utils.print_exception_no_traceback():
+                raise RuntimeError('Errors occurred during provisioning; '
+                                   'check logs above.')
+
+        logger.warning(f'Got error(s) in {region.name}:')
+        messages = '\n\t'.join(errors)
+        logger.warning(f'{style.DIM}\t{messages}{style.RESET_ALL}')
+        self._blocked_resources.add(launchable_resources.copy(zone=None))
+
     def _update_blocklist_on_scp_error(
             self, launchable_resources: 'resources_lib.Resources', region,
             zones, stdout, stderr):
         del zones  # Unused.
         style = colorama.Style
         stdout_splits = stdout.split('\n')
         stderr_splits = stderr.split('\n')
@@ -1111,14 +1140,15 @@
             clouds.AWS: self._update_blocklist_on_aws_error,
             clouds.Azure: self._update_blocklist_on_azure_error,
             clouds.GCP: self._update_blocklist_on_gcp_error,
             clouds.Lambda: self._update_blocklist_on_lambda_error,
             clouds.IBM: self._update_blocklist_on_ibm_error,
             clouds.SCP: self._update_blocklist_on_scp_error,
             clouds.Local: self._update_blocklist_on_local_error,
+            clouds.Kubernetes: self._update_blocklist_on_kubernetes_error,
             clouds.OCI: self._update_blocklist_on_oci_error,
         }
         cloud = launchable_resources.cloud
         cloud_type = type(cloud)
         if cloud_type not in handlers:
             raise NotImplementedError(
                 f'Cloud {cloud} unknown, or has not added '
@@ -1725,14 +1755,17 @@
         region_name = logging_info['region_name']
         zone_str = logging_info['zone_str']
         style = colorama.Style
         if isinstance(to_provision_cloud, clouds.Local):
             cluster_name = logging_info['cluster_name']
             logger.info(f'{style.BRIGHT}Launching on local cluster '
                         f'{cluster_name!r}.')
+        elif isinstance(to_provision_cloud, clouds.Kubernetes):
+            logger.info(f'{style.BRIGHT}Launching on {to_provision_cloud} '
+                        f'{style.RESET_ALL}')
         else:
             logger.info(f'{style.BRIGHT}Launching on {to_provision_cloud} '
                         f'{region_name}{style.RESET_ALL}{zone_str}')
         start = time.time()
 
         # Edge case: /tmp/ray does not exist, so autoscaler can't create/store
         # cluster lock and cluster state.
@@ -2088,45 +2121,49 @@
         successful provision().
     - (optional) A cached stable list of (internal IP, external IP) tuples
         for all nodes in a cluster. Filled in after successful task execution.
     - (optional) Launched num nodes
     - (optional) Launched resources
     - (optional) If TPU(s) are managed, a path to a deletion script.
     """
-    _VERSION = 3
+    _VERSION = 4
 
     def __init__(self,
                  *,
                  cluster_name: str,
                  cluster_yaml: str,
                  launched_nodes: int,
                  launched_resources: resources_lib.Resources,
                  stable_internal_external_ips: Optional[List[Tuple[
                      str, str]]] = None,
+                 stable_ssh_ports: Optional[List[int]] = None,
                  tpu_create_script: Optional[str] = None,
                  tpu_delete_script: Optional[str] = None) -> None:
         self._version = self._VERSION
         self.cluster_name = cluster_name
         self._cluster_yaml = cluster_yaml.replace(os.path.expanduser('~'), '~',
                                                   1)
         # List of (internal_ip, external_ip) tuples for all the nodes
         # in the cluster, sorted by the external ips.
         self.stable_internal_external_ips = stable_internal_external_ips
+        self.stable_ssh_ports = stable_ssh_ports
         self.launched_nodes = launched_nodes
         self.launched_resources = launched_resources
         self.tpu_create_script = tpu_create_script
         self.tpu_delete_script = tpu_delete_script
         self._maybe_make_local_handle()
 
     def __repr__(self):
         return (f'ResourceHandle('
                 f'\n\tcluster_name={self.cluster_name},'
                 f'\n\thead_ip={self.head_ip},'
                 '\n\tstable_internal_external_ips='
                 f'{self.stable_internal_external_ips},'
+                '\n\tstable_ssh_ports='
+                f'{self.stable_ssh_ports},'
                 '\n\tcluster_yaml='
                 f'{self.cluster_yaml}, '
                 f'\n\tlaunched_resources={self.launched_nodes}x '
                 f'{self.launched_resources}, '
                 f'\n\ttpu_create_script={self.tpu_create_script}, '
                 f'\n\ttpu_delete_script={self.tpu_delete_script})')
 
@@ -2189,14 +2226,27 @@
         elif cloud.is_same_cloud(clouds.Local()):
             # There is only 1 region for Local cluster, 'Local'.
             local_regions = clouds.Local.regions()
             region = local_regions[0].name
 
         self.launched_resources = self.launched_resources.copy(region=region)
 
+    def _update_stable_ssh_ports(self, max_attempts: int = 1) -> None:
+        # TODO(romilb): Replace this with a call to the cloud class to get ports
+        if isinstance(self.launched_resources.cloud, clouds.Kubernetes):
+            head_port = backend_utils.get_head_ssh_port(
+                self, use_cache=False, max_attempts=max_attempts)
+            # TODO(romilb): Multinode doesn't work with Kubernetes yet.
+            worker_ports = [22] * (self.launched_nodes - 1)
+            ports = [head_port] + worker_ports
+        else:
+            # Use port 22 for other clouds
+            ports = [22] * self.launched_nodes
+        self.stable_ssh_ports = ports
+
     def _update_stable_cluster_ips(self, max_attempts: int = 1) -> None:
         cluster_external_ips = backend_utils.get_node_ips(
             self.cluster_yaml,
             self.launched_nodes,
             handle=self,
             head_ip_max_attempts=max_attempts,
             worker_ip_max_attempts=max_attempts,
@@ -2255,14 +2305,24 @@
                      use_cached_ips: bool = True) -> Optional[List[str]]:
         if not use_cached_ips:
             self._update_stable_cluster_ips(max_attempts=max_attempts)
         if self.stable_internal_external_ips is not None:
             return [ips[1] for ips in self.stable_internal_external_ips]
         return None
 
+    def external_ssh_ports(
+            self,
+            max_attempts: int = _FETCH_IP_MAX_ATTEMPTS,
+            use_cached_ports: bool = True) -> Optional[List[int]]:
+        if not use_cached_ports:
+            self._update_stable_ssh_ports(max_attempts=max_attempts)
+        if self.stable_ssh_ports is not None:
+            return self.stable_ssh_ports
+        return None
+
     def get_hourly_price(self) -> float:
         hourly_cost = (self.launched_resources.get_cost(3600) *
                        self.launched_nodes)
         return hourly_cost
 
     @property
     def cluster_yaml(self):
@@ -2271,38 +2331,51 @@
     @property
     def head_ip(self):
         external_ips = self.external_ips()
         if external_ips is not None:
             return external_ips[0]
         return None
 
+    @property
+    def head_ssh_port(self):
+        external_ssh_ports = self.external_ssh_ports()
+        if external_ssh_ports:
+            return external_ssh_ports[0]
+        return None
+
     def __setstate__(self, state):
         self._version = self._VERSION
 
         version = state.pop('_version', None)
         if version is None:
             version = -1
             state.pop('cluster_region', None)
         if version < 2:
             state['_cluster_yaml'] = state.pop('cluster_yaml')
         if version < 3:
             head_ip = state.pop('head_ip', None)
             state['stable_internal_external_ips'] = None
+        if version < 4:
+            # Version 4 adds self.stable_ssh_ports for Kubernetes support
+            state['stable_ssh_ports'] = None
 
         self.__dict__.update(state)
 
-        # Because the _update_stable_cluster_ips function uses the handle,
-        # we call it on the current instance after the state is updated
+        # Because the _update_stable_cluster_ips and _update_stable_ssh_ports
+        # functions use the handle, we call it on the current instance
+        # after the state is updated.
         if version < 3 and head_ip is not None:
             try:
                 self._update_stable_cluster_ips()
             except exceptions.FetchIPError:
                 # This occurs when an old cluster from was autostopped,
                 # so the head IP in the database is not updated.
                 pass
+        if version < 4:
+            self._update_stable_ssh_ports()
 
         self._update_cluster_region()
 
 
 class CloudVmRayBackend(backends.Backend['CloudVmRayResourceHandle']):
     """Backend: runs on cloud virtual machines, managed by Ray.
 
@@ -2546,15 +2619,18 @@
                 launched_resources=config_dict['launched_resources'],
                 # TPU.
                 tpu_create_script=config_dict.get('tpu-create-script'),
                 tpu_delete_script=config_dict.get('tpu-delete-script'))
 
             ip_list = handle.external_ips(max_attempts=_FETCH_IP_MAX_ATTEMPTS,
                                           use_cached_ips=False)
+            ssh_port_list = handle.external_ssh_ports(
+                max_attempts=_FETCH_IP_MAX_ATTEMPTS, use_cached_ports=False)
             assert ip_list is not None, handle
+            assert ssh_port_list is not None, handle
 
             if 'tpu_name' in config_dict:
                 self._set_tpu_name(handle, config_dict['tpu_name'])
 
             # Get actual zone info and save it into handle.
             # NOTE: querying zones is expensive, observed 1node GCP >=4s.
             zones = config_dict['zones']
@@ -2567,15 +2643,15 @@
             else:
                 get_zone_cmd = (
                     handle.launched_resources.cloud.get_zone_shell_cmd())
                 if get_zone_cmd is not None:
                     ssh_credentials = backend_utils.ssh_credential_from_yaml(
                         handle.cluster_yaml)
                     runners = command_runner.SSHCommandRunner.make_runner_list(
-                        ip_list, **ssh_credentials)
+                        ip_list, port_list=ssh_port_list, **ssh_credentials)
 
                     def _get_zone(runner):
                         retry_count = 0
                         backoff = common_utils.Backoff(initial_backoff=1,
                                                        max_backoff_factor=3)
                         while True:
                             returncode, stdout, stderr = runner.run(
@@ -2604,21 +2680,22 @@
                             handle.launched_resources.copy(zone=zones[0]))
                     # If the number of zones > 1, nodes in the cluster are
                     # launched in different zones (legacy clusters before
                     # #1700), leave the zone field of handle.launched_resources
                     # to None.
             self._update_after_cluster_provisioned(handle, task,
                                                    prev_cluster_status, ip_list,
-                                                   lock_path)
+                                                   ssh_port_list, lock_path)
             return handle
 
     def _update_after_cluster_provisioned(
             self, handle: CloudVmRayResourceHandle, task: task_lib.Task,
             prev_cluster_status: Optional[status_lib.ClusterStatus],
-            ip_list: List[str], lock_path: str) -> None:
+            ip_list: List[str], ssh_port_list: List[int],
+            lock_path: str) -> None:
         usage_lib.messages.usage.update_cluster_resources(
             handle.launched_nodes, handle.launched_resources)
         usage_lib.messages.usage.update_final_cluster_status(
             status_lib.ClusterStatus.UP)
 
         # For backward compatibility and robustness of skylet, it is restarted
         with log_utils.safe_rich_status('Updating remote skylet'):
@@ -2662,26 +2739,28 @@
                 task.resources,
                 ready=True,
             )
             usage_lib.messages.usage.update_final_cluster_status(
                 status_lib.ClusterStatus.UP)
             auth_config = common_utils.read_yaml(handle.cluster_yaml)['auth']
             backend_utils.SSHConfigHelper.add_cluster(handle.cluster_name,
-                                                      ip_list, auth_config)
+                                                      ip_list, auth_config,
+                                                      ssh_port_list)
 
             common_utils.remove_file_if_exists(lock_path)
 
     def _sync_workdir(self, handle: CloudVmRayResourceHandle,
                       workdir: Path) -> None:
         # Even though provision() takes care of it, there may be cases where
         # this function is called in isolation, without calling provision(),
         # e.g., in CLI.  So we should rerun rsync_up.
         fore = colorama.Fore
         style = colorama.Style
         ip_list = handle.external_ips()
+        port_list = handle.external_ssh_ports()
         assert ip_list is not None, 'external_ips is not cached in handle'
         full_workdir = os.path.abspath(os.path.expanduser(workdir))
 
         # These asserts have been validated at Task construction time.
         assert os.path.exists(full_workdir), f'{full_workdir} does not exist'
         if os.path.islink(full_workdir):
             logger.warning(
@@ -2703,15 +2782,15 @@
         log_path = os.path.join(self.log_dir, 'workdir_sync.log')
 
         ssh_credentials = backend_utils.ssh_credential_from_yaml(
             handle.cluster_yaml)
 
         # TODO(zhwu): refactor this with backend_utils.parallel_cmd_with_rsync
         runners = command_runner.SSHCommandRunner.make_runner_list(
-            ip_list, **ssh_credentials)
+            ip_list, port_list=port_list, **ssh_credentials)
 
         def _sync_workdir_node(runner: command_runner.SSHCommandRunner) -> None:
             runner.rsync(
                 source=workdir,
                 target=SKY_REMOTE_WORKDIR,
                 up=True,
                 log_path=log_path,
@@ -2757,23 +2836,24 @@
         with tempfile.NamedTemporaryFile('w', prefix='sky_setup_') as f:
             f.write(setup_script)
             f.flush()
             setup_sh_path = f.name
             setup_file = os.path.basename(setup_sh_path)
             # Sync the setup script up and run it.
             ip_list = handle.external_ips()
+            port_list = handle.external_ssh_ports()
             assert ip_list is not None, 'external_ips is not cached in handle'
             ssh_credentials = backend_utils.ssh_credential_from_yaml(
                 handle.cluster_yaml)
             # Disable connection sharing for setup script to avoid old
             # connections being reused, which may cause stale ssh agent
             # forwarding.
             ssh_credentials.pop('ssh_control_name')
             runners = command_runner.SSHCommandRunner.make_runner_list(
-                ip_list, **ssh_credentials)
+                ip_list, port_list=port_list, **ssh_credentials)
 
             # Need this `-i` option to make sure `source ~/.bashrc` work
             setup_cmd = f'/bin/bash -i /tmp/{setup_file} 2>&1'
 
             def _setup_node(runner: command_runner.SSHCommandRunner) -> None:
                 runner.rsync(source=setup_sh_path,
                              target=f'/tmp/{setup_file}',
@@ -2847,15 +2927,17 @@
         spot_dag: Optional['dag.Dag'] = None,
     ) -> None:
         """Executes generated code on the head node."""
         style = colorama.Style
         fore = colorama.Fore
         ssh_credentials = backend_utils.ssh_credential_from_yaml(
             handle.cluster_yaml)
+        head_ssh_port = backend_utils.get_head_ssh_port(handle)
         runner = command_runner.SSHCommandRunner(handle.head_ip,
+                                                 port=head_ssh_port,
                                                  **ssh_credentials)
         with tempfile.NamedTemporaryFile('w', prefix='sky_app_') as fp:
             fp.write(codegen)
             fp.flush()
             script_path = os.path.join(SKY_REMOTE_APP_DIR, f'sky_job_{job_id}')
             # We choose to sync code + exec, because the alternative of 'ray
             # submit' may not work as it may use system python (python2) to
@@ -2889,15 +2971,14 @@
                 '--address=http://127.0.0.1:$RAY_DASHBOARD_PORT '
                 f'--submission-id {ray_job_id} --no-wait '
                 f'"{executable} -u {script_path} > {remote_log_path} 2>&1"')
 
             mkdir_code = (f'{cd} && mkdir -p {remote_log_dir} && '
                           f'touch {remote_log_path}')
             code = job_lib.JobLibCodeGen.queue_job(job_id, job_submit_cmd)
-
             job_submit_cmd = mkdir_code + ' && ' + code
 
             if spot_dag is not None:
                 # Add the spot job to spot queue table.
                 spot_codegen = spot_lib.SpotCodeGen()
                 spot_code = spot_codegen.set_pending(job_id, spot_dag)
                 # Set the spot job to PENDING state to make sure that this spot
@@ -3249,18 +3330,21 @@
         fore = colorama.Fore
         for job_id, log_dir in zip(job_ids, local_log_dirs):
             logger.info(f'{fore.CYAN}Job {job_id} logs: {log_dir}'
                         f'{style.RESET_ALL}')
 
         ip_list = handle.external_ips()
         assert ip_list is not None, 'external_ips is not cached in handle'
+        ssh_port_list = handle.external_ssh_ports()
+        assert ssh_port_list is not None, 'external_ssh_ports is not cached ' \
+                                          'in handle'
         ssh_credentials = backend_utils.ssh_credential_from_yaml(
             handle.cluster_yaml)
         runners = command_runner.SSHCommandRunner.make_runner_list(
-            ip_list, **ssh_credentials)
+            ip_list, port_list=ssh_port_list, **ssh_credentials)
 
         def _rsync_down(args) -> None:
             """Rsync down logs from remote nodes.
 
             Args:
                 args: A tuple of (runner, local_log_dir, remote_log_dir)
             """
@@ -3762,17 +3846,21 @@
                 command.
             separate_stderr: Whether to separate stderr from stdout.
             process_stream: Whether to post-process the stdout/stderr of the
                 command, such as replacing or skipping lines on the fly. If
                 enabled, lines are printed only when '\r' or '\n' is found.
         """
         head_ip = backend_utils.get_head_ip(handle, _FETCH_IP_MAX_ATTEMPTS)
+        head_ssh_port = backend_utils.get_head_ssh_port(handle,
+                                                        _FETCH_IP_MAX_ATTEMPTS)
         ssh_credentials = backend_utils.ssh_credential_from_yaml(
             handle.cluster_yaml)
-        runner = command_runner.SSHCommandRunner(head_ip, **ssh_credentials)
+        runner = command_runner.SSHCommandRunner(head_ip,
+                                                 port=head_ssh_port,
+                                                 **ssh_credentials)
         if under_remote_workdir:
             cmd = f'cd {SKY_REMOTE_WORKDIR} && {cmd}'
 
         return runner.run(
             cmd,
             port_forward=port_forward,
             log_path=log_path,
@@ -3898,15 +3986,15 @@
         """Sets TPU_NAME on all nodes."""
         ip_list = handle.external_ips()
         assert ip_list is not None, 'external_ips is not cached in handle'
         ssh_credentials = backend_utils.ssh_credential_from_yaml(
             handle.cluster_yaml)
 
         runners = command_runner.SSHCommandRunner.make_runner_list(
-            ip_list, **ssh_credentials)
+            ip_list, port_list=None, **ssh_credentials)
 
         def _setup_tpu_name_on_node(
                 runner: command_runner.SSHCommandRunner) -> None:
             cmd = (f'[[ -z $TPU_NAME ]] && echo "export TPU_NAME={tpu_name}" '
                    '>> ~/.bashrc || echo "TPU_NAME already set"')
             returncode = runner.run(cmd,
                                     log_path=os.path.join(
@@ -3929,19 +4017,20 @@
             return
         symlink_commands = []
         fore = colorama.Fore
         style = colorama.Style
         logger.info(f'{fore.CYAN}Processing file mounts.{style.RESET_ALL}')
         start = time.time()
         ip_list = handle.external_ips()
+        port_list = handle.external_ssh_ports()
         assert ip_list is not None, 'external_ips is not cached in handle'
         ssh_credentials = backend_utils.ssh_credential_from_yaml(
             handle.cluster_yaml)
         runners = command_runner.SSHCommandRunner.make_runner_list(
-            ip_list, **ssh_credentials)
+            ip_list, port_list=port_list, **ssh_credentials)
         log_path = os.path.join(self.log_dir, 'file_mounts.log')
 
         # Check the files and warn
         for dst, src in file_mounts.items():
             if not data_utils.is_cloud_store_url(src):
                 full_src = os.path.abspath(os.path.expanduser(src))
                 # Checked during Task.set_file_mounts().
@@ -4076,19 +4165,20 @@
         fore = colorama.Fore
         style = colorama.Style
         plural = 's' if len(storage_mounts) > 1 else ''
         logger.info(f'{fore.CYAN}Processing {len(storage_mounts)} '
                     f'storage mount{plural}.{style.RESET_ALL}')
         start = time.time()
         ip_list = handle.external_ips()
+        port_list = handle.external_ssh_ports()
         assert ip_list is not None, 'external_ips is not cached in handle'
         ssh_credentials = backend_utils.ssh_credential_from_yaml(
             handle.cluster_yaml)
         runners = command_runner.SSHCommandRunner.make_runner_list(
-            ip_list, **ssh_credentials)
+            ip_list, port_list=port_list, **ssh_credentials)
         log_path = os.path.join(self.log_dir, 'storage_mounts.log')
 
         for dst, storage_obj in storage_mounts.items():
             if not os.path.isabs(dst) and not dst.startswith('~/'):
                 dst = f'{SKY_REMOTE_WORKDIR}/{dst}'
             # Get the first store and use it to mount
             store = list(storage_obj.stores.values())[0]
```

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/backends/docker_utils.py` & `skypilot-nightly-1.0.0.dev20230803/sky/backends/docker_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/backends/local_docker_backend.py` & `skypilot-nightly-1.0.0.dev20230803/sky/backends/local_docker_backend.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/backends/monkey_patches/monkey_patch_ray_up.py` & `skypilot-nightly-1.0.0.dev20230803/sky/backends/monkey_patches/monkey_patch_ray_up.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/backends/onprem_utils.py` & `skypilot-nightly-1.0.0.dev20230803/sky/backends/onprem_utils.py`

 * *Files 0% similar despite different names*

```diff
@@ -542,15 +542,15 @@
 
     setup_cmds = config['setup_commands']
     if extra_setup_cmds is not None:
         setup_cmds += extra_setup_cmds
     setup_script = log_lib.make_task_bash_script('\n'.join(setup_cmds))
 
     worker_runners = command_runner.SSHCommandRunner.make_runner_list(
-        worker_ips, **ssh_credentials)
+        worker_ips, port_list=None, **ssh_credentials)
 
     # Uploads setup script to the worker node
     with tempfile.NamedTemporaryFile('w', prefix='sky_setup_') as f:
         f.write(setup_script)
         f.flush()
         setup_sh_path = f.name
         setup_file = os.path.basename(setup_sh_path)
```

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/backends/wheel_utils.py` & `skypilot-nightly-1.0.0.dev20230803/sky/backends/wheel_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/benchmark/benchmark_state.py` & `skypilot-nightly-1.0.0.dev20230803/sky/benchmark/benchmark_state.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/benchmark/benchmark_utils.py` & `skypilot-nightly-1.0.0.dev20230803/sky/benchmark/benchmark_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/check.py` & `skypilot-nightly-1.0.0.dev20230803/sky/check.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/cli.py` & `skypilot-nightly-1.0.0.dev20230803/sky/cli.py`

 * *Files 2% similar despite different names*

```diff
@@ -58,18 +58,20 @@
 from sky.backends import onprem_utils
 from sky.benchmark import benchmark_state
 from sky.benchmark import benchmark_utils
 from sky.clouds import service_catalog
 from sky.data import storage_utils
 from sky.skylet import constants
 from sky.skylet import job_lib
-from sky.utils import log_utils
 from sky.utils import common_utils
-from sky.utils import dag_utils
 from sky.utils import command_runner
+from sky.utils import dag_utils
+from sky.utils import env_options
+from sky.utils import kubernetes_utils
+from sky.utils import log_utils
 from sky.utils import schemas
 from sky.utils import subprocess_utils
 from sky.utils import timeline
 from sky.utils import ux_utils
 from sky.utils.cli_utils import status_utils
 from sky.usage import usage_lib
 
@@ -3112,14 +3114,17 @@
 
     * ``HOST_MEM``: Memory of the host instance (VM).
 
     If ``--region`` is not specified, the price displayed for each instance
     type is the lowest across all regions for both on-demand and spot
     instances. There may be multiple regions with the same lowest price.
     """
+    # validation for the --cloud kubernetes
+    if cloud == 'kubernetes':
+        raise click.UsageError('Kubernetes does not have a service catalog.')
     # validation for the --region flag
     if region is not None and cloud is None:
         raise click.UsageError(
             'The --region flag is only valid when the --cloud flag is set.')
     # This will validate 'cloud' and raise if not found.
     clouds.CLOUD_REGISTRY.from_str(cloud)
     service_catalog.validate_region_zone(region, None, clouds=cloud)
@@ -4448,13 +4453,104 @@
 
     with progress:
         subprocess_utils.run_in_parallel(_delete_benchmark, to_delete)
         progress.live.transient = False
         progress.refresh()
 
 
+@cli.group(cls=_NaturalOrderGroup, hidden=True)
+def local():
+    """SkyPilot local tools CLI."""
+    pass
+
+
+@local.command('up', cls=_DocumentedCodeCommand)
+@usage_lib.entrypoint
+def local_up():
+    """Creates a local cluster."""
+    cluster_created = False
+    # Check if ~/.kube/config exists:
+    if os.path.exists(os.path.expanduser('~/.kube/config')):
+        curr_context = kubernetes_utils.get_current_kube_config_context_name()
+        skypilot_context = 'kind-skypilot'
+        if curr_context is not None and curr_context != skypilot_context:
+            click.echo(
+                f'Current context in kube config: {curr_context}'
+                '\nWill automatically switch to kind-skypilot after the local '
+                'cluster is created.')
+    with log_utils.safe_rich_status('Creating local cluster...'):
+        path_to_package = os.path.dirname(os.path.dirname(__file__))
+        up_script_path = os.path.join(path_to_package, 'sky/utils/kubernetes',
+                                      'create_cluster.sh')
+        # Get directory of script and run it from there
+        cwd = os.path.dirname(os.path.abspath(up_script_path))
+        # Run script and don't print output
+        try:
+            subprocess_utils.run(up_script_path, cwd=cwd, capture_output=True)
+            cluster_created = True
+        except subprocess.CalledProcessError as e:
+            # Check if return code is 100
+            if e.returncode == 100:
+                click.echo('\nLocal cluster already exists. '
+                           'Run `sky local down` to delete it.')
+            else:
+                stderr = e.stderr.decode('utf-8')
+                click.echo(f'\nFailed to create local cluster. {stderr}')
+                if env_options.Options.SHOW_DEBUG_INFO.get():
+                    stdout = e.stdout.decode('utf-8')
+                    click.echo(f'Logs:\n{stdout}')
+                sys.exit(1)
+    # Run sky check
+    with log_utils.safe_rich_status('Running sky check...'):
+        sky_check.check(quiet=True)
+    if cluster_created:
+        # Get number of CPUs
+        p = subprocess_utils.run(
+            'kubectl get nodes -o jsonpath=\'{.items[0].status.capacity.cpu}\'',
+            capture_output=True)
+        num_cpus = int(p.stdout.decode('utf-8'))
+        if num_cpus < 2:
+            click.echo('Warning: Local cluster has less than 2 CPUs. '
+                       'This may cause issues with running tasks.')
+        click.echo(
+            'Local Kubernetes cluster created successfully with '
+            f'{num_cpus} CPUs. `sky launch` can now run tasks locally.'
+            '\nHint: To change the number of CPUs, change your docker '
+            'runtime settings. See https://kind.sigs.k8s.io/docs/user/quick-start/#settings-for-docker-desktop for more info.'  # pylint: disable=line-too-long
+        )
+
+
+@local.command('down', cls=_DocumentedCodeCommand)
+@usage_lib.entrypoint
+def local_down():
+    """Deletes a local cluster."""
+    cluster_removed = False
+    with log_utils.safe_rich_status('Removing local cluster...'):
+        path_to_package = os.path.dirname(os.path.dirname(__file__))
+        down_script_path = os.path.join(path_to_package, 'sky/utils/kubernetes',
+                                        'delete_cluster.sh')
+        try:
+            subprocess_utils.run(down_script_path, capture_output=True)
+            cluster_removed = True
+        except subprocess.CalledProcessError as e:
+            # Check if return code is 100
+            if e.returncode == 100:
+                click.echo('\nLocal cluster does not exist.')
+            else:
+                stderr = e.stderr.decode('utf-8')
+                click.echo(f'\nFailed to delete local cluster. {stderr}')
+                if env_options.Options.SHOW_DEBUG_INFO.get():
+                    stdout = e.stdout.decode('utf-8')
+                    click.echo(f'Logs:\n{stdout}')
+    if cluster_removed:
+        # Run sky check
+        with log_utils.safe_rich_status('Running sky check...'):
+            sky_check.check(quiet=True)
+        click.echo('Local cluster removed.')
+
+
 def main():
     return cli()
 
 
 if __name__ == '__main__':
     main()
```

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/cloud_stores.py` & `skypilot-nightly-1.0.0.dev20230803/sky/cloud_stores.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/clouds/__init__.py` & `skypilot-nightly-1.0.0.dev20230803/sky/clouds/__init__.py`

 * *Files 6% similar despite different names*

```diff
@@ -8,23 +8,25 @@
 from sky.clouds.azure import Azure
 from sky.clouds.gcp import GCP
 from sky.clouds.lambda_cloud import Lambda
 from sky.clouds.local import Local
 from sky.clouds.ibm import IBM
 from sky.clouds.scp import SCP
 from sky.clouds.oci import OCI
+from sky.clouds.kubernetes import Kubernetes
 
 __all__ = [
     'IBM',
     'AWS',
     'Azure',
     'Cloud',
     'GCP',
     'Lambda',
     'Local',
     'SCP',
     'OCI',
+    'Kubernetes',
     'CloudImplementationFeatures',
     'Region',
     'Zone',
     'CLOUD_REGISTRY',
 ]
```

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/clouds/aws.py` & `skypilot-nightly-1.0.0.dev20230803/sky/clouds/aws.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/clouds/azure.py` & `skypilot-nightly-1.0.0.dev20230803/sky/clouds/azure.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/clouds/cloud.py` & `skypilot-nightly-1.0.0.dev20230803/sky/clouds/cloud.py`

 * *Files 0% similar despite different names*

```diff
@@ -598,14 +598,18 @@
         actual status of the clusters may change on the cloud, e.g., the
         autostop happens, or the user manually stops the cluster. This
         method queries the cloud to get the latest cluster status.
 
         Returns:
             A list of ClusterStatus representing the status of all the
             alive nodes in the cluster.
+
+        Raises:
+            exceptions.ClusterStatusFetchingError: raised if the status of the
+                cluster cannot be fetched.
         """
         raise NotImplementedError
 
     # === Image related methods ===
     # These three methods are used to create, move and delete images. They
     # are currently only used in `sky launch --clone-disk-from` to clone a
     # cluster's disk to launch a new cluster.
```

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/clouds/gcp.py` & `skypilot-nightly-1.0.0.dev20230803/sky/clouds/gcp.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/clouds/ibm.py` & `skypilot-nightly-1.0.0.dev20230803/sky/clouds/ibm.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/clouds/lambda_cloud.py` & `skypilot-nightly-1.0.0.dev20230803/sky/clouds/lambda_cloud.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/clouds/local.py` & `skypilot-nightly-1.0.0.dev20230803/sky/clouds/local.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/clouds/oci.py` & `skypilot-nightly-1.0.0.dev20230803/sky/clouds/oci.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/clouds/scp.py` & `skypilot-nightly-1.0.0.dev20230803/sky/clouds/scp.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/__init__.py` & `skypilot-nightly-1.0.0.dev20230803/sky/clouds/service_catalog/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/aws_catalog.py` & `skypilot-nightly-1.0.0.dev20230803/sky/clouds/service_catalog/aws_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/azure_catalog.py` & `skypilot-nightly-1.0.0.dev20230803/sky/clouds/service_catalog/azure_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/common.py` & `skypilot-nightly-1.0.0.dev20230803/sky/clouds/service_catalog/common.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/config.py` & `skypilot-nightly-1.0.0.dev20230803/sky/clouds/service_catalog/config.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/data_fetchers/fetch_aws.py` & `skypilot-nightly-1.0.0.dev20230803/sky/clouds/service_catalog/data_fetchers/fetch_aws.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/data_fetchers/fetch_azure.py` & `skypilot-nightly-1.0.0.dev20230803/sky/clouds/service_catalog/data_fetchers/fetch_azure.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py` & `skypilot-nightly-1.0.0.dev20230803/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py` & `skypilot-nightly-1.0.0.dev20230803/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/gcp_catalog.py` & `skypilot-nightly-1.0.0.dev20230803/sky/clouds/service_catalog/gcp_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/ibm_catalog.py` & `skypilot-nightly-1.0.0.dev20230803/sky/clouds/service_catalog/ibm_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/lambda_catalog.py` & `skypilot-nightly-1.0.0.dev20230803/sky/clouds/service_catalog/lambda_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/oci_catalog.py` & `skypilot-nightly-1.0.0.dev20230803/sky/clouds/service_catalog/oci_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/scp_catalog.py` & `skypilot-nightly-1.0.0.dev20230803/sky/clouds/service_catalog/scp_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/core.py` & `skypilot-nightly-1.0.0.dev20230803/sky/core.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/dag.py` & `skypilot-nightly-1.0.0.dev20230803/sky/dag.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/data/data_transfer.py` & `skypilot-nightly-1.0.0.dev20230803/sky/data/data_transfer.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/data/data_utils.py` & `skypilot-nightly-1.0.0.dev20230803/sky/data/data_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/data/mounting_utils.py` & `skypilot-nightly-1.0.0.dev20230803/sky/data/mounting_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/data/storage.py` & `skypilot-nightly-1.0.0.dev20230803/sky/data/storage.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/data/storage_utils.py` & `skypilot-nightly-1.0.0.dev20230803/sky/data/storage_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/exceptions.py` & `skypilot-nightly-1.0.0.dev20230803/sky/exceptions.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/execution.py` & `skypilot-nightly-1.0.0.dev20230803/sky/execution.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/global_user_state.py` & `skypilot-nightly-1.0.0.dev20230803/sky/global_user_state.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/optimizer.py` & `skypilot-nightly-1.0.0.dev20230803/sky/optimizer.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/provision/__init__.py` & `skypilot-nightly-1.0.0.dev20230803/sky/provision/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/provision/aws/instance.py` & `skypilot-nightly-1.0.0.dev20230803/sky/provision/aws/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/provision/gcp/instance.py` & `skypilot-nightly-1.0.0.dev20230803/sky/provision/gcp/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/provision/gcp/instance_utils.py` & `skypilot-nightly-1.0.0.dev20230803/sky/provision/gcp/instance_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/resources.py` & `skypilot-nightly-1.0.0.dev20230803/sky/resources.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/setup_files/MANIFEST.in` & `skypilot-nightly-1.0.0.dev20230803/sky/setup_files/MANIFEST.in`

 * *Files 14% similar despite different names*

```diff
@@ -3,16 +3,18 @@
 include sky/setup_files/*
 include sky/skylet/*.sh
 include sky/skylet/LICENSE
 include sky/skylet/providers/aws/*
 include sky/skylet/providers/aws/cloudwatch/*
 include sky/skylet/providers/azure/*
 include sky/skylet/providers/gcp/*
-include sky/skylet/providers/lambda_cloud/*
 include sky/skylet/providers/ibm/*
-include sky/skylet/providers/scp/*
+include sky/skylet/providers/kubernetes/*
+include sky/skylet/providers/lambda_cloud/*
 include sky/skylet/providers/oci/*
+include sky/skylet/providers/scp/*
 include sky/skylet/ray_patches/*.patch
 include sky/spot/dashboard/*
 include sky/spot/dashboard/templates/*
 include sky/spot/dashboard/static/*
 include sky/templates/*
+include sky/utils/kubernetes/*
```

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/setup_files/setup.py` & `skypilot-nightly-1.0.0.dev20230803/sky/setup_files/setup.py`

 * *Files 1% similar despite different names*

```diff
@@ -153,14 +153,15 @@
         'ibm-cloud-sdk-core', 'ibm-vpc', 'ibm-platform-services', 'ibm-cos-sdk'
     ],
     'docker': ['docker'],
     'lambda': [],
     'cloudflare': aws_dependencies,
     'scp': [],
     'oci': ['oci'],
+    'kubernetes': ['kubernetes'],
 }
 
 extras_require['all'] = sum(extras_require.values(), [])
 
 # Install aws requirements by default, as it is the most common cloud provider,
 # and the installation is quick.
 install_requires += extras_require['aws']
```

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/sky_logging.py` & `skypilot-nightly-1.0.0.dev20230803/sky/sky_logging.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/skylet/LICENSE` & `skypilot-nightly-1.0.0.dev20230803/sky/skylet/LICENSE`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/skylet/attempt_skylet.py` & `skypilot-nightly-1.0.0.dev20230803/sky/skylet/attempt_skylet.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/skylet/autostop_lib.py` & `skypilot-nightly-1.0.0.dev20230803/sky/skylet/autostop_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/skylet/configs.py` & `skypilot-nightly-1.0.0.dev20230803/sky/skylet/configs.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/skylet/constants.py` & `skypilot-nightly-1.0.0.dev20230803/sky/skylet/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/skylet/events.py` & `skypilot-nightly-1.0.0.dev20230803/sky/skylet/events.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/skylet/job_lib.py` & `skypilot-nightly-1.0.0.dev20230803/sky/skylet/job_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/skylet/log_lib.py` & `skypilot-nightly-1.0.0.dev20230803/sky/skylet/log_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/aws/cloudwatch/cloudwatch_helper.py` & `skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/aws/cloudwatch/cloudwatch_helper.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/aws/config.py` & `skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/aws/config.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/aws/node_provider.py` & `skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/aws/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/aws/utils.py` & `skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/aws/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/azure/azure-config-template.json` & `skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/azure/azure-config-template.json`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/azure/azure-vm-template.json` & `skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/azure/azure-vm-template.json`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/azure/config.py` & `skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/azure/config.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/azure/node_provider.py` & `skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/azure/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/gcp/config.py` & `skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/gcp/config.py`

 * *Files 0% similar despite different names*

```diff
@@ -884,15 +884,15 @@
         if get_node_type(node_config) == GCPNodeType.COMPUTE:
             if "tags" not in node_config:
                 node_config["tags"] = {"items": []}
             # Add cluster name to the tags so that firewall rules will apply to
             # the created VM.
             node_config["tags"]["items"].append(config["cluster_name"])
         else:
-            assert get_node_type(node_config) == GCPNodeType.GCPTPU, node_config
+            assert get_node_type(node_config) == GCPNodeType.TPU, node_config
             # TPU VM has a different api for tags. See
             # https://cloud.google.com/tpu/docs/reference/rest/v2alpha1/projects.locations.nodes  # pylint: disable=line-too-long
             if "tags" not in node_config:
                 node_config["tags"] = []
             node_config["tags"].append(config["cluster_name"])
 
     return config
```

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/gcp/constants.py` & `skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/gcp/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/gcp/node.py` & `skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/gcp/node.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/gcp/node_provider.py` & `skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/gcp/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/ibm/node_provider.py` & `skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/ibm/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/ibm/utils.py` & `skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/ibm/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/ibm/vpc_provider.py` & `skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/ibm/vpc_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/lambda_cloud/lambda_utils.py` & `skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/lambda_cloud/lambda_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/lambda_cloud/node_provider.py` & `skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/lambda_cloud/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/oci/config.py` & `skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/oci/config.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/oci/node_provider.py` & `skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/oci/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/oci/query_helper.py` & `skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/oci/query_helper.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/scp/config.py` & `skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/scp/config.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/scp/node_provider.py` & `skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/scp/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/scp/scp_utils.py` & `skypilot-nightly-1.0.0.dev20230803/sky/skylet/providers/scp/scp_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/skylet/ray_patches/__init__.py` & `skypilot-nightly-1.0.0.dev20230803/sky/skylet/ray_patches/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/skylet/ray_patches/log_monitor.py.patch` & `skypilot-nightly-1.0.0.dev20230803/sky/skylet/ray_patches/log_monitor.py.patch`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/skylet/ray_patches/resource_demand_scheduler.py.patch` & `skypilot-nightly-1.0.0.dev20230803/sky/skylet/ray_patches/resource_demand_scheduler.py.patch`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/skylet/ray_patches/worker.py.patch` & `skypilot-nightly-1.0.0.dev20230803/sky/skylet/ray_patches/worker.py.patch`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/skylet/skylet.py` & `skypilot-nightly-1.0.0.dev20230803/sky/skylet/skylet.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/skylet/subprocess_daemon.py` & `skypilot-nightly-1.0.0.dev20230803/sky/skylet/subprocess_daemon.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/skypilot_config.py` & `skypilot-nightly-1.0.0.dev20230803/sky/skypilot_config.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/spot/__init__.py` & `skypilot-nightly-1.0.0.dev20230803/sky/spot/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/spot/constants.py` & `skypilot-nightly-1.0.0.dev20230803/sky/spot/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/spot/controller.py` & `skypilot-nightly-1.0.0.dev20230803/sky/spot/controller.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/spot/dashboard/dashboard.py` & `skypilot-nightly-1.0.0.dev20230803/sky/spot/dashboard/dashboard.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/spot/dashboard/static/favicon.ico` & `skypilot-nightly-1.0.0.dev20230803/sky/spot/dashboard/static/favicon.ico`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/spot/dashboard/templates/index.html` & `skypilot-nightly-1.0.0.dev20230803/sky/spot/dashboard/templates/index.html`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/spot/recovery_strategy.py` & `skypilot-nightly-1.0.0.dev20230803/sky/spot/recovery_strategy.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/spot/spot_state.py` & `skypilot-nightly-1.0.0.dev20230803/sky/spot/spot_state.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/spot/spot_utils.py` & `skypilot-nightly-1.0.0.dev20230803/sky/spot/spot_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/status_lib.py` & `skypilot-nightly-1.0.0.dev20230803/sky/status_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/task.py` & `skypilot-nightly-1.0.0.dev20230803/sky/task.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/templates/aws-ray.yml.j2` & `skypilot-nightly-1.0.0.dev20230803/sky/templates/aws-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/templates/azure-ray.yml.j2` & `skypilot-nightly-1.0.0.dev20230803/sky/templates/azure-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/templates/gcp-ray.yml.j2` & `skypilot-nightly-1.0.0.dev20230803/sky/templates/gcp-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/templates/ibm-ray.yml.j2` & `skypilot-nightly-1.0.0.dev20230803/sky/templates/ibm-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/templates/lambda-ray.yml.j2` & `skypilot-nightly-1.0.0.dev20230803/sky/templates/lambda-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/templates/local-ray.yml.j2` & `skypilot-nightly-1.0.0.dev20230803/sky/templates/local-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/templates/oci-ray.yml.j2` & `skypilot-nightly-1.0.0.dev20230803/sky/templates/oci-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/templates/scp-ray.yml.j2` & `skypilot-nightly-1.0.0.dev20230803/sky/templates/scp-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/templates/spot-controller.yaml.j2` & `skypilot-nightly-1.0.0.dev20230803/sky/templates/spot-controller.yaml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/usage/constants.py` & `skypilot-nightly-1.0.0.dev20230803/sky/usage/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/usage/usage_lib.py` & `skypilot-nightly-1.0.0.dev20230803/sky/usage/usage_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/utils/accelerator_registry.py` & `skypilot-nightly-1.0.0.dev20230803/sky/utils/accelerator_registry.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/utils/cli_utils/status_utils.py` & `skypilot-nightly-1.0.0.dev20230803/sky/utils/cli_utils/status_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/utils/command_runner.py` & `skypilot-nightly-1.0.0.dev20230803/sky/utils/command_runner.py`

 * *Files 3% similar despite different names*

```diff
@@ -40,19 +40,22 @@
     return path
 
 
 def ssh_options_list(ssh_private_key: Optional[str],
                      ssh_control_name: Optional[str],
                      *,
                      ssh_proxy_command: Optional[str] = None,
-                     timeout: int = 30) -> List[str]:
+                     timeout: int = 30,
+                     port: int = 22) -> List[str]:
     """Returns a list of sane options for 'ssh'."""
     # Forked from Ray SSHOptions:
     # https://github.com/ray-project/ray/blob/master/python/ray/autoscaler/_private/command_runner.py
     arg_dict = {
+        # SSH port
+        'Port': port,
         # Supresses initial fingerprint verification.
         'StrictHostKeyChecking': 'no',
         # SSH IP and fingerprint pairs no longer added to known_hosts.
         # This is to remove a 'REMOTE HOST IDENTIFICATION HAS CHANGED'
         # warning if a new node has the same IP as a previously
         # deleted node, because the fingerprints will not match in
         # that case.
@@ -115,14 +118,15 @@
     def __init__(
         self,
         ip: str,
         ssh_user: str,
         ssh_private_key: str,
         ssh_control_name: Optional[str] = '__default__',
         ssh_proxy_command: Optional[str] = None,
+        port: int = 22,
     ):
         """Initialize SSHCommandRunner.
 
         Example Usage:
             runner = SSHCommandRunner(ip, ssh_user, ssh_private_key)
             runner.run('ls -l', mode=SshMode.NON_INTERACTIVE)
             runner.rsync(source, target, up=True)
@@ -134,35 +138,41 @@
             ssh_control_name: The files name of the ssh_control to use. This is
                 used to avoid confliction between clusters for creating ssh
                 control files. It can simply be the cluster_name or any name
                 that can distinguish between clusters.
             ssh_proxy_command: Optional, the value to pass to '-o
                 ProxyCommand'. Useful for communicating with clusters without
                 public IPs using a "jump server".
+            port: The port to use for ssh.
         """
         self.ip = ip
         self.ssh_user = ssh_user
         self.ssh_private_key = ssh_private_key
         self.ssh_control_name = (
             None if ssh_control_name is None else hashlib.md5(
                 ssh_control_name.encode()).hexdigest()[:_HASH_MAX_LENGTH])
         self._ssh_proxy_command = ssh_proxy_command
+        self.port = port
 
     @staticmethod
     def make_runner_list(
         ip_list: List[str],
         ssh_user: str,
         ssh_private_key: str,
         ssh_control_name: Optional[str] = None,
         ssh_proxy_command: Optional[str] = None,
+        port_list: Optional[List[int]] = None,
     ) -> List['SSHCommandRunner']:
         """Helper function for creating runners with the same ssh credentials"""
+        if not port_list:
+            port_list = [22] * len(ip_list)
         return [
             SSHCommandRunner(ip, ssh_user, ssh_private_key, ssh_control_name,
-                             ssh_proxy_command) for ip in ip_list
+                             ssh_proxy_command, port)
+            for ip, port in zip(ip_list, port_list)
         ]
 
     def _ssh_base_command(self, *, ssh_mode: SshMode,
                           port_forward: Optional[List[int]]) -> List[str]:
         ssh = ['ssh']
         if ssh_mode == SshMode.NON_INTERACTIVE:
             # Disable pseudo-terminal allocation. Otherwise, the output of
@@ -177,14 +187,15 @@
                 logger.info(
                     f'Forwarding port {local} to port {remote} on localhost.')
                 ssh += ['-L', f'{remote}:localhost:{local}']
         return ssh + ssh_options_list(
             self.ssh_private_key,
             self.ssh_control_name,
             ssh_proxy_command=self._ssh_proxy_command,
+            port=self.port,
         ) + [f'{self.ssh_user}@{self.ip}']
 
     def run(
             self,
             cmd: Union[str, List[str]],
             *,
             require_outputs: bool = False,
@@ -331,14 +342,15 @@
                         str(resolved_source / GIT_EXCLUDE)))
 
         ssh_options = ' '.join(
             ssh_options_list(
                 self.ssh_private_key,
                 self.ssh_control_name,
                 ssh_proxy_command=self._ssh_proxy_command,
+                port=self.port,
             ))
         rsync_command.append(f'-e "ssh {ssh_options}"')
         # To support spaces in the path, we need to quote source and target.
         # rsync doesn't support '~' in a quoted local path, but it is ok to
         # have '~' in a quoted remote path.
         if up:
             full_source_str = str(resolved_source)
```

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/utils/common_utils.py` & `skypilot-nightly-1.0.0.dev20230803/sky/utils/common_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/utils/dag_utils.py` & `skypilot-nightly-1.0.0.dev20230803/sky/utils/dag_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/utils/db_utils.py` & `skypilot-nightly-1.0.0.dev20230803/sky/utils/db_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/utils/env_options.py` & `skypilot-nightly-1.0.0.dev20230803/sky/utils/env_options.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/utils/log_utils.py` & `skypilot-nightly-1.0.0.dev20230803/sky/utils/log_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/utils/schemas.py` & `skypilot-nightly-1.0.0.dev20230803/sky/utils/schemas.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/utils/subprocess_utils.py` & `skypilot-nightly-1.0.0.dev20230803/sky/utils/subprocess_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/utils/timeline.py` & `skypilot-nightly-1.0.0.dev20230803/sky/utils/timeline.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/utils/tpu_utils.py` & `skypilot-nightly-1.0.0.dev20230803/sky/utils/tpu_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/utils/ux_utils.py` & `skypilot-nightly-1.0.0.dev20230803/sky/utils/ux_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/sky/utils/validator.py` & `skypilot-nightly-1.0.0.dev20230803/sky/utils/validator.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/skypilot_nightly.egg-info/PKG-INFO` & `skypilot-nightly-1.0.0.dev20230803/skypilot_nightly.egg-info/PKG-INFO`

 * *Files 4% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: skypilot-nightly
-Version: 1.0.0.dev20230802
+Version: 1.0.0.dev20230803
 Summary: SkyPilot: An intercloud broker for the clouds
 Author: SkyPilot Team
 License: Apache 2.0
 Project-URL: Homepage, https://github.com/skypilot-org/skypilot
 Project-URL: Issues, https://github.com/skypilot-org/skypilot/issues
 Project-URL: Discussion, https://github.com/skypilot-org/skypilot/discussions
 Project-URL: Documentation, https://skypilot.readthedocs.io/en/latest/
@@ -22,14 +22,15 @@
 Provides-Extra: gcp
 Provides-Extra: ibm
 Provides-Extra: docker
 Provides-Extra: lambda
 Provides-Extra: cloudflare
 Provides-Extra: scp
 Provides-Extra: oci
+Provides-Extra: kubernetes
 Provides-Extra: all
 License-File: LICENSE
 
 <p align="center">
   <img alt="SkyPilot" src="https://raw.githubusercontent.com/skypilot-org/skypilot/master/docs/source/images/skypilot-wide-light-1k.png" width=55%>
 </p>
 
@@ -51,20 +52,20 @@
 
 <h3 align="center">
     Run LLMs and AI on Any Cloud
 </h3>
 
 ----
 :fire: *News* :fire:
-- [July, 2023] Self-Hosted **LLaMA 2 Chatbot** on Any Cloud: [**example**](./llm/llama-2/)
+- [Aug, 2023] New cookbook: Finetuning Llama 2 in your own cloud environment, privately: [**example**](./llm/vicuna-llama-2/), [**blog post**](https://blog.skypilot.co/finetuning-llama2-operational-guide/)
+- [July, 2023] Self-Hosted **Llama-2 Chatbot** on Any Cloud: [**example**](./llm/llama-2/)
 - [June, 2023] Serving LLM **24x Faster On the Cloud** with vLLM and SkyPilot: [**example**](./llm/vllm/), [**blog post**](https://blog.skypilot.co/serving-llm-24x-faster-on-the-cloud-with-vllm-and-skypilot/)
 - [June, 2023] [**Two new clouds supported**](https://skypilot.readthedocs.io/en/latest/getting-started/installation.html): Samsung SCP and Oracle OCI!
 - [April, 2023] **[**SkyPilot YAMLs released**](./llm/vicuna/) for finetuning & serving the Vicuna model with a single command**!
 - [March, 2023] **[Vicuna LLM chatbot](https://lmsys.org/blog/2023-03-30-vicuna/) trained** [**using SkyPilot**](./llm/vicuna/) **for $300 on spot instances!** 
-- [March, 2023] Serve your own LLaMA LLM chatbot (not finetuned) on any cloud: [**example**](./llm/llama-chatbots/), [**repo**](https://github.com/skypilot-org/sky-llama)
 ----
 
 SkyPilot is a framework for running LLMs, AI, and batch jobs on any cloud, offering maximum cost savings, highest GPU availability, and managed execution.
 
 SkyPilot **abstracts away cloud infra burdens**:
 - Launch jobs & clusters on any cloud 
 - Easy scale-out: queue and run many jobs, automatically managed
@@ -152,15 +153,16 @@
 Refer to [Quickstart](https://skypilot.readthedocs.io/en/latest/getting-started/quickstart.html) to get started with SkyPilot.
 
 ## More Information
 To learn more, see our [Documentation](https://skypilot.readthedocs.io/en/latest/) and [Tutorials](https://github.com/skypilot-org/skypilot-tutorial).
 
 Runnable examples:
 - LLMs on SkyPilot
-  - [Self-Hosted LLaMA 2 Chatbot](./llm/llama-2/)
+  - [Train Your Own Vicuna on Llama-2](./llm/vicuna-llama-2/)
+  - [Self-Hosted Llama-2 Chatbot](./llm/llama-2/)
   - [Vicuna chatbots: Training & Serving](./llm/vicuna/) (from official Vicuna team)
   - [vLLM: Serving LLM 24x Faster On the Cloud](./llm/vllm/) (from official vLLM team)
   - [QLoRA](https://github.com/artidoro/qlora/pull/132)
   - [LLaMA-LoRA-Tuner](https://github.com/zetavg/LLaMA-LoRA-Tuner#run-on-a-cloud-service-via-skypilot)
   - [Tabby: Self-hosted AI coding assistant](https://github.com/TabbyML/tabby/blob/bed723fcedb44a6b867ce22a7b1f03d2f3531c1e/experimental/eval/skypilot.yaml)
   - [LocalGPT](./llm/localgpt)
   - Add yours here & see more in [`llm/`](./llm)!
```

#### html2text {}

```diff
@@ -1,56 +1,56 @@
-Metadata-Version: 2.1 Name: skypilot-nightly Version: 1.0.0.dev20230802
+Metadata-Version: 2.1 Name: skypilot-nightly Version: 1.0.0.dev20230803
 Summary: SkyPilot: An intercloud broker for the clouds Author: SkyPilot Team
 License: Apache 2.0 Project-URL: Homepage, https://github.com/skypilot-org/
 skypilot Project-URL: Issues, https://github.com/skypilot-org/skypilot/issues
 Project-URL: Discussion, https://github.com/skypilot-org/skypilot/discussions
 Project-URL: Documentation, https://skypilot.readthedocs.io/en/latest/
 Classifier: Programming Language :: Python :: 3.7 Classifier: Programming
 Language :: Python :: 3.8 Classifier: Programming Language :: Python :: 3.9
 Classifier: Programming Language :: Python :: 3.10 Classifier: License :: OSI
 Approved :: Apache Software License Classifier: Operating System :: OS
 Independent Classifier: Topic :: Software Development :: Libraries :: Python
 Modules Classifier: Topic :: System :: Distributed Computing Description-
 Content-Type: text/markdown Provides-Extra: aws Provides-Extra: azure Provides-
 Extra: gcp Provides-Extra: ibm Provides-Extra: docker Provides-Extra: lambda
 Provides-Extra: cloudflare Provides-Extra: scp Provides-Extra: oci Provides-
-Extra: all License-File: LICENSE
+Extra: kubernetes Provides-Extra: all License-File: LICENSE
                                   [SkyPilot]
                  [Documentation] [GitHub_Release] [Join_Slack]
                     **** Run LLMs and AI on Any Cloud ****
----- :fire: *News* :fire: - [July, 2023] Self-Hosted **LLaMA 2 Chatbot** on Any
-Cloud: [**example**](./llm/llama-2/) - [June, 2023] Serving LLM **24x Faster On
-the Cloud** with vLLM and SkyPilot: [**example**](./llm/vllm/), [**blog post**]
-(https://blog.skypilot.co/serving-llm-24x-faster-on-the-cloud-with-vllm-and-
-skypilot/) - [June, 2023] [**Two new clouds supported**](https://
-skypilot.readthedocs.io/en/latest/getting-started/installation.html): Samsung
-SCP and Oracle OCI! - [April, 2023] **[**SkyPilot YAMLs released**](./llm/
-vicuna/) for finetuning & serving the Vicuna model with a single command**! -
-[March, 2023] **[Vicuna LLM chatbot](https://lmsys.org/blog/2023-03-30-vicuna/
-) trained** [**using SkyPilot**](./llm/vicuna/) **for $300 on spot instances!**
-- [March, 2023] Serve your own LLaMA LLM chatbot (not finetuned) on any cloud:
-[**example**](./llm/llama-chatbots/), [**repo**](https://github.com/skypilot-
-org/sky-llama) ---- SkyPilot is a framework for running LLMs, AI, and batch
-jobs on any cloud, offering maximum cost savings, highest GPU availability, and
-managed execution. SkyPilot **abstracts away cloud infra burdens**: - Launch
-jobs & clusters on any cloud - Easy scale-out: queue and run many jobs,
-automatically managed - Easy access to object stores (S3, GCS, R2) SkyPilot
-**maximizes GPU availability for your jobs**: * Provision in all zones/regions/
-clouds you have access to ([the _Sky_](https://arxiv.org/abs/2205.07147)), with
-automatic failover SkyPilot **cuts your cloud costs**: * [Managed Spot](https:/
-/skypilot.readthedocs.io/en/latest/examples/spot-jobs.html): 3-6x cost savings
-using spot VMs, with auto-recovery from preemptions * Optimizer: 2x cost
-savings by auto-picking the cheapest VM/zone/region/cloud * [Autostop](https://
-skypilot.readthedocs.io/en/latest/reference/auto-stop.html): hands-free cleanup
-of idle clusters SkyPilot supports your existing GPU, TPU, and CPU workloads,
-with no code changes. Install with pip or [from source](https://
-skypilot.readthedocs.io/en/latest/getting-started/installation.html): ``` pip
-install "skypilot[aws,gcp,azure,ibm,oci,scp,lambda]" # choose your clouds ```
-Current supported providers (AWS, Azure, GCP, Lambda Cloud, IBM, Samsung, OCI,
-Cloudflare):
+---- :fire: *News* :fire: - [Aug, 2023] New cookbook: Finetuning Llama 2 in
+your own cloud environment, privately: [**example**](./llm/vicuna-llama-2/),
+[**blog post**](https://blog.skypilot.co/finetuning-llama2-operational-guide/
+) - [July, 2023] Self-Hosted **Llama-2 Chatbot** on Any Cloud: [**example**](./
+llm/llama-2/) - [June, 2023] Serving LLM **24x Faster On the Cloud** with vLLM
+and SkyPilot: [**example**](./llm/vllm/), [**blog post**](https://
+blog.skypilot.co/serving-llm-24x-faster-on-the-cloud-with-vllm-and-skypilot/) -
+[June, 2023] [**Two new clouds supported**](https://skypilot.readthedocs.io/en/
+latest/getting-started/installation.html): Samsung SCP and Oracle OCI! -
+[April, 2023] **[**SkyPilot YAMLs released**](./llm/vicuna/) for finetuning &
+serving the Vicuna model with a single command**! - [March, 2023] **[Vicuna LLM
+chatbot](https://lmsys.org/blog/2023-03-30-vicuna/) trained** [**using
+SkyPilot**](./llm/vicuna/) **for $300 on spot instances!** ---- SkyPilot is a
+framework for running LLMs, AI, and batch jobs on any cloud, offering maximum
+cost savings, highest GPU availability, and managed execution. SkyPilot
+**abstracts away cloud infra burdens**: - Launch jobs & clusters on any cloud -
+Easy scale-out: queue and run many jobs, automatically managed - Easy access to
+object stores (S3, GCS, R2) SkyPilot **maximizes GPU availability for your
+jobs**: * Provision in all zones/regions/clouds you have access to ([the _Sky_]
+(https://arxiv.org/abs/2205.07147)), with automatic failover SkyPilot **cuts
+your cloud costs**: * [Managed Spot](https://skypilot.readthedocs.io/en/latest/
+examples/spot-jobs.html): 3-6x cost savings using spot VMs, with auto-recovery
+from preemptions * Optimizer: 2x cost savings by auto-picking the cheapest VM/
+zone/region/cloud * [Autostop](https://skypilot.readthedocs.io/en/latest/
+reference/auto-stop.html): hands-free cleanup of idle clusters SkyPilot
+supports your existing GPU, TPU, and CPU workloads, with no code changes.
+Install with pip or [from source](https://skypilot.readthedocs.io/en/latest/
+getting-started/installation.html): ``` pip install "skypilot
+[aws,gcp,azure,ibm,oci,scp,lambda]" # choose your clouds ``` Current supported
+providers (AWS, Azure, GCP, Lambda Cloud, IBM, Samsung, OCI, Cloudflare):
                                   [SkyPilot]
 ## Getting Started You can find our documentation [here](https://
 skypilot.readthedocs.io/en/latest/). - [Installation](https://
 skypilot.readthedocs.io/en/latest/getting-started/installation.html) -
 [Quickstart](https://skypilot.readthedocs.io/en/latest/getting-started/
 quickstart.html) - [CLI reference](https://skypilot.readthedocs.io/en/latest/
 reference/cli.html) ## SkyPilot in 1 Minute A SkyPilot task specifies: resource
@@ -76,33 +76,34 @@
 commands to prepare the VM for running the task 5. Run the task's `run`
 commands
                                 [SkyPilot Demo]
 Refer to [Quickstart](https://skypilot.readthedocs.io/en/latest/getting-
 started/quickstart.html) to get started with SkyPilot. ## More Information To
 learn more, see our [Documentation](https://skypilot.readthedocs.io/en/latest/
 ) and [Tutorials](https://github.com/skypilot-org/skypilot-tutorial). Runnable
-examples: - LLMs on SkyPilot - [Self-Hosted LLaMA 2 Chatbot](./llm/llama-2/) -
-[Vicuna chatbots: Training & Serving](./llm/vicuna/) (from official Vicuna
-team) - [vLLM: Serving LLM 24x Faster On the Cloud](./llm/vllm/) (from official
-vLLM team) - [QLoRA](https://github.com/artidoro/qlora/pull/132) - [LLaMA-LoRA-
-Tuner](https://github.com/zetavg/LLaMA-LoRA-Tuner#run-on-a-cloud-service-via-
-skypilot) - [Tabby: Self-hosted AI coding assistant](https://github.com/
-TabbyML/tabby/blob/bed723fcedb44a6b867ce22a7b1f03d2f3531c1e/experimental/eval/
-skypilot.yaml) - [LocalGPT](./llm/localgpt) - Add yours here & see more in
-[`llm/`](./llm)! - Framework examples: [PyTorch DDP](https://github.com/
-skypilot-org/skypilot/blob/master/examples/resnet_distributed_torch.yaml),
-[DeepSpeed](./examples/deepspeed-multinode/sky.yaml), [JAX/Flax on TPU](https:/
-/github.com/skypilot-org/skypilot/blob/master/examples/tpu/tpuvm_mnist.yaml),
-[Stable Diffusion](https://github.com/skypilot-org/skypilot/tree/master/
-examples/stable_diffusion), [Detectron2](https://github.com/skypilot-org/
-skypilot/blob/master/examples/detectron2_docker.yaml), [Distributed](https://
-github.com/skypilot-org/skypilot/blob/master/examples/
-resnet_distributed_tf_app.py) [TensorFlow](https://github.com/skypilot-org/
-skypilot/blob/master/examples/resnet_app_storage.yaml), [programmatic grid
-search](https://github.com/skypilot-org/skypilot/blob/master/examples/
+examples: - LLMs on SkyPilot - [Train Your Own Vicuna on Llama-2](./llm/vicuna-
+llama-2/) - [Self-Hosted Llama-2 Chatbot](./llm/llama-2/) - [Vicuna chatbots:
+Training & Serving](./llm/vicuna/) (from official Vicuna team) - [vLLM: Serving
+LLM 24x Faster On the Cloud](./llm/vllm/) (from official vLLM team) - [QLoRA]
+(https://github.com/artidoro/qlora/pull/132) - [LLaMA-LoRA-Tuner](https://
+github.com/zetavg/LLaMA-LoRA-Tuner#run-on-a-cloud-service-via-skypilot) -
+[Tabby: Self-hosted AI coding assistant](https://github.com/TabbyML/tabby/blob/
+bed723fcedb44a6b867ce22a7b1f03d2f3531c1e/experimental/eval/skypilot.yaml) -
+[LocalGPT](./llm/localgpt) - Add yours here & see more in [`llm/`](./llm)! -
+Framework examples: [PyTorch DDP](https://github.com/skypilot-org/skypilot/
+blob/master/examples/resnet_distributed_torch.yaml), [DeepSpeed](./examples/
+deepspeed-multinode/sky.yaml), [JAX/Flax on TPU](https://github.com/skypilot-
+org/skypilot/blob/master/examples/tpu/tpuvm_mnist.yaml), [Stable Diffusion]
+(https://github.com/skypilot-org/skypilot/tree/master/examples/
+stable_diffusion), [Detectron2](https://github.com/skypilot-org/skypilot/blob/
+master/examples/detectron2_docker.yaml), [Distributed](https://github.com/
+skypilot-org/skypilot/blob/master/examples/resnet_distributed_tf_app.py)
+[TensorFlow](https://github.com/skypilot-org/skypilot/blob/master/examples/
+resnet_app_storage.yaml), [programmatic grid search](https://github.com/
+skypilot-org/skypilot/blob/master/examples/
 huggingface_glue_imdb_grid_search_app.py), [Docker](https://github.com/
 skypilot-org/skypilot/blob/master/examples/docker/echo_app.yaml), and [many
 more (`examples/`)](./examples). Follow updates: - [Twitter](https://
 twitter.com/skypilot_org) - [Slack](http://slack.skypilot.co) - [SkyPilot Blog]
 (https://blog.skypilot.co/) ([Introductory blog post](https://blog.skypilot.co/
 introducing-skypilot/)) Read the research: - [SkyPilot paper](https://
 www.usenix.org/system/files/nsdi23-yang-zongheng.pdf) and [talk](https://
```

### Comparing `skypilot-nightly-1.0.0.dev20230802/skypilot_nightly.egg-info/SOURCES.txt` & `skypilot-nightly-1.0.0.dev20230803/skypilot_nightly.egg-info/SOURCES.txt`

 * *Files 13% similar despite different names*

```diff
@@ -22,14 +22,15 @@
 sky/adaptors/__init__.py
 sky/adaptors/aws.py
 sky/adaptors/azure.py
 sky/adaptors/cloudflare.py
 sky/adaptors/docker.py
 sky/adaptors/gcp.py
 sky/adaptors/ibm.py
+sky/adaptors/kubernetes.py
 sky/adaptors/oci.py
 sky/backends/__init__.py
 sky/backends/backend.py
 sky/backends/backend_utils.py
 sky/backends/cloud_vm_ray_backend.py
 sky/backends/docker_utils.py
 sky/backends/local_docker_backend.py
@@ -41,14 +42,15 @@
 sky/benchmark/benchmark_utils.py
 sky/clouds/__init__.py
 sky/clouds/aws.py
 sky/clouds/azure.py
 sky/clouds/cloud.py
 sky/clouds/gcp.py
 sky/clouds/ibm.py
+sky/clouds/kubernetes.py
 sky/clouds/lambda_cloud.py
 sky/clouds/local.py
 sky/clouds/oci.py
 sky/clouds/scp.py
 sky/clouds/service_catalog/__init__.py
 sky/clouds/service_catalog/aws_catalog.py
 sky/clouds/service_catalog/azure_catalog.py
@@ -106,14 +108,18 @@
 sky/skylet/providers/gcp/constants.py
 sky/skylet/providers/gcp/node.py
 sky/skylet/providers/gcp/node_provider.py
 sky/skylet/providers/ibm/__init__.py
 sky/skylet/providers/ibm/node_provider.py
 sky/skylet/providers/ibm/utils.py
 sky/skylet/providers/ibm/vpc_provider.py
+sky/skylet/providers/kubernetes/__init__.py
+sky/skylet/providers/kubernetes/config.py
+sky/skylet/providers/kubernetes/node_provider.py
+sky/skylet/providers/kubernetes/utils.py
 sky/skylet/providers/lambda_cloud/__init__.py
 sky/skylet/providers/lambda_cloud/lambda_utils.py
 sky/skylet/providers/lambda_cloud/node_provider.py
 sky/skylet/providers/oci/__init__.py
 sky/skylet/providers/oci/config.py
 sky/skylet/providers/oci/node_provider.py
 sky/skylet/providers/oci/query_helper.py
@@ -142,14 +148,15 @@
 sky/spot/dashboard/templates/index.html
 sky/templates/aws-ray.yml.j2
 sky/templates/azure-ray.yml.j2
 sky/templates/gcp-ray.yml.j2
 sky/templates/gcp-tpu-create.sh.j2
 sky/templates/gcp-tpu-delete.sh.j2
 sky/templates/ibm-ray.yml.j2
+sky/templates/kubernetes-ray.yml.j2
 sky/templates/lambda-ray.yml.j2
 sky/templates/local-ray.yml.j2
 sky/templates/oci-ray.yml.j2
 sky/templates/scp-ray.yml.j2
 sky/templates/spot-controller.yaml.j2
 sky/usage/__init__.py
 sky/usage/constants.py
@@ -166,14 +173,18 @@
 sky/utils/subprocess_utils.py
 sky/utils/timeline.py
 sky/utils/tpu_utils.py
 sky/utils/ux_utils.py
 sky/utils/validator.py
 sky/utils/cli_utils/__init__.py
 sky/utils/cli_utils/status_utils.py
+sky/utils/kubernetes/__init__.py
+sky/utils/kubernetes/create_cluster.sh
+sky/utils/kubernetes/delete_cluster.sh
+sky/utils/kubernetes/generate_kind_config.py
 skypilot_nightly.egg-info/PKG-INFO
 skypilot_nightly.egg-info/SOURCES.txt
 skypilot_nightly.egg-info/dependency_links.txt
 skypilot_nightly.egg-info/entry_points.txt
 skypilot_nightly.egg-info/requires.txt
 skypilot_nightly.egg-info/top_level.txt
 tests/test_cli.py
```

### Comparing `skypilot-nightly-1.0.0.dev20230802/skypilot_nightly.egg-info/requires.txt` & `skypilot-nightly-1.0.0.dev20230803/skypilot_nightly.egg-info/requires.txt`

 * *Files 7% similar despite different names*

```diff
@@ -55,14 +55,15 @@
 google-cloud-storage
 ibm-cloud-sdk-core
 ibm-vpc
 ibm-platform-services
 ibm-cos-sdk
 docker
 oci
+kubernetes
 
 [aws]
 urllib3<2
 awscli>=1.27.10
 botocore>=1.29.10
 boto3>=1.26.1
 pycryptodome==3.12.0
@@ -89,13 +90,16 @@
 
 [ibm]
 ibm-cloud-sdk-core
 ibm-vpc
 ibm-platform-services
 ibm-cos-sdk
 
+[kubernetes]
+kubernetes
+
 [lambda]
 
 [oci]
 oci
 
 [scp]
```

### Comparing `skypilot-nightly-1.0.0.dev20230802/tests/test_cli.py` & `skypilot-nightly-1.0.0.dev20230803/tests/test_cli.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/tests/test_config.py` & `skypilot-nightly-1.0.0.dev20230803/tests/test_config.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/tests/test_jobs.py` & `skypilot-nightly-1.0.0.dev20230803/tests/test_jobs.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/tests/test_list_accelerators.py` & `skypilot-nightly-1.0.0.dev20230803/tests/test_list_accelerators.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/tests/test_onprem.py` & `skypilot-nightly-1.0.0.dev20230803/tests/test_onprem.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/tests/test_optimizer_dryruns.py` & `skypilot-nightly-1.0.0.dev20230803/tests/test_optimizer_dryruns.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/tests/test_optimizer_random_dag.py` & `skypilot-nightly-1.0.0.dev20230803/tests/test_optimizer_random_dag.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/tests/test_smoke.py` & `skypilot-nightly-1.0.0.dev20230803/tests/test_smoke.py`

 * *Files 1% similar despite different names*

```diff
@@ -1531,7276 +1531,7590 @@
 00005fa0: 2d2d 2d2d 2d2d 2d2d 2054 6573 7420 7374  -------- Test st
 00005fb0: 616c 6520 6a6f 6220 2d2d 2d2d 2d2d 2d2d  ale job --------
 00005fc0: 2d2d 2d2d 0a40 7079 7465 7374 2e6d 6172  ----.@pytest.mar
 00005fd0: 6b2e 6e6f 5f6c 616d 6264 615f 636c 6f75  k.no_lambda_clou
 00005fe0: 6420 2023 204c 616d 6264 6120 436c 6f75  d  # Lambda Clou
 00005ff0: 6420 646f 6573 206e 6f74 2073 7570 706f  d does not suppo
 00006000: 7274 2073 746f 7070 696e 6720 696e 7374  rt stopping inst
-00006010: 616e 6365 730a 6465 6620 7465 7374 5f73  ances.def test_s
-00006020: 7461 6c65 5f6a 6f62 2867 656e 6572 6963  tale_job(generic
-00006030: 5f63 6c6f 7564 3a20 7374 7229 3a0a 2020  _cloud: str):.  
-00006040: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-00006050: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-00006060: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-00006070: 2020 2020 2020 2773 7461 6c65 5f6a 6f62        'stale_job
-00006080: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-00006090: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-000060a0: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
-000060b0: 657d 202d 2d63 6c6f 7564 207b 6765 6e65  e} --cloud {gene
-000060c0: 7269 635f 636c 6f75 647d 2022 6563 686f  ric_cloud} "echo
-000060d0: 2068 6922 272c 0a20 2020 2020 2020 2020   hi"',.         
-000060e0: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
-000060f0: 616d 657d 202d 6420 2265 6368 6f20 7374  ame} -d "echo st
-00006100: 6172 743b 2073 6c65 6570 2031 3030 3030  art; sleep 10000
-00006110: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-00006120: 6627 736b 7920 7374 6f70 207b 6e61 6d65  f'sky stop {name
-00006130: 7d20 2d79 272c 0a20 2020 2020 2020 2020  } -y',.         
-00006140: 2020 2027 736c 6565 7020 3130 3027 2c20     'sleep 100', 
-00006150: 2023 2045 6e73 7572 6520 7468 6973 2069   # Ensure this i
-00006160: 7320 6c61 7267 6520 656e 6f75 6768 2c20  s large enough, 
-00006170: 656c 7365 2047 4350 206c 6561 6b73 2e0a  else GCP leaks..
-00006180: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00006190: 7920 7374 6172 7420 7b6e 616d 657d 202d  y start {name} -
-000061a0: 7927 2c0a 2020 2020 2020 2020 2020 2020  y',.            
-000061b0: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-000061c0: 7d20 3120 2d2d 7374 6174 7573 272c 0a20  } 1 --status',. 
-000061d0: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
-000061e0: 2873 6b79 2071 7565 7565 207b 6e61 6d65  (sky queue {name
-000061f0: 7d29 3b20 6563 686f 2022 2473 223b 2065  }); echo "$s"; e
-00006200: 6368 6f3b 2065 6368 6f3b 2065 6368 6f20  cho; echo; echo 
-00006210: 2224 7322 207c 2067 7265 7020 4641 494c  "$s" | grep FAIL
-00006220: 4544 272c 0a20 2020 2020 2020 205d 2c0a  ED',.        ],.
-00006230: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
-00006240: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
-00006250: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-00006260: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
-00006270: 7974 6573 742e 6d61 726b 2e61 7773 0a64  ytest.mark.aws.d
-00006280: 6566 2074 6573 745f 6177 735f 7374 616c  ef test_aws_stal
-00006290: 655f 6a6f 625f 6d61 6e75 616c 5f72 6573  e_job_manual_res
-000062a0: 7461 7274 2829 3a0a 2020 2020 6e61 6d65  tart():.    name
-000062b0: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
-000062c0: 6e61 6d65 2829 0a20 2020 2072 6567 696f  name().    regio
-000062d0: 6e20 3d20 2775 732d 7765 7374 2d32 270a  n = 'us-west-2'.
-000062e0: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-000062f0: 0a20 2020 2020 2020 2027 6177 735f 7374  .        'aws_st
-00006300: 616c 655f 6a6f 625f 6d61 6e75 616c 5f72  ale_job_manual_r
-00006310: 6573 7461 7274 272c 0a20 2020 2020 2020  estart',.       
-00006320: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-00006330: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
-00006340: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
-00006350: 2061 7773 202d 2d72 6567 696f 6e20 7b72   aws --region {r
-00006360: 6567 696f 6e7d 2022 6563 686f 2068 6922  egion} "echo hi"
-00006370: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00006380: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-00006390: 202d 6420 2265 6368 6f20 7374 6172 743b   -d "echo start;
-000063a0: 2073 6c65 6570 2031 3030 3030 2227 2c0a   sleep 10000"',.
-000063b0: 2020 2020 2020 2020 2020 2020 2320 5374              # St
-000063c0: 6f70 2074 6865 2063 6c75 7374 6572 206d  op the cluster m
-000063d0: 616e 7561 6c6c 792e 0a20 2020 2020 2020  anually..       
-000063e0: 2020 2020 2066 2769 643d 6061 7773 2065       f'id=`aws e
-000063f0: 6332 2064 6573 6372 6962 652d 696e 7374  c2 describe-inst
-00006400: 616e 6365 7320 2d2d 7265 6769 6f6e 207b  ances --region {
-00006410: 7265 6769 6f6e 7d20 2d2d 6669 6c74 6572  region} --filter
-00006420: 7320 270a 2020 2020 2020 2020 2020 2020  s '.            
-00006430: 6627 4e61 6d65 3d74 6167 3a72 6179 2d63  f'Name=tag:ray-c
-00006440: 6c75 7374 6572 2d6e 616d 652c 5661 6c75  luster-name,Valu
-00006450: 6573 3d7b 6e61 6d65 7d20 270a 2020 2020  es={name} '.    
-00006460: 2020 2020 2020 2020 6627 2d2d 7175 6572          f'--quer
-00006470: 7920 5265 7365 7276 6174 696f 6e73 5b5d  y Reservations[]
-00006480: 2e49 6e73 7461 6e63 6573 5b5d 2e49 6e73  .Instances[].Ins
-00006490: 7461 6e63 6549 6420 270a 2020 2020 2020  tanceId '.      
-000064a0: 2020 2020 2020 272d 2d6f 7574 7075 7420        '--output 
-000064b0: 7465 7874 603b 2027 0a20 2020 2020 2020  text`; '.       
-000064c0: 2020 2020 2066 2761 7773 2065 6332 2073       f'aws ec2 s
-000064d0: 746f 702d 696e 7374 616e 6365 7320 2d2d  top-instances --
-000064e0: 7265 6769 6f6e 207b 7265 6769 6f6e 7d20  region {region} 
-000064f0: 270a 2020 2020 2020 2020 2020 2020 272d  '.            '-
-00006500: 2d69 6e73 7461 6e63 652d 6964 7320 2469  -instance-ids $i
-00006510: 6427 2c0a 2020 2020 2020 2020 2020 2020  d',.            
-00006520: 2773 6c65 6570 2034 3027 2c0a 2020 2020  'sleep 40',.    
-00006530: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
-00006540: 756e 6368 202d 6320 7b6e 616d 657d 202d  unch -c {name} -
-00006550: 7920 2265 6368 6f20 6869 2227 2c0a 2020  y "echo hi"',.  
-00006560: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00006570: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
-00006580: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
-00006590: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-000065a0: 7b6e 616d 657d 2033 202d 2d73 7461 7475  {name} 3 --statu
-000065b0: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
-000065c0: 2320 456e 7375 7265 2074 6865 2073 6b79  # Ensure the sky
-000065d0: 6c65 7420 7570 6461 7465 6420 7468 6520  let updated the 
-000065e0: 7374 616c 6520 6a6f 6220 7374 6174 7573  stale job status
-000065f0: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
-00006600: 736c 6565 7020 7b65 7665 6e74 732e 4a6f  sleep {events.Jo
-00006610: 6253 6368 6564 756c 6572 4576 656e 742e  bSchedulerEvent.
-00006620: 4556 454e 545f 494e 5445 5256 414c 5f53  EVENT_INTERVAL_S
-00006630: 4543 4f4e 4453 7d27 2c0a 2020 2020 2020  ECONDS}',.      
-00006640: 2020 2020 2020 6627 733d 2428 736b 7920        f's=$(sky 
-00006650: 7175 6575 6520 7b6e 616d 657d 293b 2065  queue {name}); e
-00006660: 6368 6f20 2224 7322 3b20 6563 686f 3b20  cho "$s"; echo; 
-00006670: 6563 686f 3b20 6563 686f 2022 2473 2220  echo; echo "$s" 
-00006680: 7c20 6772 6570 2046 4149 4c45 4427 2c0a  | grep FAILED',.
-00006690: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-000066a0: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
-000066b0: 207b 6e61 6d65 7d27 2c0a 2020 2020 290a   {name}',.    ).
-000066c0: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-000066d0: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
-000066e0: 2e6d 6172 6b2e 6763 700a 6465 6620 7465  .mark.gcp.def te
-000066f0: 7374 5f67 6370 5f73 7461 6c65 5f6a 6f62  st_gcp_stale_job
-00006700: 5f6d 616e 7561 6c5f 7265 7374 6172 7428  _manual_restart(
-00006710: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
-00006720: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
-00006730: 290a 2020 2020 7a6f 6e65 203d 2027 7573  ).    zone = 'us
-00006740: 2d77 6573 7432 2d61 270a 2020 2020 7175  -west2-a'.    qu
-00006750: 6572 795f 636d 6420 3d20 2866 2767 636c  ery_cmd = (f'gcl
-00006760: 6f75 6420 636f 6d70 7574 6520 696e 7374  oud compute inst
-00006770: 616e 6365 7320 6c69 7374 202d 2d66 696c  ances list --fil
-00006780: 7465 723d 270a 2020 2020 2020 2020 2020  ter='.          
-00006790: 2020 2020 2020 2066 2722 286c 6162 656c         f'"(label
-000067a0: 732e 7261 792d 636c 7573 7465 722d 6e61  s.ray-cluster-na
-000067b0: 6d65 3d7b 6e61 6d65 7d29 2220 270a 2020  me={name})" '.  
-000067c0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-000067d0: 272d 2d7a 6f6e 6573 3d7b 7a6f 6e65 7d20  '--zones={zone} 
-000067e0: 2d2d 666f 726d 6174 3d22 7661 6c75 6528  --format="value(
-000067f0: 6e61 6d65 2922 2729 0a20 2020 2073 746f  name)"').    sto
-00006800: 705f 636d 6420 3d20 2866 2767 636c 6f75  p_cmd = (f'gclou
-00006810: 6420 636f 6d70 7574 6520 696e 7374 616e  d compute instan
-00006820: 6365 7320 7374 6f70 202d 2d7a 6f6e 653d  ces stop --zone=
-00006830: 7b7a 6f6e 657d 270a 2020 2020 2020 2020  {zone}'.        
-00006840: 2020 2020 2020 2020 6627 202d 2d71 7569          f' --qui
-00006850: 6574 2024 287b 7175 6572 795f 636d 647d  et $({query_cmd}
-00006860: 2927 290a 2020 2020 7465 7374 203d 2054  )').    test = T
-00006870: 6573 7428 0a20 2020 2020 2020 2027 6763  est(.        'gc
-00006880: 705f 7374 616c 655f 6a6f 625f 6d61 6e75  p_stale_job_manu
-00006890: 616c 5f72 6573 7461 7274 272c 0a20 2020  al_restart',.   
-000068a0: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-000068b0: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
-000068c0: 2d79 202d 6320 7b6e 616d 657d 202d 2d63  -y -c {name} --c
-000068d0: 6c6f 7564 2067 6370 202d 2d7a 6f6e 6520  loud gcp --zone 
-000068e0: 7b7a 6f6e 657d 2022 6563 686f 2068 6922  {zone} "echo hi"
-000068f0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00006900: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-00006910: 202d 6420 2265 6368 6f20 7374 6172 743b   -d "echo start;
-00006920: 2073 6c65 6570 2031 3030 3030 2227 2c0a   sleep 10000"',.
-00006930: 2020 2020 2020 2020 2020 2020 2320 5374              # St
-00006940: 6f70 2074 6865 2063 6c75 7374 6572 206d  op the cluster m
-00006950: 616e 7561 6c6c 792e 0a20 2020 2020 2020  anually..       
-00006960: 2020 2020 2073 746f 705f 636d 642c 0a20       stop_cmd,. 
-00006970: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-00006980: 7020 3430 272c 0a20 2020 2020 2020 2020  p 40',.         
-00006990: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
-000069a0: 2d63 207b 6e61 6d65 7d20 2d79 2022 6563  -c {name} -y "ec
-000069b0: 686f 2068 6922 272c 0a20 2020 2020 2020  ho hi"',.       
-000069c0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-000069d0: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
-000069e0: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
-000069f0: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-00006a00: 7d20 3320 2d2d 7374 6174 7573 272c 0a20  } 3 --status',. 
-00006a10: 2020 2020 2020 2020 2020 2023 2045 6e73             # Ens
-00006a20: 7572 6520 7468 6520 736b 796c 6574 2075  ure the skylet u
-00006a30: 7064 6174 6564 2074 6865 2073 7461 6c65  pdated the stale
-00006a40: 206a 6f62 2073 7461 7475 732e 0a20 2020   job status..   
-00006a50: 2020 2020 2020 2020 2066 2773 6c65 6570           f'sleep
-00006a60: 207b 6576 656e 7473 2e4a 6f62 5363 6865   {events.JobSche
-00006a70: 6475 6c65 7245 7665 6e74 2e45 5645 4e54  dulerEvent.EVENT
-00006a80: 5f49 4e54 4552 5641 4c5f 5345 434f 4e44  _INTERVAL_SECOND
-00006a90: 537d 272c 0a20 2020 2020 2020 2020 2020  S}',.           
-00006aa0: 2066 2773 3d24 2873 6b79 2071 7565 7565   f's=$(sky queue
-00006ab0: 207b 6e61 6d65 7d29 3b20 6563 686f 2022   {name}); echo "
-00006ac0: 2473 223b 2065 6368 6f3b 2065 6368 6f3b  $s"; echo; echo;
-00006ad0: 2065 6368 6f20 2224 7322 207c 2067 7265   echo "$s" | gre
-00006ae0: 7020 4641 494c 4544 272c 0a20 2020 2020  p FAILED',.     
-00006af0: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
-00006b00: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
-00006b10: 657d 272c 0a20 2020 2029 0a20 2020 2072  e}',.    ).    r
-00006b20: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-00006b30: 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d  )...# ----------
-00006b40: 2043 6865 636b 2053 6b79 2773 2065 6e76   Check Sky's env
-00006b50: 6972 6f6e 6d65 6e74 2076 6172 6961 626c  ironment variabl
-00006b60: 6573 3b20 776f 726b 6469 722e 202d 2d2d  es; workdir. ---
-00006b70: 2d2d 2d2d 2d2d 2d0a 4070 7974 6573 742e  -------.@pytest.
-00006b80: 6d61 726b 2e6e 6f5f 7363 7020 2023 2053  mark.no_scp  # S
-00006b90: 4350 2064 6f65 7320 6e6f 7420 7375 7070  CP does not supp
-00006ba0: 6f72 7420 6e75 6d5f 6e6f 6465 7320 3e20  ort num_nodes > 
-00006bb0: 3120 7965 740a 6465 6620 7465 7374 5f65  1 yet.def test_e
-00006bc0: 6e76 5f63 6865 636b 2867 656e 6572 6963  nv_check(generic
-00006bd0: 5f63 6c6f 7564 3a20 7374 7229 3a0a 2020  _cloud: str):.  
-00006be0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-00006bf0: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-00006c00: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-00006c10: 2020 2020 2020 2765 6e76 5f63 6865 636b        'env_check
-00006c20: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-00006c30: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00006c40: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
-00006c50: 657d 202d 2d63 6c6f 7564 207b 6765 6e65  e} --cloud {gene
-00006c60: 7269 635f 636c 6f75 647d 202d 2d64 6574  ric_cloud} --det
-00006c70: 6163 682d 7365 7475 7020 6578 616d 706c  ach-setup exampl
-00006c80: 6573 2f65 6e76 5f63 6865 636b 2e79 616d  es/env_check.yam
-00006c90: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-00006ca0: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-00006cb0: 7d20 3120 2d2d 7374 6174 7573 272c 2020  } 1 --status',  
-00006cc0: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
-00006cd0: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
-00006ce0: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
-00006cf0: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
-00006d00: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
-00006d10: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-00006d20: 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d  t)...# ---------
-00006d30: 2d20 6669 6c65 5f6d 6f75 6e74 7320 2d2d  - file_mounts --
-00006d40: 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465 7374  --------.@pytest
-00006d50: 2e6d 6172 6b2e 6e6f 5f73 6370 2020 2320  .mark.no_scp  # 
-00006d60: 5343 5020 646f 6573 206e 6f74 2073 7570  SCP does not sup
-00006d70: 706f 7274 206e 756d 5f6e 6f64 6573 203e  port num_nodes >
-00006d80: 2031 2079 6574 2e20 5275 6e20 7465 7374   1 yet. Run test
-00006d90: 5f73 6370 5f66 696c 655f 6d6f 756e 7473  _scp_file_mounts
-00006da0: 2069 6e73 7465 6164 2e0a 6465 6620 7465   instead..def te
-00006db0: 7374 5f66 696c 655f 6d6f 756e 7473 2867  st_file_mounts(g
-00006dc0: 656e 6572 6963 5f63 6c6f 7564 3a20 7374  eneric_cloud: st
-00006dd0: 7229 3a0a 2020 2020 6e61 6d65 203d 205f  r):.    name = _
-00006de0: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-00006df0: 2829 0a20 2020 2074 6573 745f 636f 6d6d  ().    test_comm
-00006e00: 616e 6473 203d 205b 0a20 2020 2020 2020  ands = [.       
-00006e10: 202a 7374 6f72 6167 655f 7365 7475 705f   *storage_setup_
-00006e20: 636f 6d6d 616e 6473 2c0a 2020 2020 2020  commands,.      
-00006e30: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-00006e40: 7920 2d63 207b 6e61 6d65 7d20 2d2d 636c  y -c {name} --cl
-00006e50: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
-00006e60: 7564 7d20 6578 616d 706c 6573 2f75 7369  ud} examples/usi
-00006e70: 6e67 5f66 696c 655f 6d6f 756e 7473 2e79  ng_file_mounts.y
-00006e80: 616d 6c27 2c0a 2020 2020 2020 2020 6627  aml',.        f'
-00006e90: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-00006ea0: 3120 2d2d 7374 6174 7573 272c 2020 2320  1 --status',  # 
-00006eb0: 456e 7375 7265 2074 6865 206a 6f62 2073  Ensure the job s
-00006ec0: 7563 6365 6564 6564 2e0a 2020 2020 5d0a  ucceeded..    ].
-00006ed0: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-00006ee0: 0a20 2020 2020 2020 2027 7573 696e 675f  .        'using_
-00006ef0: 6669 6c65 5f6d 6f75 6e74 7327 2c0a 2020  file_mounts',.  
-00006f00: 2020 2020 2020 7465 7374 5f63 6f6d 6d61        test_comma
-00006f10: 6e64 732c 0a20 2020 2020 2020 2066 2773  nds,.        f's
-00006f20: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
-00006f30: 7d27 2c0a 2020 2020 2020 2020 7469 6d65  }',.        time
-00006f40: 6f75 743d 3230 202a 2036 302c 2020 2320  out=20 * 60,  # 
-00006f50: 3230 206d 696e 730a 2020 2020 290a 2020  20 mins.    ).  
-00006f60: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-00006f70: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
-00006f80: 6172 6b2e 7363 700a 6465 6620 7465 7374  ark.scp.def test
-00006f90: 5f73 6370 5f66 696c 655f 6d6f 756e 7473  _scp_file_mounts
-00006fa0: 2829 3a0a 2020 2020 6e61 6d65 203d 205f  ():.    name = _
-00006fb0: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-00006fc0: 2829 0a20 2020 2074 6573 745f 636f 6d6d  ().    test_comm
-00006fd0: 616e 6473 203d 205b 0a20 2020 2020 2020  ands = [.       
-00006fe0: 202a 7374 6f72 6167 655f 7365 7475 705f   *storage_setup_
-00006ff0: 636f 6d6d 616e 6473 2c0a 2020 2020 2020  commands,.      
-00007000: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-00007010: 7920 2d63 207b 6e61 6d65 7d20 7b53 4350  y -c {name} {SCP
-00007020: 5f54 5950 457d 202d 2d6e 756d 2d6e 6f64  _TYPE} --num-nod
-00007030: 6573 2031 2065 7861 6d70 6c65 732f 7573  es 1 examples/us
-00007040: 696e 675f 6669 6c65 5f6d 6f75 6e74 732e  ing_file_mounts.
-00007050: 7961 6d6c 272c 0a20 2020 2020 2020 2066  yaml',.        f
-00007060: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-00007070: 2031 202d 2d73 7461 7475 7327 2c20 2023   1 --status',  #
-00007080: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
-00007090: 7375 6363 6565 6465 642e 0a20 2020 205d  succeeded..    ]
-000070a0: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
-000070b0: 280a 2020 2020 2020 2020 2753 4350 5f75  (.        'SCP_u
-000070c0: 7369 6e67 5f66 696c 655f 6d6f 756e 7473  sing_file_mounts
-000070d0: 272c 0a20 2020 2020 2020 2074 6573 745f  ',.        test_
-000070e0: 636f 6d6d 616e 6473 2c0a 2020 2020 2020  commands,.      
-000070f0: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
-00007100: 7b6e 616d 657d 272c 0a20 2020 2020 2020  {name}',.       
-00007110: 2074 696d 656f 7574 3d32 3020 2a20 3630   timeout=20 * 60
-00007120: 2c20 2023 2032 3020 6d69 6e73 0a20 2020  ,  # 20 mins.   
-00007130: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
-00007140: 6573 7428 7465 7374 290a 0a0a 6465 6620  est(test)...def 
-00007150: 7465 7374 5f75 7369 6e67 5f66 696c 655f  test_using_file_
-00007160: 6d6f 756e 7473 5f77 6974 685f 656e 765f  mounts_with_env_
-00007170: 7661 7273 2867 656e 6572 6963 5f63 6c6f  vars(generic_clo
-00007180: 7564 3a20 7374 7229 3a0a 2020 2020 6e61  ud: str):.    na
-00007190: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-000071a0: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
-000071b0: 745f 636f 6d6d 616e 6473 203d 205b 0a20  t_commands = [. 
-000071c0: 2020 2020 2020 202a 7374 6f72 6167 655f         *storage_
-000071d0: 7365 7475 705f 636f 6d6d 616e 6473 2c0a  setup_commands,.
-000071e0: 2020 2020 2020 2020 2866 2773 6b79 206c          (f'sky l
-000071f0: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
-00007200: 657d 202d 2d63 7075 7320 322b 202d 2d63  e} --cpus 2+ --c
-00007210: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
-00007220: 6f75 647d 2027 0a20 2020 2020 2020 2020  oud} '.         
-00007230: 2765 7861 6d70 6c65 732f 7573 696e 675f  'examples/using_
-00007240: 6669 6c65 5f6d 6f75 6e74 735f 7769 7468  file_mounts_with
-00007250: 5f65 6e76 5f76 6172 732e 7961 6d6c 2729  _env_vars.yaml')
-00007260: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
-00007270: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
-00007280: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
-00007290: 7265 2074 6865 206a 6f62 2073 7563 6365  re the job succe
-000072a0: 6564 6564 2e0a 2020 2020 2020 2020 2320  eded..        # 
-000072b0: 4f76 6572 7269 6465 2077 6974 6820 2d2d  Override with --
-000072c0: 656e 763a 0a20 2020 2020 2020 2028 6627  env:.        (f'
-000072d0: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
-000072e0: 207b 6e61 6d65 7d2d 3220 2d2d 6370 7573   {name}-2 --cpus
-000072f0: 2032 2b20 2d2d 636c 6f75 6420 7b67 656e   2+ --cloud {gen
-00007300: 6572 6963 5f63 6c6f 7564 7d20 270a 2020  eric_cloud} '.  
-00007310: 2020 2020 2020 2027 6578 616d 706c 6573         'examples
-00007320: 2f75 7369 6e67 5f66 696c 655f 6d6f 756e  /using_file_moun
-00007330: 7473 5f77 6974 685f 656e 765f 7661 7273  ts_with_env_vars
-00007340: 2e79 616d 6c20 270a 2020 2020 2020 2020  .yaml '.        
-00007350: 2027 2d2d 656e 7620 4d59 5f4c 4f43 414c   '--env MY_LOCAL
-00007360: 5f50 4154 483d 746d 7066 696c 6527 292c  _PATH=tmpfile'),
-00007370: 0a20 2020 2020 2020 2066 2773 6b79 206c  .        f'sky l
-00007380: 6f67 7320 7b6e 616d 657d 2d32 2031 202d  ogs {name}-2 1 -
-00007390: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
-000073a0: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
-000073b0: 6565 6465 642e 0a20 2020 205d 0a20 2020  eeded..    ].   
-000073c0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-000073d0: 2020 2020 2020 2775 7369 6e67 5f66 696c        'using_fil
-000073e0: 655f 6d6f 756e 7473 5f77 6974 685f 656e  e_mounts_with_en
-000073f0: 765f 7661 7273 272c 0a20 2020 2020 2020  v_vars',.       
-00007400: 2074 6573 745f 636f 6d6d 616e 6473 2c0a   test_commands,.
-00007410: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
-00007420: 776e 202d 7920 7b6e 616d 657d 207b 6e61  wn -y {name} {na
-00007430: 6d65 7d2d 3227 2c0a 2020 2020 2020 2020  me}-2',.        
-00007440: 7469 6d65 6f75 743d 3230 202a 2036 302c  timeout=20 * 60,
-00007450: 2020 2320 3230 206d 696e 730a 2020 2020    # 20 mins.    
-00007460: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-00007470: 7374 2874 6573 7429 0a0a 0a23 202d 2d2d  st(test)...# ---
-00007480: 2d2d 2d2d 2d2d 2d20 7374 6f72 6167 6520  ------- storage 
-00007490: 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465  ----------.@pyte
-000074a0: 7374 2e6d 6172 6b2e 6177 730a 6465 6620  st.mark.aws.def 
-000074b0: 7465 7374 5f61 7773 5f73 746f 7261 6765  test_aws_storage
-000074c0: 5f6d 6f75 6e74 7328 293a 0a20 2020 206e  _mounts():.    n
-000074d0: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-000074e0: 6572 5f6e 616d 6528 290a 2020 2020 7374  er_name().    st
-000074f0: 6f72 6167 655f 6e61 6d65 203d 2066 2773  orage_name = f's
-00007500: 6b79 2d74 6573 742d 7b69 6e74 2874 696d  ky-test-{int(tim
-00007510: 652e 7469 6d65 2829 297d 270a 2020 2020  e.time())}'.    
-00007520: 7465 6d70 6c61 7465 5f73 7472 203d 2070  template_str = p
-00007530: 6174 686c 6962 2e50 6174 6828 0a20 2020  athlib.Path(.   
-00007540: 2020 2020 2027 7465 7374 732f 7465 7374       'tests/test
-00007550: 5f79 616d 6c73 2f74 6573 745f 7374 6f72  _yamls/test_stor
-00007560: 6167 655f 6d6f 756e 7469 6e67 2e79 616d  age_mounting.yam
-00007570: 6c27 292e 7265 6164 5f74 6578 7428 290a  l').read_text().
-00007580: 2020 2020 7465 6d70 6c61 7465 203d 206a      template = j
-00007590: 696e 6a61 322e 5465 6d70 6c61 7465 2874  inja2.Template(t
-000075a0: 656d 706c 6174 655f 7374 7229 0a20 2020  emplate_str).   
-000075b0: 2063 6f6e 7465 6e74 203d 2074 656d 706c   content = templ
-000075c0: 6174 652e 7265 6e64 6572 2873 746f 7261  ate.render(stora
-000075d0: 6765 5f6e 616d 653d 7374 6f72 6167 655f  ge_name=storage_
-000075e0: 6e61 6d65 290a 2020 2020 7769 7468 2074  name).    with t
-000075f0: 656d 7066 696c 652e 4e61 6d65 6454 656d  empfile.NamedTem
-00007600: 706f 7261 7279 4669 6c65 2873 7566 6669  poraryFile(suffi
-00007610: 783d 272e 7961 6d6c 272c 206d 6f64 653d  x='.yaml', mode=
-00007620: 2777 2729 2061 7320 663a 0a20 2020 2020  'w') as f:.     
-00007630: 2020 2066 2e77 7269 7465 2863 6f6e 7465     f.write(conte
-00007640: 6e74 290a 2020 2020 2020 2020 662e 666c  nt).        f.fl
-00007650: 7573 6828 290a 2020 2020 2020 2020 6669  ush().        fi
-00007660: 6c65 5f70 6174 6820 3d20 662e 6e61 6d65  le_path = f.name
-00007670: 0a20 2020 2020 2020 2074 6573 745f 636f  .        test_co
-00007680: 6d6d 616e 6473 203d 205b 0a20 2020 2020  mmands = [.     
-00007690: 2020 2020 2020 202a 7374 6f72 6167 655f         *storage_
-000076a0: 7365 7475 705f 636f 6d6d 616e 6473 2c0a  setup_commands,.
-000076b0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-000076c0: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
-000076d0: 6e61 6d65 7d20 2d2d 636c 6f75 6420 6177  name} --cloud aw
-000076e0: 7320 7b66 696c 655f 7061 7468 7d27 2c0a  s {file_path}',.
-000076f0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00007700: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
-00007710: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
-00007720: 7375 7265 206a 6f62 2073 7563 6365 6564  sure job succeed
-00007730: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
-00007740: 6627 6177 7320 7333 206c 7320 7b73 746f  f'aws s3 ls {sto
-00007750: 7261 6765 5f6e 616d 657d 2f68 656c 6c6f  rage_name}/hello
-00007760: 2e74 7874 272c 0a20 2020 2020 2020 205d  .txt',.        ]
-00007770: 0a20 2020 2020 2020 2074 6573 7420 3d20  .        test = 
-00007780: 5465 7374 280a 2020 2020 2020 2020 2020  Test(.          
-00007790: 2020 2761 7773 5f73 746f 7261 6765 5f6d    'aws_storage_m
-000077a0: 6f75 6e74 7327 2c0a 2020 2020 2020 2020  ounts',.        
-000077b0: 2020 2020 7465 7374 5f63 6f6d 6d61 6e64      test_command
-000077c0: 732c 0a20 2020 2020 2020 2020 2020 2066  s,.            f
-000077d0: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
-000077e0: 6d65 7d3b 2073 6b79 2073 746f 7261 6765  me}; sky storage
-000077f0: 2064 656c 6574 6520 7b73 746f 7261 6765   delete {storage
-00007800: 5f6e 616d 657d 272c 0a20 2020 2020 2020  _name}',.       
-00007810: 2020 2020 2074 696d 656f 7574 3d32 3020       timeout=20 
-00007820: 2a20 3630 2c20 2023 2032 3020 6d69 6e73  * 60,  # 20 mins
-00007830: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-00007840: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-00007850: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
-00007860: 6d61 726b 2e67 6370 0a64 6566 2074 6573  mark.gcp.def tes
-00007870: 745f 6763 705f 7374 6f72 6167 655f 6d6f  t_gcp_storage_mo
-00007880: 756e 7473 2829 3a0a 2020 2020 6e61 6d65  unts():.    name
-00007890: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
-000078a0: 6e61 6d65 2829 0a20 2020 2073 746f 7261  name().    stora
-000078b0: 6765 5f6e 616d 6520 3d20 6627 736b 792d  ge_name = f'sky-
-000078c0: 7465 7374 2d7b 696e 7428 7469 6d65 2e74  test-{int(time.t
-000078d0: 696d 6528 2929 7d27 0a20 2020 2074 656d  ime())}'.    tem
-000078e0: 706c 6174 655f 7374 7220 3d20 7061 7468  plate_str = path
-000078f0: 6c69 622e 5061 7468 280a 2020 2020 2020  lib.Path(.      
-00007900: 2020 2774 6573 7473 2f74 6573 745f 7961    'tests/test_ya
-00007910: 6d6c 732f 7465 7374 5f73 746f 7261 6765  mls/test_storage
-00007920: 5f6d 6f75 6e74 696e 672e 7961 6d6c 2729  _mounting.yaml')
-00007930: 2e72 6561 645f 7465 7874 2829 0a20 2020  .read_text().   
-00007940: 2074 656d 706c 6174 6520 3d20 6a69 6e6a   template = jinj
-00007950: 6132 2e54 656d 706c 6174 6528 7465 6d70  a2.Template(temp
-00007960: 6c61 7465 5f73 7472 290a 2020 2020 636f  late_str).    co
-00007970: 6e74 656e 7420 3d20 7465 6d70 6c61 7465  ntent = template
-00007980: 2e72 656e 6465 7228 7374 6f72 6167 655f  .render(storage_
-00007990: 6e61 6d65 3d73 746f 7261 6765 5f6e 616d  name=storage_nam
-000079a0: 6529 0a20 2020 2077 6974 6820 7465 6d70  e).    with temp
-000079b0: 6669 6c65 2e4e 616d 6564 5465 6d70 6f72  file.NamedTempor
-000079c0: 6172 7946 696c 6528 7375 6666 6978 3d27  aryFile(suffix='
-000079d0: 2e79 616d 6c27 2c20 6d6f 6465 3d27 7727  .yaml', mode='w'
-000079e0: 2920 6173 2066 3a0a 2020 2020 2020 2020  ) as f:.        
-000079f0: 662e 7772 6974 6528 636f 6e74 656e 7429  f.write(content)
-00007a00: 0a20 2020 2020 2020 2066 2e66 6c75 7368  .        f.flush
-00007a10: 2829 0a20 2020 2020 2020 2066 696c 655f  ().        file_
-00007a20: 7061 7468 203d 2066 2e6e 616d 650a 2020  path = f.name.  
-00007a30: 2020 2020 2020 7465 7374 5f63 6f6d 6d61        test_comma
-00007a40: 6e64 7320 3d20 5b0a 2020 2020 2020 2020  nds = [.        
-00007a50: 2020 2020 2a73 746f 7261 6765 5f73 6574      *storage_set
-00007a60: 7570 5f63 6f6d 6d61 6e64 732c 0a20 2020  up_commands,.   
-00007a70: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00007a80: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
-00007a90: 657d 202d 2d63 6c6f 7564 2067 6370 207b  e} --cloud gcp {
-00007aa0: 6669 6c65 5f70 6174 687d 272c 0a20 2020  file_path}',.   
-00007ab0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00007ac0: 6f67 7320 7b6e 616d 657d 2031 202d 2d73  ogs {name} 1 --s
-00007ad0: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
-00007ae0: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
-00007af0: 0a20 2020 2020 2020 2020 2020 2066 2767  .            f'g
-00007b00: 7375 7469 6c20 6c73 2067 733a 2f2f 7b73  sutil ls gs://{s
-00007b10: 746f 7261 6765 5f6e 616d 657d 2f68 656c  torage_name}/hel
-00007b20: 6c6f 2e74 7874 272c 0a20 2020 2020 2020  lo.txt',.       
-00007b30: 205d 0a20 2020 2020 2020 2074 6573 7420   ].        test 
-00007b40: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-00007b50: 2020 2020 2767 6370 5f73 746f 7261 6765      'gcp_storage
-00007b60: 5f6d 6f75 6e74 7327 2c0a 2020 2020 2020  _mounts',.      
-00007b70: 2020 2020 2020 7465 7374 5f63 6f6d 6d61        test_comma
-00007b80: 6e64 732c 0a20 2020 2020 2020 2020 2020  nds,.           
-00007b90: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
-00007ba0: 6e61 6d65 7d3b 2073 6b79 2073 746f 7261  name}; sky stora
-00007bb0: 6765 2064 656c 6574 6520 7b73 746f 7261  ge delete {stora
-00007bc0: 6765 5f6e 616d 657d 272c 0a20 2020 2020  ge_name}',.     
-00007bd0: 2020 2020 2020 2074 696d 656f 7574 3d32         timeout=2
-00007be0: 3020 2a20 3630 2c20 2023 2032 3020 6d69  0 * 60,  # 20 mi
-00007bf0: 6e73 0a20 2020 2020 2020 2029 0a20 2020  ns.        ).   
-00007c00: 2020 2020 2072 756e 5f6f 6e65 5f74 6573       run_one_tes
-00007c10: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
-00007c20: 742e 6d61 726b 2e63 6c6f 7564 666c 6172  t.mark.cloudflar
-00007c30: 650a 6465 6620 7465 7374 5f63 6c6f 7564  e.def test_cloud
-00007c40: 666c 6172 655f 7374 6f72 6167 655f 6d6f  flare_storage_mo
-00007c50: 756e 7473 2867 656e 6572 6963 5f63 6c6f  unts(generic_clo
-00007c60: 7564 3a20 7374 7229 3a0a 2020 2020 6e61  ud: str):.    na
-00007c70: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-00007c80: 725f 6e61 6d65 2829 0a20 2020 2073 746f  r_name().    sto
-00007c90: 7261 6765 5f6e 616d 6520 3d20 6627 736b  rage_name = f'sk
-00007ca0: 792d 7465 7374 2d7b 696e 7428 7469 6d65  y-test-{int(time
-00007cb0: 2e74 696d 6528 2929 7d27 0a20 2020 2074  .time())}'.    t
-00007cc0: 656d 706c 6174 655f 7374 7220 3d20 7061  emplate_str = pa
-00007cd0: 7468 6c69 622e 5061 7468 280a 2020 2020  thlib.Path(.    
-00007ce0: 2020 2020 2774 6573 7473 2f74 6573 745f      'tests/test_
-00007cf0: 7961 6d6c 732f 7465 7374 5f72 325f 7374  yamls/test_r2_st
-00007d00: 6f72 6167 655f 6d6f 756e 7469 6e67 2e79  orage_mounting.y
-00007d10: 616d 6c27 292e 7265 6164 5f74 6578 7428  aml').read_text(
-00007d20: 290a 2020 2020 7465 6d70 6c61 7465 203d  ).    template =
-00007d30: 206a 696e 6a61 322e 5465 6d70 6c61 7465   jinja2.Template
-00007d40: 2874 656d 706c 6174 655f 7374 7229 0a20  (template_str). 
-00007d50: 2020 2063 6f6e 7465 6e74 203d 2074 656d     content = tem
-00007d60: 706c 6174 652e 7265 6e64 6572 2873 746f  plate.render(sto
-00007d70: 7261 6765 5f6e 616d 653d 7374 6f72 6167  rage_name=storag
-00007d80: 655f 6e61 6d65 290a 2020 2020 656e 6470  e_name).    endp
-00007d90: 6f69 6e74 5f75 726c 203d 2063 6c6f 7564  oint_url = cloud
-00007da0: 666c 6172 652e 6372 6561 7465 5f65 6e64  flare.create_end
-00007db0: 706f 696e 7428 290a 2020 2020 7769 7468  point().    with
-00007dc0: 2074 656d 7066 696c 652e 4e61 6d65 6454   tempfile.NamedT
-00007dd0: 656d 706f 7261 7279 4669 6c65 2873 7566  emporaryFile(suf
-00007de0: 6669 783d 272e 7961 6d6c 272c 206d 6f64  fix='.yaml', mod
-00007df0: 653d 2777 2729 2061 7320 663a 0a20 2020  e='w') as f:.   
-00007e00: 2020 2020 2066 2e77 7269 7465 2863 6f6e       f.write(con
-00007e10: 7465 6e74 290a 2020 2020 2020 2020 662e  tent).        f.
-00007e20: 666c 7573 6828 290a 2020 2020 2020 2020  flush().        
-00007e30: 6669 6c65 5f70 6174 6820 3d20 662e 6e61  file_path = f.na
-00007e40: 6d65 0a20 2020 2020 2020 2074 6573 745f  me.        test_
-00007e50: 636f 6d6d 616e 6473 203d 205b 0a20 2020  commands = [.   
-00007e60: 2020 2020 2020 2020 202a 7374 6f72 6167           *storag
-00007e70: 655f 7365 7475 705f 636f 6d6d 616e 6473  e_setup_commands
-00007e80: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00007e90: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
-00007ea0: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
-00007eb0: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
-00007ec0: 7b66 696c 655f 7061 7468 7d27 2c0a 2020  {file_path}',.  
-00007ed0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00007ee0: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
-00007ef0: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
-00007f00: 7265 206a 6f62 2073 7563 6365 6564 6564  re job succeeded
-00007f10: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
-00007f20: 4157 535f 5348 4152 4544 5f43 5245 4445  AWS_SHARED_CREDE
-00007f30: 4e54 4941 4c53 5f46 494c 453d 7b63 6c6f  NTIALS_FILE={clo
-00007f40: 7564 666c 6172 652e 5232 5f43 5245 4445  udflare.R2_CREDE
-00007f50: 4e54 4941 4c53 5f50 4154 487d 2061 7773  NTIALS_PATH} aws
-00007f60: 2073 3320 6c73 2073 333a 2f2f 7b73 746f   s3 ls s3://{sto
-00007f70: 7261 6765 5f6e 616d 657d 2f68 656c 6c6f  rage_name}/hello
-00007f80: 2e74 7874 202d 2d65 6e64 706f 696e 7420  .txt --endpoint 
-00007f90: 7b65 6e64 706f 696e 745f 7572 6c7d 202d  {endpoint_url} -
-00007fa0: 2d70 726f 6669 6c65 3d72 3227 0a20 2020  -profile=r2'.   
-00007fb0: 2020 2020 205d 0a0a 2020 2020 2020 2020       ]..        
-00007fc0: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-00007fd0: 2020 2020 2020 2020 2027 636c 6f75 6466           'cloudf
-00007fe0: 6c61 7265 5f73 746f 7261 6765 5f6d 6f75  lare_storage_mou
-00007ff0: 6e74 7327 2c0a 2020 2020 2020 2020 2020  nts',.          
-00008000: 2020 7465 7374 5f63 6f6d 6d61 6e64 732c    test_commands,
-00008010: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00008020: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
-00008030: 7d3b 2073 6b79 2073 746f 7261 6765 2064  }; sky storage d
-00008040: 656c 6574 6520 7b73 746f 7261 6765 5f6e  elete {storage_n
-00008050: 616d 657d 272c 0a20 2020 2020 2020 2020  ame}',.         
-00008060: 2020 2074 696d 656f 7574 3d32 3020 2a20     timeout=20 * 
-00008070: 3630 2c20 2023 2032 3020 6d69 6e73 0a20  60,  # 20 mins. 
-00008080: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00008090: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-000080a0: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
-000080b0: 726b 2e69 626d 0a64 6566 2074 6573 745f  rk.ibm.def test_
-000080c0: 6962 6d5f 7374 6f72 6167 655f 6d6f 756e  ibm_storage_moun
-000080d0: 7473 2829 3a0a 2020 2020 6e61 6d65 203d  ts():.    name =
-000080e0: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-000080f0: 6d65 2829 0a20 2020 2073 746f 7261 6765  me().    storage
-00008100: 5f6e 616d 6520 3d20 6627 736b 792d 7465  _name = f'sky-te
-00008110: 7374 2d7b 696e 7428 7469 6d65 2e74 696d  st-{int(time.tim
-00008120: 6528 2929 7d27 0a20 2020 2062 7563 6b65  e())}'.    bucke
-00008130: 745f 7263 6c6f 6e65 5f70 726f 6669 6c65  t_rclone_profile
-00008140: 203d 2052 636c 6f6e 652e 6765 6e65 7261   = Rclone.genera
-00008150: 7465 5f72 636c 6f6e 655f 6275 636b 6574  te_rclone_bucket
-00008160: 5f70 726f 6669 6c65 5f6e 616d 6528 0a20  _profile_name(. 
-00008170: 2020 2020 2020 2073 746f 7261 6765 5f6e         storage_n
-00008180: 616d 652c 2052 636c 6f6e 652e 5263 6c6f  ame, Rclone.Rclo
-00008190: 6e65 436c 6f75 6473 2e49 424d 290a 2020  neClouds.IBM).  
-000081a0: 2020 7465 6d70 6c61 7465 5f73 7472 203d    template_str =
-000081b0: 2070 6174 686c 6962 2e50 6174 6828 0a20   pathlib.Path(. 
-000081c0: 2020 2020 2020 2027 7465 7374 732f 7465         'tests/te
-000081d0: 7374 5f79 616d 6c73 2f74 6573 745f 6962  st_yamls/test_ib
-000081e0: 6d5f 636f 735f 7374 6f72 6167 655f 6d6f  m_cos_storage_mo
-000081f0: 756e 7469 6e67 2e79 616d 6c27 292e 7265  unting.yaml').re
-00008200: 6164 5f74 6578 7428 290a 2020 2020 7465  ad_text().    te
-00008210: 6d70 6c61 7465 203d 206a 696e 6a61 322e  mplate = jinja2.
-00008220: 5465 6d70 6c61 7465 2874 656d 706c 6174  Template(templat
-00008230: 655f 7374 7229 0a20 2020 2063 6f6e 7465  e_str).    conte
-00008240: 6e74 203d 2074 656d 706c 6174 652e 7265  nt = template.re
-00008250: 6e64 6572 2873 746f 7261 6765 5f6e 616d  nder(storage_nam
-00008260: 653d 7374 6f72 6167 655f 6e61 6d65 290a  e=storage_name).
-00008270: 2020 2020 7769 7468 2074 656d 7066 696c      with tempfil
-00008280: 652e 4e61 6d65 6454 656d 706f 7261 7279  e.NamedTemporary
-00008290: 4669 6c65 2873 7566 6669 783d 272e 7961  File(suffix='.ya
-000082a0: 6d6c 272c 206d 6f64 653d 2777 2729 2061  ml', mode='w') a
-000082b0: 7320 663a 0a20 2020 2020 2020 2066 2e77  s f:.        f.w
-000082c0: 7269 7465 2863 6f6e 7465 6e74 290a 2020  rite(content).  
-000082d0: 2020 2020 2020 662e 666c 7573 6828 290a        f.flush().
-000082e0: 2020 2020 2020 2020 6669 6c65 5f70 6174          file_pat
-000082f0: 6820 3d20 662e 6e61 6d65 0a20 2020 2020  h = f.name.     
-00008300: 2020 2074 6573 745f 636f 6d6d 616e 6473     test_commands
-00008310: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
-00008320: 202a 7374 6f72 6167 655f 7365 7475 705f   *storage_setup_
-00008330: 636f 6d6d 616e 6473 2c0a 2020 2020 2020  commands,.      
-00008340: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-00008350: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
-00008360: 2d2d 636c 6f75 6420 6962 6d20 7b66 696c  --cloud ibm {fil
-00008370: 655f 7061 7468 7d27 2c0a 2020 2020 2020  e_path}',.      
-00008380: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-00008390: 207b 6e61 6d65 7d20 3120 2d2d 7374 6174   {name} 1 --stat
-000083a0: 7573 272c 2020 2320 456e 7375 7265 206a  us',  # Ensure j
-000083b0: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
-000083c0: 2020 2020 2020 2020 2020 6627 7263 6c6f            f'rclo
-000083d0: 6e65 206c 7320 7b62 7563 6b65 745f 7263  ne ls {bucket_rc
-000083e0: 6c6f 6e65 5f70 726f 6669 6c65 7d3a 7b73  lone_profile}:{s
-000083f0: 746f 7261 6765 5f6e 616d 657d 2f68 656c  torage_name}/hel
-00008400: 6c6f 2e74 7874 272c 0a20 2020 2020 2020  lo.txt',.       
-00008410: 205d 0a20 2020 2020 2020 2074 6573 7420   ].        test 
-00008420: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-00008430: 2020 2020 2769 626d 5f73 746f 7261 6765      'ibm_storage
-00008440: 5f6d 6f75 6e74 7327 2c0a 2020 2020 2020  _mounts',.      
-00008450: 2020 2020 2020 7465 7374 5f63 6f6d 6d61        test_comma
-00008460: 6e64 732c 0a20 2020 2020 2020 2020 2020  nds,.           
-00008470: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
-00008480: 6e61 6d65 7d3b 2073 6b79 2073 746f 7261  name}; sky stora
-00008490: 6765 2064 656c 6574 6520 7b73 746f 7261  ge delete {stora
-000084a0: 6765 5f6e 616d 657d 272c 0a20 2020 2020  ge_name}',.     
-000084b0: 2020 2020 2020 2074 696d 656f 7574 3d32         timeout=2
-000084c0: 3020 2a20 3630 2c20 2023 2032 3020 6d69  0 * 60,  # 20 mi
-000084d0: 6e73 0a20 2020 2020 2020 2029 0a20 2020  ns.        ).   
-000084e0: 2020 2020 2072 756e 5f6f 6e65 5f74 6573       run_one_tes
-000084f0: 7428 7465 7374 290a 0a0a 2320 2d2d 2d2d  t(test)...# ----
-00008500: 2d2d 2d2d 2d2d 2043 4c49 206c 6f67 7320  ------ CLI logs 
-00008510: 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465  ----------.@pyte
-00008520: 7374 2e6d 6172 6b2e 6e6f 5f73 6370 2020  st.mark.no_scp  
-00008530: 2320 5343 5020 646f 6573 206e 6f74 2073  # SCP does not s
-00008540: 7570 706f 7274 206e 756d 5f6e 6f64 6573  upport num_nodes
-00008550: 203e 2031 2079 6574 2e20 5275 6e20 7465   > 1 yet. Run te
-00008560: 7374 5f73 6370 5f6c 6f67 7320 696e 7374  st_scp_logs inst
-00008570: 6561 642e 0a64 6566 2074 6573 745f 636c  ead..def test_cl
-00008580: 695f 6c6f 6773 2867 656e 6572 6963 5f63  i_logs(generic_c
-00008590: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
-000085a0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
-000085b0: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
-000085c0: 696d 6573 7461 6d70 203d 2074 696d 652e  imestamp = time.
-000085d0: 7469 6d65 2829 0a20 2020 2074 6573 7420  time().    test 
-000085e0: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-000085f0: 2763 6c69 5f6c 6f67 7327 2c0a 2020 2020  'cli_logs',.    
-00008600: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-00008610: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-00008620: 7920 2d63 207b 6e61 6d65 7d20 2d2d 636c  y -c {name} --cl
-00008630: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
-00008640: 7564 7d20 2d2d 6e75 6d2d 6e6f 6465 7320  ud} --num-nodes 
-00008650: 3220 2265 6368 6f20 7b74 696d 6573 7461  2 "echo {timesta
-00008660: 6d70 7d20 3122 272c 0a20 2020 2020 2020  mp} 1"',.       
-00008670: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
-00008680: 7b6e 616d 657d 2022 6563 686f 207b 7469  {name} "echo {ti
-00008690: 6d65 7374 616d 707d 2032 2227 2c0a 2020  mestamp} 2"',.  
-000086a0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-000086b0: 6578 6563 207b 6e61 6d65 7d20 2265 6368  exec {name} "ech
-000086c0: 6f20 7b74 696d 6573 7461 6d70 7d20 3322  o {timestamp} 3"
-000086d0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-000086e0: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-000086f0: 2022 6563 686f 207b 7469 6d65 7374 616d   "echo {timestam
-00008700: 707d 2034 2227 2c0a 2020 2020 2020 2020  p} 4"',.        
-00008710: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-00008720: 6e61 6d65 7d20 3220 2d2d 7374 6174 7573  name} 2 --status
-00008730: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00008740: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-00008750: 2033 2034 202d 2d73 796e 632d 646f 776e   3 4 --sync-down
-00008760: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00008770: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-00008780: 202a 202d 2d73 796e 632d 646f 776e 272c   * --sync-down',
-00008790: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-000087a0: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
-000087b0: 207c 2067 7265 7020 227b 7469 6d65 7374   | grep "{timest
-000087c0: 616d 707d 2031 2227 2c0a 2020 2020 2020  amp} 1"',.      
-000087d0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-000087e0: 207b 6e61 6d65 7d20 7c20 6772 6570 2022   {name} | grep "
-000087f0: 7b74 696d 6573 7461 6d70 7d20 3422 272c  {timestamp} 4"',
-00008800: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-00008810: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
-00008820: 7920 7b6e 616d 657d 272c 0a20 2020 2029  y {name}',.    )
-00008830: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-00008840: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
-00008850: 742e 6d61 726b 2e73 6370 0a64 6566 2074  t.mark.scp.def t
-00008860: 6573 745f 7363 705f 6c6f 6773 2829 3a0a  est_scp_logs():.
-00008870: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-00008880: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-00008890: 2020 2074 696d 6573 7461 6d70 203d 2074     timestamp = t
-000088a0: 696d 652e 7469 6d65 2829 0a20 2020 2074  ime.time().    t
-000088b0: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-000088c0: 2020 2020 2753 4350 5f63 6c69 5f6c 6f67      'SCP_cli_log
-000088d0: 7327 2c0a 2020 2020 2020 2020 5b0a 2020  s',.        [.  
-000088e0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-000088f0: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
-00008900: 6d65 7d20 7b53 4350 5f54 5950 457d 2022  me} {SCP_TYPE} "
-00008910: 6563 686f 207b 7469 6d65 7374 616d 707d  echo {timestamp}
-00008920: 2031 2227 2c0a 2020 2020 2020 2020 2020   1"',.          
-00008930: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-00008940: 6d65 7d20 2265 6368 6f20 7b74 696d 6573  me} "echo {times
-00008950: 7461 6d70 7d20 3222 272c 0a20 2020 2020  tamp} 2"',.     
-00008960: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-00008970: 6320 7b6e 616d 657d 2022 6563 686f 207b  c {name} "echo {
-00008980: 7469 6d65 7374 616d 707d 2033 2227 2c0a  timestamp} 3"',.
-00008990: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-000089a0: 7920 6578 6563 207b 6e61 6d65 7d20 2265  y exec {name} "e
-000089b0: 6368 6f20 7b74 696d 6573 7461 6d70 7d20  cho {timestamp} 
-000089c0: 3422 272c 0a20 2020 2020 2020 2020 2020  4"',.           
-000089d0: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-000089e0: 657d 2032 202d 2d73 7461 7475 7327 2c0a  e} 2 --status',.
-000089f0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00008a00: 7920 6c6f 6773 207b 6e61 6d65 7d20 3320  y logs {name} 3 
-00008a10: 3420 2d2d 7379 6e63 2d64 6f77 6e27 2c0a  4 --sync-down',.
-00008a20: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00008a30: 7920 6c6f 6773 207b 6e61 6d65 7d20 2a20  y logs {name} * 
-00008a40: 2d2d 7379 6e63 2d64 6f77 6e27 2c0a 2020  --sync-down',.  
-00008a50: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00008a60: 6c6f 6773 207b 6e61 6d65 7d20 3120 7c20  logs {name} 1 | 
-00008a70: 6772 6570 2022 7b74 696d 6573 7461 6d70  grep "{timestamp
-00008a80: 7d20 3122 272c 0a20 2020 2020 2020 2020  } 1"',.         
-00008a90: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-00008aa0: 616d 657d 207c 2067 7265 7020 227b 7469  ame} | grep "{ti
-00008ab0: 6d65 7374 616d 707d 2034 2227 2c0a 2020  mestamp} 4"',.  
-00008ac0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-00008ad0: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
-00008ae0: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
-00008af0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-00008b00: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
-00008b10: 2d2d 2d20 4a6f 6220 5175 6575 652e 202d  --- Job Queue. -
-00008b20: 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974 6573  ---------.@pytes
-00008b30: 742e 6d61 726b 2e6e 6f5f 6c61 6d62 6461  t.mark.no_lambda
-00008b40: 5f63 6c6f 7564 2020 2320 4c61 6d62 6461  _cloud  # Lambda
-00008b50: 2043 6c6f 7564 2064 6f65 7320 6e6f 7420   Cloud does not 
-00008b60: 6861 7665 204b 3830 2067 7075 730a 4070  have K80 gpus.@p
-00008b70: 7974 6573 742e 6d61 726b 2e6e 6f5f 6962  ytest.mark.no_ib
-00008b80: 6d20 2023 2049 424d 2043 6c6f 7564 2064  m  # IBM Cloud d
-00008b90: 6f65 7320 6e6f 7420 6861 7665 204b 3830  oes not have K80
-00008ba0: 2067 7075 732e 2072 756e 2074 6573 745f   gpus. run test_
-00008bb0: 6962 6d5f 6a6f 625f 7175 6575 6520 696e  ibm_job_queue in
-00008bc0: 7374 6561 640a 4070 7974 6573 742e 6d61  stead.@pytest.ma
-00008bd0: 726b 2e6e 6f5f 7363 7020 2023 2053 4350  rk.no_scp  # SCP
-00008be0: 2064 6f65 7320 6e6f 7420 6861 7665 204b   does not have K
-00008bf0: 3830 2067 7075 732e 2052 756e 2074 6573  80 gpus. Run tes
-00008c00: 745f 7363 705f 6a6f 625f 7175 6575 6520  t_scp_job_queue 
-00008c10: 696e 7374 6561 640a 4070 7974 6573 742e  instead.@pytest.
-00008c20: 6d61 726b 2e6e 6f5f 6f63 6920 2023 204f  mark.no_oci  # O
-00008c30: 4349 2064 6f65 7320 6e6f 7420 6861 7665  CI does not have
-00008c40: 204b 3830 2067 7075 730a 6465 6620 7465   K80 gpus.def te
-00008c50: 7374 5f6a 6f62 5f71 7565 7565 2867 656e  st_job_queue(gen
-00008c60: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
-00008c70: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
-00008c80: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
-00008c90: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
-00008ca0: 280a 2020 2020 2020 2020 276a 6f62 5f71  (.        'job_q
-00008cb0: 7565 7565 272c 0a20 2020 2020 2020 205b  ueue',.        [
-00008cc0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00008cd0: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
-00008ce0: 7b6e 616d 657d 202d 2d63 6c6f 7564 207b  {name} --cloud {
-00008cf0: 6765 6e65 7269 635f 636c 6f75 647d 2065  generic_cloud} e
-00008d00: 7861 6d70 6c65 732f 6a6f 625f 7175 6575  xamples/job_queu
-00008d10: 652f 636c 7573 7465 722e 7961 6d6c 272c  e/cluster.yaml',
-00008d20: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00008d30: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
-00008d40: 6e20 7b6e 616d 657d 2d31 202d 6420 6578  n {name}-1 -d ex
-00008d50: 616d 706c 6573 2f6a 6f62 5f71 7565 7565  amples/job_queue
-00008d60: 2f6a 6f62 2e79 616d 6c27 2c0a 2020 2020  /job.yaml',.    
-00008d70: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-00008d80: 6563 207b 6e61 6d65 7d20 2d6e 207b 6e61  ec {name} -n {na
-00008d90: 6d65 7d2d 3220 2d64 2065 7861 6d70 6c65  me}-2 -d example
-00008da0: 732f 6a6f 625f 7175 6575 652f 6a6f 622e  s/job_queue/job.
-00008db0: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-00008dc0: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
-00008dd0: 616d 657d 202d 6e20 7b6e 616d 657d 2d33  ame} -n {name}-3
-00008de0: 202d 6420 6578 616d 706c 6573 2f6a 6f62   -d examples/job
-00008df0: 5f71 7565 7565 2f6a 6f62 2e79 616d 6c27  _queue/job.yaml'
-00008e00: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00008e10: 733d 2428 736b 7920 7175 6575 6520 7b6e  s=$(sky queue {n
-00008e20: 616d 657d 293b 2065 6368 6f20 2224 7322  ame}); echo "$s"
-00008e30: 3b20 6563 686f 3b20 6563 686f 3b20 6563  ; echo; echo; ec
-00008e40: 686f 2022 2473 2220 7c20 6772 6570 207b  ho "$s" | grep {
-00008e50: 6e61 6d65 7d2d 3120 7c20 6772 6570 2052  name}-1 | grep R
-00008e60: 554e 4e49 4e47 272c 0a20 2020 2020 2020  UNNING',.       
-00008e70: 2020 2020 2066 2773 3d24 2873 6b79 2071       f's=$(sky q
-00008e80: 7565 7565 207b 6e61 6d65 7d29 3b20 6563  ueue {name}); ec
-00008e90: 686f 2022 2473 223b 2065 6368 6f3b 2065  ho "$s"; echo; e
-00008ea0: 6368 6f3b 2065 6368 6f20 2224 7322 207c  cho; echo "$s" |
-00008eb0: 2067 7265 7020 7b6e 616d 657d 2d32 207c   grep {name}-2 |
-00008ec0: 2067 7265 7020 5255 4e4e 494e 4727 2c0a   grep RUNNING',.
-00008ed0: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
-00008ee0: 2428 736b 7920 7175 6575 6520 7b6e 616d  $(sky queue {nam
-00008ef0: 657d 293b 2065 6368 6f20 2224 7322 3b20  e}); echo "$s"; 
-00008f00: 6563 686f 3b20 6563 686f 3b20 6563 686f  echo; echo; echo
-00008f10: 2022 2473 2220 7c20 6772 6570 207b 6e61   "$s" | grep {na
-00008f20: 6d65 7d2d 3320 7c20 6772 6570 2050 454e  me}-3 | grep PEN
-00008f30: 4449 4e47 272c 0a20 2020 2020 2020 2020  DING',.         
-00008f40: 2020 2066 2773 6b79 2063 616e 6365 6c20     f'sky cancel 
-00008f50: 2d79 207b 6e61 6d65 7d20 3227 2c0a 2020  -y {name} 2',.  
-00008f60: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
-00008f70: 2035 272c 0a20 2020 2020 2020 2020 2020   5',.           
-00008f80: 2066 2773 3d24 2873 6b79 2071 7565 7565   f's=$(sky queue
-00008f90: 207b 6e61 6d65 7d29 3b20 6563 686f 2022   {name}); echo "
-00008fa0: 2473 223b 2065 6368 6f3b 2065 6368 6f3b  $s"; echo; echo;
-00008fb0: 2065 6368 6f20 2224 7322 207c 2067 7265   echo "$s" | gre
-00008fc0: 7020 7b6e 616d 657d 2d33 207c 2067 7265  p {name}-3 | gre
-00008fd0: 7020 5255 4e4e 494e 4727 2c0a 2020 2020  p RUNNING',.    
-00008fe0: 2020 2020 2020 2020 6627 736b 7920 6361          f'sky ca
-00008ff0: 6e63 656c 202d 7920 7b6e 616d 657d 2033  ncel -y {name} 3
-00009000: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00009010: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-00009020: 202d 2d67 7075 7320 4b38 303a 302e 3220   --gpus K80:0.2 
-00009030: 225b 5b20 5c24 534b 5950 494c 4f54 5f4e  "[[ \$SKYPILOT_N
-00009040: 554d 5f47 5055 535f 5045 525f 4e4f 4445  UM_GPUS_PER_NODE
-00009050: 202d 6571 2031 205d 5d20 7c7c 2065 7869   -eq 1 ]] || exi
-00009060: 7420 3122 272c 0a20 2020 2020 2020 2020  t 1"',.         
-00009070: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
-00009080: 616d 657d 202d 2d67 7075 7320 4b38 303a  ame} --gpus K80:
-00009090: 3120 225b 5b20 5c24 534b 5950 494c 4f54  1 "[[ \$SKYPILOT
-000090a0: 5f4e 554d 5f47 5055 535f 5045 525f 4e4f  _NUM_GPUS_PER_NO
-000090b0: 4445 202d 6571 2031 205d 5d20 7c7c 2065  DE -eq 1 ]] || e
-000090c0: 7869 7420 3122 272c 0a20 2020 2020 2020  xit 1"',.       
-000090d0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-000090e0: 7b6e 616d 657d 2034 202d 2d73 7461 7475  {name} 4 --statu
-000090f0: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
-00009100: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-00009110: 7d20 3520 2d2d 7374 6174 7573 272c 0a20  } 5 --status',. 
-00009120: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-00009130: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
-00009140: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
-00009150: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-00009160: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
-00009170: 6d61 726b 2e6c 616d 6264 615f 636c 6f75  mark.lambda_clou
-00009180: 640a 6465 6620 7465 7374 5f6c 616d 6264  d.def test_lambd
-00009190: 615f 6a6f 625f 7175 6575 6528 293a 0a20  a_job_queue():. 
-000091a0: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-000091b0: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
-000091c0: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-000091d0: 2020 2020 2020 2027 6c61 6d62 6461 5f6a         'lambda_j
-000091e0: 6f62 5f71 7565 7565 272c 0a20 2020 2020  ob_queue',.     
-000091f0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-00009200: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
-00009210: 202d 6320 7b6e 616d 657d 207b 4c41 4d42   -c {name} {LAMB
-00009220: 4441 5f54 5950 457d 2065 7861 6d70 6c65  DA_TYPE} example
-00009230: 732f 6a6f 625f 7175 6575 652f 636c 7573  s/job_queue/clus
-00009240: 7465 722e 7961 6d6c 272c 0a20 2020 2020  ter.yaml',.     
-00009250: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-00009260: 6320 7b6e 616d 657d 202d 6e20 7b6e 616d  c {name} -n {nam
-00009270: 657d 2d31 202d 2d67 7075 7320 4131 303a  e}-1 --gpus A10:
-00009280: 302e 3520 2d64 2065 7861 6d70 6c65 732f  0.5 -d examples/
-00009290: 6a6f 625f 7175 6575 652f 6a6f 622e 7961  job_queue/job.ya
-000092a0: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-000092b0: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-000092c0: 657d 202d 6e20 7b6e 616d 657d 2d32 202d  e} -n {name}-2 -
-000092d0: 2d67 7075 7320 4131 303a 302e 3520 2d64  -gpus A10:0.5 -d
-000092e0: 2065 7861 6d70 6c65 732f 6a6f 625f 7175   examples/job_qu
-000092f0: 6575 652f 6a6f 622e 7961 6d6c 272c 0a20  eue/job.yaml',. 
-00009300: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00009310: 2065 7865 6320 7b6e 616d 657d 202d 6e20   exec {name} -n 
-00009320: 7b6e 616d 657d 2d33 202d 2d67 7075 7320  {name}-3 --gpus 
-00009330: 4131 303a 302e 3520 2d64 2065 7861 6d70  A10:0.5 -d examp
-00009340: 6c65 732f 6a6f 625f 7175 6575 652f 6a6f  les/job_queue/jo
-00009350: 622e 7961 6d6c 272c 0a20 2020 2020 2020  b.yaml',.       
-00009360: 2020 2020 2066 2773 6b79 2071 7565 7565       f'sky queue
-00009370: 207b 6e61 6d65 7d20 7c20 6772 6570 207b   {name} | grep {
-00009380: 6e61 6d65 7d2d 3120 7c20 6772 6570 2052  name}-1 | grep R
-00009390: 554e 4e49 4e47 272c 0a20 2020 2020 2020  UNNING',.       
-000093a0: 2020 2020 2066 2773 6b79 2071 7565 7565       f'sky queue
-000093b0: 207b 6e61 6d65 7d20 7c20 6772 6570 207b   {name} | grep {
-000093c0: 6e61 6d65 7d2d 3220 7c20 6772 6570 2052  name}-2 | grep R
-000093d0: 554e 4e49 4e47 272c 0a20 2020 2020 2020  UNNING',.       
-000093e0: 2020 2020 2066 2773 6b79 2071 7565 7565       f'sky queue
-000093f0: 207b 6e61 6d65 7d20 7c20 6772 6570 207b   {name} | grep {
-00009400: 6e61 6d65 7d2d 3320 7c20 6772 6570 2050  name}-3 | grep P
-00009410: 454e 4449 4e47 272c 0a20 2020 2020 2020  ENDING',.       
-00009420: 2020 2020 2066 2773 6b79 2063 616e 6365       f'sky cance
-00009430: 6c20 2d79 207b 6e61 6d65 7d20 3227 2c0a  l -y {name} 2',.
-00009440: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
-00009450: 6570 2035 272c 0a20 2020 2020 2020 2020  ep 5',.         
-00009460: 2020 2066 2773 6b79 2071 7565 7565 207b     f'sky queue {
-00009470: 6e61 6d65 7d20 7c20 6772 6570 207b 6e61  name} | grep {na
-00009480: 6d65 7d2d 3320 7c20 6772 6570 2052 554e  me}-3 | grep RUN
-00009490: 4e49 4e47 272c 0a20 2020 2020 2020 2020  NING',.         
-000094a0: 2020 2066 2773 6b79 2063 616e 6365 6c20     f'sky cancel 
-000094b0: 2d79 207b 6e61 6d65 7d20 3327 2c0a 2020  -y {name} 3',.  
-000094c0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-000094d0: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
-000094e0: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
-000094f0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-00009500: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
-00009510: 6172 6b2e 6962 6d0a 6465 6620 7465 7374  ark.ibm.def test
-00009520: 5f69 626d 5f6a 6f62 5f71 7565 7565 2829  _ibm_job_queue()
-00009530: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
-00009540: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
-00009550: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
-00009560: 280a 2020 2020 2020 2020 2769 626d 5f6a  (.        'ibm_j
-00009570: 6f62 5f71 7565 7565 272c 0a20 2020 2020  ob_queue',.     
-00009580: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-00009590: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
-000095a0: 202d 6320 7b6e 616d 657d 202d 2d63 6c6f   -c {name} --clo
-000095b0: 7564 2069 626d 202d 2d67 7075 7320 7631  ud ibm --gpus v1
-000095c0: 3030 272c 0a20 2020 2020 2020 2020 2020  00',.           
-000095d0: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-000095e0: 657d 202d 6e20 7b6e 616d 657d 2d31 202d  e} -n {name}-1 -
-000095f0: 2d63 6c6f 7564 2069 626d 202d 6420 6578  -cloud ibm -d ex
-00009600: 616d 706c 6573 2f6a 6f62 5f71 7565 7565  amples/job_queue
-00009610: 2f6a 6f62 5f69 626d 2e79 616d 6c27 2c0a  /job_ibm.yaml',.
-00009620: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00009630: 7920 6578 6563 207b 6e61 6d65 7d20 2d6e  y exec {name} -n
-00009640: 207b 6e61 6d65 7d2d 3220 2d2d 636c 6f75   {name}-2 --clou
-00009650: 6420 6962 6d20 2d64 2065 7861 6d70 6c65  d ibm -d example
-00009660: 732f 6a6f 625f 7175 6575 652f 6a6f 625f  s/job_queue/job_
-00009670: 6962 6d2e 7961 6d6c 272c 0a20 2020 2020  ibm.yaml',.     
-00009680: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-00009690: 6320 7b6e 616d 657d 202d 6e20 7b6e 616d  c {name} -n {nam
-000096a0: 657d 2d33 202d 2d63 6c6f 7564 2069 626d  e}-3 --cloud ibm
-000096b0: 202d 6420 6578 616d 706c 6573 2f6a 6f62   -d examples/job
-000096c0: 5f71 7565 7565 2f6a 6f62 5f69 626d 2e79  _queue/job_ibm.y
-000096d0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-000096e0: 2020 6627 736b 7920 7175 6575 6520 7b6e    f'sky queue {n
-000096f0: 616d 657d 207c 2067 7265 7020 7b6e 616d  ame} | grep {nam
-00009700: 657d 2d31 207c 2067 7265 7020 5255 4e4e  e}-1 | grep RUNN
-00009710: 494e 4727 2c0a 2020 2020 2020 2020 2020  ING',.          
-00009720: 2020 6627 736b 7920 7175 6575 6520 7b6e    f'sky queue {n
-00009730: 616d 657d 207c 2067 7265 7020 7b6e 616d  ame} | grep {nam
-00009740: 657d 2d32 207c 2067 7265 7020 5255 4e4e  e}-2 | grep RUNN
-00009750: 494e 4727 2c0a 2020 2020 2020 2020 2020  ING',.          
-00009760: 2020 6627 736b 7920 7175 6575 6520 7b6e    f'sky queue {n
-00009770: 616d 657d 207c 2067 7265 7020 7b6e 616d  ame} | grep {nam
-00009780: 657d 2d33 207c 2067 7265 7020 5045 4e44  e}-3 | grep PEND
-00009790: 494e 4727 2c0a 2020 2020 2020 2020 2020  ING',.          
-000097a0: 2020 6627 736b 7920 6361 6e63 656c 202d    f'sky cancel -
-000097b0: 7920 7b6e 616d 657d 2032 272c 0a20 2020  y {name} 2',.   
-000097c0: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-000097d0: 3527 2c0a 2020 2020 2020 2020 2020 2020  5',.            
-000097e0: 6627 736b 7920 7175 6575 6520 7b6e 616d  f'sky queue {nam
-000097f0: 657d 207c 2067 7265 7020 7b6e 616d 657d  e} | grep {name}
-00009800: 2d33 207c 2067 7265 7020 5255 4e4e 494e  -3 | grep RUNNIN
-00009810: 4727 2c0a 2020 2020 2020 2020 2020 2020  G',.            
-00009820: 6627 736b 7920 6361 6e63 656c 202d 7920  f'sky cancel -y 
-00009830: 7b6e 616d 657d 2033 272c 0a20 2020 2020  {name} 3',.     
-00009840: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
-00009850: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
-00009860: 657d 272c 0a20 2020 2029 0a20 2020 2072  e}',.    ).    r
-00009870: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-00009880: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
-00009890: 2e73 6370 0a64 6566 2074 6573 745f 7363  .scp.def test_sc
-000098a0: 705f 6a6f 625f 7175 6575 6528 293a 0a20  p_job_queue():. 
-000098b0: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-000098c0: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
-000098d0: 2020 6e75 6d5f 6f66 5f67 7075 5f6c 6175    num_of_gpu_lau
-000098e0: 6e63 6820 3d20 310a 2020 2020 6e75 6d5f  nch = 1.    num_
-000098f0: 6f66 5f67 7075 5f65 7865 6320 3d20 302e  of_gpu_exec = 0.
-00009900: 350a 2020 2020 7465 7374 203d 2054 6573  5.    test = Tes
-00009910: 7428 0a20 2020 2020 2020 2027 5343 505f  t(.        'SCP_
-00009920: 6a6f 625f 7175 6575 6527 2c0a 2020 2020  job_queue',.    
-00009930: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-00009940: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-00009950: 7920 2d63 207b 6e61 6d65 7d20 7b53 4350  y -c {name} {SCP
-00009960: 5f54 5950 457d 207b 5343 505f 4750 555f  _TYPE} {SCP_GPU_
-00009970: 5631 3030 7d3a 7b6e 756d 5f6f 665f 6770  V100}:{num_of_gp
-00009980: 755f 6c61 756e 6368 7d20 6578 616d 706c  u_launch} exampl
-00009990: 6573 2f6a 6f62 5f71 7565 7565 2f63 6c75  es/job_queue/clu
-000099a0: 7374 6572 2e79 616d 6c27 2c0a 2020 2020  ster.yaml',.    
-000099b0: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-000099c0: 6563 207b 6e61 6d65 7d20 2d6e 207b 6e61  ec {name} -n {na
-000099d0: 6d65 7d2d 3120 7b53 4350 5f47 5055 5f56  me}-1 {SCP_GPU_V
-000099e0: 3130 307d 3a7b 6e75 6d5f 6f66 5f67 7075  100}:{num_of_gpu
-000099f0: 5f65 7865 637d 202d 6420 6578 616d 706c  _exec} -d exampl
+00006010: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
+00006020: 726b 2e6e 6f5f 6b75 6265 726e 6574 6573  rk.no_kubernetes
+00006030: 2020 2320 4b75 6265 726e 6574 6573 2064    # Kubernetes d
+00006040: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
+00006050: 7374 6f70 7069 6e67 2069 6e73 7461 6e63  stopping instanc
+00006060: 6573 0a64 6566 2074 6573 745f 7374 616c  es.def test_stal
+00006070: 655f 6a6f 6228 6765 6e65 7269 635f 636c  e_job(generic_cl
+00006080: 6f75 643a 2073 7472 293a 0a20 2020 206e  oud: str):.    n
+00006090: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
+000060a0: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
+000060b0: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+000060c0: 2020 2027 7374 616c 655f 6a6f 6227 2c0a     'stale_job',.
+000060d0: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
+000060e0: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
+000060f0: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
+00006100: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
+00006110: 5f63 6c6f 7564 7d20 2265 6368 6f20 6869  _cloud} "echo hi
+00006120: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+00006130: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+00006140: 7d20 2d64 2022 6563 686f 2073 7461 7274  } -d "echo start
+00006150: 3b20 736c 6565 7020 3130 3030 3022 272c  ; sleep 10000"',
+00006160: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00006170: 6b79 2073 746f 7020 7b6e 616d 657d 202d  ky stop {name} -
+00006180: 7927 2c0a 2020 2020 2020 2020 2020 2020  y',.            
+00006190: 2773 6c65 6570 2031 3030 272c 2020 2320  'sleep 100',  # 
+000061a0: 456e 7375 7265 2074 6869 7320 6973 206c  Ensure this is l
+000061b0: 6172 6765 2065 6e6f 7567 682c 2065 6c73  arge enough, els
+000061c0: 6520 4743 5020 6c65 616b 732e 0a20 2020  e GCP leaks..   
+000061d0: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
+000061e0: 7461 7274 207b 6e61 6d65 7d20 2d79 272c  tart {name} -y',
+000061f0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00006200: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
+00006210: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
+00006220: 2020 2020 2020 2020 6627 733d 2428 736b          f's=$(sk
+00006230: 7920 7175 6575 6520 7b6e 616d 657d 293b  y queue {name});
+00006240: 2065 6368 6f20 2224 7322 3b20 6563 686f   echo "$s"; echo
+00006250: 3b20 6563 686f 3b20 6563 686f 2022 2473  ; echo; echo "$s
+00006260: 2220 7c20 6772 6570 2046 4149 4c45 4427  " | grep FAILED'
+00006270: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
+00006280: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
+00006290: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
+000062a0: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
+000062b0: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
+000062c0: 7374 2e6d 6172 6b2e 6177 730a 6465 6620  st.mark.aws.def 
+000062d0: 7465 7374 5f61 7773 5f73 7461 6c65 5f6a  test_aws_stale_j
+000062e0: 6f62 5f6d 616e 7561 6c5f 7265 7374 6172  ob_manual_restar
+000062f0: 7428 293a 0a20 2020 206e 616d 6520 3d20  t():.    name = 
+00006300: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+00006310: 6528 290a 2020 2020 7265 6769 6f6e 203d  e().    region =
+00006320: 2027 7573 2d77 6573 742d 3227 0a20 2020   'us-west-2'.   
+00006330: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+00006340: 2020 2020 2020 2761 7773 5f73 7461 6c65        'aws_stale
+00006350: 5f6a 6f62 5f6d 616e 7561 6c5f 7265 7374  _job_manual_rest
+00006360: 6172 7427 2c0a 2020 2020 2020 2020 5b0a  art',.        [.
+00006370: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00006380: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
+00006390: 6e61 6d65 7d20 2d2d 636c 6f75 6420 6177  name} --cloud aw
+000063a0: 7320 2d2d 7265 6769 6f6e 207b 7265 6769  s --region {regi
+000063b0: 6f6e 7d20 2265 6368 6f20 6869 2227 2c0a  on} "echo hi"',.
+000063c0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+000063d0: 7920 6578 6563 207b 6e61 6d65 7d20 2d64  y exec {name} -d
+000063e0: 2022 6563 686f 2073 7461 7274 3b20 736c   "echo start; sl
+000063f0: 6565 7020 3130 3030 3022 272c 0a20 2020  eep 10000"',.   
+00006400: 2020 2020 2020 2020 2023 2053 746f 7020           # Stop 
+00006410: 7468 6520 636c 7573 7465 7220 6d61 6e75  the cluster manu
+00006420: 616c 6c79 2e0a 2020 2020 2020 2020 2020  ally..          
+00006430: 2020 6627 6964 3d60 6177 7320 6563 3220    f'id=`aws ec2 
+00006440: 6465 7363 7269 6265 2d69 6e73 7461 6e63  describe-instanc
+00006450: 6573 202d 2d72 6567 696f 6e20 7b72 6567  es --region {reg
+00006460: 696f 6e7d 202d 2d66 696c 7465 7273 2027  ion} --filters '
+00006470: 0a20 2020 2020 2020 2020 2020 2066 274e  .            f'N
+00006480: 616d 653d 7461 673a 7261 792d 636c 7573  ame=tag:ray-clus
+00006490: 7465 722d 6e61 6d65 2c56 616c 7565 733d  ter-name,Values=
+000064a0: 7b6e 616d 657d 2027 0a20 2020 2020 2020  {name} '.       
+000064b0: 2020 2020 2066 272d 2d71 7565 7279 2052       f'--query R
+000064c0: 6573 6572 7661 7469 6f6e 735b 5d2e 496e  eservations[].In
+000064d0: 7374 616e 6365 735b 5d2e 496e 7374 616e  stances[].Instan
+000064e0: 6365 4964 2027 0a20 2020 2020 2020 2020  ceId '.         
+000064f0: 2020 2027 2d2d 6f75 7470 7574 2074 6578     '--output tex
+00006500: 7460 3b20 270a 2020 2020 2020 2020 2020  t`; '.          
+00006510: 2020 6627 6177 7320 6563 3220 7374 6f70    f'aws ec2 stop
+00006520: 2d69 6e73 7461 6e63 6573 202d 2d72 6567  -instances --reg
+00006530: 696f 6e20 7b72 6567 696f 6e7d 2027 0a20  ion {region} '. 
+00006540: 2020 2020 2020 2020 2020 2027 2d2d 696e             '--in
+00006550: 7374 616e 6365 2d69 6473 2024 6964 272c  stance-ids $id',
+00006560: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+00006570: 6565 7020 3430 272c 0a20 2020 2020 2020  eep 40',.       
+00006580: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+00006590: 6820 2d63 207b 6e61 6d65 7d20 2d79 2022  h -c {name} -y "
+000065a0: 6563 686f 2068 6922 272c 0a20 2020 2020  echo hi"',.     
+000065b0: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+000065c0: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
+000065d0: 7475 7327 2c0a 2020 2020 2020 2020 2020  tus',.          
+000065e0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+000065f0: 6d65 7d20 3320 2d2d 7374 6174 7573 272c  me} 3 --status',
+00006600: 0a20 2020 2020 2020 2020 2020 2023 2045  .            # E
+00006610: 6e73 7572 6520 7468 6520 736b 796c 6574  nsure the skylet
+00006620: 2075 7064 6174 6564 2074 6865 2073 7461   updated the sta
+00006630: 6c65 206a 6f62 2073 7461 7475 732e 0a20  le job status.. 
+00006640: 2020 2020 2020 2020 2020 2066 2773 6c65             f'sle
+00006650: 6570 207b 6576 656e 7473 2e4a 6f62 5363  ep {events.JobSc
+00006660: 6865 6475 6c65 7245 7665 6e74 2e45 5645  hedulerEvent.EVE
+00006670: 4e54 5f49 4e54 4552 5641 4c5f 5345 434f  NT_INTERVAL_SECO
+00006680: 4e44 537d 272c 0a20 2020 2020 2020 2020  NDS}',.         
+00006690: 2020 2066 2773 3d24 2873 6b79 2071 7565     f's=$(sky que
+000066a0: 7565 207b 6e61 6d65 7d29 3b20 6563 686f  ue {name}); echo
+000066b0: 2022 2473 223b 2065 6368 6f3b 2065 6368   "$s"; echo; ech
+000066c0: 6f3b 2065 6368 6f20 2224 7322 207c 2067  o; echo "$s" | g
+000066d0: 7265 7020 4641 494c 4544 272c 0a20 2020  rep FAILED',.   
+000066e0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+000066f0: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
+00006700: 616d 657d 272c 0a20 2020 2029 0a20 2020  ame}',.    ).   
+00006710: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+00006720: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
+00006730: 726b 2e67 6370 0a64 6566 2074 6573 745f  rk.gcp.def test_
+00006740: 6763 705f 7374 616c 655f 6a6f 625f 6d61  gcp_stale_job_ma
+00006750: 6e75 616c 5f72 6573 7461 7274 2829 3a0a  nual_restart():.
+00006760: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+00006770: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+00006780: 2020 207a 6f6e 6520 3d20 2775 732d 7765     zone = 'us-we
+00006790: 7374 322d 6127 0a20 2020 2071 7565 7279  st2-a'.    query
+000067a0: 5f63 6d64 203d 2028 6627 6763 6c6f 7564  _cmd = (f'gcloud
+000067b0: 2063 6f6d 7075 7465 2069 6e73 7461 6e63   compute instanc
+000067c0: 6573 206c 6973 7420 2d2d 6669 6c74 6572  es list --filter
+000067d0: 3d27 0a20 2020 2020 2020 2020 2020 2020  ='.             
+000067e0: 2020 2020 6627 2228 6c61 6265 6c73 2e72      f'"(labels.r
+000067f0: 6179 2d63 6c75 7374 6572 2d6e 616d 653d  ay-cluster-name=
+00006800: 7b6e 616d 657d 2922 2027 0a20 2020 2020  {name})" '.     
+00006810: 2020 2020 2020 2020 2020 2020 6627 2d2d              f'--
+00006820: 7a6f 6e65 733d 7b7a 6f6e 657d 202d 2d66  zones={zone} --f
+00006830: 6f72 6d61 743d 2276 616c 7565 286e 616d  ormat="value(nam
+00006840: 6529 2227 290a 2020 2020 7374 6f70 5f63  e)"').    stop_c
+00006850: 6d64 203d 2028 6627 6763 6c6f 7564 2063  md = (f'gcloud c
+00006860: 6f6d 7075 7465 2069 6e73 7461 6e63 6573  ompute instances
+00006870: 2073 746f 7020 2d2d 7a6f 6e65 3d7b 7a6f   stop --zone={zo
+00006880: 6e65 7d27 0a20 2020 2020 2020 2020 2020  ne}'.           
+00006890: 2020 2020 2066 2720 2d2d 7175 6965 7420       f' --quiet 
+000068a0: 2428 7b71 7565 7279 5f63 6d64 7d29 2729  $({query_cmd})')
+000068b0: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+000068c0: 280a 2020 2020 2020 2020 2767 6370 5f73  (.        'gcp_s
+000068d0: 7461 6c65 5f6a 6f62 5f6d 616e 7561 6c5f  tale_job_manual_
+000068e0: 7265 7374 6172 7427 2c0a 2020 2020 2020  restart',.      
+000068f0: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+00006900: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
+00006910: 2d63 207b 6e61 6d65 7d20 2d2d 636c 6f75  -c {name} --clou
+00006920: 6420 6763 7020 2d2d 7a6f 6e65 207b 7a6f  d gcp --zone {zo
+00006930: 6e65 7d20 2265 6368 6f20 6869 2227 2c0a  ne} "echo hi"',.
+00006940: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00006950: 7920 6578 6563 207b 6e61 6d65 7d20 2d64  y exec {name} -d
+00006960: 2022 6563 686f 2073 7461 7274 3b20 736c   "echo start; sl
+00006970: 6565 7020 3130 3030 3022 272c 0a20 2020  eep 10000"',.   
+00006980: 2020 2020 2020 2020 2023 2053 746f 7020           # Stop 
+00006990: 7468 6520 636c 7573 7465 7220 6d61 6e75  the cluster manu
+000069a0: 616c 6c79 2e0a 2020 2020 2020 2020 2020  ally..          
+000069b0: 2020 7374 6f70 5f63 6d64 2c0a 2020 2020    stop_cmd,.    
+000069c0: 2020 2020 2020 2020 2773 6c65 6570 2034          'sleep 4
+000069d0: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
+000069e0: 6627 736b 7920 6c61 756e 6368 202d 6320  f'sky launch -c 
+000069f0: 7b6e 616d 657d 202d 7920 2265 6368 6f20  {name} -y "echo 
+00006a00: 6869 2227 2c0a 2020 2020 2020 2020 2020  hi"',.          
+00006a10: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+00006a20: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
+00006a30: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00006a40: 6b79 206c 6f67 7320 7b6e 616d 657d 2033  ky logs {name} 3
+00006a50: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
+00006a60: 2020 2020 2020 2020 2320 456e 7375 7265          # Ensure
+00006a70: 2074 6865 2073 6b79 6c65 7420 7570 6461   the skylet upda
+00006a80: 7465 6420 7468 6520 7374 616c 6520 6a6f  ted the stale jo
+00006a90: 6220 7374 6174 7573 2e0a 2020 2020 2020  b status..      
+00006aa0: 2020 2020 2020 6627 736c 6565 7020 7b65        f'sleep {e
+00006ab0: 7665 6e74 732e 4a6f 6253 6368 6564 756c  vents.JobSchedul
+00006ac0: 6572 4576 656e 742e 4556 454e 545f 494e  erEvent.EVENT_IN
+00006ad0: 5445 5256 414c 5f53 4543 4f4e 4453 7d27  TERVAL_SECONDS}'
+00006ae0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00006af0: 733d 2428 736b 7920 7175 6575 6520 7b6e  s=$(sky queue {n
+00006b00: 616d 657d 293b 2065 6368 6f20 2224 7322  ame}); echo "$s"
+00006b10: 3b20 6563 686f 3b20 6563 686f 3b20 6563  ; echo; echo; ec
+00006b20: 686f 2022 2473 2220 7c20 6772 6570 2046  ho "$s" | grep F
+00006b30: 4149 4c45 4427 2c0a 2020 2020 2020 2020  AILED',.        
+00006b40: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
+00006b50: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
+00006b60: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
+00006b70: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+00006b80: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20 4368  .# ---------- Ch
+00006b90: 6563 6b20 536b 7927 7320 656e 7669 726f  eck Sky's enviro
+00006ba0: 6e6d 656e 7420 7661 7269 6162 6c65 733b  nment variables;
+00006bb0: 2077 6f72 6b64 6972 2e20 2d2d 2d2d 2d2d   workdir. ------
+00006bc0: 2d2d 2d2d 0a40 7079 7465 7374 2e6d 6172  ----.@pytest.mar
+00006bd0: 6b2e 6e6f 5f73 6370 2020 2320 5343 5020  k.no_scp  # SCP 
+00006be0: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
+00006bf0: 206e 756d 5f6e 6f64 6573 203e 2031 2079   num_nodes > 1 y
+00006c00: 6574 0a40 7079 7465 7374 2e6d 6172 6b2e  et.@pytest.mark.
+00006c10: 6e6f 5f6b 7562 6572 6e65 7465 7320 2023  no_kubernetes  #
+00006c20: 204b 3873 2064 6f65 7320 6e6f 7420 7375   K8s does not su
+00006c30: 7070 6f72 7420 6e75 6d5f 6e6f 6465 7320  pport num_nodes 
+00006c40: 3e20 3120 7965 740a 6465 6620 7465 7374  > 1 yet.def test
+00006c50: 5f65 6e76 5f63 6865 636b 2867 656e 6572  _env_check(gener
+00006c60: 6963 5f63 6c6f 7564 3a20 7374 7229 3a0a  ic_cloud: str):.
+00006c70: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+00006c80: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+00006c90: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+00006ca0: 2020 2020 2020 2020 2765 6e76 5f63 6865          'env_che
+00006cb0: 636b 272c 0a20 2020 2020 2020 205b 0a20  ck',.        [. 
+00006cc0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00006cd0: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
+00006ce0: 616d 657d 202d 2d63 6c6f 7564 207b 6765  ame} --cloud {ge
+00006cf0: 6e65 7269 635f 636c 6f75 647d 202d 2d64  neric_cloud} --d
+00006d00: 6574 6163 682d 7365 7475 7020 6578 616d  etach-setup exam
+00006d10: 706c 6573 2f65 6e76 5f63 6865 636b 2e79  ples/env_check.y
+00006d20: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+00006d30: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+00006d40: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
+00006d50: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
+00006d60: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
+00006d70: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+00006d80: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
+00006d90: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
+00006da0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+00006db0: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
+00006dc0: 2d2d 2d20 6669 6c65 5f6d 6f75 6e74 7320  --- file_mounts 
+00006dd0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465  ----------.@pyte
+00006de0: 7374 2e6d 6172 6b2e 6e6f 5f73 6370 2020  st.mark.no_scp  
+00006df0: 2320 5343 5020 646f 6573 206e 6f74 2073  # SCP does not s
+00006e00: 7570 706f 7274 206e 756d 5f6e 6f64 6573  upport num_nodes
+00006e10: 203e 2031 2079 6574 2e20 5275 6e20 7465   > 1 yet. Run te
+00006e20: 7374 5f73 6370 5f66 696c 655f 6d6f 756e  st_scp_file_moun
+00006e30: 7473 2069 6e73 7465 6164 2e0a 6465 6620  ts instead..def 
+00006e40: 7465 7374 5f66 696c 655f 6d6f 756e 7473  test_file_mounts
+00006e50: 2867 656e 6572 6963 5f63 6c6f 7564 3a20  (generic_cloud: 
+00006e60: 7374 7229 3a0a 2020 2020 6e61 6d65 203d  str):.    name =
+00006e70: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+00006e80: 6d65 2829 0a20 2020 2065 7874 7261 5f66  me().    extra_f
+00006e90: 6c61 6773 203d 2027 270a 2020 2020 6966  lags = ''.    if
+00006ea0: 2067 656e 6572 6963 5f63 6c6f 7564 2069   generic_cloud i
+00006eb0: 6e20 276b 7562 6572 6e65 7465 7327 3a0a  n 'kubernetes':.
+00006ec0: 2020 2020 2020 2020 2320 4b75 6265 726e          # Kubern
+00006ed0: 6574 6573 2064 6f65 7320 6e6f 7420 7375  etes does not su
+00006ee0: 7070 6f72 7420 6d75 6c74 692d 6e6f 6465  pport multi-node
+00006ef0: 0a20 2020 2020 2020 2023 204e 4f54 453a  .        # NOTE:
+00006f00: 2054 6869 7320 7465 7374 2077 696c 6c20   This test will 
+00006f10: 6661 696c 2069 6620 796f 7520 6861 7665  fail if you have
+00006f20: 2061 204b 7562 6572 6e65 7465 7320 636c   a Kubernetes cl
+00006f30: 7573 7465 7220 7275 6e6e 696e 6720 6f6e  uster running on
+00006f40: 0a20 2020 2020 2020 2023 2020 6172 6d36  .        #  arm6
+00006f50: 3420 2865 2e67 2e2c 2041 7070 6c65 2053  4 (e.g., Apple S
+00006f60: 696c 6963 6f6e 2920 7369 6e63 6520 676f  ilicon) since go
+00006f70: 6f66 7973 2064 6f65 7320 6e6f 7420 776f  ofys does not wo
+00006f80: 726b 206f 6e20 6172 6d36 342e 0a20 2020  rk on arm64..   
+00006f90: 2020 2020 2065 7874 7261 5f66 6c61 6773       extra_flags
+00006fa0: 203d 2027 2d2d 6e75 6d2d 6e6f 6465 7320   = '--num-nodes 
+00006fb0: 3127 0a20 2020 2074 6573 745f 636f 6d6d  1'.    test_comm
+00006fc0: 616e 6473 203d 205b 0a20 2020 2020 2020  ands = [.       
+00006fd0: 202a 7374 6f72 6167 655f 7365 7475 705f   *storage_setup_
+00006fe0: 636f 6d6d 616e 6473 2c0a 2020 2020 2020  commands,.      
+00006ff0: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
+00007000: 7920 2d63 207b 6e61 6d65 7d20 2d2d 636c  y -c {name} --cl
+00007010: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
+00007020: 7564 7d20 7b65 7874 7261 5f66 6c61 6773  ud} {extra_flags
+00007030: 7d20 6578 616d 706c 6573 2f75 7369 6e67  } examples/using
+00007040: 5f66 696c 655f 6d6f 756e 7473 2e79 616d  _file_mounts.yam
+00007050: 6c27 2c0a 2020 2020 2020 2020 6627 736b  l',.        f'sk
+00007060: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
+00007070: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
+00007080: 7375 7265 2074 6865 206a 6f62 2073 7563  sure the job suc
+00007090: 6365 6564 6564 2e0a 2020 2020 5d0a 2020  ceeded..    ].  
+000070a0: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+000070b0: 2020 2020 2020 2027 7573 696e 675f 6669         'using_fi
+000070c0: 6c65 5f6d 6f75 6e74 7327 2c0a 2020 2020  le_mounts',.    
+000070d0: 2020 2020 7465 7374 5f63 6f6d 6d61 6e64      test_command
+000070e0: 732c 0a20 2020 2020 2020 2066 2773 6b79  s,.        f'sky
+000070f0: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
+00007100: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
+00007110: 743d 3230 202a 2036 302c 2020 2320 3230  t=20 * 60,  # 20
+00007120: 206d 696e 730a 2020 2020 290a 2020 2020   mins.    ).    
+00007130: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+00007140: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
+00007150: 6b2e 7363 700a 6465 6620 7465 7374 5f73  k.scp.def test_s
+00007160: 6370 5f66 696c 655f 6d6f 756e 7473 2829  cp_file_mounts()
+00007170: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
+00007180: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+00007190: 0a20 2020 2074 6573 745f 636f 6d6d 616e  .    test_comman
+000071a0: 6473 203d 205b 0a20 2020 2020 2020 202a  ds = [.        *
+000071b0: 7374 6f72 6167 655f 7365 7475 705f 636f  storage_setup_co
+000071c0: 6d6d 616e 6473 2c0a 2020 2020 2020 2020  mmands,.        
+000071d0: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
+000071e0: 2d63 207b 6e61 6d65 7d20 7b53 4350 5f54  -c {name} {SCP_T
+000071f0: 5950 457d 202d 2d6e 756d 2d6e 6f64 6573  YPE} --num-nodes
+00007200: 2031 2065 7861 6d70 6c65 732f 7573 696e   1 examples/usin
+00007210: 675f 6669 6c65 5f6d 6f75 6e74 732e 7961  g_file_mounts.ya
+00007220: 6d6c 272c 0a20 2020 2020 2020 2066 2773  ml',.        f's
+00007230: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
+00007240: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
+00007250: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
+00007260: 6363 6565 6465 642e 0a20 2020 205d 0a20  cceeded..    ]. 
+00007270: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+00007280: 2020 2020 2020 2020 2753 4350 5f75 7369          'SCP_usi
+00007290: 6e67 5f66 696c 655f 6d6f 756e 7473 272c  ng_file_mounts',
+000072a0: 0a20 2020 2020 2020 2074 6573 745f 636f  .        test_co
+000072b0: 6d6d 616e 6473 2c0a 2020 2020 2020 2020  mmands,.        
+000072c0: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
+000072d0: 616d 657d 272c 0a20 2020 2020 2020 2074  ame}',.        t
+000072e0: 696d 656f 7574 3d32 3020 2a20 3630 2c20  imeout=20 * 60, 
+000072f0: 2023 2032 3020 6d69 6e73 0a20 2020 2029   # 20 mins.    )
+00007300: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+00007310: 7428 7465 7374 290a 0a0a 6465 6620 7465  t(test)...def te
+00007320: 7374 5f75 7369 6e67 5f66 696c 655f 6d6f  st_using_file_mo
+00007330: 756e 7473 5f77 6974 685f 656e 765f 7661  unts_with_env_va
+00007340: 7273 2867 656e 6572 6963 5f63 6c6f 7564  rs(generic_cloud
+00007350: 3a20 7374 7229 3a0a 2020 2020 6e61 6d65  : str):.    name
+00007360: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+00007370: 6e61 6d65 2829 0a20 2020 2074 6573 745f  name().    test_
+00007380: 636f 6d6d 616e 6473 203d 205b 0a20 2020  commands = [.   
+00007390: 2020 2020 202a 7374 6f72 6167 655f 7365       *storage_se
+000073a0: 7475 705f 636f 6d6d 616e 6473 2c0a 2020  tup_commands,.  
+000073b0: 2020 2020 2020 2866 2773 6b79 206c 6175        (f'sky lau
+000073c0: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
+000073d0: 202d 2d63 7075 7320 322b 202d 2d63 6c6f   --cpus 2+ --clo
+000073e0: 7564 207b 6765 6e65 7269 635f 636c 6f75  ud {generic_clou
+000073f0: 647d 2027 0a20 2020 2020 2020 2020 2765  d} '.         'e
+00007400: 7861 6d70 6c65 732f 7573 696e 675f 6669  xamples/using_fi
+00007410: 6c65 5f6d 6f75 6e74 735f 7769 7468 5f65  le_mounts_with_e
+00007420: 6e76 5f76 6172 732e 7961 6d6c 2729 2c0a  nv_vars.yaml'),.
+00007430: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+00007440: 6773 207b 6e61 6d65 7d20 3120 2d2d 7374  gs {name} 1 --st
+00007450: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
+00007460: 2074 6865 206a 6f62 2073 7563 6365 6564   the job succeed
+00007470: 6564 2e0a 2020 2020 2020 2020 2320 4f76  ed..        # Ov
+00007480: 6572 7269 6465 2077 6974 6820 2d2d 656e  erride with --en
+00007490: 763a 0a20 2020 2020 2020 2028 6627 736b  v:.        (f'sk
+000074a0: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
+000074b0: 6e61 6d65 7d2d 3220 2d2d 6370 7573 2032  name}-2 --cpus 2
+000074c0: 2b20 2d2d 636c 6f75 6420 7b67 656e 6572  + --cloud {gener
+000074d0: 6963 5f63 6c6f 7564 7d20 270a 2020 2020  ic_cloud} '.    
+000074e0: 2020 2020 2027 6578 616d 706c 6573 2f75       'examples/u
+000074f0: 7369 6e67 5f66 696c 655f 6d6f 756e 7473  sing_file_mounts
+00007500: 5f77 6974 685f 656e 765f 7661 7273 2e79  _with_env_vars.y
+00007510: 616d 6c20 270a 2020 2020 2020 2020 2027  aml '.         '
+00007520: 2d2d 656e 7620 4d59 5f4c 4f43 414c 5f50  --env MY_LOCAL_P
+00007530: 4154 483d 746d 7066 696c 6527 292c 0a20  ATH=tmpfile'),. 
+00007540: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+00007550: 7320 7b6e 616d 657d 2d32 2031 202d 2d73  s {name}-2 1 --s
+00007560: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
+00007570: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
+00007580: 6465 642e 0a20 2020 205d 0a20 2020 2074  ded..    ].    t
+00007590: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+000075a0: 2020 2020 2775 7369 6e67 5f66 696c 655f      'using_file_
+000075b0: 6d6f 756e 7473 5f77 6974 685f 656e 765f  mounts_with_env_
+000075c0: 7661 7273 272c 0a20 2020 2020 2020 2074  vars',.        t
+000075d0: 6573 745f 636f 6d6d 616e 6473 2c0a 2020  est_commands,.  
+000075e0: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
+000075f0: 202d 7920 7b6e 616d 657d 207b 6e61 6d65   -y {name} {name
+00007600: 7d2d 3227 2c0a 2020 2020 2020 2020 7469  }-2',.        ti
+00007610: 6d65 6f75 743d 3230 202a 2036 302c 2020  meout=20 * 60,  
+00007620: 2320 3230 206d 696e 730a 2020 2020 290a  # 20 mins.    ).
+00007630: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+00007640: 2874 6573 7429 0a0a 0a23 202d 2d2d 2d2d  (test)...# -----
+00007650: 2d2d 2d2d 2d20 7374 6f72 6167 6520 2d2d  ----- storage --
+00007660: 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465 7374  --------.@pytest
+00007670: 2e6d 6172 6b2e 6177 730a 6465 6620 7465  .mark.aws.def te
+00007680: 7374 5f61 7773 5f73 746f 7261 6765 5f6d  st_aws_storage_m
+00007690: 6f75 6e74 7328 293a 0a20 2020 206e 616d  ounts():.    nam
+000076a0: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+000076b0: 5f6e 616d 6528 290a 2020 2020 7374 6f72  _name().    stor
+000076c0: 6167 655f 6e61 6d65 203d 2066 2773 6b79  age_name = f'sky
+000076d0: 2d74 6573 742d 7b69 6e74 2874 696d 652e  -test-{int(time.
+000076e0: 7469 6d65 2829 297d 270a 2020 2020 7465  time())}'.    te
+000076f0: 6d70 6c61 7465 5f73 7472 203d 2070 6174  mplate_str = pat
+00007700: 686c 6962 2e50 6174 6828 0a20 2020 2020  hlib.Path(.     
+00007710: 2020 2027 7465 7374 732f 7465 7374 5f79     'tests/test_y
+00007720: 616d 6c73 2f74 6573 745f 7374 6f72 6167  amls/test_storag
+00007730: 655f 6d6f 756e 7469 6e67 2e79 616d 6c2e  e_mounting.yaml.
+00007740: 6a32 2729 2e72 6561 645f 7465 7874 2829  j2').read_text()
+00007750: 0a20 2020 2074 656d 706c 6174 6520 3d20  .    template = 
+00007760: 6a69 6e6a 6132 2e54 656d 706c 6174 6528  jinja2.Template(
+00007770: 7465 6d70 6c61 7465 5f73 7472 290a 2020  template_str).  
+00007780: 2020 636f 6e74 656e 7420 3d20 7465 6d70    content = temp
+00007790: 6c61 7465 2e72 656e 6465 7228 7374 6f72  late.render(stor
+000077a0: 6167 655f 6e61 6d65 3d73 746f 7261 6765  age_name=storage
+000077b0: 5f6e 616d 6529 0a20 2020 2077 6974 6820  _name).    with 
+000077c0: 7465 6d70 6669 6c65 2e4e 616d 6564 5465  tempfile.NamedTe
+000077d0: 6d70 6f72 6172 7946 696c 6528 7375 6666  mporaryFile(suff
+000077e0: 6978 3d27 2e79 616d 6c27 2c20 6d6f 6465  ix='.yaml', mode
+000077f0: 3d27 7727 2920 6173 2066 3a0a 2020 2020  ='w') as f:.    
+00007800: 2020 2020 662e 7772 6974 6528 636f 6e74      f.write(cont
+00007810: 656e 7429 0a20 2020 2020 2020 2066 2e66  ent).        f.f
+00007820: 6c75 7368 2829 0a20 2020 2020 2020 2066  lush().        f
+00007830: 696c 655f 7061 7468 203d 2066 2e6e 616d  ile_path = f.nam
+00007840: 650a 2020 2020 2020 2020 7465 7374 5f63  e.        test_c
+00007850: 6f6d 6d61 6e64 7320 3d20 5b0a 2020 2020  ommands = [.    
+00007860: 2020 2020 2020 2020 2a73 746f 7261 6765          *storage
+00007870: 5f73 6574 7570 5f63 6f6d 6d61 6e64 732c  _setup_commands,
+00007880: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00007890: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+000078a0: 7b6e 616d 657d 202d 2d63 6c6f 7564 2061  {name} --cloud a
+000078b0: 7773 207b 6669 6c65 5f70 6174 687d 272c  ws {file_path}',
+000078c0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000078d0: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
+000078e0: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
+000078f0: 6e73 7572 6520 6a6f 6220 7375 6363 6565  nsure job succee
+00007900: 6465 642e 0a20 2020 2020 2020 2020 2020  ded..           
+00007910: 2066 2761 7773 2073 3320 6c73 207b 7374   f'aws s3 ls {st
+00007920: 6f72 6167 655f 6e61 6d65 7d2f 6865 6c6c  orage_name}/hell
+00007930: 6f2e 7478 7427 2c0a 2020 2020 2020 2020  o.txt',.        
+00007940: 5d0a 2020 2020 2020 2020 7465 7374 203d  ].        test =
+00007950: 2054 6573 7428 0a20 2020 2020 2020 2020   Test(.         
+00007960: 2020 2027 6177 735f 7374 6f72 6167 655f     'aws_storage_
+00007970: 6d6f 756e 7473 272c 0a20 2020 2020 2020  mounts',.       
+00007980: 2020 2020 2074 6573 745f 636f 6d6d 616e       test_comman
+00007990: 6473 2c0a 2020 2020 2020 2020 2020 2020  ds,.            
+000079a0: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
+000079b0: 616d 657d 3b20 736b 7920 7374 6f72 6167  ame}; sky storag
+000079c0: 6520 6465 6c65 7465 207b 7374 6f72 6167  e delete {storag
+000079d0: 655f 6e61 6d65 7d27 2c0a 2020 2020 2020  e_name}',.      
+000079e0: 2020 2020 2020 7469 6d65 6f75 743d 3230        timeout=20
+000079f0: 202a 2036 302c 2020 2320 3230 206d 696e   * 60,  # 20 min
+00007a00: 730a 2020 2020 2020 2020 290a 2020 2020  s.        ).    
+00007a10: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+00007a20: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
+00007a30: 2e6d 6172 6b2e 6763 700a 6465 6620 7465  .mark.gcp.def te
+00007a40: 7374 5f67 6370 5f73 746f 7261 6765 5f6d  st_gcp_storage_m
+00007a50: 6f75 6e74 7328 293a 0a20 2020 206e 616d  ounts():.    nam
+00007a60: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+00007a70: 5f6e 616d 6528 290a 2020 2020 7374 6f72  _name().    stor
+00007a80: 6167 655f 6e61 6d65 203d 2066 2773 6b79  age_name = f'sky
+00007a90: 2d74 6573 742d 7b69 6e74 2874 696d 652e  -test-{int(time.
+00007aa0: 7469 6d65 2829 297d 270a 2020 2020 7465  time())}'.    te
+00007ab0: 6d70 6c61 7465 5f73 7472 203d 2070 6174  mplate_str = pat
+00007ac0: 686c 6962 2e50 6174 6828 0a20 2020 2020  hlib.Path(.     
+00007ad0: 2020 2027 7465 7374 732f 7465 7374 5f79     'tests/test_y
+00007ae0: 616d 6c73 2f74 6573 745f 7374 6f72 6167  amls/test_storag
+00007af0: 655f 6d6f 756e 7469 6e67 2e79 616d 6c2e  e_mounting.yaml.
+00007b00: 6a32 2729 2e72 6561 645f 7465 7874 2829  j2').read_text()
+00007b10: 0a20 2020 2074 656d 706c 6174 6520 3d20  .    template = 
+00007b20: 6a69 6e6a 6132 2e54 656d 706c 6174 6528  jinja2.Template(
+00007b30: 7465 6d70 6c61 7465 5f73 7472 290a 2020  template_str).  
+00007b40: 2020 636f 6e74 656e 7420 3d20 7465 6d70    content = temp
+00007b50: 6c61 7465 2e72 656e 6465 7228 7374 6f72  late.render(stor
+00007b60: 6167 655f 6e61 6d65 3d73 746f 7261 6765  age_name=storage
+00007b70: 5f6e 616d 6529 0a20 2020 2077 6974 6820  _name).    with 
+00007b80: 7465 6d70 6669 6c65 2e4e 616d 6564 5465  tempfile.NamedTe
+00007b90: 6d70 6f72 6172 7946 696c 6528 7375 6666  mporaryFile(suff
+00007ba0: 6978 3d27 2e79 616d 6c27 2c20 6d6f 6465  ix='.yaml', mode
+00007bb0: 3d27 7727 2920 6173 2066 3a0a 2020 2020  ='w') as f:.    
+00007bc0: 2020 2020 662e 7772 6974 6528 636f 6e74      f.write(cont
+00007bd0: 656e 7429 0a20 2020 2020 2020 2066 2e66  ent).        f.f
+00007be0: 6c75 7368 2829 0a20 2020 2020 2020 2066  lush().        f
+00007bf0: 696c 655f 7061 7468 203d 2066 2e6e 616d  ile_path = f.nam
+00007c00: 650a 2020 2020 2020 2020 7465 7374 5f63  e.        test_c
+00007c10: 6f6d 6d61 6e64 7320 3d20 5b0a 2020 2020  ommands = [.    
+00007c20: 2020 2020 2020 2020 2a73 746f 7261 6765          *storage
+00007c30: 5f73 6574 7570 5f63 6f6d 6d61 6e64 732c  _setup_commands,
+00007c40: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00007c50: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+00007c60: 7b6e 616d 657d 202d 2d63 6c6f 7564 2067  {name} --cloud g
+00007c70: 6370 207b 6669 6c65 5f70 6174 687d 272c  cp {file_path}',
+00007c80: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00007c90: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
+00007ca0: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
+00007cb0: 6e73 7572 6520 6a6f 6220 7375 6363 6565  nsure job succee
+00007cc0: 6465 642e 0a20 2020 2020 2020 2020 2020  ded..           
+00007cd0: 2066 2767 7375 7469 6c20 6c73 2067 733a   f'gsutil ls gs:
+00007ce0: 2f2f 7b73 746f 7261 6765 5f6e 616d 657d  //{storage_name}
+00007cf0: 2f68 656c 6c6f 2e74 7874 272c 0a20 2020  /hello.txt',.   
+00007d00: 2020 2020 205d 0a20 2020 2020 2020 2074       ].        t
+00007d10: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+00007d20: 2020 2020 2020 2020 2767 6370 5f73 746f          'gcp_sto
+00007d30: 7261 6765 5f6d 6f75 6e74 7327 2c0a 2020  rage_mounts',.  
+00007d40: 2020 2020 2020 2020 2020 7465 7374 5f63            test_c
+00007d50: 6f6d 6d61 6e64 732c 0a20 2020 2020 2020  ommands,.       
+00007d60: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
+00007d70: 2d79 207b 6e61 6d65 7d3b 2073 6b79 2073  -y {name}; sky s
+00007d80: 746f 7261 6765 2064 656c 6574 6520 7b73  torage delete {s
+00007d90: 746f 7261 6765 5f6e 616d 657d 272c 0a20  torage_name}',. 
+00007da0: 2020 2020 2020 2020 2020 2074 696d 656f             timeo
+00007db0: 7574 3d32 3020 2a20 3630 2c20 2023 2032  ut=20 * 60,  # 2
+00007dc0: 3020 6d69 6e73 0a20 2020 2020 2020 2029  0 mins.        )
+00007dd0: 0a20 2020 2020 2020 2072 756e 5f6f 6e65  .        run_one
+00007de0: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
+00007df0: 7974 6573 742e 6d61 726b 2e6b 7562 6572  ytest.mark.kuber
+00007e00: 6e65 7465 730a 6465 6620 7465 7374 5f6b  netes.def test_k
+00007e10: 7562 6572 6e65 7465 735f 7374 6f72 6167  ubernetes_storag
+00007e20: 655f 6d6f 756e 7473 2829 3a0a 2020 2020  e_mounts():.    
+00007e30: 2320 5465 7374 7320 6275 636b 6574 206d  # Tests bucket m
+00007e40: 6f75 6e74 696e 6720 6f6e 206b 3873 2c20  ounting on k8s, 
+00007e50: 6173 7375 6d69 6e67 2053 3320 6973 2063  assuming S3 is c
+00007e60: 6f6e 6669 6775 7265 642e 0a20 2020 2023  onfigured..    #
+00007e70: 2054 6869 7320 7465 7374 2077 696c 6c20   This test will 
+00007e80: 6661 696c 2069 6620 7275 6e20 6f6e 206e  fail if run on n
+00007e90: 6f6e 2078 3836 5f36 3420 6172 6368 6974  on x86_64 archit
+00007ea0: 6563 7475 7265 2c20 7369 6e63 6520 676f  ecture, since go
+00007eb0: 6f66 7973 2069 730a 2020 2020 2320 6275  ofys is.    # bu
+00007ec0: 696c 7420 666f 7220 7838 365f 3634 206f  ilt for x86_64 o
+00007ed0: 6e6c 792e 0a20 2020 206e 616d 6520 3d20  nly..    name = 
+00007ee0: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+00007ef0: 6528 290a 2020 2020 7374 6f72 6167 655f  e().    storage_
+00007f00: 6e61 6d65 203d 2066 2773 6b79 2d74 6573  name = f'sky-tes
+00007f10: 742d 7b69 6e74 2874 696d 652e 7469 6d65  t-{int(time.time
+00007f20: 2829 297d 270a 2020 2020 7465 6d70 6c61  ())}'.    templa
+00007f30: 7465 5f73 7472 203d 2070 6174 686c 6962  te_str = pathlib
+00007f40: 2e50 6174 6828 0a20 2020 2020 2020 2027  .Path(.        '
+00007f50: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
+00007f60: 2f74 6573 745f 7374 6f72 6167 655f 6d6f  /test_storage_mo
+00007f70: 756e 7469 6e67 2e79 616d 6c2e 6a32 2729  unting.yaml.j2')
+00007f80: 2e72 6561 645f 7465 7874 2829 0a20 2020  .read_text().   
+00007f90: 2074 656d 706c 6174 6520 3d20 6a69 6e6a   template = jinj
+00007fa0: 6132 2e54 656d 706c 6174 6528 7465 6d70  a2.Template(temp
+00007fb0: 6c61 7465 5f73 7472 290a 2020 2020 636f  late_str).    co
+00007fc0: 6e74 656e 7420 3d20 7465 6d70 6c61 7465  ntent = template
+00007fd0: 2e72 656e 6465 7228 7374 6f72 6167 655f  .render(storage_
+00007fe0: 6e61 6d65 3d73 746f 7261 6765 5f6e 616d  name=storage_nam
+00007ff0: 6529 0a20 2020 2077 6974 6820 7465 6d70  e).    with temp
+00008000: 6669 6c65 2e4e 616d 6564 5465 6d70 6f72  file.NamedTempor
+00008010: 6172 7946 696c 6528 7375 6666 6978 3d27  aryFile(suffix='
+00008020: 2e79 616d 6c27 2c20 6d6f 6465 3d27 7727  .yaml', mode='w'
+00008030: 2920 6173 2066 3a0a 2020 2020 2020 2020  ) as f:.        
+00008040: 662e 7772 6974 6528 636f 6e74 656e 7429  f.write(content)
+00008050: 0a20 2020 2020 2020 2066 2e66 6c75 7368  .        f.flush
+00008060: 2829 0a20 2020 2020 2020 2066 696c 655f  ().        file_
+00008070: 7061 7468 203d 2066 2e6e 616d 650a 2020  path = f.name.  
+00008080: 2020 2020 2020 7465 7374 5f63 6f6d 6d61        test_comma
+00008090: 6e64 7320 3d20 5b0a 2020 2020 2020 2020  nds = [.        
+000080a0: 2020 2020 2a73 746f 7261 6765 5f73 6574      *storage_set
+000080b0: 7570 5f63 6f6d 6d61 6e64 732c 0a20 2020  up_commands,.   
+000080c0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+000080d0: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
+000080e0: 657d 202d 2d63 6c6f 7564 206b 7562 6572  e} --cloud kuber
+000080f0: 6e65 7465 7320 7b66 696c 655f 7061 7468  netes {file_path
+00008100: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
+00008110: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+00008120: 7d20 3120 2d2d 7374 6174 7573 272c 2020  } 1 --status',  
+00008130: 2320 456e 7375 7265 206a 6f62 2073 7563  # Ensure job suc
+00008140: 6365 6564 6564 2e0a 2020 2020 2020 2020  ceeded..        
+00008150: 2020 2020 6627 6177 7320 7333 206c 7320      f'aws s3 ls 
+00008160: 7b73 746f 7261 6765 5f6e 616d 657d 2f68  {storage_name}/h
+00008170: 656c 6c6f 2e74 7874 272c 0a20 2020 2020  ello.txt',.     
+00008180: 2020 205d 0a20 2020 2020 2020 2074 6573     ].        tes
+00008190: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+000081a0: 2020 2020 2020 276b 7562 6572 6e65 7465        'kubernete
+000081b0: 735f 7374 6f72 6167 655f 6d6f 756e 7473  s_storage_mounts
+000081c0: 272c 0a20 2020 2020 2020 2020 2020 2074  ',.            t
+000081d0: 6573 745f 636f 6d6d 616e 6473 2c0a 2020  est_commands,.  
+000081e0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000081f0: 646f 776e 202d 7920 7b6e 616d 657d 3b20  down -y {name}; 
+00008200: 736b 7920 7374 6f72 6167 6520 6465 6c65  sky storage dele
+00008210: 7465 207b 7374 6f72 6167 655f 6e61 6d65  te {storage_name
+00008220: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
+00008230: 7469 6d65 6f75 743d 3230 202a 2036 302c  timeout=20 * 60,
+00008240: 2020 2320 3230 206d 696e 730a 2020 2020    # 20 mins.    
+00008250: 2020 2020 290a 2020 2020 2020 2020 7275      ).        ru
+00008260: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+00008270: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
+00008280: 636c 6f75 6466 6c61 7265 0a64 6566 2074  cloudflare.def t
+00008290: 6573 745f 636c 6f75 6466 6c61 7265 5f73  est_cloudflare_s
+000082a0: 746f 7261 6765 5f6d 6f75 6e74 7328 6765  torage_mounts(ge
+000082b0: 6e65 7269 635f 636c 6f75 643a 2073 7472  neric_cloud: str
+000082c0: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
+000082d0: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
+000082e0: 290a 2020 2020 7374 6f72 6167 655f 6e61  ).    storage_na
+000082f0: 6d65 203d 2066 2773 6b79 2d74 6573 742d  me = f'sky-test-
+00008300: 7b69 6e74 2874 696d 652e 7469 6d65 2829  {int(time.time()
+00008310: 297d 270a 2020 2020 7465 6d70 6c61 7465  )}'.    template
+00008320: 5f73 7472 203d 2070 6174 686c 6962 2e50  _str = pathlib.P
+00008330: 6174 6828 0a20 2020 2020 2020 2027 7465  ath(.        'te
+00008340: 7374 732f 7465 7374 5f79 616d 6c73 2f74  sts/test_yamls/t
+00008350: 6573 745f 7232 5f73 746f 7261 6765 5f6d  est_r2_storage_m
+00008360: 6f75 6e74 696e 672e 7961 6d6c 2729 2e72  ounting.yaml').r
+00008370: 6561 645f 7465 7874 2829 0a20 2020 2074  ead_text().    t
+00008380: 656d 706c 6174 6520 3d20 6a69 6e6a 6132  emplate = jinja2
+00008390: 2e54 656d 706c 6174 6528 7465 6d70 6c61  .Template(templa
+000083a0: 7465 5f73 7472 290a 2020 2020 636f 6e74  te_str).    cont
+000083b0: 656e 7420 3d20 7465 6d70 6c61 7465 2e72  ent = template.r
+000083c0: 656e 6465 7228 7374 6f72 6167 655f 6e61  ender(storage_na
+000083d0: 6d65 3d73 746f 7261 6765 5f6e 616d 6529  me=storage_name)
+000083e0: 0a20 2020 2065 6e64 706f 696e 745f 7572  .    endpoint_ur
+000083f0: 6c20 3d20 636c 6f75 6466 6c61 7265 2e63  l = cloudflare.c
+00008400: 7265 6174 655f 656e 6470 6f69 6e74 2829  reate_endpoint()
+00008410: 0a20 2020 2077 6974 6820 7465 6d70 6669  .    with tempfi
+00008420: 6c65 2e4e 616d 6564 5465 6d70 6f72 6172  le.NamedTemporar
+00008430: 7946 696c 6528 7375 6666 6978 3d27 2e79  yFile(suffix='.y
+00008440: 616d 6c27 2c20 6d6f 6465 3d27 7727 2920  aml', mode='w') 
+00008450: 6173 2066 3a0a 2020 2020 2020 2020 662e  as f:.        f.
+00008460: 7772 6974 6528 636f 6e74 656e 7429 0a20  write(content). 
+00008470: 2020 2020 2020 2066 2e66 6c75 7368 2829         f.flush()
+00008480: 0a20 2020 2020 2020 2066 696c 655f 7061  .        file_pa
+00008490: 7468 203d 2066 2e6e 616d 650a 2020 2020  th = f.name.    
+000084a0: 2020 2020 7465 7374 5f63 6f6d 6d61 6e64      test_command
+000084b0: 7320 3d20 5b0a 2020 2020 2020 2020 2020  s = [.          
+000084c0: 2020 2a73 746f 7261 6765 5f73 6574 7570    *storage_setup
+000084d0: 5f63 6f6d 6d61 6e64 732c 0a20 2020 2020  _commands,.     
+000084e0: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
+000084f0: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
+00008500: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
+00008510: 635f 636c 6f75 647d 207b 6669 6c65 5f70  c_cloud} {file_p
+00008520: 6174 687d 272c 0a20 2020 2020 2020 2020  ath}',.         
+00008530: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+00008540: 616d 657d 2031 202d 2d73 7461 7475 7327  ame} 1 --status'
+00008550: 2c20 2023 2045 6e73 7572 6520 6a6f 6220  ,  # Ensure job 
+00008560: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
+00008570: 2020 2020 2020 2066 2741 5753 5f53 4841         f'AWS_SHA
+00008580: 5245 445f 4352 4544 454e 5449 414c 535f  RED_CREDENTIALS_
+00008590: 4649 4c45 3d7b 636c 6f75 6466 6c61 7265  FILE={cloudflare
+000085a0: 2e52 325f 4352 4544 454e 5449 414c 535f  .R2_CREDENTIALS_
+000085b0: 5041 5448 7d20 6177 7320 7333 206c 7320  PATH} aws s3 ls 
+000085c0: 7333 3a2f 2f7b 7374 6f72 6167 655f 6e61  s3://{storage_na
+000085d0: 6d65 7d2f 6865 6c6c 6f2e 7478 7420 2d2d  me}/hello.txt --
+000085e0: 656e 6470 6f69 6e74 207b 656e 6470 6f69  endpoint {endpoi
+000085f0: 6e74 5f75 726c 7d20 2d2d 7072 6f66 696c  nt_url} --profil
+00008600: 653d 7232 270a 2020 2020 2020 2020 5d0a  e=r2'.        ].
+00008610: 0a20 2020 2020 2020 2074 6573 7420 3d20  .        test = 
+00008620: 5465 7374 280a 2020 2020 2020 2020 2020  Test(.          
+00008630: 2020 2763 6c6f 7564 666c 6172 655f 7374    'cloudflare_st
+00008640: 6f72 6167 655f 6d6f 756e 7473 272c 0a20  orage_mounts',. 
+00008650: 2020 2020 2020 2020 2020 2074 6573 745f             test_
+00008660: 636f 6d6d 616e 6473 2c0a 2020 2020 2020  commands,.      
+00008670: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
+00008680: 202d 7920 7b6e 616d 657d 3b20 736b 7920   -y {name}; sky 
+00008690: 7374 6f72 6167 6520 6465 6c65 7465 207b  storage delete {
+000086a0: 7374 6f72 6167 655f 6e61 6d65 7d27 2c0a  storage_name}',.
+000086b0: 2020 2020 2020 2020 2020 2020 7469 6d65              time
+000086c0: 6f75 743d 3230 202a 2036 302c 2020 2320  out=20 * 60,  # 
+000086d0: 3230 206d 696e 730a 2020 2020 2020 2020  20 mins.        
+000086e0: 290a 2020 2020 2020 2020 7275 6e5f 6f6e  ).        run_on
+000086f0: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
+00008700: 7079 7465 7374 2e6d 6172 6b2e 6962 6d0a  pytest.mark.ibm.
+00008710: 6465 6620 7465 7374 5f69 626d 5f73 746f  def test_ibm_sto
+00008720: 7261 6765 5f6d 6f75 6e74 7328 293a 0a20  rage_mounts():. 
+00008730: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+00008740: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+00008750: 2020 7374 6f72 6167 655f 6e61 6d65 203d    storage_name =
+00008760: 2066 2773 6b79 2d74 6573 742d 7b69 6e74   f'sky-test-{int
+00008770: 2874 696d 652e 7469 6d65 2829 297d 270a  (time.time())}'.
+00008780: 2020 2020 6275 636b 6574 5f72 636c 6f6e      bucket_rclon
+00008790: 655f 7072 6f66 696c 6520 3d20 5263 6c6f  e_profile = Rclo
+000087a0: 6e65 2e67 656e 6572 6174 655f 7263 6c6f  ne.generate_rclo
+000087b0: 6e65 5f62 7563 6b65 745f 7072 6f66 696c  ne_bucket_profil
+000087c0: 655f 6e61 6d65 280a 2020 2020 2020 2020  e_name(.        
+000087d0: 7374 6f72 6167 655f 6e61 6d65 2c20 5263  storage_name, Rc
+000087e0: 6c6f 6e65 2e52 636c 6f6e 6543 6c6f 7564  lone.RcloneCloud
+000087f0: 732e 4942 4d29 0a20 2020 2074 656d 706c  s.IBM).    templ
+00008800: 6174 655f 7374 7220 3d20 7061 7468 6c69  ate_str = pathli
+00008810: 622e 5061 7468 280a 2020 2020 2020 2020  b.Path(.        
+00008820: 2774 6573 7473 2f74 6573 745f 7961 6d6c  'tests/test_yaml
+00008830: 732f 7465 7374 5f69 626d 5f63 6f73 5f73  s/test_ibm_cos_s
+00008840: 746f 7261 6765 5f6d 6f75 6e74 696e 672e  torage_mounting.
+00008850: 7961 6d6c 2729 2e72 6561 645f 7465 7874  yaml').read_text
+00008860: 2829 0a20 2020 2074 656d 706c 6174 6520  ().    template 
+00008870: 3d20 6a69 6e6a 6132 2e54 656d 706c 6174  = jinja2.Templat
+00008880: 6528 7465 6d70 6c61 7465 5f73 7472 290a  e(template_str).
+00008890: 2020 2020 636f 6e74 656e 7420 3d20 7465      content = te
+000088a0: 6d70 6c61 7465 2e72 656e 6465 7228 7374  mplate.render(st
+000088b0: 6f72 6167 655f 6e61 6d65 3d73 746f 7261  orage_name=stora
+000088c0: 6765 5f6e 616d 6529 0a20 2020 2077 6974  ge_name).    wit
+000088d0: 6820 7465 6d70 6669 6c65 2e4e 616d 6564  h tempfile.Named
+000088e0: 5465 6d70 6f72 6172 7946 696c 6528 7375  TemporaryFile(su
+000088f0: 6666 6978 3d27 2e79 616d 6c27 2c20 6d6f  ffix='.yaml', mo
+00008900: 6465 3d27 7727 2920 6173 2066 3a0a 2020  de='w') as f:.  
+00008910: 2020 2020 2020 662e 7772 6974 6528 636f        f.write(co
+00008920: 6e74 656e 7429 0a20 2020 2020 2020 2066  ntent).        f
+00008930: 2e66 6c75 7368 2829 0a20 2020 2020 2020  .flush().       
+00008940: 2066 696c 655f 7061 7468 203d 2066 2e6e   file_path = f.n
+00008950: 616d 650a 2020 2020 2020 2020 7465 7374  ame.        test
+00008960: 5f63 6f6d 6d61 6e64 7320 3d20 5b0a 2020  _commands = [.  
+00008970: 2020 2020 2020 2020 2020 2a73 746f 7261            *stora
+00008980: 6765 5f73 6574 7570 5f63 6f6d 6d61 6e64  ge_setup_command
+00008990: 732c 0a20 2020 2020 2020 2020 2020 2066  s,.            f
+000089a0: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
+000089b0: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
+000089c0: 2069 626d 207b 6669 6c65 5f70 6174 687d   ibm {file_path}
+000089d0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000089e0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+000089f0: 2031 202d 2d73 7461 7475 7327 2c20 2023   1 --status',  #
+00008a00: 2045 6e73 7572 6520 6a6f 6220 7375 6363   Ensure job succ
+00008a10: 6565 6465 642e 0a20 2020 2020 2020 2020  eeded..         
+00008a20: 2020 2066 2772 636c 6f6e 6520 6c73 207b     f'rclone ls {
+00008a30: 6275 636b 6574 5f72 636c 6f6e 655f 7072  bucket_rclone_pr
+00008a40: 6f66 696c 657d 3a7b 7374 6f72 6167 655f  ofile}:{storage_
+00008a50: 6e61 6d65 7d2f 6865 6c6c 6f2e 7478 7427  name}/hello.txt'
+00008a60: 2c0a 2020 2020 2020 2020 5d0a 2020 2020  ,.        ].    
+00008a70: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+00008a80: 0a20 2020 2020 2020 2020 2020 2027 6962  .            'ib
+00008a90: 6d5f 7374 6f72 6167 655f 6d6f 756e 7473  m_storage_mounts
+00008aa0: 272c 0a20 2020 2020 2020 2020 2020 2074  ',.            t
+00008ab0: 6573 745f 636f 6d6d 616e 6473 2c0a 2020  est_commands,.  
+00008ac0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00008ad0: 646f 776e 202d 7920 7b6e 616d 657d 3b20  down -y {name}; 
+00008ae0: 736b 7920 7374 6f72 6167 6520 6465 6c65  sky storage dele
+00008af0: 7465 207b 7374 6f72 6167 655f 6e61 6d65  te {storage_name
+00008b00: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
+00008b10: 7469 6d65 6f75 743d 3230 202a 2036 302c  timeout=20 * 60,
+00008b20: 2020 2320 3230 206d 696e 730a 2020 2020    # 20 mins.    
+00008b30: 2020 2020 290a 2020 2020 2020 2020 7275      ).        ru
+00008b40: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+00008b50: 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20  ...# ---------- 
+00008b60: 434c 4920 6c6f 6773 202d 2d2d 2d2d 2d2d  CLI logs -------
+00008b70: 2d2d 2d0a 4070 7974 6573 742e 6d61 726b  ---.@pytest.mark
+00008b80: 2e6e 6f5f 7363 7020 2023 2053 4350 2064  .no_scp  # SCP d
+00008b90: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
+00008ba0: 6e75 6d5f 6e6f 6465 7320 3e20 3120 7965  num_nodes > 1 ye
+00008bb0: 742e 2052 756e 2074 6573 745f 7363 705f  t. Run test_scp_
+00008bc0: 6c6f 6773 2069 6e73 7465 6164 2e0a 6465  logs instead..de
+00008bd0: 6620 7465 7374 5f63 6c69 5f6c 6f67 7328  f test_cli_logs(
+00008be0: 6765 6e65 7269 635f 636c 6f75 643a 2073  generic_cloud: s
+00008bf0: 7472 293a 0a20 2020 206e 616d 6520 3d20  tr):.    name = 
+00008c00: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+00008c10: 6528 290a 2020 2020 6e75 6d5f 6e6f 6465  e().    num_node
+00008c20: 7320 3d20 320a 2020 2020 6966 2067 656e  s = 2.    if gen
+00008c30: 6572 6963 5f63 6c6f 7564 203d 3d20 276b  eric_cloud == 'k
+00008c40: 7562 6572 6e65 7465 7327 3a0a 2020 2020  ubernetes':.    
+00008c50: 2020 2020 2320 4b75 6265 726e 6574 6573      # Kubernetes
+00008c60: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
+00008c70: 7420 6d75 6c74 692d 6e6f 6465 0a20 2020  t multi-node.   
+00008c80: 2020 2020 206e 756d 5f6e 6f64 6573 203d       num_nodes =
+00008c90: 2031 0a20 2020 2074 696d 6573 7461 6d70   1.    timestamp
+00008ca0: 203d 2074 696d 652e 7469 6d65 2829 0a20   = time.time(). 
+00008cb0: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+00008cc0: 2020 2020 2020 2020 2763 6c69 5f6c 6f67          'cli_log
+00008cd0: 7327 2c0a 2020 2020 2020 2020 5b0a 2020  s',.        [.  
+00008ce0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00008cf0: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
+00008d00: 6d65 7d20 2d2d 636c 6f75 6420 7b67 656e  me} --cloud {gen
+00008d10: 6572 6963 5f63 6c6f 7564 7d20 2d2d 6e75  eric_cloud} --nu
+00008d20: 6d2d 6e6f 6465 7320 7b6e 756d 5f6e 6f64  m-nodes {num_nod
+00008d30: 6573 7d20 2265 6368 6f20 7b74 696d 6573  es} "echo {times
+00008d40: 7461 6d70 7d20 3122 272c 0a20 2020 2020  tamp} 1"',.     
+00008d50: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+00008d60: 6320 7b6e 616d 657d 2022 6563 686f 207b  c {name} "echo {
+00008d70: 7469 6d65 7374 616d 707d 2032 2227 2c0a  timestamp} 2"',.
+00008d80: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00008d90: 7920 6578 6563 207b 6e61 6d65 7d20 2265  y exec {name} "e
+00008da0: 6368 6f20 7b74 696d 6573 7461 6d70 7d20  cho {timestamp} 
+00008db0: 3322 272c 0a20 2020 2020 2020 2020 2020  3"',.           
+00008dc0: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
+00008dd0: 657d 2022 6563 686f 207b 7469 6d65 7374  e} "echo {timest
+00008de0: 616d 707d 2034 2227 2c0a 2020 2020 2020  amp} 4"',.      
+00008df0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+00008e00: 207b 6e61 6d65 7d20 3220 2d2d 7374 6174   {name} 2 --stat
+00008e10: 7573 272c 0a20 2020 2020 2020 2020 2020  us',.           
+00008e20: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+00008e30: 657d 2033 2034 202d 2d73 796e 632d 646f  e} 3 4 --sync-do
+00008e40: 776e 272c 0a20 2020 2020 2020 2020 2020  wn',.           
+00008e50: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+00008e60: 657d 202a 202d 2d73 796e 632d 646f 776e  e} * --sync-down
+00008e70: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00008e80: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+00008e90: 2031 207c 2067 7265 7020 227b 7469 6d65   1 | grep "{time
+00008ea0: 7374 616d 707d 2031 2227 2c0a 2020 2020  stamp} 1"',.    
+00008eb0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+00008ec0: 6773 207b 6e61 6d65 7d20 7c20 6772 6570  gs {name} | grep
+00008ed0: 2022 7b74 696d 6573 7461 6d70 7d20 3422   "{timestamp} 4"
+00008ee0: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
+00008ef0: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
+00008f00: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
+00008f10: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+00008f20: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
+00008f30: 6573 742e 6d61 726b 2e73 6370 0a64 6566  est.mark.scp.def
+00008f40: 2074 6573 745f 7363 705f 6c6f 6773 2829   test_scp_logs()
+00008f50: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
+00008f60: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+00008f70: 0a20 2020 2074 696d 6573 7461 6d70 203d  .    timestamp =
+00008f80: 2074 696d 652e 7469 6d65 2829 0a20 2020   time.time().   
+00008f90: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+00008fa0: 2020 2020 2020 2753 4350 5f63 6c69 5f6c        'SCP_cli_l
+00008fb0: 6f67 7327 2c0a 2020 2020 2020 2020 5b0a  ogs',.        [.
+00008fc0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00008fd0: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
+00008fe0: 6e61 6d65 7d20 7b53 4350 5f54 5950 457d  name} {SCP_TYPE}
+00008ff0: 2022 6563 686f 207b 7469 6d65 7374 616d   "echo {timestam
+00009000: 707d 2031 2227 2c0a 2020 2020 2020 2020  p} 1"',.        
+00009010: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
+00009020: 6e61 6d65 7d20 2265 6368 6f20 7b74 696d  name} "echo {tim
+00009030: 6573 7461 6d70 7d20 3222 272c 0a20 2020  estamp} 2"',.   
+00009040: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
+00009050: 7865 6320 7b6e 616d 657d 2022 6563 686f  xec {name} "echo
+00009060: 207b 7469 6d65 7374 616d 707d 2033 2227   {timestamp} 3"'
+00009070: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00009080: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
+00009090: 2265 6368 6f20 7b74 696d 6573 7461 6d70  "echo {timestamp
+000090a0: 7d20 3422 272c 0a20 2020 2020 2020 2020  } 4"',.         
+000090b0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+000090c0: 616d 657d 2032 202d 2d73 7461 7475 7327  ame} 2 --status'
+000090d0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+000090e0: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+000090f0: 3320 3420 2d2d 7379 6e63 2d64 6f77 6e27  3 4 --sync-down'
+00009100: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00009110: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+00009120: 2a20 2d2d 7379 6e63 2d64 6f77 6e27 2c0a  * --sync-down',.
+00009130: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00009140: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
+00009150: 7c20 6772 6570 2022 7b74 696d 6573 7461  | grep "{timesta
+00009160: 6d70 7d20 3122 272c 0a20 2020 2020 2020  mp} 1"',.       
+00009170: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+00009180: 7b6e 616d 657d 207c 2067 7265 7020 227b  {name} | grep "{
+00009190: 7469 6d65 7374 616d 707d 2034 2227 2c0a  timestamp} 4"',.
+000091a0: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+000091b0: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
+000091c0: 207b 6e61 6d65 7d27 2c0a 2020 2020 290a   {name}',.    ).
+000091d0: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+000091e0: 2874 6573 7429 0a0a 0a23 202d 2d2d 2d2d  (test)...# -----
+000091f0: 2d2d 2d2d 2d20 4a6f 6220 5175 6575 652e  ----- Job Queue.
+00009200: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974   ----------.@pyt
+00009210: 6573 742e 6d61 726b 2e6e 6f5f 6c61 6d62  est.mark.no_lamb
+00009220: 6461 5f63 6c6f 7564 2020 2320 4c61 6d62  da_cloud  # Lamb
+00009230: 6461 2043 6c6f 7564 2064 6f65 7320 6e6f  da Cloud does no
+00009240: 7420 6861 7665 204b 3830 2067 7075 730a  t have K80 gpus.
+00009250: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+00009260: 6962 6d20 2023 2049 424d 2043 6c6f 7564  ibm  # IBM Cloud
+00009270: 2064 6f65 7320 6e6f 7420 6861 7665 204b   does not have K
+00009280: 3830 2067 7075 732e 2072 756e 2074 6573  80 gpus. run tes
+00009290: 745f 6962 6d5f 6a6f 625f 7175 6575 6520  t_ibm_job_queue 
+000092a0: 696e 7374 6561 640a 4070 7974 6573 742e  instead.@pytest.
+000092b0: 6d61 726b 2e6e 6f5f 7363 7020 2023 2053  mark.no_scp  # S
+000092c0: 4350 2064 6f65 7320 6e6f 7420 6861 7665  CP does not have
+000092d0: 204b 3830 2067 7075 732e 2052 756e 2074   K80 gpus. Run t
+000092e0: 6573 745f 7363 705f 6a6f 625f 7175 6575  est_scp_job_queu
+000092f0: 6520 696e 7374 6561 640a 4070 7974 6573  e instead.@pytes
+00009300: 742e 6d61 726b 2e6e 6f5f 6f63 6920 2023  t.mark.no_oci  #
+00009310: 204f 4349 2064 6f65 7320 6e6f 7420 6861   OCI does not ha
+00009320: 7665 204b 3830 2067 7075 730a 4070 7974  ve K80 gpus.@pyt
+00009330: 6573 742e 6d61 726b 2e6e 6f5f 6b75 6265  est.mark.no_kube
+00009340: 726e 6574 6573 2020 2320 4b75 6265 726e  rnetes  # Kubern
+00009350: 6574 6573 206e 6f74 2068 6176 6520 6770  etes not have gp
+00009360: 7573 0a64 6566 2074 6573 745f 6a6f 625f  us.def test_job_
+00009370: 7175 6575 6528 6765 6e65 7269 635f 636c  queue(generic_cl
+00009380: 6f75 643a 2073 7472 293a 0a20 2020 206e  oud: str):.    n
+00009390: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
+000093a0: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
+000093b0: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+000093c0: 2020 2027 6a6f 625f 7175 6575 6527 2c0a     'job_queue',.
+000093d0: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
+000093e0: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
+000093f0: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
+00009400: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
+00009410: 5f63 6c6f 7564 7d20 6578 616d 706c 6573  _cloud} examples
+00009420: 2f6a 6f62 5f71 7565 7565 2f63 6c75 7374  /job_queue/clust
+00009430: 6572 2e79 616d 6c27 2c0a 2020 2020 2020  er.yaml',.      
+00009440: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
+00009450: 207b 6e61 6d65 7d20 2d6e 207b 6e61 6d65   {name} -n {name
+00009460: 7d2d 3120 2d64 2065 7861 6d70 6c65 732f  }-1 -d examples/
+00009470: 6a6f 625f 7175 6575 652f 6a6f 622e 7961  job_queue/job.ya
+00009480: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+00009490: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
+000094a0: 657d 202d 6e20 7b6e 616d 657d 2d32 202d  e} -n {name}-2 -
+000094b0: 6420 6578 616d 706c 6573 2f6a 6f62 5f71  d examples/job_q
+000094c0: 7565 7565 2f6a 6f62 2e79 616d 6c27 2c0a  ueue/job.yaml',.
+000094d0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+000094e0: 7920 6578 6563 207b 6e61 6d65 7d20 2d6e  y exec {name} -n
+000094f0: 207b 6e61 6d65 7d2d 3320 2d64 2065 7861   {name}-3 -d exa
+00009500: 6d70 6c65 732f 6a6f 625f 7175 6575 652f  mples/job_queue/
+00009510: 6a6f 622e 7961 6d6c 272c 0a20 2020 2020  job.yaml',.     
+00009520: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
+00009530: 2071 7565 7565 207b 6e61 6d65 7d29 3b20   queue {name}); 
+00009540: 6563 686f 2022 2473 223b 2065 6368 6f3b  echo "$s"; echo;
+00009550: 2065 6368 6f3b 2065 6368 6f20 2224 7322   echo; echo "$s"
+00009560: 207c 2067 7265 7020 7b6e 616d 657d 2d31   | grep {name}-1
+00009570: 207c 2067 7265 7020 5255 4e4e 494e 4727   | grep RUNNING'
+00009580: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00009590: 733d 2428 736b 7920 7175 6575 6520 7b6e  s=$(sky queue {n
+000095a0: 616d 657d 293b 2065 6368 6f20 2224 7322  ame}); echo "$s"
+000095b0: 3b20 6563 686f 3b20 6563 686f 3b20 6563  ; echo; echo; ec
+000095c0: 686f 2022 2473 2220 7c20 6772 6570 207b  ho "$s" | grep {
+000095d0: 6e61 6d65 7d2d 3220 7c20 6772 6570 2052  name}-2 | grep R
+000095e0: 554e 4e49 4e47 272c 0a20 2020 2020 2020  UNNING',.       
+000095f0: 2020 2020 2066 2773 3d24 2873 6b79 2071       f's=$(sky q
+00009600: 7565 7565 207b 6e61 6d65 7d29 3b20 6563  ueue {name}); ec
+00009610: 686f 2022 2473 223b 2065 6368 6f3b 2065  ho "$s"; echo; e
+00009620: 6368 6f3b 2065 6368 6f20 2224 7322 207c  cho; echo "$s" |
+00009630: 2067 7265 7020 7b6e 616d 657d 2d33 207c   grep {name}-3 |
+00009640: 2067 7265 7020 5045 4e44 494e 4727 2c0a   grep PENDING',.
+00009650: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00009660: 7920 6361 6e63 656c 202d 7920 7b6e 616d  y cancel -y {nam
+00009670: 657d 2032 272c 0a20 2020 2020 2020 2020  e} 2',.         
+00009680: 2020 2027 736c 6565 7020 3527 2c0a 2020     'sleep 5',.  
+00009690: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
+000096a0: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
+000096b0: 293b 2065 6368 6f20 2224 7322 3b20 6563  ); echo "$s"; ec
+000096c0: 686f 3b20 6563 686f 3b20 6563 686f 2022  ho; echo; echo "
+000096d0: 2473 2220 7c20 6772 6570 207b 6e61 6d65  $s" | grep {name
+000096e0: 7d2d 3320 7c20 6772 6570 2052 554e 4e49  }-3 | grep RUNNI
+000096f0: 4e47 272c 0a20 2020 2020 2020 2020 2020  NG',.           
+00009700: 2066 2773 6b79 2063 616e 6365 6c20 2d79   f'sky cancel -y
+00009710: 207b 6e61 6d65 7d20 3327 2c0a 2020 2020   {name} 3',.    
+00009720: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+00009730: 6563 207b 6e61 6d65 7d20 2d2d 6770 7573  ec {name} --gpus
+00009740: 204b 3830 3a30 2e32 2022 5b5b 205c 2453   K80:0.2 "[[ \$S
+00009750: 4b59 5049 4c4f 545f 4e55 4d5f 4750 5553  KYPILOT_NUM_GPUS
+00009760: 5f50 4552 5f4e 4f44 4520 2d65 7120 3120  _PER_NODE -eq 1 
+00009770: 5d5d 207c 7c20 6578 6974 2031 2227 2c0a  ]] || exit 1"',.
+00009780: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00009790: 7920 6578 6563 207b 6e61 6d65 7d20 2d2d  y exec {name} --
+000097a0: 6770 7573 204b 3830 3a31 2022 5b5b 205c  gpus K80:1 "[[ \
+000097b0: 2453 4b59 5049 4c4f 545f 4e55 4d5f 4750  $SKYPILOT_NUM_GP
+000097c0: 5553 5f50 4552 5f4e 4f44 4520 2d65 7120  US_PER_NODE -eq 
+000097d0: 3120 5d5d 207c 7c20 6578 6974 2031 2227  1 ]] || exit 1"'
+000097e0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+000097f0: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+00009800: 3420 2d2d 7374 6174 7573 272c 0a20 2020  4 --status',.   
+00009810: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00009820: 6f67 7320 7b6e 616d 657d 2035 202d 2d73  ogs {name} 5 --s
+00009830: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
+00009840: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
+00009850: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
+00009860: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
+00009870: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+00009880: 0a40 7079 7465 7374 2e6d 6172 6b2e 6c61  .@pytest.mark.la
+00009890: 6d62 6461 5f63 6c6f 7564 0a64 6566 2074  mbda_cloud.def t
+000098a0: 6573 745f 6c61 6d62 6461 5f6a 6f62 5f71  est_lambda_job_q
+000098b0: 7565 7565 2829 3a0a 2020 2020 6e61 6d65  ueue():.    name
+000098c0: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+000098d0: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
+000098e0: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+000098f0: 276c 616d 6264 615f 6a6f 625f 7175 6575  'lambda_job_queu
+00009900: 6527 2c0a 2020 2020 2020 2020 5b0a 2020  e',.        [.  
+00009910: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00009920: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
+00009930: 6d65 7d20 7b4c 414d 4244 415f 5459 5045  me} {LAMBDA_TYPE
+00009940: 7d20 6578 616d 706c 6573 2f6a 6f62 5f71  } examples/job_q
+00009950: 7565 7565 2f63 6c75 7374 6572 2e79 616d  ueue/cluster.yam
+00009960: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+00009970: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+00009980: 7d20 2d6e 207b 6e61 6d65 7d2d 3120 2d2d  } -n {name}-1 --
+00009990: 6770 7573 2041 3130 3a30 2e35 202d 6420  gpus A10:0.5 -d 
+000099a0: 6578 616d 706c 6573 2f6a 6f62 5f71 7565  examples/job_que
+000099b0: 7565 2f6a 6f62 2e79 616d 6c27 2c0a 2020  ue/job.yaml',.  
+000099c0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000099d0: 6578 6563 207b 6e61 6d65 7d20 2d6e 207b  exec {name} -n {
+000099e0: 6e61 6d65 7d2d 3220 2d2d 6770 7573 2041  name}-2 --gpus A
+000099f0: 3130 3a30 2e35 202d 6420 6578 616d 706c  10:0.5 -d exampl
 00009a00: 6573 2f6a 6f62 5f71 7565 7565 2f6a 6f62  es/job_queue/job
 00009a10: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
 00009a20: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
 00009a30: 6e61 6d65 7d20 2d6e 207b 6e61 6d65 7d2d  name} -n {name}-
-00009a40: 3220 7b53 4350 5f47 5055 5f56 3130 307d  2 {SCP_GPU_V100}
-00009a50: 3a7b 6e75 6d5f 6f66 5f67 7075 5f65 7865  :{num_of_gpu_exe
-00009a60: 637d 202d 6420 6578 616d 706c 6573 2f6a  c} -d examples/j
-00009a70: 6f62 5f71 7565 7565 2f6a 6f62 2e79 616d  ob_queue/job.yam
-00009a80: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-00009a90: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
-00009aa0: 7d20 2d6e 207b 6e61 6d65 7d2d 3320 7b53  } -n {name}-3 {S
-00009ab0: 4350 5f47 5055 5f56 3130 307d 3a7b 6e75  CP_GPU_V100}:{nu
-00009ac0: 6d5f 6f66 5f67 7075 5f65 7865 637d 202d  m_of_gpu_exec} -
-00009ad0: 6420 6578 616d 706c 6573 2f6a 6f62 5f71  d examples/job_q
-00009ae0: 7565 7565 2f6a 6f62 2e79 616d 6c27 2c0a  ueue/job.yaml',.
-00009af0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00009b00: 7920 7175 6575 6520 7b6e 616d 657d 207c  y queue {name} |
-00009b10: 2067 7265 7020 7b6e 616d 657d 2d31 207c   grep {name}-1 |
-00009b20: 2067 7265 7020 5255 4e4e 494e 4727 2c0a   grep RUNNING',.
-00009b30: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00009b40: 7920 7175 6575 6520 7b6e 616d 657d 207c  y queue {name} |
-00009b50: 2067 7265 7020 7b6e 616d 657d 2d32 207c   grep {name}-2 |
-00009b60: 2067 7265 7020 5255 4e4e 494e 4727 2c0a   grep RUNNING',.
+00009a40: 3320 2d2d 6770 7573 2041 3130 3a30 2e35  3 --gpus A10:0.5
+00009a50: 202d 6420 6578 616d 706c 6573 2f6a 6f62   -d examples/job
+00009a60: 5f71 7565 7565 2f6a 6f62 2e79 616d 6c27  _queue/job.yaml'
+00009a70: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00009a80: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
+00009a90: 207c 2067 7265 7020 7b6e 616d 657d 2d31   | grep {name}-1
+00009aa0: 207c 2067 7265 7020 5255 4e4e 494e 4727   | grep RUNNING'
+00009ab0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00009ac0: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
+00009ad0: 207c 2067 7265 7020 7b6e 616d 657d 2d32   | grep {name}-2
+00009ae0: 207c 2067 7265 7020 5255 4e4e 494e 4727   | grep RUNNING'
+00009af0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00009b00: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
+00009b10: 207c 2067 7265 7020 7b6e 616d 657d 2d33   | grep {name}-3
+00009b20: 207c 2067 7265 7020 5045 4e44 494e 4727   | grep PENDING'
+00009b30: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00009b40: 736b 7920 6361 6e63 656c 202d 7920 7b6e  sky cancel -y {n
+00009b50: 616d 657d 2032 272c 0a20 2020 2020 2020  ame} 2',.       
+00009b60: 2020 2020 2027 736c 6565 7020 3527 2c0a       'sleep 5',.
 00009b70: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
 00009b80: 7920 7175 6575 6520 7b6e 616d 657d 207c  y queue {name} |
 00009b90: 2067 7265 7020 7b6e 616d 657d 2d33 207c   grep {name}-3 |
-00009ba0: 2067 7265 7020 5045 4e44 494e 4727 2c0a   grep PENDING',.
+00009ba0: 2067 7265 7020 5255 4e4e 494e 4727 2c0a   grep RUNNING',.
 00009bb0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
 00009bc0: 7920 6361 6e63 656c 202d 7920 7b6e 616d  y cancel -y {nam
-00009bd0: 657d 2032 272c 0a20 2020 2020 2020 2020  e} 2',.         
-00009be0: 2020 2027 736c 6565 7020 3527 2c0a 2020     'sleep 5',.  
-00009bf0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00009c00: 7175 6575 6520 7b6e 616d 657d 207c 2067  queue {name} | g
-00009c10: 7265 7020 7b6e 616d 657d 2d33 207c 2067  rep {name}-3 | g
-00009c20: 7265 7020 5255 4e4e 494e 4727 2c0a 2020  rep RUNNING',.  
-00009c30: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00009c40: 6361 6e63 656c 202d 7920 7b6e 616d 657d  cancel -y {name}
-00009c50: 2033 272c 0a20 2020 2020 2020 205d 2c0a   3',.        ],.
-00009c60: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
-00009c70: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
-00009c80: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-00009c90: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
-00009ca0: 7974 6573 742e 6d61 726b 2e6e 6f5f 6c61  ytest.mark.no_la
-00009cb0: 6d62 6461 5f63 6c6f 7564 2020 2320 4c61  mbda_cloud  # La
-00009cc0: 6d62 6461 2043 6c6f 7564 2064 6f65 7320  mbda Cloud does 
-00009cd0: 6e6f 7420 6861 7665 2054 3420 6770 7573  not have T4 gpus
-00009ce0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-00009cf0: 5f69 626d 2020 2320 4942 4d20 436c 6f75  _ibm  # IBM Clou
-00009d00: 6420 646f 6573 206e 6f74 2068 6176 6520  d does not have 
-00009d10: 5434 2067 7075 732e 2072 756e 2074 6573  T4 gpus. run tes
-00009d20: 745f 6962 6d5f 6a6f 625f 7175 6575 655f  t_ibm_job_queue_
-00009d30: 6d75 6c74 696e 6f64 6520 696e 7374 6561  multinode instea
-00009d40: 640a 4070 7974 6573 742e 6d61 726b 2e6e  d.@pytest.mark.n
-00009d50: 6f5f 7363 7020 2023 2053 4350 2064 6f65  o_scp  # SCP doe
-00009d60: 7320 6e6f 7420 7375 7070 6f72 7420 6e75  s not support nu
-00009d70: 6d5f 6e6f 6465 7320 3e20 3120 7965 740a  m_nodes > 1 yet.
-00009d80: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-00009d90: 6f63 6920 2023 204f 4349 2043 6c6f 7564  oci  # OCI Cloud
-00009da0: 2064 6f65 7320 6e6f 7420 6861 7665 2054   does not have T
-00009db0: 3420 6770 7573 2e0a 6465 6620 7465 7374  4 gpus..def test
-00009dc0: 5f6a 6f62 5f71 7565 7565 5f6d 756c 7469  _job_queue_multi
-00009dd0: 6e6f 6465 2867 656e 6572 6963 5f63 6c6f  node(generic_clo
-00009de0: 7564 3a20 7374 7229 3a0a 2020 2020 6e61  ud: str):.    na
-00009df0: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-00009e00: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
-00009e10: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-00009e20: 2020 276a 6f62 5f71 7565 7565 5f6d 756c    'job_queue_mul
-00009e30: 7469 6e6f 6465 272c 0a20 2020 2020 2020  tinode',.       
-00009e40: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-00009e50: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
-00009e60: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
-00009e70: 207b 6765 6e65 7269 635f 636c 6f75 647d   {generic_cloud}
-00009e80: 2065 7861 6d70 6c65 732f 6a6f 625f 7175   examples/job_qu
-00009e90: 6575 652f 636c 7573 7465 725f 6d75 6c74  eue/cluster_mult
-00009ea0: 696e 6f64 652e 7961 6d6c 272c 0a20 2020  inode.yaml',.   
-00009eb0: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
-00009ec0: 7865 6320 7b6e 616d 657d 202d 6e20 7b6e  xec {name} -n {n
-00009ed0: 616d 657d 2d31 202d 6420 6578 616d 706c  ame}-1 -d exampl
-00009ee0: 6573 2f6a 6f62 5f71 7565 7565 2f6a 6f62  es/job_queue/job
-00009ef0: 5f6d 756c 7469 6e6f 6465 2e79 616d 6c27  _multinode.yaml'
-00009f00: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00009f10: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
-00009f20: 2d6e 207b 6e61 6d65 7d2d 3220 2d64 2065  -n {name}-2 -d e
-00009f30: 7861 6d70 6c65 732f 6a6f 625f 7175 6575  xamples/job_queu
-00009f40: 652f 6a6f 625f 6d75 6c74 696e 6f64 652e  e/job_multinode.
-00009f50: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-00009f60: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
-00009f70: 2d63 207b 6e61 6d65 7d20 2d6e 207b 6e61  -c {name} -n {na
-00009f80: 6d65 7d2d 3320 2d2d 6465 7461 6368 2d73  me}-3 --detach-s
-00009f90: 6574 7570 202d 6420 6578 616d 706c 6573  etup -d examples
-00009fa0: 2f6a 6f62 5f71 7565 7565 2f6a 6f62 5f6d  /job_queue/job_m
-00009fb0: 756c 7469 6e6f 6465 2e79 616d 6c27 2c0a  ultinode.yaml',.
-00009fc0: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
-00009fd0: 2428 736b 7920 7175 6575 6520 7b6e 616d  $(sky queue {nam
-00009fe0: 657d 2920 2626 2065 6368 6f20 2224 7322  e}) && echo "$s"
-00009ff0: 2026 2620 2865 6368 6f20 2224 7322 207c   && (echo "$s" |
-0000a000: 2067 7265 7020 7b6e 616d 657d 2d31 207c   grep {name}-1 |
-0000a010: 2067 7265 7020 5255 4e4e 494e 4729 272c   grep RUNNING)',
-0000a020: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000a030: 3d24 2873 6b79 2071 7565 7565 207b 6e61  =$(sky queue {na
-0000a040: 6d65 7d29 2026 2620 6563 686f 2022 2473  me}) && echo "$s
-0000a050: 2220 2626 2028 6563 686f 2022 2473 2220  " && (echo "$s" 
-0000a060: 7c20 6772 6570 207b 6e61 6d65 7d2d 3220  | grep {name}-2 
-0000a070: 7c20 6772 6570 2052 554e 4e49 4e47 2927  | grep RUNNING)'
-0000a080: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000a090: 733d 2428 736b 7920 7175 6575 6520 7b6e  s=$(sky queue {n
-0000a0a0: 616d 657d 2920 2626 2065 6368 6f20 2224  ame}) && echo "$
-0000a0b0: 7322 2026 2620 2865 6368 6f20 2224 7322  s" && (echo "$s"
-0000a0c0: 207c 2067 7265 7020 7b6e 616d 657d 2d33   | grep {name}-3
-0000a0d0: 207c 2067 7265 7020 5045 4e44 494e 4729   | grep PENDING)
-0000a0e0: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-0000a0f0: 736c 6565 7020 3930 272c 0a20 2020 2020  sleep 90',.     
-0000a100: 2020 2020 2020 2066 2773 6b79 2063 616e         f'sky can
-0000a110: 6365 6c20 2d79 207b 6e61 6d65 7d20 3127  cel -y {name} 1'
-0000a120: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
-0000a130: 6c65 6570 2035 272c 0a20 2020 2020 2020  leep 5',.       
-0000a140: 2020 2020 2066 2773 3d24 2873 6b79 2071       f's=$(sky q
-0000a150: 7565 7565 207b 6e61 6d65 7d29 3b20 6563  ueue {name}); ec
-0000a160: 686f 2022 2473 223b 2065 6368 6f3b 2065  ho "$s"; echo; e
-0000a170: 6368 6f3b 2065 6368 6f20 2224 7322 207c  cho; echo "$s" |
-0000a180: 2067 7265 7020 7b6e 616d 657d 2d33 207c   grep {name}-3 |
-0000a190: 2067 7265 7020 5345 5454 494e 475f 5550   grep SETTING_UP
-0000a1a0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0000a1b0: 2773 6b79 2063 616e 6365 6c20 2d79 207b  'sky cancel -y {
-0000a1c0: 6e61 6d65 7d20 3120 3220 3327 2c0a 2020  name} 1 2 3',.  
-0000a1d0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000a1e0: 6c61 756e 6368 202d 6320 7b6e 616d 657d  launch -c {name}
-0000a1f0: 202d 6e20 7b6e 616d 657d 2d34 202d 2d64   -n {name}-4 --d
-0000a200: 6574 6163 682d 7365 7475 7020 2d64 2065  etach-setup -d e
-0000a210: 7861 6d70 6c65 732f 6a6f 625f 7175 6575  xamples/job_queu
-0000a220: 652f 6a6f 625f 6d75 6c74 696e 6f64 652e  e/job_multinode.
-0000a230: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-0000a240: 2020 2023 2054 6573 7420 7468 6520 6a6f     # Test the jo
-0000a250: 6220 7374 6174 7573 2069 7320 636f 7272  b status is corr
-0000a260: 6563 746c 7920 7365 7420 746f 2053 4554  ectly set to SET
-0000a270: 5449 4e47 5f55 502c 2064 7572 696e 6720  TING_UP, during 
-0000a280: 7468 6520 7365 7475 7020 6973 2072 756e  the setup is run
-0000a290: 6e69 6e67 2c0a 2020 2020 2020 2020 2020  ning,.          
-0000a2a0: 2020 2320 616e 6420 7468 6520 6a6f 6220    # and the job 
-0000a2b0: 6361 6e20 6265 2063 616e 6365 6c6c 6564  can be cancelled
-0000a2c0: 2064 7572 696e 6720 7468 6520 7365 7475   during the setu
-0000a2d0: 702e 0a20 2020 2020 2020 2020 2020 2027  p..            '
-0000a2e0: 736c 6565 7020 3527 2c0a 2020 2020 2020  sleep 5',.      
-0000a2f0: 2020 2020 2020 6627 733d 2428 736b 7920        f's=$(sky 
-0000a300: 7175 6575 6520 7b6e 616d 657d 2920 2626  queue {name}) &&
-0000a310: 2065 6368 6f20 2224 7322 2026 2620 2865   echo "$s" && (e
-0000a320: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
-0000a330: 7b6e 616d 657d 2d34 207c 2067 7265 7020  {name}-4 | grep 
-0000a340: 5345 5454 494e 475f 5550 2927 2c0a 2020  SETTING_UP)',.  
-0000a350: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000a360: 6361 6e63 656c 202d 7920 7b6e 616d 657d  cancel -y {name}
-0000a370: 2034 272c 0a20 2020 2020 2020 2020 2020   4',.           
-0000a380: 2066 2773 3d24 2873 6b79 2071 7565 7565   f's=$(sky queue
-0000a390: 207b 6e61 6d65 7d29 2026 2620 6563 686f   {name}) && echo
-0000a3a0: 2022 2473 2220 2626 2028 6563 686f 2022   "$s" && (echo "
-0000a3b0: 2473 2220 7c20 6772 6570 207b 6e61 6d65  $s" | grep {name
-0000a3c0: 7d2d 3420 7c20 6772 6570 2043 414e 4345  }-4 | grep CANCE
-0000a3d0: 4c4c 4544 2927 2c0a 2020 2020 2020 2020  LLED)',.        
-0000a3e0: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
-0000a3f0: 6e61 6d65 7d20 2d2d 6770 7573 2054 343a  name} --gpus T4:
-0000a400: 302e 3220 225b 5b20 5c24 534b 5950 494c  0.2 "[[ \$SKYPIL
-0000a410: 4f54 5f4e 554d 5f47 5055 535f 5045 525f  OT_NUM_GPUS_PER_
-0000a420: 4e4f 4445 202d 6571 2031 205d 5d20 7c7c  NODE -eq 1 ]] ||
-0000a430: 2065 7869 7420 3122 272c 0a20 2020 2020   exit 1"',.     
-0000a440: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-0000a450: 6320 7b6e 616d 657d 202d 2d67 7075 7320  c {name} --gpus 
-0000a460: 5434 3a30 2e32 202d 2d6e 756d 2d6e 6f64  T4:0.2 --num-nod
-0000a470: 6573 2032 2022 5b5b 205c 2453 4b59 5049  es 2 "[[ \$SKYPI
-0000a480: 4c4f 545f 4e55 4d5f 4750 5553 5f50 4552  LOT_NUM_GPUS_PER
-0000a490: 5f4e 4f44 4520 2d65 7120 3120 5d5d 207c  _NODE -eq 1 ]] |
-0000a4a0: 7c20 6578 6974 2031 2227 2c0a 2020 2020  | exit 1"',.    
-0000a4b0: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-0000a4c0: 6563 207b 6e61 6d65 7d20 2d2d 6770 7573  ec {name} --gpus
-0000a4d0: 2054 343a 3120 2d2d 6e75 6d2d 6e6f 6465   T4:1 --num-node
-0000a4e0: 7320 3220 225b 5b20 5c24 534b 5950 494c  s 2 "[[ \$SKYPIL
-0000a4f0: 4f54 5f4e 554d 5f47 5055 535f 5045 525f  OT_NUM_GPUS_PER_
-0000a500: 4e4f 4445 202d 6571 2031 205d 5d20 7c7c  NODE -eq 1 ]] ||
-0000a510: 2065 7869 7420 3122 272c 0a20 2020 2020   exit 1"',.     
-0000a520: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-0000a530: 7320 7b6e 616d 657d 2035 202d 2d73 7461  s {name} 5 --sta
-0000a540: 7475 7327 2c0a 2020 2020 2020 2020 2020  tus',.          
-0000a550: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-0000a560: 6d65 7d20 3620 2d2d 7374 6174 7573 272c  me} 6 --status',
-0000a570: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000a580: 6b79 206c 6f67 7320 7b6e 616d 657d 2037  ky logs {name} 7
-0000a590: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
-0000a5a0: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
-0000a5b0: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
-0000a5c0: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
-0000a5d0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-0000a5e0: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
-0000a5f0: 6b2e 6e6f 5f6c 616d 6264 615f 636c 6f75  k.no_lambda_clou
-0000a600: 6420 2023 204e 6f20 4c61 6d62 6461 2043  d  # No Lambda C
-0000a610: 6c6f 7564 2056 4d20 6861 7320 3820 4350  loud VM has 8 CP
-0000a620: 5573 0a64 6566 2074 6573 745f 6c61 7267  Us.def test_larg
-0000a630: 655f 6a6f 625f 7175 6575 6528 6765 6e65  e_job_queue(gene
-0000a640: 7269 635f 636c 6f75 643a 2073 7472 293a  ric_cloud: str):
-0000a650: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-0000a660: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
-0000a670: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-0000a680: 0a20 2020 2020 2020 2027 6c61 7267 655f  .        'large_
-0000a690: 6a6f 625f 7175 6575 6527 2c0a 2020 2020  job_queue',.    
-0000a6a0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-0000a6b0: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-0000a6c0: 7920 2d63 207b 6e61 6d65 7d20 2d2d 636c  y -c {name} --cl
-0000a6d0: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
-0000a6e0: 7564 7d27 2c0a 2020 2020 2020 2020 2020  ud}',.          
-0000a6f0: 2020 6627 666f 7220 6920 696e 2060 7365    f'for i in `se
-0000a700: 7120 3120 3735 603b 2064 6f20 736b 7920  q 1 75`; do sky 
-0000a710: 6578 6563 207b 6e61 6d65 7d20 2d6e 207b  exec {name} -n {
-0000a720: 6e61 6d65 7d2d 2469 202d 6420 2265 6368  name}-$i -d "ech
-0000a730: 6f20 2469 3b20 736c 6565 7020 3130 3030  o $i; sleep 1000
-0000a740: 3030 3030 3022 3b20 646f 6e65 272c 0a20  00000"; done',. 
-0000a750: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000a760: 2063 616e 6365 6c20 2d79 207b 6e61 6d65   cancel -y {name
-0000a770: 7d20 3120 3220 3320 3420 3520 3620 3720  } 1 2 3 4 5 6 7 
-0000a780: 3820 3920 3130 2031 3120 3132 2031 3320  8 9 10 11 12 13 
-0000a790: 3134 2031 3520 3136 272c 0a20 2020 2020  14 15 16',.     
-0000a7a0: 2020 2020 2020 2027 736c 6565 7020 3735         'sleep 75
-0000a7b0: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
-0000a7c0: 2045 6163 6820 6a6f 6220 7461 6b65 7320   Each job takes 
-0000a7d0: 302e 3520 4350 5520 616e 6420 7468 6520  0.5 CPU and the 
-0000a7e0: 6465 6661 756c 7420 564d 2068 6173 2038  default VM has 8
-0000a7f0: 2043 5055 732c 2073 6f20 7468 6572 6520   CPUs, so there 
-0000a800: 7368 6f75 6c64 2062 6520 3820 2f20 302e  should be 8 / 0.
-0000a810: 3520 3d20 3136 206a 6f62 7320 7275 6e6e  5 = 16 jobs runn
-0000a820: 696e 672e 0a20 2020 2020 2020 2020 2020  ing..           
-0000a830: 2023 2054 6865 2066 6972 7374 2031 3620   # The first 16 
-0000a840: 6a6f 6273 2061 7265 2063 616e 6365 6c65  jobs are cancele
-0000a850: 642c 2073 6f20 7468 6572 6520 7368 6f75  d, so there shou
-0000a860: 6c64 2062 6520 3735 202d 2033 3220 3d20  ld be 75 - 32 = 
-0000a870: 3433 206a 6f62 7320 5045 4e44 494e 472e  43 jobs PENDING.
-0000a880: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000a890: 3d24 2873 6b79 2071 7565 7565 207b 6e61  =$(sky queue {na
-0000a8a0: 6d65 7d29 3b20 6563 686f 2022 2473 223b  me}); echo "$s";
-0000a8b0: 2065 6368 6f3b 2065 6368 6f3b 2065 6368   echo; echo; ech
-0000a8c0: 6f20 2224 7322 207c 2067 7265 7020 2d76  o "$s" | grep -v
-0000a8d0: 2067 7265 7020 7c20 6772 6570 2050 454e   grep | grep PEN
-0000a8e0: 4449 4e47 207c 2077 6320 2d6c 207c 2067  DING | wc -l | g
-0000a8f0: 7265 7020 3433 272c 0a20 2020 2020 2020  rep 43',.       
-0000a900: 2020 2020 2023 204d 616b 6520 7375 7265       # Make sure
-0000a910: 2074 6865 206a 6f62 7320 6172 6520 7363   the jobs are sc
-0000a920: 6865 6475 6c65 6420 696e 2046 4946 4f20  heduled in FIFO 
-0000a930: 6f72 6465 720a 2020 2020 2020 2020 2020  order.          
-0000a940: 2020 2a5b 0a20 2020 2020 2020 2020 2020    *[.           
-0000a950: 2020 2020 2066 2773 3d24 2873 6b79 2071       f's=$(sky q
-0000a960: 7565 7565 207b 6e61 6d65 7d29 3b20 6563  ueue {name}); ec
-0000a970: 686f 2022 2473 223b 2065 6368 6f3b 2065  ho "$s"; echo; e
-0000a980: 6368 6f3b 2065 6368 6f20 2224 7322 207c  cho; echo "$s" |
-0000a990: 2067 7265 7020 7b6e 616d 657d 2d7b 697d   grep {name}-{i}
-0000a9a0: 207c 2067 7265 7020 4341 4e43 454c 4c45   | grep CANCELLE
-0000a9b0: 4427 0a20 2020 2020 2020 2020 2020 2020  D'.             
-0000a9c0: 2020 2066 6f72 2069 2069 6e20 7261 6e67     for i in rang
-0000a9d0: 6528 312c 2031 3729 0a20 2020 2020 2020  e(1, 17).       
-0000a9e0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-0000a9f0: 2020 2020 2a5b 0a20 2020 2020 2020 2020      *[.         
-0000aa00: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
-0000aa10: 2071 7565 7565 207b 6e61 6d65 7d29 3b20   queue {name}); 
-0000aa20: 6563 686f 2022 2473 223b 2065 6368 6f3b  echo "$s"; echo;
-0000aa30: 2065 6368 6f3b 2065 6368 6f20 2224 7322   echo; echo "$s"
-0000aa40: 207c 2067 7265 7020 7b6e 616d 657d 2d7b   | grep {name}-{
-0000aa50: 697d 207c 2067 7265 7020 5255 4e4e 494e  i} | grep RUNNIN
-0000aa60: 4727 0a20 2020 2020 2020 2020 2020 2020  G'.             
-0000aa70: 2020 2066 6f72 2069 2069 6e20 7261 6e67     for i in rang
-0000aa80: 6528 3137 2c20 3333 290a 2020 2020 2020  e(17, 33).      
-0000aa90: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-0000aaa0: 2020 2020 202a 5b0a 2020 2020 2020 2020       *[.        
-0000aab0: 2020 2020 2020 2020 6627 733d 2428 736b          f's=$(sk
-0000aac0: 7920 7175 6575 6520 7b6e 616d 657d 293b  y queue {name});
-0000aad0: 2065 6368 6f20 2224 7322 3b20 6563 686f   echo "$s"; echo
-0000aae0: 3b20 6563 686f 3b20 6563 686f 2022 2473  ; echo; echo "$s
-0000aaf0: 2220 7c20 6772 6570 207b 6e61 6d65 7d2d  " | grep {name}-
-0000ab00: 7b69 7d20 7c20 6772 6570 2050 454e 4449  {i} | grep PENDI
-0000ab10: 4e47 270a 2020 2020 2020 2020 2020 2020  NG'.            
-0000ab20: 2020 2020 666f 7220 6920 696e 2072 616e      for i in ran
-0000ab30: 6765 2833 332c 2037 3529 0a20 2020 2020  ge(33, 75).     
-0000ab40: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-0000ab50: 2020 2020 2020 6627 736b 7920 6361 6e63        f'sky canc
-0000ab60: 656c 202d 7920 7b6e 616d 657d 2033 3320  el -y {name} 33 
-0000ab70: 3335 2033 3720 3339 2031 3720 3138 2031  35 37 39 17 18 1
-0000ab80: 3927 2c0a 2020 2020 2020 2020 2020 2020  9',.            
-0000ab90: 2a5b 0a20 2020 2020 2020 2020 2020 2020  *[.             
-0000aba0: 2020 2066 2773 3d24 2873 6b79 2071 7565     f's=$(sky que
-0000abb0: 7565 207b 6e61 6d65 7d29 3b20 6563 686f  ue {name}); echo
-0000abc0: 2022 2473 223b 2065 6368 6f3b 2065 6368   "$s"; echo; ech
-0000abd0: 6f3b 2065 6368 6f20 2224 7322 207c 2067  o; echo "$s" | g
-0000abe0: 7265 7020 7b6e 616d 657d 2d7b 697d 207c  rep {name}-{i} |
-0000abf0: 2067 7265 7020 4341 4e43 454c 4c45 4427   grep CANCELLED'
-0000ac00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ac10: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
-0000ac20: 3333 2c20 3430 2c20 3229 0a20 2020 2020  33, 40, 2).     
-0000ac30: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-0000ac40: 2020 2020 2020 2773 6c65 6570 2031 3027        'sleep 10'
-0000ac50: 2c0a 2020 2020 2020 2020 2020 2020 2a5b  ,.            *[
-0000ac60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ac70: 2066 2773 3d24 2873 6b79 2071 7565 7565   f's=$(sky queue
-0000ac80: 207b 6e61 6d65 7d29 3b20 6563 686f 2022   {name}); echo "
-0000ac90: 2473 223b 2065 6368 6f3b 2065 6368 6f3b  $s"; echo; echo;
-0000aca0: 2065 6368 6f20 2224 7322 207c 2067 7265   echo "$s" | gre
-0000acb0: 7020 7b6e 616d 657d 2d7b 697d 207c 2067  p {name}-{i} | g
-0000acc0: 7265 7020 5255 4e4e 494e 4727 0a20 2020  rep RUNNING'.   
-0000acd0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-0000ace0: 2069 2069 6e20 5b33 342c 2033 362c 2033   i in [34, 36, 3
-0000acf0: 385d 0a20 2020 2020 2020 2020 2020 205d  8].            ]
-0000ad00: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
-0000ad10: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
-0000ad20: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
-0000ad30: 2020 2020 7469 6d65 6f75 743d 3230 202a      timeout=20 *
-0000ad40: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
-0000ad50: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-0000ad60: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
-0000ad70: 2e6e 6f5f 6c61 6d62 6461 5f63 6c6f 7564  .no_lambda_cloud
-0000ad80: 2020 2320 4e6f 204c 616d 6264 6120 436c    # No Lambda Cl
-0000ad90: 6f75 6420 564d 2068 6173 2038 2043 5055  oud VM has 8 CPU
-0000ada0: 730a 6465 6620 7465 7374 5f66 6173 745f  s.def test_fast_
-0000adb0: 6c61 7267 655f 6a6f 625f 7175 6575 6528  large_job_queue(
-0000adc0: 6765 6e65 7269 635f 636c 6f75 643a 2073  generic_cloud: s
-0000add0: 7472 293a 0a20 2020 2023 2054 6869 7320  tr):.    # This 
-0000ade0: 6973 2074 6f20 7465 7374 2074 6865 206a  is to test the j
-0000adf0: 6f62 7320 6361 6e20 6265 2073 6368 6564  obs can be sched
-0000ae00: 756c 6564 2071 7569 636b 6c79 2077 6865  uled quickly whe
-0000ae10: 6e20 7468 6572 6520 6172 6520 6d61 6e79  n there are many
-0000ae20: 206a 6f62 7320 696e 2074 6865 2071 7565   jobs in the que
-0000ae30: 7565 2e0a 2020 2020 6e61 6d65 203d 205f  ue..    name = _
-0000ae40: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-0000ae50: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
-0000ae60: 7374 280a 2020 2020 2020 2020 2766 6173  st(.        'fas
-0000ae70: 745f 6c61 7267 655f 6a6f 625f 7175 6575  t_large_job_queu
-0000ae80: 6527 2c0a 2020 2020 2020 2020 5b0a 2020  e',.        [.  
-0000ae90: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000aea0: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
-0000aeb0: 6d65 7d20 2d2d 636c 6f75 6420 7b67 656e  me} --cloud {gen
-0000aec0: 6572 6963 5f63 6c6f 7564 7d27 2c0a 2020  eric_cloud}',.  
-0000aed0: 2020 2020 2020 2020 2020 6627 666f 7220            f'for 
-0000aee0: 6920 696e 2060 7365 7120 3120 3332 603b  i in `seq 1 32`;
-0000aef0: 2064 6f20 736b 7920 6578 6563 207b 6e61   do sky exec {na
-0000af00: 6d65 7d20 2d6e 207b 6e61 6d65 7d2d 2469  me} -n {name}-$i
-0000af10: 202d 6420 2265 6368 6f20 2469 223b 2064   -d "echo $i"; d
-0000af20: 6f6e 6527 2c0a 2020 2020 2020 2020 2020  one',.          
-0000af30: 2020 2773 6c65 6570 2036 3027 2c0a 2020    'sleep 60',.  
-0000af40: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
-0000af50: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
-0000af60: 293b 2065 6368 6f20 2224 7322 3b20 6563  ); echo "$s"; ec
-0000af70: 686f 3b20 6563 686f 3b20 6563 686f 2022  ho; echo; echo "
-0000af80: 2473 2220 7c20 6772 6570 202d 7620 6772  $s" | grep -v gr
-0000af90: 6570 207c 2067 7265 7020 5355 4343 4545  ep | grep SUCCEE
-0000afa0: 4445 4420 7c20 7763 202d 6c20 7c20 6772  DED | wc -l | gr
-0000afb0: 6570 2033 3227 2c0a 2020 2020 2020 2020  ep 32',.        
-0000afc0: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
-0000afd0: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
-0000afe0: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
-0000aff0: 743d 3230 202a 2036 302c 0a20 2020 2029  t=20 * 60,.    )
-0000b000: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-0000b010: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
-0000b020: 742e 6d61 726b 2e69 626d 0a64 6566 2074  t.mark.ibm.def t
-0000b030: 6573 745f 6962 6d5f 6a6f 625f 7175 6575  est_ibm_job_queu
-0000b040: 655f 6d75 6c74 696e 6f64 6528 293a 0a20  e_multinode():. 
-0000b050: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-0000b060: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
-0000b070: 2020 7461 736b 5f66 696c 6520 3d20 2765    task_file = 'e
-0000b080: 7861 6d70 6c65 732f 6a6f 625f 7175 6575  xamples/job_queu
-0000b090: 652f 6a6f 625f 6d75 6c74 696e 6f64 655f  e/job_multinode_
-0000b0a0: 6962 6d2e 7961 6d6c 270a 2020 2020 7465  ibm.yaml'.    te
-0000b0b0: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-0000b0c0: 2020 2027 6962 6d5f 6a6f 625f 7175 6575     'ibm_job_queu
-0000b0d0: 655f 6d75 6c74 696e 6f64 6527 2c0a 2020  e_multinode',.  
-0000b0e0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-0000b0f0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
-0000b100: 202d 7920 2d63 207b 6e61 6d65 7d20 2d2d   -y -c {name} --
-0000b110: 636c 6f75 6420 6962 6d20 2d2d 6770 7573  cloud ibm --gpus
-0000b120: 2076 3130 3020 2d2d 6e75 6d2d 6e6f 6465   v100 --num-node
-0000b130: 7320 3227 2c0a 2020 2020 2020 2020 2020  s 2',.          
-0000b140: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-0000b150: 6d65 7d20 2d6e 207b 6e61 6d65 7d2d 3120  me} -n {name}-1 
-0000b160: 2d64 207b 7461 736b 5f66 696c 657d 272c  -d {task_file}',
-0000b170: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000b180: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
-0000b190: 6e20 7b6e 616d 657d 2d32 202d 6420 7b74  n {name}-2 -d {t
-0000b1a0: 6173 6b5f 6669 6c65 7d27 2c0a 2020 2020  ask_file}',.    
-0000b1b0: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
-0000b1c0: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
-0000b1d0: 7d20 2d6e 207b 6e61 6d65 7d2d 3320 2d2d  } -n {name}-3 --
-0000b1e0: 6465 7461 6368 2d73 6574 7570 202d 6420  detach-setup -d 
-0000b1f0: 7b74 6173 6b5f 6669 6c65 7d27 2c0a 2020  {task_file}',.  
-0000b200: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
-0000b210: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
-0000b220: 2920 2626 2070 7269 6e74 6620 2224 7322  ) && printf "$s"
-0000b230: 2026 2620 2865 6368 6f20 2224 7322 207c   && (echo "$s" |
-0000b240: 2067 7265 7020 7b6e 616d 657d 2d31 207c   grep {name}-1 |
-0000b250: 2067 7265 7020 5255 4e4e 494e 4729 272c   grep RUNNING)',
-0000b260: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000b270: 3d24 2873 6b79 2071 7565 7565 207b 6e61  =$(sky queue {na
-0000b280: 6d65 7d29 2026 2620 7072 696e 7466 2022  me}) && printf "
-0000b290: 2473 2220 2626 2028 6563 686f 2022 2473  $s" && (echo "$s
-0000b2a0: 2220 7c20 6772 6570 207b 6e61 6d65 7d2d  " | grep {name}-
-0000b2b0: 3220 7c20 6772 6570 2052 554e 4e49 4e47  2 | grep RUNNING
-0000b2c0: 2927 2c0a 2020 2020 2020 2020 2020 2020  )',.            
-0000b2d0: 6627 733d 2428 736b 7920 7175 6575 6520  f's=$(sky queue 
-0000b2e0: 7b6e 616d 657d 2920 2626 2070 7269 6e74  {name}) && print
-0000b2f0: 6620 2224 7322 2026 2620 2865 6368 6f20  f "$s" && (echo 
-0000b300: 2224 7322 207c 2067 7265 7020 7b6e 616d  "$s" | grep {nam
-0000b310: 657d 2d33 207c 2067 7265 7020 5345 5454  e}-3 | grep SETT
-0000b320: 494e 475f 5550 2927 2c0a 2020 2020 2020  ING_UP)',.      
-0000b330: 2020 2020 2020 2773 6c65 6570 2039 3027        'sleep 90'
-0000b340: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000b350: 733d 2428 736b 7920 7175 6575 6520 7b6e  s=$(sky queue {n
-0000b360: 616d 657d 2920 2626 2070 7269 6e74 6620  ame}) && printf 
-0000b370: 2224 7322 2026 2620 2865 6368 6f20 2224  "$s" && (echo "$
-0000b380: 7322 207c 2067 7265 7020 7b6e 616d 657d  s" | grep {name}
-0000b390: 2d33 207c 2067 7265 7020 5045 4e44 494e  -3 | grep PENDIN
-0000b3a0: 4729 272c 0a20 2020 2020 2020 2020 2020  G)',.           
-0000b3b0: 2066 2773 6b79 2063 616e 6365 6c20 2d79   f'sky cancel -y
-0000b3c0: 207b 6e61 6d65 7d20 3127 2c0a 2020 2020   {name} 1',.    
-0000b3d0: 2020 2020 2020 2020 2773 6c65 6570 2035          'sleep 5
-0000b3e0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0000b3f0: 2773 6b79 2071 7565 7565 207b 6e61 6d65  'sky queue {name
-0000b400: 7d20 7c20 6772 6570 207b 6e61 6d65 7d2d  } | grep {name}-
-0000b410: 3320 7c20 6772 6570 2052 554e 4e49 4e47  3 | grep RUNNING
-0000b420: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0000b430: 2773 6b79 2063 616e 6365 6c20 2d79 207b  'sky cancel -y {
-0000b440: 6e61 6d65 7d20 3120 3220 3327 2c0a 2020  name} 1 2 3',.  
-0000b450: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000b460: 6c61 756e 6368 202d 6320 7b6e 616d 657d  launch -c {name}
-0000b470: 202d 6e20 7b6e 616d 657d 2d34 202d 2d64   -n {name}-4 --d
-0000b480: 6574 6163 682d 7365 7475 7020 2d64 207b  etach-setup -d {
-0000b490: 7461 736b 5f66 696c 657d 272c 0a20 2020  task_file}',.   
-0000b4a0: 2020 2020 2020 2020 2023 2054 6573 7420           # Test 
-0000b4b0: 7468 6520 6a6f 6220 7374 6174 7573 2069  the job status i
-0000b4c0: 7320 636f 7272 6563 746c 7920 7365 7420  s correctly set 
-0000b4d0: 746f 2053 4554 5449 4e47 5f55 502c 2064  to SETTING_UP, d
-0000b4e0: 7572 696e 6720 7468 6520 7365 7475 7020  uring the setup 
-0000b4f0: 6973 2072 756e 6e69 6e67 2c0a 2020 2020  is running,.    
-0000b500: 2020 2020 2020 2020 2320 616e 6420 7468          # and th
-0000b510: 6520 6a6f 6220 6361 6e20 6265 2063 616e  e job can be can
-0000b520: 6365 6c6c 6564 2064 7572 696e 6720 7468  celled during th
-0000b530: 6520 7365 7475 702e 0a20 2020 2020 2020  e setup..       
-0000b540: 2020 2020 2066 2773 3d24 2873 6b79 2071       f's=$(sky q
-0000b550: 7565 7565 207b 6e61 6d65 7d29 2026 2620  ueue {name}) && 
-0000b560: 7072 696e 7466 2022 2473 2220 2626 2028  printf "$s" && (
-0000b570: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
-0000b580: 207b 6e61 6d65 7d2d 3420 7c20 6772 6570   {name}-4 | grep
-0000b590: 2053 4554 5449 4e47 5f55 5029 272c 0a20   SETTING_UP)',. 
-0000b5a0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000b5b0: 2063 616e 6365 6c20 2d79 207b 6e61 6d65   cancel -y {name
-0000b5c0: 7d20 3427 2c0a 2020 2020 2020 2020 2020  } 4',.          
-0000b5d0: 2020 6627 733d 2428 736b 7920 7175 6575    f's=$(sky queu
-0000b5e0: 6520 7b6e 616d 657d 2920 2626 2070 7269  e {name}) && pri
-0000b5f0: 6e74 6620 2224 7322 2026 2620 2865 6368  ntf "$s" && (ech
-0000b600: 6f20 2224 7322 207c 2067 7265 7020 7b6e  o "$s" | grep {n
-0000b610: 616d 657d 2d34 207c 2067 7265 7020 4341  ame}-4 | grep CA
-0000b620: 4e43 454c 4c45 4429 272c 0a20 2020 2020  NCELLED)',.     
-0000b630: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-0000b640: 6320 7b6e 616d 657d 202d 2d67 7075 7320  c {name} --gpus 
-0000b650: 7631 3030 3a30 2e32 2022 5b5b 205c 2453  v100:0.2 "[[ \$S
-0000b660: 4b59 5049 4c4f 545f 4e55 4d5f 4750 5553  KYPILOT_NUM_GPUS
-0000b670: 5f50 4552 5f4e 4f44 4520 2d65 7120 3120  _PER_NODE -eq 1 
-0000b680: 5d5d 207c 7c20 6578 6974 2031 2227 2c0a  ]] || exit 1"',.
-0000b690: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000b6a0: 7920 6578 6563 207b 6e61 6d65 7d20 2d2d  y exec {name} --
-0000b6b0: 6770 7573 2076 3130 303a 302e 3220 2d2d  gpus v100:0.2 --
-0000b6c0: 6e75 6d2d 6e6f 6465 7320 3220 225b 5b20  num-nodes 2 "[[ 
-0000b6d0: 5c24 534b 5950 494c 4f54 5f4e 554d 5f47  \$SKYPILOT_NUM_G
-0000b6e0: 5055 535f 5045 525f 4e4f 4445 202d 6571  PUS_PER_NODE -eq
-0000b6f0: 2031 205d 5d20 7c7c 2065 7869 7420 3122   1 ]] || exit 1"
-0000b700: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0000b710: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-0000b720: 202d 2d67 7075 7320 7631 3030 3a31 202d   --gpus v100:1 -
-0000b730: 2d6e 756d 2d6e 6f64 6573 2032 2022 5b5b  -num-nodes 2 "[[
-0000b740: 205c 2453 4b59 5049 4c4f 545f 4e55 4d5f   \$SKYPILOT_NUM_
-0000b750: 4750 5553 5f50 4552 5f4e 4f44 4520 2d65  GPUS_PER_NODE -e
-0000b760: 7120 3120 5d5d 207c 7c20 6578 6974 2031  q 1 ]] || exit 1
-0000b770: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-0000b780: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-0000b790: 7d20 3520 2d2d 7374 6174 7573 272c 0a20  } 5 --status',. 
-0000b7a0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000b7b0: 206c 6f67 7320 7b6e 616d 657d 2036 202d   logs {name} 6 -
-0000b7c0: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
-0000b7d0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-0000b7e0: 207b 6e61 6d65 7d20 3720 2d2d 7374 6174   {name} 7 --stat
-0000b7f0: 7573 272c 0a20 2020 2020 2020 205d 2c0a  us',.        ],.
-0000b800: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
-0000b810: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
-0000b820: 2020 2020 2020 2074 696d 656f 7574 3d32         timeout=2
-0000b830: 3020 2a20 3630 2c20 2023 2032 3020 6d69  0 * 60,  # 20 mi
-0000b840: 6e73 0a20 2020 2029 0a20 2020 2072 756e  ns.    ).    run
-0000b850: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
-0000b860: 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2053  ..# ---------- S
-0000b870: 7562 6d69 7474 696e 6720 6d75 6c74 6970  ubmitting multip
-0000b880: 6c65 2074 6173 6b73 2074 6f20 7468 6520  le tasks to the 
-0000b890: 7361 6d65 2063 6c75 7374 6572 2e20 2d2d  same cluster. --
-0000b8a0: 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465 7374  --------.@pytest
-0000b8b0: 2e6d 6172 6b2e 6e6f 5f6c 616d 6264 615f  .mark.no_lambda_
-0000b8c0: 636c 6f75 6420 2023 204c 616d 6264 6120  cloud  # Lambda 
-0000b8d0: 436c 6f75 6420 646f 6573 206e 6f74 2068  Cloud does not h
-0000b8e0: 6176 6520 4b38 3020 6770 7573 0a40 7079  ave K80 gpus.@py
-0000b8f0: 7465 7374 2e6d 6172 6b2e 6e6f 5f69 626d  test.mark.no_ibm
-0000b900: 2020 2320 4942 4d20 436c 6f75 6420 646f    # IBM Cloud do
-0000b910: 6573 206e 6f74 2068 6176 6520 4b38 3020  es not have K80 
-0000b920: 6770 7573 0a40 7079 7465 7374 2e6d 6172  gpus.@pytest.mar
-0000b930: 6b2e 6e6f 5f73 6370 2020 2320 5343 5020  k.no_scp  # SCP 
-0000b940: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
-0000b950: 206e 756d 5f6e 6f64 6573 203e 2031 2079   num_nodes > 1 y
-0000b960: 6574 0a40 7079 7465 7374 2e6d 6172 6b2e  et.@pytest.mark.
-0000b970: 6e6f 5f6f 6369 2020 2320 4f43 4920 436c  no_oci  # OCI Cl
-0000b980: 6f75 6420 646f 6573 206e 6f74 2068 6176  oud does not hav
-0000b990: 6520 4b38 3020 6770 7573 0a64 6566 2074  e K80 gpus.def t
-0000b9a0: 6573 745f 6d75 6c74 695f 6563 686f 2867  est_multi_echo(g
-0000b9b0: 656e 6572 6963 5f63 6c6f 7564 3a20 7374  eneric_cloud: st
-0000b9c0: 7229 3a0a 2020 2020 6e61 6d65 203d 205f  r):.    name = _
-0000b9d0: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-0000b9e0: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
-0000b9f0: 7374 280a 2020 2020 2020 2020 276d 756c  st(.        'mul
-0000ba00: 7469 5f65 6368 6f27 2c0a 2020 2020 2020  ti_echo',.      
-0000ba10: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-0000ba20: 6627 7079 7468 6f6e 2065 7861 6d70 6c65  f'python example
-0000ba30: 732f 6d75 6c74 695f 6563 686f 2e70 7920  s/multi_echo.py 
-0000ba40: 7b6e 616d 657d 207b 6765 6e65 7269 635f  {name} {generic_
-0000ba50: 636c 6f75 647d 272c 0a20 2020 2020 2020  cloud}',.       
-0000ba60: 2020 2020 2027 736c 6565 7020 3132 3027       'sleep 120'
-0000ba70: 2c0a 2020 2020 2020 2020 5d20 2b0a 2020  ,.        ] +.  
-0000ba80: 2020 2020 2020 2320 456e 7375 7265 206a        # Ensure j
-0000ba90: 6f62 7320 7375 6363 6565 6465 642e 0a20  obs succeeded.. 
-0000baa0: 2020 2020 2020 205b 6627 736b 7920 6c6f         [f'sky lo
-0000bab0: 6773 207b 6e61 6d65 7d20 7b69 202b 2031  gs {name} {i + 1
-0000bac0: 7d20 2d2d 7374 6174 7573 2720 666f 7220  } --status' for 
-0000bad0: 6920 696e 2072 616e 6765 2833 3229 5d20  i in range(32)] 
-0000bae0: 2b0a 2020 2020 2020 2020 2320 456e 7375  +.        # Ensu
-0000baf0: 7265 206d 6f6e 6974 6f72 2f61 7574 6f73  re monitor/autos
-0000bb00: 6361 6c65 7220 6469 646e 2774 2063 7261  caler didn't cra
-0000bb10: 7368 206f 6e20 7468 6520 2761 7373 6572  sh on the 'asser
-0000bb20: 7420 6e6f 740a 2020 2020 2020 2020 2320  t not.        # 
-0000bb30: 756e 6675 6c66 696c 6c65 6427 2065 7272  unfulfilled' err
-0000bb40: 6f72 2e20 2049 6620 7072 6f63 6573 7320  or.  If process 
-0000bb50: 6e6f 7420 666f 756e 642c 2067 7265 702d  not found, grep-
-0000bb60: 3e73 7368 2072 6574 7572 6e73 2031 2e0a  >ssh returns 1..
-0000bb70: 2020 2020 2020 2020 5b66 2773 7368 207b          [f'ssh {
-0000bb80: 6e61 6d65 7d20 5c27 7073 2061 7578 207c  name} \'ps aux |
-0000bb90: 2067 7265 7020 225b 2f5d 226d 6f6e 6974   grep "[/]"monit
-0000bba0: 6f72 2e70 795c 2727 5d2c 0a20 2020 2020  or.py\''],.     
-0000bbb0: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
-0000bbc0: 207b 6e61 6d65 7d27 2c0a 2020 2020 2020   {name}',.      
-0000bbd0: 2020 7469 6d65 6f75 743d 3230 202a 2036    timeout=20 * 6
-0000bbe0: 302c 0a20 2020 2029 0a20 2020 2072 756e  0,.    ).    run
-0000bbf0: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
-0000bc00: 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054  ..# ---------- T
-0000bc10: 6173 6b3a 2031 206e 6f64 6520 7472 6169  ask: 1 node trai
-0000bc20: 6e69 6e67 2e20 2d2d 2d2d 2d2d 2d2d 2d2d  ning. ----------
-0000bc30: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-0000bc40: 5f6c 616d 6264 615f 636c 6f75 6420 2023  _lambda_cloud  #
-0000bc50: 204c 616d 6264 6120 436c 6f75 6420 646f   Lambda Cloud do
-0000bc60: 6573 206e 6f74 2068 6176 6520 5631 3030  es not have V100
-0000bc70: 2067 7075 730a 4070 7974 6573 742e 6d61   gpus.@pytest.ma
-0000bc80: 726b 2e6e 6f5f 6962 6d20 2023 2049 424d  rk.no_ibm  # IBM
-0000bc90: 2063 6c6f 7564 2063 7572 7265 6e74 6c79   cloud currently
-0000bca0: 2064 6f65 736e 2774 2070 726f 7669 6465   doesn't provide
-0000bcb0: 2070 7562 6c69 6320 696d 6167 6520 7769   public image wi
-0000bcc0: 7468 2043 5544 410a 4070 7974 6573 742e  th CUDA.@pytest.
-0000bcd0: 6d61 726b 2e6e 6f5f 7363 7020 2023 2053  mark.no_scp  # S
-0000bce0: 4350 2064 6f65 7320 6e6f 7420 6861 7665  CP does not have
-0000bcf0: 2056 3130 3020 2831 3647 4229 2047 5055   V100 (16GB) GPU
-0000bd00: 732e 2052 756e 2074 6573 745f 7363 705f  s. Run test_scp_
-0000bd10: 6875 6767 696e 6766 6163 6520 696e 7374  huggingface inst
-0000bd20: 6561 642e 0a64 6566 2074 6573 745f 6875  ead..def test_hu
-0000bd30: 6767 696e 6766 6163 6528 6765 6e65 7269  ggingface(generi
-0000bd40: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
-0000bd50: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-0000bd60: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
-0000bd70: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-0000bd80: 2020 2020 2020 2027 6875 6767 696e 6766         'huggingf
-0000bd90: 6163 655f 676c 7565 5f69 6d64 625f 6170  ace_glue_imdb_ap
-0000bda0: 7027 2c0a 2020 2020 2020 2020 5b0a 2020  p',.        [.  
-0000bdb0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000bdc0: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
-0000bdd0: 6d65 7d20 2d2d 636c 6f75 6420 7b67 656e  me} --cloud {gen
-0000bde0: 6572 6963 5f63 6c6f 7564 7d20 6578 616d  eric_cloud} exam
-0000bdf0: 706c 6573 2f68 7567 6769 6e67 6661 6365  ples/huggingface
-0000be00: 5f67 6c75 655f 696d 6462 5f61 7070 2e79  _glue_imdb_app.y
-0000be10: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-0000be20: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-0000be30: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
-0000be40: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
-0000be50: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
-0000be60: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000be70: 6578 6563 207b 6e61 6d65 7d20 6578 616d  exec {name} exam
-0000be80: 706c 6573 2f68 7567 6769 6e67 6661 6365  ples/huggingface
-0000be90: 5f67 6c75 655f 696d 6462 5f61 7070 2e79  _glue_imdb_app.y
-0000bea0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-0000beb0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-0000bec0: 6d65 7d20 3220 2d2d 7374 6174 7573 272c  me} 2 --status',
-0000bed0: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
-0000bee0: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
-0000bef0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-0000bf00: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
-0000bf10: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
-0000bf20: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-0000bf30: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
-0000bf40: 6172 6b2e 6c61 6d62 6461 5f63 6c6f 7564  ark.lambda_cloud
-0000bf50: 0a64 6566 2074 6573 745f 6c61 6d62 6461  .def test_lambda
-0000bf60: 5f68 7567 6769 6e67 6661 6365 2867 656e  _huggingface(gen
-0000bf70: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
-0000bf80: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
-0000bf90: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
-0000bfa0: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
-0000bfb0: 280a 2020 2020 2020 2020 276c 616d 6264  (.        'lambd
-0000bfc0: 615f 6875 6767 696e 6766 6163 655f 676c  a_huggingface_gl
-0000bfd0: 7565 5f69 6d64 625f 6170 7027 2c0a 2020  ue_imdb_app',.  
-0000bfe0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-0000bff0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
-0000c000: 202d 7920 2d63 207b 6e61 6d65 7d20 7b4c   -y -c {name} {L
-0000c010: 414d 4244 415f 5459 5045 7d20 6578 616d  AMBDA_TYPE} exam
-0000c020: 706c 6573 2f68 7567 6769 6e67 6661 6365  ples/huggingface
-0000c030: 5f67 6c75 655f 696d 6462 5f61 7070 2e79  _glue_imdb_app.y
-0000c040: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-0000c050: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-0000c060: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
-0000c070: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
-0000c080: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
-0000c090: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000c0a0: 6578 6563 207b 6e61 6d65 7d20 7b4c 414d  exec {name} {LAM
-0000c0b0: 4244 415f 5459 5045 7d20 6578 616d 706c  BDA_TYPE} exampl
-0000c0c0: 6573 2f68 7567 6769 6e67 6661 6365 5f67  es/huggingface_g
-0000c0d0: 6c75 655f 696d 6462 5f61 7070 2e79 616d  lue_imdb_app.yam
-0000c0e0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-0000c0f0: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-0000c100: 7d20 3220 2d2d 7374 6174 7573 272c 2020  } 2 --status',  
-0000c110: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
-0000c120: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
-0000c130: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
-0000c140: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
-0000c150: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
-0000c160: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-0000c170: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
-0000c180: 6b2e 7363 700a 6465 6620 7465 7374 5f73  k.scp.def test_s
-0000c190: 6370 5f68 7567 6769 6e67 6661 6365 2867  cp_huggingface(g
-0000c1a0: 656e 6572 6963 5f63 6c6f 7564 3a20 7374  eneric_cloud: st
-0000c1b0: 7229 3a0a 2020 2020 6e61 6d65 203d 205f  r):.    name = _
-0000c1c0: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-0000c1d0: 2829 0a20 2020 206e 756d 5f6f 665f 6770  ().    num_of_gp
-0000c1e0: 755f 6c61 756e 6368 203d 2031 0a20 2020  u_launch = 1.   
-0000c1f0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-0000c200: 2020 2020 2020 2753 4350 5f68 7567 6769        'SCP_huggi
-0000c210: 6e67 6661 6365 5f67 6c75 655f 696d 6462  ngface_glue_imdb
-0000c220: 5f61 7070 272c 0a20 2020 2020 2020 205b  _app',.        [
-0000c230: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000c240: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
-0000c250: 7b6e 616d 657d 207b 5343 505f 5459 5045  {name} {SCP_TYPE
-0000c260: 7d20 7b53 4350 5f47 5055 5f56 3130 307d  } {SCP_GPU_V100}
-0000c270: 3a7b 6e75 6d5f 6f66 5f67 7075 5f6c 6175  :{num_of_gpu_lau
-0000c280: 6e63 687d 2065 7861 6d70 6c65 732f 6875  nch} examples/hu
-0000c290: 6767 696e 6766 6163 655f 676c 7565 5f69  ggingface_glue_i
-0000c2a0: 6d64 625f 6170 702e 7961 6d6c 272c 0a20  mdb_app.yaml',. 
-0000c2b0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000c2c0: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
-0000c2d0: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
-0000c2e0: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
-0000c2f0: 6565 6465 642e 0a20 2020 2020 2020 2020  eeded..         
-0000c300: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
-0000c310: 616d 657d 207b 5343 505f 5459 5045 7d20  ame} {SCP_TYPE} 
-0000c320: 7b53 4350 5f47 5055 5f56 3130 307d 3a7b  {SCP_GPU_V100}:{
-0000c330: 6e75 6d5f 6f66 5f67 7075 5f6c 6175 6e63  num_of_gpu_launc
-0000c340: 687d 2065 7861 6d70 6c65 732f 6875 6767  h} examples/hugg
-0000c350: 696e 6766 6163 655f 676c 7565 5f69 6d64  ingface_glue_imd
-0000c360: 625f 6170 702e 7961 6d6c 272c 0a20 2020  b_app.yaml',.   
-0000c370: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-0000c380: 6f67 7320 7b6e 616d 657d 2032 202d 2d73  ogs {name} 2 --s
-0000c390: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
-0000c3a0: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
-0000c3b0: 6465 642e 0a20 2020 2020 2020 205d 2c0a  ded..        ],.
-0000c3c0: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
-0000c3d0: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
-0000c3e0: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-0000c3f0: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
-0000c400: 2d2d 2d2d 2d2d 2d2d 2d2d 2054 5055 2e20  ---------- TPU. 
-0000c410: 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465  ----------.@pyte
-0000c420: 7374 2e6d 6172 6b2e 6763 700a 6465 6620  st.mark.gcp.def 
-0000c430: 7465 7374 5f74 7075 2829 3a0a 2020 2020  test_tpu():.    
-0000c440: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
-0000c450: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
-0000c460: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-0000c470: 2020 2020 2774 7075 5f61 7070 272c 0a20      'tpu_app',. 
-0000c480: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-0000c490: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-0000c4a0: 6820 2d79 202d 6320 7b6e 616d 657d 2065  h -y -c {name} e
-0000c4b0: 7861 6d70 6c65 732f 7470 752f 7470 755f  xamples/tpu/tpu_
-0000c4c0: 6170 702e 7961 6d6c 272c 0a20 2020 2020  app.yaml',.     
-0000c4d0: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-0000c4e0: 7320 7b6e 616d 657d 2031 272c 2020 2320  s {name} 1',  # 
-0000c4f0: 456e 7375 7265 2074 6865 206a 6f62 2066  Ensure the job f
-0000c500: 696e 6973 6865 642e 0a20 2020 2020 2020  inished..       
-0000c510: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-0000c520: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
-0000c530: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
-0000c540: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
-0000c550: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000c560: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
-0000c570: 7b6e 616d 657d 2065 7861 6d70 6c65 732f  {name} examples/
-0000c580: 7470 752f 7470 755f 6170 702e 7961 6d6c  tpu/tpu_app.yaml
-0000c590: 207c 2067 7265 7020 2254 5055 202e 2a20   | grep "TPU .* 
-0000c5a0: 616c 7265 6164 7920 6578 6973 7473 2227  already exists"'
-0000c5b0: 2c20 2023 2045 6e73 7572 6520 736b 7920  ,  # Ensure sky 
-0000c5c0: 6c61 756e 6368 2077 6f6e 2774 2063 7265  launch won't cre
-0000c5d0: 6174 6520 616e 6f74 6865 7220 5450 552e  ate another TPU.
-0000c5e0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-0000c5f0: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
-0000c600: 7920 7b6e 616d 657d 272c 0a20 2020 2020  y {name}',.     
-0000c610: 2020 2074 696d 656f 7574 3d33 3020 2a20     timeout=30 * 
-0000c620: 3630 2c20 2023 2063 616e 2074 616b 6520  60,  # can take 
-0000c630: 3e32 3020 6d69 6e73 0a20 2020 2029 0a20  >20 mins.    ). 
-0000c640: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-0000c650: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
-0000c660: 2d2d 2d2d 2054 5055 2056 4d2e 202d 2d2d  ---- TPU VM. ---
-0000c670: 2d2d 2d2d 2d2d 2d0a 4070 7974 6573 742e  -------.@pytest.
-0000c680: 6d61 726b 2e67 6370 0a64 6566 2074 6573  mark.gcp.def tes
-0000c690: 745f 7470 755f 766d 2829 3a0a 2020 2020  t_tpu_vm():.    
-0000c6a0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
-0000c6b0: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
-0000c6c0: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-0000c6d0: 2020 2020 2774 7075 5f76 6d5f 6170 7027      'tpu_vm_app'
-0000c6e0: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-0000c6f0: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
-0000c700: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
-0000c710: 7d20 6578 616d 706c 6573 2f74 7075 2f74  } examples/tpu/t
-0000c720: 7075 766d 5f6d 6e69 7374 2e79 616d 6c27  puvm_mnist.yaml'
-0000c730: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000c740: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-0000c750: 3127 2c20 2023 2045 6e73 7572 6520 7468  1',  # Ensure th
-0000c760: 6520 6a6f 6220 6669 6e69 7368 6564 2e0a  e job finished..
-0000c770: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000c780: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
-0000c790: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
-0000c7a0: 7375 7265 2074 6865 206a 6f62 2073 7563  sure the job suc
-0000c7b0: 6365 6564 6564 2e0a 2020 2020 2020 2020  ceeded..        
-0000c7c0: 2020 2020 6627 736b 7920 7374 6f70 202d      f'sky stop -
-0000c7d0: 7920 7b6e 616d 657d 272c 0a20 2020 2020  y {name}',.     
-0000c7e0: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
-0000c7f0: 2073 7461 7475 7320 7b6e 616d 657d 202d   status {name} -
-0000c800: 2d72 6566 7265 7368 293b 2065 6368 6f20  -refresh); echo 
-0000c810: 2224 7322 3b20 6563 686f 3b20 6563 686f  "$s"; echo; echo
-0000c820: 3b20 6563 686f 2022 2473 2220 207c 2067  ; echo "$s"  | g
-0000c830: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
-0000c840: 7020 5354 4f50 5045 4427 2c20 2023 2045  p STOPPED',  # E
-0000c850: 6e73 7572 6520 7468 6520 636c 7573 7465  nsure the cluste
-0000c860: 7220 6973 2053 544f 5050 4544 2e0a 2020  r is STOPPED..  
-0000c870: 2020 2020 2020 2020 2020 2320 5573 6520            # Use 
-0000c880: 7265 7472 793a 2067 7561 7264 2061 6761  retry: guard aga
-0000c890: 696e 7374 2074 7261 6e73 6965 6e74 2065  inst transient e
-0000c8a0: 7272 6f72 7320 6f62 7365 7276 6564 2066  rrors observed f
-0000c8b0: 6f72 0a20 2020 2020 2020 2020 2020 2023  or.            #
-0000c8c0: 206a 7573 742d 7374 6f70 7065 6420 5450   just-stopped TP
-0000c8d0: 5520 564d 7320 2823 3936 3229 2e0a 2020  U VMs (#962)..  
-0000c8e0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000c8f0: 7374 6172 7420 2d2d 7265 7472 792d 756e  start --retry-un
-0000c900: 7469 6c2d 7570 202d 7920 7b6e 616d 657d  til-up -y {name}
-0000c910: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0000c920: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-0000c930: 2065 7861 6d70 6c65 732f 7470 752f 7470   examples/tpu/tp
-0000c940: 7576 6d5f 6d6e 6973 742e 7961 6d6c 272c  uvm_mnist.yaml',
-0000c950: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000c960: 6b79 206c 6f67 7320 7b6e 616d 657d 2032  ky logs {name} 2
-0000c970: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
-0000c980: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
-0000c990: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
-0000c9a0: 2020 2020 2066 2773 6b79 2073 746f 7020       f'sky stop 
-0000c9b0: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
-0000c9c0: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
-0000c9d0: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
-0000c9e0: 6d65 7d27 2c0a 2020 2020 2020 2020 7469  me}',.        ti
-0000c9f0: 6d65 6f75 743d 3330 202a 2036 302c 2020  meout=30 * 60,  
-0000ca00: 2320 6361 6e20 7461 6b65 2033 3020 6d69  # can take 30 mi
-0000ca10: 6e73 0a20 2020 2029 0a20 2020 2072 756e  ns.    ).    run
-0000ca20: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
-0000ca30: 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054  ..# ---------- T
-0000ca40: 5055 2056 4d20 506f 642e 202d 2d2d 2d2d  PU VM Pod. -----
-0000ca50: 2d2d 2d2d 2d0a 4070 7974 6573 742e 6d61  -----.@pytest.ma
-0000ca60: 726b 2e67 6370 0a64 6566 2074 6573 745f  rk.gcp.def test_
-0000ca70: 7470 755f 766d 5f70 6f64 2829 3a0a 2020  tpu_vm_pod():.  
-0000ca80: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-0000ca90: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-0000caa0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-0000cab0: 2020 2020 2020 2774 7075 5f70 6f64 272c        'tpu_pod',
-0000cac0: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
-0000cad0: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-0000cae0: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
-0000caf0: 2065 7861 6d70 6c65 732f 7470 752f 7470   examples/tpu/tp
-0000cb00: 7576 6d5f 6d6e 6973 742e 7961 6d6c 202d  uvm_mnist.yaml -
-0000cb10: 2d67 7075 7320 7470 752d 7632 2d33 3220  -gpus tpu-v2-32 
-0000cb20: 2d2d 7573 652d 7370 6f74 202d 2d7a 6f6e  --use-spot --zon
-0000cb30: 6520 6575 726f 7065 2d77 6573 7434 2d61  e europe-west4-a
-0000cb40: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0000cb50: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-0000cb60: 2031 272c 2020 2320 456e 7375 7265 2074   1',  # Ensure t
-0000cb70: 6865 206a 6f62 2066 696e 6973 6865 642e  he job finished.
-0000cb80: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000cb90: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
-0000cba0: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
-0000cbb0: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
-0000cbc0: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
-0000cbd0: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
-0000cbe0: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
-0000cbf0: 272c 0a20 2020 2020 2020 2074 696d 656f  ',.        timeo
-0000cc00: 7574 3d33 3020 2a20 3630 2c20 2023 2063  ut=30 * 60,  # c
-0000cc10: 616e 2074 616b 6520 3330 206d 696e 730a  an take 30 mins.
-0000cc20: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-0000cc30: 655f 7465 7374 2874 6573 7429 0a0a 0a23  e_test(test)...#
-0000cc40: 202d 2d2d 2d2d 2d2d 2d2d 2d20 5369 6d70   ---------- Simp
-0000cc50: 6c65 2061 7070 732e 202d 2d2d 2d2d 2d2d  le apps. -------
-0000cc60: 2d2d 2d0a 4070 7974 6573 742e 6d61 726b  ---.@pytest.mark
-0000cc70: 2e6e 6f5f 7363 7020 2023 2053 4350 2064  .no_scp  # SCP d
-0000cc80: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
-0000cc90: 6e75 6d5f 6e6f 6465 7320 3e20 3120 7965  num_nodes > 1 ye
-0000cca0: 740a 6465 6620 7465 7374 5f6d 756c 7469  t.def test_multi
-0000ccb0: 5f68 6f73 746e 616d 6528 6765 6e65 7269  _hostname(generi
-0000ccc0: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
-0000ccd0: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-0000cce0: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
-0000ccf0: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-0000cd00: 2020 2020 2020 2027 6d75 6c74 695f 686f         'multi_ho
-0000cd10: 7374 6e61 6d65 272c 0a20 2020 2020 2020  stname',.       
-0000cd20: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-0000cd30: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
-0000cd40: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
-0000cd50: 207b 6765 6e65 7269 635f 636c 6f75 647d   {generic_cloud}
-0000cd60: 2065 7861 6d70 6c65 732f 6d75 6c74 695f   examples/multi_
-0000cd70: 686f 7374 6e61 6d65 2e79 616d 6c27 2c0a  hostname.yaml',.
-0000cd80: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000cd90: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
-0000cda0: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
-0000cdb0: 7375 7265 2074 6865 206a 6f62 2073 7563  sure the job suc
-0000cdc0: 6365 6564 6564 2e0a 2020 2020 2020 2020  ceeded..        
-0000cdd0: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-0000cde0: 6e61 6d65 7d20 3120 7c20 6772 6570 2022  name} 1 | grep "
-0000cdf0: 4d79 2068 6f73 746e 616d 653a 2220 7c20  My hostname:" | 
-0000ce00: 7763 202d 6c20 7c20 6772 6570 2032 272c  wc -l | grep 2',
-0000ce10: 2020 2320 456e 7375 7265 2074 6865 7265    # Ensure there
-0000ce20: 2061 7265 2032 2068 6f73 7473 2e0a 2020   are 2 hosts..  
-0000ce30: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000ce40: 6578 6563 207b 6e61 6d65 7d20 6578 616d  exec {name} exam
-0000ce50: 706c 6573 2f6d 756c 7469 5f68 6f73 746e  ples/multi_hostn
-0000ce60: 616d 652e 7961 6d6c 272c 0a20 2020 2020  ame.yaml',.     
-0000ce70: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-0000ce80: 7320 7b6e 616d 657d 2032 202d 2d73 7461  s {name} 2 --sta
-0000ce90: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
-0000cea0: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
-0000ceb0: 642e 0a20 2020 2020 2020 205d 2c0a 2020  d..        ],.  
-0000cec0: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
-0000ced0: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-0000cee0: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
-0000cef0: 6573 7428 7465 7374 290a 0a0a 2320 2d2d  est(test)...# --
-0000cf00: 2d2d 2d2d 2d2d 2d2d 2057 6562 2061 7070  -------- Web app
-0000cf10: 7320 7769 7468 2063 7573 746f 6d20 706f  s with custom po
-0000cf20: 7274 7320 6f6e 2047 4350 2e20 2d2d 2d2d  rts on GCP. ----
-0000cf30: 2d2d 2d2d 2d2d 0a40 7079 7465 7374 2e6d  ------.@pytest.m
-0000cf40: 6172 6b2e 6763 700a 6465 6620 7465 7374  ark.gcp.def test
-0000cf50: 5f67 6370 5f68 7474 705f 7365 7276 6572  _gcp_http_server
-0000cf60: 5f77 6974 685f 6375 7374 6f6d 5f70 6f72  _with_custom_por
-0000cf70: 7473 2829 3a0a 2020 2020 6e61 6d65 203d  ts():.    name =
-0000cf80: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-0000cf90: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
-0000cfa0: 5465 7374 280a 2020 2020 2020 2020 2767  Test(.        'g
-0000cfb0: 6370 5f68 7474 705f 7365 7276 6572 5f77  cp_http_server_w
-0000cfc0: 6974 685f 6375 7374 6f6d 5f70 6f72 7473  ith_custom_ports
-0000cfd0: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-0000cfe0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-0000cff0: 6175 6e63 6820 2d79 202d 6420 2d63 207b  aunch -y -d -c {
-0000d000: 6e61 6d65 7d20 2d2d 636c 6f75 6420 6763  name} --cloud gc
-0000d010: 7020 6578 616d 706c 6573 2f68 7474 705f  p examples/http_
-0000d020: 7365 7276 6572 5f77 6974 685f 6375 7374  server_with_cust
-0000d030: 6f6d 5f70 6f72 7473 2f74 6173 6b2e 7961  om_ports/task.ya
-0000d040: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-0000d050: 2027 736c 6565 7020 3130 272c 0a20 2020   'sleep 10',.   
-0000d060: 2020 2020 2020 2020 2027 6970 3d24 2867           'ip=$(g
-0000d070: 7265 7020 2d41 3120 2248 6f73 7420 2720  rep -A1 "Host ' 
-0000d080: 2b20 6e61 6d65 202b 0a20 2020 2020 2020  + name +.       
-0000d090: 2020 2020 2027 2220 7e2f 2e73 7368 2f63       '" ~/.ssh/c
-0000d0a0: 6f6e 6669 6720 7c20 6772 6570 2022 486f  onfig | grep "Ho
-0000d0b0: 7374 4e61 6d65 2220 7c20 6177 6b20 5c27  stName" | awk \'
-0000d0c0: 7b70 7269 6e74 2024 327d 5c27 293b 2063  {print $2}\'); c
-0000d0d0: 7572 6c20 2469 703a 3333 3832 3820 7c20  url $ip:33828 | 
-0000d0e0: 6772 6570 2022 3c68 313e 5468 6973 2069  grep "<h1>This i
-0000d0f0: 7320 6120 6465 6d6f 2048 544d 4c20 7061  s a demo HTML pa
-0000d100: 6765 2e3c 2f68 313e 2227 2c0a 2020 2020  ge.</h1>"',.    
-0000d110: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
-0000d120: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
-0000d130: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
-0000d140: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-0000d150: 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d  t)...# ---------
-0000d160: 2d20 5765 6220 6170 7073 2077 6974 6820  - Web apps with 
-0000d170: 6375 7374 6f6d 2070 6f72 7473 206f 6e20  custom ports on 
-0000d180: 4157 532e 202d 2d2d 2d2d 2d2d 2d2d 2d0a  AWS. ----------.
-0000d190: 4070 7974 6573 742e 6d61 726b 2e61 7773  @pytest.mark.aws
-0000d1a0: 0a64 6566 2074 6573 745f 6177 735f 6874  .def test_aws_ht
-0000d1b0: 7470 5f73 6572 7665 725f 7769 7468 5f63  tp_server_with_c
-0000d1c0: 7573 746f 6d5f 706f 7274 7328 293a 0a20  ustom_ports():. 
-0000d1d0: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-0000d1e0: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
-0000d1f0: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-0000d200: 2020 2020 2020 2027 6177 735f 6874 7470         'aws_http
-0000d210: 5f73 6572 7665 725f 7769 7468 5f63 7573  _server_with_cus
-0000d220: 746f 6d5f 706f 7274 7327 2c0a 2020 2020  tom_ports',.    
-0000d230: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-0000d240: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-0000d250: 7920 2d64 202d 6320 7b6e 616d 657d 202d  y -d -c {name} -
-0000d260: 2d63 6c6f 7564 2061 7773 2065 7861 6d70  -cloud aws examp
-0000d270: 6c65 732f 6874 7470 5f73 6572 7665 725f  les/http_server_
-0000d280: 7769 7468 5f63 7573 746f 6d5f 706f 7274  with_custom_port
-0000d290: 732f 7461 736b 2e79 616d 6c27 2c0a 2020  s/task.yaml',.  
-0000d2a0: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
-0000d2b0: 2031 3027 2c0a 2020 2020 2020 2020 2020   10',.          
-0000d2c0: 2020 2769 703d 2428 6772 6570 202d 4131    'ip=$(grep -A1
-0000d2d0: 2022 486f 7374 2027 202b 206e 616d 6520   "Host ' + name 
-0000d2e0: 2b0a 2020 2020 2020 2020 2020 2020 2722  +.            '"
-0000d2f0: 207e 2f2e 7373 682f 636f 6e66 6967 207c   ~/.ssh/config |
-0000d300: 2067 7265 7020 2248 6f73 744e 616d 6522   grep "HostName"
-0000d310: 207c 2061 776b 205c 277b 7072 696e 7420   | awk \'{print 
-0000d320: 2432 7d5c 2729 3b20 6375 726c 2024 6970  $2}\'); curl $ip
-0000d330: 3a33 3338 3238 207c 2067 7265 7020 223c  :33828 | grep "<
-0000d340: 6831 3e54 6869 7320 6973 2061 2064 656d  h1>This is a dem
-0000d350: 6f20 4854 4d4c 2070 6167 652e 3c2f 6831  o HTML page.</h1
-0000d360: 3e22 272c 0a20 2020 2020 2020 205d 2c0a  >"',.        ],.
-0000d370: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
-0000d380: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
-0000d390: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-0000d3a0: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
-0000d3b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6173 6b3a  ---------- Task:
-0000d3c0: 206e 3d32 206e 6f64 6573 2077 6974 6820   n=2 nodes with 
-0000d3d0: 7365 7475 7073 2e20 2d2d 2d2d 2d2d 2d2d  setups. --------
-0000d3e0: 2d2d 0a40 7079 7465 7374 2e6d 6172 6b2e  --.@pytest.mark.
-0000d3f0: 6e6f 5f6c 616d 6264 615f 636c 6f75 6420  no_lambda_cloud 
-0000d400: 2023 204c 616d 6264 6120 436c 6f75 6420   # Lambda Cloud 
-0000d410: 646f 6573 206e 6f74 2068 6176 6520 5631  does not have V1
-0000d420: 3030 2067 7075 730a 4070 7974 6573 742e  00 gpus.@pytest.
-0000d430: 6d61 726b 2e6e 6f5f 6962 6d20 2023 2049  mark.no_ibm  # I
-0000d440: 424d 2063 6c6f 7564 2063 7572 7265 6e74  BM cloud current
-0000d450: 6c79 2064 6f65 736e 2774 2070 726f 7669  ly doesn't provi
-0000d460: 6465 2070 7562 6c69 6320 696d 6167 6520  de public image 
-0000d470: 7769 7468 2043 5544 410a 4070 7974 6573  with CUDA.@pytes
-0000d480: 742e 6d61 726b 2e6e 6f5f 7363 7020 2023  t.mark.no_scp  #
-0000d490: 2053 4350 2064 6f65 7320 6e6f 7420 7375   SCP does not su
-0000d4a0: 7070 6f72 7420 6e75 6d5f 6e6f 6465 7320  pport num_nodes 
-0000d4b0: 3e20 3120 7965 740a 4070 7974 6573 742e  > 1 yet.@pytest.
-0000d4c0: 6d61 726b 2e73 6b69 7028 0a20 2020 2072  mark.skip(.    r
-0000d4d0: 6561 736f 6e3d 0a20 2020 2027 5468 6520  eason=.    'The 
-0000d4e0: 7265 736e 6574 5f64 6973 7472 6962 7574  resnet_distribut
-0000d4f0: 6564 5f74 665f 6170 7020 6973 2066 6c61  ed_tf_app is fla
-0000d500: 6b79 2c20 6475 6520 746f 2069 7420 6661  ky, due to it fa
-0000d510: 696c 696e 6720 746f 2064 6574 6563 7420  iling to detect 
-0000d520: 4750 5573 2e27 290a 6465 6620 7465 7374  GPUs.').def test
-0000d530: 5f64 6973 7472 6962 7574 6564 5f74 6628  _distributed_tf(
-0000d540: 6765 6e65 7269 635f 636c 6f75 643a 2073  generic_cloud: s
-0000d550: 7472 293a 0a20 2020 206e 616d 6520 3d20  tr):.    name = 
-0000d560: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-0000d570: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
-0000d580: 6573 7428 0a20 2020 2020 2020 2027 7265  est(.        're
-0000d590: 736e 6574 5f64 6973 7472 6962 7574 6564  snet_distributed
-0000d5a0: 5f74 665f 6170 7027 2c0a 2020 2020 2020  _tf_app',.      
-0000d5b0: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-0000d5c0: 2320 4e4f 5445 3a20 7275 6e6e 696e 6720  # NOTE: running 
-0000d5d0: 6974 2074 7769 6365 2077 696c 6c20 6861  it twice will ha
-0000d5e0: 6e67 2028 736f 6d65 7469 6d65 733f 2920  ng (sometimes?) 
-0000d5f0: 2d20 616e 2061 7070 2d6c 6576 656c 2062  - an app-level b
-0000d600: 7567 2e0a 2020 2020 2020 2020 2020 2020  ug..            
-0000d610: 6627 7079 7468 6f6e 2065 7861 6d70 6c65  f'python example
-0000d620: 732f 7265 736e 6574 5f64 6973 7472 6962  s/resnet_distrib
-0000d630: 7574 6564 5f74 665f 6170 702e 7079 207b  uted_tf_app.py {
-0000d640: 6e61 6d65 7d20 7b67 656e 6572 6963 5f63  name} {generic_c
-0000d650: 6c6f 7564 7d27 2c0a 2020 2020 2020 2020  loud}',.        
-0000d660: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-0000d670: 6e61 6d65 7d20 3120 2d2d 7374 6174 7573  name} 1 --status
-0000d680: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
-0000d690: 206a 6f62 2073 7563 6365 6564 6564 2e0a   job succeeded..
-0000d6a0: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-0000d6b0: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
-0000d6c0: 207b 6e61 6d65 7d27 2c0a 2020 2020 2020   {name}',.      
-0000d6d0: 2020 7469 6d65 6f75 743d 3235 202a 2036    timeout=25 * 6
-0000d6e0: 302c 2020 2320 3235 206d 696e 7320 2869  0,  # 25 mins (i
-0000d6f0: 7420 7461 6b65 7320 6172 6f75 6e64 207e  t takes around ~
-0000d700: 3139 206d 696e 7329 0a20 2020 2029 0a20  19 mins).    ). 
-0000d710: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-0000d720: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
-0000d730: 2d2d 2d2d 2054 6573 7469 6e67 2047 4350  ---- Testing GCP
-0000d740: 2073 7461 7274 2061 6e64 2073 746f 7020   start and stop 
-0000d750: 696e 7374 616e 6365 7320 2d2d 2d2d 2d2d  instances ------
-0000d760: 2d2d 2d2d 0a40 7079 7465 7374 2e6d 6172  ----.@pytest.mar
-0000d770: 6b2e 6763 700a 6465 6620 7465 7374 5f67  k.gcp.def test_g
-0000d780: 6370 5f73 7461 7274 5f73 746f 7028 293a  cp_start_stop():
-0000d790: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-0000d7a0: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
-0000d7b0: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-0000d7c0: 0a20 2020 2020 2020 2027 6763 702d 7374  .        'gcp-st
-0000d7d0: 6172 742d 7374 6f70 272c 0a20 2020 2020  art-stop',.     
-0000d7e0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-0000d7f0: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
-0000d800: 202d 6320 7b6e 616d 657d 2065 7861 6d70   -c {name} examp
-0000d810: 6c65 732f 6763 705f 7374 6172 745f 7374  les/gcp_start_st
-0000d820: 6f70 2e79 616d 6c27 2c0a 2020 2020 2020  op.yaml',.      
-0000d830: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-0000d840: 207b 6e61 6d65 7d20 3120 2d2d 7374 6174   {name} 1 --stat
-0000d850: 7573 272c 2020 2320 456e 7375 7265 2074  us',  # Ensure t
-0000d860: 6865 206a 6f62 2073 7563 6365 6564 6564  he job succeeded
-0000d870: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
-0000d880: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
-0000d890: 6578 616d 706c 6573 2f67 6370 5f73 7461  examples/gcp_sta
-0000d8a0: 7274 5f73 746f 702e 7961 6d6c 272c 0a20  rt_stop.yaml',. 
-0000d8b0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000d8c0: 206c 6f67 7320 7b6e 616d 657d 2032 202d   logs {name} 2 -
-0000d8d0: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
-0000d8e0: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
-0000d8f0: 6565 6465 642e 0a20 2020 2020 2020 2020  eeded..         
-0000d900: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
-0000d910: 616d 657d 2022 7072 6c69 6d69 7420 2d6e  ame} "prlimit -n
-0000d920: 202d 2d70 6964 3d5c 2428 7067 7265 7020   --pid=\$(pgrep 
-0000d930: 2d66 205c 2772 6179 6c65 742f 7261 796c  -f \'raylet/rayl
-0000d940: 6574 202d 2d72 6179 6c65 745f 736f 636b  et --raylet_sock
-0000d950: 6574 5f6e 616d 655c 2729 207c 2067 7265  et_name\') | gre
-0000d960: 7020 5c27 225c 2731 3034 3835 3736 2031  p \'"\'1048576 1
-0000d970: 3034 3835 3736 5c27 225c 2722 272c 2020  048576\'"\'"',  
-0000d980: 2320 456e 7375 7265 2074 6865 2072 6179  # Ensure the ray
-0000d990: 6c65 7420 7072 6f63 6573 7320 6861 7320  let process has 
-0000d9a0: 7468 6520 636f 7272 6563 7420 6669 6c65  the correct file
-0000d9b0: 2064 6573 6372 6970 746f 7220 6c69 6d69   descriptor limi
-0000d9c0: 742e 0a20 2020 2020 2020 2020 2020 2066  t..            f
-0000d9d0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-0000d9e0: 2033 202d 2d73 7461 7475 7327 2c20 2023   3 --status',  #
-0000d9f0: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
-0000da00: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
-0000da10: 2020 2020 2020 2066 2773 6b79 2073 746f         f'sky sto
-0000da20: 7020 2d79 207b 6e61 6d65 7d27 2c0a 2020  p -y {name}',.  
-0000da30: 2020 2020 2020 2020 2020 6627 736c 6565            f'slee
-0000da40: 7020 3230 272c 0a20 2020 2020 2020 2020  p 20',.         
-0000da50: 2020 2066 2773 6b79 2073 7461 7274 202d     f'sky start -
-0000da60: 7920 7b6e 616d 657d 202d 6920 3127 2c0a  y {name} -i 1',.
-0000da70: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000da80: 7920 6578 6563 207b 6e61 6d65 7d20 6578  y exec {name} ex
-0000da90: 616d 706c 6573 2f67 6370 5f73 7461 7274  amples/gcp_start
-0000daa0: 5f73 746f 702e 7961 6d6c 272c 0a20 2020  _stop.yaml',.   
-0000dab0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-0000dac0: 6f67 7320 7b6e 616d 657d 2034 202d 2d73  ogs {name} 4 --s
-0000dad0: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
-0000dae0: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
-0000daf0: 6465 642e 0a20 2020 2020 2020 2020 2020  ded..           
-0000db00: 2027 736c 6565 7020 3138 3027 2c0a 2020   'sleep 180',.  
-0000db10: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000db20: 7374 6174 7573 202d 7220 7b6e 616d 657d  status -r {name}
-0000db30: 207c 2067 7265 7020 2249 4e49 545c 7c53   | grep "INIT\|S
-0000db40: 544f 5050 4544 2227 2c0a 2020 2020 2020  TOPPED"',.      
-0000db50: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
-0000db60: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
-0000db70: 7d27 2c0a 2020 2020 290a 2020 2020 7275  }',.    ).    ru
-0000db80: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-0000db90: 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20  ...# ---------- 
-0000dba0: 5465 7374 696e 6720 417a 7572 6520 7374  Testing Azure st
-0000dbb0: 6172 7420 616e 6420 7374 6f70 2069 6e73  art and stop ins
-0000dbc0: 7461 6e63 6573 202d 2d2d 2d2d 2d2d 2d2d  tances ---------
-0000dbd0: 2d0a 4070 7974 6573 742e 6d61 726b 2e61  -.@pytest.mark.a
-0000dbe0: 7a75 7265 0a64 6566 2074 6573 745f 617a  zure.def test_az
-0000dbf0: 7572 655f 7374 6172 745f 7374 6f70 2829  ure_start_stop()
-0000dc00: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
-0000dc10: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
-0000dc20: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
-0000dc30: 280a 2020 2020 2020 2020 2761 7a75 7265  (.        'azure
-0000dc40: 2d73 7461 7274 2d73 746f 7027 2c0a 2020  -start-stop',.  
-0000dc50: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-0000dc60: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
-0000dc70: 202d 7920 2d63 207b 6e61 6d65 7d20 6578   -y -c {name} ex
-0000dc80: 616d 706c 6573 2f61 7a75 7265 5f73 7461  amples/azure_sta
-0000dc90: 7274 5f73 746f 702e 7961 6d6c 272c 0a20  rt_stop.yaml',. 
-0000dca0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000dcb0: 2065 7865 6320 7b6e 616d 657d 2065 7861   exec {name} exa
-0000dcc0: 6d70 6c65 732f 617a 7572 655f 7374 6172  mples/azure_star
-0000dcd0: 745f 7374 6f70 2e79 616d 6c27 2c0a 2020  t_stop.yaml',.  
-0000dce0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000dcf0: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
-0000dd00: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
-0000dd10: 7265 2074 6865 206a 6f62 2073 7563 6365  re the job succe
-0000dd20: 6564 6564 2e0a 2020 2020 2020 2020 2020  eded..          
-0000dd30: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-0000dd40: 6d65 7d20 2270 726c 696d 6974 202d 6e20  me} "prlimit -n 
-0000dd50: 2d2d 7069 643d 5c24 2870 6772 6570 202d  --pid=\$(pgrep -
-0000dd60: 6620 5c27 7261 796c 6574 2f72 6179 6c65  f \'raylet/rayle
-0000dd70: 7420 2d2d 7261 796c 6574 5f73 6f63 6b65  t --raylet_socke
-0000dd80: 745f 6e61 6d65 5c27 2920 7c20 6772 6570  t_name\') | grep
-0000dd90: 205c 2722 5c27 3130 3438 3537 3620 3130   \'"\'1048576 10
-0000dda0: 3438 3537 365c 2722 5c27 2227 2c20 2023  48576\'"\'"',  #
-0000ddb0: 2045 6e73 7572 6520 7468 6520 7261 796c   Ensure the rayl
-0000ddc0: 6574 2070 726f 6365 7373 2068 6173 2074  et process has t
-0000ddd0: 6865 2063 6f72 7265 6374 2066 696c 6520  he correct file 
-0000dde0: 6465 7363 7269 7074 6f72 206c 696d 6974  descriptor limit
-0000ddf0: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
-0000de00: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-0000de10: 3220 2d2d 7374 6174 7573 272c 2020 2320  2 --status',  # 
-0000de20: 456e 7375 7265 2074 6865 206a 6f62 2073  Ensure the job s
-0000de30: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
-0000de40: 2020 2020 2020 6627 736b 7920 7374 6f70        f'sky stop
-0000de50: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-0000de60: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
-0000de70: 7461 7274 202d 7920 7b6e 616d 657d 202d  tart -y {name} -
-0000de80: 6920 3127 2c0a 2020 2020 2020 2020 2020  i 1',.          
-0000de90: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-0000dea0: 6d65 7d20 6578 616d 706c 6573 2f61 7a75  me} examples/azu
-0000deb0: 7265 5f73 7461 7274 5f73 746f 702e 7961  re_start_stop.ya
-0000dec0: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-0000ded0: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-0000dee0: 657d 2033 202d 2d73 7461 7475 7327 2c20  e} 3 --status', 
-0000def0: 2023 2045 6e73 7572 6520 7468 6520 6a6f   # Ensure the jo
-0000df00: 6220 7375 6363 6565 6465 642e 0a20 2020  b succeeded..   
-0000df10: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-0000df20: 3230 3027 2c0a 2020 2020 2020 2020 2020  200',.          
-0000df30: 2020 6627 733d 2428 736b 7920 7374 6174    f's=$(sky stat
-0000df40: 7573 202d 7220 7b6e 616d 657d 2920 2626  us -r {name}) &&
-0000df50: 2065 6368 6f20 2473 2026 2620 6563 686f   echo $s && echo
-0000df60: 2024 7320 7c20 6772 6570 2022 494e 4954   $s | grep "INIT
-0000df70: 5c7c 5354 4f50 5045 4422 270a 2020 2020  \|STOPPED"'.    
-0000df80: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
-0000df90: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
-0000dfa0: 6d65 7d27 2c0a 2020 2020 2020 2020 7469  me}',.        ti
-0000dfb0: 6d65 6f75 743d 3330 202a 2036 302c 2020  meout=30 * 60,  
-0000dfc0: 2320 3330 206d 696e 730a 2020 2020 290a  # 30 mins.    ).
-0000dfd0: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-0000dfe0: 2874 6573 7429 0a0a 0a23 202d 2d2d 2d2d  (test)...# -----
-0000dff0: 2d2d 2d2d 2d20 5465 7374 696e 6720 4175  ----- Testing Au
-0000e000: 746f 7374 6f70 7069 6e67 202d 2d2d 2d2d  tostopping -----
-0000e010: 2d2d 2d2d 2d0a 4070 7974 6573 742e 6d61  -----.@pytest.ma
-0000e020: 726b 2e6e 6f5f 6c61 6d62 6461 5f63 6c6f  rk.no_lambda_clo
-0000e030: 7564 2020 2320 4c61 6d62 6461 2043 6c6f  ud  # Lambda Clo
-0000e040: 7564 2064 6f65 7320 6e6f 7420 7375 7070  ud does not supp
-0000e050: 6f72 7420 7374 6f70 7069 6e67 2069 6e73  ort stopping ins
-0000e060: 7461 6e63 6573 0a40 7079 7465 7374 2e6d  tances.@pytest.m
-0000e070: 6172 6b2e 6e6f 5f69 626d 2020 2320 4649  ark.no_ibm  # FI
-0000e080: 5828 4942 4d29 2073 706f 7261 6469 6361  X(IBM) sporadica
-0000e090: 6c6c 7920 6661 696c 732c 2061 7320 7265  lly fails, as re
-0000e0a0: 7374 6172 7465 6420 776f 726b 6572 7320  started workers 
-0000e0b0: 7374 6179 2075 6e69 6e69 7469 616c 697a  stay uninitializ
-0000e0c0: 6564 2069 6e64 6566 696e 6974 656c 790a  ed indefinitely.
-0000e0d0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-0000e0e0: 7363 7020 2023 2053 4350 2064 6f65 7320  scp  # SCP does 
-0000e0f0: 6e6f 7420 7375 7070 6f72 7420 6e75 6d5f  not support num_
-0000e100: 6e6f 6465 7320 3e20 3120 7965 740a 6465  nodes > 1 yet.de
-0000e110: 6620 7465 7374 5f61 7574 6f73 746f 7028  f test_autostop(
-0000e120: 6765 6e65 7269 635f 636c 6f75 643a 2073  generic_cloud: s
-0000e130: 7472 293a 0a20 2020 206e 616d 6520 3d20  tr):.    name = 
-0000e140: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-0000e150: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
-0000e160: 6573 7428 0a20 2020 2020 2020 2027 6175  est(.        'au
-0000e170: 746f 7374 6f70 272c 0a20 2020 2020 2020  tostop',.       
-0000e180: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-0000e190: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
-0000e1a0: 6420 2d63 207b 6e61 6d65 7d20 2d2d 6e75  d -c {name} --nu
-0000e1b0: 6d2d 6e6f 6465 7320 3220 2d2d 636c 6f75  m-nodes 2 --clou
-0000e1c0: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
-0000e1d0: 7d20 7465 7374 732f 7465 7374 5f79 616d  } tests/test_yam
-0000e1e0: 6c73 2f6d 696e 696d 616c 2e79 616d 6c27  ls/minimal.yaml'
-0000e1f0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000e200: 736b 7920 6175 746f 7374 6f70 202d 7920  sky autostop -y 
-0000e210: 7b6e 616d 657d 202d 6920 3127 2c0a 0a20  {name} -i 1',.. 
-0000e220: 2020 2020 2020 2020 2020 2023 2045 6e73             # Ens
-0000e230: 7572 6520 6175 746f 7374 6f70 2069 7320  ure autostop is 
-0000e240: 7365 742e 0a20 2020 2020 2020 2020 2020  set..           
-0000e250: 2066 2773 6b79 2073 7461 7475 7320 7c20   f'sky status | 
-0000e260: 6772 6570 207b 6e61 6d65 7d20 7c20 6772  grep {name} | gr
-0000e270: 6570 2022 316d 2227 2c0a 0a20 2020 2020  ep "1m"',..     
-0000e280: 2020 2020 2020 2023 2045 6e73 7572 6520         # Ensure 
-0000e290: 7468 6520 636c 7573 7465 7220 6973 206e  the cluster is n
-0000e2a0: 6f74 2073 746f 7070 6564 2065 6172 6c79  ot stopped early
-0000e2b0: 2e0a 2020 2020 2020 2020 2020 2020 2773  ..            's
-0000e2c0: 6c65 6570 2034 3527 2c0a 2020 2020 2020  leep 45',.      
-0000e2d0: 2020 2020 2020 6627 733d 2428 736b 7920        f's=$(sky 
-0000e2e0: 7374 6174 7573 207b 6e61 6d65 7d20 2d2d  status {name} --
-0000e2f0: 7265 6672 6573 6829 3b20 6563 686f 2022  refresh); echo "
-0000e300: 2473 223b 2065 6368 6f3b 2065 6368 6f3b  $s"; echo; echo;
-0000e310: 2065 6368 6f20 2224 7322 2020 7c20 6772   echo "$s"  | gr
-0000e320: 6570 207b 6e61 6d65 7d20 7c20 6772 6570  ep {name} | grep
-0000e330: 2055 5027 2c0a 0a20 2020 2020 2020 2020   UP',..         
-0000e340: 2020 2023 2045 6e73 7572 6520 7468 6520     # Ensure the 
-0000e350: 636c 7573 7465 7220 6973 2053 544f 5050  cluster is STOPP
-0000e360: 4544 2e0a 2020 2020 2020 2020 2020 2020  ED..            
-0000e370: 2773 6c65 6570 2032 3530 272c 0a20 2020  'sleep 250',.   
-0000e380: 2020 2020 2020 2020 2066 2773 3d24 2873           f's=$(s
-0000e390: 6b79 2073 7461 7475 7320 7b6e 616d 657d  ky status {name}
-0000e3a0: 202d 2d72 6566 7265 7368 293b 2065 6368   --refresh); ech
-0000e3b0: 6f20 2224 7322 3b20 6563 686f 3b20 6563  o "$s"; echo; ec
-0000e3c0: 686f 3b20 6563 686f 2022 2473 2220 207c  ho; echo "$s"  |
-0000e3d0: 2067 7265 7020 7b6e 616d 657d 207c 2067   grep {name} | g
-0000e3e0: 7265 7020 5354 4f50 5045 4427 2c0a 0a20  rep STOPPED',.. 
-0000e3f0: 2020 2020 2020 2020 2020 2023 2045 6e73             # Ens
-0000e400: 7572 6520 7468 6520 636c 7573 7465 7220  ure the cluster 
-0000e410: 6973 2055 5020 616e 6420 7468 6520 6175  is UP and the au
-0000e420: 746f 7374 6f70 2073 6574 7469 6e67 2069  tostop setting i
-0000e430: 7320 7265 7365 7420 2827 2d27 292e 0a20  s reset ('-').. 
-0000e440: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000e450: 2073 7461 7274 202d 7920 7b6e 616d 657d   start -y {name}
-0000e460: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0000e470: 2773 6b79 2073 7461 7475 7320 7c20 6772  'sky status | gr
-0000e480: 6570 207b 6e61 6d65 7d20 7c20 6772 6570  ep {name} | grep
-0000e490: 202d 4520 2255 505c 732b 2d22 272c 0a0a   -E "UP\s+-"',..
-0000e4a0: 2020 2020 2020 2020 2020 2020 2320 456e              # En
-0000e4b0: 7375 7265 2074 6865 206a 6f62 2073 7563  sure the job suc
-0000e4c0: 6365 6564 6564 2e0a 2020 2020 2020 2020  ceeded..        
-0000e4d0: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
-0000e4e0: 6e61 6d65 7d20 7465 7374 732f 7465 7374  name} tests/test
-0000e4f0: 5f79 616d 6c73 2f6d 696e 696d 616c 2e79  _yamls/minimal.y
-0000e500: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-0000e510: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-0000e520: 6d65 7d20 3220 2d2d 7374 6174 7573 272c  me} 2 --status',
-0000e530: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-0000e540: 5465 7374 2072 6573 7461 7274 696e 6720  Test restarting 
-0000e550: 7468 6520 6964 6c65 6e65 7373 2074 696d  the idleness tim
-0000e560: 6572 2076 6961 2063 616e 6365 6c20 2b20  er via cancel + 
-0000e570: 7265 7365 743a 0a20 2020 2020 2020 2020  reset:.         
-0000e580: 2020 2066 2773 6b79 2061 7574 6f73 746f     f'sky autosto
-0000e590: 7020 2d79 207b 6e61 6d65 7d20 2d69 2031  p -y {name} -i 1
-0000e5a0: 272c 2020 2320 4964 6c65 6e65 7373 2073  ',  # Idleness s
-0000e5b0: 7461 7274 7320 636f 756e 7469 6e67 2e0a  tarts counting..
-0000e5c0: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
-0000e5d0: 6570 2034 3527 2c20 2023 2041 6c6d 6f73  ep 45',  # Almos
-0000e5e0: 7420 7265 6163 6865 6420 7468 6520 7468  t reached the th
-0000e5f0: 7265 7368 6f6c 642e 0a20 2020 2020 2020  reshold..       
-0000e600: 2020 2020 2066 2773 6b79 2061 7574 6f73       f'sky autos
-0000e610: 746f 7020 2d79 207b 6e61 6d65 7d20 2d2d  top -y {name} --
-0000e620: 6361 6e63 656c 272c 0a20 2020 2020 2020  cancel',.       
-0000e630: 2020 2020 2066 2773 6b79 2061 7574 6f73       f'sky autos
-0000e640: 746f 7020 2d79 207b 6e61 6d65 7d20 2d69  top -y {name} -i
-0000e650: 2031 272c 2020 2320 5368 6f75 6c64 2072   1',  # Should r
-0000e660: 6573 7461 7274 2074 6865 2074 696d 6572  estart the timer
-0000e670: 2e0a 2020 2020 2020 2020 2020 2020 2773  ..            's
-0000e680: 6c65 6570 2034 3527 2c0a 2020 2020 2020  leep 45',.      
-0000e690: 2020 2020 2020 6627 733d 2428 736b 7920        f's=$(sky 
-0000e6a0: 7374 6174 7573 207b 6e61 6d65 7d20 2d2d  status {name} --
-0000e6b0: 7265 6672 6573 6829 3b20 6563 686f 2022  refresh); echo "
-0000e6c0: 2473 223b 2065 6368 6f3b 2065 6368 6f3b  $s"; echo; echo;
-0000e6d0: 2065 6368 6f20 2224 7322 207c 2067 7265   echo "$s" | gre
-0000e6e0: 7020 7b6e 616d 657d 207c 2067 7265 7020  p {name} | grep 
-0000e6f0: 5550 272c 0a20 2020 2020 2020 2020 2020  UP',.           
-0000e700: 2027 736c 6565 7020 3235 3027 2c0a 2020   'sleep 250',.  
-0000e710: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
-0000e720: 736b 7920 7374 6174 7573 207b 6e61 6d65  sky status {name
-0000e730: 7d20 2d2d 7265 6672 6573 6829 3b20 6563  } --refresh); ec
-0000e740: 686f 2022 2473 223b 2065 6368 6f3b 2065  ho "$s"; echo; e
-0000e750: 6368 6f3b 2065 6368 6f20 2224 7322 2020  cho; echo "$s"  
-0000e760: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
-0000e770: 6772 6570 2053 544f 5050 4544 272c 0a0a  grep STOPPED',..
-0000e780: 2020 2020 2020 2020 2020 2020 2320 5465              # Te
-0000e790: 7374 2072 6573 7461 7274 696e 6720 7468  st restarting th
-0000e7a0: 6520 6964 6c65 6e65 7373 2074 696d 6572  e idleness timer
-0000e7b0: 2076 6961 2065 7865 633a 0a20 2020 2020   via exec:.     
-0000e7c0: 2020 2020 2020 2066 2773 6b79 2073 7461         f'sky sta
-0000e7d0: 7274 202d 7920 7b6e 616d 657d 272c 0a20  rt -y {name}',. 
-0000e7e0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000e7f0: 2073 7461 7475 7320 7c20 6772 6570 207b   status | grep {
-0000e800: 6e61 6d65 7d20 7c20 6772 6570 202d 4520  name} | grep -E 
-0000e810: 2255 505c 732b 2d22 272c 0a20 2020 2020  "UP\s+-"',.     
-0000e820: 2020 2020 2020 2066 2773 6b79 2061 7574         f'sky aut
-0000e830: 6f73 746f 7020 2d79 207b 6e61 6d65 7d20  ostop -y {name} 
-0000e840: 2d69 2031 272c 2020 2320 4964 6c65 6e65  -i 1',  # Idlene
-0000e850: 7373 2073 7461 7274 7320 636f 756e 7469  ss starts counti
-0000e860: 6e67 2e0a 2020 2020 2020 2020 2020 2020  ng..            
-0000e870: 2773 6c65 6570 2034 3527 2c20 2023 2041  'sleep 45',  # A
-0000e880: 6c6d 6f73 7420 7265 6163 6865 6420 7468  lmost reached th
-0000e890: 6520 7468 7265 7368 6f6c 642e 0a20 2020  e threshold..   
-0000e8a0: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
-0000e8b0: 7865 6320 7b6e 616d 657d 2065 6368 6f20  xec {name} echo 
-0000e8c0: 6869 272c 2020 2320 5368 6f75 6c64 2072  hi',  # Should r
-0000e8d0: 6573 7461 7274 2074 6865 2074 696d 6572  estart the timer
-0000e8e0: 2e0a 2020 2020 2020 2020 2020 2020 2773  ..            's
-0000e8f0: 6c65 6570 2034 3527 2c0a 2020 2020 2020  leep 45',.      
-0000e900: 2020 2020 2020 6627 733d 2428 736b 7920        f's=$(sky 
-0000e910: 7374 6174 7573 207b 6e61 6d65 7d20 2d2d  status {name} --
-0000e920: 7265 6672 6573 6829 3b20 6563 686f 2022  refresh); echo "
-0000e930: 2473 223b 2065 6368 6f3b 2065 6368 6f3b  $s"; echo; echo;
-0000e940: 2065 6368 6f20 2224 7322 2020 7c20 6772   echo "$s"  | gr
-0000e950: 6570 207b 6e61 6d65 7d20 7c20 6772 6570  ep {name} | grep
-0000e960: 2055 5027 2c0a 2020 2020 2020 2020 2020   UP',.          
-0000e970: 2020 2773 6c65 6570 2032 3530 272c 0a20    'sleep 250',. 
-0000e980: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
-0000e990: 2873 6b79 2073 7461 7475 7320 7b6e 616d  (sky status {nam
-0000e9a0: 657d 202d 2d72 6566 7265 7368 293b 2065  e} --refresh); e
-0000e9b0: 6368 6f20 2224 7322 3b20 6563 686f 3b20  cho "$s"; echo; 
-0000e9c0: 6563 686f 3b20 6563 686f 2022 2473 2220  echo; echo "$s" 
-0000e9d0: 207c 2067 7265 7020 7b6e 616d 657d 207c   | grep {name} |
-0000e9e0: 2067 7265 7020 5354 4f50 5045 4427 2c0a   grep STOPPED',.
-0000e9f0: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-0000ea00: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
-0000ea10: 207b 6e61 6d65 7d27 2c0a 2020 2020 2020   {name}',.      
-0000ea20: 2020 7469 6d65 6f75 743d 3230 202a 2036    timeout=20 * 6
-0000ea30: 302c 0a20 2020 2029 0a20 2020 2072 756e  0,.    ).    run
-0000ea40: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
-0000ea50: 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054  ..# ---------- T
-0000ea60: 6573 7469 6e67 2041 7574 6f64 6f77 6e69  esting Autodowni
-0000ea70: 6e67 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070  ng ----------.@p
-0000ea80: 7974 6573 742e 6d61 726b 2e6e 6f5f 7363  ytest.mark.no_sc
-0000ea90: 7020 2023 2053 4350 2064 6f65 7320 6e6f  p  # SCP does no
-0000eaa0: 7420 7375 7070 6f72 7420 6e75 6d5f 6e6f  t support num_no
-0000eab0: 6465 7320 3e20 3120 7965 742e 2052 756e  des > 1 yet. Run
-0000eac0: 2074 6573 745f 7363 705f 6175 746f 646f   test_scp_autodo
-0000ead0: 776e 2069 6e73 7465 6164 2e0a 6465 6620  wn instead..def 
-0000eae0: 7465 7374 5f61 7574 6f64 6f77 6e28 6765  test_autodown(ge
-0000eaf0: 6e65 7269 635f 636c 6f75 643a 2073 7472  neric_cloud: str
-0000eb00: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
-0000eb10: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
-0000eb20: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
-0000eb30: 7428 0a20 2020 2020 2020 2027 6175 746f  t(.        'auto
-0000eb40: 646f 776e 272c 0a20 2020 2020 2020 205b  down',.        [
-0000eb50: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000eb60: 6b79 206c 6175 6e63 6820 2d79 202d 6420  ky launch -y -d 
-0000eb70: 2d63 207b 6e61 6d65 7d20 2d2d 6e75 6d2d  -c {name} --num-
-0000eb80: 6e6f 6465 7320 3220 2d2d 636c 6f75 6420  nodes 2 --cloud 
-0000eb90: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
-0000eba0: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
-0000ebb0: 2f6d 696e 696d 616c 2e79 616d 6c27 2c0a  /minimal.yaml',.
-0000ebc0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000ebd0: 7920 6175 746f 7374 6f70 202d 7920 7b6e  y autostop -y {n
-0000ebe0: 616d 657d 202d 2d64 6f77 6e20 2d69 2031  ame} --down -i 1
-0000ebf0: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
-0000ec00: 2045 6e73 7572 6520 6175 746f 7374 6f70   Ensure autostop
-0000ec10: 2069 7320 7365 742e 0a20 2020 2020 2020   is set..       
-0000ec20: 2020 2020 2066 2773 6b79 2073 7461 7475       f'sky statu
-0000ec30: 7320 7c20 6772 6570 207b 6e61 6d65 7d20  s | grep {name} 
-0000ec40: 7c20 6772 6570 2022 316d 2028 646f 776e  | grep "1m (down
-0000ec50: 2922 272c 0a20 2020 2020 2020 2020 2020  )"',.           
-0000ec60: 2023 2045 6e73 7572 6520 7468 6520 636c   # Ensure the cl
-0000ec70: 7573 7465 7220 6973 206e 6f74 2074 6572  uster is not ter
-0000ec80: 6d69 6e61 7465 6420 6561 726c 792e 0a20  minated early.. 
-0000ec90: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-0000eca0: 7020 3435 272c 0a20 2020 2020 2020 2020  p 45',.         
-0000ecb0: 2020 2066 2773 3d24 2873 6b79 2073 7461     f's=$(sky sta
-0000ecc0: 7475 7320 7b6e 616d 657d 202d 2d72 6566  tus {name} --ref
-0000ecd0: 7265 7368 293b 2065 6368 6f20 2224 7322  resh); echo "$s"
-0000ece0: 3b20 6563 686f 3b20 6563 686f 3b20 6563  ; echo; echo; ec
-0000ecf0: 686f 2022 2473 2220 207c 2067 7265 7020  ho "$s"  | grep 
-0000ed00: 7b6e 616d 657d 207c 2067 7265 7020 5550  {name} | grep UP
-0000ed10: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
-0000ed20: 2045 6e73 7572 6520 7468 6520 636c 7573   Ensure the clus
-0000ed30: 7465 7220 6973 2074 6572 6d69 6e61 7465  ter is terminate
-0000ed40: 642e 0a20 2020 2020 2020 2020 2020 2027  d..            '
-0000ed50: 736c 6565 7020 3230 3027 2c0a 2020 2020  sleep 200',.    
-0000ed60: 2020 2020 2020 2020 6627 733d 2428 534b          f's=$(SK
-0000ed70: 5950 494c 4f54 5f44 4542 5547 3d30 2073  YPILOT_DEBUG=0 s
-0000ed80: 6b79 2073 7461 7475 7320 7b6e 616d 657d  ky status {name}
-0000ed90: 202d 2d72 6566 7265 7368 2920 2626 2065   --refresh) && e
-0000eda0: 6368 6f20 2224 7322 2026 2620 7b7b 2065  cho "$s" && {{ e
-0000edb0: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
-0000edc0: 7b6e 616d 657d 207c 2067 7265 7020 2241  {name} | grep "A
-0000edd0: 7574 6f64 6f77 6e65 6420 636c 7573 7465  utodowned cluste
-0000ede0: 725c 7c74 6572 6d69 6e61 7465 6420 6f6e  r\|terminated on
-0000edf0: 2074 6865 2063 6c6f 7564 223b 207d 7d20   the cloud"; }} 
-0000ee00: 7c7c 207b 7b20 6563 686f 2022 2473 2220  || {{ echo "$s" 
-0000ee10: 7c20 6772 6570 207b 6e61 6d65 7d20 2626  | grep {name} &&
-0000ee20: 2065 7869 7420 3120 7c7c 2065 7869 7420   exit 1 || exit 
-0000ee30: 303b 207d 7d27 2c0a 2020 2020 2020 2020  0; }}',.        
-0000ee40: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
-0000ee50: 202d 7920 2d64 202d 6320 7b6e 616d 657d   -y -d -c {name}
-0000ee60: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
-0000ee70: 635f 636c 6f75 647d 202d 2d6e 756d 2d6e  c_cloud} --num-n
-0000ee80: 6f64 6573 2032 202d 2d64 6f77 6e20 7465  odes 2 --down te
-0000ee90: 7374 732f 7465 7374 5f79 616d 6c73 2f6d  sts/test_yamls/m
-0000eea0: 696e 696d 616c 2e79 616d 6c27 2c0a 2020  inimal.yaml',.  
-0000eeb0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000eec0: 7374 6174 7573 207c 2067 7265 7020 7b6e  status | grep {n
-0000eed0: 616d 657d 207c 2067 7265 7020 5550 272c  ame} | grep UP',
-0000eee0: 2020 2320 456e 7375 7265 2074 6865 2063    # Ensure the c
-0000eef0: 6c75 7374 6572 2069 7320 5550 2e0a 2020  luster is UP..  
-0000ef00: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000ef10: 6578 6563 207b 6e61 6d65 7d20 2d2d 636c  exec {name} --cl
-0000ef20: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
-0000ef30: 7564 7d20 7465 7374 732f 7465 7374 5f79  ud} tests/test_y
-0000ef40: 616d 6c73 2f6d 696e 696d 616c 2e79 616d  amls/minimal.yam
-0000ef50: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-0000ef60: 6627 736b 7920 7374 6174 7573 207c 2067  f'sky status | g
-0000ef70: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
-0000ef80: 7020 2231 6d20 2864 6f77 6e29 2227 2c0a  p "1m (down)"',.
-0000ef90: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
-0000efa0: 6570 2032 3430 272c 0a20 2020 2020 2020  ep 240',.       
-0000efb0: 2020 2020 2023 2045 6e73 7572 6520 7468       # Ensure th
-0000efc0: 6520 636c 7573 7465 7220 6973 2074 6572  e cluster is ter
-0000efd0: 6d69 6e61 7465 642e 0a20 2020 2020 2020  minated..       
-0000efe0: 2020 2020 2066 2773 3d24 2853 4b59 5049       f's=$(SKYPI
-0000eff0: 4c4f 545f 4445 4255 473d 3020 736b 7920  LOT_DEBUG=0 sky 
-0000f000: 7374 6174 7573 207b 6e61 6d65 7d20 2d2d  status {name} --
-0000f010: 7265 6672 6573 6829 2026 2620 6563 686f  refresh) && echo
-0000f020: 2022 2473 2220 2626 207b 7b20 6563 686f   "$s" && {{ echo
-0000f030: 2022 2473 2220 7c20 6772 6570 207b 6e61   "$s" | grep {na
-0000f040: 6d65 7d20 7c20 6772 6570 2022 4175 746f  me} | grep "Auto
-0000f050: 646f 776e 6564 2063 6c75 7374 6572 5c7c  downed cluster\|
-0000f060: 7465 726d 696e 6174 6564 206f 6e20 7468  terminated on th
-0000f070: 6520 636c 6f75 6422 3b20 7d7d 207c 7c20  e cloud"; }} || 
-0000f080: 7b7b 2065 6368 6f20 2224 7322 207c 2067  {{ echo "$s" | g
-0000f090: 7265 7020 7b6e 616d 657d 2026 2620 6578  rep {name} && ex
-0000f0a0: 6974 2031 207c 7c20 6578 6974 2030 3b20  it 1 || exit 0; 
-0000f0b0: 7d7d 272c 0a20 2020 2020 2020 2020 2020  }}',.           
-0000f0c0: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
-0000f0d0: 202d 6420 2d63 207b 6e61 6d65 7d20 2d2d   -d -c {name} --
-0000f0e0: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
-0000f0f0: 6c6f 7564 7d20 2d2d 6e75 6d2d 6e6f 6465  loud} --num-node
-0000f100: 7320 3220 2d2d 646f 776e 2074 6573 7473  s 2 --down tests
-0000f110: 2f74 6573 745f 7961 6d6c 732f 6d69 6e69  /test_yamls/mini
-0000f120: 6d61 6c2e 7961 6d6c 272c 0a20 2020 2020  mal.yaml',.     
-0000f130: 2020 2020 2020 2066 2773 6b79 2061 7574         f'sky aut
-0000f140: 6f73 746f 7020 2d79 207b 6e61 6d65 7d20  ostop -y {name} 
-0000f150: 2d2d 6361 6e63 656c 272c 0a20 2020 2020  --cancel',.     
-0000f160: 2020 2020 2020 2027 736c 6565 7020 3234         'sleep 24
-0000f170: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
-0000f180: 2320 456e 7375 7265 2074 6865 2063 6c75  # Ensure the clu
-0000f190: 7374 6572 2069 7320 7374 696c 6c20 5550  ster is still UP
-0000f1a0: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
-0000f1b0: 733d 2428 534b 5950 494c 4f54 5f44 4542  s=$(SKYPILOT_DEB
-0000f1c0: 5547 3d30 2073 6b79 2073 7461 7475 7320  UG=0 sky status 
-0000f1d0: 7b6e 616d 657d 202d 2d72 6566 7265 7368  {name} --refresh
-0000f1e0: 2920 2626 2065 6368 6f20 2224 7322 2026  ) && echo "$s" &
-0000f1f0: 2620 6563 686f 2022 2473 2220 7c20 6772  & echo "$s" | gr
-0000f200: 6570 207b 6e61 6d65 7d20 7c20 6772 6570  ep {name} | grep
-0000f210: 2055 5027 2c0a 2020 2020 2020 2020 5d2c   UP',.        ],
-0000f220: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
-0000f230: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
-0000f240: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
-0000f250: 3230 202a 2036 302c 0a20 2020 2029 0a20  20 * 60,.    ). 
-0000f260: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-0000f270: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
-0000f280: 6d61 726b 2e73 6370 0a64 6566 2074 6573  mark.scp.def tes
-0000f290: 745f 7363 705f 6175 746f 646f 776e 2829  t_scp_autodown()
-0000f2a0: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
-0000f2b0: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
-0000f2c0: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
-0000f2d0: 280a 2020 2020 2020 2020 2753 4350 5f61  (.        'SCP_a
-0000f2e0: 7574 6f64 6f77 6e27 2c0a 2020 2020 2020  utodown',.      
-0000f2f0: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-0000f300: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
-0000f310: 2d64 202d 6320 7b6e 616d 657d 207b 5343  -d -c {name} {SC
-0000f320: 505f 5459 5045 7d20 7465 7374 732f 7465  P_TYPE} tests/te
-0000f330: 7374 5f79 616d 6c73 2f6d 696e 696d 616c  st_yamls/minimal
-0000f340: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-0000f350: 2020 2020 6627 736b 7920 6175 746f 7374      f'sky autost
-0000f360: 6f70 202d 7920 7b6e 616d 657d 202d 2d64  op -y {name} --d
-0000f370: 6f77 6e20 2d69 2031 272c 0a20 2020 2020  own -i 1',.     
-0000f380: 2020 2020 2020 2023 2045 6e73 7572 6520         # Ensure 
-0000f390: 6175 746f 7374 6f70 2069 7320 7365 742e  autostop is set.
-0000f3a0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000f3b0: 6b79 2073 7461 7475 7320 7c20 6772 6570  ky status | grep
-0000f3c0: 207b 6e61 6d65 7d20 7c20 6772 6570 2022   {name} | grep "
-0000f3d0: 316d 2028 646f 776e 2922 272c 0a20 2020  1m (down)"',.   
-0000f3e0: 2020 2020 2020 2020 2023 2045 6e73 7572           # Ensur
-0000f3f0: 6520 7468 6520 636c 7573 7465 7220 6973  e the cluster is
-0000f400: 206e 6f74 2074 6572 6d69 6e61 7465 6420   not terminated 
-0000f410: 6561 726c 792e 0a20 2020 2020 2020 2020  early..         
-0000f420: 2020 2027 736c 6565 7020 3435 272c 0a20     'sleep 45',. 
-0000f430: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000f440: 2073 7461 7475 7320 2d2d 7265 6672 6573   status --refres
-0000f450: 6820 7c20 6772 6570 207b 6e61 6d65 7d20  h | grep {name} 
-0000f460: 7c20 6772 6570 2055 5027 2c0a 2020 2020  | grep UP',.    
-0000f470: 2020 2020 2020 2020 2320 456e 7375 7265          # Ensure
-0000f480: 2074 6865 2063 6c75 7374 6572 2069 7320   the cluster is 
-0000f490: 7465 726d 696e 6174 6564 2e0a 2020 2020  terminated..    
-0000f4a0: 2020 2020 2020 2020 2773 6c65 6570 2032          'sleep 2
-0000f4b0: 3030 272c 0a20 2020 2020 2020 2020 2020  00',.           
-0000f4c0: 2066 2773 3d24 2853 4b59 5049 4c4f 545f   f's=$(SKYPILOT_
-0000f4d0: 4445 4255 473d 3020 736b 7920 7374 6174  DEBUG=0 sky stat
-0000f4e0: 7573 202d 2d72 6566 7265 7368 2920 2626  us --refresh) &&
-0000f4f0: 2070 7269 6e74 6620 2224 7322 2026 2620   printf "$s" && 
-0000f500: 7b7b 2065 6368 6f20 2224 7322 207c 2067  {{ echo "$s" | g
-0000f510: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
-0000f520: 7020 2241 7574 6f64 6f77 6e65 6420 636c  p "Autodowned cl
-0000f530: 7573 7465 725c 7c74 6572 6d69 6e61 7465  uster\|terminate
-0000f540: 6420 6f6e 2074 6865 2063 6c6f 7564 223b  d on the cloud";
-0000f550: 207d 7d20 7c7c 207b 7b20 6563 686f 2022   }} || {{ echo "
-0000f560: 2473 2220 7c20 6772 6570 207b 6e61 6d65  $s" | grep {name
-0000f570: 7d20 2626 2065 7869 7420 3120 7c7c 2065  } && exit 1 || e
-0000f580: 7869 7420 303b 207d 7d27 2c0a 2020 2020  xit 0; }}',.    
-0000f590: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
-0000f5a0: 756e 6368 202d 7920 2d64 202d 6320 7b6e  unch -y -d -c {n
-0000f5b0: 616d 657d 207b 5343 505f 5459 5045 7d20  ame} {SCP_TYPE} 
-0000f5c0: 2d2d 646f 776e 2074 6573 7473 2f74 6573  --down tests/tes
-0000f5d0: 745f 7961 6d6c 732f 6d69 6e69 6d61 6c2e  t_yamls/minimal.
-0000f5e0: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-0000f5f0: 2020 2066 2773 6b79 2073 7461 7475 7320     f'sky status 
-0000f600: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
-0000f610: 6772 6570 2055 5027 2c20 2023 2045 6e73  grep UP',  # Ens
-0000f620: 7572 6520 7468 6520 636c 7573 7465 7220  ure the cluster 
-0000f630: 6973 2055 502e 0a20 2020 2020 2020 2020  is UP..         
-0000f640: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
-0000f650: 616d 657d 207b 5343 505f 5459 5045 7d20  ame} {SCP_TYPE} 
-0000f660: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
-0000f670: 2f6d 696e 696d 616c 2e79 616d 6c27 2c0a  /minimal.yaml',.
-0000f680: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000f690: 7920 7374 6174 7573 207c 2067 7265 7020  y status | grep 
-0000f6a0: 7b6e 616d 657d 207c 2067 7265 7020 2231  {name} | grep "1
-0000f6b0: 6d20 2864 6f77 6e29 2227 2c0a 2020 2020  m (down)"',.    
-0000f6c0: 2020 2020 2020 2020 2773 6c65 6570 2032          'sleep 2
-0000f6d0: 3030 272c 0a20 2020 2020 2020 2020 2020  00',.           
-0000f6e0: 2023 2045 6e73 7572 6520 7468 6520 636c   # Ensure the cl
-0000f6f0: 7573 7465 7220 6973 2074 6572 6d69 6e61  uster is termina
-0000f700: 7465 642e 0a20 2020 2020 2020 2020 2020  ted..           
-0000f710: 2066 2773 3d24 2853 4b59 5049 4c4f 545f   f's=$(SKYPILOT_
-0000f720: 4445 4255 473d 3020 736b 7920 7374 6174  DEBUG=0 sky stat
-0000f730: 7573 202d 2d72 6566 7265 7368 2920 2626  us --refresh) &&
-0000f740: 2070 7269 6e74 6620 2224 7322 2026 2620   printf "$s" && 
-0000f750: 7b7b 2065 6368 6f20 2224 7322 207c 2067  {{ echo "$s" | g
-0000f760: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
-0000f770: 7020 2241 7574 6f64 6f77 6e65 6420 636c  p "Autodowned cl
-0000f780: 7573 7465 725c 7c74 6572 6d69 6e61 7465  uster\|terminate
-0000f790: 6420 6f6e 2074 6865 2063 6c6f 7564 223b  d on the cloud";
-0000f7a0: 207d 7d20 7c7c 207b 7b20 6563 686f 2022   }} || {{ echo "
-0000f7b0: 2473 2220 7c20 6772 6570 207b 6e61 6d65  $s" | grep {name
-0000f7c0: 7d20 2626 2065 7869 7420 3120 7c7c 2065  } && exit 1 || e
-0000f7d0: 7869 7420 303b 207d 7d27 2c0a 2020 2020  xit 0; }}',.    
-0000f7e0: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
-0000f7f0: 756e 6368 202d 7920 2d64 202d 6320 7b6e  unch -y -d -c {n
-0000f800: 616d 657d 207b 5343 505f 5459 5045 7d20  ame} {SCP_TYPE} 
-0000f810: 2d2d 646f 776e 2074 6573 7473 2f74 6573  --down tests/tes
-0000f820: 745f 7961 6d6c 732f 6d69 6e69 6d61 6c2e  t_yamls/minimal.
-0000f830: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-0000f840: 2020 2066 2773 6b79 2061 7574 6f73 746f     f'sky autosto
-0000f850: 7020 2d79 207b 6e61 6d65 7d20 2d2d 6361  p -y {name} --ca
-0000f860: 6e63 656c 272c 0a20 2020 2020 2020 2020  ncel',.         
-0000f870: 2020 2027 736c 6565 7020 3230 3027 2c0a     'sleep 200',.
-0000f880: 2020 2020 2020 2020 2020 2020 2320 456e              # En
-0000f890: 7375 7265 2074 6865 2063 6c75 7374 6572  sure the cluster
-0000f8a0: 2069 7320 7374 696c 6c20 5550 2e0a 2020   is still UP..  
-0000f8b0: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
-0000f8c0: 534b 5950 494c 4f54 5f44 4542 5547 3d30  SKYPILOT_DEBUG=0
-0000f8d0: 2073 6b79 2073 7461 7475 7320 2d2d 7265   sky status --re
-0000f8e0: 6672 6573 6829 2026 2620 7072 696e 7466  fresh) && printf
-0000f8f0: 2022 2473 2220 2626 2065 6368 6f20 2224   "$s" && echo "$
-0000f900: 7322 207c 2067 7265 7020 7b6e 616d 657d  s" | grep {name}
-0000f910: 207c 2067 7265 7020 5550 272c 0a20 2020   | grep UP',.   
-0000f920: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-0000f930: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
-0000f940: 616d 657d 272c 0a20 2020 2020 2020 2074  ame}',.        t
-0000f950: 696d 656f 7574 3d32 3520 2a20 3630 2c0a  imeout=25 * 60,.
-0000f960: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-0000f970: 655f 7465 7374 2874 6573 7429 0a0a 0a64  e_test(test)...d
-0000f980: 6566 205f 6765 745f 6361 6e63 656c 5f74  ef _get_cancel_t
-0000f990: 6173 6b5f 7769 7468 5f63 6c6f 7564 286e  ask_with_cloud(n
-0000f9a0: 616d 652c 2063 6c6f 7564 2c20 7469 6d65  ame, cloud, time
-0000f9b0: 6f75 743d 3135 202a 2036 3029 3a0a 2020  out=15 * 60):.  
-0000f9c0: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-0000f9d0: 2020 2020 2020 2066 277b 636c 6f75 647d         f'{cloud}
-0000f9e0: 2d63 616e 6365 6c2d 7461 736b 272c 0a20  -cancel-task',. 
-0000f9f0: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-0000fa00: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-0000fa10: 6820 2d63 207b 6e61 6d65 7d20 6578 616d  h -c {name} exam
-0000fa20: 706c 6573 2f72 6573 6e65 745f 6170 702e  ples/resnet_app.
-0000fa30: 7961 6d6c 202d 2d63 6c6f 7564 207b 636c  yaml --cloud {cl
-0000fa40: 6f75 647d 202d 7920 2d64 272c 0a20 2020  oud} -y -d',.   
-0000fa50: 2020 2020 2020 2020 2023 2057 6169 7420           # Wait 
-0000fa60: 7468 6520 4750 5520 7072 6f63 6573 7320  the GPU process 
-0000fa70: 746f 2073 7461 7274 2e0a 2020 2020 2020  to start..      
-0000fa80: 2020 2020 2020 2773 6c65 6570 2036 3027        'sleep 60'
-0000fa90: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000faa0: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
-0000fab0: 226e 7669 6469 612d 736d 6920 7c20 6772  "nvidia-smi | gr
-0000fac0: 6570 2070 7974 686f 6e22 272c 0a20 2020  ep python"',.   
-0000fad0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-0000fae0: 6f67 7320 7b6e 616d 657d 2032 202d 2d73  ogs {name} 2 --s
-0000faf0: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
-0000fb00: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
-0000fb10: 6465 642e 0a20 2020 2020 2020 2020 2020  ded..           
-0000fb20: 2066 2773 6b79 2063 616e 6365 6c20 2d79   f'sky cancel -y
-0000fb30: 207b 6e61 6d65 7d20 3127 2c0a 2020 2020   {name} 1',.    
-0000fb40: 2020 2020 2020 2020 2773 6c65 6570 2036          'sleep 6
-0000fb50: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
-0000fb60: 2320 6368 6563 6b20 6966 2074 6865 2070  # check if the p
-0000fb70: 7974 686f 6e20 6a6f 6220 6973 2067 6f6e  ython job is gon
-0000fb80: 652e 0a20 2020 2020 2020 2020 2020 2066  e..            f
-0000fb90: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-0000fba0: 2022 2120 6e76 6964 6961 2d73 6d69 207c   "! nvidia-smi |
-0000fbb0: 2067 7265 7020 7079 7468 6f6e 2227 2c0a   grep python"',.
-0000fbc0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000fbd0: 7920 6c6f 6773 207b 6e61 6d65 7d20 3320  y logs {name} 3 
-0000fbe0: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
-0000fbf0: 7375 7265 2074 6865 206a 6f62 2073 7563  sure the job suc
-0000fc00: 6365 6564 6564 2e0a 2020 2020 2020 2020  ceeded..        
-0000fc10: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
-0000fc20: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
-0000fc30: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
-0000fc40: 743d 7469 6d65 6f75 742c 0a20 2020 2029  t=timeout,.    )
-0000fc50: 0a20 2020 2072 6574 7572 6e20 7465 7374  .    return test
-0000fc60: 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20  ...# ---------- 
-0000fc70: 5465 7374 696e 6720 6073 6b79 2063 616e  Testing `sky can
-0000fc80: 6365 6c60 202d 2d2d 2d2d 2d2d 2d2d 2d0a  cel` ----------.
-0000fc90: 4070 7974 6573 742e 6d61 726b 2e61 7773  @pytest.mark.aws
-0000fca0: 0a40 7079 7465 7374 2e6d 6172 6b2e 736b  .@pytest.mark.sk
-0000fcb0: 6970 280a 2020 2020 7265 6173 6f6e 3d27  ip(.    reason='
-0000fcc0: 5468 6520 7265 736e 6574 5f61 7070 2069  The resnet_app i
-0000fcd0: 7320 666c 616b 792c 2064 7565 2074 6f20  s flaky, due to 
-0000fce0: 5446 2066 6169 6c69 6e67 2074 6f20 6465  TF failing to de
-0000fcf0: 7465 6374 2047 5055 732e 2729 0a64 6566  tect GPUs.').def
-0000fd00: 2074 6573 745f 6361 6e63 656c 5f61 7773   test_cancel_aws
-0000fd10: 2829 3a0a 2020 2020 6e61 6d65 203d 205f  ():.    name = _
-0000fd20: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-0000fd30: 2829 0a20 2020 2074 6573 7420 3d20 5f67  ().    test = _g
-0000fd40: 6574 5f63 616e 6365 6c5f 7461 736b 5f77  et_cancel_task_w
-0000fd50: 6974 685f 636c 6f75 6428 6e61 6d65 2c20  ith_cloud(name, 
-0000fd60: 2761 7773 2729 0a20 2020 2072 756e 5f6f  'aws').    run_o
-0000fd70: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-0000fd80: 4070 7974 6573 742e 6d61 726b 2e67 6370  @pytest.mark.gcp
-0000fd90: 0a40 7079 7465 7374 2e6d 6172 6b2e 736b  .@pytest.mark.sk
-0000fda0: 6970 280a 2020 2020 7265 6173 6f6e 3d27  ip(.    reason='
-0000fdb0: 5468 6520 7265 736e 6574 5f61 7070 2069  The resnet_app i
-0000fdc0: 7320 666c 616b 792c 2064 7565 2074 6f20  s flaky, due to 
-0000fdd0: 5446 2066 6169 6c69 6e67 2074 6f20 6465  TF failing to de
-0000fde0: 7465 6374 2047 5055 732e 2729 0a64 6566  tect GPUs.').def
-0000fdf0: 2074 6573 745f 6361 6e63 656c 5f67 6370   test_cancel_gcp
-0000fe00: 2829 3a0a 2020 2020 6e61 6d65 203d 205f  ():.    name = _
-0000fe10: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-0000fe20: 2829 0a20 2020 2074 6573 7420 3d20 5f67  ().    test = _g
-0000fe30: 6574 5f63 616e 6365 6c5f 7461 736b 5f77  et_cancel_task_w
-0000fe40: 6974 685f 636c 6f75 6428 6e61 6d65 2c20  ith_cloud(name, 
-0000fe50: 2767 6370 2729 0a20 2020 2072 756e 5f6f  'gcp').    run_o
-0000fe60: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-0000fe70: 4070 7974 6573 742e 6d61 726b 2e61 7a75  @pytest.mark.azu
-0000fe80: 7265 0a40 7079 7465 7374 2e6d 6172 6b2e  re.@pytest.mark.
-0000fe90: 736b 6970 280a 2020 2020 7265 6173 6f6e  skip(.    reason
-0000fea0: 3d27 5468 6520 7265 736e 6574 5f61 7070  ='The resnet_app
-0000feb0: 2069 7320 666c 616b 792c 2064 7565 2074   is flaky, due t
-0000fec0: 6f20 5446 2066 6169 6c69 6e67 2074 6f20  o TF failing to 
-0000fed0: 6465 7465 6374 2047 5055 732e 2729 0a64  detect GPUs.').d
-0000fee0: 6566 2074 6573 745f 6361 6e63 656c 5f61  ef test_cancel_a
-0000fef0: 7a75 7265 2829 3a0a 2020 2020 6e61 6d65  zure():.    name
-0000ff00: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
-0000ff10: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
-0000ff20: 3d20 5f67 6574 5f63 616e 6365 6c5f 7461  = _get_cancel_ta
-0000ff30: 736b 5f77 6974 685f 636c 6f75 6428 6e61  sk_with_cloud(na
-0000ff40: 6d65 2c20 2761 7a75 7265 272c 2074 696d  me, 'azure', tim
-0000ff50: 656f 7574 3d33 3020 2a20 3630 290a 2020  eout=30 * 60).  
-0000ff60: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-0000ff70: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
-0000ff80: 6172 6b2e 6e6f 5f6c 616d 6264 615f 636c  ark.no_lambda_cl
-0000ff90: 6f75 6420 2023 204c 616d 6264 6120 436c  oud  # Lambda Cl
-0000ffa0: 6f75 6420 646f 6573 206e 6f74 2068 6176  oud does not hav
-0000ffb0: 6520 5631 3030 2067 7075 730a 4070 7974  e V100 gpus.@pyt
-0000ffc0: 6573 742e 6d61 726b 2e6e 6f5f 6962 6d20  est.mark.no_ibm 
-0000ffd0: 2023 2049 424d 2063 6c6f 7564 2063 7572   # IBM cloud cur
-0000ffe0: 7265 6e74 6c79 2064 6f65 736e 2774 2070  rently doesn't p
-0000fff0: 726f 7669 6465 2070 7562 6c69 6320 696d  rovide public im
-00010000: 6167 6520 7769 7468 2043 5544 410a 4070  age with CUDA.@p
-00010010: 7974 6573 742e 6d61 726b 2e6e 6f5f 7363  ytest.mark.no_sc
-00010020: 7020 2023 2053 4350 2064 6f65 7320 6e6f  p  # SCP does no
-00010030: 7420 7375 7070 6f72 7420 6e75 6d5f 6e6f  t support num_no
-00010040: 6465 7320 3e20 3120 7965 740a 6465 6620  des > 1 yet.def 
-00010050: 7465 7374 5f63 616e 6365 6c5f 7079 746f  test_cancel_pyto
-00010060: 7263 6828 6765 6e65 7269 635f 636c 6f75  rch(generic_clou
-00010070: 643a 2073 7472 293a 0a20 2020 206e 616d  d: str):.    nam
-00010080: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-00010090: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-000100a0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-000100b0: 2027 6361 6e63 656c 2d70 7974 6f72 6368   'cancel-pytorch
-000100c0: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-000100d0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-000100e0: 6175 6e63 6820 2d63 207b 6e61 6d65 7d20  aunch -c {name} 
-000100f0: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
-00010100: 5f63 6c6f 7564 7d20 6578 616d 706c 6573  _cloud} examples
-00010110: 2f72 6573 6e65 745f 6469 7374 7269 6275  /resnet_distribu
-00010120: 7465 645f 746f 7263 682e 7961 6d6c 202d  ted_torch.yaml -
-00010130: 7920 2d64 272c 0a20 2020 2020 2020 2020  y -d',.         
-00010140: 2020 2023 2057 6169 7420 7468 6520 4750     # Wait the GP
-00010150: 5520 7072 6f63 6573 7320 746f 2073 7461  U process to sta
-00010160: 7274 2e0a 2020 2020 2020 2020 2020 2020  rt..            
-00010170: 2773 6c65 6570 2039 3027 2c0a 2020 2020  'sleep 90',.    
-00010180: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-00010190: 6563 207b 6e61 6d65 7d20 226e 7669 6469  ec {name} "nvidi
-000101a0: 612d 736d 6920 7c20 6772 6570 2070 7974  a-smi | grep pyt
-000101b0: 686f 6e22 272c 0a20 2020 2020 2020 2020  hon"',.         
-000101c0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-000101d0: 616d 657d 2032 202d 2d73 7461 7475 7327  ame} 2 --status'
-000101e0: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
-000101f0: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
-00010200: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00010210: 2063 616e 6365 6c20 2d79 207b 6e61 6d65   cancel -y {name
-00010220: 7d20 3127 2c0a 2020 2020 2020 2020 2020  } 1',.          
-00010230: 2020 2773 6c65 6570 2036 3027 2c0a 2020    'sleep 60',.  
-00010240: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00010250: 6578 6563 207b 6e61 6d65 7d20 2228 6e76  exec {name} "(nv
-00010260: 6964 6961 2d73 6d69 207c 2067 7265 7020  idia-smi | grep 
-00010270: 5c27 4e6f 2072 756e 6e69 6e67 2070 726f  \'No running pro
-00010280: 6365 7373 5c27 2920 7c7c 2027 0a20 2020  cess\') || '.   
-00010290: 2020 2020 2020 2020 2023 2045 6e73 7572           # Ensur
-000102a0: 6520 586f 7267 2069 7320 7468 6520 6f6e  e Xorg is the on
-000102b0: 6c79 2070 726f 6365 7373 2072 756e 6e69  ly process runni
-000102c0: 6e67 2e0a 2020 2020 2020 2020 2020 2020  ng..            
-000102d0: 275b 205c 2428 6e76 6964 6961 2d73 6d69  '[ \$(nvidia-smi
-000102e0: 207c 2067 7265 7020 2d41 2031 3020 5072   | grep -A 10 Pr
-000102f0: 6f63 6573 7365 7320 7c20 6772 6570 202d  ocesses | grep -
-00010300: 4120 3130 203d 3d3d 207c 2067 7265 7020  A 10 === | grep 
-00010310: 2d76 2058 6f72 6729 202d 6571 2032 205d  -v Xorg) -eq 2 ]
-00010320: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-00010330: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-00010340: 7d20 3320 2d2d 7374 6174 7573 272c 2020  } 3 --status',  
-00010350: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
-00010360: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
-00010370: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
-00010380: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
-00010390: 6d65 7d27 2c0a 2020 2020 2020 2020 7469  me}',.        ti
-000103a0: 6d65 6f75 743d 3230 202a 2036 302c 0a20  meout=20 * 60,. 
-000103b0: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-000103c0: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
-000103d0: 6361 6e27 7420 7573 6520 605f 6765 745f  can't use `_get_
-000103e0: 6361 6e63 656c 5f74 6173 6b5f 7769 7468  cancel_task_with
-000103f0: 5f63 6c6f 7564 2829 602c 2061 7320 636f  _cloud()`, as co
-00010400: 6d6d 616e 6420 606e 7669 6469 612d 736d  mmand `nvidia-sm
-00010410: 6960 0a23 2072 6571 7569 7265 7320 6120  i`.# requires a 
-00010420: 4355 4441 2070 7562 6c69 6320 696d 6167  CUDA public imag
-00010430: 652c 2077 6869 6368 2049 424d 2064 6f65  e, which IBM doe
-00010440: 736e 2774 206f 6666 6572 0a40 7079 7465  sn't offer.@pyte
-00010450: 7374 2e6d 6172 6b2e 6962 6d0a 6465 6620  st.mark.ibm.def 
-00010460: 7465 7374 5f63 616e 6365 6c5f 6962 6d28  test_cancel_ibm(
-00010470: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
-00010480: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
-00010490: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
-000104a0: 7428 0a20 2020 2020 2020 2027 6962 6d2d  t(.        'ibm-
-000104b0: 6361 6e63 656c 2d74 6173 6b27 2c0a 2020  cancel-task',.  
-000104c0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-000104d0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
-000104e0: 202d 7920 2d63 207b 6e61 6d65 7d20 2d2d   -y -c {name} --
-000104f0: 636c 6f75 6420 6962 6d20 6578 616d 706c  cloud ibm exampl
-00010500: 6573 2f6d 696e 696d 616c 2e79 616d 6c27  es/minimal.yaml'
-00010510: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00010520: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
-00010530: 2d6e 207b 6e61 6d65 7d2d 3120 2d64 2020  -n {name}-1 -d  
-00010540: 2277 6869 6c65 2074 7275 653b 2064 6f20  "while true; do 
-00010550: 6563 686f 205c 2748 656c 6c6f 2053 6b79  echo \'Hello Sky
-00010560: 5069 6c6f 745c 273b 2073 6c65 6570 2032  Pilot\'; sleep 2
-00010570: 3b20 646f 6e65 2227 2c0a 2020 2020 2020  ; done"',.      
-00010580: 2020 2020 2020 2773 6c65 6570 2032 3027        'sleep 20'
-00010590: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-000105a0: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
-000105b0: 207c 2067 7265 7020 7b6e 616d 657d 2d31   | grep {name}-1
-000105c0: 207c 2067 7265 7020 5255 4e4e 494e 4727   | grep RUNNING'
-000105d0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-000105e0: 736b 7920 6361 6e63 656c 202d 7920 7b6e  sky cancel -y {n
-000105f0: 616d 657d 2032 272c 0a20 2020 2020 2020  ame} 2',.       
-00010600: 2020 2020 2066 2773 6c65 6570 2035 272c       f'sleep 5',
-00010610: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00010620: 6b79 2071 7565 7565 207b 6e61 6d65 7d20  ky queue {name} 
-00010630: 7c20 6772 6570 207b 6e61 6d65 7d2d 3120  | grep {name}-1 
-00010640: 7c20 6772 6570 2043 414e 4345 4c4c 4544  | grep CANCELLED
-00010650: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
-00010660: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
-00010670: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-00010680: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
-00010690: 6573 7428 7465 7374 290a 0a0a 2320 2d2d  est(test)...# --
-000106a0: 2d2d 2d2d 2d2d 2d2d 2054 6573 7469 6e67  -------- Testing
-000106b0: 2075 7365 2d73 706f 7420 6f70 7469 6f6e   use-spot option
-000106c0: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974   ----------.@pyt
-000106d0: 6573 742e 6d61 726b 2e6e 6f5f 6c61 6d62  est.mark.no_lamb
-000106e0: 6461 5f63 6c6f 7564 2020 2320 4c61 6d62  da_cloud  # Lamb
-000106f0: 6461 2043 6c6f 7564 2064 6f65 7320 6e6f  da Cloud does no
-00010700: 7420 7375 7070 6f72 7420 7370 6f74 2069  t support spot i
-00010710: 6e73 7461 6e63 6573 0a40 7079 7465 7374  nstances.@pytest
-00010720: 2e6d 6172 6b2e 6e6f 5f69 626d 2020 2320  .mark.no_ibm  # 
-00010730: 4942 4d20 436c 6f75 6420 646f 6573 206e  IBM Cloud does n
-00010740: 6f74 2073 7570 706f 7274 2073 706f 7420  ot support spot 
-00010750: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
-00010760: 742e 6d61 726b 2e6e 6f5f 7363 7020 2023  t.mark.no_scp  #
-00010770: 2053 4350 2064 6f65 7320 6e6f 7420 7375   SCP does not su
-00010780: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
-00010790: 6e63 6573 0a64 6566 2074 6573 745f 7573  nces.def test_us
-000107a0: 655f 7370 6f74 2867 656e 6572 6963 5f63  e_spot(generic_c
-000107b0: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
-000107c0: 2222 2254 6573 7420 7573 652d 7370 6f74  """Test use-spot
-000107d0: 2061 6e64 2073 6b79 2065 7865 632e 2222   and sky exec.""
-000107e0: 220a 2020 2020 6e61 6d65 203d 205f 6765  ".    name = _ge
-000107f0: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
-00010800: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
-00010810: 280a 2020 2020 2020 2020 2775 7365 2d73  (.        'use-s
-00010820: 706f 7427 2c0a 2020 2020 2020 2020 5b0a  pot',.        [.
-00010830: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00010840: 7920 6c61 756e 6368 202d 6320 7b6e 616d  y launch -c {nam
-00010850: 657d 202d 2d63 6c6f 7564 207b 6765 6e65  e} --cloud {gene
-00010860: 7269 635f 636c 6f75 647d 2074 6573 7473  ric_cloud} tests
-00010870: 2f74 6573 745f 7961 6d6c 732f 6d69 6e69  /test_yamls/mini
-00010880: 6d61 6c2e 7961 6d6c 202d 2d75 7365 2d73  mal.yaml --use-s
-00010890: 706f 7420 2d79 272c 0a20 2020 2020 2020  pot -y',.       
-000108a0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-000108b0: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
-000108c0: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
-000108d0: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
-000108e0: 7d20 6563 686f 2068 6927 2c0a 2020 2020  } echo hi',.    
-000108f0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-00010900: 6773 207b 6e61 6d65 7d20 3220 2d2d 7374  gs {name} 2 --st
-00010910: 6174 7573 272c 0a20 2020 2020 2020 205d  atus',.        ]
-00010920: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
-00010930: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
-00010940: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
-00010950: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-00010960: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573  # ---------- Tes
-00010970: 7469 6e67 206d 616e 6167 6564 2073 706f  ting managed spo
-00010980: 7420 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079  t ----------.@py
-00010990: 7465 7374 2e6d 6172 6b2e 6e6f 5f6c 616d  test.mark.no_lam
-000109a0: 6264 615f 636c 6f75 6420 2023 204c 616d  bda_cloud  # Lam
-000109b0: 6264 6120 436c 6f75 6420 646f 6573 206e  bda Cloud does n
-000109c0: 6f74 2073 7570 706f 7274 2073 706f 7420  ot support spot 
-000109d0: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
-000109e0: 742e 6d61 726b 2e6e 6f5f 6962 6d20 2023  t.mark.no_ibm  #
-000109f0: 2049 424d 2043 6c6f 7564 2064 6f65 7320   IBM Cloud does 
-00010a00: 6e6f 7420 7375 7070 6f72 7420 7370 6f74  not support spot
-00010a10: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
-00010a20: 7374 2e6d 6172 6b2e 6e6f 5f73 6370 2020  st.mark.no_scp  
-00010a30: 2320 5343 5020 646f 6573 206e 6f74 2073  # SCP does not s
-00010a40: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
-00010a50: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
-00010a60: 726b 2e6d 616e 6167 6564 5f73 706f 740a  rk.managed_spot.
-00010a70: 6465 6620 7465 7374 5f73 706f 7428 6765  def test_spot(ge
-00010a80: 6e65 7269 635f 636c 6f75 643a 2073 7472  neric_cloud: str
-00010a90: 293a 0a20 2020 2022 2222 5465 7374 2074  ):.    """Test t
-00010aa0: 6865 2073 706f 7420 7961 6d6c 2e22 2222  he spot yaml."""
-00010ab0: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-00010ac0: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
-00010ad0: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-00010ae0: 0a20 2020 2020 2020 2027 6d61 6e61 6765  .        'manage
-00010af0: 642d 7370 6f74 272c 0a20 2020 2020 2020  d-spot',.       
-00010b00: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-00010b10: 2773 6b79 2073 706f 7420 6c61 756e 6368  'sky spot launch
-00010b20: 202d 6e20 7b6e 616d 657d 2d31 202d 2d63   -n {name}-1 --c
-00010b30: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
-00010b40: 6f75 647d 2065 7861 6d70 6c65 732f 6d61  oud} examples/ma
-00010b50: 6e61 6765 645f 7370 6f74 2e79 616d 6c20  naged_spot.yaml 
-00010b60: 2d79 202d 6427 2c0a 2020 2020 2020 2020  -y -d',.        
-00010b70: 2020 2020 6627 736b 7920 7370 6f74 206c      f'sky spot l
-00010b80: 6175 6e63 6820 2d6e 207b 6e61 6d65 7d2d  aunch -n {name}-
-00010b90: 3220 2d2d 636c 6f75 6420 7b67 656e 6572  2 --cloud {gener
-00010ba0: 6963 5f63 6c6f 7564 7d20 6578 616d 706c  ic_cloud} exampl
-00010bb0: 6573 2f6d 616e 6167 6564 5f73 706f 742e  es/managed_spot.
-00010bc0: 7961 6d6c 202d 7920 2d64 272c 0a20 2020  yaml -y -d',.   
-00010bd0: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-00010be0: 3527 2c0a 2020 2020 2020 2020 2020 2020  5',.            
-00010bf0: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
-00010c00: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
-00010c10: 7d2d 3120 7c20 6865 6164 202d 6e31 207c  }-1 | head -n1 |
-00010c20: 2067 7265 7020 2253 5441 5254 494e 475c   grep "STARTING\
-00010c30: 7c52 554e 4e49 4e47 2227 2c0a 2020 2020  |RUNNING"',.    
-00010c40: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
-00010c50: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
-00010c60: 6570 207b 6e61 6d65 7d2d 3220 7c20 6865  ep {name}-2 | he
-00010c70: 6164 202d 6e31 207c 2067 7265 7020 2253  ad -n1 | grep "S
-00010c80: 5441 5254 494e 475c 7c52 554e 4e49 4e47  TARTING\|RUNNING
-00010c90: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-00010ca0: 5f53 504f 545f 4341 4e43 454c 5f57 4149  _SPOT_CANCEL_WAI
-00010cb0: 542e 666f 726d 6174 286a 6f62 5f6e 616d  T.format(job_nam
-00010cc0: 653d 6627 7b6e 616d 657d 2d31 2729 2c0a  e=f'{name}-1'),.
-00010cd0: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
-00010ce0: 6570 2035 272c 0a20 2020 2020 2020 2020  ep 5',.         
-00010cf0: 2020 2066 277b 5f53 504f 545f 5155 4555     f'{_SPOT_QUEU
-00010d00: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
-00010d10: 616d 657d 2d31 207c 2068 6561 6420 2d6e  ame}-1 | head -n
-00010d20: 3120 7c20 6772 6570 2022 4341 4e43 454c  1 | grep "CANCEL
-00010d30: 4c49 4e47 5c7c 4341 4e43 454c 4c45 4422  LING\|CANCELLED"
-00010d40: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-00010d50: 736c 6565 7020 3230 3027 2c0a 2020 2020  sleep 200',.    
-00010d60: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
-00010d70: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
-00010d80: 6570 207b 6e61 6d65 7d2d 3120 7c20 6865  ep {name}-1 | he
-00010d90: 6164 202d 6e31 207c 2067 7265 7020 4341  ad -n1 | grep CA
-00010da0: 4e43 454c 4c45 4427 2c0a 2020 2020 2020  NCELLED',.      
-00010db0: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
-00010dc0: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
-00010dd0: 207b 6e61 6d65 7d2d 3220 7c20 6865 6164   {name}-2 | head
-00010de0: 202d 6e31 207c 2067 7265 7020 2252 554e   -n1 | grep "RUN
-00010df0: 4e49 4e47 5c7c 5355 4343 4545 4445 4422  NING\|SUCCEEDED"
-00010e00: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
-00010e10: 2020 2020 2020 2320 544f 444f 287a 6877        # TODO(zhw
-00010e20: 7529 3a20 4368 616e 6765 2074 6f20 5f53  u): Change to _S
-00010e30: 504f 545f 4341 4e43 454c 5f57 4149 542e  POT_CANCEL_WAIT.
-00010e40: 666f 726d 6174 286a 6f62 5f6e 616d 653d  format(job_name=
-00010e50: 6627 7b6e 616d 657d 2d31 202d 6e20 7b6e  f'{name}-1 -n {n
-00010e60: 616d 657d 2d32 2729 2077 6865 6e0a 2020  ame}-2') when.  
-00010e70: 2020 2020 2020 2320 6361 6e63 656c 696e        # cancelin
-00010e80: 6720 6d75 6c74 6970 6c65 206a 6f62 206e  g multiple job n
-00010e90: 616d 6573 2069 7320 7375 7070 6f72 7465  ames is supporte
-00010ea0: 642e 0a20 2020 2020 2020 2028 5f53 504f  d..        (_SPO
-00010eb0: 545f 4341 4e43 454c 5f57 4149 542e 666f  T_CANCEL_WAIT.fo
-00010ec0: 726d 6174 286a 6f62 5f6e 616d 653d 6627  rmat(job_name=f'
-00010ed0: 7b6e 616d 657d 2d31 2729 202b 2027 3b20  {name}-1') + '; 
-00010ee0: 2720 2b0a 2020 2020 2020 2020 205f 5350  ' +.         _SP
-00010ef0: 4f54 5f43 414e 4345 4c5f 5741 4954 2e66  OT_CANCEL_WAIT.f
-00010f00: 6f72 6d61 7428 6a6f 625f 6e61 6d65 3d66  ormat(job_name=f
-00010f10: 277b 6e61 6d65 7d2d 3227 2929 2c0a 2020  '{name}-2')),.  
-00010f20: 2020 2020 2020 2320 496e 6372 6561 7365        # Increase
-00010f30: 2074 696d 656f 7574 2073 696e 6365 2073   timeout since s
-00010f40: 6b79 2073 706f 7420 7175 6575 6520 2d72  ky spot queue -r
-00010f50: 2063 616e 2062 6520 626c 6f63 6b65 6420   can be blocked 
-00010f60: 6279 206f 7468 6572 2073 706f 7420 7465  by other spot te
-00010f70: 7374 732e 0a20 2020 2020 2020 2074 696d  sts..        tim
-00010f80: 656f 7574 3d32 3020 2a20 3630 2c0a 2020  eout=20 * 60,.  
-00010f90: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-00010fa0: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
-00010fb0: 7465 7374 2e6d 6172 6b2e 6e6f 5f6c 616d  test.mark.no_lam
-00010fc0: 6264 615f 636c 6f75 6420 2023 204c 616d  bda_cloud  # Lam
-00010fd0: 6264 6120 436c 6f75 6420 646f 6573 206e  bda Cloud does n
-00010fe0: 6f74 2073 7570 706f 7274 2073 706f 7420  ot support spot 
-00010ff0: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
-00011000: 742e 6d61 726b 2e6e 6f5f 6962 6d20 2023  t.mark.no_ibm  #
-00011010: 2049 424d 2043 6c6f 7564 2064 6f65 7320   IBM Cloud does 
-00011020: 6e6f 7420 7375 7070 6f72 7420 7370 6f74  not support spot
-00011030: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
-00011040: 7374 2e6d 6172 6b2e 6e6f 5f73 6370 2020  st.mark.no_scp  
-00011050: 2320 5343 5020 646f 6573 206e 6f74 2073  # SCP does not s
-00011060: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
-00011070: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
-00011080: 726b 2e6d 616e 6167 6564 5f73 706f 740a  rk.managed_spot.
-00011090: 6465 6620 7465 7374 5f73 706f 745f 7069  def test_spot_pi
-000110a0: 7065 6c69 6e65 2867 656e 6572 6963 5f63  peline(generic_c
-000110b0: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
-000110c0: 2222 2254 6573 7420 6120 7370 6f74 c2a0  """Test a spot..
-000110d0: 7069 7065 6c69 6e65 2e22 2222 0a20 2020  pipeline.""".   
-000110e0: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
-000110f0: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
-00011100: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-00011110: 2020 2020 2027 7370 6f74 2d70 6970 656c       'spot-pipel
-00011120: 696e 6527 2c0a 2020 2020 2020 2020 5b0a  ine',.        [.
-00011130: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00011140: 7920 7370 6f74 206c 6175 6e63 6820 2d6e  y spot launch -n
-00011150: 207b 6e61 6d65 7d20 7465 7374 732f 7465   {name} tests/te
-00011160: 7374 5f79 616d 6c73 2f70 6970 656c 696e  st_yamls/pipelin
-00011170: 652e 7961 6d6c 202d 7920 2d64 272c 0a20  e.yaml -y -d',. 
-00011180: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-00011190: 7020 3527 2c0a 2020 2020 2020 2020 2020  p 5',.          
-000111a0: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
-000111b0: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
-000111c0: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
-000111d0: 2067 7265 7020 2253 5441 5254 494e 475c   grep "STARTING\
-000111e0: 7c52 554e 4e49 4e47 2227 2c0a 2020 2020  |RUNNING"',.    
-000111f0: 2020 2020 2020 2020 2320 6067 7265 7020          # `grep 
-00011200: 2d41 2034 207b 6e61 6d65 7d60 2066 696e  -A 4 {name}` fin
-00011210: 6473 2074 6865 206a 6f62 2077 6974 6820  ds the job with 
-00011220: 7b6e 616d 657d 2061 6e64 2074 6865 2034  {name} and the 4
-00011230: 206c 696e 6573 0a20 2020 2020 2020 2020   lines.         
-00011240: 2020 2023 2061 6674 6572 2069 742c 2069     # after it, i
-00011250: 2e65 2e20 7468 6520 3420 7461 736b 7320  .e. the 4 tasks 
-00011260: 7769 7468 696e 2074 6865 206a 6f62 2e0a  within the job..
-00011270: 2020 2020 2020 2020 2020 2020 2320 6073              # `s
-00011280: 6564 202d 6e20 3270 6020 6765 7473 2074  ed -n 2p` gets t
-00011290: 6865 2073 6563 6f6e 6420 6c69 6e65 206f  he second line o
-000112a0: 6620 7468 6520 3420 6c69 6e65 732c 2069  f the 4 lines, i
-000112b0: 2e65 2e20 7468 6520 6669 7273 740a 2020  .e. the first.  
-000112c0: 2020 2020 2020 2020 2020 2320 7461 736b            # task
-000112d0: 2077 6974 6869 6e20 7468 6520 6a6f 622e   within the job.
-000112e0: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
-000112f0: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
-00011300: 7d7c 2067 7265 7020 2d41 2034 207b 6e61  }| grep -A 4 {na
-00011310: 6d65 7d7c 2073 6564 202d 6e20 3270 207c  me}| sed -n 2p |
-00011320: 2067 7265 7020 2253 5441 5254 494e 475c   grep "STARTING\
-00011330: 7c52 554e 4e49 4e47 2227 2c0a 2020 2020  |RUNNING"',.    
-00011340: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
-00011350: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
-00011360: 6570 202d 4120 3420 7b6e 616d 657d 7c20  ep -A 4 {name}| 
-00011370: 7365 6420 2d6e 2033 7020 7c20 6772 6570  sed -n 3p | grep
-00011380: 2022 5045 4e44 494e 4722 272c 0a20 2020   "PENDING"',.   
-00011390: 2020 2020 2020 2020 205f 5350 4f54 5f43           _SPOT_C
-000113a0: 414e 4345 4c5f 5741 4954 2e66 6f72 6d61  ANCEL_WAIT.forma
-000113b0: 7428 6a6f 625f 6e61 6d65 3d66 277b 6e61  t(job_name=f'{na
-000113c0: 6d65 7d27 292c 0a20 2020 2020 2020 2020  me}'),.         
-000113d0: 2020 2027 736c 6565 7020 3527 2c0a 2020     'sleep 5',.  
-000113e0: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
-000113f0: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
-00011400: 6772 6570 202d 4120 3420 7b6e 616d 657d  grep -A 4 {name}
-00011410: 7c20 7365 6420 2d6e 2032 7020 7c20 6772  | sed -n 2p | gr
-00011420: 6570 2022 4341 4e43 454c 4c49 4e47 5c7c  ep "CANCELLING\|
-00011430: 4341 4e43 454c 4c45 4422 272c 0a20 2020  CANCELLED"',.   
-00011440: 2020 2020 2020 2020 2066 277b 5f53 504f           f'{_SPO
-00011450: 545f 5155 4555 455f 5741 4954 7d7c 2067  T_QUEUE_WAIT}| g
-00011460: 7265 7020 2d41 2034 207b 6e61 6d65 7d7c  rep -A 4 {name}|
-00011470: 2073 6564 202d 6e20 3370 207c 2067 7265   sed -n 3p | gre
-00011480: 7020 2243 414e 4345 4c4c 494e 475c 7c43  p "CANCELLING\|C
-00011490: 414e 4345 4c4c 4544 2227 2c0a 2020 2020  ANCELLED"',.    
-000114a0: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
-000114b0: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
-000114c0: 6570 202d 4120 3420 7b6e 616d 657d 7c20  ep -A 4 {name}| 
-000114d0: 7365 6420 2d6e 2034 7020 7c20 6772 6570  sed -n 4p | grep
-000114e0: 2022 4341 4e43 454c 4c49 4e47 5c7c 4341   "CANCELLING\|CA
-000114f0: 4e43 454c 4c45 4422 272c 0a20 2020 2020  NCELLED"',.     
-00011500: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
-00011510: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
-00011520: 7020 2d41 2034 207b 6e61 6d65 7d7c 2073  p -A 4 {name}| s
-00011530: 6564 202d 6e20 3570 207c 2067 7265 7020  ed -n 5p | grep 
-00011540: 2243 414e 4345 4c4c 494e 475c 7c43 414e  "CANCELLING\|CAN
-00011550: 4345 4c4c 4544 2227 2c0a 2020 2020 2020  CELLED"',.      
-00011560: 2020 2020 2020 2773 6c65 6570 2032 3030        'sleep 200
-00011570: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00011580: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
-00011590: 4954 7d7c 2067 7265 7020 2d41 2034 207b  IT}| grep -A 4 {
-000115a0: 6e61 6d65 7d7c 2073 6564 202d 6e20 3270  name}| sed -n 2p
-000115b0: 207c 2067 7265 7020 2243 414e 4345 4c4c   | grep "CANCELL
-000115c0: 4544 2227 2c0a 2020 2020 2020 2020 2020  ED"',.          
-000115d0: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
-000115e0: 5f57 4149 547d 7c20 6772 6570 202d 4120  _WAIT}| grep -A 
-000115f0: 3420 7b6e 616d 657d 7c20 7365 6420 2d6e  4 {name}| sed -n
-00011600: 2033 7020 7c20 6772 6570 2022 4341 4e43   3p | grep "CANC
-00011610: 454c 4c45 4422 272c 0a20 2020 2020 2020  ELLED"',.       
-00011620: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
-00011630: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
-00011640: 2d41 2034 207b 6e61 6d65 7d7c 2073 6564  -A 4 {name}| sed
-00011650: 202d 6e20 3470 207c 2067 7265 7020 2243   -n 4p | grep "C
-00011660: 414e 4345 4c4c 4544 2227 2c0a 2020 2020  ANCELLED"',.    
-00011670: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
-00011680: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
-00011690: 6570 202d 4120 3420 7b6e 616d 657d 7c20  ep -A 4 {name}| 
-000116a0: 7365 6420 2d6e 2035 7020 7c20 6772 6570  sed -n 5p | grep
-000116b0: 2022 4341 4e43 454c 4c45 4422 272c 0a20   "CANCELLED"',. 
-000116c0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-000116d0: 2020 5f53 504f 545f 4341 4e43 454c 5f57    _SPOT_CANCEL_W
-000116e0: 4149 542e 666f 726d 6174 286a 6f62 5f6e  AIT.format(job_n
-000116f0: 616d 653d 6627 7b6e 616d 657d 2729 2c0a  ame=f'{name}'),.
-00011700: 2020 2020 2020 2020 2320 496e 6372 6561          # Increa
-00011710: 7365 2074 696d 656f 7574 2073 696e 6365  se timeout since
-00011720: 2073 6b79 2073 706f 7420 7175 6575 6520   sky spot queue 
-00011730: 2d72 2063 616e 2062 6520 626c 6f63 6b65  -r can be blocke
-00011740: 6420 6279 206f 7468 6572 2073 706f 7420  d by other spot 
-00011750: 7465 7374 732e 0a20 2020 2020 2020 2074  tests..        t
-00011760: 696d 656f 7574 3d33 3020 2a20 3630 2c0a  imeout=30 * 60,.
-00011770: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-00011780: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
-00011790: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f6c  pytest.mark.no_l
-000117a0: 616d 6264 615f 636c 6f75 6420 2023 204c  ambda_cloud  # L
-000117b0: 616d 6264 6120 436c 6f75 6420 646f 6573  ambda Cloud does
-000117c0: 206e 6f74 2073 7570 706f 7274 2073 706f   not support spo
-000117d0: 7420 696e 7374 616e 6365 730a 4070 7974  t instances.@pyt
-000117e0: 6573 742e 6d61 726b 2e6e 6f5f 6962 6d20  est.mark.no_ibm 
-000117f0: 2023 2049 424d 2043 6c6f 7564 2064 6f65   # IBM Cloud doe
-00011800: 7320 6e6f 7420 7375 7070 6f72 7420 7370  s not support sp
-00011810: 6f74 2069 6e73 7461 6e63 6573 0a40 7079  ot instances.@py
-00011820: 7465 7374 2e6d 6172 6b2e 6e6f 5f73 6370  test.mark.no_scp
-00011830: 2020 2320 5343 5020 646f 6573 206e 6f74    # SCP does not
-00011840: 2073 7570 706f 7274 2073 706f 7420 696e   support spot in
-00011850: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
-00011860: 6d61 726b 2e6d 616e 6167 6564 5f73 706f  mark.managed_spo
-00011870: 740a 6465 6620 7465 7374 5f73 706f 745f  t.def test_spot_
-00011880: 6661 696c 6564 5f73 6574 7570 2867 656e  failed_setup(gen
-00011890: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
-000118a0: 3a0a 2020 2020 2222 2254 6573 7420 6d61  :.    """Test ma
-000118b0: 6e61 6765 6420 7370 6f74 206a 6f62 2077  naged spot job w
-000118c0: 6974 6820 6661 696c 6564 2073 6574 7570  ith failed setup
-000118d0: 2e22 2222 0a20 2020 206e 616d 6520 3d20  .""".    name = 
-000118e0: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-000118f0: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
-00011900: 6573 7428 0a20 2020 2020 2020 2027 7370  est(.        'sp
-00011910: 6f74 5f66 6169 6c65 645f 7365 7475 7027  ot_failed_setup'
-00011920: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-00011930: 2020 2020 2020 2020 6627 736b 7920 7370          f'sky sp
-00011940: 6f74 206c 6175 6e63 6820 2d6e 207b 6e61  ot launch -n {na
-00011950: 6d65 7d20 2d2d 636c 6f75 6420 7b67 656e  me} --cloud {gen
-00011960: 6572 6963 5f63 6c6f 7564 7d20 2d79 202d  eric_cloud} -y -
-00011970: 6420 7465 7374 732f 7465 7374 5f79 616d  d tests/test_yam
-00011980: 6c73 2f66 6169 6c65 645f 7365 7475 702e  ls/failed_setup.
-00011990: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-000119a0: 2020 2027 736c 6565 7020 3333 3027 2c0a     'sleep 330',.
-000119b0: 2020 2020 2020 2020 2020 2020 2320 4d61              # Ma
-000119c0: 6b65 2073 7572 6520 7468 6520 6a6f 6220  ke sure the job 
-000119d0: 6661 696c 6564 2071 7569 636b 6c79 2e0a  failed quickly..
-000119e0: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
-000119f0: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
-00011a00: 207c 2067 7265 7020 7b6e 616d 657d 207c   | grep {name} |
-00011a10: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
-00011a20: 2022 4641 494c 4544 5f53 4554 5550 2227   "FAILED_SETUP"'
-00011a30: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
-00011a40: 2020 2020 205f 5350 4f54 5f43 414e 4345       _SPOT_CANCE
-00011a50: 4c5f 5741 4954 2e66 6f72 6d61 7428 6a6f  L_WAIT.format(jo
-00011a60: 625f 6e61 6d65 3d6e 616d 6529 2c0a 2020  b_name=name),.  
-00011a70: 2020 2020 2020 2320 496e 6372 6561 7365        # Increase
-00011a80: 2074 696d 656f 7574 2073 696e 6365 2073   timeout since s
-00011a90: 6b79 2073 706f 7420 7175 6575 6520 2d72  ky spot queue -r
-00011aa0: 2063 616e 2062 6520 626c 6f63 6b65 6420   can be blocked 
-00011ab0: 6279 206f 7468 6572 2073 706f 7420 7465  by other spot te
-00011ac0: 7374 732e 0a20 2020 2020 2020 2074 696d  sts..        tim
-00011ad0: 656f 7574 3d32 3020 2a20 3630 2c0a 2020  eout=20 * 60,.  
-00011ae0: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-00011af0: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
-00011b00: 7465 7374 2e6d 6172 6b2e 6e6f 5f6c 616d  test.mark.no_lam
-00011b10: 6264 615f 636c 6f75 6420 2023 204c 616d  bda_cloud  # Lam
-00011b20: 6264 6120 436c 6f75 6420 646f 6573 206e  bda Cloud does n
-00011b30: 6f74 2073 7570 706f 7274 2073 706f 7420  ot support spot 
-00011b40: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
-00011b50: 742e 6d61 726b 2e6e 6f5f 6962 6d20 2023  t.mark.no_ibm  #
-00011b60: 2049 424d 2043 6c6f 7564 2064 6f65 7320   IBM Cloud does 
-00011b70: 6e6f 7420 7375 7070 6f72 7420 7370 6f74  not support spot
-00011b80: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
-00011b90: 7374 2e6d 6172 6b2e 6e6f 5f73 6370 2020  st.mark.no_scp  
-00011ba0: 2320 5343 5020 646f 6573 206e 6f74 2073  # SCP does not s
-00011bb0: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
-00011bc0: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
-00011bd0: 726b 2e6d 616e 6167 6564 5f73 706f 740a  rk.managed_spot.
-00011be0: 6465 6620 7465 7374 5f73 706f 745f 7069  def test_spot_pi
-00011bf0: 7065 6c69 6e65 5f66 6169 6c65 645f 7365  peline_failed_se
-00011c00: 7475 7028 6765 6e65 7269 635f 636c 6f75  tup(generic_clou
-00011c10: 643a 2073 7472 293a 0a20 2020 2022 2222  d: str):.    """
-00011c20: 5465 7374 206d 616e 6167 6564 2073 706f  Test managed spo
-00011c30: 7420 6a6f 6220 7769 7468 2066 6169 6c65  t job with faile
-00011c40: 6420 7365 7475 7020 666f 7220 6120 7069  d setup for a pi
-00011c50: 7065 6c69 6e65 2e22 2222 0a20 2020 206e  peline.""".    n
-00011c60: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-00011c70: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
-00011c80: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-00011c90: 2020 2027 7370 6f74 5f70 6970 656c 696e     'spot_pipelin
-00011ca0: 655f 6661 696c 6564 5f73 6574 7570 272c  e_failed_setup',
-00011cb0: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
-00011cc0: 2020 2020 2020 2066 2773 6b79 2073 706f         f'sky spo
-00011cd0: 7420 6c61 756e 6368 202d 6e20 7b6e 616d  t launch -n {nam
-00011ce0: 657d 202d 7920 2d64 2074 6573 7473 2f74  e} -y -d tests/t
-00011cf0: 6573 745f 7961 6d6c 732f 6661 696c 6564  est_yamls/failed
-00011d00: 5f73 6574 7570 5f70 6970 656c 696e 652e  _setup_pipeline.
-00011d10: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-00011d20: 2020 2027 736c 6565 7020 3830 3027 2c0a     'sleep 800',.
-00011d30: 2020 2020 2020 2020 2020 2020 2320 4d61              # Ma
-00011d40: 6b65 2073 7572 6520 7468 6520 6a6f 6220  ke sure the job 
-00011d50: 6661 696c 6564 2071 7569 636b 6c79 2e0a  failed quickly..
-00011d60: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
-00011d70: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
-00011d80: 207c 2067 7265 7020 7b6e 616d 657d 207c   | grep {name} |
-00011d90: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
-00011da0: 2022 4641 494c 4544 5f53 4554 5550 2227   "FAILED_SETUP"'
-00011db0: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-00011dc0: 5461 736b 2030 2073 686f 756c 6420 6265  Task 0 should be
-00011dd0: 2053 5543 4345 4544 4544 2e0a 2020 2020   SUCCEEDED..    
-00011de0: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
-00011df0: 5f51 5545 5545 5f57 4149 547d 207c 2067  _QUEUE_WAIT} | g
-00011e00: 7265 7020 2d41 2034 207b 6e61 6d65 7d7c  rep -A 4 {name}|
-00011e10: 2073 6564 202d 6e20 3270 207c 2067 7265   sed -n 2p | gre
-00011e20: 7020 2253 5543 4345 4544 4544 2227 2c0a  p "SUCCEEDED"',.
-00011e30: 2020 2020 2020 2020 2020 2020 2320 5461              # Ta
-00011e40: 736b 2031 2073 686f 756c 6420 6265 2046  sk 1 should be F
-00011e50: 4149 4c45 445f 5345 5455 502e 0a20 2020  AILED_SETUP..   
-00011e60: 2020 2020 2020 2020 2066 277b 5f53 504f           f'{_SPO
-00011e70: 545f 5155 4555 455f 5741 4954 7d20 7c20  T_QUEUE_WAIT} | 
-00011e80: 6772 6570 202d 4120 3420 7b6e 616d 657d  grep -A 4 {name}
-00011e90: 7c20 7365 6420 2d6e 2033 7020 7c20 6772  | sed -n 3p | gr
-00011ea0: 6570 2022 4641 494c 4544 5f53 4554 5550  ep "FAILED_SETUP
-00011eb0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-00011ec0: 2320 5461 736b 2032 2073 686f 756c 6420  # Task 2 should 
-00011ed0: 6265 2043 414e 4345 4c4c 4544 2e0a 2020  be CANCELLED..  
-00011ee0: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
-00011ef0: 4f54 5f51 5545 5545 5f57 4149 547d 207c  OT_QUEUE_WAIT} |
-00011f00: 2067 7265 7020 2d41 2034 207b 6e61 6d65   grep -A 4 {name
-00011f10: 7d7c 2073 6564 202d 6e20 3470 207c 2067  }| sed -n 4p | g
-00011f20: 7265 7020 2243 414e 4345 4c4c 4544 2227  rep "CANCELLED"'
-00011f30: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-00011f40: 5461 736b 2033 2073 686f 756c 6420 6265  Task 3 should be
-00011f50: 2043 414e 4345 4c4c 4544 2e0a 2020 2020   CANCELLED..    
-00011f60: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
-00011f70: 5f51 5545 5545 5f57 4149 547d 207c 2067  _QUEUE_WAIT} | g
-00011f80: 7265 7020 2d41 2034 207b 6e61 6d65 7d7c  rep -A 4 {name}|
-00011f90: 2073 6564 202d 6e20 3570 207c 2067 7265   sed -n 5p | gre
-00011fa0: 7020 2243 414e 4345 4c4c 4544 2227 2c0a  p "CANCELLED"',.
-00011fb0: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-00011fc0: 2020 205f 5350 4f54 5f43 414e 4345 4c5f     _SPOT_CANCEL_
-00011fd0: 5741 4954 2e66 6f72 6d61 7428 6a6f 625f  WAIT.format(job_
-00011fe0: 6e61 6d65 3d6e 616d 6529 2c0a 2020 2020  name=name),.    
-00011ff0: 2020 2020 2320 496e 6372 6561 7365 2074      # Increase t
-00012000: 696d 656f 7574 2073 696e 6365 2073 6b79  imeout since sky
-00012010: 2073 706f 7420 7175 6575 6520 2d72 2063   spot queue -r c
-00012020: 616e 2062 6520 626c 6f63 6b65 6420 6279  an be blocked by
-00012030: 206f 7468 6572 2073 706f 7420 7465 7374   other spot test
-00012040: 732e 0a20 2020 2020 2020 2074 696d 656f  s..        timeo
-00012050: 7574 3d33 3020 2a20 3630 2c0a 2020 2020  ut=30 * 60,.    
-00012060: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-00012070: 7374 2874 6573 7429 0a0a 0a23 202d 2d2d  st(test)...# ---
-00012080: 2d2d 2d2d 2d2d 2d20 5465 7374 696e 6720  ------- Testing 
-00012090: 6d61 6e61 6765 6420 7370 6f74 2072 6563  managed spot rec
-000120a0: 6f76 6572 7920 2d2d 2d2d 2d2d 2d2d 2d2d  overy ----------
-000120b0: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
-000120c0: 6177 730a 4070 7974 6573 742e 6d61 726b  aws.@pytest.mark
-000120d0: 2e6d 616e 6167 6564 5f73 706f 740a 6465  .managed_spot.de
-000120e0: 6620 7465 7374 5f73 706f 745f 7265 636f  f test_spot_reco
-000120f0: 7665 7279 5f61 7773 2861 7773 5f63 6f6e  very_aws(aws_con
-00012100: 6669 675f 7265 6769 6f6e 293a 0a20 2020  fig_region):.   
-00012110: 2022 2222 5465 7374 206d 616e 6167 6564   """Test managed
-00012120: 2073 706f 7420 7265 636f 7665 7279 2e22   spot recovery."
-00012130: 2222 0a20 2020 206e 616d 6520 3d20 5f67  "".    name = _g
-00012140: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
-00012150: 290a 2020 2020 7265 6769 6f6e 203d 2061  ).    region = a
-00012160: 7773 5f63 6f6e 6669 675f 7265 6769 6f6e  ws_config_region
-00012170: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
-00012180: 280a 2020 2020 2020 2020 2773 706f 745f  (.        'spot_
-00012190: 7265 636f 7665 7279 5f61 7773 272c 0a20  recovery_aws',. 
-000121a0: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-000121b0: 2020 2020 2066 2773 6b79 2073 706f 7420       f'sky spot 
-000121c0: 6c61 756e 6368 202d 2d63 6c6f 7564 2061  launch --cloud a
-000121d0: 7773 202d 2d72 6567 696f 6e20 7b72 6567  ws --region {reg
-000121e0: 696f 6e7d 202d 6e20 7b6e 616d 657d 2022  ion} -n {name} "
-000121f0: 6563 686f 2053 4b59 5049 4c4f 545f 5441  echo SKYPILOT_TA
-00012200: 534b 5f49 443a 205c 2453 4b59 5049 4c4f  SK_ID: \$SKYPILO
-00012210: 545f 5441 534b 5f49 443b 2073 6c65 6570  T_TASK_ID; sleep
-00012220: 2031 3830 3022 2020 2d79 202d 6427 2c0a   1800"  -y -d',.
-00012230: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
-00012240: 6570 2033 3630 272c 0a20 2020 2020 2020  ep 360',.       
-00012250: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
-00012260: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
-00012270: 7b6e 616d 657d 207c 2068 6561 6420 2d6e  {name} | head -n
-00012280: 3120 7c20 6772 6570 2022 5255 4e4e 494e  1 | grep "RUNNIN
-00012290: 4722 272c 0a20 2020 2020 2020 2020 2020  G"',.           
-000122a0: 2066 2752 554e 5f49 443d 2428 736b 7920   f'RUN_ID=$(sky 
-000122b0: 7370 6f74 206c 6f67 7320 2d6e 207b 6e61  spot logs -n {na
-000122c0: 6d65 7d20 2d2d 6e6f 2d66 6f6c 6c6f 7720  me} --no-follow 
-000122d0: 7c20 6772 6570 2053 4b59 5049 4c4f 545f  | grep SKYPILOT_
-000122e0: 5441 534b 5f49 4420 7c20 6375 7420 2d64  TASK_ID | cut -d
-000122f0: 3a20 2d66 3229 3b20 6563 686f 2022 2452  : -f2); echo "$R
-00012300: 554e 5f49 4422 207c 2074 6565 202f 746d  UN_ID" | tee /tm
-00012310: 702f 7b6e 616d 657d 2d72 756e 2d69 6427  p/{name}-run-id'
-00012320: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-00012330: 5465 726d 696e 6174 6520 7468 6520 636c  Terminate the cl
-00012340: 7573 7465 7220 6d61 6e75 616c 6c79 2e0a  uster manually..
-00012350: 2020 2020 2020 2020 2020 2020 2866 2761              (f'a
-00012360: 7773 2065 6332 2074 6572 6d69 6e61 7465  ws ec2 terminate
-00012370: 2d69 6e73 7461 6e63 6573 202d 2d72 6567  -instances --reg
-00012380: 696f 6e20 7b72 6567 696f 6e7d 202d 2d69  ion {region} --i
-00012390: 6e73 7461 6e63 652d 6964 7320 2428 270a  nstance-ids $('.
-000123a0: 2020 2020 2020 2020 2020 2020 2066 2761               f'a
-000123b0: 7773 2065 6332 2064 6573 6372 6962 652d  ws ec2 describe-
-000123c0: 696e 7374 616e 6365 7320 2d2d 7265 6769  instances --regi
-000123d0: 6f6e 207b 7265 6769 6f6e 7d20 270a 2020  on {region} '.  
-000123e0: 2020 2020 2020 2020 2020 2066 272d 2d66             f'--f
-000123f0: 696c 7465 7273 204e 616d 653d 7461 673a  ilters Name=tag:
-00012400: 7261 792d 636c 7573 7465 722d 6e61 6d65  ray-cluster-name
-00012410: 2c56 616c 7565 733d 7b6e 616d 657d 2a20  ,Values={name}* 
-00012420: 270a 2020 2020 2020 2020 2020 2020 2066  '.             f
-00012430: 272d 2d71 7565 7279 2052 6573 6572 7661  '--query Reserva
-00012440: 7469 6f6e 735b 5d2e 496e 7374 616e 6365  tions[].Instance
-00012450: 735b 5d2e 496e 7374 616e 6365 4964 2027  s[].InstanceId '
-00012460: 0a20 2020 2020 2020 2020 2020 2020 272d  .             '-
-00012470: 2d6f 7574 7075 7420 7465 7874 2927 292c  -output text)'),
-00012480: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-00012490: 6565 7020 3130 3027 2c0a 2020 2020 2020  eep 100',.      
-000124a0: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
-000124b0: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
-000124c0: 207b 6e61 6d65 7d20 7c20 6865 6164 202d   {name} | head -
-000124d0: 6e31 207c 2067 7265 7020 2252 4543 4f56  n1 | grep "RECOV
-000124e0: 4552 494e 4722 272c 0a20 2020 2020 2020  ERING"',.       
-000124f0: 2020 2020 2027 736c 6565 7020 3230 3027       'sleep 200'
-00012500: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00012510: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
-00012520: 547d 7c20 6772 6570 207b 6e61 6d65 7d20  T}| grep {name} 
-00012530: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
-00012540: 7020 2252 554e 4e49 4e47 2227 2c0a 2020  p "RUNNING"',.  
-00012550: 2020 2020 2020 2020 2020 6627 5255 4e5f            f'RUN_
-00012560: 4944 3d24 2863 6174 202f 746d 702f 7b6e  ID=$(cat /tmp/{n
-00012570: 616d 657d 2d72 756e 2d69 6429 3b20 6563  ame}-run-id); ec
-00012580: 686f 2024 5255 4e5f 4944 3b20 736b 7920  ho $RUN_ID; sky 
-00012590: 7370 6f74 206c 6f67 7320 2d6e 207b 6e61  spot logs -n {na
-000125a0: 6d65 7d20 2d2d 6e6f 2d66 6f6c 6c6f 7720  me} --no-follow 
-000125b0: 7c20 6772 6570 2053 4b59 5049 4c4f 545f  | grep SKYPILOT_
-000125c0: 5441 534b 5f49 4420 7c20 6772 6570 2022  TASK_ID | grep "
-000125d0: 2452 554e 5f49 4422 272c 0a20 2020 2020  $RUN_ID"',.     
-000125e0: 2020 205d 2c0a 2020 2020 2020 2020 5f53     ],.        _S
-000125f0: 504f 545f 4341 4e43 454c 5f57 4149 542e  POT_CANCEL_WAIT.
-00012600: 666f 726d 6174 286a 6f62 5f6e 616d 653d  format(job_name=
-00012610: 6e61 6d65 292c 0a20 2020 2020 2020 2074  name),.        t
-00012620: 696d 656f 7574 3d32 3520 2a20 3630 2c0a  imeout=25 * 60,.
-00012630: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-00012640: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
-00012650: 7079 7465 7374 2e6d 6172 6b2e 6763 700a  pytest.mark.gcp.
-00012660: 4070 7974 6573 742e 6d61 726b 2e6d 616e  @pytest.mark.man
-00012670: 6167 6564 5f73 706f 740a 6465 6620 7465  aged_spot.def te
-00012680: 7374 5f73 706f 745f 7265 636f 7665 7279  st_spot_recovery
-00012690: 5f67 6370 2829 3a0a 2020 2020 2222 2254  _gcp():.    """T
-000126a0: 6573 7420 6d61 6e61 6765 6420 7370 6f74  est managed spot
-000126b0: 2072 6563 6f76 6572 792e 2222 220a 2020   recovery.""".  
-000126c0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-000126d0: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-000126e0: 207a 6f6e 6520 3d20 2775 732d 6561 7374   zone = 'us-east
-000126f0: 342d 6227 0a20 2020 2071 7565 7279 5f63  4-b'.    query_c
-00012700: 6d64 203d 2028 6627 6763 6c6f 7564 2063  md = (f'gcloud c
-00012710: 6f6d 7075 7465 2069 6e73 7461 6e63 6573  ompute instances
-00012720: 206c 6973 7420 2d2d 6669 6c74 6572 3d27   list --filter='
-00012730: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012740: 2020 6627 2228 6c61 6265 6c73 2e72 6179    f'"(labels.ray
-00012750: 2d63 6c75 7374 6572 2d6e 616d 653a 7b6e  -cluster-name:{n
-00012760: 616d 657d 2922 2027 0a20 2020 2020 2020  ame})" '.       
-00012770: 2020 2020 2020 2020 2020 6627 2d2d 7a6f            f'--zo
-00012780: 6e65 733d 7b7a 6f6e 657d 202d 2d66 6f72  nes={zone} --for
-00012790: 6d61 743d 2276 616c 7565 286e 616d 6529  mat="value(name)
-000127a0: 2227 290a 2020 2020 7465 726d 696e 6174  "').    terminat
-000127b0: 655f 636d 6420 3d20 2866 2767 636c 6f75  e_cmd = (f'gclou
-000127c0: 6420 636f 6d70 7574 6520 696e 7374 616e  d compute instan
-000127d0: 6365 7320 6465 6c65 7465 202d 2d7a 6f6e  ces delete --zon
-000127e0: 653d 7b7a 6f6e 657d 270a 2020 2020 2020  e={zone}'.      
-000127f0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00012800: 2720 2d2d 7175 6965 7420 2428 7b71 7565  ' --quiet $({que
-00012810: 7279 5f63 6d64 7d29 2729 0a20 2020 2074  ry_cmd})').    t
-00012820: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-00012830: 2020 2020 2773 706f 745f 7265 636f 7665      'spot_recove
-00012840: 7279 5f67 6370 272c 0a20 2020 2020 2020  ry_gcp',.       
-00012850: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-00012860: 2773 6b79 2073 706f 7420 6c61 756e 6368  'sky spot launch
-00012870: 202d 2d63 6c6f 7564 2067 6370 202d 2d7a   --cloud gcp --z
-00012880: 6f6e 6520 7b7a 6f6e 657d 202d 6e20 7b6e  one {zone} -n {n
-00012890: 616d 657d 2022 6563 686f 2053 4b59 5049  ame} "echo SKYPI
-000128a0: 4c4f 545f 5441 534b 5f49 443a 205c 2453  LOT_TASK_ID: \$S
-000128b0: 4b59 5049 4c4f 545f 5441 534b 5f49 443b  KYPILOT_TASK_ID;
-000128c0: 2073 6c65 6570 2031 3830 3022 2020 2d79   sleep 1800"  -y
-000128d0: 202d 6427 2c0a 2020 2020 2020 2020 2020   -d',.          
-000128e0: 2020 2773 6c65 6570 2033 3630 272c 0a20    'sleep 360',. 
-000128f0: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
-00012900: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
-00012910: 2067 7265 7020 7b6e 616d 657d 207c 2068   grep {name} | h
-00012920: 6561 6420 2d6e 3120 7c20 6772 6570 2022  ead -n1 | grep "
-00012930: 5255 4e4e 494e 4722 272c 0a20 2020 2020  RUNNING"',.     
-00012940: 2020 2020 2020 2066 2752 554e 5f49 443d         f'RUN_ID=
-00012950: 2428 736b 7920 7370 6f74 206c 6f67 7320  $(sky spot logs 
-00012960: 2d6e 207b 6e61 6d65 7d20 2d2d 6e6f 2d66  -n {name} --no-f
-00012970: 6f6c 6c6f 7720 7c20 6772 6570 2053 4b59  ollow | grep SKY
-00012980: 5049 4c4f 545f 5441 534b 5f49 4420 7c20  PILOT_TASK_ID | 
-00012990: 6375 7420 2d64 3a20 2d66 3229 3b20 6563  cut -d: -f2); ec
-000129a0: 686f 2022 2452 554e 5f49 4422 207c 2074  ho "$RUN_ID" | t
-000129b0: 6565 202f 746d 702f 7b6e 616d 657d 2d72  ee /tmp/{name}-r
-000129c0: 756e 2d69 6427 2c0a 2020 2020 2020 2020  un-id',.        
-000129d0: 2020 2020 2320 5465 726d 696e 6174 6520      # Terminate 
-000129e0: 7468 6520 636c 7573 7465 7220 6d61 6e75  the cluster manu
-000129f0: 616c 6c79 2e0a 2020 2020 2020 2020 2020  ally..          
-00012a00: 2020 7465 726d 696e 6174 655f 636d 642c    terminate_cmd,
-00012a10: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-00012a20: 6565 7020 3130 3027 2c0a 2020 2020 2020  eep 100',.      
-00012a30: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
-00012a40: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
-00012a50: 207b 6e61 6d65 7d20 7c20 6865 6164 202d   {name} | head -
-00012a60: 6e31 207c 2067 7265 7020 2252 4543 4f56  n1 | grep "RECOV
-00012a70: 4552 494e 4722 272c 0a20 2020 2020 2020  ERING"',.       
-00012a80: 2020 2020 2027 736c 6565 7020 3230 3027       'sleep 200'
-00012a90: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00012aa0: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
-00012ab0: 547d 7c20 6772 6570 207b 6e61 6d65 7d20  T}| grep {name} 
-00012ac0: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
-00012ad0: 7020 2252 554e 4e49 4e47 2227 2c0a 2020  p "RUNNING"',.  
-00012ae0: 2020 2020 2020 2020 2020 6627 5255 4e5f            f'RUN_
-00012af0: 4944 3d24 2863 6174 202f 746d 702f 7b6e  ID=$(cat /tmp/{n
-00012b00: 616d 657d 2d72 756e 2d69 6429 3b20 6563  ame}-run-id); ec
-00012b10: 686f 2024 5255 4e5f 4944 3b20 736b 7920  ho $RUN_ID; sky 
-00012b20: 7370 6f74 206c 6f67 7320 2d6e 207b 6e61  spot logs -n {na
-00012b30: 6d65 7d20 2d2d 6e6f 2d66 6f6c 6c6f 7720  me} --no-follow 
-00012b40: 7c20 6772 6570 2053 4b59 5049 4c4f 545f  | grep SKYPILOT_
-00012b50: 5441 534b 5f49 443a 207c 2067 7265 7020  TASK_ID: | grep 
-00012b60: 2224 5255 4e5f 4944 2227 2c0a 2020 2020  "$RUN_ID"',.    
-00012b70: 2020 2020 5d2c 0a20 2020 2020 2020 205f      ],.        _
-00012b80: 5350 4f54 5f43 414e 4345 4c5f 5741 4954  SPOT_CANCEL_WAIT
-00012b90: 2e66 6f72 6d61 7428 6a6f 625f 6e61 6d65  .format(job_name
-00012ba0: 3d6e 616d 6529 2c0a 2020 2020 2020 2020  =name),.        
-00012bb0: 7469 6d65 6f75 743d 3235 202a 2036 302c  timeout=25 * 60,
-00012bc0: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
-00012bd0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-00012be0: 4070 7974 6573 742e 6d61 726b 2e61 7773  @pytest.mark.aws
-00012bf0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6d61  .@pytest.mark.ma
-00012c00: 6e61 6765 645f 7370 6f74 0a64 6566 2074  naged_spot.def t
-00012c10: 6573 745f 7370 6f74 5f70 6970 656c 696e  est_spot_pipelin
-00012c20: 655f 7265 636f 7665 7279 5f61 7773 2861  e_recovery_aws(a
-00012c30: 7773 5f63 6f6e 6669 675f 7265 6769 6f6e  ws_config_region
-00012c40: 293a 0a20 2020 2022 2222 5465 7374 206d  ):.    """Test m
-00012c50: 616e 6167 6564 2073 706f 7420 7265 636f  anaged spot reco
-00012c60: 7665 7279 2066 6f72 2061 2070 6970 656c  very for a pipel
-00012c70: 696e 652e 2222 220a 2020 2020 6e61 6d65  ine.""".    name
-00012c80: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
-00012c90: 6e61 6d65 2829 0a20 2020 2072 6567 696f  name().    regio
-00012ca0: 6e20 3d20 6177 735f 636f 6e66 6967 5f72  n = aws_config_r
-00012cb0: 6567 696f 6e0a 2020 2020 6966 2072 6567  egion.    if reg
-00012cc0: 696f 6e20 213d 2027 7573 2d77 6573 742d  ion != 'us-west-
-00012cd0: 3227 3a0a 2020 2020 2020 2020 7079 7465  2':.        pyte
-00012ce0: 7374 2e73 6b69 7028 274f 6e6c 7920 7275  st.skip('Only ru
-00012cf0: 6e20 7370 6f74 2070 6970 656c 696e 6520  n spot pipeline 
-00012d00: 7265 636f 7665 7279 2074 6573 7420 696e  recovery test in
-00012d10: 2075 732d 7765 7374 2d32 2729 0a20 2020   us-west-2').   
-00012d20: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-00012d30: 2020 2020 2020 2773 706f 745f 7069 7065        'spot_pipe
-00012d40: 6c69 6e65 5f72 6563 6f76 6572 795f 6177  line_recovery_aw
-00012d50: 7327 2c0a 2020 2020 2020 2020 5b0a 2020  s',.        [.  
-00012d60: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00012d70: 7370 6f74 206c 6175 6e63 6820 2d6e 207b  spot launch -n {
-00012d80: 6e61 6d65 7d20 7465 7374 732f 7465 7374  name} tests/test
-00012d90: 5f79 616d 6c73 2f70 6970 656c 696e 655f  _yamls/pipeline_
-00012da0: 6177 732e 7961 6d6c 2020 2d79 202d 6427  aws.yaml  -y -d'
-00012db0: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
-00012dc0: 6c65 6570 2034 3030 272c 0a20 2020 2020  leep 400',.     
-00012dd0: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
-00012de0: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
-00012df0: 7020 7b6e 616d 657d 207c 2068 6561 6420  p {name} | head 
-00012e00: 2d6e 3120 7c20 6772 6570 2022 5255 4e4e  -n1 | grep "RUNN
-00012e10: 494e 4722 272c 0a20 2020 2020 2020 2020  ING"',.         
-00012e20: 2020 2066 2752 554e 5f49 443d 2428 736b     f'RUN_ID=$(sk
-00012e30: 7920 7370 6f74 206c 6f67 7320 2d6e 207b  y spot logs -n {
-00012e40: 6e61 6d65 7d20 2d2d 6e6f 2d66 6f6c 6c6f  name} --no-follo
-00012e50: 7720 7c20 6772 6570 2053 4b59 5049 4c4f  w | grep SKYPILO
-00012e60: 545f 5441 534b 5f49 443a 207c 2063 7574  T_TASK_ID: | cut
-00012e70: 202d 643a 202d 6632 293b 2065 6368 6f20   -d: -f2); echo 
-00012e80: 2224 5255 4e5f 4944 2220 7c20 7465 6520  "$RUN_ID" | tee 
-00012e90: 2f74 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d  /tmp/{name}-run-
-00012ea0: 6964 272c 0a20 2020 2020 2020 2020 2020  id',.           
-00012eb0: 2066 2752 554e 5f49 4453 3d24 2873 6b79   f'RUN_IDS=$(sky
-00012ec0: 2073 706f 7420 6c6f 6773 202d 6e20 7b6e   spot logs -n {n
-00012ed0: 616d 657d 202d 2d6e 6f2d 666f 6c6c 6f77  ame} --no-follow
-00012ee0: 207c 2067 7265 7020 2d41 2034 2053 4b59   | grep -A 4 SKY
-00012ef0: 5049 4c4f 545f 5441 534b 5f49 4453 207c  PILOT_TASK_IDS |
-00012f00: 2063 7574 202d 6422 2922 202d 6632 293b   cut -d")" -f2);
-00012f10: 2065 6368 6f20 2224 5255 4e5f 4944 5322   echo "$RUN_IDS"
-00012f20: 207c 2074 6565 202f 746d 702f 7b6e 616d   | tee /tmp/{nam
-00012f30: 657d 2d72 756e 2d69 6473 272c 0a20 2020  e}-run-ids',.   
-00012f40: 2020 2020 2020 2020 2023 2054 6572 6d69           # Termi
-00012f50: 6e61 7465 2074 6865 2063 6c75 7374 6572  nate the cluster
-00012f60: 206d 616e 7561 6c6c 792e 0a20 2020 2020   manually..     
-00012f70: 2020 2020 2020 2023 2054 6865 2060 6361         # The `ca
-00012f80: 7420 2e2e 2e7c 2072 6576 6020 6973 2074  t ...| rev` is t
-00012f90: 6f20 7265 7472 6965 7665 2074 6865 206a  o retrieve the j
-00012fa0: 6f62 5f69 6420 6672 6f6d 2074 6865 0a20  ob_id from the. 
-00012fb0: 2020 2020 2020 2020 2020 2023 2053 4b59             # SKY
-00012fc0: 5049 4c4f 545f 5441 534b 5f49 442c 2077  PILOT_TASK_ID, w
-00012fd0: 6869 6368 2067 6574 7320 7468 6520 7365  hich gets the se
-00012fe0: 636f 6e64 2074 6f20 6c61 7374 2066 6965  cond to last fie
-00012ff0: 6c64 0a20 2020 2020 2020 2020 2020 2023  ld.            #
-00013000: 2073 6570 6172 6174 6564 2062 7920 602d   separated by `-
-00013010: 602e 0a20 2020 2020 2020 2020 2020 2028  `..            (
-00013020: 6627 5350 4f54 5f4a 4f42 5f49 443d 6063  f'SPOT_JOB_ID=`c
-00013030: 6174 202f 746d 702f 7b6e 616d 657d 2d72  at /tmp/{name}-r
-00013040: 756e 2d69 6420 7c20 7265 7620 7c20 270a  un-id | rev | '.
-00013050: 2020 2020 2020 2020 2020 2020 2027 6375               'cu
-00013060: 7420 2d64 5c27 2d5c 2720 2d66 3220 7c20  t -d\'-\' -f2 | 
-00013070: 7265 7660 3b27 0a20 2020 2020 2020 2020  rev`;'.         
-00013080: 2020 2020 6627 6177 7320 6563 3220 7465      f'aws ec2 te
-00013090: 726d 696e 6174 652d 696e 7374 616e 6365  rminate-instance
-000130a0: 7320 2d2d 7265 6769 6f6e 207b 7265 6769  s --region {regi
-000130b0: 6f6e 7d20 2d2d 696e 7374 616e 6365 2d69  on} --instance-i
-000130c0: 6473 2024 2827 0a20 2020 2020 2020 2020  ds $('.         
-000130d0: 2020 2020 6627 6177 7320 6563 3220 6465      f'aws ec2 de
-000130e0: 7363 7269 6265 2d69 6e73 7461 6e63 6573  scribe-instances
-000130f0: 202d 2d72 6567 696f 6e20 7b72 6567 696f   --region {regio
-00013100: 6e7d 2027 0a20 2020 2020 2020 2020 2020  n} '.           
-00013110: 2020 272d 2d66 696c 7465 7273 204e 616d    '--filters Nam
-00013120: 653d 7461 673a 7261 792d 636c 7573 7465  e=tag:ray-cluste
-00013130: 722d 6e61 6d65 2c56 616c 7565 733d 2a2d  r-name,Values=*-
-00013140: 247b 5350 4f54 5f4a 4f42 5f49 447d 2027  ${SPOT_JOB_ID} '
-00013150: 0a20 2020 2020 2020 2020 2020 2020 6627  .             f'
-00013160: 2d2d 7175 6572 7920 5265 7365 7276 6174  --query Reservat
-00013170: 696f 6e73 5b5d 2e49 6e73 7461 6e63 6573  ions[].Instances
-00013180: 5b5d 2e49 6e73 7461 6e63 6549 6420 270a  [].InstanceId '.
-00013190: 2020 2020 2020 2020 2020 2020 2027 2d2d               '--
-000131a0: 6f75 7470 7574 2074 6578 7429 2729 2c0a  output text)'),.
-000131b0: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
-000131c0: 6570 2031 3030 272c 0a20 2020 2020 2020  ep 100',.       
-000131d0: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
-000131e0: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
-000131f0: 7b6e 616d 657d 207c 2068 6561 6420 2d6e  {name} | head -n
-00013200: 3120 7c20 6772 6570 2022 5245 434f 5645  1 | grep "RECOVE
-00013210: 5249 4e47 2227 2c0a 2020 2020 2020 2020  RING"',.        
-00013220: 2020 2020 2773 6c65 6570 2032 3030 272c      'sleep 200',
-00013230: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
-00013240: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
-00013250: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
-00013260: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
-00013270: 2022 5255 4e4e 494e 4722 272c 0a20 2020   "RUNNING"',.   
-00013280: 2020 2020 2020 2020 2066 2752 554e 5f49           f'RUN_I
-00013290: 443d 2428 6361 7420 2f74 6d70 2f7b 6e61  D=$(cat /tmp/{na
-000132a0: 6d65 7d2d 7275 6e2d 6964 293b 2065 6368  me}-run-id); ech
-000132b0: 6f20 2452 554e 5f49 443b 2073 6b79 2073  o $RUN_ID; sky s
-000132c0: 706f 7420 6c6f 6773 202d 6e20 7b6e 616d  pot logs -n {nam
-000132d0: 657d 202d 2d6e 6f2d 666f 6c6c 6f77 207c  e} --no-follow |
-000132e0: 2067 7265 7020 534b 5950 494c 4f54 5f54   grep SKYPILOT_T
-000132f0: 4153 4b5f 4944 3a20 7c20 6772 6570 2022  ASK_ID: | grep "
-00013300: 2452 554e 5f49 4422 272c 0a20 2020 2020  $RUN_ID"',.     
-00013310: 2020 2020 2020 2066 2752 554e 5f49 4453         f'RUN_IDS
-00013320: 3d24 2873 6b79 2073 706f 7420 6c6f 6773  =$(sky spot logs
-00013330: 202d 6e20 7b6e 616d 657d 202d 2d6e 6f2d   -n {name} --no-
-00013340: 666f 6c6c 6f77 207c 2067 7265 7020 2d41  follow | grep -A
-00013350: 2034 2053 4b59 5049 4c4f 545f 5441 534b   4 SKYPILOT_TASK
-00013360: 5f49 4453 207c 2063 7574 202d 6422 2922  _IDS | cut -d")"
-00013370: 202d 6632 293b 2065 6368 6f20 2224 5255   -f2); echo "$RU
-00013380: 4e5f 4944 5322 207c 2074 6565 202f 746d  N_IDS" | tee /tm
-00013390: 702f 7b6e 616d 657d 2d72 756e 2d69 6473  p/{name}-run-ids
-000133a0: 2d6e 6577 272c 0a20 2020 2020 2020 2020  -new',.         
-000133b0: 2020 2066 2764 6966 6620 2f74 6d70 2f7b     f'diff /tmp/{
-000133c0: 6e61 6d65 7d2d 7275 6e2d 6964 7320 2f74  name}-run-ids /t
-000133d0: 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d 6964  mp/{name}-run-id
-000133e0: 732d 6e65 7727 2c0a 2020 2020 2020 2020  s-new',.        
-000133f0: 2020 2020 6627 6361 7420 2f74 6d70 2f7b      f'cat /tmp/{
-00013400: 6e61 6d65 7d2d 7275 6e2d 6964 7320 7c20  name}-run-ids | 
-00013410: 7365 6420 2d6e 2032 7020 7c20 6772 6570  sed -n 2p | grep
-00013420: 2060 6361 7420 2f74 6d70 2f7b 6e61 6d65   `cat /tmp/{name
-00013430: 7d2d 7275 6e2d 6964 6027 2c0a 2020 2020  }-run-id`',.    
-00013440: 2020 2020 5d2c 0a20 2020 2020 2020 205f      ],.        _
-00013450: 5350 4f54 5f43 414e 4345 4c5f 5741 4954  SPOT_CANCEL_WAIT
-00013460: 2e66 6f72 6d61 7428 6a6f 625f 6e61 6d65  .format(job_name
-00013470: 3d6e 616d 6529 2c0a 2020 2020 2020 2020  =name),.        
-00013480: 7469 6d65 6f75 743d 3235 202a 2036 302c  timeout=25 * 60,
-00013490: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
-000134a0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-000134b0: 4070 7974 6573 742e 6d61 726b 2e67 6370  @pytest.mark.gcp
-000134c0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6d61  .@pytest.mark.ma
-000134d0: 6e61 6765 645f 7370 6f74 0a64 6566 2074  naged_spot.def t
-000134e0: 6573 745f 7370 6f74 5f70 6970 656c 696e  est_spot_pipelin
-000134f0: 655f 7265 636f 7665 7279 5f67 6370 2829  e_recovery_gcp()
-00013500: 3a0a 2020 2020 2222 2254 6573 7420 6d61  :.    """Test ma
-00013510: 6e61 6765 6420 7370 6f74 2072 6563 6f76  naged spot recov
-00013520: 6572 7920 666f 7220 6120 7069 7065 6c69  ery for a pipeli
-00013530: 6e65 2e22 2222 0a20 2020 206e 616d 6520  ne.""".    name 
-00013540: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-00013550: 616d 6528 290a 2020 2020 7a6f 6e65 203d  ame().    zone =
-00013560: 2027 7573 2d65 6173 7434 2d62 270a 2020   'us-east4-b'.  
-00013570: 2020 7175 6572 795f 636d 6420 3d20 2827    query_cmd = ('
-00013580: 6763 6c6f 7564 2063 6f6d 7075 7465 2069  gcloud compute i
-00013590: 6e73 7461 6e63 6573 206c 6973 7420 2d2d  nstances list --
-000135a0: 6669 6c74 6572 3d27 0a20 2020 2020 2020  filter='.       
-000135b0: 2020 2020 2020 2020 2020 2722 286c 6162            '"(lab
-000135c0: 656c 732e 7261 792d 636c 7573 7465 722d  els.ray-cluster-
-000135d0: 6e61 6d65 3a2a 2d24 7b53 504f 545f 4a4f  name:*-${SPOT_JO
-000135e0: 425f 4944 7d29 2220 270a 2020 2020 2020  B_ID})" '.      
-000135f0: 2020 2020 2020 2020 2020 2066 272d 2d7a             f'--z
-00013600: 6f6e 6573 3d7b 7a6f 6e65 7d20 2d2d 666f  ones={zone} --fo
-00013610: 726d 6174 3d22 7661 6c75 6528 6e61 6d65  rmat="value(name
-00013620: 2922 2729 0a20 2020 2074 6572 6d69 6e61  )"').    termina
-00013630: 7465 5f63 6d64 203d 2028 6627 6763 6c6f  te_cmd = (f'gclo
-00013640: 7564 2063 6f6d 7075 7465 2069 6e73 7461  ud compute insta
-00013650: 6e63 6573 2064 656c 6574 6520 2d2d 7a6f  nces delete --zo
-00013660: 6e65 3d7b 7a6f 6e65 7d27 0a20 2020 2020  ne={zone}'.     
-00013670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013680: 6627 202d 2d71 7569 6574 2024 287b 7175  f' --quiet $({qu
-00013690: 6572 795f 636d 647d 2927 290a 2020 2020  ery_cmd})').    
-000136a0: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-000136b0: 2020 2020 2027 7370 6f74 5f70 6970 656c       'spot_pipel
-000136c0: 696e 655f 7265 636f 7665 7279 5f67 6370  ine_recovery_gcp
-000136d0: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-000136e0: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
-000136f0: 706f 7420 6c61 756e 6368 202d 6e20 7b6e  pot launch -n {n
-00013700: 616d 657d 2074 6573 7473 2f74 6573 745f  ame} tests/test_
-00013710: 7961 6d6c 732f 7069 7065 6c69 6e65 5f67  yamls/pipeline_g
-00013720: 6370 2e79 616d 6c20 202d 7920 2d64 272c  cp.yaml  -y -d',
-00013730: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-00013740: 6565 7020 3430 3027 2c0a 2020 2020 2020  eep 400',.      
-00013750: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
-00013760: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
-00013770: 207b 6e61 6d65 7d20 7c20 6865 6164 202d   {name} | head -
-00013780: 6e31 207c 2067 7265 7020 2252 554e 4e49  n1 | grep "RUNNI
-00013790: 4e47 2227 2c0a 2020 2020 2020 2020 2020  NG"',.          
-000137a0: 2020 6627 5255 4e5f 4944 3d24 2873 6b79    f'RUN_ID=$(sky
-000137b0: 2073 706f 7420 6c6f 6773 202d 6e20 7b6e   spot logs -n {n
-000137c0: 616d 657d 202d 2d6e 6f2d 666f 6c6c 6f77  ame} --no-follow
-000137d0: 207c 2067 7265 7020 534b 5950 494c 4f54   | grep SKYPILOT
-000137e0: 5f54 4153 4b5f 4944 3a20 7c20 6375 7420  _TASK_ID: | cut 
-000137f0: 2d64 3a20 2d66 3229 3b20 6563 686f 2022  -d: -f2); echo "
-00013800: 2452 554e 5f49 4422 207c 2074 6565 202f  $RUN_ID" | tee /
-00013810: 746d 702f 7b6e 616d 657d 2d72 756e 2d69  tmp/{name}-run-i
-00013820: 6427 2c0a 2020 2020 2020 2020 2020 2020  d',.            
-00013830: 6627 5255 4e5f 4944 533d 2428 736b 7920  f'RUN_IDS=$(sky 
-00013840: 7370 6f74 206c 6f67 7320 2d6e 207b 6e61  spot logs -n {na
-00013850: 6d65 7d20 2d2d 6e6f 2d66 6f6c 6c6f 7720  me} --no-follow 
-00013860: 7c20 6772 6570 202d 4120 3420 534b 5950  | grep -A 4 SKYP
-00013870: 494c 4f54 5f54 4153 4b5f 4944 5320 7c20  ILOT_TASK_IDS | 
-00013880: 6375 7420 2d64 2229 2220 2d66 3229 3b20  cut -d")" -f2); 
-00013890: 6563 686f 2022 2452 554e 5f49 4453 2220  echo "$RUN_IDS" 
-000138a0: 7c20 7465 6520 2f74 6d70 2f7b 6e61 6d65  | tee /tmp/{name
-000138b0: 7d2d 7275 6e2d 6964 7327 2c0a 2020 2020  }-run-ids',.    
-000138c0: 2020 2020 2020 2020 2320 5465 726d 696e          # Termin
-000138d0: 6174 6520 7468 6520 636c 7573 7465 7220  ate the cluster 
-000138e0: 6d61 6e75 616c 6c79 2e0a 2020 2020 2020  manually..      
-000138f0: 2020 2020 2020 2320 5468 6520 6063 6174        # The `cat
-00013900: 202e 2e2e 7c20 7265 7660 2069 7320 746f   ...| rev` is to
-00013910: 2072 6574 7269 6576 6520 7468 6520 6a6f   retrieve the jo
-00013920: 625f 6964 2066 726f 6d20 7468 650a 2020  b_id from the.  
-00013930: 2020 2020 2020 2020 2020 2320 534b 5950            # SKYP
-00013940: 494c 4f54 5f54 4153 4b5f 4944 2c20 7768  ILOT_TASK_ID, wh
-00013950: 6963 6820 6765 7473 2074 6865 2073 6563  ich gets the sec
-00013960: 6f6e 6420 746f 206c 6173 7420 6669 656c  ond to last fiel
-00013970: 640a 2020 2020 2020 2020 2020 2020 2320  d.            # 
-00013980: 7365 7061 7261 7465 6420 6279 2060 2d60  separated by `-`
-00013990: 2e0a 2020 2020 2020 2020 2020 2020 2866  ..            (f
-000139a0: 2753 504f 545f 4a4f 425f 4944 3d60 6361  'SPOT_JOB_ID=`ca
-000139b0: 7420 2f74 6d70 2f7b 6e61 6d65 7d2d 7275  t /tmp/{name}-ru
-000139c0: 6e2d 6964 207c 2072 6576 207c 2027 0a20  n-id | rev | '. 
-000139d0: 2020 2020 2020 2020 2020 2020 6627 6375              f'cu
-000139e0: 7420 2d64 5c27 2d5c 2720 2d66 3220 7c20  t -d\'-\' -f2 | 
-000139f0: 7265 7660 3b7b 7465 726d 696e 6174 655f  rev`;{terminate_
-00013a00: 636d 647d 2729 2c0a 2020 2020 2020 2020  cmd}'),.        
-00013a10: 2020 2020 2773 6c65 6570 2031 3030 272c      'sleep 100',
-00013a20: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
-00013a30: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
-00013a40: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
-00013a50: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
-00013a60: 2022 5245 434f 5645 5249 4e47 2227 2c0a   "RECOVERING"',.
-00013a70: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
-00013a80: 6570 2032 3030 272c 0a20 2020 2020 2020  ep 200',.       
-00013a90: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
-00013aa0: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
-00013ab0: 7b6e 616d 657d 207c 2068 6561 6420 2d6e  {name} | head -n
-00013ac0: 3120 7c20 6772 6570 2022 5255 4e4e 494e  1 | grep "RUNNIN
-00013ad0: 4722 272c 0a20 2020 2020 2020 2020 2020  G"',.           
-00013ae0: 2066 2752 554e 5f49 443d 2428 6361 7420   f'RUN_ID=$(cat 
-00013af0: 2f74 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d  /tmp/{name}-run-
-00013b00: 6964 293b 2065 6368 6f20 2452 554e 5f49  id); echo $RUN_I
-00013b10: 443b 2073 6b79 2073 706f 7420 6c6f 6773  D; sky spot logs
-00013b20: 202d 6e20 7b6e 616d 657d 202d 2d6e 6f2d   -n {name} --no-
-00013b30: 666f 6c6c 6f77 207c 2067 7265 7020 534b  follow | grep SK
-00013b40: 5950 494c 4f54 5f54 4153 4b5f 4944 3a20  YPILOT_TASK_ID: 
-00013b50: 7c20 6772 6570 2022 2452 554e 5f49 4422  | grep "$RUN_ID"
-00013b60: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00013b70: 2752 554e 5f49 4453 3d24 2873 6b79 2073  'RUN_IDS=$(sky s
-00013b80: 706f 7420 6c6f 6773 202d 6e20 7b6e 616d  pot logs -n {nam
-00013b90: 657d 202d 2d6e 6f2d 666f 6c6c 6f77 207c  e} --no-follow |
-00013ba0: 2067 7265 7020 2d41 2034 2053 4b59 5049   grep -A 4 SKYPI
-00013bb0: 4c4f 545f 5441 534b 5f49 4453 207c 2063  LOT_TASK_IDS | c
-00013bc0: 7574 202d 6422 2922 202d 6632 293b 2065  ut -d")" -f2); e
-00013bd0: 6368 6f20 2224 5255 4e5f 4944 5322 207c  cho "$RUN_IDS" |
-00013be0: 2074 6565 202f 746d 702f 7b6e 616d 657d   tee /tmp/{name}
-00013bf0: 2d72 756e 2d69 6473 2d6e 6577 272c 0a20  -run-ids-new',. 
-00013c00: 2020 2020 2020 2020 2020 2066 2764 6966             f'dif
-00013c10: 6620 2f74 6d70 2f7b 6e61 6d65 7d2d 7275  f /tmp/{name}-ru
-00013c20: 6e2d 6964 7320 2f74 6d70 2f7b 6e61 6d65  n-ids /tmp/{name
-00013c30: 7d2d 7275 6e2d 6964 732d 6e65 7727 2c0a  }-run-ids-new',.
-00013c40: 2020 2020 2020 2020 2020 2020 6627 6361              f'ca
-00013c50: 7420 2f74 6d70 2f7b 6e61 6d65 7d2d 7275  t /tmp/{name}-ru
-00013c60: 6e2d 6964 7320 7c20 7365 6420 2d6e 2032  n-ids | sed -n 2
-00013c70: 7020 7c20 6772 6570 2060 6361 7420 2f74  p | grep `cat /t
-00013c80: 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d 6964  mp/{name}-run-id
-00013c90: 6027 2c0a 2020 2020 2020 2020 5d2c 0a20  `',.        ],. 
-00013ca0: 2020 2020 2020 205f 5350 4f54 5f43 414e         _SPOT_CAN
-00013cb0: 4345 4c5f 5741 4954 2e66 6f72 6d61 7428  CEL_WAIT.format(
-00013cc0: 6a6f 625f 6e61 6d65 3d6e 616d 6529 2c0a  job_name=name),.
-00013cd0: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
-00013ce0: 3235 202a 2036 302c 0a20 2020 2029 0a20  25 * 60,.    ). 
-00013cf0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-00013d00: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
-00013d10: 6d61 726b 2e6e 6f5f 6c61 6d62 6461 5f63  mark.no_lambda_c
-00013d20: 6c6f 7564 2020 2320 4c61 6d62 6461 2043  loud  # Lambda C
-00013d30: 6c6f 7564 2064 6f65 7320 6e6f 7420 7375  loud does not su
-00013d40: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
-00013d50: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
-00013d60: 6b2e 6e6f 5f69 626d 2020 2320 4942 4d20  k.no_ibm  # IBM 
-00013d70: 436c 6f75 6420 646f 6573 206e 6f74 2073  Cloud does not s
-00013d80: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
-00013d90: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
-00013da0: 726b 2e6e 6f5f 7363 7020 2023 2053 4350  rk.no_scp  # SCP
-00013db0: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
-00013dc0: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
-00013dd0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6d61  .@pytest.mark.ma
-00013de0: 6e61 6765 645f 7370 6f74 0a64 6566 2074  naged_spot.def t
-00013df0: 6573 745f 7370 6f74 5f72 6563 6f76 6572  est_spot_recover
-00013e00: 795f 6465 6661 756c 745f 7265 736f 7572  y_default_resour
-00013e10: 6365 7328 6765 6e65 7269 635f 636c 6f75  ces(generic_clou
-00013e20: 643a 2073 7472 293a 0a20 2020 2022 2222  d: str):.    """
-00013e30: 5465 7374 206d 616e 6167 6564 2073 706f  Test managed spo
-00013e40: 7420 7265 636f 7665 7279 2066 6f72 2064  t recovery for d
-00013e50: 6566 6175 6c74 2072 6573 6f75 7263 6573  efault resources
-00013e60: 2e22 2222 0a20 2020 206e 616d 6520 3d20  .""".    name = 
-00013e70: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-00013e80: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
-00013e90: 6573 7428 0a20 2020 2020 2020 2027 6d61  est(.        'ma
-00013ea0: 6e61 6765 642d 7370 6f74 2d72 6563 6f76  naged-spot-recov
-00013eb0: 6572 792d 6465 6661 756c 742d 7265 736f  ery-default-reso
-00013ec0: 7572 6365 7327 2c0a 2020 2020 2020 2020  urces',.        
-00013ed0: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
-00013ee0: 736b 7920 7370 6f74 206c 6175 6e63 6820  sky spot launch 
-00013ef0: 2d6e 207b 6e61 6d65 7d20 2d2d 636c 6f75  -n {name} --clou
-00013f00: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
-00013f10: 7d20 2273 6c65 6570 2033 3020 2626 2073  } "sleep 30 && s
-00013f20: 7564 6f20 7368 7574 646f 776e 206e 6f77  udo shutdown now
-00013f30: 2026 2620 736c 6565 7020 3130 3030 2220   && sleep 1000" 
-00013f40: 2d79 202d 6427 2c0a 2020 2020 2020 2020  -y -d',.        
-00013f50: 2020 2020 2773 6c65 6570 2033 3630 272c      'sleep 360',
-00013f60: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
-00013f70: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
-00013f80: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
-00013f90: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
-00013fa0: 2022 5255 4e4e 494e 475c 7c52 4543 4f56   "RUNNING\|RECOV
-00013fb0: 4552 494e 4722 272c 0a20 2020 2020 2020  ERING"',.       
-00013fc0: 205d 2c0a 2020 2020 2020 2020 5f53 504f   ],.        _SPO
-00013fd0: 545f 4341 4e43 454c 5f57 4149 542e 666f  T_CANCEL_WAIT.fo
-00013fe0: 726d 6174 286a 6f62 5f6e 616d 653d 6e61  rmat(job_name=na
-00013ff0: 6d65 292c 0a20 2020 2020 2020 2074 696d  me),.        tim
-00014000: 656f 7574 3d32 3520 2a20 3630 2c0a 2020  eout=25 * 60,.  
-00014010: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-00014020: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
-00014030: 7465 7374 2e6d 6172 6b2e 6177 730a 4070  test.mark.aws.@p
-00014040: 7974 6573 742e 6d61 726b 2e6d 616e 6167  ytest.mark.manag
-00014050: 6564 5f73 706f 740a 6465 6620 7465 7374  ed_spot.def test
-00014060: 5f73 706f 745f 7265 636f 7665 7279 5f6d  _spot_recovery_m
-00014070: 756c 7469 5f6e 6f64 655f 6177 7328 6177  ulti_node_aws(aw
-00014080: 735f 636f 6e66 6967 5f72 6567 696f 6e29  s_config_region)
-00014090: 3a0a 2020 2020 2222 2254 6573 7420 6d61  :.    """Test ma
-000140a0: 6e61 6765 6420 7370 6f74 2072 6563 6f76  naged spot recov
-000140b0: 6572 792e 2222 220a 2020 2020 6e61 6d65  ery.""".    name
-000140c0: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
-000140d0: 6e61 6d65 2829 0a20 2020 2072 6567 696f  name().    regio
-000140e0: 6e20 3d20 6177 735f 636f 6e66 6967 5f72  n = aws_config_r
-000140f0: 6567 696f 6e0a 2020 2020 7465 7374 203d  egion.    test =
-00014100: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-00014110: 7370 6f74 5f72 6563 6f76 6572 795f 6d75  spot_recovery_mu
-00014120: 6c74 695f 6e6f 6465 5f61 7773 272c 0a20  lti_node_aws',. 
-00014130: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-00014140: 2020 2020 2066 2773 6b79 2073 706f 7420       f'sky spot 
-00014150: 6c61 756e 6368 202d 2d63 6c6f 7564 2061  launch --cloud a
-00014160: 7773 202d 2d72 6567 696f 6e20 7b72 6567  ws --region {reg
-00014170: 696f 6e7d 202d 6e20 7b6e 616d 657d 202d  ion} -n {name} -
-00014180: 2d6e 756d 2d6e 6f64 6573 2032 2022 6563  -num-nodes 2 "ec
-00014190: 686f 2053 4b59 5049 4c4f 545f 5441 534b  ho SKYPILOT_TASK
-000141a0: 5f49 443a 205c 2453 4b59 5049 4c4f 545f  _ID: \$SKYPILOT_
-000141b0: 5441 534b 5f49 443b 2073 6c65 6570 2031  TASK_ID; sleep 1
-000141c0: 3830 3022 2020 2d79 202d 6427 2c0a 2020  800"  -y -d',.  
-000141d0: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
-000141e0: 2034 3530 272c 0a20 2020 2020 2020 2020   450',.         
-000141f0: 2020 2066 277b 5f53 504f 545f 5155 4555     f'{_SPOT_QUEU
-00014200: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
-00014210: 616d 657d 207c 2068 6561 6420 2d6e 3120  ame} | head -n1 
-00014220: 7c20 6772 6570 2022 5255 4e4e 494e 4722  | grep "RUNNING"
-00014230: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00014240: 2752 554e 5f49 443d 2428 736b 7920 7370  'RUN_ID=$(sky sp
-00014250: 6f74 206c 6f67 7320 2d6e 207b 6e61 6d65  ot logs -n {name
-00014260: 7d20 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20  } --no-follow | 
-00014270: 6772 6570 2053 4b59 5049 4c4f 545f 5441  grep SKYPILOT_TA
-00014280: 534b 5f49 4420 7c20 6375 7420 2d64 3a20  SK_ID | cut -d: 
-00014290: 2d66 3229 3b20 6563 686f 2022 2452 554e  -f2); echo "$RUN
-000142a0: 5f49 4422 207c 2074 6565 202f 746d 702f  _ID" | tee /tmp/
-000142b0: 7b6e 616d 657d 2d72 756e 2d69 6427 2c0a  {name}-run-id',.
-000142c0: 2020 2020 2020 2020 2020 2020 2320 5465              # Te
-000142d0: 726d 696e 6174 6520 7468 6520 776f 726b  rminate the work
-000142e0: 6572 206d 616e 7561 6c6c 792e 0a20 2020  er manually..   
-000142f0: 2020 2020 2020 2020 2028 6627 6177 7320           (f'aws 
-00014300: 6563 3220 7465 726d 696e 6174 652d 696e  ec2 terminate-in
-00014310: 7374 616e 6365 7320 2d2d 7265 6769 6f6e  stances --region
-00014320: 207b 7265 6769 6f6e 7d20 2d2d 696e 7374   {region} --inst
-00014330: 616e 6365 2d69 6473 2024 2827 0a20 2020  ance-ids $('.   
-00014340: 2020 2020 2020 2020 2020 6627 6177 7320            f'aws 
-00014350: 6563 3220 6465 7363 7269 6265 2d69 6e73  ec2 describe-ins
-00014360: 7461 6e63 6573 202d 2d72 6567 696f 6e20  tances --region 
-00014370: 7b72 6567 696f 6e7d 2027 0a20 2020 2020  {region} '.     
-00014380: 2020 2020 2020 2020 6627 2d2d 6669 6c74          f'--filt
-00014390: 6572 7320 4e61 6d65 3d74 6167 3a72 6179  ers Name=tag:ray
-000143a0: 2d63 6c75 7374 6572 2d6e 616d 652c 5661  -cluster-name,Va
-000143b0: 6c75 6573 3d7b 6e61 6d65 7d2a 2027 0a20  lues={name}* '. 
-000143c0: 2020 2020 2020 2020 2020 2020 274e 616d              'Nam
-000143d0: 653d 7461 673a 7261 792d 6e6f 6465 2d74  e=tag:ray-node-t
-000143e0: 7970 652c 5661 6c75 6573 3d77 6f72 6b65  ype,Values=worke
-000143f0: 7220 270a 2020 2020 2020 2020 2020 2020  r '.            
-00014400: 2066 272d 2d71 7565 7279 2052 6573 6572   f'--query Reser
-00014410: 7661 7469 6f6e 735b 5d2e 496e 7374 616e  vations[].Instan
-00014420: 6365 735b 5d2e 496e 7374 616e 6365 4964  ces[].InstanceId
-00014430: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-00014440: 272d 2d6f 7574 7075 7420 7465 7874 2927  '--output text)'
-00014450: 292c 0a20 2020 2020 2020 2020 2020 2027  ),.            '
-00014460: 736c 6565 7020 3530 272c 0a20 2020 2020  sleep 50',.     
-00014470: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
-00014480: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
-00014490: 7020 7b6e 616d 657d 207c 2068 6561 6420  p {name} | head 
-000144a0: 2d6e 3120 7c20 6772 6570 2022 5245 434f  -n1 | grep "RECO
-000144b0: 5645 5249 4e47 2227 2c0a 2020 2020 2020  VERING"',.      
-000144c0: 2020 2020 2020 2773 6c65 6570 2035 3630        'sleep 560
-000144d0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-000144e0: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
-000144f0: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
-00014500: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
-00014510: 6570 2022 5255 4e4e 494e 4722 272c 0a20  ep "RUNNING"',. 
-00014520: 2020 2020 2020 2020 2020 2066 2752 554e             f'RUN
-00014530: 5f49 443d 2428 6361 7420 2f74 6d70 2f7b  _ID=$(cat /tmp/{
-00014540: 6e61 6d65 7d2d 7275 6e2d 6964 293b 2065  name}-run-id); e
-00014550: 6368 6f20 2452 554e 5f49 443b 2073 6b79  cho $RUN_ID; sky
-00014560: 2073 706f 7420 6c6f 6773 202d 6e20 7b6e   spot logs -n {n
-00014570: 616d 657d 202d 2d6e 6f2d 666f 6c6c 6f77  ame} --no-follow
-00014580: 207c 2067 7265 7020 534b 5950 494c 4f54   | grep SKYPILOT
-00014590: 5f54 4153 4b5f 4944 207c 2063 7574 202d  _TASK_ID | cut -
-000145a0: 643a 202d 6632 207c 2067 7265 7020 2224  d: -f2 | grep "$
-000145b0: 5255 4e5f 4944 2227 2c0a 2020 2020 2020  RUN_ID"',.      
-000145c0: 2020 5d2c 0a20 2020 2020 2020 205f 5350    ],.        _SP
-000145d0: 4f54 5f43 414e 4345 4c5f 5741 4954 2e66  OT_CANCEL_WAIT.f
-000145e0: 6f72 6d61 7428 6a6f 625f 6e61 6d65 3d6e  ormat(job_name=n
-000145f0: 616d 6529 2c0a 2020 2020 2020 2020 7469  ame),.        ti
-00014600: 6d65 6f75 743d 3330 202a 2036 302c 0a20  meout=30 * 60,. 
-00014610: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-00014620: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
-00014630: 7974 6573 742e 6d61 726b 2e67 6370 0a40  ytest.mark.gcp.@
-00014640: 7079 7465 7374 2e6d 6172 6b2e 6d61 6e61  pytest.mark.mana
-00014650: 6765 645f 7370 6f74 0a64 6566 2074 6573  ged_spot.def tes
-00014660: 745f 7370 6f74 5f72 6563 6f76 6572 795f  t_spot_recovery_
-00014670: 6d75 6c74 695f 6e6f 6465 5f67 6370 2829  multi_node_gcp()
-00014680: 3a0a 2020 2020 2222 2254 6573 7420 6d61  :.    """Test ma
-00014690: 6e61 6765 6420 7370 6f74 2072 6563 6f76  naged spot recov
-000146a0: 6572 792e 2222 220a 2020 2020 6e61 6d65  ery.""".    name
-000146b0: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
-000146c0: 6e61 6d65 2829 0a20 2020 207a 6f6e 6520  name().    zone 
-000146d0: 3d20 2775 732d 7765 7374 322d 6127 0a20  = 'us-west2-a'. 
-000146e0: 2020 2023 2055 7365 2027 3a27 2074 6f20     # Use ':' to 
-000146f0: 6d61 7463 6820 6173 2074 6865 2063 6c75  match as the clu
-00014700: 7374 6572 206e 616d 6520 7769 6c6c 2063  ster name will c
-00014710: 6f6e 7461 696e 2074 6865 2073 7566 6669  ontain the suffi
-00014720: 7820 7769 7468 206a 6f62 2069 640a 2020  x with job id.  
-00014730: 2020 7175 6572 795f 636d 6420 3d20 280a    query_cmd = (.
-00014740: 2020 2020 2020 2020 6627 6763 6c6f 7564          f'gcloud
-00014750: 2063 6f6d 7075 7465 2069 6e73 7461 6e63   compute instanc
-00014760: 6573 206c 6973 7420 2d2d 6669 6c74 6572  es list --filter
-00014770: 3d27 0a20 2020 2020 2020 2066 2722 286c  ='.        f'"(l
-00014780: 6162 656c 732e 7261 792d 636c 7573 7465  abels.ray-cluste
-00014790: 722d 6e61 6d65 3a7b 6e61 6d65 7d20 414e  r-name:{name} AN
-000147a0: 4420 6c61 6265 6c73 2e72 6179 2d6e 6f64  D labels.ray-nod
-000147b0: 652d 7479 7065 3d77 6f72 6b65 7229 2220  e-type=worker)" 
-000147c0: 270a 2020 2020 2020 2020 6627 2d2d 7a6f  '.        f'--zo
-000147d0: 6e65 733d 7b7a 6f6e 657d 202d 2d66 6f72  nes={zone} --for
-000147e0: 6d61 743d 2276 616c 7565 286e 616d 6529  mat="value(name)
-000147f0: 2227 290a 2020 2020 7465 726d 696e 6174  "').    terminat
-00014800: 655f 636d 6420 3d20 2866 2767 636c 6f75  e_cmd = (f'gclou
-00014810: 6420 636f 6d70 7574 6520 696e 7374 616e  d compute instan
-00014820: 6365 7320 6465 6c65 7465 202d 2d7a 6f6e  ces delete --zon
-00014830: 653d 7b7a 6f6e 657d 270a 2020 2020 2020  e={zone}'.      
-00014840: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00014850: 2720 2d2d 7175 6965 7420 2428 7b71 7565  ' --quiet $({que
-00014860: 7279 5f63 6d64 7d29 2729 0a20 2020 2074  ry_cmd})').    t
-00014870: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-00014880: 2020 2020 2773 706f 745f 7265 636f 7665      'spot_recove
-00014890: 7279 5f6d 756c 7469 5f6e 6f64 655f 6763  ry_multi_node_gc
-000148a0: 7027 2c0a 2020 2020 2020 2020 5b0a 2020  p',.        [.  
-000148b0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-000148c0: 7370 6f74 206c 6175 6e63 6820 2d2d 636c  spot launch --cl
-000148d0: 6f75 6420 6763 7020 2d2d 7a6f 6e65 207b  oud gcp --zone {
-000148e0: 7a6f 6e65 7d20 2d6e 207b 6e61 6d65 7d20  zone} -n {name} 
-000148f0: 2d2d 6e75 6d2d 6e6f 6465 7320 3220 2265  --num-nodes 2 "e
-00014900: 6368 6f20 534b 5950 494c 4f54 5f54 4153  cho SKYPILOT_TAS
-00014910: 4b5f 4944 3a20 5c24 534b 5950 494c 4f54  K_ID: \$SKYPILOT
-00014920: 5f54 4153 4b5f 4944 3b20 736c 6565 7020  _TASK_ID; sleep 
-00014930: 3138 3030 2220 202d 7920 2d64 272c 0a20  1800"  -y -d',. 
-00014940: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-00014950: 7020 3430 3027 2c0a 2020 2020 2020 2020  p 400',.        
-00014960: 2020 2020 6627 7b5f 5350 4f54 5f51 5545      f'{_SPOT_QUE
-00014970: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
-00014980: 6e61 6d65 7d20 7c20 6865 6164 202d 6e31  name} | head -n1
-00014990: 207c 2067 7265 7020 2252 554e 4e49 4e47   | grep "RUNNING
-000149a0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-000149b0: 6627 5255 4e5f 4944 3d24 2873 6b79 2073  f'RUN_ID=$(sky s
-000149c0: 706f 7420 6c6f 6773 202d 6e20 7b6e 616d  pot logs -n {nam
-000149d0: 657d 202d 2d6e 6f2d 666f 6c6c 6f77 207c  e} --no-follow |
-000149e0: 2067 7265 7020 534b 5950 494c 4f54 5f54   grep SKYPILOT_T
-000149f0: 4153 4b5f 4944 207c 2063 7574 202d 643a  ASK_ID | cut -d:
-00014a00: 202d 6632 293b 2065 6368 6f20 2224 5255   -f2); echo "$RU
-00014a10: 4e5f 4944 2220 7c20 7465 6520 2f74 6d70  N_ID" | tee /tmp
-00014a20: 2f7b 6e61 6d65 7d2d 7275 6e2d 6964 272c  /{name}-run-id',
-00014a30: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
-00014a40: 6572 6d69 6e61 7465 2074 6865 2077 6f72  erminate the wor
-00014a50: 6b65 7220 6d61 6e75 616c 6c79 2e0a 2020  ker manually..  
-00014a60: 2020 2020 2020 2020 2020 7465 726d 696e            termin
-00014a70: 6174 655f 636d 642c 0a20 2020 2020 2020  ate_cmd,.       
-00014a80: 2020 2020 2027 736c 6565 7020 3530 272c       'sleep 50',
-00014a90: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
-00014aa0: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
-00014ab0: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
-00014ac0: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
-00014ad0: 2022 5245 434f 5645 5249 4e47 2227 2c0a   "RECOVERING"',.
-00014ae0: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
-00014af0: 6570 2034 3230 272c 0a20 2020 2020 2020  ep 420',.       
-00014b00: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
-00014b10: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
-00014b20: 7b6e 616d 657d 207c 2068 6561 6420 2d6e  {name} | head -n
-00014b30: 3120 7c20 6772 6570 2022 5255 4e4e 494e  1 | grep "RUNNIN
-00014b40: 4722 272c 0a20 2020 2020 2020 2020 2020  G"',.           
-00014b50: 2066 2752 554e 5f49 443d 2428 6361 7420   f'RUN_ID=$(cat 
-00014b60: 2f74 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d  /tmp/{name}-run-
-00014b70: 6964 293b 2065 6368 6f20 2452 554e 5f49  id); echo $RUN_I
-00014b80: 443b 2073 6b79 2073 706f 7420 6c6f 6773  D; sky spot logs
-00014b90: 202d 6e20 7b6e 616d 657d 202d 2d6e 6f2d   -n {name} --no-
-00014ba0: 666f 6c6c 6f77 207c 2067 7265 7020 534b  follow | grep SK
-00014bb0: 5950 494c 4f54 5f54 4153 4b5f 4944 207c  YPILOT_TASK_ID |
-00014bc0: 2063 7574 202d 643a 202d 6632 207c 2067   cut -d: -f2 | g
-00014bd0: 7265 7020 2224 5255 4e5f 4944 2227 2c0a  rep "$RUN_ID"',.
-00014be0: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-00014bf0: 2020 205f 5350 4f54 5f43 414e 4345 4c5f     _SPOT_CANCEL_
-00014c00: 5741 4954 2e66 6f72 6d61 7428 6a6f 625f  WAIT.format(job_
-00014c10: 6e61 6d65 3d6e 616d 6529 2c0a 2020 2020  name=name),.    
-00014c20: 2020 2020 7469 6d65 6f75 743d 3235 202a      timeout=25 *
-00014c30: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
-00014c40: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-00014c50: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
-00014c60: 2e61 7773 0a40 7079 7465 7374 2e6d 6172  .aws.@pytest.mar
-00014c70: 6b2e 6d61 6e61 6765 645f 7370 6f74 0a64  k.managed_spot.d
-00014c80: 6566 2074 6573 745f 7370 6f74 5f63 616e  ef test_spot_can
-00014c90: 6365 6c6c 6174 696f 6e5f 6177 7328 6177  cellation_aws(aw
-00014ca0: 735f 636f 6e66 6967 5f72 6567 696f 6e29  s_config_region)
-00014cb0: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
-00014cc0: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
-00014cd0: 0a20 2020 2072 6567 696f 6e20 3d20 6177  .    region = aw
-00014ce0: 735f 636f 6e66 6967 5f72 6567 696f 6e0a  s_config_region.
-00014cf0: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-00014d00: 0a20 2020 2020 2020 2027 7370 6f74 5f63  .        'spot_c
-00014d10: 616e 6365 6c6c 6174 696f 6e5f 6177 7327  ancellation_aws'
-00014d20: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-00014d30: 2020 2020 2020 2020 2320 5465 7374 2063          # Test c
-00014d40: 616e 6365 6c6c 6174 696f 6e20 6475 7269  ancellation duri
-00014d50: 6e67 2073 706f 7420 636c 7573 7465 7220  ng spot cluster 
-00014d60: 6265 696e 6720 6c61 756e 6368 6564 2e0a  being launched..
-00014d70: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00014d80: 7920 7370 6f74 206c 6175 6e63 6820 2d2d  y spot launch --
-00014d90: 636c 6f75 6420 6177 7320 2d2d 7265 6769  cloud aws --regi
-00014da0: 6f6e 207b 7265 6769 6f6e 7d20 2d6e 207b  on {region} -n {
-00014db0: 6e61 6d65 7d20 2273 6c65 6570 2031 3030  name} "sleep 100
-00014dc0: 3022 2020 2d79 202d 6427 2c0a 2020 2020  0"  -y -d',.    
-00014dd0: 2020 2020 2020 2020 2773 6c65 6570 2036          'sleep 6
-00014de0: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
-00014df0: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
-00014e00: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
-00014e10: 7d20 7c20 6865 6164 202d 6e31 207c 2067  } | head -n1 | g
-00014e20: 7265 7020 2253 5441 5254 494e 4722 272c  rep "STARTING"',
-00014e30: 0a20 2020 2020 2020 2020 2020 205f 5350  .            _SP
-00014e40: 4f54 5f43 414e 4345 4c5f 5741 4954 2e66  OT_CANCEL_WAIT.f
-00014e50: 6f72 6d61 7428 6a6f 625f 6e61 6d65 3d6e  ormat(job_name=n
-00014e60: 616d 6529 2c0a 2020 2020 2020 2020 2020  ame),.          
-00014e70: 2020 2773 6c65 6570 2035 272c 0a20 2020    'sleep 5',.   
-00014e80: 2020 2020 2020 2020 2066 277b 5f53 504f           f'{_SPO
-00014e90: 545f 5155 4555 455f 5741 4954 7d7c 2067  T_QUEUE_WAIT}| g
-00014ea0: 7265 7020 7b6e 616d 657d 207c 2068 6561  rep {name} | hea
-00014eb0: 6420 2d6e 3120 7c20 6772 6570 2022 4341  d -n1 | grep "CA
-00014ec0: 4e43 454c 4c49 4e47 5c7c 4341 4e43 454c  NCELLING\|CANCEL
-00014ed0: 4c45 4422 272c 0a20 2020 2020 2020 2020  LED"',.         
-00014ee0: 2020 2027 736c 6565 7020 3132 3027 2c0a     'sleep 120',.
-00014ef0: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
-00014f00: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
-00014f10: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
-00014f20: 6865 6164 202d 6e31 207c 2067 7265 7020  head -n1 | grep 
-00014f30: 2243 414e 4345 4c4c 4544 2227 2c0a 2020  "CANCELLED"',.  
-00014f40: 2020 2020 2020 2020 2020 2866 2773 3d24            (f's=$
-00014f50: 2861 7773 2065 6332 2064 6573 6372 6962  (aws ec2 describ
-00014f60: 652d 696e 7374 616e 6365 7320 2d2d 7265  e-instances --re
-00014f70: 6769 6f6e 207b 7265 6769 6f6e 7d20 270a  gion {region} '.
-00014f80: 2020 2020 2020 2020 2020 2020 2066 272d               f'-
-00014f90: 2d66 696c 7465 7273 204e 616d 653d 7461  -filters Name=ta
-00014fa0: 673a 7261 792d 636c 7573 7465 722d 6e61  g:ray-cluster-na
-00014fb0: 6d65 2c56 616c 7565 733d 7b6e 616d 657d  me,Values={name}
-00014fc0: 2d2a 2027 0a20 2020 2020 2020 2020 2020  -* '.           
-00014fd0: 2020 6627 2d2d 7175 6572 7920 5265 7365    f'--query Rese
-00014fe0: 7276 6174 696f 6e73 5b5d 2e49 6e73 7461  rvations[].Insta
-00014ff0: 6e63 6573 5b5d 2e53 7461 7465 5b5d 2e4e  nces[].State[].N
-00015000: 616d 6520 270a 2020 2020 2020 2020 2020  ame '.          
-00015010: 2020 2027 2d2d 6f75 7470 7574 2074 6578     '--output tex
-00015020: 7429 2026 2620 6563 686f 2022 2473 2220  t) && echo "$s" 
-00015030: 2626 2065 6368 6f3b 205b 5b20 2d7a 2022  && echo; [[ -z "
-00015040: 2473 2220 5d5d 207c 7c20 5b5b 2022 2473  $s" ]] || [[ "$s
-00015050: 2220 3d20 2274 6572 6d69 6e61 7465 6422  " = "terminated"
-00015060: 205d 5d20 7c7c 205b 5b20 2224 7322 203d   ]] || [[ "$s" =
-00015070: 2022 7368 7574 7469 6e67 2d64 6f77 6e22   "shutting-down"
-00015080: 205d 5d27 0a20 2020 2020 2020 2020 2020   ]]'.           
-00015090: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
-000150a0: 2320 5465 7374 2063 616e 6365 6c6c 696e  # Test cancellin
-000150b0: 6720 7468 6520 7370 6f74 2063 6c75 7374  g the spot clust
-000150c0: 6572 2064 7572 696e 6720 7370 6f74 206a  er during spot j
-000150d0: 6f62 2062 6569 6e67 2073 6574 7570 2e0a  ob being setup..
-000150e0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-000150f0: 7920 7370 6f74 206c 6175 6e63 6820 2d2d  y spot launch --
-00015100: 636c 6f75 6420 6177 7320 2d2d 7265 6769  cloud aws --regi
-00015110: 6f6e 207b 7265 6769 6f6e 7d20 2d6e 207b  on {region} -n {
-00015120: 6e61 6d65 7d2d 3220 7465 7374 732f 7465  name}-2 tests/te
-00015130: 7374 5f79 616d 6c73 2f74 6573 745f 6c6f  st_yamls/test_lo
-00015140: 6e67 5f73 6574 7570 2e79 616d 6c20 202d  ng_setup.yaml  -
-00015150: 7920 2d64 272c 0a20 2020 2020 2020 2020  y -d',.         
-00015160: 2020 2027 736c 6565 7020 3330 3027 2c0a     'sleep 300',.
-00015170: 2020 2020 2020 2020 2020 2020 5f53 504f              _SPO
-00015180: 545f 4341 4e43 454c 5f57 4149 542e 666f  T_CANCEL_WAIT.fo
-00015190: 726d 6174 286a 6f62 5f6e 616d 653d 6627  rmat(job_name=f'
-000151a0: 7b6e 616d 657d 2d32 2729 2c0a 2020 2020  {name}-2'),.    
-000151b0: 2020 2020 2020 2020 2773 6c65 6570 2035          'sleep 5
-000151c0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-000151d0: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
-000151e0: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
-000151f0: 2d32 207c 2068 6561 6420 2d6e 3120 7c20  -2 | head -n1 | 
-00015200: 6772 6570 2022 4341 4e43 454c 4c49 4e47  grep "CANCELLING
-00015210: 5c7c 4341 4e43 454c 4c45 4422 272c 0a20  \|CANCELLED"',. 
-00015220: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-00015230: 7020 3132 3027 2c0a 2020 2020 2020 2020  p 120',.        
-00015240: 2020 2020 6627 7b5f 5350 4f54 5f51 5545      f'{_SPOT_QUE
-00015250: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
-00015260: 6e61 6d65 7d2d 3220 7c20 6865 6164 202d  name}-2 | head -
-00015270: 6e31 207c 2067 7265 7020 2243 414e 4345  n1 | grep "CANCE
-00015280: 4c4c 4544 2227 2c0a 2020 2020 2020 2020  LLED"',.        
-00015290: 2020 2020 2866 2773 3d24 2861 7773 2065      (f's=$(aws e
-000152a0: 6332 2064 6573 6372 6962 652d 696e 7374  c2 describe-inst
-000152b0: 616e 6365 7320 2d2d 7265 6769 6f6e 207b  ances --region {
-000152c0: 7265 6769 6f6e 7d20 270a 2020 2020 2020  region} '.      
-000152d0: 2020 2020 2020 2066 272d 2d66 696c 7465         f'--filte
-000152e0: 7273 204e 616d 653d 7461 673a 7261 792d  rs Name=tag:ray-
-000152f0: 636c 7573 7465 722d 6e61 6d65 2c56 616c  cluster-name,Val
-00015300: 7565 733d 7b6e 616d 657d 2d32 2d2a 2027  ues={name}-2-* '
-00015310: 0a20 2020 2020 2020 2020 2020 2020 6627  .             f'
-00015320: 2d2d 7175 6572 7920 5265 7365 7276 6174  --query Reservat
-00015330: 696f 6e73 5b5d 2e49 6e73 7461 6e63 6573  ions[].Instances
-00015340: 5b5d 2e53 7461 7465 5b5d 2e4e 616d 6520  [].State[].Name 
-00015350: 270a 2020 2020 2020 2020 2020 2020 2027  '.             '
-00015360: 2d2d 6f75 7470 7574 2074 6578 7429 2026  --output text) &
-00015370: 2620 6563 686f 2022 2473 2220 2626 2065  & echo "$s" && e
-00015380: 6368 6f3b 205b 5b20 2d7a 2022 2473 2220  cho; [[ -z "$s" 
-00015390: 5d5d 207c 7c20 5b5b 2022 2473 2220 3d20  ]] || [[ "$s" = 
-000153a0: 2274 6572 6d69 6e61 7465 6422 205d 5d20  "terminated" ]] 
-000153b0: 7c7c 205b 5b20 2224 7322 203d 2022 7368  || [[ "$s" = "sh
-000153c0: 7574 7469 6e67 2d64 6f77 6e22 205d 5d27  utting-down" ]]'
-000153d0: 0a20 2020 2020 2020 2020 2020 2029 2c0a  .            ),.
-000153e0: 2020 2020 2020 2020 2020 2020 2320 5465              # Te
-000153f0: 7374 2063 616e 6365 6c6c 6174 696f 6e20  st cancellation 
-00015400: 6475 7269 6e67 2073 706f 7420 6a6f 6220  during spot job 
-00015410: 6973 2072 6563 6f76 6572 696e 672e 0a20  is recovering.. 
-00015420: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00015430: 2073 706f 7420 6c61 756e 6368 202d 2d63   spot launch --c
-00015440: 6c6f 7564 2061 7773 202d 2d72 6567 696f  loud aws --regio
-00015450: 6e20 7b72 6567 696f 6e7d 202d 6e20 7b6e  n {region} -n {n
-00015460: 616d 657d 2d33 2022 736c 6565 7020 3130  ame}-3 "sleep 10
-00015470: 3030 2220 202d 7920 2d64 272c 0a20 2020  00"  -y -d',.   
-00015480: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-00015490: 3330 3027 2c0a 2020 2020 2020 2020 2020  300',.          
-000154a0: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
-000154b0: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
-000154c0: 6d65 7d2d 3320 7c20 6865 6164 202d 6e31  me}-3 | head -n1
-000154d0: 207c 2067 7265 7020 2252 554e 4e49 4e47   | grep "RUNNING
-000154e0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-000154f0: 2320 5465 726d 696e 6174 6520 7468 6520  # Terminate the 
-00015500: 636c 7573 7465 7220 6d61 6e75 616c 6c79  cluster manually
-00015510: 2e0a 2020 2020 2020 2020 2020 2020 2866  ..            (f
-00015520: 2761 7773 2065 6332 2074 6572 6d69 6e61  'aws ec2 termina
-00015530: 7465 2d69 6e73 7461 6e63 6573 202d 2d72  te-instances --r
-00015540: 6567 696f 6e20 7b72 6567 696f 6e7d 202d  egion {region} -
-00015550: 2d69 6e73 7461 6e63 652d 6964 7320 2428  -instance-ids $(
-00015560: 270a 2020 2020 2020 2020 2020 2020 2066  '.             f
-00015570: 2761 7773 2065 6332 2064 6573 6372 6962  'aws ec2 describ
-00015580: 652d 696e 7374 616e 6365 7320 2d2d 7265  e-instances --re
-00015590: 6769 6f6e 207b 7265 6769 6f6e 7d20 270a  gion {region} '.
-000155a0: 2020 2020 2020 2020 2020 2020 2066 272d               f'-
-000155b0: 2d66 696c 7465 7273 204e 616d 653d 7461  -filters Name=ta
-000155c0: 673a 7261 792d 636c 7573 7465 722d 6e61  g:ray-cluster-na
-000155d0: 6d65 2c56 616c 7565 733d 7b6e 616d 657d  me,Values={name}
-000155e0: 2d33 2d2a 2027 0a20 2020 2020 2020 2020  -3-* '.         
-000155f0: 2020 2020 6627 2d2d 7175 6572 7920 5265      f'--query Re
-00015600: 7365 7276 6174 696f 6e73 5b5d 2e49 6e73  servations[].Ins
-00015610: 7461 6e63 6573 5b5d 2e49 6e73 7461 6e63  tances[].Instanc
-00015620: 6549 6420 270a 2020 2020 2020 2020 2020  eId '.          
-00015630: 2020 2027 2d2d 6f75 7470 7574 2074 6578     '--output tex
-00015640: 7429 2729 2c0a 2020 2020 2020 2020 2020  t)'),.          
-00015650: 2020 2773 6c65 6570 2031 3230 272c 0a20    'sleep 120',. 
-00015660: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
-00015670: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
-00015680: 2067 7265 7020 7b6e 616d 657d 2d33 207c   grep {name}-3 |
-00015690: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
-000156a0: 2022 5245 434f 5645 5249 4e47 2227 2c0a   "RECOVERING"',.
-000156b0: 2020 2020 2020 2020 2020 2020 5f53 504f              _SPO
-000156c0: 545f 4341 4e43 454c 5f57 4149 542e 666f  T_CANCEL_WAIT.fo
-000156d0: 726d 6174 286a 6f62 5f6e 616d 653d 6627  rmat(job_name=f'
-000156e0: 7b6e 616d 657d 2d33 2729 2c0a 2020 2020  {name}-3'),.    
-000156f0: 2020 2020 2020 2020 2773 6c65 6570 2035          'sleep 5
-00015700: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00015710: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
-00015720: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
-00015730: 2d33 207c 2068 6561 6420 2d6e 3120 7c20  -3 | head -n1 | 
-00015740: 6772 6570 2022 4341 4e43 454c 4c49 4e47  grep "CANCELLING
-00015750: 5c7c 4341 4e43 454c 4c45 4422 272c 0a20  \|CANCELLED"',. 
-00015760: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-00015770: 7020 3132 3027 2c0a 2020 2020 2020 2020  p 120',.        
-00015780: 2020 2020 6627 7b5f 5350 4f54 5f51 5545      f'{_SPOT_QUE
-00015790: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
-000157a0: 6e61 6d65 7d2d 3320 7c20 6865 6164 202d  name}-3 | head -
-000157b0: 6e31 207c 2067 7265 7020 2243 414e 4345  n1 | grep "CANCE
-000157c0: 4c4c 4544 2227 2c0a 2020 2020 2020 2020  LLED"',.        
-000157d0: 2020 2020 2320 5468 6520 636c 7573 7465      # The cluste
-000157e0: 7220 7368 6f75 6c64 2062 6520 7465 726d  r should be term
-000157f0: 696e 6174 6564 2028 7368 7574 7469 6e67  inated (shutting
-00015800: 2d64 6f77 6e29 2061 6674 6572 2063 616e  -down) after can
-00015810: 6365 6c6c 6174 696f 6e2e 2057 6520 646f  cellation. We do
-00015820: 6e27 7420 7573 6520 7468 6520 603d 6020  n't use the `=` 
-00015830: 6f70 6572 6174 6f72 2068 6572 6520 6265  operator here be
-00015840: 6361 7573 650a 2020 2020 2020 2020 2020  cause.          
-00015850: 2020 2320 7468 6572 6520 6361 6e20 6265    # there can be
-00015860: 206d 756c 7469 706c 6520 564d 2077 6974   multiple VM wit
-00015870: 6820 7468 6520 7361 6d65 206e 616d 6520  h the same name 
-00015880: 6475 6520 746f 2074 6865 2072 6563 6f76  due to the recov
-00015890: 6572 792e 0a20 2020 2020 2020 2020 2020  ery..           
-000158a0: 2028 6627 733d 2428 6177 7320 6563 3220   (f's=$(aws ec2 
-000158b0: 6465 7363 7269 6265 2d69 6e73 7461 6e63  describe-instanc
-000158c0: 6573 202d 2d72 6567 696f 6e20 7b72 6567  es --region {reg
-000158d0: 696f 6e7d 2027 0a20 2020 2020 2020 2020  ion} '.         
-000158e0: 2020 2020 6627 2d2d 6669 6c74 6572 7320      f'--filters 
-000158f0: 4e61 6d65 3d74 6167 3a72 6179 2d63 6c75  Name=tag:ray-clu
-00015900: 7374 6572 2d6e 616d 652c 5661 6c75 6573  ster-name,Values
-00015910: 3d7b 6e61 6d65 7d2d 332d 2a20 270a 2020  ={name}-3-* '.  
-00015920: 2020 2020 2020 2020 2020 2066 272d 2d71             f'--q
-00015930: 7565 7279 2052 6573 6572 7661 7469 6f6e  uery Reservation
-00015940: 735b 5d2e 496e 7374 616e 6365 735b 5d2e  s[].Instances[].
-00015950: 5374 6174 655b 5d2e 4e61 6d65 2027 0a20  State[].Name '. 
-00015960: 2020 2020 2020 2020 2020 2020 272d 2d6f              '--o
-00015970: 7574 7075 7420 7465 7874 2920 2626 2065  utput text) && e
-00015980: 6368 6f20 2224 7322 2026 2620 6563 686f  cho "$s" && echo
-00015990: 3b20 5b5b 202d 7a20 2224 7322 205d 5d20  ; [[ -z "$s" ]] 
-000159a0: 7c7c 2065 6368 6f20 2224 7322 207c 2067  || echo "$s" | g
-000159b0: 7265 7020 2d76 202d 4520 2270 656e 6469  rep -v -E "pendi
-000159c0: 6e67 7c72 756e 6e69 6e67 7c73 746f 7070  ng|running|stopp
-000159d0: 6564 7c73 746f 7070 696e 6722 270a 2020  ed|stopping"'.  
-000159e0: 2020 2020 2020 2020 2020 292c 0a20 2020            ),.   
-000159f0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-00015a00: 7469 6d65 6f75 743d 3235 202a 2036 3029  timeout=25 * 60)
-00015a10: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-00015a20: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
-00015a30: 742e 6d61 726b 2e67 6370 0a40 7079 7465  t.mark.gcp.@pyte
-00015a40: 7374 2e6d 6172 6b2e 6d61 6e61 6765 645f  st.mark.managed_
-00015a50: 7370 6f74 0a64 6566 2074 6573 745f 7370  spot.def test_sp
-00015a60: 6f74 5f63 616e 6365 6c6c 6174 696f 6e5f  ot_cancellation_
-00015a70: 6763 7028 293a 0a20 2020 206e 616d 6520  gcp():.    name 
-00015a80: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-00015a90: 616d 6528 290a 2020 2020 7a6f 6e65 203d  ame().    zone =
-00015aa0: 2027 7573 2d77 6573 7433 2d62 270a 2020   'us-west3-b'.  
-00015ab0: 2020 7175 6572 795f 7374 6174 655f 636d    query_state_cm
-00015ac0: 6420 3d20 2827 6763 6c6f 7564 2063 6f6d  d = ('gcloud com
-00015ad0: 7075 7465 2069 6e73 7461 6e63 6573 206c  pute instances l
-00015ae0: 6973 7420 270a 2020 2020 2020 2020 2020  ist '.          
-00015af0: 2020 2020 2020 2020 2020 2020 2066 272d               f'-
-00015b00: 2d66 696c 7465 723d 2228 6c61 6265 6c73  -filter="(labels
-00015b10: 2e72 6179 2d63 6c75 7374 6572 2d6e 616d  .ray-cluster-nam
-00015b20: 653a 7b6e 616d 657d 2922 2027 0a20 2020  e:{name})" '.   
-00015b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015b40: 2020 2020 272d 2d66 6f72 6d61 743d 2276      '--format="v
-00015b50: 616c 7565 2873 7461 7475 7329 2227 290a  alue(status)"').
-00015b60: 2020 2020 7175 6572 795f 636d 6420 3d20      query_cmd = 
-00015b70: 2866 2767 636c 6f75 6420 636f 6d70 7574  (f'gcloud comput
-00015b80: 6520 696e 7374 616e 6365 7320 6c69 7374  e instances list
-00015b90: 202d 2d66 696c 7465 723d 270a 2020 2020   --filter='.    
-00015ba0: 2020 2020 2020 2020 2020 2020 2066 2722               f'"
-00015bb0: 286c 6162 656c 732e 7261 792d 636c 7573  (labels.ray-clus
-00015bc0: 7465 722d 6e61 6d65 3a7b 6e61 6d65 7d29  ter-name:{name})
-00015bd0: 2220 270a 2020 2020 2020 2020 2020 2020  " '.            
-00015be0: 2020 2020 2066 272d 2d7a 6f6e 6573 3d7b       f'--zones={
-00015bf0: 7a6f 6e65 7d20 2d2d 666f 726d 6174 3d22  zone} --format="
-00015c00: 7661 6c75 6528 6e61 6d65 2922 2729 0a20  value(name)"'). 
-00015c10: 2020 2074 6572 6d69 6e61 7465 5f63 6d64     terminate_cmd
-00015c20: 203d 2028 6627 6763 6c6f 7564 2063 6f6d   = (f'gcloud com
-00015c30: 7075 7465 2069 6e73 7461 6e63 6573 2064  pute instances d
-00015c40: 656c 6574 6520 2d2d 7a6f 6e65 3d7b 7a6f  elete --zone={zo
-00015c50: 6e65 7d27 0a20 2020 2020 2020 2020 2020  ne}'.           
-00015c60: 2020 2020 2020 2020 2020 6627 202d 2d71            f' --q
-00015c70: 7569 6574 2024 287b 7175 6572 795f 636d  uiet $({query_cm
-00015c80: 647d 2927 290a 2020 2020 7465 7374 203d  d})').    test =
-00015c90: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-00015ca0: 7370 6f74 5f63 616e 6365 6c6c 6174 696f  spot_cancellatio
-00015cb0: 6e5f 6763 7027 2c0a 2020 2020 2020 2020  n_gcp',.        
-00015cc0: 5b0a 2020 2020 2020 2020 2020 2020 2320  [.            # 
-00015cd0: 5465 7374 2063 616e 6365 6c6c 6174 696f  Test cancellatio
-00015ce0: 6e20 6475 7269 6e67 2073 706f 7420 636c  n during spot cl
-00015cf0: 7573 7465 7220 6265 696e 6720 6c61 756e  uster being laun
-00015d00: 6368 6564 2e0a 2020 2020 2020 2020 2020  ched..          
-00015d10: 2020 6627 736b 7920 7370 6f74 206c 6175    f'sky spot lau
-00015d20: 6e63 6820 2d2d 636c 6f75 6420 6763 7020  nch --cloud gcp 
-00015d30: 2d2d 7a6f 6e65 207b 7a6f 6e65 7d20 2d6e  --zone {zone} -n
-00015d40: 207b 6e61 6d65 7d20 2273 6c65 6570 2031   {name} "sleep 1
-00015d50: 3030 3022 2020 2d79 202d 6427 2c0a 2020  000"  -y -d',.  
-00015d60: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
-00015d70: 2036 3027 2c0a 2020 2020 2020 2020 2020   60',.          
-00015d80: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
-00015d90: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
-00015da0: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
-00015db0: 2067 7265 7020 2253 5441 5254 494e 4722   grep "STARTING"
-00015dc0: 272c 0a20 2020 2020 2020 2020 2020 205f  ',.            _
-00015dd0: 5350 4f54 5f43 414e 4345 4c5f 5741 4954  SPOT_CANCEL_WAIT
-00015de0: 2e66 6f72 6d61 7428 6a6f 625f 6e61 6d65  .format(job_name
-00015df0: 3d6e 616d 6529 2c0a 2020 2020 2020 2020  =name),.        
-00015e00: 2020 2020 2773 6c65 6570 2035 272c 0a20      'sleep 5',. 
-00015e10: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
-00015e20: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
-00015e30: 2067 7265 7020 7b6e 616d 657d 207c 2068   grep {name} | h
-00015e40: 6561 6420 2d6e 3120 7c20 6772 6570 2022  ead -n1 | grep "
-00015e50: 4341 4e43 454c 4c49 4e47 5c7c 4341 4e43  CANCELLING\|CANC
-00015e60: 454c 4c45 4422 272c 0a20 2020 2020 2020  ELLED"',.       
-00015e70: 2020 2020 2027 736c 6565 7020 3132 3027       'sleep 120'
-00015e80: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00015e90: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
-00015ea0: 547d 7c20 6772 6570 207b 6e61 6d65 7d20  T}| grep {name} 
-00015eb0: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
-00015ec0: 7020 2243 414e 4345 4c4c 4544 2227 2c0a  p "CANCELLED"',.
-00015ed0: 2020 2020 2020 2020 2020 2020 2320 5465              # Te
-00015ee0: 7374 2063 616e 6365 6c6c 696e 6720 7468  st cancelling th
-00015ef0: 6520 7370 6f74 2063 6c75 7374 6572 2064  e spot cluster d
-00015f00: 7572 696e 6720 7370 6f74 206a 6f62 2062  uring spot job b
-00015f10: 6569 6e67 2073 6574 7570 2e0a 2020 2020  eing setup..    
-00015f20: 2020 2020 2020 2020 6627 736b 7920 7370          f'sky sp
-00015f30: 6f74 206c 6175 6e63 6820 2d2d 636c 6f75  ot launch --clou
-00015f40: 6420 6763 7020 2d2d 7a6f 6e65 207b 7a6f  d gcp --zone {zo
-00015f50: 6e65 7d20 2d6e 207b 6e61 6d65 7d2d 3220  ne} -n {name}-2 
-00015f60: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
-00015f70: 2f74 6573 745f 6c6f 6e67 5f73 6574 7570  /test_long_setup
-00015f80: 2e79 616d 6c20 202d 7920 2d64 272c 0a20  .yaml  -y -d',. 
-00015f90: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-00015fa0: 7020 3330 3027 2c0a 2020 2020 2020 2020  p 300',.        
-00015fb0: 2020 2020 5f53 504f 545f 4341 4e43 454c      _SPOT_CANCEL
-00015fc0: 5f57 4149 542e 666f 726d 6174 286a 6f62  _WAIT.format(job
-00015fd0: 5f6e 616d 653d 6627 7b6e 616d 657d 2d32  _name=f'{name}-2
-00015fe0: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
-00015ff0: 2773 6c65 6570 2035 272c 0a20 2020 2020  'sleep 5',.     
-00016000: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
-00016010: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
-00016020: 7020 7b6e 616d 657d 2d32 207c 2068 6561  p {name}-2 | hea
-00016030: 6420 2d6e 3120 7c20 6772 6570 2022 4341  d -n1 | grep "CA
-00016040: 4e43 454c 4c49 4e47 5c7c 4341 4e43 454c  NCELLING\|CANCEL
-00016050: 4c45 4422 272c 0a20 2020 2020 2020 2020  LED"',.         
-00016060: 2020 2027 736c 6565 7020 3132 3027 2c0a     'sleep 120',.
-00016070: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
-00016080: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
-00016090: 7c20 6772 6570 207b 6e61 6d65 7d2d 3220  | grep {name}-2 
-000160a0: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
-000160b0: 7020 2243 414e 4345 4c4c 4544 2227 2c0a  p "CANCELLED"',.
-000160c0: 2020 2020 2020 2020 2020 2020 2320 5465              # Te
-000160d0: 7374 2063 616e 6365 6c6c 6174 696f 6e20  st cancellation 
-000160e0: 6475 7269 6e67 2073 706f 7420 6a6f 6220  during spot job 
-000160f0: 6973 2072 6563 6f76 6572 696e 672e 0a20  is recovering.. 
-00016100: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00016110: 2073 706f 7420 6c61 756e 6368 202d 2d63   spot launch --c
-00016120: 6c6f 7564 2067 6370 202d 2d7a 6f6e 6520  loud gcp --zone 
-00016130: 7b7a 6f6e 657d 202d 6e20 7b6e 616d 657d  {zone} -n {name}
-00016140: 2d33 2022 736c 6565 7020 3130 3030 2220  -3 "sleep 1000" 
-00016150: 202d 7920 2d64 272c 0a20 2020 2020 2020   -y -d',.       
-00016160: 2020 2020 2027 736c 6565 7020 3330 3027       'sleep 300'
-00016170: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00016180: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
-00016190: 547d 7c20 6772 6570 207b 6e61 6d65 7d2d  T}| grep {name}-
-000161a0: 3320 7c20 6865 6164 202d 6e31 207c 2067  3 | head -n1 | g
-000161b0: 7265 7020 2252 554e 4e49 4e47 2227 2c0a  rep "RUNNING"',.
-000161c0: 2020 2020 2020 2020 2020 2020 2320 5465              # Te
-000161d0: 726d 696e 6174 6520 7468 6520 636c 7573  rminate the clus
-000161e0: 7465 7220 6d61 6e75 616c 6c79 2e0a 2020  ter manually..  
-000161f0: 2020 2020 2020 2020 2020 7465 726d 696e            termin
-00016200: 6174 655f 636d 642c 0a20 2020 2020 2020  ate_cmd,.       
-00016210: 2020 2020 2027 736c 6565 7020 3130 3027       'sleep 100'
-00016220: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00016230: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
-00016240: 547d 7c20 6772 6570 207b 6e61 6d65 7d2d  T}| grep {name}-
-00016250: 3320 7c20 6865 6164 202d 6e31 207c 2067  3 | head -n1 | g
-00016260: 7265 7020 2252 4543 4f56 4552 494e 4722  rep "RECOVERING"
-00016270: 272c 0a20 2020 2020 2020 2020 2020 205f  ',.            _
-00016280: 5350 4f54 5f43 414e 4345 4c5f 5741 4954  SPOT_CANCEL_WAIT
-00016290: 2e66 6f72 6d61 7428 6a6f 625f 6e61 6d65  .format(job_name
-000162a0: 3d66 277b 6e61 6d65 7d2d 3327 292c 0a20  =f'{name}-3'),. 
-000162b0: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-000162c0: 7020 3527 2c0a 2020 2020 2020 2020 2020  p 5',.          
-000162d0: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
-000162e0: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
-000162f0: 6d65 7d2d 3320 7c20 6865 6164 202d 6e31  me}-3 | head -n1
-00016300: 207c 2067 7265 7020 2243 414e 4345 4c4c   | grep "CANCELL
-00016310: 494e 475c 7c43 414e 4345 4c4c 4544 2227  ING\|CANCELLED"'
-00016320: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
-00016330: 6c65 6570 2031 3230 272c 0a20 2020 2020  leep 120',.     
-00016340: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
-00016350: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
-00016360: 7020 7b6e 616d 657d 2d33 207c 2068 6561  p {name}-3 | hea
-00016370: 6420 2d6e 3120 7c20 6772 6570 2022 4341  d -n1 | grep "CA
-00016380: 4e43 454c 4c45 4422 272c 0a20 2020 2020  NCELLED"',.     
-00016390: 2020 2020 2020 2023 2054 6865 2063 6c75         # The clu
-000163a0: 7374 6572 2073 686f 756c 6420 6265 2074  ster should be t
-000163b0: 6572 6d69 6e61 7465 6420 2853 544f 5050  erminated (STOPP
-000163c0: 494e 4729 2061 6674 6572 2063 616e 6365  ING) after cance
-000163d0: 6c6c 6174 696f 6e2e 2057 6520 646f 6e27  llation. We don'
-000163e0: 7420 7573 6520 7468 6520 603d 6020 6f70  t use the `=` op
-000163f0: 6572 6174 6f72 2068 6572 6520 6265 6361  erator here beca
-00016400: 7573 650a 2020 2020 2020 2020 2020 2020  use.            
-00016410: 2320 7468 6572 6520 6361 6e20 6265 206d  # there can be m
-00016420: 756c 7469 706c 6520 564d 2077 6974 6820  ultiple VM with 
-00016430: 7468 6520 7361 6d65 206e 616d 6520 6475  the same name du
-00016440: 6520 746f 2074 6865 2072 6563 6f76 6572  e to the recover
-00016450: 792e 0a20 2020 2020 2020 2020 2020 2028  y..            (
-00016460: 6627 733d 2428 7b71 7565 7279 5f73 7461  f's=$({query_sta
-00016470: 7465 5f63 6d64 7d29 2026 2620 6563 686f  te_cmd}) && echo
-00016480: 2022 2473 2220 2626 2065 6368 6f3b 205b   "$s" && echo; [
-00016490: 5b20 2d7a 2022 2473 2220 5d5d 207c 7c20  [ -z "$s" ]] || 
-000164a0: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
-000164b0: 202d 7620 2d45 2022 5052 4f56 4953 494f   -v -E "PROVISIO
-000164c0: 4e49 4e47 7c53 5441 4749 4e47 7c52 554e  NING|STAGING|RUN
-000164d0: 4e49 4e47 7c52 4550 4149 5249 4e47 7c54  NING|REPAIRING|T
-000164e0: 4552 4d49 4e41 5445 447c 5355 5350 454e  ERMINATED|SUSPEN
-000164f0: 4449 4e47 7c53 5553 5045 4e44 4544 7c53  DING|SUSPENDED|S
-00016500: 5553 5045 4e44 4544 2227 0a20 2020 2020  USPENDED"'.     
-00016510: 2020 2020 2020 2029 2c0a 2020 2020 2020         ),.      
-00016520: 2020 5d2c 0a20 2020 2020 2020 2074 696d    ],.        tim
-00016530: 656f 7574 3d32 3520 2a20 3630 290a 2020  eout=25 * 60).  
-00016540: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-00016550: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
-00016560: 2d2d 2d20 5465 7374 696e 6720 7374 6f72  --- Testing stor
-00016570: 6167 6520 666f 7220 6d61 6e61 6765 6420  age for managed 
-00016580: 7370 6f74 202d 2d2d 2d2d 2d2d 2d2d 2d0a  spot ----------.
-00016590: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-000165a0: 6c61 6d62 6461 5f63 6c6f 7564 2020 2320  lambda_cloud  # 
-000165b0: 4c61 6d62 6461 2043 6c6f 7564 2064 6f65  Lambda Cloud doe
-000165c0: 7320 6e6f 7420 7375 7070 6f72 7420 7370  s not support sp
-000165d0: 6f74 2069 6e73 7461 6e63 6573 0a40 7079  ot instances.@py
-000165e0: 7465 7374 2e6d 6172 6b2e 6e6f 5f69 626d  test.mark.no_ibm
-000165f0: 2020 2320 4942 4d20 436c 6f75 6420 646f    # IBM Cloud do
-00016600: 6573 206e 6f74 2073 7570 706f 7274 2073  es not support s
-00016610: 706f 7420 696e 7374 616e 6365 730a 4070  pot instances.@p
-00016620: 7974 6573 742e 6d61 726b 2e6e 6f5f 7363  ytest.mark.no_sc
-00016630: 7020 2023 2053 4350 2064 6f65 7320 6e6f  p  # SCP does no
-00016640: 7420 7375 7070 6f72 7420 7370 6f74 2069  t support spot i
-00016650: 6e73 7461 6e63 6573 0a40 7079 7465 7374  nstances.@pytest
-00016660: 2e6d 6172 6b2e 6d61 6e61 6765 645f 7370  .mark.managed_sp
-00016670: 6f74 0a64 6566 2074 6573 745f 7370 6f74  ot.def test_spot
-00016680: 5f73 746f 7261 6765 2867 656e 6572 6963  _storage(generic
-00016690: 5f63 6c6f 7564 3a20 7374 7229 3a0a 2020  _cloud: str):.  
-000166a0: 2020 2222 2254 6573 7420 7374 6f72 6167    """Test storag
-000166b0: 6520 7769 7468 206d 616e 6167 6564 2073  e with managed s
-000166c0: 706f 7422 2222 0a20 2020 206e 616d 6520  pot""".    name 
-000166d0: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-000166e0: 616d 6528 290a 2020 2020 7961 6d6c 5f73  ame().    yaml_s
-000166f0: 7472 203d 2070 6174 686c 6962 2e50 6174  tr = pathlib.Pat
-00016700: 6828 0a20 2020 2020 2020 2027 6578 616d  h(.        'exam
-00016710: 706c 6573 2f6d 616e 6167 6564 5f73 706f  ples/managed_spo
-00016720: 745f 7769 7468 5f73 746f 7261 6765 2e79  t_with_storage.y
-00016730: 616d 6c27 292e 7265 6164 5f74 6578 7428  aml').read_text(
-00016740: 290a 2020 2020 7374 6f72 6167 655f 6e61  ).    storage_na
-00016750: 6d65 203d 2066 2773 6b79 2d74 6573 742d  me = f'sky-test-
-00016760: 7b69 6e74 2874 696d 652e 7469 6d65 2829  {int(time.time()
-00016770: 297d 270a 2020 2020 7961 6d6c 5f73 7472  )}'.    yaml_str
-00016780: 203d 2079 616d 6c5f 7374 722e 7265 706c   = yaml_str.repl
-00016790: 6163 6528 2773 6b79 2d77 6f72 6b64 6972  ace('sky-workdir
-000167a0: 2d7a 6877 7527 2c20 7374 6f72 6167 655f  -zhwu', storage_
-000167b0: 6e61 6d65 290a 2020 2020 7769 7468 2074  name).    with t
-000167c0: 656d 7066 696c 652e 4e61 6d65 6454 656d  empfile.NamedTem
-000167d0: 706f 7261 7279 4669 6c65 2873 7566 6669  poraryFile(suffi
-000167e0: 783d 272e 7961 6d6c 272c 206d 6f64 653d  x='.yaml', mode=
-000167f0: 2777 2729 2061 7320 663a 0a20 2020 2020  'w') as f:.     
-00016800: 2020 2066 2e77 7269 7465 2879 616d 6c5f     f.write(yaml_
-00016810: 7374 7229 0a20 2020 2020 2020 2066 2e66  str).        f.f
-00016820: 6c75 7368 2829 0a20 2020 2020 2020 2066  lush().        f
-00016830: 696c 655f 7061 7468 203d 2066 2e6e 616d  ile_path = f.nam
-00016840: 650a 2020 2020 2020 2020 7465 7374 203d  e.        test =
-00016850: 2054 6573 7428 0a20 2020 2020 2020 2020   Test(.         
-00016860: 2020 2027 7370 6f74 5f73 746f 7261 6765     'spot_storage
-00016870: 272c 0a20 2020 2020 2020 2020 2020 205b  ',.            [
-00016880: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016890: 202a 7374 6f72 6167 655f 7365 7475 705f   *storage_setup_
-000168a0: 636f 6d6d 616e 6473 2c0a 2020 2020 2020  commands,.      
-000168b0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-000168c0: 7370 6f74 206c 6175 6e63 6820 2d6e 207b  spot launch -n {
-000168d0: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
-000168e0: 656e 6572 6963 5f63 6c6f 7564 7d20 7b66  eneric_cloud} {f
-000168f0: 696c 655f 7061 7468 7d20 2d79 272c 0a20  ile_path} -y',. 
-00016900: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00016910: 736c 6565 7020 3630 272c 2020 2320 5761  sleep 60',  # Wa
-00016920: 6974 2074 6865 2073 706f 7420 7175 6575  it the spot queu
-00016930: 6520 746f 2062 6520 7570 6461 7465 640a  e to be updated.
-00016940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016950: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
-00016960: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
-00016970: 7d20 7c20 6772 6570 2053 5543 4345 4544  } | grep SUCCEED
-00016980: 4544 272c 0a20 2020 2020 2020 2020 2020  ED',.           
-00016990: 2020 2020 2066 275b 2024 2861 7773 2073       f'[ $(aws s
-000169a0: 3361 7069 206c 6973 742d 6275 636b 6574  3api list-bucket
-000169b0: 7320 2d2d 7175 6572 7920 2242 7563 6b65  s --query "Bucke
-000169c0: 7473 5b3f 636f 6e74 6169 6e73 284e 616d  ts[?contains(Nam
-000169d0: 652c 205c 277b 7374 6f72 6167 655f 6e61  e, \'{storage_na
-000169e0: 6d65 7d5c 2729 5d2e 4e61 6d65 2220 2d2d  me}\')].Name" --
-000169f0: 6f75 7470 7574 2074 6578 7420 7c20 7763  output text | wc
-00016a00: 202d 6c29 202d 6571 2030 205d 270a 2020   -l) -eq 0 ]'.  
-00016a10: 2020 2020 2020 2020 2020 5d2c 0a20 2020            ],.   
-00016a20: 2020 2020 2020 2020 205f 5350 4f54 5f43           _SPOT_C
-00016a30: 414e 4345 4c5f 5741 4954 2e66 6f72 6d61  ANCEL_WAIT.forma
-00016a40: 7428 6a6f 625f 6e61 6d65 3d6e 616d 6529  t(job_name=name)
-00016a50: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-00016a60: 496e 6372 6561 7365 2074 696d 656f 7574  Increase timeout
-00016a70: 2073 696e 6365 2073 6b79 2073 706f 7420   since sky spot 
-00016a80: 7175 6575 6520 2d72 2063 616e 2062 6520  queue -r can be 
-00016a90: 626c 6f63 6b65 6420 6279 206f 7468 6572  blocked by other
-00016aa0: 2073 706f 7420 7465 7374 732e 0a20 2020   spot tests..   
-00016ab0: 2020 2020 2020 2020 2074 696d 656f 7574           timeout
-00016ac0: 3d32 3020 2a20 3630 2c0a 2020 2020 2020  =20 * 60,.      
-00016ad0: 2020 290a 2020 2020 2020 2020 7275 6e5f    ).        run_
-00016ae0: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-00016af0: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465  .# ---------- Te
-00016b00: 7374 696e 6720 7370 6f74 2054 5055 202d  sting spot TPU -
-00016b10: 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974 6573  ---------.@pytes
-00016b20: 742e 6d61 726b 2e67 6370 0a40 7079 7465  t.mark.gcp.@pyte
-00016b30: 7374 2e6d 6172 6b2e 6d61 6e61 6765 645f  st.mark.managed_
-00016b40: 7370 6f74 0a64 6566 2074 6573 745f 7370  spot.def test_sp
-00016b50: 6f74 5f74 7075 2829 3a0a 2020 2020 2222  ot_tpu():.    ""
-00016b60: 2254 6573 7420 6d61 6e61 6765 6420 7370  "Test managed sp
-00016b70: 6f74 206f 6e20 5450 552e 2222 220a 2020  ot on TPU.""".  
-00016b80: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-00016b90: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-00016ba0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-00016bb0: 2020 2020 2020 2774 6573 742d 7370 6f74        'test-spot
-00016bc0: 2d74 7075 272c 0a20 2020 2020 2020 205b  -tpu',.        [
-00016bd0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00016be0: 6b79 2073 706f 7420 6c61 756e 6368 202d  ky spot launch -
-00016bf0: 6e20 7b6e 616d 657d 2065 7861 6d70 6c65  n {name} example
-00016c00: 732f 7470 752f 7470 7576 6d5f 6d6e 6973  s/tpu/tpuvm_mnis
-00016c10: 742e 7961 6d6c 202d 7920 2d64 272c 0a20  t.yaml -y -d',. 
-00016c20: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-00016c30: 7020 3527 2c0a 2020 2020 2020 2020 2020  p 5',.          
-00016c40: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
-00016c50: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
-00016c60: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
-00016c70: 2067 7265 7020 5354 4152 5449 4e47 272c   grep STARTING',
-00016c80: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-00016c90: 6565 7020 3834 3027 2c20 2023 2054 5055  eep 840',  # TPU
-00016ca0: 2074 616b 6573 2061 2077 6869 6c65 2074   takes a while t
-00016cb0: 6f20 6c61 756e 6368 0a20 2020 2020 2020  o launch.       
-00016cc0: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
-00016cd0: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
-00016ce0: 7b6e 616d 657d 207c 2068 6561 6420 2d6e  {name} | head -n
-00016cf0: 3120 7c20 6772 6570 2022 5255 4e4e 494e  1 | grep "RUNNIN
-00016d00: 475c 7c53 5543 4345 4544 4544 2227 2c0a  G\|SUCCEEDED"',.
-00016d10: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-00016d20: 2020 205f 5350 4f54 5f43 414e 4345 4c5f     _SPOT_CANCEL_
-00016d30: 5741 4954 2e66 6f72 6d61 7428 6a6f 625f  WAIT.format(job_
-00016d40: 6e61 6d65 3d6e 616d 6529 2c0a 2020 2020  name=name),.    
-00016d50: 2020 2020 2320 496e 6372 6561 7365 2074      # Increase t
-00016d60: 696d 656f 7574 2073 696e 6365 2073 6b79  imeout since sky
-00016d70: 2073 706f 7420 7175 6575 6520 2d72 2063   spot queue -r c
-00016d80: 616e 2062 6520 626c 6f63 6b65 6420 6279  an be blocked by
-00016d90: 206f 7468 6572 2073 706f 7420 7465 7374   other spot test
-00016da0: 732e 0a20 2020 2020 2020 2074 696d 656f  s..        timeo
-00016db0: 7574 3d32 3020 2a20 3630 2c0a 2020 2020  ut=20 * 60,.    
-00016dc0: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-00016dd0: 7374 2874 6573 7429 0a0a 0a23 202d 2d2d  st(test)...# ---
-00016de0: 2d2d 2d2d 2d2d 2d20 5465 7374 696e 6720  ------- Testing 
-00016df0: 656e 7620 666f 7220 7370 6f74 202d 2d2d  env for spot ---
-00016e00: 2d2d 2d2d 2d2d 2d0a 4070 7974 6573 742e  -------.@pytest.
-00016e10: 6d61 726b 2e6e 6f5f 6c61 6d62 6461 5f63  mark.no_lambda_c
-00016e20: 6c6f 7564 2020 2320 4c61 6d62 6461 2043  loud  # Lambda C
-00016e30: 6c6f 7564 2064 6f65 7320 6e6f 7420 7375  loud does not su
-00016e40: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
-00016e50: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
-00016e60: 6b2e 6e6f 5f69 626d 2020 2320 4942 4d20  k.no_ibm  # IBM 
-00016e70: 436c 6f75 6420 646f 6573 206e 6f74 2073  Cloud does not s
-00016e80: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
-00016e90: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
-00016ea0: 726b 2e6e 6f5f 7363 7020 2023 2053 4350  rk.no_scp  # SCP
-00016eb0: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
-00016ec0: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
-00016ed0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6d61  .@pytest.mark.ma
-00016ee0: 6e61 6765 645f 7370 6f74 0a64 6566 2074  naged_spot.def t
-00016ef0: 6573 745f 7370 6f74 5f69 6e6c 696e 655f  est_spot_inline_
-00016f00: 656e 7628 6765 6e65 7269 635f 636c 6f75  env(generic_clou
-00016f10: 643a 2073 7472 293a 0a20 2020 2022 2222  d: str):.    """
-00016f20: 5465 7374 2073 706f 7420 656e 7622 2222  Test spot env"""
-00016f30: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-00016f40: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
-00016f50: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-00016f60: 0a20 2020 2020 2020 2027 7465 7374 2d73  .        'test-s
-00016f70: 706f 742d 696e 6c69 6e65 2d65 6e76 272c  pot-inline-env',
-00016f80: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
-00016f90: 2020 2020 2020 2066 2773 6b79 2073 706f         f'sky spo
-00016fa0: 7420 6c61 756e 6368 202d 6e20 7b6e 616d  t launch -n {nam
-00016fb0: 657d 202d 7920 2d2d 636c 6f75 6420 7b67  e} -y --cloud {g
-00016fc0: 656e 6572 6963 5f63 6c6f 7564 7d20 2d2d  eneric_cloud} --
-00016fd0: 656e 7620 5445 5354 5f45 4e56 3d22 6865  env TEST_ENV="he
-00016fe0: 6c6c 6f20 776f 726c 6422 202d 2d20 2228  llo world" -- "(
-00016ff0: 5b5b 2021 202d 7a20 5c5c 225c 2454 4553  [[ ! -z \\"\$TES
-00017000: 545f 454e 565c 5c22 205d 5d20 2626 205b  T_ENV\\" ]] && [
-00017010: 5b20 2120 2d7a 205c 5c22 5c24 534b 5950  [ ! -z \\"\$SKYP
-00017020: 494c 4f54 5f4e 4f44 455f 4950 535c 5c22  ILOT_NODE_IPS\\"
-00017030: 205d 5d20 2626 205b 5b20 2120 2d7a 205c   ]] && [[ ! -z \
-00017040: 5c22 5c24 534b 5950 494c 4f54 5f4e 4f44  \"\$SKYPILOT_NOD
-00017050: 455f 5241 4e4b 5c5c 2220 5d5d 2920 7c7c  E_RANK\\" ]]) ||
-00017060: 2065 7869 7420 3122 272c 0a20 2020 2020   exit 1"',.     
-00017070: 2020 2020 2020 2027 736c 6565 7020 3230         'sleep 20
-00017080: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00017090: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
-000170a0: 4954 7d20 7c20 6772 6570 207b 6e61 6d65  IT} | grep {name
-000170b0: 7d20 7c20 6772 6570 2053 5543 4345 4544  } | grep SUCCEED
-000170c0: 4544 272c 0a20 2020 2020 2020 205d 2c0a  ED',.        ],.
-000170d0: 2020 2020 2020 2020 5f53 504f 545f 4341          _SPOT_CA
-000170e0: 4e43 454c 5f57 4149 542e 666f 726d 6174  NCEL_WAIT.format
-000170f0: 286a 6f62 5f6e 616d 653d 6e61 6d65 292c  (job_name=name),
-00017100: 0a20 2020 2020 2020 2023 2049 6e63 7265  .        # Incre
-00017110: 6173 6520 7469 6d65 6f75 7420 7369 6e63  ase timeout sinc
-00017120: 6520 736b 7920 7370 6f74 2071 7565 7565  e sky spot queue
-00017130: 202d 7220 6361 6e20 6265 2062 6c6f 636b   -r can be block
-00017140: 6564 2062 7920 6f74 6865 7220 7370 6f74  ed by other spot
-00017150: 2074 6573 7473 2e0a 2020 2020 2020 2020   tests..        
-00017160: 7469 6d65 6f75 743d 3230 202a 2036 302c  timeout=20 * 60,
-00017170: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
-00017180: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-00017190: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573  # ---------- Tes
-000171a0: 7469 6e67 2065 6e76 202d 2d2d 2d2d 2d2d  ting env -------
-000171b0: 2d2d 2d0a 6465 6620 7465 7374 5f69 6e6c  ---.def test_inl
-000171c0: 696e 655f 656e 7628 6765 6e65 7269 635f  ine_env(generic_
-000171d0: 636c 6f75 643a 2073 7472 293a 0a20 2020  cloud: str):.   
-000171e0: 2022 2222 5465 7374 2065 6e76 2222 220a   """Test env""".
-000171f0: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-00017200: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-00017210: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-00017220: 2020 2020 2020 2020 2774 6573 742d 696e          'test-in
-00017230: 6c69 6e65 2d65 6e76 272c 0a20 2020 2020  line-env',.     
-00017240: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-00017250: 2066 2773 6b79 206c 6175 6e63 6820 2d63   f'sky launch -c
-00017260: 207b 6e61 6d65 7d20 2d79 202d 2d63 6c6f   {name} -y --clo
-00017270: 7564 207b 6765 6e65 7269 635f 636c 6f75  ud {generic_clou
-00017280: 647d 202d 2d65 6e76 2054 4553 545f 454e  d} --env TEST_EN
-00017290: 563d 2268 656c 6c6f 2077 6f72 6c64 2220  V="hello world" 
-000172a0: 2d2d 2022 285b 5b20 2120 2d7a 205c 5c22  -- "([[ ! -z \\"
-000172b0: 5c24 5445 5354 5f45 4e56 5c5c 2220 5d5d  \$TEST_ENV\\" ]]
-000172c0: 2026 2620 5b5b 2021 202d 7a20 5c5c 225c   && [[ ! -z \\"\
-000172d0: 2453 4b59 5049 4c4f 545f 4e4f 4445 5f49  $SKYPILOT_NODE_I
-000172e0: 5053 5c5c 2220 5d5d 2026 2620 5b5b 2021  PS\\" ]] && [[ !
-000172f0: 202d 7a20 5c5c 225c 2453 4b59 5049 4c4f   -z \\"\$SKYPILO
-00017300: 545f 4e4f 4445 5f52 414e 4b5c 5c22 205d  T_NODE_RANK\\" ]
-00017310: 5d29 207c 7c20 6578 6974 2031 2227 2c0a  ]) || exit 1"',.
-00017320: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00017330: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
-00017340: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
-00017350: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-00017360: 6320 7b6e 616d 657d 202d 2d65 6e76 2054  c {name} --env T
-00017370: 4553 545f 454e 5632 3d22 7375 6363 6573  EST_ENV2="succes
-00017380: 7322 2022 285b 5b20 2120 2d7a 205c 5c22  s" "([[ ! -z \\"
-00017390: 5c24 5445 5354 5f45 4e56 325c 5c22 205d  \$TEST_ENV2\\" ]
-000173a0: 5d20 2626 205b 5b20 2120 2d7a 205c 5c22  ] && [[ ! -z \\"
-000173b0: 5c24 534b 5950 494c 4f54 5f4e 4f44 455f  \$SKYPILOT_NODE_
-000173c0: 4950 535c 5c22 205d 5d20 2626 205b 5b20  IPS\\" ]] && [[ 
-000173d0: 2120 2d7a 205c 5c22 5c24 534b 5950 494c  ! -z \\"\$SKYPIL
-000173e0: 4f54 5f4e 4f44 455f 5241 4e4b 5c5c 2220  OT_NODE_RANK\\" 
-000173f0: 5d5d 2920 7c7c 2065 7869 7420 3122 272c  ]]) || exit 1"',
-00017400: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00017410: 6b79 206c 6f67 7320 7b6e 616d 657d 2032  ky logs {name} 2
-00017420: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
-00017430: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
-00017440: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
-00017450: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
-00017460: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-00017470: 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d  t)...# ---------
-00017480: 2d20 5465 7374 696e 6720 656e 7620 6669  - Testing env fi
-00017490: 6c65 202d 2d2d 2d2d 2d2d 2d2d 2d0a 6465  le ----------.de
-000174a0: 6620 7465 7374 5f69 6e6c 696e 655f 656e  f test_inline_en
-000174b0: 765f 6669 6c65 2867 656e 6572 6963 5f63  v_file(generic_c
-000174c0: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
-000174d0: 2222 2254 6573 7420 656e 7622 2222 0a20  """Test env""". 
-000174e0: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-000174f0: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
-00017500: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-00017510: 2020 2020 2020 2027 7465 7374 2d69 6e6c         'test-inl
-00017520: 696e 652d 656e 762d 6669 6c65 272c 0a20  ine-env-file',. 
-00017530: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-00017540: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-00017550: 6820 2d63 207b 6e61 6d65 7d20 2d79 202d  h -c {name} -y -
-00017560: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
-00017570: 636c 6f75 647d 202d 2d65 6e76 2054 4553  cloud} --env TES
-00017580: 545f 454e 563d 2268 656c 6c6f 2077 6f72  T_ENV="hello wor
-00017590: 6c64 2220 2d2d 2022 285b 5b20 2120 2d7a  ld" -- "([[ ! -z
-000175a0: 205c 5c22 5c24 5445 5354 5f45 4e56 5c5c   \\"\$TEST_ENV\\
-000175b0: 2220 5d5d 2026 2620 5b5b 2021 202d 7a20  " ]] && [[ ! -z 
-000175c0: 5c5c 225c 2453 4b59 5049 4c4f 545f 4e4f  \\"\$SKYPILOT_NO
-000175d0: 4445 5f49 5053 5c5c 2220 5d5d 2026 2620  DE_IPS\\" ]] && 
-000175e0: 5b5b 2021 202d 7a20 5c5c 225c 2453 4b59  [[ ! -z \\"\$SKY
-000175f0: 5049 4c4f 545f 4e4f 4445 5f52 414e 4b5c  PILOT_NODE_RANK\
-00017600: 5c22 205d 5d29 207c 7c20 6578 6974 2031  \" ]]) || exit 1
+00009bd0: 657d 2033 272c 0a20 2020 2020 2020 205d  e} 3',.        ]
+00009be0: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+00009bf0: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
+00009c00: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+00009c10: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+00009c20: 4070 7974 6573 742e 6d61 726b 2e69 626d  @pytest.mark.ibm
+00009c30: 0a64 6566 2074 6573 745f 6962 6d5f 6a6f  .def test_ibm_jo
+00009c40: 625f 7175 6575 6528 293a 0a20 2020 206e  b_queue():.    n
+00009c50: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
+00009c60: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
+00009c70: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+00009c80: 2020 2027 6962 6d5f 6a6f 625f 7175 6575     'ibm_job_queu
+00009c90: 6527 2c0a 2020 2020 2020 2020 5b0a 2020  e',.        [.  
+00009ca0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00009cb0: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
+00009cc0: 6d65 7d20 2d2d 636c 6f75 6420 6962 6d20  me} --cloud ibm 
+00009cd0: 2d2d 6770 7573 2076 3130 3027 2c0a 2020  --gpus v100',.  
+00009ce0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00009cf0: 6578 6563 207b 6e61 6d65 7d20 2d6e 207b  exec {name} -n {
+00009d00: 6e61 6d65 7d2d 3120 2d2d 636c 6f75 6420  name}-1 --cloud 
+00009d10: 6962 6d20 2d64 2065 7861 6d70 6c65 732f  ibm -d examples/
+00009d20: 6a6f 625f 7175 6575 652f 6a6f 625f 6962  job_queue/job_ib
+00009d30: 6d2e 7961 6d6c 272c 0a20 2020 2020 2020  m.yaml',.       
+00009d40: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
+00009d50: 7b6e 616d 657d 202d 6e20 7b6e 616d 657d  {name} -n {name}
+00009d60: 2d32 202d 2d63 6c6f 7564 2069 626d 202d  -2 --cloud ibm -
+00009d70: 6420 6578 616d 706c 6573 2f6a 6f62 5f71  d examples/job_q
+00009d80: 7565 7565 2f6a 6f62 5f69 626d 2e79 616d  ueue/job_ibm.yam
+00009d90: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+00009da0: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+00009db0: 7d20 2d6e 207b 6e61 6d65 7d2d 3320 2d2d  } -n {name}-3 --
+00009dc0: 636c 6f75 6420 6962 6d20 2d64 2065 7861  cloud ibm -d exa
+00009dd0: 6d70 6c65 732f 6a6f 625f 7175 6575 652f  mples/job_queue/
+00009de0: 6a6f 625f 6962 6d2e 7961 6d6c 272c 0a20  job_ibm.yaml',. 
+00009df0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00009e00: 2071 7565 7565 207b 6e61 6d65 7d20 7c20   queue {name} | 
+00009e10: 6772 6570 207b 6e61 6d65 7d2d 3120 7c20  grep {name}-1 | 
+00009e20: 6772 6570 2052 554e 4e49 4e47 272c 0a20  grep RUNNING',. 
+00009e30: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00009e40: 2071 7565 7565 207b 6e61 6d65 7d20 7c20   queue {name} | 
+00009e50: 6772 6570 207b 6e61 6d65 7d2d 3220 7c20  grep {name}-2 | 
+00009e60: 6772 6570 2052 554e 4e49 4e47 272c 0a20  grep RUNNING',. 
+00009e70: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00009e80: 2071 7565 7565 207b 6e61 6d65 7d20 7c20   queue {name} | 
+00009e90: 6772 6570 207b 6e61 6d65 7d2d 3320 7c20  grep {name}-3 | 
+00009ea0: 6772 6570 2050 454e 4449 4e47 272c 0a20  grep PENDING',. 
+00009eb0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00009ec0: 2063 616e 6365 6c20 2d79 207b 6e61 6d65   cancel -y {name
+00009ed0: 7d20 3227 2c0a 2020 2020 2020 2020 2020  } 2',.          
+00009ee0: 2020 2773 6c65 6570 2035 272c 0a20 2020    'sleep 5',.   
+00009ef0: 2020 2020 2020 2020 2066 2773 6b79 2071           f'sky q
+00009f00: 7565 7565 207b 6e61 6d65 7d20 7c20 6772  ueue {name} | gr
+00009f10: 6570 207b 6e61 6d65 7d2d 3320 7c20 6772  ep {name}-3 | gr
+00009f20: 6570 2052 554e 4e49 4e47 272c 0a20 2020  ep RUNNING',.   
+00009f30: 2020 2020 2020 2020 2066 2773 6b79 2063           f'sky c
+00009f40: 616e 6365 6c20 2d79 207b 6e61 6d65 7d20  ancel -y {name} 
+00009f50: 3327 2c0a 2020 2020 2020 2020 5d2c 0a20  3',.        ],. 
+00009f60: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
+00009f70: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
+00009f80: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
+00009f90: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
+00009fa0: 7465 7374 2e6d 6172 6b2e 7363 700a 6465  test.mark.scp.de
+00009fb0: 6620 7465 7374 5f73 6370 5f6a 6f62 5f71  f test_scp_job_q
+00009fc0: 7565 7565 2829 3a0a 2020 2020 6e61 6d65  ueue():.    name
+00009fd0: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+00009fe0: 6e61 6d65 2829 0a20 2020 206e 756d 5f6f  name().    num_o
+00009ff0: 665f 6770 755f 6c61 756e 6368 203d 2031  f_gpu_launch = 1
+0000a000: 0a20 2020 206e 756d 5f6f 665f 6770 755f  .    num_of_gpu_
+0000a010: 6578 6563 203d 2030 2e35 0a20 2020 2074  exec = 0.5.    t
+0000a020: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+0000a030: 2020 2020 2753 4350 5f6a 6f62 5f71 7565      'SCP_job_que
+0000a040: 7565 272c 0a20 2020 2020 2020 205b 0a20  ue',.        [. 
+0000a050: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000a060: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
+0000a070: 616d 657d 207b 5343 505f 5459 5045 7d20  ame} {SCP_TYPE} 
+0000a080: 7b53 4350 5f47 5055 5f56 3130 307d 3a7b  {SCP_GPU_V100}:{
+0000a090: 6e75 6d5f 6f66 5f67 7075 5f6c 6175 6e63  num_of_gpu_launc
+0000a0a0: 687d 2065 7861 6d70 6c65 732f 6a6f 625f  h} examples/job_
+0000a0b0: 7175 6575 652f 636c 7573 7465 722e 7961  queue/cluster.ya
+0000a0c0: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+0000a0d0: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
+0000a0e0: 657d 202d 6e20 7b6e 616d 657d 2d31 207b  e} -n {name}-1 {
+0000a0f0: 5343 505f 4750 555f 5631 3030 7d3a 7b6e  SCP_GPU_V100}:{n
+0000a100: 756d 5f6f 665f 6770 755f 6578 6563 7d20  um_of_gpu_exec} 
+0000a110: 2d64 2065 7861 6d70 6c65 732f 6a6f 625f  -d examples/job_
+0000a120: 7175 6575 652f 6a6f 622e 7961 6d6c 272c  queue/job.yaml',
+0000a130: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000a140: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
+0000a150: 6e20 7b6e 616d 657d 2d32 207b 5343 505f  n {name}-2 {SCP_
+0000a160: 4750 555f 5631 3030 7d3a 7b6e 756d 5f6f  GPU_V100}:{num_o
+0000a170: 665f 6770 755f 6578 6563 7d20 2d64 2065  f_gpu_exec} -d e
+0000a180: 7861 6d70 6c65 732f 6a6f 625f 7175 6575  xamples/job_queu
+0000a190: 652f 6a6f 622e 7961 6d6c 272c 0a20 2020  e/job.yaml',.   
+0000a1a0: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
+0000a1b0: 7865 6320 7b6e 616d 657d 202d 6e20 7b6e  xec {name} -n {n
+0000a1c0: 616d 657d 2d33 207b 5343 505f 4750 555f  ame}-3 {SCP_GPU_
+0000a1d0: 5631 3030 7d3a 7b6e 756d 5f6f 665f 6770  V100}:{num_of_gp
+0000a1e0: 755f 6578 6563 7d20 2d64 2065 7861 6d70  u_exec} -d examp
+0000a1f0: 6c65 732f 6a6f 625f 7175 6575 652f 6a6f  les/job_queue/jo
+0000a200: 622e 7961 6d6c 272c 0a20 2020 2020 2020  b.yaml',.       
+0000a210: 2020 2020 2066 2773 6b79 2071 7565 7565       f'sky queue
+0000a220: 207b 6e61 6d65 7d20 7c20 6772 6570 207b   {name} | grep {
+0000a230: 6e61 6d65 7d2d 3120 7c20 6772 6570 2052  name}-1 | grep R
+0000a240: 554e 4e49 4e47 272c 0a20 2020 2020 2020  UNNING',.       
+0000a250: 2020 2020 2066 2773 6b79 2071 7565 7565       f'sky queue
+0000a260: 207b 6e61 6d65 7d20 7c20 6772 6570 207b   {name} | grep {
+0000a270: 6e61 6d65 7d2d 3220 7c20 6772 6570 2052  name}-2 | grep R
+0000a280: 554e 4e49 4e47 272c 0a20 2020 2020 2020  UNNING',.       
+0000a290: 2020 2020 2066 2773 6b79 2071 7565 7565       f'sky queue
+0000a2a0: 207b 6e61 6d65 7d20 7c20 6772 6570 207b   {name} | grep {
+0000a2b0: 6e61 6d65 7d2d 3320 7c20 6772 6570 2050  name}-3 | grep P
+0000a2c0: 454e 4449 4e47 272c 0a20 2020 2020 2020  ENDING',.       
+0000a2d0: 2020 2020 2066 2773 6b79 2063 616e 6365       f'sky cance
+0000a2e0: 6c20 2d79 207b 6e61 6d65 7d20 3227 2c0a  l -y {name} 2',.
+0000a2f0: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+0000a300: 6570 2035 272c 0a20 2020 2020 2020 2020  ep 5',.         
+0000a310: 2020 2066 2773 6b79 2071 7565 7565 207b     f'sky queue {
+0000a320: 6e61 6d65 7d20 7c20 6772 6570 207b 6e61  name} | grep {na
+0000a330: 6d65 7d2d 3320 7c20 6772 6570 2052 554e  me}-3 | grep RUN
+0000a340: 4e49 4e47 272c 0a20 2020 2020 2020 2020  NING',.         
+0000a350: 2020 2066 2773 6b79 2063 616e 6365 6c20     f'sky cancel 
+0000a360: 2d79 207b 6e61 6d65 7d20 3327 2c0a 2020  -y {name} 3',.  
+0000a370: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+0000a380: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
+0000a390: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
+0000a3a0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+0000a3b0: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+0000a3c0: 6172 6b2e 6e6f 5f6c 616d 6264 615f 636c  ark.no_lambda_cl
+0000a3d0: 6f75 6420 2023 204c 616d 6264 6120 436c  oud  # Lambda Cl
+0000a3e0: 6f75 6420 646f 6573 206e 6f74 2068 6176  oud does not hav
+0000a3f0: 6520 5434 2067 7075 730a 4070 7974 6573  e T4 gpus.@pytes
+0000a400: 742e 6d61 726b 2e6e 6f5f 6962 6d20 2023  t.mark.no_ibm  #
+0000a410: 2049 424d 2043 6c6f 7564 2064 6f65 7320   IBM Cloud does 
+0000a420: 6e6f 7420 6861 7665 2054 3420 6770 7573  not have T4 gpus
+0000a430: 2e20 7275 6e20 7465 7374 5f69 626d 5f6a  . run test_ibm_j
+0000a440: 6f62 5f71 7565 7565 5f6d 756c 7469 6e6f  ob_queue_multino
+0000a450: 6465 2069 6e73 7465 6164 0a40 7079 7465  de instead.@pyte
+0000a460: 7374 2e6d 6172 6b2e 6e6f 5f73 6370 2020  st.mark.no_scp  
+0000a470: 2320 5343 5020 646f 6573 206e 6f74 2073  # SCP does not s
+0000a480: 7570 706f 7274 206e 756d 5f6e 6f64 6573  upport num_nodes
+0000a490: 203e 2031 2079 6574 0a40 7079 7465 7374   > 1 yet.@pytest
+0000a4a0: 2e6d 6172 6b2e 6e6f 5f6f 6369 2020 2320  .mark.no_oci  # 
+0000a4b0: 4f43 4920 436c 6f75 6420 646f 6573 206e  OCI Cloud does n
+0000a4c0: 6f74 2068 6176 6520 5434 2067 7075 732e  ot have T4 gpus.
+0000a4d0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+0000a4e0: 5f6b 7562 6572 6e65 7465 7320 2023 204b  _kubernetes  # K
+0000a4f0: 7562 6572 6e65 7465 7320 6e6f 7420 6861  ubernetes not ha
+0000a500: 7665 2067 7075 730a 6465 6620 7465 7374  ve gpus.def test
+0000a510: 5f6a 6f62 5f71 7565 7565 5f6d 756c 7469  _job_queue_multi
+0000a520: 6e6f 6465 2867 656e 6572 6963 5f63 6c6f  node(generic_clo
+0000a530: 7564 3a20 7374 7229 3a0a 2020 2020 6e61  ud: str):.    na
+0000a540: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
+0000a550: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
+0000a560: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+0000a570: 2020 276a 6f62 5f71 7565 7565 5f6d 756c    'job_queue_mul
+0000a580: 7469 6e6f 6465 272c 0a20 2020 2020 2020  tinode',.       
+0000a590: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+0000a5a0: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
+0000a5b0: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
+0000a5c0: 207b 6765 6e65 7269 635f 636c 6f75 647d   {generic_cloud}
+0000a5d0: 2065 7861 6d70 6c65 732f 6a6f 625f 7175   examples/job_qu
+0000a5e0: 6575 652f 636c 7573 7465 725f 6d75 6c74  eue/cluster_mult
+0000a5f0: 696e 6f64 652e 7961 6d6c 272c 0a20 2020  inode.yaml',.   
+0000a600: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
+0000a610: 7865 6320 7b6e 616d 657d 202d 6e20 7b6e  xec {name} -n {n
+0000a620: 616d 657d 2d31 202d 6420 6578 616d 706c  ame}-1 -d exampl
+0000a630: 6573 2f6a 6f62 5f71 7565 7565 2f6a 6f62  es/job_queue/job
+0000a640: 5f6d 756c 7469 6e6f 6465 2e79 616d 6c27  _multinode.yaml'
+0000a650: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000a660: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
+0000a670: 2d6e 207b 6e61 6d65 7d2d 3220 2d64 2065  -n {name}-2 -d e
+0000a680: 7861 6d70 6c65 732f 6a6f 625f 7175 6575  xamples/job_queu
+0000a690: 652f 6a6f 625f 6d75 6c74 696e 6f64 652e  e/job_multinode.
+0000a6a0: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+0000a6b0: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+0000a6c0: 2d63 207b 6e61 6d65 7d20 2d6e 207b 6e61  -c {name} -n {na
+0000a6d0: 6d65 7d2d 3320 2d2d 6465 7461 6368 2d73  me}-3 --detach-s
+0000a6e0: 6574 7570 202d 6420 6578 616d 706c 6573  etup -d examples
+0000a6f0: 2f6a 6f62 5f71 7565 7565 2f6a 6f62 5f6d  /job_queue/job_m
+0000a700: 756c 7469 6e6f 6465 2e79 616d 6c27 2c0a  ultinode.yaml',.
+0000a710: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
+0000a720: 2428 736b 7920 7175 6575 6520 7b6e 616d  $(sky queue {nam
+0000a730: 657d 2920 2626 2065 6368 6f20 2224 7322  e}) && echo "$s"
+0000a740: 2026 2620 2865 6368 6f20 2224 7322 207c   && (echo "$s" |
+0000a750: 2067 7265 7020 7b6e 616d 657d 2d31 207c   grep {name}-1 |
+0000a760: 2067 7265 7020 5255 4e4e 494e 4729 272c   grep RUNNING)',
+0000a770: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000a780: 3d24 2873 6b79 2071 7565 7565 207b 6e61  =$(sky queue {na
+0000a790: 6d65 7d29 2026 2620 6563 686f 2022 2473  me}) && echo "$s
+0000a7a0: 2220 2626 2028 6563 686f 2022 2473 2220  " && (echo "$s" 
+0000a7b0: 7c20 6772 6570 207b 6e61 6d65 7d2d 3220  | grep {name}-2 
+0000a7c0: 7c20 6772 6570 2052 554e 4e49 4e47 2927  | grep RUNNING)'
+0000a7d0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000a7e0: 733d 2428 736b 7920 7175 6575 6520 7b6e  s=$(sky queue {n
+0000a7f0: 616d 657d 2920 2626 2065 6368 6f20 2224  ame}) && echo "$
+0000a800: 7322 2026 2620 2865 6368 6f20 2224 7322  s" && (echo "$s"
+0000a810: 207c 2067 7265 7020 7b6e 616d 657d 2d33   | grep {name}-3
+0000a820: 207c 2067 7265 7020 5045 4e44 494e 4729   | grep PENDING)
+0000a830: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
+0000a840: 736c 6565 7020 3930 272c 0a20 2020 2020  sleep 90',.     
+0000a850: 2020 2020 2020 2066 2773 6b79 2063 616e         f'sky can
+0000a860: 6365 6c20 2d79 207b 6e61 6d65 7d20 3127  cel -y {name} 1'
+0000a870: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
+0000a880: 6c65 6570 2035 272c 0a20 2020 2020 2020  leep 5',.       
+0000a890: 2020 2020 2066 2773 3d24 2873 6b79 2071       f's=$(sky q
+0000a8a0: 7565 7565 207b 6e61 6d65 7d29 3b20 6563  ueue {name}); ec
+0000a8b0: 686f 2022 2473 223b 2065 6368 6f3b 2065  ho "$s"; echo; e
+0000a8c0: 6368 6f3b 2065 6368 6f20 2224 7322 207c  cho; echo "$s" |
+0000a8d0: 2067 7265 7020 7b6e 616d 657d 2d33 207c   grep {name}-3 |
+0000a8e0: 2067 7265 7020 5345 5454 494e 475f 5550   grep SETTING_UP
+0000a8f0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000a900: 2773 6b79 2063 616e 6365 6c20 2d79 207b  'sky cancel -y {
+0000a910: 6e61 6d65 7d20 3120 3220 3327 2c0a 2020  name} 1 2 3',.  
+0000a920: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000a930: 6c61 756e 6368 202d 6320 7b6e 616d 657d  launch -c {name}
+0000a940: 202d 6e20 7b6e 616d 657d 2d34 202d 2d64   -n {name}-4 --d
+0000a950: 6574 6163 682d 7365 7475 7020 2d64 2065  etach-setup -d e
+0000a960: 7861 6d70 6c65 732f 6a6f 625f 7175 6575  xamples/job_queu
+0000a970: 652f 6a6f 625f 6d75 6c74 696e 6f64 652e  e/job_multinode.
+0000a980: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+0000a990: 2020 2023 2054 6573 7420 7468 6520 6a6f     # Test the jo
+0000a9a0: 6220 7374 6174 7573 2069 7320 636f 7272  b status is corr
+0000a9b0: 6563 746c 7920 7365 7420 746f 2053 4554  ectly set to SET
+0000a9c0: 5449 4e47 5f55 502c 2064 7572 696e 6720  TING_UP, during 
+0000a9d0: 7468 6520 7365 7475 7020 6973 2072 756e  the setup is run
+0000a9e0: 6e69 6e67 2c0a 2020 2020 2020 2020 2020  ning,.          
+0000a9f0: 2020 2320 616e 6420 7468 6520 6a6f 6220    # and the job 
+0000aa00: 6361 6e20 6265 2063 616e 6365 6c6c 6564  can be cancelled
+0000aa10: 2064 7572 696e 6720 7468 6520 7365 7475   during the setu
+0000aa20: 702e 0a20 2020 2020 2020 2020 2020 2027  p..            '
+0000aa30: 736c 6565 7020 3527 2c0a 2020 2020 2020  sleep 5',.      
+0000aa40: 2020 2020 2020 6627 733d 2428 736b 7920        f's=$(sky 
+0000aa50: 7175 6575 6520 7b6e 616d 657d 2920 2626  queue {name}) &&
+0000aa60: 2065 6368 6f20 2224 7322 2026 2620 2865   echo "$s" && (e
+0000aa70: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
+0000aa80: 7b6e 616d 657d 2d34 207c 2067 7265 7020  {name}-4 | grep 
+0000aa90: 5345 5454 494e 475f 5550 2927 2c0a 2020  SETTING_UP)',.  
+0000aaa0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000aab0: 6361 6e63 656c 202d 7920 7b6e 616d 657d  cancel -y {name}
+0000aac0: 2034 272c 0a20 2020 2020 2020 2020 2020   4',.           
+0000aad0: 2066 2773 3d24 2873 6b79 2071 7565 7565   f's=$(sky queue
+0000aae0: 207b 6e61 6d65 7d29 2026 2620 6563 686f   {name}) && echo
+0000aaf0: 2022 2473 2220 2626 2028 6563 686f 2022   "$s" && (echo "
+0000ab00: 2473 2220 7c20 6772 6570 207b 6e61 6d65  $s" | grep {name
+0000ab10: 7d2d 3420 7c20 6772 6570 2043 414e 4345  }-4 | grep CANCE
+0000ab20: 4c4c 4544 2927 2c0a 2020 2020 2020 2020  LLED)',.        
+0000ab30: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
+0000ab40: 6e61 6d65 7d20 2d2d 6770 7573 2054 343a  name} --gpus T4:
+0000ab50: 302e 3220 225b 5b20 5c24 534b 5950 494c  0.2 "[[ \$SKYPIL
+0000ab60: 4f54 5f4e 554d 5f47 5055 535f 5045 525f  OT_NUM_GPUS_PER_
+0000ab70: 4e4f 4445 202d 6571 2031 205d 5d20 7c7c  NODE -eq 1 ]] ||
+0000ab80: 2065 7869 7420 3122 272c 0a20 2020 2020   exit 1"',.     
+0000ab90: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+0000aba0: 6320 7b6e 616d 657d 202d 2d67 7075 7320  c {name} --gpus 
+0000abb0: 5434 3a30 2e32 202d 2d6e 756d 2d6e 6f64  T4:0.2 --num-nod
+0000abc0: 6573 2032 2022 5b5b 205c 2453 4b59 5049  es 2 "[[ \$SKYPI
+0000abd0: 4c4f 545f 4e55 4d5f 4750 5553 5f50 4552  LOT_NUM_GPUS_PER
+0000abe0: 5f4e 4f44 4520 2d65 7120 3120 5d5d 207c  _NODE -eq 1 ]] |
+0000abf0: 7c20 6578 6974 2031 2227 2c0a 2020 2020  | exit 1"',.    
+0000ac00: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+0000ac10: 6563 207b 6e61 6d65 7d20 2d2d 6770 7573  ec {name} --gpus
+0000ac20: 2054 343a 3120 2d2d 6e75 6d2d 6e6f 6465   T4:1 --num-node
+0000ac30: 7320 3220 225b 5b20 5c24 534b 5950 494c  s 2 "[[ \$SKYPIL
+0000ac40: 4f54 5f4e 554d 5f47 5055 535f 5045 525f  OT_NUM_GPUS_PER_
+0000ac50: 4e4f 4445 202d 6571 2031 205d 5d20 7c7c  NODE -eq 1 ]] ||
+0000ac60: 2065 7869 7420 3122 272c 0a20 2020 2020   exit 1"',.     
+0000ac70: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+0000ac80: 7320 7b6e 616d 657d 2035 202d 2d73 7461  s {name} 5 --sta
+0000ac90: 7475 7327 2c0a 2020 2020 2020 2020 2020  tus',.          
+0000aca0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+0000acb0: 6d65 7d20 3620 2d2d 7374 6174 7573 272c  me} 6 --status',
+0000acc0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000acd0: 6b79 206c 6f67 7320 7b6e 616d 657d 2037  ky logs {name} 7
+0000ace0: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
+0000acf0: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+0000ad00: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+0000ad10: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
+0000ad20: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+0000ad30: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
+0000ad40: 6b2e 6e6f 5f6c 616d 6264 615f 636c 6f75  k.no_lambda_clou
+0000ad50: 6420 2023 204e 6f20 4c61 6d62 6461 2043  d  # No Lambda C
+0000ad60: 6c6f 7564 2056 4d20 6861 7320 3820 4350  loud VM has 8 CP
+0000ad70: 5573 0a64 6566 2074 6573 745f 6c61 7267  Us.def test_larg
+0000ad80: 655f 6a6f 625f 7175 6575 6528 6765 6e65  e_job_queue(gene
+0000ad90: 7269 635f 636c 6f75 643a 2073 7472 293a  ric_cloud: str):
+0000ada0: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+0000adb0: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+0000adc0: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+0000add0: 0a20 2020 2020 2020 2027 6c61 7267 655f  .        'large_
+0000ade0: 6a6f 625f 7175 6575 6527 2c0a 2020 2020  job_queue',.    
+0000adf0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+0000ae00: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
+0000ae10: 7920 2d63 207b 6e61 6d65 7d20 2d2d 6370  y -c {name} --cp
+0000ae20: 7573 2038 202d 2d63 6c6f 7564 207b 6765  us 8 --cloud {ge
+0000ae30: 6e65 7269 635f 636c 6f75 647d 272c 0a20  neric_cloud}',. 
+0000ae40: 2020 2020 2020 2020 2020 2066 2766 6f72             f'for
+0000ae50: 2069 2069 6e20 6073 6571 2031 2037 3560   i in `seq 1 75`
+0000ae60: 3b20 646f 2073 6b79 2065 7865 6320 7b6e  ; do sky exec {n
+0000ae70: 616d 657d 202d 6e20 7b6e 616d 657d 2d24  ame} -n {name}-$
+0000ae80: 6920 2d64 2022 6563 686f 2024 693b 2073  i -d "echo $i; s
+0000ae90: 6c65 6570 2031 3030 3030 3030 3030 223b  leep 100000000";
+0000aea0: 2064 6f6e 6527 2c0a 2020 2020 2020 2020   done',.        
+0000aeb0: 2020 2020 6627 736b 7920 6361 6e63 656c      f'sky cancel
+0000aec0: 202d 7920 7b6e 616d 657d 2031 2032 2033   -y {name} 1 2 3
+0000aed0: 2034 2035 2036 2037 2038 2039 2031 3020   4 5 6 7 8 9 10 
+0000aee0: 3131 2031 3220 3133 2031 3420 3135 2031  11 12 13 14 15 1
+0000aef0: 3627 2c0a 2020 2020 2020 2020 2020 2020  6',.            
+0000af00: 2773 6c65 6570 2037 3527 2c0a 2020 2020  'sleep 75',.    
+0000af10: 2020 2020 2020 2020 2320 4561 6368 206a          # Each j
+0000af20: 6f62 2074 616b 6573 2030 2e35 2043 5055  ob takes 0.5 CPU
+0000af30: 2061 6e64 2074 6865 2064 6566 6175 6c74   and the default
+0000af40: 2056 4d20 6861 7320 3820 4350 5573 2c20   VM has 8 CPUs, 
+0000af50: 736f 2074 6865 7265 2073 686f 756c 6420  so there should 
+0000af60: 6265 2038 202f 2030 2e35 203d 2031 3620  be 8 / 0.5 = 16 
+0000af70: 6a6f 6273 2072 756e 6e69 6e67 2e0a 2020  jobs running..  
+0000af80: 2020 2020 2020 2020 2020 2320 5468 6520            # The 
+0000af90: 6669 7273 7420 3136 206a 6f62 7320 6172  first 16 jobs ar
+0000afa0: 6520 6361 6e63 656c 6564 2c20 736f 2074  e canceled, so t
+0000afb0: 6865 7265 2073 686f 756c 6420 6265 2037  here should be 7
+0000afc0: 3520 2d20 3332 203d 2034 3320 6a6f 6273  5 - 32 = 43 jobs
+0000afd0: 2050 454e 4449 4e47 2e0a 2020 2020 2020   PENDING..      
+0000afe0: 2020 2020 2020 6627 733d 2428 736b 7920        f's=$(sky 
+0000aff0: 7175 6575 6520 7b6e 616d 657d 293b 2065  queue {name}); e
+0000b000: 6368 6f20 2224 7322 3b20 6563 686f 3b20  cho "$s"; echo; 
+0000b010: 6563 686f 3b20 6563 686f 2022 2473 2220  echo; echo "$s" 
+0000b020: 7c20 6772 6570 202d 7620 6772 6570 207c  | grep -v grep |
+0000b030: 2067 7265 7020 5045 4e44 494e 4720 7c20   grep PENDING | 
+0000b040: 7763 202d 6c20 7c20 6772 6570 2034 3327  wc -l | grep 43'
+0000b050: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+0000b060: 4d61 6b65 2073 7572 6520 7468 6520 6a6f  Make sure the jo
+0000b070: 6273 2061 7265 2073 6368 6564 756c 6564  bs are scheduled
+0000b080: 2069 6e20 4649 464f 206f 7264 6572 0a20   in FIFO order. 
+0000b090: 2020 2020 2020 2020 2020 202a 5b0a 2020             *[.  
+0000b0a0: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+0000b0b0: 733d 2428 736b 7920 7175 6575 6520 7b6e  s=$(sky queue {n
+0000b0c0: 616d 657d 293b 2065 6368 6f20 2224 7322  ame}); echo "$s"
+0000b0d0: 3b20 6563 686f 3b20 6563 686f 3b20 6563  ; echo; echo; ec
+0000b0e0: 686f 2022 2473 2220 7c20 6772 6570 207b  ho "$s" | grep {
+0000b0f0: 6e61 6d65 7d2d 7b69 7d20 7c20 6772 6570  name}-{i} | grep
+0000b100: 2043 414e 4345 4c4c 4544 270a 2020 2020   CANCELLED'.    
+0000b110: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0000b120: 6920 696e 2072 616e 6765 2831 2c20 3137  i in range(1, 17
+0000b130: 290a 2020 2020 2020 2020 2020 2020 5d2c  ).            ],
+0000b140: 0a20 2020 2020 2020 2020 2020 202a 5b0a  .            *[.
+0000b150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b160: 6627 733d 2428 736b 7920 7175 6575 6520  f's=$(sky queue 
+0000b170: 7b6e 616d 657d 293b 2065 6368 6f20 2224  {name}); echo "$
+0000b180: 7322 3b20 6563 686f 3b20 6563 686f 3b20  s"; echo; echo; 
+0000b190: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
+0000b1a0: 207b 6e61 6d65 7d2d 7b69 7d20 7c20 6772   {name}-{i} | gr
+0000b1b0: 6570 2052 554e 4e49 4e47 270a 2020 2020  ep RUNNING'.    
+0000b1c0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0000b1d0: 6920 696e 2072 616e 6765 2831 372c 2033  i in range(17, 3
+0000b1e0: 3329 0a20 2020 2020 2020 2020 2020 205d  3).            ]
+0000b1f0: 2c0a 2020 2020 2020 2020 2020 2020 2a5b  ,.            *[
+0000b200: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b210: 2066 2773 3d24 2873 6b79 2071 7565 7565   f's=$(sky queue
+0000b220: 207b 6e61 6d65 7d29 3b20 6563 686f 2022   {name}); echo "
+0000b230: 2473 223b 2065 6368 6f3b 2065 6368 6f3b  $s"; echo; echo;
+0000b240: 2065 6368 6f20 2224 7322 207c 2067 7265   echo "$s" | gre
+0000b250: 7020 7b6e 616d 657d 2d7b 697d 207c 2067  p {name}-{i} | g
+0000b260: 7265 7020 5045 4e44 494e 4727 0a20 2020  rep PENDING'.   
+0000b270: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+0000b280: 2069 2069 6e20 7261 6e67 6528 3333 2c20   i in range(33, 
+0000b290: 3735 290a 2020 2020 2020 2020 2020 2020  75).            
+0000b2a0: 5d2c 0a20 2020 2020 2020 2020 2020 2066  ],.            f
+0000b2b0: 2773 6b79 2063 616e 6365 6c20 2d79 207b  'sky cancel -y {
+0000b2c0: 6e61 6d65 7d20 3333 2033 3520 3337 2033  name} 33 35 37 3
+0000b2d0: 3920 3137 2031 3820 3139 272c 0a20 2020  9 17 18 19',.   
+0000b2e0: 2020 2020 2020 2020 202a 5b0a 2020 2020           *[.    
+0000b2f0: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
+0000b300: 2428 736b 7920 7175 6575 6520 7b6e 616d  $(sky queue {nam
+0000b310: 657d 293b 2065 6368 6f20 2224 7322 3b20  e}); echo "$s"; 
+0000b320: 6563 686f 3b20 6563 686f 3b20 6563 686f  echo; echo; echo
+0000b330: 2022 2473 2220 7c20 6772 6570 207b 6e61   "$s" | grep {na
+0000b340: 6d65 7d2d 7b69 7d20 7c20 6772 6570 2043  me}-{i} | grep C
+0000b350: 414e 4345 4c4c 4544 270a 2020 2020 2020  ANCELLED'.      
+0000b360: 2020 2020 2020 2020 2020 666f 7220 6920            for i 
+0000b370: 696e 2072 616e 6765 2833 332c 2034 302c  in range(33, 40,
+0000b380: 2032 290a 2020 2020 2020 2020 2020 2020   2).            
+0000b390: 5d2c 0a20 2020 2020 2020 2020 2020 2027  ],.            '
+0000b3a0: 736c 6565 7020 3130 272c 0a20 2020 2020  sleep 10',.     
+0000b3b0: 2020 2020 2020 202a 5b0a 2020 2020 2020         *[.      
+0000b3c0: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
+0000b3d0: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
+0000b3e0: 293b 2065 6368 6f20 2224 7322 3b20 6563  ); echo "$s"; ec
+0000b3f0: 686f 3b20 6563 686f 3b20 6563 686f 2022  ho; echo; echo "
+0000b400: 2473 2220 7c20 6772 6570 207b 6e61 6d65  $s" | grep {name
+0000b410: 7d2d 7b69 7d20 7c20 6772 6570 2052 554e  }-{i} | grep RUN
+0000b420: 4e49 4e47 270a 2020 2020 2020 2020 2020  NING'.          
+0000b430: 2020 2020 2020 666f 7220 6920 696e 205b        for i in [
+0000b440: 3334 2c20 3336 2c20 3338 5d0a 2020 2020  34, 36, 38].    
+0000b450: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+0000b460: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
+0000b470: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
+0000b480: 657d 272c 0a20 2020 2020 2020 2074 696d  e}',.        tim
+0000b490: 656f 7574 3d32 3020 2a20 3630 2c0a 2020  eout=20 * 60,.  
+0000b4a0: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
+0000b4b0: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
+0000b4c0: 7465 7374 2e6d 6172 6b2e 6e6f 5f6c 616d  test.mark.no_lam
+0000b4d0: 6264 615f 636c 6f75 6420 2023 204e 6f20  bda_cloud  # No 
+0000b4e0: 4c61 6d62 6461 2043 6c6f 7564 2056 4d20  Lambda Cloud VM 
+0000b4f0: 6861 7320 3820 4350 5573 0a64 6566 2074  has 8 CPUs.def t
+0000b500: 6573 745f 6661 7374 5f6c 6172 6765 5f6a  est_fast_large_j
+0000b510: 6f62 5f71 7565 7565 2867 656e 6572 6963  ob_queue(generic
+0000b520: 5f63 6c6f 7564 3a20 7374 7229 3a0a 2020  _cloud: str):.  
+0000b530: 2020 2320 5468 6973 2069 7320 746f 2074    # This is to t
+0000b540: 6573 7420 7468 6520 6a6f 6273 2063 616e  est the jobs can
+0000b550: 2062 6520 7363 6865 6475 6c65 6420 7175   be scheduled qu
+0000b560: 6963 6b6c 7920 7768 656e 2074 6865 7265  ickly when there
+0000b570: 2061 7265 206d 616e 7920 6a6f 6273 2069   are many jobs i
+0000b580: 6e20 7468 6520 7175 6575 652e 0a20 2020  n the queue..   
+0000b590: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
+0000b5a0: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
+0000b5b0: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+0000b5c0: 2020 2020 2027 6661 7374 5f6c 6172 6765       'fast_large
+0000b5d0: 5f6a 6f62 5f71 7565 7565 272c 0a20 2020  _job_queue',.   
+0000b5e0: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+0000b5f0: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+0000b600: 2d79 202d 6320 7b6e 616d 657d 202d 2d63  -y -c {name} --c
+0000b610: 7075 7320 3820 2d2d 636c 6f75 6420 7b67  pus 8 --cloud {g
+0000b620: 656e 6572 6963 5f63 6c6f 7564 7d27 2c0a  eneric_cloud}',.
+0000b630: 2020 2020 2020 2020 2020 2020 6627 666f              f'fo
+0000b640: 7220 6920 696e 2060 7365 7120 3120 3332  r i in `seq 1 32
+0000b650: 603b 2064 6f20 736b 7920 6578 6563 207b  `; do sky exec {
+0000b660: 6e61 6d65 7d20 2d6e 207b 6e61 6d65 7d2d  name} -n {name}-
+0000b670: 2469 202d 6420 2265 6368 6f20 2469 223b  $i -d "echo $i";
+0000b680: 2064 6f6e 6527 2c0a 2020 2020 2020 2020   done',.        
+0000b690: 2020 2020 2773 6c65 6570 2036 3027 2c0a      'sleep 60',.
+0000b6a0: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
+0000b6b0: 2428 736b 7920 7175 6575 6520 7b6e 616d  $(sky queue {nam
+0000b6c0: 657d 293b 2065 6368 6f20 2224 7322 3b20  e}); echo "$s"; 
+0000b6d0: 6563 686f 3b20 6563 686f 3b20 6563 686f  echo; echo; echo
+0000b6e0: 2022 2473 2220 7c20 6772 6570 202d 7620   "$s" | grep -v 
+0000b6f0: 6772 6570 207c 2067 7265 7020 5355 4343  grep | grep SUCC
+0000b700: 4545 4445 4420 7c20 7763 202d 6c20 7c20  EEDED | wc -l | 
+0000b710: 6772 6570 2033 3227 2c0a 2020 2020 2020  grep 32',.      
+0000b720: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
+0000b730: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
+0000b740: 7d27 2c0a 2020 2020 2020 2020 7469 6d65  }',.        time
+0000b750: 6f75 743d 3230 202a 2036 302c 0a20 2020  out=20 * 60,.   
+0000b760: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+0000b770: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
+0000b780: 6573 742e 6d61 726b 2e69 626d 0a64 6566  est.mark.ibm.def
+0000b790: 2074 6573 745f 6962 6d5f 6a6f 625f 7175   test_ibm_job_qu
+0000b7a0: 6575 655f 6d75 6c74 696e 6f64 6528 293a  eue_multinode():
+0000b7b0: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+0000b7c0: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+0000b7d0: 2020 2020 7461 736b 5f66 696c 6520 3d20      task_file = 
+0000b7e0: 2765 7861 6d70 6c65 732f 6a6f 625f 7175  'examples/job_qu
+0000b7f0: 6575 652f 6a6f 625f 6d75 6c74 696e 6f64  eue/job_multinod
+0000b800: 655f 6962 6d2e 7961 6d6c 270a 2020 2020  e_ibm.yaml'.    
+0000b810: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+0000b820: 2020 2020 2027 6962 6d5f 6a6f 625f 7175       'ibm_job_qu
+0000b830: 6575 655f 6d75 6c74 696e 6f64 6527 2c0a  eue_multinode',.
+0000b840: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
+0000b850: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
+0000b860: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
+0000b870: 2d2d 636c 6f75 6420 6962 6d20 2d2d 6770  --cloud ibm --gp
+0000b880: 7573 2076 3130 3020 2d2d 6e75 6d2d 6e6f  us v100 --num-no
+0000b890: 6465 7320 3227 2c0a 2020 2020 2020 2020  des 2',.        
+0000b8a0: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
+0000b8b0: 6e61 6d65 7d20 2d6e 207b 6e61 6d65 7d2d  name} -n {name}-
+0000b8c0: 3120 2d64 207b 7461 736b 5f66 696c 657d  1 -d {task_file}
+0000b8d0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000b8e0: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+0000b8f0: 202d 6e20 7b6e 616d 657d 2d32 202d 6420   -n {name}-2 -d 
+0000b900: 7b74 6173 6b5f 6669 6c65 7d27 2c0a 2020  {task_file}',.  
+0000b910: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000b920: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
+0000b930: 6d65 7d20 2d6e 207b 6e61 6d65 7d2d 3320  me} -n {name}-3 
+0000b940: 2d2d 6465 7461 6368 2d73 6574 7570 202d  --detach-setup -
+0000b950: 6420 7b74 6173 6b5f 6669 6c65 7d27 2c0a  d {task_file}',.
+0000b960: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
+0000b970: 2428 736b 7920 7175 6575 6520 7b6e 616d  $(sky queue {nam
+0000b980: 657d 2920 2626 2070 7269 6e74 6620 2224  e}) && printf "$
+0000b990: 7322 2026 2620 2865 6368 6f20 2224 7322  s" && (echo "$s"
+0000b9a0: 207c 2067 7265 7020 7b6e 616d 657d 2d31   | grep {name}-1
+0000b9b0: 207c 2067 7265 7020 5255 4e4e 494e 4729   | grep RUNNING)
+0000b9c0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000b9d0: 2773 3d24 2873 6b79 2071 7565 7565 207b  's=$(sky queue {
+0000b9e0: 6e61 6d65 7d29 2026 2620 7072 696e 7466  name}) && printf
+0000b9f0: 2022 2473 2220 2626 2028 6563 686f 2022   "$s" && (echo "
+0000ba00: 2473 2220 7c20 6772 6570 207b 6e61 6d65  $s" | grep {name
+0000ba10: 7d2d 3220 7c20 6772 6570 2052 554e 4e49  }-2 | grep RUNNI
+0000ba20: 4e47 2927 2c0a 2020 2020 2020 2020 2020  NG)',.          
+0000ba30: 2020 6627 733d 2428 736b 7920 7175 6575    f's=$(sky queu
+0000ba40: 6520 7b6e 616d 657d 2920 2626 2070 7269  e {name}) && pri
+0000ba50: 6e74 6620 2224 7322 2026 2620 2865 6368  ntf "$s" && (ech
+0000ba60: 6f20 2224 7322 207c 2067 7265 7020 7b6e  o "$s" | grep {n
+0000ba70: 616d 657d 2d33 207c 2067 7265 7020 5345  ame}-3 | grep SE
+0000ba80: 5454 494e 475f 5550 2927 2c0a 2020 2020  TTING_UP)',.    
+0000ba90: 2020 2020 2020 2020 2773 6c65 6570 2039          'sleep 9
+0000baa0: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
+0000bab0: 6627 733d 2428 736b 7920 7175 6575 6520  f's=$(sky queue 
+0000bac0: 7b6e 616d 657d 2920 2626 2070 7269 6e74  {name}) && print
+0000bad0: 6620 2224 7322 2026 2620 2865 6368 6f20  f "$s" && (echo 
+0000bae0: 2224 7322 207c 2067 7265 7020 7b6e 616d  "$s" | grep {nam
+0000baf0: 657d 2d33 207c 2067 7265 7020 5045 4e44  e}-3 | grep PEND
+0000bb00: 494e 4729 272c 0a20 2020 2020 2020 2020  ING)',.         
+0000bb10: 2020 2066 2773 6b79 2063 616e 6365 6c20     f'sky cancel 
+0000bb20: 2d79 207b 6e61 6d65 7d20 3127 2c0a 2020  -y {name} 1',.  
+0000bb30: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+0000bb40: 2035 272c 0a20 2020 2020 2020 2020 2020   5',.           
+0000bb50: 2066 2773 6b79 2071 7565 7565 207b 6e61   f'sky queue {na
+0000bb60: 6d65 7d20 7c20 6772 6570 207b 6e61 6d65  me} | grep {name
+0000bb70: 7d2d 3320 7c20 6772 6570 2052 554e 4e49  }-3 | grep RUNNI
+0000bb80: 4e47 272c 0a20 2020 2020 2020 2020 2020  NG',.           
+0000bb90: 2066 2773 6b79 2063 616e 6365 6c20 2d79   f'sky cancel -y
+0000bba0: 207b 6e61 6d65 7d20 3120 3220 3327 2c0a   {name} 1 2 3',.
+0000bbb0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000bbc0: 7920 6c61 756e 6368 202d 6320 7b6e 616d  y launch -c {nam
+0000bbd0: 657d 202d 6e20 7b6e 616d 657d 2d34 202d  e} -n {name}-4 -
+0000bbe0: 2d64 6574 6163 682d 7365 7475 7020 2d64  -detach-setup -d
+0000bbf0: 207b 7461 736b 5f66 696c 657d 272c 0a20   {task_file}',. 
+0000bc00: 2020 2020 2020 2020 2020 2023 2054 6573             # Tes
+0000bc10: 7420 7468 6520 6a6f 6220 7374 6174 7573  t the job status
+0000bc20: 2069 7320 636f 7272 6563 746c 7920 7365   is correctly se
+0000bc30: 7420 746f 2053 4554 5449 4e47 5f55 502c  t to SETTING_UP,
+0000bc40: 2064 7572 696e 6720 7468 6520 7365 7475   during the setu
+0000bc50: 7020 6973 2072 756e 6e69 6e67 2c0a 2020  p is running,.  
+0000bc60: 2020 2020 2020 2020 2020 2320 616e 6420            # and 
+0000bc70: 7468 6520 6a6f 6220 6361 6e20 6265 2063  the job can be c
+0000bc80: 616e 6365 6c6c 6564 2064 7572 696e 6720  ancelled during 
+0000bc90: 7468 6520 7365 7475 702e 0a20 2020 2020  the setup..     
+0000bca0: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
+0000bcb0: 2071 7565 7565 207b 6e61 6d65 7d29 2026   queue {name}) &
+0000bcc0: 2620 7072 696e 7466 2022 2473 2220 2626  & printf "$s" &&
+0000bcd0: 2028 6563 686f 2022 2473 2220 7c20 6772   (echo "$s" | gr
+0000bce0: 6570 207b 6e61 6d65 7d2d 3420 7c20 6772  ep {name}-4 | gr
+0000bcf0: 6570 2053 4554 5449 4e47 5f55 5029 272c  ep SETTING_UP)',
+0000bd00: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000bd10: 6b79 2063 616e 6365 6c20 2d79 207b 6e61  ky cancel -y {na
+0000bd20: 6d65 7d20 3427 2c0a 2020 2020 2020 2020  me} 4',.        
+0000bd30: 2020 2020 6627 733d 2428 736b 7920 7175      f's=$(sky qu
+0000bd40: 6575 6520 7b6e 616d 657d 2920 2626 2070  eue {name}) && p
+0000bd50: 7269 6e74 6620 2224 7322 2026 2620 2865  rintf "$s" && (e
+0000bd60: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
+0000bd70: 7b6e 616d 657d 2d34 207c 2067 7265 7020  {name}-4 | grep 
+0000bd80: 4341 4e43 454c 4c45 4429 272c 0a20 2020  CANCELLED)',.   
+0000bd90: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
+0000bda0: 7865 6320 7b6e 616d 657d 202d 2d67 7075  xec {name} --gpu
+0000bdb0: 7320 7631 3030 3a30 2e32 2022 5b5b 205c  s v100:0.2 "[[ \
+0000bdc0: 2453 4b59 5049 4c4f 545f 4e55 4d5f 4750  $SKYPILOT_NUM_GP
+0000bdd0: 5553 5f50 4552 5f4e 4f44 4520 2d65 7120  US_PER_NODE -eq 
+0000bde0: 3120 5d5d 207c 7c20 6578 6974 2031 2227  1 ]] || exit 1"'
+0000bdf0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000be00: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
+0000be10: 2d2d 6770 7573 2076 3130 303a 302e 3220  --gpus v100:0.2 
+0000be20: 2d2d 6e75 6d2d 6e6f 6465 7320 3220 225b  --num-nodes 2 "[
+0000be30: 5b20 5c24 534b 5950 494c 4f54 5f4e 554d  [ \$SKYPILOT_NUM
+0000be40: 5f47 5055 535f 5045 525f 4e4f 4445 202d  _GPUS_PER_NODE -
+0000be50: 6571 2031 205d 5d20 7c7c 2065 7869 7420  eq 1 ]] || exit 
+0000be60: 3122 272c 0a20 2020 2020 2020 2020 2020  1"',.           
+0000be70: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
+0000be80: 657d 202d 2d67 7075 7320 7631 3030 3a31  e} --gpus v100:1
+0000be90: 202d 2d6e 756d 2d6e 6f64 6573 2032 2022   --num-nodes 2 "
+0000bea0: 5b5b 205c 2453 4b59 5049 4c4f 545f 4e55  [[ \$SKYPILOT_NU
+0000beb0: 4d5f 4750 5553 5f50 4552 5f4e 4f44 4520  M_GPUS_PER_NODE 
+0000bec0: 2d65 7120 3120 5d5d 207c 7c20 6578 6974  -eq 1 ]] || exit
+0000bed0: 2031 2227 2c0a 2020 2020 2020 2020 2020   1"',.          
+0000bee0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+0000bef0: 6d65 7d20 3520 2d2d 7374 6174 7573 272c  me} 5 --status',
+0000bf00: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000bf10: 6b79 206c 6f67 7320 7b6e 616d 657d 2036  ky logs {name} 6
+0000bf20: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
+0000bf30: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+0000bf40: 6773 207b 6e61 6d65 7d20 3720 2d2d 7374  gs {name} 7 --st
+0000bf50: 6174 7573 272c 0a20 2020 2020 2020 205d  atus',.        ]
+0000bf60: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+0000bf70: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
+0000bf80: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
+0000bf90: 3d32 3020 2a20 3630 2c20 2023 2032 3020  =20 * 60,  # 20 
+0000bfa0: 6d69 6e73 0a20 2020 2029 0a20 2020 2072  mins.    ).    r
+0000bfb0: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+0000bfc0: 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d  )...# ----------
+0000bfd0: 2053 7562 6d69 7474 696e 6720 6d75 6c74   Submitting mult
+0000bfe0: 6970 6c65 2074 6173 6b73 2074 6f20 7468  iple tasks to th
+0000bff0: 6520 7361 6d65 2063 6c75 7374 6572 2e20  e same cluster. 
+0000c000: 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465  ----------.@pyte
+0000c010: 7374 2e6d 6172 6b2e 6e6f 5f6c 616d 6264  st.mark.no_lambd
+0000c020: 615f 636c 6f75 6420 2023 204c 616d 6264  a_cloud  # Lambd
+0000c030: 6120 436c 6f75 6420 646f 6573 206e 6f74  a Cloud does not
+0000c040: 2068 6176 6520 4b38 3020 6770 7573 0a40   have K80 gpus.@
+0000c050: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f69  pytest.mark.no_i
+0000c060: 626d 2020 2320 4942 4d20 436c 6f75 6420  bm  # IBM Cloud 
+0000c070: 646f 6573 206e 6f74 2068 6176 6520 4b38  does not have K8
+0000c080: 3020 6770 7573 0a40 7079 7465 7374 2e6d  0 gpus.@pytest.m
+0000c090: 6172 6b2e 6e6f 5f73 6370 2020 2320 5343  ark.no_scp  # SC
+0000c0a0: 5020 646f 6573 206e 6f74 2073 7570 706f  P does not suppo
+0000c0b0: 7274 206e 756d 5f6e 6f64 6573 203e 2031  rt num_nodes > 1
+0000c0c0: 2079 6574 0a40 7079 7465 7374 2e6d 6172   yet.@pytest.mar
+0000c0d0: 6b2e 6e6f 5f6f 6369 2020 2320 4f43 4920  k.no_oci  # OCI 
+0000c0e0: 436c 6f75 6420 646f 6573 206e 6f74 2068  Cloud does not h
+0000c0f0: 6176 6520 4b38 3020 6770 7573 0a40 7079  ave K80 gpus.@py
+0000c100: 7465 7374 2e6d 6172 6b2e 6e6f 5f6b 7562  test.mark.no_kub
+0000c110: 6572 6e65 7465 7320 2023 204b 7562 6572  ernetes  # Kuber
+0000c120: 6e65 7465 7320 6e6f 7420 6861 7665 2067  netes not have g
+0000c130: 7075 730a 6465 6620 7465 7374 5f6d 756c  pus.def test_mul
+0000c140: 7469 5f65 6368 6f28 6765 6e65 7269 635f  ti_echo(generic_
+0000c150: 636c 6f75 643a 2073 7472 293a 0a20 2020  cloud: str):.   
+0000c160: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
+0000c170: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
+0000c180: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+0000c190: 2020 2020 2027 6d75 6c74 695f 6563 686f       'multi_echo
+0000c1a0: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
+0000c1b0: 2020 2020 2020 2020 2066 2770 7974 686f           f'pytho
+0000c1c0: 6e20 6578 616d 706c 6573 2f6d 756c 7469  n examples/multi
+0000c1d0: 5f65 6368 6f2e 7079 207b 6e61 6d65 7d20  _echo.py {name} 
+0000c1e0: 7b67 656e 6572 6963 5f63 6c6f 7564 7d27  {generic_cloud}'
+0000c1f0: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
+0000c200: 6c65 6570 2031 3230 272c 0a20 2020 2020  leep 120',.     
+0000c210: 2020 205d 202b 0a20 2020 2020 2020 2023     ] +.        #
+0000c220: 2045 6e73 7572 6520 6a6f 6273 2073 7563   Ensure jobs suc
+0000c230: 6365 6564 6564 2e0a 2020 2020 2020 2020  ceeded..        
+0000c240: 5b66 2773 6b79 206c 6f67 7320 7b6e 616d  [f'sky logs {nam
+0000c250: 657d 207b 6920 2b20 317d 202d 2d73 7461  e} {i + 1} --sta
+0000c260: 7475 7327 2066 6f72 2069 2069 6e20 7261  tus' for i in ra
+0000c270: 6e67 6528 3332 295d 202b 0a20 2020 2020  nge(32)] +.     
+0000c280: 2020 2023 2045 6e73 7572 6520 6d6f 6e69     # Ensure moni
+0000c290: 746f 722f 6175 746f 7363 616c 6572 2064  tor/autoscaler d
+0000c2a0: 6964 6e27 7420 6372 6173 6820 6f6e 2074  idn't crash on t
+0000c2b0: 6865 2027 6173 7365 7274 206e 6f74 0a20  he 'assert not. 
+0000c2c0: 2020 2020 2020 2023 2075 6e66 756c 6669         # unfulfi
+0000c2d0: 6c6c 6564 2720 6572 726f 722e 2020 4966  lled' error.  If
+0000c2e0: 2070 726f 6365 7373 206e 6f74 2066 6f75   process not fou
+0000c2f0: 6e64 2c20 6772 6570 2d3e 7373 6820 7265  nd, grep->ssh re
+0000c300: 7475 726e 7320 312e 0a20 2020 2020 2020  turns 1..       
+0000c310: 205b 6627 7373 6820 7b6e 616d 657d 205c   [f'ssh {name} \
+0000c320: 2770 7320 6175 7820 7c20 6772 6570 2022  'ps aux | grep "
+0000c330: 5b2f 5d22 6d6f 6e69 746f 722e 7079 5c27  [/]"monitor.py\'
+0000c340: 275d 2c0a 2020 2020 2020 2020 6627 736b  '],.        f'sk
+0000c350: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
+0000c360: 272c 0a20 2020 2020 2020 2074 696d 656f  ',.        timeo
+0000c370: 7574 3d32 3020 2a20 3630 2c0a 2020 2020  ut=20 * 60,.    
+0000c380: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
+0000c390: 7374 2874 6573 7429 0a0a 0a23 202d 2d2d  st(test)...# ---
+0000c3a0: 2d2d 2d2d 2d2d 2d20 5461 736b 3a20 3120  ------- Task: 1 
+0000c3b0: 6e6f 6465 2074 7261 696e 696e 672e 202d  node training. -
+0000c3c0: 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974 6573  ---------.@pytes
+0000c3d0: 742e 6d61 726b 2e6e 6f5f 6c61 6d62 6461  t.mark.no_lambda
+0000c3e0: 5f63 6c6f 7564 2020 2320 4c61 6d62 6461  _cloud  # Lambda
+0000c3f0: 2043 6c6f 7564 2064 6f65 7320 6e6f 7420   Cloud does not 
+0000c400: 6861 7665 2056 3130 3020 6770 7573 0a40  have V100 gpus.@
+0000c410: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f69  pytest.mark.no_i
+0000c420: 626d 2020 2320 4942 4d20 636c 6f75 6420  bm  # IBM cloud 
+0000c430: 6375 7272 656e 746c 7920 646f 6573 6e27  currently doesn'
+0000c440: 7420 7072 6f76 6964 6520 7075 626c 6963  t provide public
+0000c450: 2069 6d61 6765 2077 6974 6820 4355 4441   image with CUDA
+0000c460: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+0000c470: 5f73 6370 2020 2320 5343 5020 646f 6573  _scp  # SCP does
+0000c480: 206e 6f74 2068 6176 6520 5631 3030 2028   not have V100 (
+0000c490: 3136 4742 2920 4750 5573 2e20 5275 6e20  16GB) GPUs. Run 
+0000c4a0: 7465 7374 5f73 6370 5f68 7567 6769 6e67  test_scp_hugging
+0000c4b0: 6661 6365 2069 6e73 7465 6164 2e0a 4070  face instead..@p
+0000c4c0: 7974 6573 742e 6d61 726b 2e6e 6f5f 6b75  ytest.mark.no_ku
+0000c4d0: 6265 726e 6574 6573 2020 2320 4b75 6265  bernetes  # Kube
+0000c4e0: 726e 6574 6573 206e 6f74 2068 6176 6520  rnetes not have 
+0000c4f0: 6770 7573 0a64 6566 2074 6573 745f 6875  gpus.def test_hu
+0000c500: 6767 696e 6766 6163 6528 6765 6e65 7269  ggingface(generi
+0000c510: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
+0000c520: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+0000c530: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+0000c540: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+0000c550: 2020 2020 2020 2027 6875 6767 696e 6766         'huggingf
+0000c560: 6163 655f 676c 7565 5f69 6d64 625f 6170  ace_glue_imdb_ap
+0000c570: 7027 2c0a 2020 2020 2020 2020 5b0a 2020  p',.        [.  
+0000c580: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000c590: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
+0000c5a0: 6d65 7d20 2d2d 636c 6f75 6420 7b67 656e  me} --cloud {gen
+0000c5b0: 6572 6963 5f63 6c6f 7564 7d20 6578 616d  eric_cloud} exam
+0000c5c0: 706c 6573 2f68 7567 6769 6e67 6661 6365  ples/huggingface
+0000c5d0: 5f67 6c75 655f 696d 6462 5f61 7070 2e79  _glue_imdb_app.y
+0000c5e0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+0000c5f0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+0000c600: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
+0000c610: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
+0000c620: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
+0000c630: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000c640: 6578 6563 207b 6e61 6d65 7d20 6578 616d  exec {name} exam
+0000c650: 706c 6573 2f68 7567 6769 6e67 6661 6365  ples/huggingface
+0000c660: 5f67 6c75 655f 696d 6462 5f61 7070 2e79  _glue_imdb_app.y
+0000c670: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+0000c680: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+0000c690: 6d65 7d20 3220 2d2d 7374 6174 7573 272c  me} 2 --status',
+0000c6a0: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
+0000c6b0: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
+0000c6c0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+0000c6d0: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
+0000c6e0: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
+0000c6f0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+0000c700: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+0000c710: 6172 6b2e 6c61 6d62 6461 5f63 6c6f 7564  ark.lambda_cloud
+0000c720: 0a64 6566 2074 6573 745f 6c61 6d62 6461  .def test_lambda
+0000c730: 5f68 7567 6769 6e67 6661 6365 2867 656e  _huggingface(gen
+0000c740: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
+0000c750: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
+0000c760: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+0000c770: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+0000c780: 280a 2020 2020 2020 2020 276c 616d 6264  (.        'lambd
+0000c790: 615f 6875 6767 696e 6766 6163 655f 676c  a_huggingface_gl
+0000c7a0: 7565 5f69 6d64 625f 6170 7027 2c0a 2020  ue_imdb_app',.  
+0000c7b0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+0000c7c0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+0000c7d0: 202d 7920 2d63 207b 6e61 6d65 7d20 7b4c   -y -c {name} {L
+0000c7e0: 414d 4244 415f 5459 5045 7d20 6578 616d  AMBDA_TYPE} exam
+0000c7f0: 706c 6573 2f68 7567 6769 6e67 6661 6365  ples/huggingface
+0000c800: 5f67 6c75 655f 696d 6462 5f61 7070 2e79  _glue_imdb_app.y
+0000c810: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+0000c820: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+0000c830: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
+0000c840: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
+0000c850: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
+0000c860: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000c870: 6578 6563 207b 6e61 6d65 7d20 7b4c 414d  exec {name} {LAM
+0000c880: 4244 415f 5459 5045 7d20 6578 616d 706c  BDA_TYPE} exampl
+0000c890: 6573 2f68 7567 6769 6e67 6661 6365 5f67  es/huggingface_g
+0000c8a0: 6c75 655f 696d 6462 5f61 7070 2e79 616d  lue_imdb_app.yam
+0000c8b0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+0000c8c0: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+0000c8d0: 7d20 3220 2d2d 7374 6174 7573 272c 2020  } 2 --status',  
+0000c8e0: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
+0000c8f0: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
+0000c900: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+0000c910: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+0000c920: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
+0000c930: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+0000c940: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
+0000c950: 6b2e 7363 700a 6465 6620 7465 7374 5f73  k.scp.def test_s
+0000c960: 6370 5f68 7567 6769 6e67 6661 6365 2867  cp_huggingface(g
+0000c970: 656e 6572 6963 5f63 6c6f 7564 3a20 7374  eneric_cloud: st
+0000c980: 7229 3a0a 2020 2020 6e61 6d65 203d 205f  r):.    name = _
+0000c990: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
+0000c9a0: 2829 0a20 2020 206e 756d 5f6f 665f 6770  ().    num_of_gp
+0000c9b0: 755f 6c61 756e 6368 203d 2031 0a20 2020  u_launch = 1.   
+0000c9c0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+0000c9d0: 2020 2020 2020 2753 4350 5f68 7567 6769        'SCP_huggi
+0000c9e0: 6e67 6661 6365 5f67 6c75 655f 696d 6462  ngface_glue_imdb
+0000c9f0: 5f61 7070 272c 0a20 2020 2020 2020 205b  _app',.        [
+0000ca00: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000ca10: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+0000ca20: 7b6e 616d 657d 207b 5343 505f 5459 5045  {name} {SCP_TYPE
+0000ca30: 7d20 7b53 4350 5f47 5055 5f56 3130 307d  } {SCP_GPU_V100}
+0000ca40: 3a7b 6e75 6d5f 6f66 5f67 7075 5f6c 6175  :{num_of_gpu_lau
+0000ca50: 6e63 687d 2065 7861 6d70 6c65 732f 6875  nch} examples/hu
+0000ca60: 6767 696e 6766 6163 655f 676c 7565 5f69  ggingface_glue_i
+0000ca70: 6d64 625f 6170 702e 7961 6d6c 272c 0a20  mdb_app.yaml',. 
+0000ca80: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000ca90: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
+0000caa0: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
+0000cab0: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
+0000cac0: 6565 6465 642e 0a20 2020 2020 2020 2020  eeded..         
+0000cad0: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
+0000cae0: 616d 657d 207b 5343 505f 5459 5045 7d20  ame} {SCP_TYPE} 
+0000caf0: 7b53 4350 5f47 5055 5f56 3130 307d 3a7b  {SCP_GPU_V100}:{
+0000cb00: 6e75 6d5f 6f66 5f67 7075 5f6c 6175 6e63  num_of_gpu_launc
+0000cb10: 687d 2065 7861 6d70 6c65 732f 6875 6767  h} examples/hugg
+0000cb20: 696e 6766 6163 655f 676c 7565 5f69 6d64  ingface_glue_imd
+0000cb30: 625f 6170 702e 7961 6d6c 272c 0a20 2020  b_app.yaml',.   
+0000cb40: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+0000cb50: 6f67 7320 7b6e 616d 657d 2032 202d 2d73  ogs {name} 2 --s
+0000cb60: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
+0000cb70: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
+0000cb80: 6465 642e 0a20 2020 2020 2020 205d 2c0a  ded..        ],.
+0000cb90: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
+0000cba0: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
+0000cbb0: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+0000cbc0: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
+0000cbd0: 2d2d 2d2d 2d2d 2d2d 2d2d 2054 5055 2e20  ---------- TPU. 
+0000cbe0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465  ----------.@pyte
+0000cbf0: 7374 2e6d 6172 6b2e 6763 700a 6465 6620  st.mark.gcp.def 
+0000cc00: 7465 7374 5f74 7075 2829 3a0a 2020 2020  test_tpu():.    
+0000cc10: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+0000cc20: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
+0000cc30: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+0000cc40: 2020 2020 2774 7075 5f61 7070 272c 0a20      'tpu_app',. 
+0000cc50: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+0000cc60: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+0000cc70: 6820 2d79 202d 6320 7b6e 616d 657d 2065  h -y -c {name} e
+0000cc80: 7861 6d70 6c65 732f 7470 752f 7470 755f  xamples/tpu/tpu_
+0000cc90: 6170 702e 7961 6d6c 272c 0a20 2020 2020  app.yaml',.     
+0000cca0: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+0000ccb0: 7320 7b6e 616d 657d 2031 272c 2020 2320  s {name} 1',  # 
+0000ccc0: 456e 7375 7265 2074 6865 206a 6f62 2066  Ensure the job f
+0000ccd0: 696e 6973 6865 642e 0a20 2020 2020 2020  inished..       
+0000cce0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+0000ccf0: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
+0000cd00: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
+0000cd10: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
+0000cd20: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000cd30: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+0000cd40: 7b6e 616d 657d 2065 7861 6d70 6c65 732f  {name} examples/
+0000cd50: 7470 752f 7470 755f 6170 702e 7961 6d6c  tpu/tpu_app.yaml
+0000cd60: 207c 2067 7265 7020 2254 5055 202e 2a20   | grep "TPU .* 
+0000cd70: 616c 7265 6164 7920 6578 6973 7473 2227  already exists"'
+0000cd80: 2c20 2023 2045 6e73 7572 6520 736b 7920  ,  # Ensure sky 
+0000cd90: 6c61 756e 6368 2077 6f6e 2774 2063 7265  launch won't cre
+0000cda0: 6174 6520 616e 6f74 6865 7220 5450 552e  ate another TPU.
+0000cdb0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+0000cdc0: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
+0000cdd0: 7920 7b6e 616d 657d 272c 0a20 2020 2020  y {name}',.     
+0000cde0: 2020 2074 696d 656f 7574 3d33 3020 2a20     timeout=30 * 
+0000cdf0: 3630 2c20 2023 2063 616e 2074 616b 6520  60,  # can take 
+0000ce00: 3e32 3020 6d69 6e73 0a20 2020 2029 0a20  >20 mins.    ). 
+0000ce10: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+0000ce20: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
+0000ce30: 2d2d 2d2d 2054 5055 2056 4d2e 202d 2d2d  ---- TPU VM. ---
+0000ce40: 2d2d 2d2d 2d2d 2d0a 4070 7974 6573 742e  -------.@pytest.
+0000ce50: 6d61 726b 2e67 6370 0a64 6566 2074 6573  mark.gcp.def tes
+0000ce60: 745f 7470 755f 766d 2829 3a0a 2020 2020  t_tpu_vm():.    
+0000ce70: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+0000ce80: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
+0000ce90: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+0000cea0: 2020 2020 2774 7075 5f76 6d5f 6170 7027      'tpu_vm_app'
+0000ceb0: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+0000cec0: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
+0000ced0: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
+0000cee0: 7d20 6578 616d 706c 6573 2f74 7075 2f74  } examples/tpu/t
+0000cef0: 7075 766d 5f6d 6e69 7374 2e79 616d 6c27  puvm_mnist.yaml'
+0000cf00: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000cf10: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+0000cf20: 3127 2c20 2023 2045 6e73 7572 6520 7468  1',  # Ensure th
+0000cf30: 6520 6a6f 6220 6669 6e69 7368 6564 2e0a  e job finished..
+0000cf40: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000cf50: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
+0000cf60: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
+0000cf70: 7375 7265 2074 6865 206a 6f62 2073 7563  sure the job suc
+0000cf80: 6365 6564 6564 2e0a 2020 2020 2020 2020  ceeded..        
+0000cf90: 2020 2020 6627 736b 7920 7374 6f70 202d      f'sky stop -
+0000cfa0: 7920 7b6e 616d 657d 272c 0a20 2020 2020  y {name}',.     
+0000cfb0: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
+0000cfc0: 2073 7461 7475 7320 7b6e 616d 657d 202d   status {name} -
+0000cfd0: 2d72 6566 7265 7368 293b 2065 6368 6f20  -refresh); echo 
+0000cfe0: 2224 7322 3b20 6563 686f 3b20 6563 686f  "$s"; echo; echo
+0000cff0: 3b20 6563 686f 2022 2473 2220 207c 2067  ; echo "$s"  | g
+0000d000: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
+0000d010: 7020 5354 4f50 5045 4427 2c20 2023 2045  p STOPPED',  # E
+0000d020: 6e73 7572 6520 7468 6520 636c 7573 7465  nsure the cluste
+0000d030: 7220 6973 2053 544f 5050 4544 2e0a 2020  r is STOPPED..  
+0000d040: 2020 2020 2020 2020 2020 2320 5573 6520            # Use 
+0000d050: 7265 7472 793a 2067 7561 7264 2061 6761  retry: guard aga
+0000d060: 696e 7374 2074 7261 6e73 6965 6e74 2065  inst transient e
+0000d070: 7272 6f72 7320 6f62 7365 7276 6564 2066  rrors observed f
+0000d080: 6f72 0a20 2020 2020 2020 2020 2020 2023  or.            #
+0000d090: 206a 7573 742d 7374 6f70 7065 6420 5450   just-stopped TP
+0000d0a0: 5520 564d 7320 2823 3936 3229 2e0a 2020  U VMs (#962)..  
+0000d0b0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000d0c0: 7374 6172 7420 2d2d 7265 7472 792d 756e  start --retry-un
+0000d0d0: 7469 6c2d 7570 202d 7920 7b6e 616d 657d  til-up -y {name}
+0000d0e0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000d0f0: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+0000d100: 2065 7861 6d70 6c65 732f 7470 752f 7470   examples/tpu/tp
+0000d110: 7576 6d5f 6d6e 6973 742e 7961 6d6c 272c  uvm_mnist.yaml',
+0000d120: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000d130: 6b79 206c 6f67 7320 7b6e 616d 657d 2032  ky logs {name} 2
+0000d140: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
+0000d150: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
+0000d160: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
+0000d170: 2020 2020 2066 2773 6b79 2073 746f 7020       f'sky stop 
+0000d180: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
+0000d190: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+0000d1a0: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+0000d1b0: 6d65 7d27 2c0a 2020 2020 2020 2020 7469  me}',.        ti
+0000d1c0: 6d65 6f75 743d 3330 202a 2036 302c 2020  meout=30 * 60,  
+0000d1d0: 2320 6361 6e20 7461 6b65 2033 3020 6d69  # can take 30 mi
+0000d1e0: 6e73 0a20 2020 2029 0a20 2020 2072 756e  ns.    ).    run
+0000d1f0: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+0000d200: 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054  ..# ---------- T
+0000d210: 5055 2056 4d20 506f 642e 202d 2d2d 2d2d  PU VM Pod. -----
+0000d220: 2d2d 2d2d 2d0a 4070 7974 6573 742e 6d61  -----.@pytest.ma
+0000d230: 726b 2e67 6370 0a64 6566 2074 6573 745f  rk.gcp.def test_
+0000d240: 7470 755f 766d 5f70 6f64 2829 3a0a 2020  tpu_vm_pod():.  
+0000d250: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+0000d260: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+0000d270: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+0000d280: 2020 2020 2020 2774 7075 5f70 6f64 272c        'tpu_pod',
+0000d290: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+0000d2a0: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
+0000d2b0: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
+0000d2c0: 2065 7861 6d70 6c65 732f 7470 752f 7470   examples/tpu/tp
+0000d2d0: 7576 6d5f 6d6e 6973 742e 7961 6d6c 202d  uvm_mnist.yaml -
+0000d2e0: 2d67 7075 7320 7470 752d 7632 2d33 3220  -gpus tpu-v2-32 
+0000d2f0: 2d2d 7573 652d 7370 6f74 202d 2d7a 6f6e  --use-spot --zon
+0000d300: 6520 6575 726f 7065 2d77 6573 7434 2d61  e europe-west4-a
+0000d310: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000d320: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+0000d330: 2031 272c 2020 2320 456e 7375 7265 2074   1',  # Ensure t
+0000d340: 6865 206a 6f62 2066 696e 6973 6865 642e  he job finished.
+0000d350: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000d360: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
+0000d370: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
+0000d380: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
+0000d390: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
+0000d3a0: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
+0000d3b0: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
+0000d3c0: 272c 0a20 2020 2020 2020 2074 696d 656f  ',.        timeo
+0000d3d0: 7574 3d33 3020 2a20 3630 2c20 2023 2063  ut=30 * 60,  # c
+0000d3e0: 616e 2074 616b 6520 3330 206d 696e 730a  an take 30 mins.
+0000d3f0: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+0000d400: 655f 7465 7374 2874 6573 7429 0a0a 0a23  e_test(test)...#
+0000d410: 202d 2d2d 2d2d 2d2d 2d2d 2d20 5369 6d70   ---------- Simp
+0000d420: 6c65 2061 7070 732e 202d 2d2d 2d2d 2d2d  le apps. -------
+0000d430: 2d2d 2d0a 4070 7974 6573 742e 6d61 726b  ---.@pytest.mark
+0000d440: 2e6e 6f5f 7363 7020 2023 2053 4350 2064  .no_scp  # SCP d
+0000d450: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
+0000d460: 6e75 6d5f 6e6f 6465 7320 3e20 3120 7965  num_nodes > 1 ye
+0000d470: 740a 4070 7974 6573 742e 6d61 726b 2e6e  t.@pytest.mark.n
+0000d480: 6f5f 6b75 6265 726e 6574 6573 2020 2320  o_kubernetes  # 
+0000d490: 4b75 6265 726e 6574 6573 2064 6f65 7320  Kubernetes does 
+0000d4a0: 6e6f 7420 7375 7070 6f72 7420 6e75 6d5f  not support num_
+0000d4b0: 6e6f 6465 7320 3e20 3120 6e6f 6465 2079  nodes > 1 node y
+0000d4c0: 6574 0a64 6566 2074 6573 745f 6d75 6c74  et.def test_mult
+0000d4d0: 695f 686f 7374 6e61 6d65 2867 656e 6572  i_hostname(gener
+0000d4e0: 6963 5f63 6c6f 7564 3a20 7374 7229 3a0a  ic_cloud: str):.
+0000d4f0: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+0000d500: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+0000d510: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+0000d520: 2020 2020 2020 2020 276d 756c 7469 5f68          'multi_h
+0000d530: 6f73 746e 616d 6527 2c0a 2020 2020 2020  ostname',.      
+0000d540: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+0000d550: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
+0000d560: 2d63 207b 6e61 6d65 7d20 2d2d 636c 6f75  -c {name} --clou
+0000d570: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
+0000d580: 7d20 6578 616d 706c 6573 2f6d 756c 7469  } examples/multi
+0000d590: 5f68 6f73 746e 616d 652e 7961 6d6c 272c  _hostname.yaml',
+0000d5a0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000d5b0: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
+0000d5c0: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
+0000d5d0: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
+0000d5e0: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
+0000d5f0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+0000d600: 7b6e 616d 657d 2031 207c 2067 7265 7020  {name} 1 | grep 
+0000d610: 224d 7920 686f 7374 6e61 6d65 3a22 207c  "My hostname:" |
+0000d620: 2077 6320 2d6c 207c 2067 7265 7020 3227   wc -l | grep 2'
+0000d630: 2c20 2023 2045 6e73 7572 6520 7468 6572  ,  # Ensure ther
+0000d640: 6520 6172 6520 3220 686f 7374 732e 0a20  e are 2 hosts.. 
+0000d650: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000d660: 2065 7865 6320 7b6e 616d 657d 2065 7861   exec {name} exa
+0000d670: 6d70 6c65 732f 6d75 6c74 695f 686f 7374  mples/multi_host
+0000d680: 6e61 6d65 2e79 616d 6c27 2c0a 2020 2020  name.yaml',.    
+0000d690: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+0000d6a0: 6773 207b 6e61 6d65 7d20 3220 2d2d 7374  gs {name} 2 --st
+0000d6b0: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
+0000d6c0: 2074 6865 206a 6f62 2073 7563 6365 6564   the job succeed
+0000d6d0: 6564 2e0a 2020 2020 2020 2020 5d2c 0a20  ed..        ],. 
+0000d6e0: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
+0000d6f0: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
+0000d700: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
+0000d710: 7465 7374 2874 6573 7429 0a0a 0a23 202d  test(test)...# -
+0000d720: 2d2d 2d2d 2d2d 2d2d 2d20 5765 6220 6170  --------- Web ap
+0000d730: 7073 2077 6974 6820 6375 7374 6f6d 2070  ps with custom p
+0000d740: 6f72 7473 206f 6e20 4743 502e 202d 2d2d  orts on GCP. ---
+0000d750: 2d2d 2d2d 2d2d 2d0a 4070 7974 6573 742e  -------.@pytest.
+0000d760: 6d61 726b 2e67 6370 0a64 6566 2074 6573  mark.gcp.def tes
+0000d770: 745f 6763 705f 6874 7470 5f73 6572 7665  t_gcp_http_serve
+0000d780: 725f 7769 7468 5f63 7573 746f 6d5f 706f  r_with_custom_po
+0000d790: 7274 7328 293a 0a20 2020 206e 616d 6520  rts():.    name 
+0000d7a0: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
+0000d7b0: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
+0000d7c0: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
+0000d7d0: 6763 705f 6874 7470 5f73 6572 7665 725f  gcp_http_server_
+0000d7e0: 7769 7468 5f63 7573 746f 6d5f 706f 7274  with_custom_port
+0000d7f0: 7327 2c0a 2020 2020 2020 2020 5b0a 2020  s',.        [.  
+0000d800: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000d810: 6c61 756e 6368 202d 7920 2d64 202d 6320  launch -y -d -c 
+0000d820: 7b6e 616d 657d 202d 2d63 6c6f 7564 2067  {name} --cloud g
+0000d830: 6370 2065 7861 6d70 6c65 732f 6874 7470  cp examples/http
+0000d840: 5f73 6572 7665 725f 7769 7468 5f63 7573  _server_with_cus
+0000d850: 746f 6d5f 706f 7274 732f 7461 736b 2e79  tom_ports/task.y
+0000d860: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+0000d870: 2020 2773 6c65 6570 2031 3027 2c0a 2020    'sleep 10',.  
+0000d880: 2020 2020 2020 2020 2020 2769 703d 2428            'ip=$(
+0000d890: 6772 6570 202d 4131 2022 486f 7374 2027  grep -A1 "Host '
+0000d8a0: 202b 206e 616d 6520 2b0a 2020 2020 2020   + name +.      
+0000d8b0: 2020 2020 2020 2722 207e 2f2e 7373 682f        '" ~/.ssh/
+0000d8c0: 636f 6e66 6967 207c 2067 7265 7020 2248  config | grep "H
+0000d8d0: 6f73 744e 616d 6522 207c 2061 776b 205c  ostName" | awk \
+0000d8e0: 277b 7072 696e 7420 2432 7d5c 2729 3b20  '{print $2}\'); 
+0000d8f0: 6375 726c 2024 6970 3a33 3338 3238 207c  curl $ip:33828 |
+0000d900: 2067 7265 7020 223c 6831 3e54 6869 7320   grep "<h1>This 
+0000d910: 6973 2061 2064 656d 6f20 4854 4d4c 2070  is a demo HTML p
+0000d920: 6167 652e 3c2f 6831 3e22 272c 0a20 2020  age.</h1>"',.   
+0000d930: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+0000d940: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
+0000d950: 616d 657d 272c 0a20 2020 2029 0a20 2020  ame}',.    ).   
+0000d960: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+0000d970: 7374 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d  st)...# --------
+0000d980: 2d2d 2057 6562 2061 7070 7320 7769 7468  -- Web apps with
+0000d990: 2063 7573 746f 6d20 706f 7274 7320 6f6e   custom ports on
+0000d9a0: 2041 5753 2e20 2d2d 2d2d 2d2d 2d2d 2d2d   AWS. ----------
+0000d9b0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6177  .@pytest.mark.aw
+0000d9c0: 730a 6465 6620 7465 7374 5f61 7773 5f68  s.def test_aws_h
+0000d9d0: 7474 705f 7365 7276 6572 5f77 6974 685f  ttp_server_with_
+0000d9e0: 6375 7374 6f6d 5f70 6f72 7473 2829 3a0a  custom_ports():.
+0000d9f0: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+0000da00: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+0000da10: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+0000da20: 2020 2020 2020 2020 2761 7773 5f68 7474          'aws_htt
+0000da30: 705f 7365 7276 6572 5f77 6974 685f 6375  p_server_with_cu
+0000da40: 7374 6f6d 5f70 6f72 7473 272c 0a20 2020  stom_ports',.   
+0000da50: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+0000da60: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+0000da70: 2d79 202d 6420 2d63 207b 6e61 6d65 7d20  -y -d -c {name} 
+0000da80: 2d2d 636c 6f75 6420 6177 7320 6578 616d  --cloud aws exam
+0000da90: 706c 6573 2f68 7474 705f 7365 7276 6572  ples/http_server
+0000daa0: 5f77 6974 685f 6375 7374 6f6d 5f70 6f72  _with_custom_por
+0000dab0: 7473 2f74 6173 6b2e 7961 6d6c 272c 0a20  ts/task.yaml',. 
+0000dac0: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+0000dad0: 7020 3130 272c 0a20 2020 2020 2020 2020  p 10',.         
+0000dae0: 2020 2027 6970 3d24 2867 7265 7020 2d41     'ip=$(grep -A
+0000daf0: 3120 2248 6f73 7420 2720 2b20 6e61 6d65  1 "Host ' + name
+0000db00: 202b 0a20 2020 2020 2020 2020 2020 2027   +.            '
+0000db10: 2220 7e2f 2e73 7368 2f63 6f6e 6669 6720  " ~/.ssh/config 
+0000db20: 7c20 6772 6570 2022 486f 7374 4e61 6d65  | grep "HostName
+0000db30: 2220 7c20 6177 6b20 5c27 7b70 7269 6e74  " | awk \'{print
+0000db40: 2024 327d 5c27 293b 2063 7572 6c20 2469   $2}\'); curl $i
+0000db50: 703a 3333 3832 3820 7c20 6772 6570 2022  p:33828 | grep "
+0000db60: 3c68 313e 5468 6973 2069 7320 6120 6465  <h1>This is a de
+0000db70: 6d6f 2048 544d 4c20 7061 6765 2e3c 2f68  mo HTML page.</h
+0000db80: 313e 2227 2c0a 2020 2020 2020 2020 5d2c  1>"',.        ],
+0000db90: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
+0000dba0: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
+0000dbb0: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+0000dbc0: 655f 7465 7374 2874 6573 7429 0a0a 0a23  e_test(test)...#
+0000dbd0: 202d 2d2d 2d2d 2d2d 2d2d 2d20 5461 736b   ---------- Task
+0000dbe0: 3a20 6e3d 3220 6e6f 6465 7320 7769 7468  : n=2 nodes with
+0000dbf0: 2073 6574 7570 732e 202d 2d2d 2d2d 2d2d   setups. -------
+0000dc00: 2d2d 2d0a 4070 7974 6573 742e 6d61 726b  ---.@pytest.mark
+0000dc10: 2e6e 6f5f 6c61 6d62 6461 5f63 6c6f 7564  .no_lambda_cloud
+0000dc20: 2020 2320 4c61 6d62 6461 2043 6c6f 7564    # Lambda Cloud
+0000dc30: 2064 6f65 7320 6e6f 7420 6861 7665 2056   does not have V
+0000dc40: 3130 3020 6770 7573 0a40 7079 7465 7374  100 gpus.@pytest
+0000dc50: 2e6d 6172 6b2e 6e6f 5f69 626d 2020 2320  .mark.no_ibm  # 
+0000dc60: 4942 4d20 636c 6f75 6420 6375 7272 656e  IBM cloud curren
+0000dc70: 746c 7920 646f 6573 6e27 7420 7072 6f76  tly doesn't prov
+0000dc80: 6964 6520 7075 626c 6963 2069 6d61 6765  ide public image
+0000dc90: 2077 6974 6820 4355 4441 0a40 7079 7465   with CUDA.@pyte
+0000dca0: 7374 2e6d 6172 6b2e 6e6f 5f73 6370 2020  st.mark.no_scp  
+0000dcb0: 2320 5343 5020 646f 6573 206e 6f74 2073  # SCP does not s
+0000dcc0: 7570 706f 7274 206e 756d 5f6e 6f64 6573  upport num_nodes
+0000dcd0: 203e 2031 2079 6574 0a40 7079 7465 7374   > 1 yet.@pytest
+0000dce0: 2e6d 6172 6b2e 6e6f 5f6b 7562 6572 6e65  .mark.no_kuberne
+0000dcf0: 7465 7320 2023 204b 7562 6572 6e65 7465  tes  # Kubernete
+0000dd00: 7320 646f 6573 206e 6f74 2073 7570 706f  s does not suppo
+0000dd10: 7274 206e 756d 5f6e 6f64 6573 203e 2031  rt num_nodes > 1
+0000dd20: 206e 6f64 6520 7965 740a 4070 7974 6573   node yet.@pytes
+0000dd30: 742e 6d61 726b 2e73 6b69 7028 0a20 2020  t.mark.skip(.   
+0000dd40: 2072 6561 736f 6e3d 0a20 2020 2027 5468   reason=.    'Th
+0000dd50: 6520 7265 736e 6574 5f64 6973 7472 6962  e resnet_distrib
+0000dd60: 7574 6564 5f74 665f 6170 7020 6973 2066  uted_tf_app is f
+0000dd70: 6c61 6b79 2c20 6475 6520 746f 2069 7420  laky, due to it 
+0000dd80: 6661 696c 696e 6720 746f 2064 6574 6563  failing to detec
+0000dd90: 7420 4750 5573 2e27 290a 6465 6620 7465  t GPUs.').def te
+0000dda0: 7374 5f64 6973 7472 6962 7574 6564 5f74  st_distributed_t
+0000ddb0: 6628 6765 6e65 7269 635f 636c 6f75 643a  f(generic_cloud:
+0000ddc0: 2073 7472 293a 0a20 2020 206e 616d 6520   str):.    name 
+0000ddd0: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
+0000dde0: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
+0000ddf0: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
+0000de00: 7265 736e 6574 5f64 6973 7472 6962 7574  resnet_distribut
+0000de10: 6564 5f74 665f 6170 7027 2c0a 2020 2020  ed_tf_app',.    
+0000de20: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+0000de30: 2020 2320 4e4f 5445 3a20 7275 6e6e 696e    # NOTE: runnin
+0000de40: 6720 6974 2074 7769 6365 2077 696c 6c20  g it twice will 
+0000de50: 6861 6e67 2028 736f 6d65 7469 6d65 733f  hang (sometimes?
+0000de60: 2920 2d20 616e 2061 7070 2d6c 6576 656c  ) - an app-level
+0000de70: 2062 7567 2e0a 2020 2020 2020 2020 2020   bug..          
+0000de80: 2020 6627 7079 7468 6f6e 2065 7861 6d70    f'python examp
+0000de90: 6c65 732f 7265 736e 6574 5f64 6973 7472  les/resnet_distr
+0000dea0: 6962 7574 6564 5f74 665f 6170 702e 7079  ibuted_tf_app.py
+0000deb0: 207b 6e61 6d65 7d20 7b67 656e 6572 6963   {name} {generic
+0000dec0: 5f63 6c6f 7564 7d27 2c0a 2020 2020 2020  _cloud}',.      
+0000ded0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+0000dee0: 207b 6e61 6d65 7d20 3120 2d2d 7374 6174   {name} 1 --stat
+0000def0: 7573 272c 2020 2320 456e 7375 7265 2074  us',  # Ensure t
+0000df00: 6865 206a 6f62 2073 7563 6365 6564 6564  he job succeeded
+0000df10: 2e0a 2020 2020 2020 2020 5d2c 0a20 2020  ..        ],.   
+0000df20: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
+0000df30: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
+0000df40: 2020 2020 7469 6d65 6f75 743d 3235 202a      timeout=25 *
+0000df50: 2036 302c 2020 2320 3235 206d 696e 7320   60,  # 25 mins 
+0000df60: 2869 7420 7461 6b65 7320 6172 6f75 6e64  (it takes around
+0000df70: 207e 3139 206d 696e 7329 0a20 2020 2029   ~19 mins).    )
+0000df80: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+0000df90: 7428 7465 7374 290a 0a0a 2320 2d2d 2d2d  t(test)...# ----
+0000dfa0: 2d2d 2d2d 2d2d 2054 6573 7469 6e67 2047  ------ Testing G
+0000dfb0: 4350 2073 7461 7274 2061 6e64 2073 746f  CP start and sto
+0000dfc0: 7020 696e 7374 616e 6365 7320 2d2d 2d2d  p instances ----
+0000dfd0: 2d2d 2d2d 2d2d 0a40 7079 7465 7374 2e6d  ------.@pytest.m
+0000dfe0: 6172 6b2e 6763 700a 6465 6620 7465 7374  ark.gcp.def test
+0000dff0: 5f67 6370 5f73 7461 7274 5f73 746f 7028  _gcp_start_stop(
+0000e000: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
+0000e010: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
+0000e020: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
+0000e030: 7428 0a20 2020 2020 2020 2027 6763 702d  t(.        'gcp-
+0000e040: 7374 6172 742d 7374 6f70 272c 0a20 2020  start-stop',.   
+0000e050: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+0000e060: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+0000e070: 2d79 202d 6320 7b6e 616d 657d 2065 7861  -y -c {name} exa
+0000e080: 6d70 6c65 732f 6763 705f 7374 6172 745f  mples/gcp_start_
+0000e090: 7374 6f70 2e79 616d 6c27 2c0a 2020 2020  stop.yaml',.    
+0000e0a0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+0000e0b0: 6773 207b 6e61 6d65 7d20 3120 2d2d 7374  gs {name} 1 --st
+0000e0c0: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
+0000e0d0: 2074 6865 206a 6f62 2073 7563 6365 6564   the job succeed
+0000e0e0: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
+0000e0f0: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+0000e100: 7d20 6578 616d 706c 6573 2f67 6370 5f73  } examples/gcp_s
+0000e110: 7461 7274 5f73 746f 702e 7961 6d6c 272c  tart_stop.yaml',
+0000e120: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000e130: 6b79 206c 6f67 7320 7b6e 616d 657d 2032  ky logs {name} 2
+0000e140: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
+0000e150: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
+0000e160: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
+0000e170: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
+0000e180: 7b6e 616d 657d 2022 7072 6c69 6d69 7420  {name} "prlimit 
+0000e190: 2d6e 202d 2d70 6964 3d5c 2428 7067 7265  -n --pid=\$(pgre
+0000e1a0: 7020 2d66 205c 2772 6179 6c65 742f 7261  p -f \'raylet/ra
+0000e1b0: 796c 6574 202d 2d72 6179 6c65 745f 736f  ylet --raylet_so
+0000e1c0: 636b 6574 5f6e 616d 655c 2729 207c 2067  cket_name\') | g
+0000e1d0: 7265 7020 5c27 225c 2731 3034 3835 3736  rep \'"\'1048576
+0000e1e0: 2031 3034 3835 3736 5c27 225c 2722 272c   1048576\'"\'"',
+0000e1f0: 2020 2320 456e 7375 7265 2074 6865 2072    # Ensure the r
+0000e200: 6179 6c65 7420 7072 6f63 6573 7320 6861  aylet process ha
+0000e210: 7320 7468 6520 636f 7272 6563 7420 6669  s the correct fi
+0000e220: 6c65 2064 6573 6372 6970 746f 7220 6c69  le descriptor li
+0000e230: 6d69 742e 0a20 2020 2020 2020 2020 2020  mit..           
+0000e240: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+0000e250: 657d 2033 202d 2d73 7461 7475 7327 2c20  e} 3 --status', 
+0000e260: 2023 2045 6e73 7572 6520 7468 6520 6a6f   # Ensure the jo
+0000e270: 6220 7375 6363 6565 6465 642e 0a20 2020  b succeeded..   
+0000e280: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
+0000e290: 746f 7020 2d79 207b 6e61 6d65 7d27 2c0a  top -y {name}',.
+0000e2a0: 2020 2020 2020 2020 2020 2020 6627 736c              f'sl
+0000e2b0: 6565 7020 3230 272c 0a20 2020 2020 2020  eep 20',.       
+0000e2c0: 2020 2020 2066 2773 6b79 2073 7461 7274       f'sky start
+0000e2d0: 202d 7920 7b6e 616d 657d 202d 6920 3127   -y {name} -i 1'
+0000e2e0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000e2f0: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
+0000e300: 6578 616d 706c 6573 2f67 6370 5f73 7461  examples/gcp_sta
+0000e310: 7274 5f73 746f 702e 7961 6d6c 272c 0a20  rt_stop.yaml',. 
+0000e320: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000e330: 206c 6f67 7320 7b6e 616d 657d 2034 202d   logs {name} 4 -
+0000e340: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
+0000e350: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
+0000e360: 6565 6465 642e 0a20 2020 2020 2020 2020  eeded..         
+0000e370: 2020 2027 736c 6565 7020 3138 3027 2c0a     'sleep 180',.
+0000e380: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000e390: 7920 7374 6174 7573 202d 7220 7b6e 616d  y status -r {nam
+0000e3a0: 657d 207c 2067 7265 7020 2249 4e49 545c  e} | grep "INIT\
+0000e3b0: 7c53 544f 5050 4544 2227 2c0a 2020 2020  |STOPPED"',.    
+0000e3c0: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+0000e3d0: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+0000e3e0: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
+0000e3f0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+0000e400: 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d  t)...# ---------
+0000e410: 2d20 5465 7374 696e 6720 417a 7572 6520  - Testing Azure 
+0000e420: 7374 6172 7420 616e 6420 7374 6f70 2069  start and stop i
+0000e430: 6e73 7461 6e63 6573 202d 2d2d 2d2d 2d2d  nstances -------
+0000e440: 2d2d 2d0a 4070 7974 6573 742e 6d61 726b  ---.@pytest.mark
+0000e450: 2e61 7a75 7265 0a64 6566 2074 6573 745f  .azure.def test_
+0000e460: 617a 7572 655f 7374 6172 745f 7374 6f70  azure_start_stop
+0000e470: 2829 3a0a 2020 2020 6e61 6d65 203d 205f  ():.    name = _
+0000e480: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
+0000e490: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
+0000e4a0: 7374 280a 2020 2020 2020 2020 2761 7a75  st(.        'azu
+0000e4b0: 7265 2d73 7461 7274 2d73 746f 7027 2c0a  re-start-stop',.
+0000e4c0: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
+0000e4d0: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
+0000e4e0: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
+0000e4f0: 6578 616d 706c 6573 2f61 7a75 7265 5f73  examples/azure_s
+0000e500: 7461 7274 5f73 746f 702e 7961 6d6c 272c  tart_stop.yaml',
+0000e510: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000e520: 6b79 2065 7865 6320 7b6e 616d 657d 2065  ky exec {name} e
+0000e530: 7861 6d70 6c65 732f 617a 7572 655f 7374  xamples/azure_st
+0000e540: 6172 745f 7374 6f70 2e79 616d 6c27 2c0a  art_stop.yaml',.
+0000e550: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000e560: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
+0000e570: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
+0000e580: 7375 7265 2074 6865 206a 6f62 2073 7563  sure the job suc
+0000e590: 6365 6564 6564 2e0a 2020 2020 2020 2020  ceeded..        
+0000e5a0: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
+0000e5b0: 6e61 6d65 7d20 2270 726c 696d 6974 202d  name} "prlimit -
+0000e5c0: 6e20 2d2d 7069 643d 5c24 2870 6772 6570  n --pid=\$(pgrep
+0000e5d0: 202d 6620 5c27 7261 796c 6574 2f72 6179   -f \'raylet/ray
+0000e5e0: 6c65 7420 2d2d 7261 796c 6574 5f73 6f63  let --raylet_soc
+0000e5f0: 6b65 745f 6e61 6d65 5c27 2920 7c20 6772  ket_name\') | gr
+0000e600: 6570 205c 2722 5c27 3130 3438 3537 3620  ep \'"\'1048576 
+0000e610: 3130 3438 3537 365c 2722 5c27 2227 2c20  1048576\'"\'"', 
+0000e620: 2023 2045 6e73 7572 6520 7468 6520 7261   # Ensure the ra
+0000e630: 796c 6574 2070 726f 6365 7373 2068 6173  ylet process has
+0000e640: 2074 6865 2063 6f72 7265 6374 2066 696c   the correct fil
+0000e650: 6520 6465 7363 7269 7074 6f72 206c 696d  e descriptor lim
+0000e660: 6974 2e0a 2020 2020 2020 2020 2020 2020  it..            
+0000e670: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+0000e680: 7d20 3220 2d2d 7374 6174 7573 272c 2020  } 2 --status',  
+0000e690: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
+0000e6a0: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
+0000e6b0: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
+0000e6c0: 6f70 202d 7920 7b6e 616d 657d 272c 0a20  op -y {name}',. 
+0000e6d0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000e6e0: 2073 7461 7274 202d 7920 7b6e 616d 657d   start -y {name}
+0000e6f0: 202d 6920 3127 2c0a 2020 2020 2020 2020   -i 1',.        
+0000e700: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
+0000e710: 6e61 6d65 7d20 6578 616d 706c 6573 2f61  name} examples/a
+0000e720: 7a75 7265 5f73 7461 7274 5f73 746f 702e  zure_start_stop.
+0000e730: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+0000e740: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+0000e750: 616d 657d 2033 202d 2d73 7461 7475 7327  ame} 3 --status'
+0000e760: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
+0000e770: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
+0000e780: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+0000e790: 7020 3230 3027 2c0a 2020 2020 2020 2020  p 200',.        
+0000e7a0: 2020 2020 6627 733d 2428 736b 7920 7374      f's=$(sky st
+0000e7b0: 6174 7573 202d 7220 7b6e 616d 657d 2920  atus -r {name}) 
+0000e7c0: 2626 2065 6368 6f20 2473 2026 2620 6563  && echo $s && ec
+0000e7d0: 686f 2024 7320 7c20 6772 6570 2022 494e  ho $s | grep "IN
+0000e7e0: 4954 5c7c 5354 4f50 5045 4422 270a 2020  IT\|STOPPED"'.  
+0000e7f0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+0000e800: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
+0000e810: 6e61 6d65 7d27 2c0a 2020 2020 2020 2020  name}',.        
+0000e820: 7469 6d65 6f75 743d 3330 202a 2036 302c  timeout=30 * 60,
+0000e830: 2020 2320 3330 206d 696e 730a 2020 2020    # 30 mins.    
+0000e840: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
+0000e850: 7374 2874 6573 7429 0a0a 0a23 202d 2d2d  st(test)...# ---
+0000e860: 2d2d 2d2d 2d2d 2d20 5465 7374 696e 6720  ------- Testing 
+0000e870: 4175 746f 7374 6f70 7069 6e67 202d 2d2d  Autostopping ---
+0000e880: 2d2d 2d2d 2d2d 2d0a 4070 7974 6573 742e  -------.@pytest.
+0000e890: 6d61 726b 2e6e 6f5f 6c61 6d62 6461 5f63  mark.no_lambda_c
+0000e8a0: 6c6f 7564 2020 2320 4c61 6d62 6461 2043  loud  # Lambda C
+0000e8b0: 6c6f 7564 2064 6f65 7320 6e6f 7420 7375  loud does not su
+0000e8c0: 7070 6f72 7420 7374 6f70 7069 6e67 2069  pport stopping i
+0000e8d0: 6e73 7461 6e63 6573 0a40 7079 7465 7374  nstances.@pytest
+0000e8e0: 2e6d 6172 6b2e 6e6f 5f69 626d 2020 2320  .mark.no_ibm  # 
+0000e8f0: 4649 5828 4942 4d29 2073 706f 7261 6469  FIX(IBM) sporadi
+0000e900: 6361 6c6c 7920 6661 696c 732c 2061 7320  cally fails, as 
+0000e910: 7265 7374 6172 7465 6420 776f 726b 6572  restarted worker
+0000e920: 7320 7374 6179 2075 6e69 6e69 7469 616c  s stay uninitial
+0000e930: 697a 6564 2069 6e64 6566 696e 6974 656c  ized indefinitel
+0000e940: 790a 4070 7974 6573 742e 6d61 726b 2e6e  y.@pytest.mark.n
+0000e950: 6f5f 7363 7020 2023 2053 4350 2064 6f65  o_scp  # SCP doe
+0000e960: 7320 6e6f 7420 7375 7070 6f72 7420 6e75  s not support nu
+0000e970: 6d5f 6e6f 6465 7320 3e20 3120 7965 740a  m_nodes > 1 yet.
+0000e980: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+0000e990: 6b75 6265 726e 6574 6573 2020 2320 4b75  kubernetes  # Ku
+0000e9a0: 6265 726e 6574 6573 2064 6f65 7320 6e6f  bernetes does no
+0000e9b0: 7420 6175 746f 7374 6f70 2079 6574 0a64  t autostop yet.d
+0000e9c0: 6566 2074 6573 745f 6175 746f 7374 6f70  ef test_autostop
+0000e9d0: 2867 656e 6572 6963 5f63 6c6f 7564 3a20  (generic_cloud: 
+0000e9e0: 7374 7229 3a0a 2020 2020 6e61 6d65 203d  str):.    name =
+0000e9f0: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+0000ea00: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
+0000ea10: 5465 7374 280a 2020 2020 2020 2020 2761  Test(.        'a
+0000ea20: 7574 6f73 746f 7027 2c0a 2020 2020 2020  utostop',.      
+0000ea30: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+0000ea40: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
+0000ea50: 2d64 202d 6320 7b6e 616d 657d 202d 2d6e  -d -c {name} --n
+0000ea60: 756d 2d6e 6f64 6573 2032 202d 2d63 6c6f  um-nodes 2 --clo
+0000ea70: 7564 207b 6765 6e65 7269 635f 636c 6f75  ud {generic_clou
+0000ea80: 647d 2074 6573 7473 2f74 6573 745f 7961  d} tests/test_ya
+0000ea90: 6d6c 732f 6d69 6e69 6d61 6c2e 7961 6d6c  mls/minimal.yaml
+0000eaa0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000eab0: 2773 6b79 2061 7574 6f73 746f 7020 2d79  'sky autostop -y
+0000eac0: 207b 6e61 6d65 7d20 2d69 2031 272c 0a0a   {name} -i 1',..
+0000ead0: 2020 2020 2020 2020 2020 2020 2320 456e              # En
+0000eae0: 7375 7265 2061 7574 6f73 746f 7020 6973  sure autostop is
+0000eaf0: 2073 6574 2e0a 2020 2020 2020 2020 2020   set..          
+0000eb00: 2020 6627 736b 7920 7374 6174 7573 207c    f'sky status |
+0000eb10: 2067 7265 7020 7b6e 616d 657d 207c 2067   grep {name} | g
+0000eb20: 7265 7020 2231 6d22 272c 0a0a 2020 2020  rep "1m"',..    
+0000eb30: 2020 2020 2020 2020 2320 456e 7375 7265          # Ensure
+0000eb40: 2074 6865 2063 6c75 7374 6572 2069 7320   the cluster is 
+0000eb50: 6e6f 7420 7374 6f70 7065 6420 6561 726c  not stopped earl
+0000eb60: 792e 0a20 2020 2020 2020 2020 2020 2027  y..            '
+0000eb70: 736c 6565 7020 3435 272c 0a20 2020 2020  sleep 45',.     
+0000eb80: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
+0000eb90: 2073 7461 7475 7320 7b6e 616d 657d 202d   status {name} -
+0000eba0: 2d72 6566 7265 7368 293b 2065 6368 6f20  -refresh); echo 
+0000ebb0: 2224 7322 3b20 6563 686f 3b20 6563 686f  "$s"; echo; echo
+0000ebc0: 3b20 6563 686f 2022 2473 2220 207c 2067  ; echo "$s"  | g
+0000ebd0: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
+0000ebe0: 7020 5550 272c 0a0a 2020 2020 2020 2020  p UP',..        
+0000ebf0: 2020 2020 2320 456e 7375 7265 2074 6865      # Ensure the
+0000ec00: 2063 6c75 7374 6572 2069 7320 5354 4f50   cluster is STOP
+0000ec10: 5045 442e 0a20 2020 2020 2020 2020 2020  PED..           
+0000ec20: 2027 736c 6565 7020 3235 3027 2c0a 2020   'sleep 250',.  
+0000ec30: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
+0000ec40: 736b 7920 7374 6174 7573 207b 6e61 6d65  sky status {name
+0000ec50: 7d20 2d2d 7265 6672 6573 6829 3b20 6563  } --refresh); ec
+0000ec60: 686f 2022 2473 223b 2065 6368 6f3b 2065  ho "$s"; echo; e
+0000ec70: 6368 6f3b 2065 6368 6f20 2224 7322 2020  cho; echo "$s"  
+0000ec80: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
+0000ec90: 6772 6570 2053 544f 5050 4544 272c 0a0a  grep STOPPED',..
+0000eca0: 2020 2020 2020 2020 2020 2020 2320 456e              # En
+0000ecb0: 7375 7265 2074 6865 2063 6c75 7374 6572  sure the cluster
+0000ecc0: 2069 7320 5550 2061 6e64 2074 6865 2061   is UP and the a
+0000ecd0: 7574 6f73 746f 7020 7365 7474 696e 6720  utostop setting 
+0000ece0: 6973 2072 6573 6574 2028 272d 2729 2e0a  is reset ('-')..
+0000ecf0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000ed00: 7920 7374 6172 7420 2d79 207b 6e61 6d65  y start -y {name
+0000ed10: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
+0000ed20: 6627 736b 7920 7374 6174 7573 207c 2067  f'sky status | g
+0000ed30: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
+0000ed40: 7020 2d45 2022 5550 5c73 2b2d 2227 2c0a  p -E "UP\s+-"',.
+0000ed50: 0a20 2020 2020 2020 2020 2020 2023 2045  .            # E
+0000ed60: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
+0000ed70: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
+0000ed80: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
+0000ed90: 7b6e 616d 657d 2074 6573 7473 2f74 6573  {name} tests/tes
+0000eda0: 745f 7961 6d6c 732f 6d69 6e69 6d61 6c2e  t_yamls/minimal.
+0000edb0: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+0000edc0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+0000edd0: 616d 657d 2032 202d 2d73 7461 7475 7327  ame} 2 --status'
+0000ede0: 2c0a 0a20 2020 2020 2020 2020 2020 2023  ,..            #
+0000edf0: 2054 6573 7420 7265 7374 6172 7469 6e67   Test restarting
+0000ee00: 2074 6865 2069 646c 656e 6573 7320 7469   the idleness ti
+0000ee10: 6d65 7220 7669 6120 6361 6e63 656c 202b  mer via cancel +
+0000ee20: 2072 6573 6574 3a0a 2020 2020 2020 2020   reset:.        
+0000ee30: 2020 2020 6627 736b 7920 6175 746f 7374      f'sky autost
+0000ee40: 6f70 202d 7920 7b6e 616d 657d 202d 6920  op -y {name} -i 
+0000ee50: 3127 2c20 2023 2049 646c 656e 6573 7320  1',  # Idleness 
+0000ee60: 7374 6172 7473 2063 6f75 6e74 696e 672e  starts counting.
+0000ee70: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+0000ee80: 6565 7020 3435 272c 2020 2320 416c 6d6f  eep 45',  # Almo
+0000ee90: 7374 2072 6561 6368 6564 2074 6865 2074  st reached the t
+0000eea0: 6872 6573 686f 6c64 2e0a 2020 2020 2020  hreshold..      
+0000eeb0: 2020 2020 2020 6627 736b 7920 6175 746f        f'sky auto
+0000eec0: 7374 6f70 202d 7920 7b6e 616d 657d 202d  stop -y {name} -
+0000eed0: 2d63 616e 6365 6c27 2c0a 2020 2020 2020  -cancel',.      
+0000eee0: 2020 2020 2020 6627 736b 7920 6175 746f        f'sky auto
+0000eef0: 7374 6f70 202d 7920 7b6e 616d 657d 202d  stop -y {name} -
+0000ef00: 6920 3127 2c20 2023 2053 686f 756c 6420  i 1',  # Should 
+0000ef10: 7265 7374 6172 7420 7468 6520 7469 6d65  restart the time
+0000ef20: 722e 0a20 2020 2020 2020 2020 2020 2027  r..            '
+0000ef30: 736c 6565 7020 3435 272c 0a20 2020 2020  sleep 45',.     
+0000ef40: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
+0000ef50: 2073 7461 7475 7320 7b6e 616d 657d 202d   status {name} -
+0000ef60: 2d72 6566 7265 7368 293b 2065 6368 6f20  -refresh); echo 
+0000ef70: 2224 7322 3b20 6563 686f 3b20 6563 686f  "$s"; echo; echo
+0000ef80: 3b20 6563 686f 2022 2473 2220 7c20 6772  ; echo "$s" | gr
+0000ef90: 6570 207b 6e61 6d65 7d20 7c20 6772 6570  ep {name} | grep
+0000efa0: 2055 5027 2c0a 2020 2020 2020 2020 2020   UP',.          
+0000efb0: 2020 2773 6c65 6570 2032 3530 272c 0a20    'sleep 250',. 
+0000efc0: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
+0000efd0: 2873 6b79 2073 7461 7475 7320 7b6e 616d  (sky status {nam
+0000efe0: 657d 202d 2d72 6566 7265 7368 293b 2065  e} --refresh); e
+0000eff0: 6368 6f20 2224 7322 3b20 6563 686f 3b20  cho "$s"; echo; 
+0000f000: 6563 686f 3b20 6563 686f 2022 2473 2220  echo; echo "$s" 
+0000f010: 207c 2067 7265 7020 7b6e 616d 657d 207c   | grep {name} |
+0000f020: 2067 7265 7020 5354 4f50 5045 4427 2c0a   grep STOPPED',.
+0000f030: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
+0000f040: 6573 7420 7265 7374 6172 7469 6e67 2074  est restarting t
+0000f050: 6865 2069 646c 656e 6573 7320 7469 6d65  he idleness time
+0000f060: 7220 7669 6120 6578 6563 3a0a 2020 2020  r via exec:.    
+0000f070: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
+0000f080: 6172 7420 2d79 207b 6e61 6d65 7d27 2c0a  art -y {name}',.
+0000f090: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000f0a0: 7920 7374 6174 7573 207c 2067 7265 7020  y status | grep 
+0000f0b0: 7b6e 616d 657d 207c 2067 7265 7020 2d45  {name} | grep -E
+0000f0c0: 2022 5550 5c73 2b2d 2227 2c0a 2020 2020   "UP\s+-"',.    
+0000f0d0: 2020 2020 2020 2020 6627 736b 7920 6175          f'sky au
+0000f0e0: 746f 7374 6f70 202d 7920 7b6e 616d 657d  tostop -y {name}
+0000f0f0: 202d 6920 3127 2c20 2023 2049 646c 656e   -i 1',  # Idlen
+0000f100: 6573 7320 7374 6172 7473 2063 6f75 6e74  ess starts count
+0000f110: 696e 672e 0a20 2020 2020 2020 2020 2020  ing..           
+0000f120: 2027 736c 6565 7020 3435 272c 2020 2320   'sleep 45',  # 
+0000f130: 416c 6d6f 7374 2072 6561 6368 6564 2074  Almost reached t
+0000f140: 6865 2074 6872 6573 686f 6c64 2e0a 2020  he threshold..  
+0000f150: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000f160: 6578 6563 207b 6e61 6d65 7d20 6563 686f  exec {name} echo
+0000f170: 2068 6927 2c20 2023 2053 686f 756c 6420   hi',  # Should 
+0000f180: 7265 7374 6172 7420 7468 6520 7469 6d65  restart the time
+0000f190: 722e 0a20 2020 2020 2020 2020 2020 2027  r..            '
+0000f1a0: 736c 6565 7020 3435 272c 0a20 2020 2020  sleep 45',.     
+0000f1b0: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
+0000f1c0: 2073 7461 7475 7320 7b6e 616d 657d 202d   status {name} -
+0000f1d0: 2d72 6566 7265 7368 293b 2065 6368 6f20  -refresh); echo 
+0000f1e0: 2224 7322 3b20 6563 686f 3b20 6563 686f  "$s"; echo; echo
+0000f1f0: 3b20 6563 686f 2022 2473 2220 207c 2067  ; echo "$s"  | g
+0000f200: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
+0000f210: 7020 5550 272c 0a20 2020 2020 2020 2020  p UP',.         
+0000f220: 2020 2027 736c 6565 7020 3235 3027 2c0a     'sleep 250',.
+0000f230: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
+0000f240: 2428 736b 7920 7374 6174 7573 207b 6e61  $(sky status {na
+0000f250: 6d65 7d20 2d2d 7265 6672 6573 6829 3b20  me} --refresh); 
+0000f260: 6563 686f 2022 2473 223b 2065 6368 6f3b  echo "$s"; echo;
+0000f270: 2065 6368 6f3b 2065 6368 6f20 2224 7322   echo; echo "$s"
+0000f280: 2020 7c20 6772 6570 207b 6e61 6d65 7d20    | grep {name} 
+0000f290: 7c20 6772 6570 2053 544f 5050 4544 272c  | grep STOPPED',
+0000f2a0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+0000f2b0: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
+0000f2c0: 7920 7b6e 616d 657d 272c 0a20 2020 2020  y {name}',.     
+0000f2d0: 2020 2074 696d 656f 7574 3d32 3020 2a20     timeout=20 * 
+0000f2e0: 3630 2c0a 2020 2020 290a 2020 2020 7275  60,.    ).    ru
+0000f2f0: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+0000f300: 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20  ...# ---------- 
+0000f310: 5465 7374 696e 6720 4175 746f 646f 776e  Testing Autodown
+0000f320: 696e 6720 2d2d 2d2d 2d2d 2d2d 2d2d 0a40  ing ----------.@
+0000f330: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f73  pytest.mark.no_s
+0000f340: 6370 2020 2320 5343 5020 646f 6573 206e  cp  # SCP does n
+0000f350: 6f74 2073 7570 706f 7274 206e 756d 5f6e  ot support num_n
+0000f360: 6f64 6573 203e 2031 2079 6574 2e20 5275  odes > 1 yet. Ru
+0000f370: 6e20 7465 7374 5f73 6370 5f61 7574 6f64  n test_scp_autod
+0000f380: 6f77 6e20 696e 7374 6561 642e 0a40 7079  own instead..@py
+0000f390: 7465 7374 2e6d 6172 6b2e 6e6f 5f6b 7562  test.mark.no_kub
+0000f3a0: 6572 6e65 7465 7320 2023 204b 7562 6572  ernetes  # Kuber
+0000f3b0: 6e65 7465 7320 646f 6573 206e 6f74 2073  netes does not s
+0000f3c0: 7570 706f 7274 206e 756d 5f6e 6f64 6573  upport num_nodes
+0000f3d0: 203e 2031 2079 6574 2e20 5275 6e20 7465   > 1 yet. Run te
+0000f3e0: 7374 5f73 6370 5f6b 7562 6572 6e65 7465  st_scp_kubernete
+0000f3f0: 7320 696e 7374 6561 642e 0a64 6566 2074  s instead..def t
+0000f400: 6573 745f 6175 746f 646f 776e 2867 656e  est_autodown(gen
+0000f410: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
+0000f420: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
+0000f430: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+0000f440: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+0000f450: 280a 2020 2020 2020 2020 2761 7574 6f64  (.        'autod
+0000f460: 6f77 6e27 2c0a 2020 2020 2020 2020 5b0a  own',.        [.
+0000f470: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000f480: 7920 6c61 756e 6368 202d 7920 2d64 202d  y launch -y -d -
+0000f490: 6320 7b6e 616d 657d 202d 2d6e 756d 2d6e  c {name} --num-n
+0000f4a0: 6f64 6573 2032 202d 2d63 6c6f 7564 207b  odes 2 --cloud {
+0000f4b0: 6765 6e65 7269 635f 636c 6f75 647d 2074  generic_cloud} t
+0000f4c0: 6573 7473 2f74 6573 745f 7961 6d6c 732f  ests/test_yamls/
+0000f4d0: 6d69 6e69 6d61 6c2e 7961 6d6c 272c 0a20  minimal.yaml',. 
+0000f4e0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000f4f0: 2061 7574 6f73 746f 7020 2d79 207b 6e61   autostop -y {na
+0000f500: 6d65 7d20 2d2d 646f 776e 202d 6920 3127  me} --down -i 1'
+0000f510: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+0000f520: 456e 7375 7265 2061 7574 6f73 746f 7020  Ensure autostop 
+0000f530: 6973 2073 6574 2e0a 2020 2020 2020 2020  is set..        
+0000f540: 2020 2020 6627 736b 7920 7374 6174 7573      f'sky status
+0000f550: 207c 2067 7265 7020 7b6e 616d 657d 207c   | grep {name} |
+0000f560: 2067 7265 7020 2231 6d20 2864 6f77 6e29   grep "1m (down)
+0000f570: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+0000f580: 2320 456e 7375 7265 2074 6865 2063 6c75  # Ensure the clu
+0000f590: 7374 6572 2069 7320 6e6f 7420 7465 726d  ster is not term
+0000f5a0: 696e 6174 6564 2065 6172 6c79 2e0a 2020  inated early..  
+0000f5b0: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+0000f5c0: 2034 3527 2c0a 2020 2020 2020 2020 2020   45',.          
+0000f5d0: 2020 6627 733d 2428 736b 7920 7374 6174    f's=$(sky stat
+0000f5e0: 7573 207b 6e61 6d65 7d20 2d2d 7265 6672  us {name} --refr
+0000f5f0: 6573 6829 3b20 6563 686f 2022 2473 223b  esh); echo "$s";
+0000f600: 2065 6368 6f3b 2065 6368 6f3b 2065 6368   echo; echo; ech
+0000f610: 6f20 2224 7322 2020 7c20 6772 6570 207b  o "$s"  | grep {
+0000f620: 6e61 6d65 7d20 7c20 6772 6570 2055 5027  name} | grep UP'
+0000f630: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+0000f640: 456e 7375 7265 2074 6865 2063 6c75 7374  Ensure the clust
+0000f650: 6572 2069 7320 7465 726d 696e 6174 6564  er is terminated
+0000f660: 2e0a 2020 2020 2020 2020 2020 2020 2773  ..            's
+0000f670: 6c65 6570 2032 3030 272c 0a20 2020 2020  leep 200',.     
+0000f680: 2020 2020 2020 2066 2773 3d24 2853 4b59         f's=$(SKY
+0000f690: 5049 4c4f 545f 4445 4255 473d 3020 736b  PILOT_DEBUG=0 sk
+0000f6a0: 7920 7374 6174 7573 207b 6e61 6d65 7d20  y status {name} 
+0000f6b0: 2d2d 7265 6672 6573 6829 2026 2620 6563  --refresh) && ec
+0000f6c0: 686f 2022 2473 2220 2626 207b 7b20 6563  ho "$s" && {{ ec
+0000f6d0: 686f 2022 2473 2220 7c20 6772 6570 207b  ho "$s" | grep {
+0000f6e0: 6e61 6d65 7d20 7c20 6772 6570 2022 4175  name} | grep "Au
+0000f6f0: 746f 646f 776e 6564 2063 6c75 7374 6572  todowned cluster
+0000f700: 5c7c 7465 726d 696e 6174 6564 206f 6e20  \|terminated on 
+0000f710: 7468 6520 636c 6f75 6422 3b20 7d7d 207c  the cloud"; }} |
+0000f720: 7c20 7b7b 2065 6368 6f20 2224 7322 207c  | {{ echo "$s" |
+0000f730: 2067 7265 7020 7b6e 616d 657d 2026 2620   grep {name} && 
+0000f740: 6578 6974 2031 207c 7c20 6578 6974 2030  exit 1 || exit 0
+0000f750: 3b20 7d7d 272c 0a20 2020 2020 2020 2020  ; }}',.         
+0000f760: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+0000f770: 2d79 202d 6420 2d63 207b 6e61 6d65 7d20  -y -d -c {name} 
+0000f780: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
+0000f790: 5f63 6c6f 7564 7d20 2d2d 6e75 6d2d 6e6f  _cloud} --num-no
+0000f7a0: 6465 7320 3220 2d2d 646f 776e 2074 6573  des 2 --down tes
+0000f7b0: 7473 2f74 6573 745f 7961 6d6c 732f 6d69  ts/test_yamls/mi
+0000f7c0: 6e69 6d61 6c2e 7961 6d6c 272c 0a20 2020  nimal.yaml',.   
+0000f7d0: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
+0000f7e0: 7461 7475 7320 7c20 6772 6570 207b 6e61  tatus | grep {na
+0000f7f0: 6d65 7d20 7c20 6772 6570 2055 5027 2c20  me} | grep UP', 
+0000f800: 2023 2045 6e73 7572 6520 7468 6520 636c   # Ensure the cl
+0000f810: 7573 7465 7220 6973 2055 502e 0a20 2020  uster is UP..   
+0000f820: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
+0000f830: 7865 6320 7b6e 616d 657d 202d 2d63 6c6f  xec {name} --clo
+0000f840: 7564 207b 6765 6e65 7269 635f 636c 6f75  ud {generic_clou
+0000f850: 647d 2074 6573 7473 2f74 6573 745f 7961  d} tests/test_ya
+0000f860: 6d6c 732f 6d69 6e69 6d61 6c2e 7961 6d6c  mls/minimal.yaml
+0000f870: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000f880: 2773 6b79 2073 7461 7475 7320 7c20 6772  'sky status | gr
+0000f890: 6570 207b 6e61 6d65 7d20 7c20 6772 6570  ep {name} | grep
+0000f8a0: 2022 316d 2028 646f 776e 2922 272c 0a20   "1m (down)"',. 
+0000f8b0: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+0000f8c0: 7020 3234 3027 2c0a 2020 2020 2020 2020  p 240',.        
+0000f8d0: 2020 2020 2320 456e 7375 7265 2074 6865      # Ensure the
+0000f8e0: 2063 6c75 7374 6572 2069 7320 7465 726d   cluster is term
+0000f8f0: 696e 6174 6564 2e0a 2020 2020 2020 2020  inated..        
+0000f900: 2020 2020 6627 733d 2428 534b 5950 494c      f's=$(SKYPIL
+0000f910: 4f54 5f44 4542 5547 3d30 2073 6b79 2073  OT_DEBUG=0 sky s
+0000f920: 7461 7475 7320 7b6e 616d 657d 202d 2d72  tatus {name} --r
+0000f930: 6566 7265 7368 2920 2626 2065 6368 6f20  efresh) && echo 
+0000f940: 2224 7322 2026 2620 7b7b 2065 6368 6f20  "$s" && {{ echo 
+0000f950: 2224 7322 207c 2067 7265 7020 7b6e 616d  "$s" | grep {nam
+0000f960: 657d 207c 2067 7265 7020 2241 7574 6f64  e} | grep "Autod
+0000f970: 6f77 6e65 6420 636c 7573 7465 725c 7c74  owned cluster\|t
+0000f980: 6572 6d69 6e61 7465 6420 6f6e 2074 6865  erminated on the
+0000f990: 2063 6c6f 7564 223b 207d 7d20 7c7c 207b   cloud"; }} || {
+0000f9a0: 7b20 6563 686f 2022 2473 2220 7c20 6772  { echo "$s" | gr
+0000f9b0: 6570 207b 6e61 6d65 7d20 2626 2065 7869  ep {name} && exi
+0000f9c0: 7420 3120 7c7c 2065 7869 7420 303b 207d  t 1 || exit 0; }
+0000f9d0: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
+0000f9e0: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
+0000f9f0: 2d64 202d 6320 7b6e 616d 657d 202d 2d63  -d -c {name} --c
+0000fa00: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
+0000fa10: 6f75 647d 202d 2d6e 756d 2d6e 6f64 6573  oud} --num-nodes
+0000fa20: 2032 202d 2d64 6f77 6e20 7465 7374 732f   2 --down tests/
+0000fa30: 7465 7374 5f79 616d 6c73 2f6d 696e 696d  test_yamls/minim
+0000fa40: 616c 2e79 616d 6c27 2c0a 2020 2020 2020  al.yaml',.      
+0000fa50: 2020 2020 2020 6627 736b 7920 6175 746f        f'sky auto
+0000fa60: 7374 6f70 202d 7920 7b6e 616d 657d 202d  stop -y {name} -
+0000fa70: 2d63 616e 6365 6c27 2c0a 2020 2020 2020  -cancel',.      
+0000fa80: 2020 2020 2020 2773 6c65 6570 2032 3430        'sleep 240
+0000fa90: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
+0000faa0: 2045 6e73 7572 6520 7468 6520 636c 7573   Ensure the clus
+0000fab0: 7465 7220 6973 2073 7469 6c6c 2055 502e  ter is still UP.
+0000fac0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000fad0: 3d24 2853 4b59 5049 4c4f 545f 4445 4255  =$(SKYPILOT_DEBU
+0000fae0: 473d 3020 736b 7920 7374 6174 7573 207b  G=0 sky status {
+0000faf0: 6e61 6d65 7d20 2d2d 7265 6672 6573 6829  name} --refresh)
+0000fb00: 2026 2620 6563 686f 2022 2473 2220 2626   && echo "$s" &&
+0000fb10: 2065 6368 6f20 2224 7322 207c 2067 7265   echo "$s" | gre
+0000fb20: 7020 7b6e 616d 657d 207c 2067 7265 7020  p {name} | grep 
+0000fb30: 5550 272c 0a20 2020 2020 2020 205d 2c0a  UP',.        ],.
+0000fb40: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
+0000fb50: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
+0000fb60: 2020 2020 2020 2074 696d 656f 7574 3d32         timeout=2
+0000fb70: 3020 2a20 3630 2c0a 2020 2020 290a 2020  0 * 60,.    ).  
+0000fb80: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+0000fb90: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+0000fba0: 6172 6b2e 7363 700a 6465 6620 7465 7374  ark.scp.def test
+0000fbb0: 5f73 6370 5f61 7574 6f64 6f77 6e28 293a  _scp_autodown():
+0000fbc0: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+0000fbd0: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+0000fbe0: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+0000fbf0: 0a20 2020 2020 2020 2027 5343 505f 6175  .        'SCP_au
+0000fc00: 746f 646f 776e 272c 0a20 2020 2020 2020  todown',.       
+0000fc10: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+0000fc20: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
+0000fc30: 6420 2d63 207b 6e61 6d65 7d20 7b53 4350  d -c {name} {SCP
+0000fc40: 5f54 5950 457d 2074 6573 7473 2f74 6573  _TYPE} tests/tes
+0000fc50: 745f 7961 6d6c 732f 6d69 6e69 6d61 6c2e  t_yamls/minimal.
+0000fc60: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+0000fc70: 2020 2066 2773 6b79 2061 7574 6f73 746f     f'sky autosto
+0000fc80: 7020 2d79 207b 6e61 6d65 7d20 2d2d 646f  p -y {name} --do
+0000fc90: 776e 202d 6920 3127 2c0a 2020 2020 2020  wn -i 1',.      
+0000fca0: 2020 2020 2020 2320 456e 7375 7265 2061        # Ensure a
+0000fcb0: 7574 6f73 746f 7020 6973 2073 6574 2e0a  utostop is set..
+0000fcc0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000fcd0: 7920 7374 6174 7573 207c 2067 7265 7020  y status | grep 
+0000fce0: 7b6e 616d 657d 207c 2067 7265 7020 2231  {name} | grep "1
+0000fcf0: 6d20 2864 6f77 6e29 2227 2c0a 2020 2020  m (down)"',.    
+0000fd00: 2020 2020 2020 2020 2320 456e 7375 7265          # Ensure
+0000fd10: 2074 6865 2063 6c75 7374 6572 2069 7320   the cluster is 
+0000fd20: 6e6f 7420 7465 726d 696e 6174 6564 2065  not terminated e
+0000fd30: 6172 6c79 2e0a 2020 2020 2020 2020 2020  arly..          
+0000fd40: 2020 2773 6c65 6570 2034 3527 2c0a 2020    'sleep 45',.  
+0000fd50: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000fd60: 7374 6174 7573 202d 2d72 6566 7265 7368  status --refresh
+0000fd70: 207c 2067 7265 7020 7b6e 616d 657d 207c   | grep {name} |
+0000fd80: 2067 7265 7020 5550 272c 0a20 2020 2020   grep UP',.     
+0000fd90: 2020 2020 2020 2023 2045 6e73 7572 6520         # Ensure 
+0000fda0: 7468 6520 636c 7573 7465 7220 6973 2074  the cluster is t
+0000fdb0: 6572 6d69 6e61 7465 642e 0a20 2020 2020  erminated..     
+0000fdc0: 2020 2020 2020 2027 736c 6565 7020 3230         'sleep 20
+0000fdd0: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
+0000fde0: 6627 733d 2428 534b 5950 494c 4f54 5f44  f's=$(SKYPILOT_D
+0000fdf0: 4542 5547 3d30 2073 6b79 2073 7461 7475  EBUG=0 sky statu
+0000fe00: 7320 2d2d 7265 6672 6573 6829 2026 2620  s --refresh) && 
+0000fe10: 7072 696e 7466 2022 2473 2220 2626 207b  printf "$s" && {
+0000fe20: 7b20 6563 686f 2022 2473 2220 7c20 6772  { echo "$s" | gr
+0000fe30: 6570 207b 6e61 6d65 7d20 7c20 6772 6570  ep {name} | grep
+0000fe40: 2022 4175 746f 646f 776e 6564 2063 6c75   "Autodowned clu
+0000fe50: 7374 6572 5c7c 7465 726d 696e 6174 6564  ster\|terminated
+0000fe60: 206f 6e20 7468 6520 636c 6f75 6422 3b20   on the cloud"; 
+0000fe70: 7d7d 207c 7c20 7b7b 2065 6368 6f20 2224  }} || {{ echo "$
+0000fe80: 7322 207c 2067 7265 7020 7b6e 616d 657d  s" | grep {name}
+0000fe90: 2026 2620 6578 6974 2031 207c 7c20 6578   && exit 1 || ex
+0000fea0: 6974 2030 3b20 7d7d 272c 0a20 2020 2020  it 0; }}',.     
+0000feb0: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
+0000fec0: 6e63 6820 2d79 202d 6420 2d63 207b 6e61  nch -y -d -c {na
+0000fed0: 6d65 7d20 7b53 4350 5f54 5950 457d 202d  me} {SCP_TYPE} -
+0000fee0: 2d64 6f77 6e20 7465 7374 732f 7465 7374  -down tests/test
+0000fef0: 5f79 616d 6c73 2f6d 696e 696d 616c 2e79  _yamls/minimal.y
+0000ff00: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+0000ff10: 2020 6627 736b 7920 7374 6174 7573 207c    f'sky status |
+0000ff20: 2067 7265 7020 7b6e 616d 657d 207c 2067   grep {name} | g
+0000ff30: 7265 7020 5550 272c 2020 2320 456e 7375  rep UP',  # Ensu
+0000ff40: 7265 2074 6865 2063 6c75 7374 6572 2069  re the cluster i
+0000ff50: 7320 5550 2e0a 2020 2020 2020 2020 2020  s UP..          
+0000ff60: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
+0000ff70: 6d65 7d20 7b53 4350 5f54 5950 457d 2074  me} {SCP_TYPE} t
+0000ff80: 6573 7473 2f74 6573 745f 7961 6d6c 732f  ests/test_yamls/
+0000ff90: 6d69 6e69 6d61 6c2e 7961 6d6c 272c 0a20  minimal.yaml',. 
+0000ffa0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000ffb0: 2073 7461 7475 7320 7c20 6772 6570 207b   status | grep {
+0000ffc0: 6e61 6d65 7d20 7c20 6772 6570 2022 316d  name} | grep "1m
+0000ffd0: 2028 646f 776e 2922 272c 0a20 2020 2020   (down)"',.     
+0000ffe0: 2020 2020 2020 2027 736c 6565 7020 3230         'sleep 20
+0000fff0: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
+00010000: 2320 456e 7375 7265 2074 6865 2063 6c75  # Ensure the clu
+00010010: 7374 6572 2069 7320 7465 726d 696e 6174  ster is terminat
+00010020: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
+00010030: 6627 733d 2428 534b 5950 494c 4f54 5f44  f's=$(SKYPILOT_D
+00010040: 4542 5547 3d30 2073 6b79 2073 7461 7475  EBUG=0 sky statu
+00010050: 7320 2d2d 7265 6672 6573 6829 2026 2620  s --refresh) && 
+00010060: 7072 696e 7466 2022 2473 2220 2626 207b  printf "$s" && {
+00010070: 7b20 6563 686f 2022 2473 2220 7c20 6772  { echo "$s" | gr
+00010080: 6570 207b 6e61 6d65 7d20 7c20 6772 6570  ep {name} | grep
+00010090: 2022 4175 746f 646f 776e 6564 2063 6c75   "Autodowned clu
+000100a0: 7374 6572 5c7c 7465 726d 696e 6174 6564  ster\|terminated
+000100b0: 206f 6e20 7468 6520 636c 6f75 6422 3b20   on the cloud"; 
+000100c0: 7d7d 207c 7c20 7b7b 2065 6368 6f20 2224  }} || {{ echo "$
+000100d0: 7322 207c 2067 7265 7020 7b6e 616d 657d  s" | grep {name}
+000100e0: 2026 2620 6578 6974 2031 207c 7c20 6578   && exit 1 || ex
+000100f0: 6974 2030 3b20 7d7d 272c 0a20 2020 2020  it 0; }}',.     
+00010100: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
+00010110: 6e63 6820 2d79 202d 6420 2d63 207b 6e61  nch -y -d -c {na
+00010120: 6d65 7d20 7b53 4350 5f54 5950 457d 202d  me} {SCP_TYPE} -
+00010130: 2d64 6f77 6e20 7465 7374 732f 7465 7374  -down tests/test
+00010140: 5f79 616d 6c73 2f6d 696e 696d 616c 2e79  _yamls/minimal.y
+00010150: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+00010160: 2020 6627 736b 7920 6175 746f 7374 6f70    f'sky autostop
+00010170: 202d 7920 7b6e 616d 657d 202d 2d63 616e   -y {name} --can
+00010180: 6365 6c27 2c0a 2020 2020 2020 2020 2020  cel',.          
+00010190: 2020 2773 6c65 6570 2032 3030 272c 0a20    'sleep 200',. 
+000101a0: 2020 2020 2020 2020 2020 2023 2045 6e73             # Ens
+000101b0: 7572 6520 7468 6520 636c 7573 7465 7220  ure the cluster 
+000101c0: 6973 2073 7469 6c6c 2055 502e 0a20 2020  is still UP..   
+000101d0: 2020 2020 2020 2020 2066 2773 3d24 2853           f's=$(S
+000101e0: 4b59 5049 4c4f 545f 4445 4255 473d 3020  KYPILOT_DEBUG=0 
+000101f0: 736b 7920 7374 6174 7573 202d 2d72 6566  sky status --ref
+00010200: 7265 7368 2920 2626 2070 7269 6e74 6620  resh) && printf 
+00010210: 2224 7322 2026 2620 6563 686f 2022 2473  "$s" && echo "$s
+00010220: 2220 7c20 6772 6570 207b 6e61 6d65 7d20  " | grep {name} 
+00010230: 7c20 6772 6570 2055 5027 2c0a 2020 2020  | grep UP',.    
+00010240: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+00010250: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+00010260: 6d65 7d27 2c0a 2020 2020 2020 2020 7469  me}',.        ti
+00010270: 6d65 6f75 743d 3235 202a 2036 302c 0a20  meout=25 * 60,. 
+00010280: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+00010290: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
+000102a0: 7974 6573 742e 6d61 726b 2e6b 7562 6572  ytest.mark.kuber
+000102b0: 6e65 7465 730a 6465 6620 7465 7374 5f6b  netes.def test_k
+000102c0: 7562 6572 6e65 7465 735f 6175 746f 646f  ubernetes_autodo
+000102d0: 776e 2829 3a0a 2020 2020 6e61 6d65 203d  wn():.    name =
+000102e0: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+000102f0: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
+00010300: 5465 7374 280a 2020 2020 2020 2020 276b  Test(.        'k
+00010310: 7562 6572 6e65 7465 735f 6175 746f 646f  ubernetes_autodo
+00010320: 776e 272c 0a20 2020 2020 2020 205b 0a20  wn',.        [. 
+00010330: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00010340: 206c 6175 6e63 6820 2d79 202d 6420 2d63   launch -y -d -c
+00010350: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+00010360: 6b75 6265 726e 6574 6573 2074 6573 7473  kubernetes tests
+00010370: 2f74 6573 745f 7961 6d6c 732f 6d69 6e69  /test_yamls/mini
+00010380: 6d61 6c2e 7961 6d6c 272c 0a20 2020 2020  mal.yaml',.     
+00010390: 2020 2020 2020 2066 2773 6b79 2061 7574         f'sky aut
+000103a0: 6f73 746f 7020 2d79 207b 6e61 6d65 7d20  ostop -y {name} 
+000103b0: 2d2d 646f 776e 202d 6920 3127 2c0a 2020  --down -i 1',.  
+000103c0: 2020 2020 2020 2020 2020 2320 456e 7375            # Ensu
+000103d0: 7265 2061 7574 6f73 746f 7020 6973 2073  re autostop is s
+000103e0: 6574 2e0a 2020 2020 2020 2020 2020 2020  et..            
+000103f0: 6627 736b 7920 7374 6174 7573 207c 2067  f'sky status | g
+00010400: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
+00010410: 7020 2231 6d20 2864 6f77 6e29 2227 2c0a  p "1m (down)"',.
+00010420: 2020 2020 2020 2020 2020 2020 2320 456e              # En
+00010430: 7375 7265 2074 6865 2063 6c75 7374 6572  sure the cluster
+00010440: 2069 7320 6e6f 7420 7465 726d 696e 6174   is not terminat
+00010450: 6564 2065 6172 6c79 2e0a 2020 2020 2020  ed early..      
+00010460: 2020 2020 2020 2773 6c65 6570 2034 3527        'sleep 45'
+00010470: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00010480: 736b 7920 7374 6174 7573 202d 2d72 6566  sky status --ref
+00010490: 7265 7368 207c 2067 7265 7020 7b6e 616d  resh | grep {nam
+000104a0: 657d 207c 2067 7265 7020 5550 272c 0a20  e} | grep UP',. 
+000104b0: 2020 2020 2020 2020 2020 2023 2045 6e73             # Ens
+000104c0: 7572 6520 7468 6520 636c 7573 7465 7220  ure the cluster 
+000104d0: 6973 2074 6572 6d69 6e61 7465 642e 0a20  is terminated.. 
+000104e0: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+000104f0: 7020 3230 3027 2c0a 2020 2020 2020 2020  p 200',.        
+00010500: 2020 2020 6627 733d 2428 534b 5950 494c      f's=$(SKYPIL
+00010510: 4f54 5f44 4542 5547 3d30 2073 6b79 2073  OT_DEBUG=0 sky s
+00010520: 7461 7475 7320 2d2d 7265 6672 6573 6829  tatus --refresh)
+00010530: 2026 2620 7072 696e 7466 2022 2473 2220   && printf "$s" 
+00010540: 2626 207b 7b20 6563 686f 2022 2473 2220  && {{ echo "$s" 
+00010550: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
+00010560: 6772 6570 2022 4175 746f 646f 776e 6564  grep "Autodowned
+00010570: 2063 6c75 7374 6572 5c7c 7465 726d 696e   cluster\|termin
+00010580: 6174 6564 206f 6e20 7468 6520 636c 6f75  ated on the clou
+00010590: 6422 3b20 7d7d 207c 7c20 7b7b 2065 6368  d"; }} || {{ ech
+000105a0: 6f20 2224 7322 207c 2067 7265 7020 7b6e  o "$s" | grep {n
+000105b0: 616d 657d 2026 2620 6578 6974 2031 207c  ame} && exit 1 |
+000105c0: 7c20 6578 6974 2030 3b20 7d7d 272c 0a20  | exit 0; }}',. 
+000105d0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000105e0: 206c 6175 6e63 6820 2d79 202d 6420 2d63   launch -y -d -c
+000105f0: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+00010600: 6b75 6265 726e 6574 6573 202d 2d64 6f77  kubernetes --dow
+00010610: 6e20 7465 7374 732f 7465 7374 5f79 616d  n tests/test_yam
+00010620: 6c73 2f6d 696e 696d 616c 2e79 616d 6c27  ls/minimal.yaml'
+00010630: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00010640: 736b 7920 7374 6174 7573 207c 2067 7265  sky status | gre
+00010650: 7020 7b6e 616d 657d 207c 2067 7265 7020  p {name} | grep 
+00010660: 5550 272c 2020 2320 456e 7375 7265 2074  UP',  # Ensure t
+00010670: 6865 2063 6c75 7374 6572 2069 7320 5550  he cluster is UP
+00010680: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+00010690: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
+000106a0: 2d2d 636c 6f75 6420 6b75 6265 726e 6574  --cloud kubernet
+000106b0: 6573 2074 6573 7473 2f74 6573 745f 7961  es tests/test_ya
+000106c0: 6d6c 732f 6d69 6e69 6d61 6c2e 7961 6d6c  mls/minimal.yaml
+000106d0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000106e0: 2773 6b79 2073 7461 7475 7320 7c20 6772  'sky status | gr
+000106f0: 6570 207b 6e61 6d65 7d20 7c20 6772 6570  ep {name} | grep
+00010700: 2022 316d 2028 646f 776e 2922 272c 0a20   "1m (down)"',. 
+00010710: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+00010720: 7020 3230 3027 2c0a 2020 2020 2020 2020  p 200',.        
+00010730: 2020 2020 2320 456e 7375 7265 2074 6865      # Ensure the
+00010740: 2063 6c75 7374 6572 2069 7320 7465 726d   cluster is term
+00010750: 696e 6174 6564 2e0a 2020 2020 2020 2020  inated..        
+00010760: 2020 2020 6627 733d 2428 534b 5950 494c      f's=$(SKYPIL
+00010770: 4f54 5f44 4542 5547 3d30 2073 6b79 2073  OT_DEBUG=0 sky s
+00010780: 7461 7475 7320 2d2d 7265 6672 6573 6829  tatus --refresh)
+00010790: 2026 2620 7072 696e 7466 2022 2473 2220   && printf "$s" 
+000107a0: 2626 207b 7b20 6563 686f 2022 2473 2220  && {{ echo "$s" 
+000107b0: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
+000107c0: 6772 6570 2022 4175 746f 646f 776e 6564  grep "Autodowned
+000107d0: 2063 6c75 7374 6572 5c7c 7465 726d 696e   cluster\|termin
+000107e0: 6174 6564 206f 6e20 7468 6520 636c 6f75  ated on the clou
+000107f0: 6422 3b20 7d7d 207c 7c20 7b7b 2065 6368  d"; }} || {{ ech
+00010800: 6f20 2224 7322 207c 2067 7265 7020 7b6e  o "$s" | grep {n
+00010810: 616d 657d 2026 2620 6578 6974 2031 207c  ame} && exit 1 |
+00010820: 7c20 6578 6974 2030 3b20 7d7d 272c 0a20  | exit 0; }}',. 
+00010830: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00010840: 206c 6175 6e63 6820 2d79 202d 6420 2d63   launch -y -d -c
+00010850: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+00010860: 6b75 6265 726e 6574 6573 202d 2d64 6f77  kubernetes --dow
+00010870: 6e20 7465 7374 732f 7465 7374 5f79 616d  n tests/test_yam
+00010880: 6c73 2f6d 696e 696d 616c 2e79 616d 6c27  ls/minimal.yaml'
+00010890: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+000108a0: 736b 7920 6175 746f 7374 6f70 202d 7920  sky autostop -y 
+000108b0: 7b6e 616d 657d 202d 2d63 616e 6365 6c27  {name} --cancel'
+000108c0: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
+000108d0: 6c65 6570 2032 3030 272c 0a20 2020 2020  leep 200',.     
+000108e0: 2020 2020 2020 2023 2045 6e73 7572 6520         # Ensure 
+000108f0: 7468 6520 636c 7573 7465 7220 6973 2073  the cluster is s
+00010900: 7469 6c6c 2055 502e 0a20 2020 2020 2020  till UP..       
+00010910: 2020 2020 2066 2773 3d24 2853 4b59 5049       f's=$(SKYPI
+00010920: 4c4f 545f 4445 4255 473d 3020 736b 7920  LOT_DEBUG=0 sky 
+00010930: 7374 6174 7573 202d 2d72 6566 7265 7368  status --refresh
+00010940: 2920 2626 2070 7269 6e74 6620 2224 7322  ) && printf "$s"
+00010950: 2026 2620 6563 686f 2022 2473 2220 7c20   && echo "$s" | 
+00010960: 6772 6570 207b 6e61 6d65 7d20 7c20 6772  grep {name} | gr
+00010970: 6570 2055 5027 2c0a 2020 2020 2020 2020  ep UP',.        
+00010980: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
+00010990: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
+000109a0: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
+000109b0: 743d 3235 202a 2036 302c 0a20 2020 2029  t=25 * 60,.    )
+000109c0: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+000109d0: 7428 7465 7374 290a 0a0a 6465 6620 5f67  t(test)...def _g
+000109e0: 6574 5f63 616e 6365 6c5f 7461 736b 5f77  et_cancel_task_w
+000109f0: 6974 685f 636c 6f75 6428 6e61 6d65 2c20  ith_cloud(name, 
+00010a00: 636c 6f75 642c 2074 696d 656f 7574 3d31  cloud, timeout=1
+00010a10: 3520 2a20 3630 293a 0a20 2020 2074 6573  5 * 60):.    tes
+00010a20: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+00010a30: 2020 6627 7b63 6c6f 7564 7d2d 6361 6e63    f'{cloud}-canc
+00010a40: 656c 2d74 6173 6b27 2c0a 2020 2020 2020  el-task',.      
+00010a50: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+00010a60: 6627 736b 7920 6c61 756e 6368 202d 6320  f'sky launch -c 
+00010a70: 7b6e 616d 657d 2065 7861 6d70 6c65 732f  {name} examples/
+00010a80: 7265 736e 6574 5f61 7070 2e79 616d 6c20  resnet_app.yaml 
+00010a90: 2d2d 636c 6f75 6420 7b63 6c6f 7564 7d20  --cloud {cloud} 
+00010aa0: 2d79 202d 6427 2c0a 2020 2020 2020 2020  -y -d',.        
+00010ab0: 2020 2020 2320 5761 6974 2074 6865 2047      # Wait the G
+00010ac0: 5055 2070 726f 6365 7373 2074 6f20 7374  PU process to st
+00010ad0: 6172 742e 0a20 2020 2020 2020 2020 2020  art..           
+00010ae0: 2027 736c 6565 7020 3630 272c 0a20 2020   'sleep 60',.   
+00010af0: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
+00010b00: 7865 6320 7b6e 616d 657d 2022 6e76 6964  xec {name} "nvid
+00010b10: 6961 2d73 6d69 207c 2067 7265 7020 7079  ia-smi | grep py
+00010b20: 7468 6f6e 2227 2c0a 2020 2020 2020 2020  thon"',.        
+00010b30: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+00010b40: 6e61 6d65 7d20 3220 2d2d 7374 6174 7573  name} 2 --status
+00010b50: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
+00010b60: 206a 6f62 2073 7563 6365 6564 6564 2e0a   job succeeded..
+00010b70: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00010b80: 7920 6361 6e63 656c 202d 7920 7b6e 616d  y cancel -y {nam
+00010b90: 657d 2031 272c 0a20 2020 2020 2020 2020  e} 1',.         
+00010ba0: 2020 2027 736c 6565 7020 3630 272c 0a20     'sleep 60',. 
+00010bb0: 2020 2020 2020 2020 2020 2023 2063 6865             # che
+00010bc0: 636b 2069 6620 7468 6520 7079 7468 6f6e  ck if the python
+00010bd0: 206a 6f62 2069 7320 676f 6e65 2e0a 2020   job is gone..  
+00010be0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00010bf0: 6578 6563 207b 6e61 6d65 7d20 2221 206e  exec {name} "! n
+00010c00: 7669 6469 612d 736d 6920 7c20 6772 6570  vidia-smi | grep
+00010c10: 2070 7974 686f 6e22 272c 0a20 2020 2020   python"',.     
+00010c20: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+00010c30: 7320 7b6e 616d 657d 2033 202d 2d73 7461  s {name} 3 --sta
+00010c40: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
+00010c50: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
+00010c60: 642e 0a20 2020 2020 2020 205d 2c0a 2020  d..        ],.  
+00010c70: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
+00010c80: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
+00010c90: 2020 2020 2074 696d 656f 7574 3d74 696d       timeout=tim
+00010ca0: 656f 7574 2c0a 2020 2020 290a 2020 2020  eout,.    ).    
+00010cb0: 7265 7475 726e 2074 6573 740a 0a0a 2320  return test...# 
+00010cc0: 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573 7469  ---------- Testi
+00010cd0: 6e67 2060 736b 7920 6361 6e63 656c 6020  ng `sky cancel` 
+00010ce0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465  ----------.@pyte
+00010cf0: 7374 2e6d 6172 6b2e 6177 730a 4070 7974  st.mark.aws.@pyt
+00010d00: 6573 742e 6d61 726b 2e73 6b69 7028 0a20  est.mark.skip(. 
+00010d10: 2020 2072 6561 736f 6e3d 2754 6865 2072     reason='The r
+00010d20: 6573 6e65 745f 6170 7020 6973 2066 6c61  esnet_app is fla
+00010d30: 6b79 2c20 6475 6520 746f 2054 4620 6661  ky, due to TF fa
+00010d40: 696c 696e 6720 746f 2064 6574 6563 7420  iling to detect 
+00010d50: 4750 5573 2e27 290a 6465 6620 7465 7374  GPUs.').def test
+00010d60: 5f63 616e 6365 6c5f 6177 7328 293a 0a20  _cancel_aws():. 
+00010d70: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+00010d80: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+00010d90: 2020 7465 7374 203d 205f 6765 745f 6361    test = _get_ca
+00010da0: 6e63 656c 5f74 6173 6b5f 7769 7468 5f63  ncel_task_with_c
+00010db0: 6c6f 7564 286e 616d 652c 2027 6177 7327  loud(name, 'aws'
+00010dc0: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
+00010dd0: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
+00010de0: 7374 2e6d 6172 6b2e 6763 700a 4070 7974  st.mark.gcp.@pyt
+00010df0: 6573 742e 6d61 726b 2e73 6b69 7028 0a20  est.mark.skip(. 
+00010e00: 2020 2072 6561 736f 6e3d 2754 6865 2072     reason='The r
+00010e10: 6573 6e65 745f 6170 7020 6973 2066 6c61  esnet_app is fla
+00010e20: 6b79 2c20 6475 6520 746f 2054 4620 6661  ky, due to TF fa
+00010e30: 696c 696e 6720 746f 2064 6574 6563 7420  iling to detect 
+00010e40: 4750 5573 2e27 290a 6465 6620 7465 7374  GPUs.').def test
+00010e50: 5f63 616e 6365 6c5f 6763 7028 293a 0a20  _cancel_gcp():. 
+00010e60: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+00010e70: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+00010e80: 2020 7465 7374 203d 205f 6765 745f 6361    test = _get_ca
+00010e90: 6e63 656c 5f74 6173 6b5f 7769 7468 5f63  ncel_task_with_c
+00010ea0: 6c6f 7564 286e 616d 652c 2027 6763 7027  loud(name, 'gcp'
+00010eb0: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
+00010ec0: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
+00010ed0: 7374 2e6d 6172 6b2e 617a 7572 650a 4070  st.mark.azure.@p
+00010ee0: 7974 6573 742e 6d61 726b 2e73 6b69 7028  ytest.mark.skip(
+00010ef0: 0a20 2020 2072 6561 736f 6e3d 2754 6865  .    reason='The
+00010f00: 2072 6573 6e65 745f 6170 7020 6973 2066   resnet_app is f
+00010f10: 6c61 6b79 2c20 6475 6520 746f 2054 4620  laky, due to TF 
+00010f20: 6661 696c 696e 6720 746f 2064 6574 6563  failing to detec
+00010f30: 7420 4750 5573 2e27 290a 6465 6620 7465  t GPUs.').def te
+00010f40: 7374 5f63 616e 6365 6c5f 617a 7572 6528  st_cancel_azure(
+00010f50: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
+00010f60: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
+00010f70: 290a 2020 2020 7465 7374 203d 205f 6765  ).    test = _ge
+00010f80: 745f 6361 6e63 656c 5f74 6173 6b5f 7769  t_cancel_task_wi
+00010f90: 7468 5f63 6c6f 7564 286e 616d 652c 2027  th_cloud(name, '
+00010fa0: 617a 7572 6527 2c20 7469 6d65 6f75 743d  azure', timeout=
+00010fb0: 3330 202a 2036 3029 0a20 2020 2072 756e  30 * 60).    run
+00010fc0: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+00010fd0: 0a0a 4070 7974 6573 742e 6d61 726b 2e6e  ..@pytest.mark.n
+00010fe0: 6f5f 6c61 6d62 6461 5f63 6c6f 7564 2020  o_lambda_cloud  
+00010ff0: 2320 4c61 6d62 6461 2043 6c6f 7564 2064  # Lambda Cloud d
+00011000: 6f65 7320 6e6f 7420 6861 7665 2056 3130  oes not have V10
+00011010: 3020 6770 7573 0a40 7079 7465 7374 2e6d  0 gpus.@pytest.m
+00011020: 6172 6b2e 6e6f 5f69 626d 2020 2320 4942  ark.no_ibm  # IB
+00011030: 4d20 636c 6f75 6420 6375 7272 656e 746c  M cloud currentl
+00011040: 7920 646f 6573 6e27 7420 7072 6f76 6964  y doesn't provid
+00011050: 6520 7075 626c 6963 2069 6d61 6765 2077  e public image w
+00011060: 6974 6820 4355 4441 0a40 7079 7465 7374  ith CUDA.@pytest
+00011070: 2e6d 6172 6b2e 6e6f 5f73 6370 2020 2320  .mark.no_scp  # 
+00011080: 5343 5020 646f 6573 206e 6f74 2073 7570  SCP does not sup
+00011090: 706f 7274 206e 756d 5f6e 6f64 6573 203e  port num_nodes >
+000110a0: 2031 2079 6574 0a40 7079 7465 7374 2e6d   1 yet.@pytest.m
+000110b0: 6172 6b2e 6e6f 5f6b 7562 6572 6e65 7465  ark.no_kubernete
+000110c0: 7320 2023 204b 7562 6572 6e65 7465 7320  s  # Kubernetes 
+000110d0: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
+000110e0: 2047 5055 2079 6574 0a64 6566 2074 6573   GPU yet.def tes
+000110f0: 745f 6361 6e63 656c 5f70 7974 6f72 6368  t_cancel_pytorch
+00011100: 2867 656e 6572 6963 5f63 6c6f 7564 3a20  (generic_cloud: 
+00011110: 7374 7229 3a0a 2020 2020 6e61 6d65 203d  str):.    name =
+00011120: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+00011130: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
+00011140: 5465 7374 280a 2020 2020 2020 2020 2763  Test(.        'c
+00011150: 616e 6365 6c2d 7079 746f 7263 6827 2c0a  ancel-pytorch',.
+00011160: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
+00011170: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
+00011180: 6368 202d 6320 7b6e 616d 657d 202d 2d63  ch -c {name} --c
+00011190: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
+000111a0: 6f75 647d 2065 7861 6d70 6c65 732f 7265  oud} examples/re
+000111b0: 736e 6574 5f64 6973 7472 6962 7574 6564  snet_distributed
+000111c0: 5f74 6f72 6368 2e79 616d 6c20 2d79 202d  _torch.yaml -y -
+000111d0: 6427 2c0a 2020 2020 2020 2020 2020 2020  d',.            
+000111e0: 2320 5761 6974 2074 6865 2047 5055 2070  # Wait the GPU p
+000111f0: 726f 6365 7373 2074 6f20 7374 6172 742e  rocess to start.
+00011200: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+00011210: 6565 7020 3930 272c 0a20 2020 2020 2020  eep 90',.       
+00011220: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
+00011230: 7b6e 616d 657d 2022 6e76 6964 6961 2d73  {name} "nvidia-s
+00011240: 6d69 207c 2067 7265 7020 7079 7468 6f6e  mi | grep python
+00011250: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+00011260: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+00011270: 7d20 3220 2d2d 7374 6174 7573 272c 2020  } 2 --status',  
+00011280: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
+00011290: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
+000112a0: 2020 2020 2020 2020 6627 736b 7920 6361          f'sky ca
+000112b0: 6e63 656c 202d 7920 7b6e 616d 657d 2031  ncel -y {name} 1
+000112c0: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
+000112d0: 736c 6565 7020 3630 272c 0a20 2020 2020  sleep 60',.     
+000112e0: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+000112f0: 6320 7b6e 616d 657d 2022 286e 7669 6469  c {name} "(nvidi
+00011300: 612d 736d 6920 7c20 6772 6570 205c 274e  a-smi | grep \'N
+00011310: 6f20 7275 6e6e 696e 6720 7072 6f63 6573  o running proces
+00011320: 735c 2729 207c 7c20 270a 2020 2020 2020  s\') || '.      
+00011330: 2020 2020 2020 2320 456e 7375 7265 2058        # Ensure X
+00011340: 6f72 6720 6973 2074 6865 206f 6e6c 7920  org is the only 
+00011350: 7072 6f63 6573 7320 7275 6e6e 696e 672e  process running.
+00011360: 0a20 2020 2020 2020 2020 2020 2027 5b20  .            '[ 
+00011370: 5c24 286e 7669 6469 612d 736d 6920 7c20  \$(nvidia-smi | 
+00011380: 6772 6570 202d 4120 3130 2050 726f 6365  grep -A 10 Proce
+00011390: 7373 6573 207c 2067 7265 7020 2d41 2031  sses | grep -A 1
+000113a0: 3020 3d3d 3d20 7c20 6772 6570 202d 7620  0 === | grep -v 
+000113b0: 586f 7267 2920 2d65 7120 3220 5d22 272c  Xorg) -eq 2 ]"',
+000113c0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000113d0: 6b79 206c 6f67 7320 7b6e 616d 657d 2033  ky logs {name} 3
+000113e0: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
+000113f0: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
+00011400: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
+00011410: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
+00011420: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
+00011430: 272c 0a20 2020 2020 2020 2074 696d 656f  ',.        timeo
+00011440: 7574 3d32 3020 2a20 3630 2c0a 2020 2020  ut=20 * 60,.    
+00011450: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
+00011460: 7374 2874 6573 7429 0a0a 0a23 2063 616e  st(test)...# can
+00011470: 2774 2075 7365 2060 5f67 6574 5f63 616e  't use `_get_can
+00011480: 6365 6c5f 7461 736b 5f77 6974 685f 636c  cel_task_with_cl
+00011490: 6f75 6428 2960 2c20 6173 2063 6f6d 6d61  oud()`, as comma
+000114a0: 6e64 2060 6e76 6964 6961 2d73 6d69 600a  nd `nvidia-smi`.
+000114b0: 2320 7265 7175 6972 6573 2061 2043 5544  # requires a CUD
+000114c0: 4120 7075 626c 6963 2069 6d61 6765 2c20  A public image, 
+000114d0: 7768 6963 6820 4942 4d20 646f 6573 6e27  which IBM doesn'
+000114e0: 7420 6f66 6665 720a 4070 7974 6573 742e  t offer.@pytest.
+000114f0: 6d61 726b 2e69 626d 0a64 6566 2074 6573  mark.ibm.def tes
+00011500: 745f 6361 6e63 656c 5f69 626d 2829 3a0a  t_cancel_ibm():.
+00011510: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+00011520: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+00011530: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+00011540: 2020 2020 2020 2020 2769 626d 2d63 616e          'ibm-can
+00011550: 6365 6c2d 7461 736b 272c 0a20 2020 2020  cel-task',.     
+00011560: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+00011570: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
+00011580: 202d 6320 7b6e 616d 657d 202d 2d63 6c6f   -c {name} --clo
+00011590: 7564 2069 626d 2065 7861 6d70 6c65 732f  ud ibm examples/
+000115a0: 6d69 6e69 6d61 6c2e 7961 6d6c 272c 0a20  minimal.yaml',. 
+000115b0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000115c0: 2065 7865 6320 7b6e 616d 657d 202d 6e20   exec {name} -n 
+000115d0: 7b6e 616d 657d 2d31 202d 6420 2022 7768  {name}-1 -d  "wh
+000115e0: 696c 6520 7472 7565 3b20 646f 2065 6368  ile true; do ech
+000115f0: 6f20 5c27 4865 6c6c 6f20 536b 7950 696c  o \'Hello SkyPil
+00011600: 6f74 5c27 3b20 736c 6565 7020 323b 2064  ot\'; sleep 2; d
+00011610: 6f6e 6522 272c 0a20 2020 2020 2020 2020  one"',.         
+00011620: 2020 2027 736c 6565 7020 3230 272c 0a20     'sleep 20',. 
+00011630: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00011640: 2071 7565 7565 207b 6e61 6d65 7d20 7c20   queue {name} | 
+00011650: 6772 6570 207b 6e61 6d65 7d2d 3120 7c20  grep {name}-1 | 
+00011660: 6772 6570 2052 554e 4e49 4e47 272c 0a20  grep RUNNING',. 
+00011670: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00011680: 2063 616e 6365 6c20 2d79 207b 6e61 6d65   cancel -y {name
+00011690: 7d20 3227 2c0a 2020 2020 2020 2020 2020  } 2',.          
+000116a0: 2020 6627 736c 6565 7020 3527 2c0a 2020    f'sleep 5',.  
+000116b0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000116c0: 7175 6575 6520 7b6e 616d 657d 207c 2067  queue {name} | g
+000116d0: 7265 7020 7b6e 616d 657d 2d31 207c 2067  rep {name}-1 | g
+000116e0: 7265 7020 4341 4e43 454c 4c45 4427 2c0a  rep CANCELLED',.
+000116f0: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+00011700: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
+00011710: 207b 6e61 6d65 7d27 2c0a 2020 2020 290a   {name}',.    ).
+00011720: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+00011730: 2874 6573 7429 0a0a 0a23 202d 2d2d 2d2d  (test)...# -----
+00011740: 2d2d 2d2d 2d20 5465 7374 696e 6720 7573  ----- Testing us
+00011750: 652d 7370 6f74 206f 7074 696f 6e20 2d2d  e-spot option --
+00011760: 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465 7374  --------.@pytest
+00011770: 2e6d 6172 6b2e 6e6f 5f6c 616d 6264 615f  .mark.no_lambda_
+00011780: 636c 6f75 6420 2023 204c 616d 6264 6120  cloud  # Lambda 
+00011790: 436c 6f75 6420 646f 6573 206e 6f74 2073  Cloud does not s
+000117a0: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
+000117b0: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
+000117c0: 726b 2e6e 6f5f 6962 6d20 2023 2049 424d  rk.no_ibm  # IBM
+000117d0: 2043 6c6f 7564 2064 6f65 7320 6e6f 7420   Cloud does not 
+000117e0: 7375 7070 6f72 7420 7370 6f74 2069 6e73  support spot ins
+000117f0: 7461 6e63 6573 0a40 7079 7465 7374 2e6d  tances.@pytest.m
+00011800: 6172 6b2e 6e6f 5f73 6370 2020 2320 5343  ark.no_scp  # SC
+00011810: 5020 646f 6573 206e 6f74 2073 7570 706f  P does not suppo
+00011820: 7274 2073 706f 7420 696e 7374 616e 6365  rt spot instance
+00011830: 730a 4070 7974 6573 742e 6d61 726b 2e6e  s.@pytest.mark.n
+00011840: 6f5f 6b75 6265 726e 6574 6573 2020 2320  o_kubernetes  # 
+00011850: 4b75 6265 726e 6574 6573 2064 6f65 7320  Kubernetes does 
+00011860: 6e6f 7420 6861 7665 2061 206e 6f74 696f  not have a notio
+00011870: 6e20 6f66 2073 706f 7420 696e 7374 616e  n of spot instan
+00011880: 6365 730a 6465 6620 7465 7374 5f75 7365  ces.def test_use
+00011890: 5f73 706f 7428 6765 6e65 7269 635f 636c  _spot(generic_cl
+000118a0: 6f75 643a 2073 7472 293a 0a20 2020 2022  oud: str):.    "
+000118b0: 2222 5465 7374 2075 7365 2d73 706f 7420  ""Test use-spot 
+000118c0: 616e 6420 736b 7920 6578 6563 2e22 2222  and sky exec."""
+000118d0: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+000118e0: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+000118f0: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+00011900: 0a20 2020 2020 2020 2027 7573 652d 7370  .        'use-sp
+00011910: 6f74 272c 0a20 2020 2020 2020 205b 0a20  ot',.        [. 
+00011920: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00011930: 206c 6175 6e63 6820 2d63 207b 6e61 6d65   launch -c {name
+00011940: 7d20 2d2d 636c 6f75 6420 7b67 656e 6572  } --cloud {gener
+00011950: 6963 5f63 6c6f 7564 7d20 7465 7374 732f  ic_cloud} tests/
+00011960: 7465 7374 5f79 616d 6c73 2f6d 696e 696d  test_yamls/minim
+00011970: 616c 2e79 616d 6c20 2d2d 7573 652d 7370  al.yaml --use-sp
+00011980: 6f74 202d 7927 2c0a 2020 2020 2020 2020  ot -y',.        
+00011990: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+000119a0: 6e61 6d65 7d20 3120 2d2d 7374 6174 7573  name} 1 --status
+000119b0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000119c0: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+000119d0: 2065 6368 6f20 6869 272c 0a20 2020 2020   echo hi',.     
+000119e0: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+000119f0: 7320 7b6e 616d 657d 2032 202d 2d73 7461  s {name} 2 --sta
+00011a00: 7475 7327 2c0a 2020 2020 2020 2020 5d2c  tus',.        ],
+00011a10: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
+00011a20: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
+00011a30: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+00011a40: 655f 7465 7374 2874 6573 7429 0a0a 0a23  e_test(test)...#
+00011a50: 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465 7374   ---------- Test
+00011a60: 696e 6720 6d61 6e61 6765 6420 7370 6f74  ing managed spot
+00011a70: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974   ----------.@pyt
+00011a80: 6573 742e 6d61 726b 2e6e 6f5f 6c61 6d62  est.mark.no_lamb
+00011a90: 6461 5f63 6c6f 7564 2020 2320 4c61 6d62  da_cloud  # Lamb
+00011aa0: 6461 2043 6c6f 7564 2064 6f65 7320 6e6f  da Cloud does no
+00011ab0: 7420 7375 7070 6f72 7420 7370 6f74 2069  t support spot i
+00011ac0: 6e73 7461 6e63 6573 0a40 7079 7465 7374  nstances.@pytest
+00011ad0: 2e6d 6172 6b2e 6e6f 5f69 626d 2020 2320  .mark.no_ibm  # 
+00011ae0: 4942 4d20 436c 6f75 6420 646f 6573 206e  IBM Cloud does n
+00011af0: 6f74 2073 7570 706f 7274 2073 706f 7420  ot support spot 
+00011b00: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
+00011b10: 742e 6d61 726b 2e6e 6f5f 7363 7020 2023  t.mark.no_scp  #
+00011b20: 2053 4350 2064 6f65 7320 6e6f 7420 7375   SCP does not su
+00011b30: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
+00011b40: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
+00011b50: 6b2e 6e6f 5f6b 7562 6572 6e65 7465 7320  k.no_kubernetes 
+00011b60: 2023 204b 7562 6572 6e65 7465 7320 646f   # Kubernetes do
+00011b70: 6573 206e 6f74 2068 6176 6520 6120 6e6f  es not have a no
+00011b80: 7469 6f6e 206f 6620 7370 6f74 2069 6e73  tion of spot ins
+00011b90: 7461 6e63 6573 0a40 7079 7465 7374 2e6d  tances.@pytest.m
+00011ba0: 6172 6b2e 6d61 6e61 6765 645f 7370 6f74  ark.managed_spot
+00011bb0: 0a64 6566 2074 6573 745f 7370 6f74 2867  .def test_spot(g
+00011bc0: 656e 6572 6963 5f63 6c6f 7564 3a20 7374  eneric_cloud: st
+00011bd0: 7229 3a0a 2020 2020 2222 2254 6573 7420  r):.    """Test 
+00011be0: 7468 6520 7370 6f74 2079 616d 6c2e 2222  the spot yaml.""
+00011bf0: 220a 2020 2020 6e61 6d65 203d 205f 6765  ".    name = _ge
+00011c00: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+00011c10: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+00011c20: 280a 2020 2020 2020 2020 276d 616e 6167  (.        'manag
+00011c30: 6564 2d73 706f 7427 2c0a 2020 2020 2020  ed-spot',.      
+00011c40: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+00011c50: 6627 736b 7920 7370 6f74 206c 6175 6e63  f'sky spot launc
+00011c60: 6820 2d6e 207b 6e61 6d65 7d2d 3120 2d2d  h -n {name}-1 --
+00011c70: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
+00011c80: 6c6f 7564 7d20 6578 616d 706c 6573 2f6d  loud} examples/m
+00011c90: 616e 6167 6564 5f73 706f 742e 7961 6d6c  anaged_spot.yaml
+00011ca0: 202d 7920 2d64 272c 0a20 2020 2020 2020   -y -d',.       
+00011cb0: 2020 2020 2066 2773 6b79 2073 706f 7420       f'sky spot 
+00011cc0: 6c61 756e 6368 202d 6e20 7b6e 616d 657d  launch -n {name}
+00011cd0: 2d32 202d 2d63 6c6f 7564 207b 6765 6e65  -2 --cloud {gene
+00011ce0: 7269 635f 636c 6f75 647d 2065 7861 6d70  ric_cloud} examp
+00011cf0: 6c65 732f 6d61 6e61 6765 645f 7370 6f74  les/managed_spot
+00011d00: 2e79 616d 6c20 2d79 202d 6427 2c0a 2020  .yaml -y -d',.  
+00011d10: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+00011d20: 2035 272c 0a20 2020 2020 2020 2020 2020   5',.           
+00011d30: 2066 277b 5f53 504f 545f 5155 4555 455f   f'{_SPOT_QUEUE_
+00011d40: 5741 4954 7d7c 2067 7265 7020 7b6e 616d  WAIT}| grep {nam
+00011d50: 657d 2d31 207c 2068 6561 6420 2d6e 3120  e}-1 | head -n1 
+00011d60: 7c20 6772 6570 2022 5354 4152 5449 4e47  | grep "STARTING
+00011d70: 5c7c 5255 4e4e 494e 4722 272c 0a20 2020  \|RUNNING"',.   
+00011d80: 2020 2020 2020 2020 2066 277b 5f53 504f           f'{_SPO
+00011d90: 545f 5155 4555 455f 5741 4954 7d7c 2067  T_QUEUE_WAIT}| g
+00011da0: 7265 7020 7b6e 616d 657d 2d32 207c 2068  rep {name}-2 | h
+00011db0: 6561 6420 2d6e 3120 7c20 6772 6570 2022  ead -n1 | grep "
+00011dc0: 5354 4152 5449 4e47 5c7c 5255 4e4e 494e  STARTING\|RUNNIN
+00011dd0: 4722 272c 0a20 2020 2020 2020 2020 2020  G"',.           
+00011de0: 205f 5350 4f54 5f43 414e 4345 4c5f 5741   _SPOT_CANCEL_WA
+00011df0: 4954 2e66 6f72 6d61 7428 6a6f 625f 6e61  IT.format(job_na
+00011e00: 6d65 3d66 277b 6e61 6d65 7d2d 3127 292c  me=f'{name}-1'),
+00011e10: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+00011e20: 6565 7020 3527 2c0a 2020 2020 2020 2020  eep 5',.        
+00011e30: 2020 2020 6627 7b5f 5350 4f54 5f51 5545      f'{_SPOT_QUE
+00011e40: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
+00011e50: 6e61 6d65 7d2d 3120 7c20 6865 6164 202d  name}-1 | head -
+00011e60: 6e31 207c 2067 7265 7020 2243 414e 4345  n1 | grep "CANCE
+00011e70: 4c4c 494e 475c 7c43 414e 4345 4c4c 4544  LLING\|CANCELLED
+00011e80: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+00011e90: 2773 6c65 6570 2032 3030 272c 0a20 2020  'sleep 200',.   
+00011ea0: 2020 2020 2020 2020 2066 277b 5f53 504f           f'{_SPO
+00011eb0: 545f 5155 4555 455f 5741 4954 7d7c 2067  T_QUEUE_WAIT}| g
+00011ec0: 7265 7020 7b6e 616d 657d 2d31 207c 2068  rep {name}-1 | h
+00011ed0: 6561 6420 2d6e 3120 7c20 6772 6570 2043  ead -n1 | grep C
+00011ee0: 414e 4345 4c4c 4544 272c 0a20 2020 2020  ANCELLED',.     
+00011ef0: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
+00011f00: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
+00011f10: 7020 7b6e 616d 657d 2d32 207c 2068 6561  p {name}-2 | hea
+00011f20: 6420 2d6e 3120 7c20 6772 6570 2022 5255  d -n1 | grep "RU
+00011f30: 4e4e 494e 475c 7c53 5543 4345 4544 4544  NNING\|SUCCEEDED
+00011f40: 2227 2c0a 2020 2020 2020 2020 5d2c 0a20  "',.        ],. 
+00011f50: 2020 2020 2020 2023 2054 4f44 4f28 7a68         # TODO(zh
+00011f60: 7775 293a 2043 6861 6e67 6520 746f 205f  wu): Change to _
+00011f70: 5350 4f54 5f43 414e 4345 4c5f 5741 4954  SPOT_CANCEL_WAIT
+00011f80: 2e66 6f72 6d61 7428 6a6f 625f 6e61 6d65  .format(job_name
+00011f90: 3d66 277b 6e61 6d65 7d2d 3120 2d6e 207b  =f'{name}-1 -n {
+00011fa0: 6e61 6d65 7d2d 3227 2920 7768 656e 0a20  name}-2') when. 
+00011fb0: 2020 2020 2020 2023 2063 616e 6365 6c69         # canceli
+00011fc0: 6e67 206d 756c 7469 706c 6520 6a6f 6220  ng multiple job 
+00011fd0: 6e61 6d65 7320 6973 2073 7570 706f 7274  names is support
+00011fe0: 6564 2e0a 2020 2020 2020 2020 285f 5350  ed..        (_SP
+00011ff0: 4f54 5f43 414e 4345 4c5f 5741 4954 2e66  OT_CANCEL_WAIT.f
+00012000: 6f72 6d61 7428 6a6f 625f 6e61 6d65 3d66  ormat(job_name=f
+00012010: 277b 6e61 6d65 7d2d 3127 2920 2b20 273b  '{name}-1') + ';
+00012020: 2027 202b 0a20 2020 2020 2020 2020 5f53   ' +.         _S
+00012030: 504f 545f 4341 4e43 454c 5f57 4149 542e  POT_CANCEL_WAIT.
+00012040: 666f 726d 6174 286a 6f62 5f6e 616d 653d  format(job_name=
+00012050: 6627 7b6e 616d 657d 2d32 2729 292c 0a20  f'{name}-2')),. 
+00012060: 2020 2020 2020 2023 2049 6e63 7265 6173         # Increas
+00012070: 6520 7469 6d65 6f75 7420 7369 6e63 6520  e timeout since 
+00012080: 736b 7920 7370 6f74 2071 7565 7565 202d  sky spot queue -
+00012090: 7220 6361 6e20 6265 2062 6c6f 636b 6564  r can be blocked
+000120a0: 2062 7920 6f74 6865 7220 7370 6f74 2074   by other spot t
+000120b0: 6573 7473 2e0a 2020 2020 2020 2020 7469  ests..        ti
+000120c0: 6d65 6f75 743d 3230 202a 2036 302c 0a20  meout=20 * 60,. 
+000120d0: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+000120e0: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
+000120f0: 7974 6573 742e 6d61 726b 2e6e 6f5f 6c61  ytest.mark.no_la
+00012100: 6d62 6461 5f63 6c6f 7564 2020 2320 4c61  mbda_cloud  # La
+00012110: 6d62 6461 2043 6c6f 7564 2064 6f65 7320  mbda Cloud does 
+00012120: 6e6f 7420 7375 7070 6f72 7420 7370 6f74  not support spot
+00012130: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
+00012140: 7374 2e6d 6172 6b2e 6e6f 5f69 626d 2020  st.mark.no_ibm  
+00012150: 2320 4942 4d20 436c 6f75 6420 646f 6573  # IBM Cloud does
+00012160: 206e 6f74 2073 7570 706f 7274 2073 706f   not support spo
+00012170: 7420 696e 7374 616e 6365 730a 4070 7974  t instances.@pyt
+00012180: 6573 742e 6d61 726b 2e6e 6f5f 7363 7020  est.mark.no_scp 
+00012190: 2023 2053 4350 2064 6f65 7320 6e6f 7420   # SCP does not 
+000121a0: 7375 7070 6f72 7420 7370 6f74 2069 6e73  support spot ins
+000121b0: 7461 6e63 6573 0a40 7079 7465 7374 2e6d  tances.@pytest.m
+000121c0: 6172 6b2e 6e6f 5f6b 7562 6572 6e65 7465  ark.no_kubernete
+000121d0: 7320 2023 204b 7562 6572 6e65 7465 7320  s  # Kubernetes 
+000121e0: 646f 6573 206e 6f74 2068 6176 6520 6120  does not have a 
+000121f0: 6e6f 7469 6f6e 206f 6620 7370 6f74 2069  notion of spot i
+00012200: 6e73 7461 6e63 6573 0a40 7079 7465 7374  nstances.@pytest
+00012210: 2e6d 6172 6b2e 6d61 6e61 6765 645f 7370  .mark.managed_sp
+00012220: 6f74 0a64 6566 2074 6573 745f 7370 6f74  ot.def test_spot
+00012230: 5f70 6970 656c 696e 6528 6765 6e65 7269  _pipeline(generi
+00012240: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
+00012250: 2020 2022 2222 5465 7374 2061 2073 706f     """Test a spo
+00012260: 74c2 a070 6970 656c 696e 652e 2222 220a  t..pipeline.""".
+00012270: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+00012280: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+00012290: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+000122a0: 2020 2020 2020 2020 2773 706f 742d 7069          'spot-pi
+000122b0: 7065 6c69 6e65 272c 0a20 2020 2020 2020  peline',.       
+000122c0: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+000122d0: 2773 6b79 2073 706f 7420 6c61 756e 6368  'sky spot launch
+000122e0: 202d 6e20 7b6e 616d 657d 2074 6573 7473   -n {name} tests
+000122f0: 2f74 6573 745f 7961 6d6c 732f 7069 7065  /test_yamls/pipe
+00012300: 6c69 6e65 2e79 616d 6c20 2d79 202d 6427  line.yaml -y -d'
+00012310: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
+00012320: 6c65 6570 2035 272c 0a20 2020 2020 2020  leep 5',.       
+00012330: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
+00012340: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
+00012350: 7b6e 616d 657d 207c 2068 6561 6420 2d6e  {name} | head -n
+00012360: 3120 7c20 6772 6570 2022 5354 4152 5449  1 | grep "STARTI
+00012370: 4e47 5c7c 5255 4e4e 494e 4722 272c 0a20  NG\|RUNNING"',. 
+00012380: 2020 2020 2020 2020 2020 2023 2060 6772             # `gr
+00012390: 6570 202d 4120 3420 7b6e 616d 657d 6020  ep -A 4 {name}` 
+000123a0: 6669 6e64 7320 7468 6520 6a6f 6220 7769  finds the job wi
+000123b0: 7468 207b 6e61 6d65 7d20 616e 6420 7468  th {name} and th
+000123c0: 6520 3420 6c69 6e65 730a 2020 2020 2020  e 4 lines.      
+000123d0: 2020 2020 2020 2320 6166 7465 7220 6974        # after it
+000123e0: 2c20 692e 652e 2074 6865 2034 2074 6173  , i.e. the 4 tas
+000123f0: 6b73 2077 6974 6869 6e20 7468 6520 6a6f  ks within the jo
+00012400: 622e 0a20 2020 2020 2020 2020 2020 2023  b..            #
+00012410: 2060 7365 6420 2d6e 2032 7060 2067 6574   `sed -n 2p` get
+00012420: 7320 7468 6520 7365 636f 6e64 206c 696e  s the second lin
+00012430: 6520 6f66 2074 6865 2034 206c 696e 6573  e of the 4 lines
+00012440: 2c20 692e 652e 2074 6865 2066 6972 7374  , i.e. the first
+00012450: 0a20 2020 2020 2020 2020 2020 2023 2074  .            # t
+00012460: 6173 6b20 7769 7468 696e 2074 6865 206a  ask within the j
+00012470: 6f62 2e0a 2020 2020 2020 2020 2020 2020  ob..            
+00012480: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
+00012490: 4149 547d 7c20 6772 6570 202d 4120 3420  AIT}| grep -A 4 
+000124a0: 7b6e 616d 657d 7c20 7365 6420 2d6e 2032  {name}| sed -n 2
+000124b0: 7020 7c20 6772 6570 2022 5354 4152 5449  p | grep "STARTI
+000124c0: 4e47 5c7c 5255 4e4e 494e 4722 272c 0a20  NG\|RUNNING"',. 
+000124d0: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
+000124e0: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
+000124f0: 2067 7265 7020 2d41 2034 207b 6e61 6d65   grep -A 4 {name
+00012500: 7d7c 2073 6564 202d 6e20 3370 207c 2067  }| sed -n 3p | g
+00012510: 7265 7020 2250 454e 4449 4e47 2227 2c0a  rep "PENDING"',.
+00012520: 2020 2020 2020 2020 2020 2020 5f53 504f              _SPO
+00012530: 545f 4341 4e43 454c 5f57 4149 542e 666f  T_CANCEL_WAIT.fo
+00012540: 726d 6174 286a 6f62 5f6e 616d 653d 6627  rmat(job_name=f'
+00012550: 7b6e 616d 657d 2729 2c0a 2020 2020 2020  {name}'),.      
+00012560: 2020 2020 2020 2773 6c65 6570 2035 272c        'sleep 5',
+00012570: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+00012580: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
+00012590: 7d7c 2067 7265 7020 2d41 2034 207b 6e61  }| grep -A 4 {na
+000125a0: 6d65 7d7c 2073 6564 202d 6e20 3270 207c  me}| sed -n 2p |
+000125b0: 2067 7265 7020 2243 414e 4345 4c4c 494e   grep "CANCELLIN
+000125c0: 475c 7c43 414e 4345 4c4c 4544 2227 2c0a  G\|CANCELLED"',.
+000125d0: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+000125e0: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
+000125f0: 7c20 6772 6570 202d 4120 3420 7b6e 616d  | grep -A 4 {nam
+00012600: 657d 7c20 7365 6420 2d6e 2033 7020 7c20  e}| sed -n 3p | 
+00012610: 6772 6570 2022 4341 4e43 454c 4c49 4e47  grep "CANCELLING
+00012620: 5c7c 4341 4e43 454c 4c45 4422 272c 0a20  \|CANCELLED"',. 
+00012630: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
+00012640: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
+00012650: 2067 7265 7020 2d41 2034 207b 6e61 6d65   grep -A 4 {name
+00012660: 7d7c 2073 6564 202d 6e20 3470 207c 2067  }| sed -n 4p | g
+00012670: 7265 7020 2243 414e 4345 4c4c 494e 475c  rep "CANCELLING\
+00012680: 7c43 414e 4345 4c4c 4544 2227 2c0a 2020  |CANCELLED"',.  
+00012690: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
+000126a0: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
+000126b0: 6772 6570 202d 4120 3420 7b6e 616d 657d  grep -A 4 {name}
+000126c0: 7c20 7365 6420 2d6e 2035 7020 7c20 6772  | sed -n 5p | gr
+000126d0: 6570 2022 4341 4e43 454c 4c49 4e47 5c7c  ep "CANCELLING\|
+000126e0: 4341 4e43 454c 4c45 4422 272c 0a20 2020  CANCELLED"',.   
+000126f0: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+00012700: 3230 3027 2c0a 2020 2020 2020 2020 2020  200',.          
+00012710: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
+00012720: 5f57 4149 547d 7c20 6772 6570 202d 4120  _WAIT}| grep -A 
+00012730: 3420 7b6e 616d 657d 7c20 7365 6420 2d6e  4 {name}| sed -n
+00012740: 2032 7020 7c20 6772 6570 2022 4341 4e43   2p | grep "CANC
+00012750: 454c 4c45 4422 272c 0a20 2020 2020 2020  ELLED"',.       
+00012760: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
+00012770: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
+00012780: 2d41 2034 207b 6e61 6d65 7d7c 2073 6564  -A 4 {name}| sed
+00012790: 202d 6e20 3370 207c 2067 7265 7020 2243   -n 3p | grep "C
+000127a0: 414e 4345 4c4c 4544 2227 2c0a 2020 2020  ANCELLED"',.    
+000127b0: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
+000127c0: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
+000127d0: 6570 202d 4120 3420 7b6e 616d 657d 7c20  ep -A 4 {name}| 
+000127e0: 7365 6420 2d6e 2034 7020 7c20 6772 6570  sed -n 4p | grep
+000127f0: 2022 4341 4e43 454c 4c45 4422 272c 0a20   "CANCELLED"',. 
+00012800: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
+00012810: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
+00012820: 2067 7265 7020 2d41 2034 207b 6e61 6d65   grep -A 4 {name
+00012830: 7d7c 2073 6564 202d 6e20 3570 207c 2067  }| sed -n 5p | g
+00012840: 7265 7020 2243 414e 4345 4c4c 4544 2227  rep "CANCELLED"'
+00012850: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
+00012860: 2020 2020 205f 5350 4f54 5f43 414e 4345       _SPOT_CANCE
+00012870: 4c5f 5741 4954 2e66 6f72 6d61 7428 6a6f  L_WAIT.format(jo
+00012880: 625f 6e61 6d65 3d66 277b 6e61 6d65 7d27  b_name=f'{name}'
+00012890: 292c 0a20 2020 2020 2020 2023 2049 6e63  ),.        # Inc
+000128a0: 7265 6173 6520 7469 6d65 6f75 7420 7369  rease timeout si
+000128b0: 6e63 6520 736b 7920 7370 6f74 2071 7565  nce sky spot que
+000128c0: 7565 202d 7220 6361 6e20 6265 2062 6c6f  ue -r can be blo
+000128d0: 636b 6564 2062 7920 6f74 6865 7220 7370  cked by other sp
+000128e0: 6f74 2074 6573 7473 2e0a 2020 2020 2020  ot tests..      
+000128f0: 2020 7469 6d65 6f75 743d 3330 202a 2036    timeout=30 * 6
+00012900: 302c 0a20 2020 2029 0a20 2020 2072 756e  0,.    ).    run
+00012910: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+00012920: 0a0a 4070 7974 6573 742e 6d61 726b 2e6e  ..@pytest.mark.n
+00012930: 6f5f 6c61 6d62 6461 5f63 6c6f 7564 2020  o_lambda_cloud  
+00012940: 2320 4c61 6d62 6461 2043 6c6f 7564 2064  # Lambda Cloud d
+00012950: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
+00012960: 7370 6f74 2069 6e73 7461 6e63 6573 0a40  spot instances.@
+00012970: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f69  pytest.mark.no_i
+00012980: 626d 2020 2320 4942 4d20 436c 6f75 6420  bm  # IBM Cloud 
+00012990: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
+000129a0: 2073 706f 7420 696e 7374 616e 6365 730a   spot instances.
+000129b0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+000129c0: 7363 7020 2023 2053 4350 2064 6f65 7320  scp  # SCP does 
+000129d0: 6e6f 7420 7375 7070 6f72 7420 7370 6f74  not support spot
+000129e0: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
+000129f0: 7374 2e6d 6172 6b2e 6e6f 5f6b 7562 6572  st.mark.no_kuber
+00012a00: 6e65 7465 7320 2023 204b 7562 6572 6e65  netes  # Kuberne
+00012a10: 7465 7320 646f 6573 206e 6f74 2068 6176  tes does not hav
+00012a20: 6520 6120 6e6f 7469 6f6e 206f 6620 7370  e a notion of sp
+00012a30: 6f74 2069 6e73 7461 6e63 6573 0a40 7079  ot instances.@py
+00012a40: 7465 7374 2e6d 6172 6b2e 6d61 6e61 6765  test.mark.manage
+00012a50: 645f 7370 6f74 0a64 6566 2074 6573 745f  d_spot.def test_
+00012a60: 7370 6f74 5f66 6169 6c65 645f 7365 7475  spot_failed_setu
+00012a70: 7028 6765 6e65 7269 635f 636c 6f75 643a  p(generic_cloud:
+00012a80: 2073 7472 293a 0a20 2020 2022 2222 5465   str):.    """Te
+00012a90: 7374 206d 616e 6167 6564 2073 706f 7420  st managed spot 
+00012aa0: 6a6f 6220 7769 7468 2066 6169 6c65 6420  job with failed 
+00012ab0: 7365 7475 702e 2222 220a 2020 2020 6e61  setup.""".    na
+00012ac0: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
+00012ad0: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
+00012ae0: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+00012af0: 2020 2773 706f 745f 6661 696c 6564 5f73    'spot_failed_s
+00012b00: 6574 7570 272c 0a20 2020 2020 2020 205b  etup',.        [
+00012b10: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00012b20: 6b79 2073 706f 7420 6c61 756e 6368 202d  ky spot launch -
+00012b30: 6e20 7b6e 616d 657d 202d 2d63 6c6f 7564  n {name} --cloud
+00012b40: 207b 6765 6e65 7269 635f 636c 6f75 647d   {generic_cloud}
+00012b50: 202d 7920 2d64 2074 6573 7473 2f74 6573   -y -d tests/tes
+00012b60: 745f 7961 6d6c 732f 6661 696c 6564 5f73  t_yamls/failed_s
+00012b70: 6574 7570 2e79 616d 6c27 2c0a 2020 2020  etup.yaml',.    
+00012b80: 2020 2020 2020 2020 2773 6c65 6570 2033          'sleep 3
+00012b90: 3330 272c 0a20 2020 2020 2020 2020 2020  30',.           
+00012ba0: 2023 204d 616b 6520 7375 7265 2074 6865   # Make sure the
+00012bb0: 206a 6f62 2066 6169 6c65 6420 7175 6963   job failed quic
+00012bc0: 6b6c 792e 0a20 2020 2020 2020 2020 2020  kly..           
+00012bd0: 2066 277b 5f53 504f 545f 5155 4555 455f   f'{_SPOT_QUEUE_
+00012be0: 5741 4954 7d20 7c20 6772 6570 207b 6e61  WAIT} | grep {na
+00012bf0: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
+00012c00: 2067 7265 7020 2246 4149 4c45 445f 5345   grep "FAILED_SE
+00012c10: 5455 5022 272c 0a20 2020 2020 2020 205d  TUP"',.        ]
+00012c20: 2c0a 2020 2020 2020 2020 5f53 504f 545f  ,.        _SPOT_
+00012c30: 4341 4e43 454c 5f57 4149 542e 666f 726d  CANCEL_WAIT.form
+00012c40: 6174 286a 6f62 5f6e 616d 653d 6e61 6d65  at(job_name=name
+00012c50: 292c 0a20 2020 2020 2020 2023 2049 6e63  ),.        # Inc
+00012c60: 7265 6173 6520 7469 6d65 6f75 7420 7369  rease timeout si
+00012c70: 6e63 6520 736b 7920 7370 6f74 2071 7565  nce sky spot que
+00012c80: 7565 202d 7220 6361 6e20 6265 2062 6c6f  ue -r can be blo
+00012c90: 636b 6564 2062 7920 6f74 6865 7220 7370  cked by other sp
+00012ca0: 6f74 2074 6573 7473 2e0a 2020 2020 2020  ot tests..      
+00012cb0: 2020 7469 6d65 6f75 743d 3230 202a 2036    timeout=20 * 6
+00012cc0: 302c 0a20 2020 2029 0a20 2020 2072 756e  0,.    ).    run
+00012cd0: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+00012ce0: 0a0a 4070 7974 6573 742e 6d61 726b 2e6e  ..@pytest.mark.n
+00012cf0: 6f5f 6c61 6d62 6461 5f63 6c6f 7564 2020  o_lambda_cloud  
+00012d00: 2320 4c61 6d62 6461 2043 6c6f 7564 2064  # Lambda Cloud d
+00012d10: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
+00012d20: 7370 6f74 2069 6e73 7461 6e63 6573 0a40  spot instances.@
+00012d30: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f69  pytest.mark.no_i
+00012d40: 626d 2020 2320 4942 4d20 436c 6f75 6420  bm  # IBM Cloud 
+00012d50: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
+00012d60: 2073 706f 7420 696e 7374 616e 6365 730a   spot instances.
+00012d70: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+00012d80: 7363 7020 2023 2053 4350 2064 6f65 7320  scp  # SCP does 
+00012d90: 6e6f 7420 7375 7070 6f72 7420 7370 6f74  not support spot
+00012da0: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
+00012db0: 7374 2e6d 6172 6b2e 6e6f 5f6b 7562 6572  st.mark.no_kuber
+00012dc0: 6e65 7465 7320 2023 204b 7562 6572 6e65  netes  # Kuberne
+00012dd0: 7465 7320 646f 6573 206e 6f74 2068 6176  tes does not hav
+00012de0: 6520 6120 6e6f 7469 6f6e 206f 6620 7370  e a notion of sp
+00012df0: 6f74 2069 6e73 7461 6e63 6573 0a40 7079  ot instances.@py
+00012e00: 7465 7374 2e6d 6172 6b2e 6d61 6e61 6765  test.mark.manage
+00012e10: 645f 7370 6f74 0a64 6566 2074 6573 745f  d_spot.def test_
+00012e20: 7370 6f74 5f70 6970 656c 696e 655f 6661  spot_pipeline_fa
+00012e30: 696c 6564 5f73 6574 7570 2867 656e 6572  iled_setup(gener
+00012e40: 6963 5f63 6c6f 7564 3a20 7374 7229 3a0a  ic_cloud: str):.
+00012e50: 2020 2020 2222 2254 6573 7420 6d61 6e61      """Test mana
+00012e60: 6765 6420 7370 6f74 206a 6f62 2077 6974  ged spot job wit
+00012e70: 6820 6661 696c 6564 2073 6574 7570 2066  h failed setup f
+00012e80: 6f72 2061 2070 6970 656c 696e 652e 2222  or a pipeline.""
+00012e90: 220a 2020 2020 6e61 6d65 203d 205f 6765  ".    name = _ge
+00012ea0: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+00012eb0: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+00012ec0: 280a 2020 2020 2020 2020 2773 706f 745f  (.        'spot_
+00012ed0: 7069 7065 6c69 6e65 5f66 6169 6c65 645f  pipeline_failed_
+00012ee0: 7365 7475 7027 2c0a 2020 2020 2020 2020  setup',.        
+00012ef0: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+00012f00: 736b 7920 7370 6f74 206c 6175 6e63 6820  sky spot launch 
+00012f10: 2d6e 207b 6e61 6d65 7d20 2d79 202d 6420  -n {name} -y -d 
+00012f20: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
+00012f30: 2f66 6169 6c65 645f 7365 7475 705f 7069  /failed_setup_pi
+00012f40: 7065 6c69 6e65 2e79 616d 6c27 2c0a 2020  peline.yaml',.  
+00012f50: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+00012f60: 2038 3030 272c 0a20 2020 2020 2020 2020   800',.         
+00012f70: 2020 2023 204d 616b 6520 7375 7265 2074     # Make sure t
+00012f80: 6865 206a 6f62 2066 6169 6c65 6420 7175  he job failed qu
+00012f90: 6963 6b6c 792e 0a20 2020 2020 2020 2020  ickly..         
+00012fa0: 2020 2066 277b 5f53 504f 545f 5155 4555     f'{_SPOT_QUEU
+00012fb0: 455f 5741 4954 7d20 7c20 6772 6570 207b  E_WAIT} | grep {
+00012fc0: 6e61 6d65 7d20 7c20 6865 6164 202d 6e31  name} | head -n1
+00012fd0: 207c 2067 7265 7020 2246 4149 4c45 445f   | grep "FAILED_
+00012fe0: 5345 5455 5022 272c 0a20 2020 2020 2020  SETUP"',.       
+00012ff0: 2020 2020 2023 2054 6173 6b20 3020 7368       # Task 0 sh
+00013000: 6f75 6c64 2062 6520 5355 4343 4545 4445  ould be SUCCEEDE
+00013010: 442e 0a20 2020 2020 2020 2020 2020 2066  D..            f
+00013020: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
+00013030: 4954 7d20 7c20 6772 6570 202d 4120 3420  IT} | grep -A 4 
+00013040: 7b6e 616d 657d 7c20 7365 6420 2d6e 2032  {name}| sed -n 2
+00013050: 7020 7c20 6772 6570 2022 5355 4343 4545  p | grep "SUCCEE
+00013060: 4445 4422 272c 0a20 2020 2020 2020 2020  DED"',.         
+00013070: 2020 2023 2054 6173 6b20 3120 7368 6f75     # Task 1 shou
+00013080: 6c64 2062 6520 4641 494c 4544 5f53 4554  ld be FAILED_SET
+00013090: 5550 2e0a 2020 2020 2020 2020 2020 2020  UP..            
+000130a0: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
+000130b0: 4149 547d 207c 2067 7265 7020 2d41 2034  AIT} | grep -A 4
+000130c0: 207b 6e61 6d65 7d7c 2073 6564 202d 6e20   {name}| sed -n 
+000130d0: 3370 207c 2067 7265 7020 2246 4149 4c45  3p | grep "FAILE
+000130e0: 445f 5345 5455 5022 272c 0a20 2020 2020  D_SETUP"',.     
+000130f0: 2020 2020 2020 2023 2054 6173 6b20 3220         # Task 2 
+00013100: 7368 6f75 6c64 2062 6520 4341 4e43 454c  should be CANCEL
+00013110: 4c45 442e 0a20 2020 2020 2020 2020 2020  LED..           
+00013120: 2066 277b 5f53 504f 545f 5155 4555 455f   f'{_SPOT_QUEUE_
+00013130: 5741 4954 7d20 7c20 6772 6570 202d 4120  WAIT} | grep -A 
+00013140: 3420 7b6e 616d 657d 7c20 7365 6420 2d6e  4 {name}| sed -n
+00013150: 2034 7020 7c20 6772 6570 2022 4341 4e43   4p | grep "CANC
+00013160: 454c 4c45 4422 272c 0a20 2020 2020 2020  ELLED"',.       
+00013170: 2020 2020 2023 2054 6173 6b20 3320 7368       # Task 3 sh
+00013180: 6f75 6c64 2062 6520 4341 4e43 454c 4c45  ould be CANCELLE
+00013190: 442e 0a20 2020 2020 2020 2020 2020 2066  D..            f
+000131a0: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
+000131b0: 4954 7d20 7c20 6772 6570 202d 4120 3420  IT} | grep -A 4 
+000131c0: 7b6e 616d 657d 7c20 7365 6420 2d6e 2035  {name}| sed -n 5
+000131d0: 7020 7c20 6772 6570 2022 4341 4e43 454c  p | grep "CANCEL
+000131e0: 4c45 4422 272c 0a20 2020 2020 2020 205d  LED"',.        ]
+000131f0: 2c0a 2020 2020 2020 2020 5f53 504f 545f  ,.        _SPOT_
+00013200: 4341 4e43 454c 5f57 4149 542e 666f 726d  CANCEL_WAIT.form
+00013210: 6174 286a 6f62 5f6e 616d 653d 6e61 6d65  at(job_name=name
+00013220: 292c 0a20 2020 2020 2020 2023 2049 6e63  ),.        # Inc
+00013230: 7265 6173 6520 7469 6d65 6f75 7420 7369  rease timeout si
+00013240: 6e63 6520 736b 7920 7370 6f74 2071 7565  nce sky spot que
+00013250: 7565 202d 7220 6361 6e20 6265 2062 6c6f  ue -r can be blo
+00013260: 636b 6564 2062 7920 6f74 6865 7220 7370  cked by other sp
+00013270: 6f74 2074 6573 7473 2e0a 2020 2020 2020  ot tests..      
+00013280: 2020 7469 6d65 6f75 743d 3330 202a 2036    timeout=30 * 6
+00013290: 302c 0a20 2020 2029 0a20 2020 2072 756e  0,.    ).    run
+000132a0: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+000132b0: 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054  ..# ---------- T
+000132c0: 6573 7469 6e67 206d 616e 6167 6564 2073  esting managed s
+000132d0: 706f 7420 7265 636f 7665 7279 202d 2d2d  pot recovery ---
+000132e0: 2d2d 2d2d 2d2d 2d0a 0a0a 4070 7974 6573  -------...@pytes
+000132f0: 742e 6d61 726b 2e61 7773 0a40 7079 7465  t.mark.aws.@pyte
+00013300: 7374 2e6d 6172 6b2e 6d61 6e61 6765 645f  st.mark.managed_
+00013310: 7370 6f74 0a64 6566 2074 6573 745f 7370  spot.def test_sp
+00013320: 6f74 5f72 6563 6f76 6572 795f 6177 7328  ot_recovery_aws(
+00013330: 6177 735f 636f 6e66 6967 5f72 6567 696f  aws_config_regio
+00013340: 6e29 3a0a 2020 2020 2222 2254 6573 7420  n):.    """Test 
+00013350: 6d61 6e61 6765 6420 7370 6f74 2072 6563  managed spot rec
+00013360: 6f76 6572 792e 2222 220a 2020 2020 6e61  overy.""".    na
+00013370: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
+00013380: 725f 6e61 6d65 2829 0a20 2020 2072 6567  r_name().    reg
+00013390: 696f 6e20 3d20 6177 735f 636f 6e66 6967  ion = aws_config
+000133a0: 5f72 6567 696f 6e0a 2020 2020 7465 7374  _region.    test
+000133b0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
+000133c0: 2027 7370 6f74 5f72 6563 6f76 6572 795f   'spot_recovery_
+000133d0: 6177 7327 2c0a 2020 2020 2020 2020 5b0a  aws',.        [.
+000133e0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+000133f0: 7920 7370 6f74 206c 6175 6e63 6820 2d2d  y spot launch --
+00013400: 636c 6f75 6420 6177 7320 2d2d 7265 6769  cloud aws --regi
+00013410: 6f6e 207b 7265 6769 6f6e 7d20 2d6e 207b  on {region} -n {
+00013420: 6e61 6d65 7d20 2265 6368 6f20 534b 5950  name} "echo SKYP
+00013430: 494c 4f54 5f54 4153 4b5f 4944 3a20 5c24  ILOT_TASK_ID: \$
+00013440: 534b 5950 494c 4f54 5f54 4153 4b5f 4944  SKYPILOT_TASK_ID
+00013450: 3b20 736c 6565 7020 3138 3030 2220 202d  ; sleep 1800"  -
+00013460: 7920 2d64 272c 0a20 2020 2020 2020 2020  y -d',.         
+00013470: 2020 2027 736c 6565 7020 3336 3027 2c0a     'sleep 360',.
+00013480: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+00013490: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
+000134a0: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
+000134b0: 6865 6164 202d 6e31 207c 2067 7265 7020  head -n1 | grep 
+000134c0: 2252 554e 4e49 4e47 2227 2c0a 2020 2020  "RUNNING"',.    
+000134d0: 2020 2020 2020 2020 6627 5255 4e5f 4944          f'RUN_ID
+000134e0: 3d24 2873 6b79 2073 706f 7420 6c6f 6773  =$(sky spot logs
+000134f0: 202d 6e20 7b6e 616d 657d 202d 2d6e 6f2d   -n {name} --no-
+00013500: 666f 6c6c 6f77 207c 2067 7265 7020 534b  follow | grep SK
+00013510: 5950 494c 4f54 5f54 4153 4b5f 4944 207c  YPILOT_TASK_ID |
+00013520: 2063 7574 202d 643a 202d 6632 293b 2065   cut -d: -f2); e
+00013530: 6368 6f20 2224 5255 4e5f 4944 2220 7c20  cho "$RUN_ID" | 
+00013540: 7465 6520 2f74 6d70 2f7b 6e61 6d65 7d2d  tee /tmp/{name}-
+00013550: 7275 6e2d 6964 272c 0a20 2020 2020 2020  run-id',.       
+00013560: 2020 2020 2023 2054 6572 6d69 6e61 7465       # Terminate
+00013570: 2074 6865 2063 6c75 7374 6572 206d 616e   the cluster man
+00013580: 7561 6c6c 792e 0a20 2020 2020 2020 2020  ually..         
+00013590: 2020 2028 6627 6177 7320 6563 3220 7465     (f'aws ec2 te
+000135a0: 726d 696e 6174 652d 696e 7374 616e 6365  rminate-instance
+000135b0: 7320 2d2d 7265 6769 6f6e 207b 7265 6769  s --region {regi
+000135c0: 6f6e 7d20 2d2d 696e 7374 616e 6365 2d69  on} --instance-i
+000135d0: 6473 2024 2827 0a20 2020 2020 2020 2020  ds $('.         
+000135e0: 2020 2020 6627 6177 7320 6563 3220 6465      f'aws ec2 de
+000135f0: 7363 7269 6265 2d69 6e73 7461 6e63 6573  scribe-instances
+00013600: 202d 2d72 6567 696f 6e20 7b72 6567 696f   --region {regio
+00013610: 6e7d 2027 0a20 2020 2020 2020 2020 2020  n} '.           
+00013620: 2020 6627 2d2d 6669 6c74 6572 7320 4e61    f'--filters Na
+00013630: 6d65 3d74 6167 3a72 6179 2d63 6c75 7374  me=tag:ray-clust
+00013640: 6572 2d6e 616d 652c 5661 6c75 6573 3d7b  er-name,Values={
+00013650: 6e61 6d65 7d2a 2027 0a20 2020 2020 2020  name}* '.       
+00013660: 2020 2020 2020 6627 2d2d 7175 6572 7920        f'--query 
+00013670: 5265 7365 7276 6174 696f 6e73 5b5d 2e49  Reservations[].I
+00013680: 6e73 7461 6e63 6573 5b5d 2e49 6e73 7461  nstances[].Insta
+00013690: 6e63 6549 6420 270a 2020 2020 2020 2020  nceId '.        
+000136a0: 2020 2020 2027 2d2d 6f75 7470 7574 2074       '--output t
+000136b0: 6578 7429 2729 2c0a 2020 2020 2020 2020  ext)'),.        
+000136c0: 2020 2020 2773 6c65 6570 2031 3030 272c      'sleep 100',
+000136d0: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+000136e0: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
+000136f0: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
+00013700: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
+00013710: 2022 5245 434f 5645 5249 4e47 2227 2c0a   "RECOVERING"',.
+00013720: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+00013730: 6570 2032 3030 272c 0a20 2020 2020 2020  ep 200',.       
+00013740: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
+00013750: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
+00013760: 7b6e 616d 657d 207c 2068 6561 6420 2d6e  {name} | head -n
+00013770: 3120 7c20 6772 6570 2022 5255 4e4e 494e  1 | grep "RUNNIN
+00013780: 4722 272c 0a20 2020 2020 2020 2020 2020  G"',.           
+00013790: 2066 2752 554e 5f49 443d 2428 6361 7420   f'RUN_ID=$(cat 
+000137a0: 2f74 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d  /tmp/{name}-run-
+000137b0: 6964 293b 2065 6368 6f20 2452 554e 5f49  id); echo $RUN_I
+000137c0: 443b 2073 6b79 2073 706f 7420 6c6f 6773  D; sky spot logs
+000137d0: 202d 6e20 7b6e 616d 657d 202d 2d6e 6f2d   -n {name} --no-
+000137e0: 666f 6c6c 6f77 207c 2067 7265 7020 534b  follow | grep SK
+000137f0: 5950 494c 4f54 5f54 4153 4b5f 4944 207c  YPILOT_TASK_ID |
+00013800: 2067 7265 7020 2224 5255 4e5f 4944 2227   grep "$RUN_ID"'
+00013810: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
+00013820: 2020 2020 205f 5350 4f54 5f43 414e 4345       _SPOT_CANCE
+00013830: 4c5f 5741 4954 2e66 6f72 6d61 7428 6a6f  L_WAIT.format(jo
+00013840: 625f 6e61 6d65 3d6e 616d 6529 2c0a 2020  b_name=name),.  
+00013850: 2020 2020 2020 7469 6d65 6f75 743d 3235        timeout=25
+00013860: 202a 2036 302c 0a20 2020 2029 0a20 2020   * 60,.    ).   
+00013870: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+00013880: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
+00013890: 726b 2e67 6370 0a40 7079 7465 7374 2e6d  rk.gcp.@pytest.m
+000138a0: 6172 6b2e 6d61 6e61 6765 645f 7370 6f74  ark.managed_spot
+000138b0: 0a64 6566 2074 6573 745f 7370 6f74 5f72  .def test_spot_r
+000138c0: 6563 6f76 6572 795f 6763 7028 293a 0a20  ecovery_gcp():. 
+000138d0: 2020 2022 2222 5465 7374 206d 616e 6167     """Test manag
+000138e0: 6564 2073 706f 7420 7265 636f 7665 7279  ed spot recovery
+000138f0: 2e22 2222 0a20 2020 206e 616d 6520 3d20  .""".    name = 
+00013900: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+00013910: 6528 290a 2020 2020 7a6f 6e65 203d 2027  e().    zone = '
+00013920: 7573 2d65 6173 7434 2d62 270a 2020 2020  us-east4-b'.    
+00013930: 7175 6572 795f 636d 6420 3d20 2866 2767  query_cmd = (f'g
+00013940: 636c 6f75 6420 636f 6d70 7574 6520 696e  cloud compute in
+00013950: 7374 616e 6365 7320 6c69 7374 202d 2d66  stances list --f
+00013960: 696c 7465 723d 270a 2020 2020 2020 2020  ilter='.        
+00013970: 2020 2020 2020 2020 2066 2722 286c 6162           f'"(lab
+00013980: 656c 732e 7261 792d 636c 7573 7465 722d  els.ray-cluster-
+00013990: 6e61 6d65 3a7b 6e61 6d65 7d29 2220 270a  name:{name})" '.
+000139a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000139b0: 2066 272d 2d7a 6f6e 6573 3d7b 7a6f 6e65   f'--zones={zone
+000139c0: 7d20 2d2d 666f 726d 6174 3d22 7661 6c75  } --format="valu
+000139d0: 6528 6e61 6d65 2922 2729 0a20 2020 2074  e(name)"').    t
+000139e0: 6572 6d69 6e61 7465 5f63 6d64 203d 2028  erminate_cmd = (
+000139f0: 6627 6763 6c6f 7564 2063 6f6d 7075 7465  f'gcloud compute
+00013a00: 2069 6e73 7461 6e63 6573 2064 656c 6574   instances delet
+00013a10: 6520 2d2d 7a6f 6e65 3d7b 7a6f 6e65 7d27  e --zone={zone}'
+00013a20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013a30: 2020 2020 2020 6627 202d 2d71 7569 6574        f' --quiet
+00013a40: 2024 287b 7175 6572 795f 636d 647d 2927   $({query_cmd})'
+00013a50: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
+00013a60: 7428 0a20 2020 2020 2020 2027 7370 6f74  t(.        'spot
+00013a70: 5f72 6563 6f76 6572 795f 6763 7027 2c0a  _recovery_gcp',.
+00013a80: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
+00013a90: 2020 2020 2020 6627 736b 7920 7370 6f74        f'sky spot
+00013aa0: 206c 6175 6e63 6820 2d2d 636c 6f75 6420   launch --cloud 
+00013ab0: 6763 7020 2d2d 7a6f 6e65 207b 7a6f 6e65  gcp --zone {zone
+00013ac0: 7d20 2d6e 207b 6e61 6d65 7d20 2265 6368  } -n {name} "ech
+00013ad0: 6f20 534b 5950 494c 4f54 5f54 4153 4b5f  o SKYPILOT_TASK_
+00013ae0: 4944 3a20 5c24 534b 5950 494c 4f54 5f54  ID: \$SKYPILOT_T
+00013af0: 4153 4b5f 4944 3b20 736c 6565 7020 3138  ASK_ID; sleep 18
+00013b00: 3030 2220 202d 7920 2d64 272c 0a20 2020  00"  -y -d',.   
+00013b10: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+00013b20: 3336 3027 2c0a 2020 2020 2020 2020 2020  360',.          
+00013b30: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
+00013b40: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
+00013b50: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
+00013b60: 2067 7265 7020 2252 554e 4e49 4e47 2227   grep "RUNNING"'
+00013b70: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00013b80: 5255 4e5f 4944 3d24 2873 6b79 2073 706f  RUN_ID=$(sky spo
+00013b90: 7420 6c6f 6773 202d 6e20 7b6e 616d 657d  t logs -n {name}
+00013ba0: 202d 2d6e 6f2d 666f 6c6c 6f77 207c 2067   --no-follow | g
+00013bb0: 7265 7020 534b 5950 494c 4f54 5f54 4153  rep SKYPILOT_TAS
+00013bc0: 4b5f 4944 207c 2063 7574 202d 643a 202d  K_ID | cut -d: -
+00013bd0: 6632 293b 2065 6368 6f20 2224 5255 4e5f  f2); echo "$RUN_
+00013be0: 4944 2220 7c20 7465 6520 2f74 6d70 2f7b  ID" | tee /tmp/{
+00013bf0: 6e61 6d65 7d2d 7275 6e2d 6964 272c 0a20  name}-run-id',. 
+00013c00: 2020 2020 2020 2020 2020 2023 2054 6572             # Ter
+00013c10: 6d69 6e61 7465 2074 6865 2063 6c75 7374  minate the clust
+00013c20: 6572 206d 616e 7561 6c6c 792e 0a20 2020  er manually..   
+00013c30: 2020 2020 2020 2020 2074 6572 6d69 6e61           termina
+00013c40: 7465 5f63 6d64 2c0a 2020 2020 2020 2020  te_cmd,.        
+00013c50: 2020 2020 2773 6c65 6570 2031 3030 272c      'sleep 100',
+00013c60: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+00013c70: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
+00013c80: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
+00013c90: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
+00013ca0: 2022 5245 434f 5645 5249 4e47 2227 2c0a   "RECOVERING"',.
+00013cb0: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+00013cc0: 6570 2032 3030 272c 0a20 2020 2020 2020  ep 200',.       
+00013cd0: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
+00013ce0: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
+00013cf0: 7b6e 616d 657d 207c 2068 6561 6420 2d6e  {name} | head -n
+00013d00: 3120 7c20 6772 6570 2022 5255 4e4e 494e  1 | grep "RUNNIN
+00013d10: 4722 272c 0a20 2020 2020 2020 2020 2020  G"',.           
+00013d20: 2066 2752 554e 5f49 443d 2428 6361 7420   f'RUN_ID=$(cat 
+00013d30: 2f74 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d  /tmp/{name}-run-
+00013d40: 6964 293b 2065 6368 6f20 2452 554e 5f49  id); echo $RUN_I
+00013d50: 443b 2073 6b79 2073 706f 7420 6c6f 6773  D; sky spot logs
+00013d60: 202d 6e20 7b6e 616d 657d 202d 2d6e 6f2d   -n {name} --no-
+00013d70: 666f 6c6c 6f77 207c 2067 7265 7020 534b  follow | grep SK
+00013d80: 5950 494c 4f54 5f54 4153 4b5f 4944 3a20  YPILOT_TASK_ID: 
+00013d90: 7c20 6772 6570 2022 2452 554e 5f49 4422  | grep "$RUN_ID"
+00013da0: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
+00013db0: 2020 2020 2020 5f53 504f 545f 4341 4e43        _SPOT_CANC
+00013dc0: 454c 5f57 4149 542e 666f 726d 6174 286a  EL_WAIT.format(j
+00013dd0: 6f62 5f6e 616d 653d 6e61 6d65 292c 0a20  ob_name=name),. 
+00013de0: 2020 2020 2020 2074 696d 656f 7574 3d32         timeout=2
+00013df0: 3520 2a20 3630 2c0a 2020 2020 290a 2020  5 * 60,.    ).  
+00013e00: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+00013e10: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+00013e20: 6172 6b2e 6177 730a 4070 7974 6573 742e  ark.aws.@pytest.
+00013e30: 6d61 726b 2e6d 616e 6167 6564 5f73 706f  mark.managed_spo
+00013e40: 740a 6465 6620 7465 7374 5f73 706f 745f  t.def test_spot_
+00013e50: 7069 7065 6c69 6e65 5f72 6563 6f76 6572  pipeline_recover
+00013e60: 795f 6177 7328 6177 735f 636f 6e66 6967  y_aws(aws_config
+00013e70: 5f72 6567 696f 6e29 3a0a 2020 2020 2222  _region):.    ""
+00013e80: 2254 6573 7420 6d61 6e61 6765 6420 7370  "Test managed sp
+00013e90: 6f74 2072 6563 6f76 6572 7920 666f 7220  ot recovery for 
+00013ea0: 6120 7069 7065 6c69 6e65 2e22 2222 0a20  a pipeline.""". 
+00013eb0: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+00013ec0: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+00013ed0: 2020 7265 6769 6f6e 203d 2061 7773 5f63    region = aws_c
+00013ee0: 6f6e 6669 675f 7265 6769 6f6e 0a20 2020  onfig_region.   
+00013ef0: 2069 6620 7265 6769 6f6e 2021 3d20 2775   if region != 'u
+00013f00: 732d 7765 7374 2d32 273a 0a20 2020 2020  s-west-2':.     
+00013f10: 2020 2070 7974 6573 742e 736b 6970 2827     pytest.skip('
+00013f20: 4f6e 6c79 2072 756e 2073 706f 7420 7069  Only run spot pi
+00013f30: 7065 6c69 6e65 2072 6563 6f76 6572 7920  peline recovery 
+00013f40: 7465 7374 2069 6e20 7573 2d77 6573 742d  test in us-west-
+00013f50: 3227 290a 2020 2020 7465 7374 203d 2054  2').    test = T
+00013f60: 6573 7428 0a20 2020 2020 2020 2027 7370  est(.        'sp
+00013f70: 6f74 5f70 6970 656c 696e 655f 7265 636f  ot_pipeline_reco
+00013f80: 7665 7279 5f61 7773 272c 0a20 2020 2020  very_aws',.     
+00013f90: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+00013fa0: 2066 2773 6b79 2073 706f 7420 6c61 756e   f'sky spot laun
+00013fb0: 6368 202d 6e20 7b6e 616d 657d 2074 6573  ch -n {name} tes
+00013fc0: 7473 2f74 6573 745f 7961 6d6c 732f 7069  ts/test_yamls/pi
+00013fd0: 7065 6c69 6e65 5f61 7773 2e79 616d 6c20  peline_aws.yaml 
+00013fe0: 202d 7920 2d64 272c 0a20 2020 2020 2020   -y -d',.       
+00013ff0: 2020 2020 2027 736c 6565 7020 3430 3027       'sleep 400'
+00014000: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00014010: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
+00014020: 547d 7c20 6772 6570 207b 6e61 6d65 7d20  T}| grep {name} 
+00014030: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
+00014040: 7020 2252 554e 4e49 4e47 2227 2c0a 2020  p "RUNNING"',.  
+00014050: 2020 2020 2020 2020 2020 6627 5255 4e5f            f'RUN_
+00014060: 4944 3d24 2873 6b79 2073 706f 7420 6c6f  ID=$(sky spot lo
+00014070: 6773 202d 6e20 7b6e 616d 657d 202d 2d6e  gs -n {name} --n
+00014080: 6f2d 666f 6c6c 6f77 207c 2067 7265 7020  o-follow | grep 
+00014090: 534b 5950 494c 4f54 5f54 4153 4b5f 4944  SKYPILOT_TASK_ID
+000140a0: 3a20 7c20 6375 7420 2d64 3a20 2d66 3229  : | cut -d: -f2)
+000140b0: 3b20 6563 686f 2022 2452 554e 5f49 4422  ; echo "$RUN_ID"
+000140c0: 207c 2074 6565 202f 746d 702f 7b6e 616d   | tee /tmp/{nam
+000140d0: 657d 2d72 756e 2d69 6427 2c0a 2020 2020  e}-run-id',.    
+000140e0: 2020 2020 2020 2020 6627 5255 4e5f 4944          f'RUN_ID
+000140f0: 533d 2428 736b 7920 7370 6f74 206c 6f67  S=$(sky spot log
+00014100: 7320 2d6e 207b 6e61 6d65 7d20 2d2d 6e6f  s -n {name} --no
+00014110: 2d66 6f6c 6c6f 7720 7c20 6772 6570 202d  -follow | grep -
+00014120: 4120 3420 534b 5950 494c 4f54 5f54 4153  A 4 SKYPILOT_TAS
+00014130: 4b5f 4944 5320 7c20 6375 7420 2d64 2229  K_IDS | cut -d")
+00014140: 2220 2d66 3229 3b20 6563 686f 2022 2452  " -f2); echo "$R
+00014150: 554e 5f49 4453 2220 7c20 7465 6520 2f74  UN_IDS" | tee /t
+00014160: 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d 6964  mp/{name}-run-id
+00014170: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
+00014180: 2320 5465 726d 696e 6174 6520 7468 6520  # Terminate the 
+00014190: 636c 7573 7465 7220 6d61 6e75 616c 6c79  cluster manually
+000141a0: 2e0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+000141b0: 5468 6520 6063 6174 202e 2e2e 7c20 7265  The `cat ...| re
+000141c0: 7660 2069 7320 746f 2072 6574 7269 6576  v` is to retriev
+000141d0: 6520 7468 6520 6a6f 625f 6964 2066 726f  e the job_id fro
+000141e0: 6d20 7468 650a 2020 2020 2020 2020 2020  m the.          
+000141f0: 2020 2320 534b 5950 494c 4f54 5f54 4153    # SKYPILOT_TAS
+00014200: 4b5f 4944 2c20 7768 6963 6820 6765 7473  K_ID, which gets
+00014210: 2074 6865 2073 6563 6f6e 6420 746f 206c   the second to l
+00014220: 6173 7420 6669 656c 640a 2020 2020 2020  ast field.      
+00014230: 2020 2020 2020 2320 7365 7061 7261 7465        # separate
+00014240: 6420 6279 2060 2d60 2e0a 2020 2020 2020  d by `-`..      
+00014250: 2020 2020 2020 2866 2753 504f 545f 4a4f        (f'SPOT_JO
+00014260: 425f 4944 3d60 6361 7420 2f74 6d70 2f7b  B_ID=`cat /tmp/{
+00014270: 6e61 6d65 7d2d 7275 6e2d 6964 207c 2072  name}-run-id | r
+00014280: 6576 207c 2027 0a20 2020 2020 2020 2020  ev | '.         
+00014290: 2020 2020 2763 7574 202d 645c 272d 5c27      'cut -d\'-\'
+000142a0: 202d 6632 207c 2072 6576 603b 270a 2020   -f2 | rev`;'.  
+000142b0: 2020 2020 2020 2020 2020 2066 2761 7773             f'aws
+000142c0: 2065 6332 2074 6572 6d69 6e61 7465 2d69   ec2 terminate-i
+000142d0: 6e73 7461 6e63 6573 202d 2d72 6567 696f  nstances --regio
+000142e0: 6e20 7b72 6567 696f 6e7d 202d 2d69 6e73  n {region} --ins
+000142f0: 7461 6e63 652d 6964 7320 2428 270a 2020  tance-ids $('.  
+00014300: 2020 2020 2020 2020 2020 2066 2761 7773             f'aws
+00014310: 2065 6332 2064 6573 6372 6962 652d 696e   ec2 describe-in
+00014320: 7374 616e 6365 7320 2d2d 7265 6769 6f6e  stances --region
+00014330: 207b 7265 6769 6f6e 7d20 270a 2020 2020   {region} '.    
+00014340: 2020 2020 2020 2020 2027 2d2d 6669 6c74           '--filt
+00014350: 6572 7320 4e61 6d65 3d74 6167 3a72 6179  ers Name=tag:ray
+00014360: 2d63 6c75 7374 6572 2d6e 616d 652c 5661  -cluster-name,Va
+00014370: 6c75 6573 3d2a 2d24 7b53 504f 545f 4a4f  lues=*-${SPOT_JO
+00014380: 425f 4944 7d20 270a 2020 2020 2020 2020  B_ID} '.        
+00014390: 2020 2020 2066 272d 2d71 7565 7279 2052       f'--query R
+000143a0: 6573 6572 7661 7469 6f6e 735b 5d2e 496e  eservations[].In
+000143b0: 7374 616e 6365 735b 5d2e 496e 7374 616e  stances[].Instan
+000143c0: 6365 4964 2027 0a20 2020 2020 2020 2020  ceId '.         
+000143d0: 2020 2020 272d 2d6f 7574 7075 7420 7465      '--output te
+000143e0: 7874 2927 292c 0a20 2020 2020 2020 2020  xt)'),.         
+000143f0: 2020 2027 736c 6565 7020 3130 3027 2c0a     'sleep 100',.
+00014400: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+00014410: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
+00014420: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
+00014430: 6865 6164 202d 6e31 207c 2067 7265 7020  head -n1 | grep 
+00014440: 2252 4543 4f56 4552 494e 4722 272c 0a20  "RECOVERING"',. 
+00014450: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+00014460: 7020 3230 3027 2c0a 2020 2020 2020 2020  p 200',.        
+00014470: 2020 2020 6627 7b5f 5350 4f54 5f51 5545      f'{_SPOT_QUE
+00014480: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
+00014490: 6e61 6d65 7d20 7c20 6865 6164 202d 6e31  name} | head -n1
+000144a0: 207c 2067 7265 7020 2252 554e 4e49 4e47   | grep "RUNNING
+000144b0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+000144c0: 6627 5255 4e5f 4944 3d24 2863 6174 202f  f'RUN_ID=$(cat /
+000144d0: 746d 702f 7b6e 616d 657d 2d72 756e 2d69  tmp/{name}-run-i
+000144e0: 6429 3b20 6563 686f 2024 5255 4e5f 4944  d); echo $RUN_ID
+000144f0: 3b20 736b 7920 7370 6f74 206c 6f67 7320  ; sky spot logs 
+00014500: 2d6e 207b 6e61 6d65 7d20 2d2d 6e6f 2d66  -n {name} --no-f
+00014510: 6f6c 6c6f 7720 7c20 6772 6570 2053 4b59  ollow | grep SKY
+00014520: 5049 4c4f 545f 5441 534b 5f49 443a 207c  PILOT_TASK_ID: |
+00014530: 2067 7265 7020 2224 5255 4e5f 4944 2227   grep "$RUN_ID"'
+00014540: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00014550: 5255 4e5f 4944 533d 2428 736b 7920 7370  RUN_IDS=$(sky sp
+00014560: 6f74 206c 6f67 7320 2d6e 207b 6e61 6d65  ot logs -n {name
+00014570: 7d20 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20  } --no-follow | 
+00014580: 6772 6570 202d 4120 3420 534b 5950 494c  grep -A 4 SKYPIL
+00014590: 4f54 5f54 4153 4b5f 4944 5320 7c20 6375  OT_TASK_IDS | cu
+000145a0: 7420 2d64 2229 2220 2d66 3229 3b20 6563  t -d")" -f2); ec
+000145b0: 686f 2022 2452 554e 5f49 4453 2220 7c20  ho "$RUN_IDS" | 
+000145c0: 7465 6520 2f74 6d70 2f7b 6e61 6d65 7d2d  tee /tmp/{name}-
+000145d0: 7275 6e2d 6964 732d 6e65 7727 2c0a 2020  run-ids-new',.  
+000145e0: 2020 2020 2020 2020 2020 6627 6469 6666            f'diff
+000145f0: 202f 746d 702f 7b6e 616d 657d 2d72 756e   /tmp/{name}-run
+00014600: 2d69 6473 202f 746d 702f 7b6e 616d 657d  -ids /tmp/{name}
+00014610: 2d72 756e 2d69 6473 2d6e 6577 272c 0a20  -run-ids-new',. 
+00014620: 2020 2020 2020 2020 2020 2066 2763 6174             f'cat
+00014630: 202f 746d 702f 7b6e 616d 657d 2d72 756e   /tmp/{name}-run
+00014640: 2d69 6473 207c 2073 6564 202d 6e20 3270  -ids | sed -n 2p
+00014650: 207c 2067 7265 7020 6063 6174 202f 746d   | grep `cat /tm
+00014660: 702f 7b6e 616d 657d 2d72 756e 2d69 6460  p/{name}-run-id`
+00014670: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
+00014680: 2020 2020 2020 5f53 504f 545f 4341 4e43        _SPOT_CANC
+00014690: 454c 5f57 4149 542e 666f 726d 6174 286a  EL_WAIT.format(j
+000146a0: 6f62 5f6e 616d 653d 6e61 6d65 292c 0a20  ob_name=name),. 
+000146b0: 2020 2020 2020 2074 696d 656f 7574 3d32         timeout=2
+000146c0: 3520 2a20 3630 2c0a 2020 2020 290a 2020  5 * 60,.    ).  
+000146d0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+000146e0: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+000146f0: 6172 6b2e 6763 700a 4070 7974 6573 742e  ark.gcp.@pytest.
+00014700: 6d61 726b 2e6d 616e 6167 6564 5f73 706f  mark.managed_spo
+00014710: 740a 6465 6620 7465 7374 5f73 706f 745f  t.def test_spot_
+00014720: 7069 7065 6c69 6e65 5f72 6563 6f76 6572  pipeline_recover
+00014730: 795f 6763 7028 293a 0a20 2020 2022 2222  y_gcp():.    """
+00014740: 5465 7374 206d 616e 6167 6564 2073 706f  Test managed spo
+00014750: 7420 7265 636f 7665 7279 2066 6f72 2061  t recovery for a
+00014760: 2070 6970 656c 696e 652e 2222 220a 2020   pipeline.""".  
+00014770: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+00014780: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+00014790: 207a 6f6e 6520 3d20 2775 732d 6561 7374   zone = 'us-east
+000147a0: 342d 6227 0a20 2020 2071 7565 7279 5f63  4-b'.    query_c
+000147b0: 6d64 203d 2028 2767 636c 6f75 6420 636f  md = ('gcloud co
+000147c0: 6d70 7574 6520 696e 7374 616e 6365 7320  mpute instances 
+000147d0: 6c69 7374 202d 2d66 696c 7465 723d 270a  list --filter='.
+000147e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000147f0: 2027 2228 6c61 6265 6c73 2e72 6179 2d63   '"(labels.ray-c
+00014800: 6c75 7374 6572 2d6e 616d 653a 2a2d 247b  luster-name:*-${
+00014810: 5350 4f54 5f4a 4f42 5f49 447d 2922 2027  SPOT_JOB_ID})" '
+00014820: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014830: 2020 6627 2d2d 7a6f 6e65 733d 7b7a 6f6e    f'--zones={zon
+00014840: 657d 202d 2d66 6f72 6d61 743d 2276 616c  e} --format="val
+00014850: 7565 286e 616d 6529 2227 290a 2020 2020  ue(name)"').    
+00014860: 7465 726d 696e 6174 655f 636d 6420 3d20  terminate_cmd = 
+00014870: 2866 2767 636c 6f75 6420 636f 6d70 7574  (f'gcloud comput
+00014880: 6520 696e 7374 616e 6365 7320 6465 6c65  e instances dele
+00014890: 7465 202d 2d7a 6f6e 653d 7b7a 6f6e 657d  te --zone={zone}
+000148a0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+000148b0: 2020 2020 2020 2066 2720 2d2d 7175 6965         f' --quie
+000148c0: 7420 2428 7b71 7565 7279 5f63 6d64 7d29  t $({query_cmd})
+000148d0: 2729 0a20 2020 2074 6573 7420 3d20 5465  ').    test = Te
+000148e0: 7374 280a 2020 2020 2020 2020 2773 706f  st(.        'spo
+000148f0: 745f 7069 7065 6c69 6e65 5f72 6563 6f76  t_pipeline_recov
+00014900: 6572 795f 6763 7027 2c0a 2020 2020 2020  ery_gcp',.      
+00014910: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+00014920: 6627 736b 7920 7370 6f74 206c 6175 6e63  f'sky spot launc
+00014930: 6820 2d6e 207b 6e61 6d65 7d20 7465 7374  h -n {name} test
+00014940: 732f 7465 7374 5f79 616d 6c73 2f70 6970  s/test_yamls/pip
+00014950: 656c 696e 655f 6763 702e 7961 6d6c 2020  eline_gcp.yaml  
+00014960: 2d79 202d 6427 2c0a 2020 2020 2020 2020  -y -d',.        
+00014970: 2020 2020 2773 6c65 6570 2034 3030 272c      'sleep 400',
+00014980: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+00014990: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
+000149a0: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
+000149b0: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
+000149c0: 2022 5255 4e4e 494e 4722 272c 0a20 2020   "RUNNING"',.   
+000149d0: 2020 2020 2020 2020 2066 2752 554e 5f49           f'RUN_I
+000149e0: 443d 2428 736b 7920 7370 6f74 206c 6f67  D=$(sky spot log
+000149f0: 7320 2d6e 207b 6e61 6d65 7d20 2d2d 6e6f  s -n {name} --no
+00014a00: 2d66 6f6c 6c6f 7720 7c20 6772 6570 2053  -follow | grep S
+00014a10: 4b59 5049 4c4f 545f 5441 534b 5f49 443a  KYPILOT_TASK_ID:
+00014a20: 207c 2063 7574 202d 643a 202d 6632 293b   | cut -d: -f2);
+00014a30: 2065 6368 6f20 2224 5255 4e5f 4944 2220   echo "$RUN_ID" 
+00014a40: 7c20 7465 6520 2f74 6d70 2f7b 6e61 6d65  | tee /tmp/{name
+00014a50: 7d2d 7275 6e2d 6964 272c 0a20 2020 2020  }-run-id',.     
+00014a60: 2020 2020 2020 2066 2752 554e 5f49 4453         f'RUN_IDS
+00014a70: 3d24 2873 6b79 2073 706f 7420 6c6f 6773  =$(sky spot logs
+00014a80: 202d 6e20 7b6e 616d 657d 202d 2d6e 6f2d   -n {name} --no-
+00014a90: 666f 6c6c 6f77 207c 2067 7265 7020 2d41  follow | grep -A
+00014aa0: 2034 2053 4b59 5049 4c4f 545f 5441 534b   4 SKYPILOT_TASK
+00014ab0: 5f49 4453 207c 2063 7574 202d 6422 2922  _IDS | cut -d")"
+00014ac0: 202d 6632 293b 2065 6368 6f20 2224 5255   -f2); echo "$RU
+00014ad0: 4e5f 4944 5322 207c 2074 6565 202f 746d  N_IDS" | tee /tm
+00014ae0: 702f 7b6e 616d 657d 2d72 756e 2d69 6473  p/{name}-run-ids
+00014af0: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
+00014b00: 2054 6572 6d69 6e61 7465 2074 6865 2063   Terminate the c
+00014b10: 6c75 7374 6572 206d 616e 7561 6c6c 792e  luster manually.
+00014b20: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
+00014b30: 6865 2060 6361 7420 2e2e 2e7c 2072 6576  he `cat ...| rev
+00014b40: 6020 6973 2074 6f20 7265 7472 6965 7665  ` is to retrieve
+00014b50: 2074 6865 206a 6f62 5f69 6420 6672 6f6d   the job_id from
+00014b60: 2074 6865 0a20 2020 2020 2020 2020 2020   the.           
+00014b70: 2023 2053 4b59 5049 4c4f 545f 5441 534b   # SKYPILOT_TASK
+00014b80: 5f49 442c 2077 6869 6368 2067 6574 7320  _ID, which gets 
+00014b90: 7468 6520 7365 636f 6e64 2074 6f20 6c61  the second to la
+00014ba0: 7374 2066 6965 6c64 0a20 2020 2020 2020  st field.       
+00014bb0: 2020 2020 2023 2073 6570 6172 6174 6564       # separated
+00014bc0: 2062 7920 602d 602e 0a20 2020 2020 2020   by `-`..       
+00014bd0: 2020 2020 2028 6627 5350 4f54 5f4a 4f42       (f'SPOT_JOB
+00014be0: 5f49 443d 6063 6174 202f 746d 702f 7b6e  _ID=`cat /tmp/{n
+00014bf0: 616d 657d 2d72 756e 2d69 6420 7c20 7265  ame}-run-id | re
+00014c00: 7620 7c20 270a 2020 2020 2020 2020 2020  v | '.          
+00014c10: 2020 2066 2763 7574 202d 645c 272d 5c27     f'cut -d\'-\'
+00014c20: 202d 6632 207c 2072 6576 603b 7b74 6572   -f2 | rev`;{ter
+00014c30: 6d69 6e61 7465 5f63 6d64 7d27 292c 0a20  minate_cmd}'),. 
+00014c40: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+00014c50: 7020 3130 3027 2c0a 2020 2020 2020 2020  p 100',.        
+00014c60: 2020 2020 6627 7b5f 5350 4f54 5f51 5545      f'{_SPOT_QUE
+00014c70: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
+00014c80: 6e61 6d65 7d20 7c20 6865 6164 202d 6e31  name} | head -n1
+00014c90: 207c 2067 7265 7020 2252 4543 4f56 4552   | grep "RECOVER
+00014ca0: 494e 4722 272c 0a20 2020 2020 2020 2020  ING"',.         
+00014cb0: 2020 2027 736c 6565 7020 3230 3027 2c0a     'sleep 200',.
+00014cc0: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+00014cd0: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
+00014ce0: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
+00014cf0: 6865 6164 202d 6e31 207c 2067 7265 7020  head -n1 | grep 
+00014d00: 2252 554e 4e49 4e47 2227 2c0a 2020 2020  "RUNNING"',.    
+00014d10: 2020 2020 2020 2020 6627 5255 4e5f 4944          f'RUN_ID
+00014d20: 3d24 2863 6174 202f 746d 702f 7b6e 616d  =$(cat /tmp/{nam
+00014d30: 657d 2d72 756e 2d69 6429 3b20 6563 686f  e}-run-id); echo
+00014d40: 2024 5255 4e5f 4944 3b20 736b 7920 7370   $RUN_ID; sky sp
+00014d50: 6f74 206c 6f67 7320 2d6e 207b 6e61 6d65  ot logs -n {name
+00014d60: 7d20 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20  } --no-follow | 
+00014d70: 6772 6570 2053 4b59 5049 4c4f 545f 5441  grep SKYPILOT_TA
+00014d80: 534b 5f49 443a 207c 2067 7265 7020 2224  SK_ID: | grep "$
+00014d90: 5255 4e5f 4944 2227 2c0a 2020 2020 2020  RUN_ID"',.      
+00014da0: 2020 2020 2020 6627 5255 4e5f 4944 533d        f'RUN_IDS=
+00014db0: 2428 736b 7920 7370 6f74 206c 6f67 7320  $(sky spot logs 
+00014dc0: 2d6e 207b 6e61 6d65 7d20 2d2d 6e6f 2d66  -n {name} --no-f
+00014dd0: 6f6c 6c6f 7720 7c20 6772 6570 202d 4120  ollow | grep -A 
+00014de0: 3420 534b 5950 494c 4f54 5f54 4153 4b5f  4 SKYPILOT_TASK_
+00014df0: 4944 5320 7c20 6375 7420 2d64 2229 2220  IDS | cut -d")" 
+00014e00: 2d66 3229 3b20 6563 686f 2022 2452 554e  -f2); echo "$RUN
+00014e10: 5f49 4453 2220 7c20 7465 6520 2f74 6d70  _IDS" | tee /tmp
+00014e20: 2f7b 6e61 6d65 7d2d 7275 6e2d 6964 732d  /{name}-run-ids-
+00014e30: 6e65 7727 2c0a 2020 2020 2020 2020 2020  new',.          
+00014e40: 2020 6627 6469 6666 202f 746d 702f 7b6e    f'diff /tmp/{n
+00014e50: 616d 657d 2d72 756e 2d69 6473 202f 746d  ame}-run-ids /tm
+00014e60: 702f 7b6e 616d 657d 2d72 756e 2d69 6473  p/{name}-run-ids
+00014e70: 2d6e 6577 272c 0a20 2020 2020 2020 2020  -new',.         
+00014e80: 2020 2066 2763 6174 202f 746d 702f 7b6e     f'cat /tmp/{n
+00014e90: 616d 657d 2d72 756e 2d69 6473 207c 2073  ame}-run-ids | s
+00014ea0: 6564 202d 6e20 3270 207c 2067 7265 7020  ed -n 2p | grep 
+00014eb0: 6063 6174 202f 746d 702f 7b6e 616d 657d  `cat /tmp/{name}
+00014ec0: 2d72 756e 2d69 6460 272c 0a20 2020 2020  -run-id`',.     
+00014ed0: 2020 205d 2c0a 2020 2020 2020 2020 5f53     ],.        _S
+00014ee0: 504f 545f 4341 4e43 454c 5f57 4149 542e  POT_CANCEL_WAIT.
+00014ef0: 666f 726d 6174 286a 6f62 5f6e 616d 653d  format(job_name=
+00014f00: 6e61 6d65 292c 0a20 2020 2020 2020 2074  name),.        t
+00014f10: 696d 656f 7574 3d32 3520 2a20 3630 2c0a  imeout=25 * 60,.
+00014f20: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+00014f30: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
+00014f40: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f6c  pytest.mark.no_l
+00014f50: 616d 6264 615f 636c 6f75 6420 2023 204c  ambda_cloud  # L
+00014f60: 616d 6264 6120 436c 6f75 6420 646f 6573  ambda Cloud does
+00014f70: 206e 6f74 2073 7570 706f 7274 2073 706f   not support spo
+00014f80: 7420 696e 7374 616e 6365 730a 4070 7974  t instances.@pyt
+00014f90: 6573 742e 6d61 726b 2e6e 6f5f 6962 6d20  est.mark.no_ibm 
+00014fa0: 2023 2049 424d 2043 6c6f 7564 2064 6f65   # IBM Cloud doe
+00014fb0: 7320 6e6f 7420 7375 7070 6f72 7420 7370  s not support sp
+00014fc0: 6f74 2069 6e73 7461 6e63 6573 0a40 7079  ot instances.@py
+00014fd0: 7465 7374 2e6d 6172 6b2e 6e6f 5f73 6370  test.mark.no_scp
+00014fe0: 2020 2320 5343 5020 646f 6573 206e 6f74    # SCP does not
+00014ff0: 2073 7570 706f 7274 2073 706f 7420 696e   support spot in
+00015000: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
+00015010: 6d61 726b 2e6e 6f5f 6b75 6265 726e 6574  mark.no_kubernet
+00015020: 6573 2020 2320 4b75 6265 726e 6574 6573  es  # Kubernetes
+00015030: 2064 6f65 7320 6e6f 7420 6861 7665 2061   does not have a
+00015040: 206e 6f74 696f 6e20 6f66 2073 706f 7420   notion of spot 
+00015050: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
+00015060: 742e 6d61 726b 2e6d 616e 6167 6564 5f73  t.mark.managed_s
+00015070: 706f 740a 6465 6620 7465 7374 5f73 706f  pot.def test_spo
+00015080: 745f 7265 636f 7665 7279 5f64 6566 6175  t_recovery_defau
+00015090: 6c74 5f72 6573 6f75 7263 6573 2867 656e  lt_resources(gen
+000150a0: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
+000150b0: 3a0a 2020 2020 2222 2254 6573 7420 6d61  :.    """Test ma
+000150c0: 6e61 6765 6420 7370 6f74 2072 6563 6f76  naged spot recov
+000150d0: 6572 7920 666f 7220 6465 6661 756c 7420  ery for default 
+000150e0: 7265 736f 7572 6365 732e 2222 220a 2020  resources.""".  
+000150f0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+00015100: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+00015110: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+00015120: 2020 2020 2020 276d 616e 6167 6564 2d73        'managed-s
+00015130: 706f 742d 7265 636f 7665 7279 2d64 6566  pot-recovery-def
+00015140: 6175 6c74 2d72 6573 6f75 7263 6573 272c  ault-resources',
+00015150: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+00015160: 2020 2020 2020 2066 2773 6b79 2073 706f         f'sky spo
+00015170: 7420 6c61 756e 6368 202d 6e20 7b6e 616d  t launch -n {nam
+00015180: 657d 202d 2d63 6c6f 7564 207b 6765 6e65  e} --cloud {gene
+00015190: 7269 635f 636c 6f75 647d 2022 736c 6565  ric_cloud} "slee
+000151a0: 7020 3330 2026 2620 7375 646f 2073 6875  p 30 && sudo shu
+000151b0: 7464 6f77 6e20 6e6f 7720 2626 2073 6c65  tdown now && sle
+000151c0: 6570 2031 3030 3022 202d 7920 2d64 272c  ep 1000" -y -d',
+000151d0: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+000151e0: 6565 7020 3336 3027 2c0a 2020 2020 2020  eep 360',.      
+000151f0: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
+00015200: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
+00015210: 207b 6e61 6d65 7d20 7c20 6865 6164 202d   {name} | head -
+00015220: 6e31 207c 2067 7265 7020 2252 554e 4e49  n1 | grep "RUNNI
+00015230: 4e47 5c7c 5245 434f 5645 5249 4e47 2227  NG\|RECOVERING"'
+00015240: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
+00015250: 2020 2020 205f 5350 4f54 5f43 414e 4345       _SPOT_CANCE
+00015260: 4c5f 5741 4954 2e66 6f72 6d61 7428 6a6f  L_WAIT.format(jo
+00015270: 625f 6e61 6d65 3d6e 616d 6529 2c0a 2020  b_name=name),.  
+00015280: 2020 2020 2020 7469 6d65 6f75 743d 3235        timeout=25
+00015290: 202a 2036 302c 0a20 2020 2029 0a20 2020   * 60,.    ).   
+000152a0: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+000152b0: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
+000152c0: 726b 2e61 7773 0a40 7079 7465 7374 2e6d  rk.aws.@pytest.m
+000152d0: 6172 6b2e 6d61 6e61 6765 645f 7370 6f74  ark.managed_spot
+000152e0: 0a64 6566 2074 6573 745f 7370 6f74 5f72  .def test_spot_r
+000152f0: 6563 6f76 6572 795f 6d75 6c74 695f 6e6f  ecovery_multi_no
+00015300: 6465 5f61 7773 2861 7773 5f63 6f6e 6669  de_aws(aws_confi
+00015310: 675f 7265 6769 6f6e 293a 0a20 2020 2022  g_region):.    "
+00015320: 2222 5465 7374 206d 616e 6167 6564 2073  ""Test managed s
+00015330: 706f 7420 7265 636f 7665 7279 2e22 2222  pot recovery."""
+00015340: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+00015350: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+00015360: 2020 2020 7265 6769 6f6e 203d 2061 7773      region = aws
+00015370: 5f63 6f6e 6669 675f 7265 6769 6f6e 0a20  _config_region. 
+00015380: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+00015390: 2020 2020 2020 2020 2773 706f 745f 7265          'spot_re
+000153a0: 636f 7665 7279 5f6d 756c 7469 5f6e 6f64  covery_multi_nod
+000153b0: 655f 6177 7327 2c0a 2020 2020 2020 2020  e_aws',.        
+000153c0: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+000153d0: 736b 7920 7370 6f74 206c 6175 6e63 6820  sky spot launch 
+000153e0: 2d2d 636c 6f75 6420 6177 7320 2d2d 7265  --cloud aws --re
+000153f0: 6769 6f6e 207b 7265 6769 6f6e 7d20 2d6e  gion {region} -n
+00015400: 207b 6e61 6d65 7d20 2d2d 6e75 6d2d 6e6f   {name} --num-no
+00015410: 6465 7320 3220 2265 6368 6f20 534b 5950  des 2 "echo SKYP
+00015420: 494c 4f54 5f54 4153 4b5f 4944 3a20 5c24  ILOT_TASK_ID: \$
+00015430: 534b 5950 494c 4f54 5f54 4153 4b5f 4944  SKYPILOT_TASK_ID
+00015440: 3b20 736c 6565 7020 3138 3030 2220 202d  ; sleep 1800"  -
+00015450: 7920 2d64 272c 0a20 2020 2020 2020 2020  y -d',.         
+00015460: 2020 2027 736c 6565 7020 3435 3027 2c0a     'sleep 450',.
+00015470: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+00015480: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
+00015490: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
+000154a0: 6865 6164 202d 6e31 207c 2067 7265 7020  head -n1 | grep 
+000154b0: 2252 554e 4e49 4e47 2227 2c0a 2020 2020  "RUNNING"',.    
+000154c0: 2020 2020 2020 2020 6627 5255 4e5f 4944          f'RUN_ID
+000154d0: 3d24 2873 6b79 2073 706f 7420 6c6f 6773  =$(sky spot logs
+000154e0: 202d 6e20 7b6e 616d 657d 202d 2d6e 6f2d   -n {name} --no-
+000154f0: 666f 6c6c 6f77 207c 2067 7265 7020 534b  follow | grep SK
+00015500: 5950 494c 4f54 5f54 4153 4b5f 4944 207c  YPILOT_TASK_ID |
+00015510: 2063 7574 202d 643a 202d 6632 293b 2065   cut -d: -f2); e
+00015520: 6368 6f20 2224 5255 4e5f 4944 2220 7c20  cho "$RUN_ID" | 
+00015530: 7465 6520 2f74 6d70 2f7b 6e61 6d65 7d2d  tee /tmp/{name}-
+00015540: 7275 6e2d 6964 272c 0a20 2020 2020 2020  run-id',.       
+00015550: 2020 2020 2023 2054 6572 6d69 6e61 7465       # Terminate
+00015560: 2074 6865 2077 6f72 6b65 7220 6d61 6e75   the worker manu
+00015570: 616c 6c79 2e0a 2020 2020 2020 2020 2020  ally..          
+00015580: 2020 2866 2761 7773 2065 6332 2074 6572    (f'aws ec2 ter
+00015590: 6d69 6e61 7465 2d69 6e73 7461 6e63 6573  minate-instances
+000155a0: 202d 2d72 6567 696f 6e20 7b72 6567 696f   --region {regio
+000155b0: 6e7d 202d 2d69 6e73 7461 6e63 652d 6964  n} --instance-id
+000155c0: 7320 2428 270a 2020 2020 2020 2020 2020  s $('.          
+000155d0: 2020 2066 2761 7773 2065 6332 2064 6573     f'aws ec2 des
+000155e0: 6372 6962 652d 696e 7374 616e 6365 7320  cribe-instances 
+000155f0: 2d2d 7265 6769 6f6e 207b 7265 6769 6f6e  --region {region
+00015600: 7d20 270a 2020 2020 2020 2020 2020 2020  } '.            
+00015610: 2066 272d 2d66 696c 7465 7273 204e 616d   f'--filters Nam
+00015620: 653d 7461 673a 7261 792d 636c 7573 7465  e=tag:ray-cluste
+00015630: 722d 6e61 6d65 2c56 616c 7565 733d 7b6e  r-name,Values={n
+00015640: 616d 657d 2a20 270a 2020 2020 2020 2020  ame}* '.        
+00015650: 2020 2020 2027 4e61 6d65 3d74 6167 3a72       'Name=tag:r
+00015660: 6179 2d6e 6f64 652d 7479 7065 2c56 616c  ay-node-type,Val
+00015670: 7565 733d 776f 726b 6572 2027 0a20 2020  ues=worker '.   
+00015680: 2020 2020 2020 2020 2020 6627 2d2d 7175            f'--qu
+00015690: 6572 7920 5265 7365 7276 6174 696f 6e73  ery Reservations
+000156a0: 5b5d 2e49 6e73 7461 6e63 6573 5b5d 2e49  [].Instances[].I
+000156b0: 6e73 7461 6e63 6549 6420 270a 2020 2020  nstanceId '.    
+000156c0: 2020 2020 2020 2020 2027 2d2d 6f75 7470           '--outp
+000156d0: 7574 2074 6578 7429 2729 2c0a 2020 2020  ut text)'),.    
+000156e0: 2020 2020 2020 2020 2773 6c65 6570 2035          'sleep 5
+000156f0: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
+00015700: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
+00015710: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
+00015720: 7d20 7c20 6865 6164 202d 6e31 207c 2067  } | head -n1 | g
+00015730: 7265 7020 2252 4543 4f56 4552 494e 4722  rep "RECOVERING"
+00015740: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
+00015750: 736c 6565 7020 3536 3027 2c0a 2020 2020  sleep 560',.    
+00015760: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
+00015770: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
+00015780: 6570 207b 6e61 6d65 7d20 7c20 6865 6164  ep {name} | head
+00015790: 202d 6e31 207c 2067 7265 7020 2252 554e   -n1 | grep "RUN
+000157a0: 4e49 4e47 2227 2c0a 2020 2020 2020 2020  NING"',.        
+000157b0: 2020 2020 6627 5255 4e5f 4944 3d24 2863      f'RUN_ID=$(c
+000157c0: 6174 202f 746d 702f 7b6e 616d 657d 2d72  at /tmp/{name}-r
+000157d0: 756e 2d69 6429 3b20 6563 686f 2024 5255  un-id); echo $RU
+000157e0: 4e5f 4944 3b20 736b 7920 7370 6f74 206c  N_ID; sky spot l
+000157f0: 6f67 7320 2d6e 207b 6e61 6d65 7d20 2d2d  ogs -n {name} --
+00015800: 6e6f 2d66 6f6c 6c6f 7720 7c20 6772 6570  no-follow | grep
+00015810: 2053 4b59 5049 4c4f 545f 5441 534b 5f49   SKYPILOT_TASK_I
+00015820: 4420 7c20 6375 7420 2d64 3a20 2d66 3220  D | cut -d: -f2 
+00015830: 7c20 6772 6570 2022 2452 554e 5f49 4422  | grep "$RUN_ID"
+00015840: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
+00015850: 2020 2020 2020 5f53 504f 545f 4341 4e43        _SPOT_CANC
+00015860: 454c 5f57 4149 542e 666f 726d 6174 286a  EL_WAIT.format(j
+00015870: 6f62 5f6e 616d 653d 6e61 6d65 292c 0a20  ob_name=name),. 
+00015880: 2020 2020 2020 2074 696d 656f 7574 3d33         timeout=3
+00015890: 3020 2a20 3630 2c0a 2020 2020 290a 2020  0 * 60,.    ).  
+000158a0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+000158b0: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+000158c0: 6172 6b2e 6763 700a 4070 7974 6573 742e  ark.gcp.@pytest.
+000158d0: 6d61 726b 2e6d 616e 6167 6564 5f73 706f  mark.managed_spo
+000158e0: 740a 6465 6620 7465 7374 5f73 706f 745f  t.def test_spot_
+000158f0: 7265 636f 7665 7279 5f6d 756c 7469 5f6e  recovery_multi_n
+00015900: 6f64 655f 6763 7028 293a 0a20 2020 2022  ode_gcp():.    "
+00015910: 2222 5465 7374 206d 616e 6167 6564 2073  ""Test managed s
+00015920: 706f 7420 7265 636f 7665 7279 2e22 2222  pot recovery."""
+00015930: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+00015940: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+00015950: 2020 2020 7a6f 6e65 203d 2027 7573 2d77      zone = 'us-w
+00015960: 6573 7432 2d61 270a 2020 2020 2320 5573  est2-a'.    # Us
+00015970: 6520 273a 2720 746f 206d 6174 6368 2061  e ':' to match a
+00015980: 7320 7468 6520 636c 7573 7465 7220 6e61  s the cluster na
+00015990: 6d65 2077 696c 6c20 636f 6e74 6169 6e20  me will contain 
+000159a0: 7468 6520 7375 6666 6978 2077 6974 6820  the suffix with 
+000159b0: 6a6f 6220 6964 0a20 2020 2071 7565 7279  job id.    query
+000159c0: 5f63 6d64 203d 2028 0a20 2020 2020 2020  _cmd = (.       
+000159d0: 2066 2767 636c 6f75 6420 636f 6d70 7574   f'gcloud comput
+000159e0: 6520 696e 7374 616e 6365 7320 6c69 7374  e instances list
+000159f0: 202d 2d66 696c 7465 723d 270a 2020 2020   --filter='.    
+00015a00: 2020 2020 6627 2228 6c61 6265 6c73 2e72      f'"(labels.r
+00015a10: 6179 2d63 6c75 7374 6572 2d6e 616d 653a  ay-cluster-name:
+00015a20: 7b6e 616d 657d 2041 4e44 206c 6162 656c  {name} AND label
+00015a30: 732e 7261 792d 6e6f 6465 2d74 7970 653d  s.ray-node-type=
+00015a40: 776f 726b 6572 2922 2027 0a20 2020 2020  worker)" '.     
+00015a50: 2020 2066 272d 2d7a 6f6e 6573 3d7b 7a6f     f'--zones={zo
+00015a60: 6e65 7d20 2d2d 666f 726d 6174 3d22 7661  ne} --format="va
+00015a70: 6c75 6528 6e61 6d65 2922 2729 0a20 2020  lue(name)"').   
+00015a80: 2074 6572 6d69 6e61 7465 5f63 6d64 203d   terminate_cmd =
+00015a90: 2028 6627 6763 6c6f 7564 2063 6f6d 7075   (f'gcloud compu
+00015aa0: 7465 2069 6e73 7461 6e63 6573 2064 656c  te instances del
+00015ab0: 6574 6520 2d2d 7a6f 6e65 3d7b 7a6f 6e65  ete --zone={zone
+00015ac0: 7d27 0a20 2020 2020 2020 2020 2020 2020  }'.             
+00015ad0: 2020 2020 2020 2020 6627 202d 2d71 7569          f' --qui
+00015ae0: 6574 2024 287b 7175 6572 795f 636d 647d  et $({query_cmd}
+00015af0: 2927 290a 2020 2020 7465 7374 203d 2054  )').    test = T
+00015b00: 6573 7428 0a20 2020 2020 2020 2027 7370  est(.        'sp
+00015b10: 6f74 5f72 6563 6f76 6572 795f 6d75 6c74  ot_recovery_mult
+00015b20: 695f 6e6f 6465 5f67 6370 272c 0a20 2020  i_node_gcp',.   
+00015b30: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+00015b40: 2020 2066 2773 6b79 2073 706f 7420 6c61     f'sky spot la
+00015b50: 756e 6368 202d 2d63 6c6f 7564 2067 6370  unch --cloud gcp
+00015b60: 202d 2d7a 6f6e 6520 7b7a 6f6e 657d 202d   --zone {zone} -
+00015b70: 6e20 7b6e 616d 657d 202d 2d6e 756d 2d6e  n {name} --num-n
+00015b80: 6f64 6573 2032 2022 6563 686f 2053 4b59  odes 2 "echo SKY
+00015b90: 5049 4c4f 545f 5441 534b 5f49 443a 205c  PILOT_TASK_ID: \
+00015ba0: 2453 4b59 5049 4c4f 545f 5441 534b 5f49  $SKYPILOT_TASK_I
+00015bb0: 443b 2073 6c65 6570 2031 3830 3022 2020  D; sleep 1800"  
+00015bc0: 2d79 202d 6427 2c0a 2020 2020 2020 2020  -y -d',.        
+00015bd0: 2020 2020 2773 6c65 6570 2034 3030 272c      'sleep 400',
+00015be0: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+00015bf0: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
+00015c00: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
+00015c10: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
+00015c20: 2022 5255 4e4e 494e 4722 272c 0a20 2020   "RUNNING"',.   
+00015c30: 2020 2020 2020 2020 2066 2752 554e 5f49           f'RUN_I
+00015c40: 443d 2428 736b 7920 7370 6f74 206c 6f67  D=$(sky spot log
+00015c50: 7320 2d6e 207b 6e61 6d65 7d20 2d2d 6e6f  s -n {name} --no
+00015c60: 2d66 6f6c 6c6f 7720 7c20 6772 6570 2053  -follow | grep S
+00015c70: 4b59 5049 4c4f 545f 5441 534b 5f49 4420  KYPILOT_TASK_ID 
+00015c80: 7c20 6375 7420 2d64 3a20 2d66 3229 3b20  | cut -d: -f2); 
+00015c90: 6563 686f 2022 2452 554e 5f49 4422 207c  echo "$RUN_ID" |
+00015ca0: 2074 6565 202f 746d 702f 7b6e 616d 657d   tee /tmp/{name}
+00015cb0: 2d72 756e 2d69 6427 2c0a 2020 2020 2020  -run-id',.      
+00015cc0: 2020 2020 2020 2320 5465 726d 696e 6174        # Terminat
+00015cd0: 6520 7468 6520 776f 726b 6572 206d 616e  e the worker man
+00015ce0: 7561 6c6c 792e 0a20 2020 2020 2020 2020  ually..         
+00015cf0: 2020 2074 6572 6d69 6e61 7465 5f63 6d64     terminate_cmd
+00015d00: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
+00015d10: 6c65 6570 2035 3027 2c0a 2020 2020 2020  leep 50',.      
+00015d20: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
+00015d30: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
+00015d40: 207b 6e61 6d65 7d20 7c20 6865 6164 202d   {name} | head -
+00015d50: 6e31 207c 2067 7265 7020 2252 4543 4f56  n1 | grep "RECOV
+00015d60: 4552 494e 4722 272c 0a20 2020 2020 2020  ERING"',.       
+00015d70: 2020 2020 2027 736c 6565 7020 3432 3027       'sleep 420'
+00015d80: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00015d90: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
+00015da0: 547d 7c20 6772 6570 207b 6e61 6d65 7d20  T}| grep {name} 
+00015db0: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
+00015dc0: 7020 2252 554e 4e49 4e47 2227 2c0a 2020  p "RUNNING"',.  
+00015dd0: 2020 2020 2020 2020 2020 6627 5255 4e5f            f'RUN_
+00015de0: 4944 3d24 2863 6174 202f 746d 702f 7b6e  ID=$(cat /tmp/{n
+00015df0: 616d 657d 2d72 756e 2d69 6429 3b20 6563  ame}-run-id); ec
+00015e00: 686f 2024 5255 4e5f 4944 3b20 736b 7920  ho $RUN_ID; sky 
+00015e10: 7370 6f74 206c 6f67 7320 2d6e 207b 6e61  spot logs -n {na
+00015e20: 6d65 7d20 2d2d 6e6f 2d66 6f6c 6c6f 7720  me} --no-follow 
+00015e30: 7c20 6772 6570 2053 4b59 5049 4c4f 545f  | grep SKYPILOT_
+00015e40: 5441 534b 5f49 4420 7c20 6375 7420 2d64  TASK_ID | cut -d
+00015e50: 3a20 2d66 3220 7c20 6772 6570 2022 2452  : -f2 | grep "$R
+00015e60: 554e 5f49 4422 272c 0a20 2020 2020 2020  UN_ID"',.       
+00015e70: 205d 2c0a 2020 2020 2020 2020 5f53 504f   ],.        _SPO
+00015e80: 545f 4341 4e43 454c 5f57 4149 542e 666f  T_CANCEL_WAIT.fo
+00015e90: 726d 6174 286a 6f62 5f6e 616d 653d 6e61  rmat(job_name=na
+00015ea0: 6d65 292c 0a20 2020 2020 2020 2074 696d  me),.        tim
+00015eb0: 656f 7574 3d32 3520 2a20 3630 2c0a 2020  eout=25 * 60,.  
+00015ec0: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
+00015ed0: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
+00015ee0: 7465 7374 2e6d 6172 6b2e 6177 730a 4070  test.mark.aws.@p
+00015ef0: 7974 6573 742e 6d61 726b 2e6d 616e 6167  ytest.mark.manag
+00015f00: 6564 5f73 706f 740a 6465 6620 7465 7374  ed_spot.def test
+00015f10: 5f73 706f 745f 6361 6e63 656c 6c61 7469  _spot_cancellati
+00015f20: 6f6e 5f61 7773 2861 7773 5f63 6f6e 6669  on_aws(aws_confi
+00015f30: 675f 7265 6769 6f6e 293a 0a20 2020 206e  g_region):.    n
+00015f40: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
+00015f50: 6572 5f6e 616d 6528 290a 2020 2020 7265  er_name().    re
+00015f60: 6769 6f6e 203d 2061 7773 5f63 6f6e 6669  gion = aws_confi
+00015f70: 675f 7265 6769 6f6e 0a20 2020 2074 6573  g_region.    tes
+00015f80: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+00015f90: 2020 2773 706f 745f 6361 6e63 656c 6c61    'spot_cancella
+00015fa0: 7469 6f6e 5f61 7773 272c 0a20 2020 2020  tion_aws',.     
+00015fb0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+00015fc0: 2023 2054 6573 7420 6361 6e63 656c 6c61   # Test cancella
+00015fd0: 7469 6f6e 2064 7572 696e 6720 7370 6f74  tion during spot
+00015fe0: 2063 6c75 7374 6572 2062 6569 6e67 206c   cluster being l
+00015ff0: 6175 6e63 6865 642e 0a20 2020 2020 2020  aunched..       
+00016000: 2020 2020 2066 2773 6b79 2073 706f 7420       f'sky spot 
+00016010: 6c61 756e 6368 202d 2d63 6c6f 7564 2061  launch --cloud a
+00016020: 7773 202d 2d72 6567 696f 6e20 7b72 6567  ws --region {reg
+00016030: 696f 6e7d 202d 6e20 7b6e 616d 657d 2022  ion} -n {name} "
+00016040: 736c 6565 7020 3130 3030 2220 202d 7920  sleep 1000"  -y 
+00016050: 2d64 272c 0a20 2020 2020 2020 2020 2020  -d',.           
+00016060: 2027 736c 6565 7020 3630 272c 0a20 2020   'sleep 60',.   
+00016070: 2020 2020 2020 2020 2066 277b 5f53 504f           f'{_SPO
+00016080: 545f 5155 4555 455f 5741 4954 7d7c 2067  T_QUEUE_WAIT}| g
+00016090: 7265 7020 7b6e 616d 657d 207c 2068 6561  rep {name} | hea
+000160a0: 6420 2d6e 3120 7c20 6772 6570 2022 5354  d -n1 | grep "ST
+000160b0: 4152 5449 4e47 2227 2c0a 2020 2020 2020  ARTING"',.      
+000160c0: 2020 2020 2020 5f53 504f 545f 4341 4e43        _SPOT_CANC
+000160d0: 454c 5f57 4149 542e 666f 726d 6174 286a  EL_WAIT.format(j
+000160e0: 6f62 5f6e 616d 653d 6e61 6d65 292c 0a20  ob_name=name),. 
+000160f0: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+00016100: 7020 3527 2c0a 2020 2020 2020 2020 2020  p 5',.          
+00016110: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
+00016120: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
+00016130: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
+00016140: 2067 7265 7020 2243 414e 4345 4c4c 494e   grep "CANCELLIN
+00016150: 475c 7c43 414e 4345 4c4c 4544 2227 2c0a  G\|CANCELLED"',.
+00016160: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+00016170: 6570 2031 3230 272c 0a20 2020 2020 2020  ep 120',.       
+00016180: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
+00016190: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
+000161a0: 7b6e 616d 657d 207c 2068 6561 6420 2d6e  {name} | head -n
+000161b0: 3120 7c20 6772 6570 2022 4341 4e43 454c  1 | grep "CANCEL
+000161c0: 4c45 4422 272c 0a20 2020 2020 2020 2020  LED"',.         
+000161d0: 2020 2028 6627 733d 2428 6177 7320 6563     (f's=$(aws ec
+000161e0: 3220 6465 7363 7269 6265 2d69 6e73 7461  2 describe-insta
+000161f0: 6e63 6573 202d 2d72 6567 696f 6e20 7b72  nces --region {r
+00016200: 6567 696f 6e7d 2027 0a20 2020 2020 2020  egion} '.       
+00016210: 2020 2020 2020 6627 2d2d 6669 6c74 6572        f'--filter
+00016220: 7320 4e61 6d65 3d74 6167 3a72 6179 2d63  s Name=tag:ray-c
+00016230: 6c75 7374 6572 2d6e 616d 652c 5661 6c75  luster-name,Valu
+00016240: 6573 3d7b 6e61 6d65 7d2d 2a20 270a 2020  es={name}-* '.  
+00016250: 2020 2020 2020 2020 2020 2066 272d 2d71             f'--q
+00016260: 7565 7279 2052 6573 6572 7661 7469 6f6e  uery Reservation
+00016270: 735b 5d2e 496e 7374 616e 6365 735b 5d2e  s[].Instances[].
+00016280: 5374 6174 655b 5d2e 4e61 6d65 2027 0a20  State[].Name '. 
+00016290: 2020 2020 2020 2020 2020 2020 272d 2d6f              '--o
+000162a0: 7574 7075 7420 7465 7874 2920 2626 2065  utput text) && e
+000162b0: 6368 6f20 2224 7322 2026 2620 6563 686f  cho "$s" && echo
+000162c0: 3b20 5b5b 202d 7a20 2224 7322 205d 5d20  ; [[ -z "$s" ]] 
+000162d0: 7c7c 205b 5b20 2224 7322 203d 2022 7465  || [[ "$s" = "te
+000162e0: 726d 696e 6174 6564 2220 5d5d 207c 7c20  rminated" ]] || 
+000162f0: 5b5b 2022 2473 2220 3d20 2273 6875 7474  [[ "$s" = "shutt
+00016300: 696e 672d 646f 776e 2220 5d5d 270a 2020  ing-down" ]]'.  
+00016310: 2020 2020 2020 2020 2020 292c 0a20 2020            ),.   
+00016320: 2020 2020 2020 2020 2023 2054 6573 7420           # Test 
+00016330: 6361 6e63 656c 6c69 6e67 2074 6865 2073  cancelling the s
+00016340: 706f 7420 636c 7573 7465 7220 6475 7269  pot cluster duri
+00016350: 6e67 2073 706f 7420 6a6f 6220 6265 696e  ng spot job bein
+00016360: 6720 7365 7475 702e 0a20 2020 2020 2020  g setup..       
+00016370: 2020 2020 2066 2773 6b79 2073 706f 7420       f'sky spot 
+00016380: 6c61 756e 6368 202d 2d63 6c6f 7564 2061  launch --cloud a
+00016390: 7773 202d 2d72 6567 696f 6e20 7b72 6567  ws --region {reg
+000163a0: 696f 6e7d 202d 6e20 7b6e 616d 657d 2d32  ion} -n {name}-2
+000163b0: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
+000163c0: 732f 7465 7374 5f6c 6f6e 675f 7365 7475  s/test_long_setu
+000163d0: 702e 7961 6d6c 2020 2d79 202d 6427 2c0a  p.yaml  -y -d',.
+000163e0: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+000163f0: 6570 2033 3030 272c 0a20 2020 2020 2020  ep 300',.       
+00016400: 2020 2020 205f 5350 4f54 5f43 414e 4345       _SPOT_CANCE
+00016410: 4c5f 5741 4954 2e66 6f72 6d61 7428 6a6f  L_WAIT.format(jo
+00016420: 625f 6e61 6d65 3d66 277b 6e61 6d65 7d2d  b_name=f'{name}-
+00016430: 3227 292c 0a20 2020 2020 2020 2020 2020  2'),.           
+00016440: 2027 736c 6565 7020 3527 2c0a 2020 2020   'sleep 5',.    
+00016450: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
+00016460: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
+00016470: 6570 207b 6e61 6d65 7d2d 3220 7c20 6865  ep {name}-2 | he
+00016480: 6164 202d 6e31 207c 2067 7265 7020 2243  ad -n1 | grep "C
+00016490: 414e 4345 4c4c 494e 475c 7c43 414e 4345  ANCELLING\|CANCE
+000164a0: 4c4c 4544 2227 2c0a 2020 2020 2020 2020  LLED"',.        
+000164b0: 2020 2020 2773 6c65 6570 2031 3230 272c      'sleep 120',
+000164c0: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+000164d0: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
+000164e0: 7d7c 2067 7265 7020 7b6e 616d 657d 2d32  }| grep {name}-2
+000164f0: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
+00016500: 6570 2022 4341 4e43 454c 4c45 4422 272c  ep "CANCELLED"',
+00016510: 0a20 2020 2020 2020 2020 2020 2028 6627  .            (f'
+00016520: 733d 2428 6177 7320 6563 3220 6465 7363  s=$(aws ec2 desc
+00016530: 7269 6265 2d69 6e73 7461 6e63 6573 202d  ribe-instances -
+00016540: 2d72 6567 696f 6e20 7b72 6567 696f 6e7d  -region {region}
+00016550: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+00016560: 6627 2d2d 6669 6c74 6572 7320 4e61 6d65  f'--filters Name
+00016570: 3d74 6167 3a72 6179 2d63 6c75 7374 6572  =tag:ray-cluster
+00016580: 2d6e 616d 652c 5661 6c75 6573 3d7b 6e61  -name,Values={na
+00016590: 6d65 7d2d 322d 2a20 270a 2020 2020 2020  me}-2-* '.      
+000165a0: 2020 2020 2020 2066 272d 2d71 7565 7279         f'--query
+000165b0: 2052 6573 6572 7661 7469 6f6e 735b 5d2e   Reservations[].
+000165c0: 496e 7374 616e 6365 735b 5d2e 5374 6174  Instances[].Stat
+000165d0: 655b 5d2e 4e61 6d65 2027 0a20 2020 2020  e[].Name '.     
+000165e0: 2020 2020 2020 2020 272d 2d6f 7574 7075          '--outpu
+000165f0: 7420 7465 7874 2920 2626 2065 6368 6f20  t text) && echo 
+00016600: 2224 7322 2026 2620 6563 686f 3b20 5b5b  "$s" && echo; [[
+00016610: 202d 7a20 2224 7322 205d 5d20 7c7c 205b   -z "$s" ]] || [
+00016620: 5b20 2224 7322 203d 2022 7465 726d 696e  [ "$s" = "termin
+00016630: 6174 6564 2220 5d5d 207c 7c20 5b5b 2022  ated" ]] || [[ "
+00016640: 2473 2220 3d20 2273 6875 7474 696e 672d  $s" = "shutting-
+00016650: 646f 776e 2220 5d5d 270a 2020 2020 2020  down" ]]'.      
+00016660: 2020 2020 2020 292c 0a20 2020 2020 2020        ),.       
+00016670: 2020 2020 2023 2054 6573 7420 6361 6e63       # Test canc
+00016680: 656c 6c61 7469 6f6e 2064 7572 696e 6720  ellation during 
+00016690: 7370 6f74 206a 6f62 2069 7320 7265 636f  spot job is reco
+000166a0: 7665 7269 6e67 2e0a 2020 2020 2020 2020  vering..        
+000166b0: 2020 2020 6627 736b 7920 7370 6f74 206c      f'sky spot l
+000166c0: 6175 6e63 6820 2d2d 636c 6f75 6420 6177  aunch --cloud aw
+000166d0: 7320 2d2d 7265 6769 6f6e 207b 7265 6769  s --region {regi
+000166e0: 6f6e 7d20 2d6e 207b 6e61 6d65 7d2d 3320  on} -n {name}-3 
+000166f0: 2273 6c65 6570 2031 3030 3022 2020 2d79  "sleep 1000"  -y
+00016700: 202d 6427 2c0a 2020 2020 2020 2020 2020   -d',.          
+00016710: 2020 2773 6c65 6570 2033 3030 272c 0a20    'sleep 300',. 
+00016720: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
+00016730: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
+00016740: 2067 7265 7020 7b6e 616d 657d 2d33 207c   grep {name}-3 |
+00016750: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
+00016760: 2022 5255 4e4e 494e 4722 272c 0a20 2020   "RUNNING"',.   
+00016770: 2020 2020 2020 2020 2023 2054 6572 6d69           # Termi
+00016780: 6e61 7465 2074 6865 2063 6c75 7374 6572  nate the cluster
+00016790: 206d 616e 7561 6c6c 792e 0a20 2020 2020   manually..     
+000167a0: 2020 2020 2020 2028 6627 6177 7320 6563         (f'aws ec
+000167b0: 3220 7465 726d 696e 6174 652d 696e 7374  2 terminate-inst
+000167c0: 616e 6365 7320 2d2d 7265 6769 6f6e 207b  ances --region {
+000167d0: 7265 6769 6f6e 7d20 2d2d 696e 7374 616e  region} --instan
+000167e0: 6365 2d69 6473 2024 2827 0a20 2020 2020  ce-ids $('.     
+000167f0: 2020 2020 2020 2020 6627 6177 7320 6563          f'aws ec
+00016800: 3220 6465 7363 7269 6265 2d69 6e73 7461  2 describe-insta
+00016810: 6e63 6573 202d 2d72 6567 696f 6e20 7b72  nces --region {r
+00016820: 6567 696f 6e7d 2027 0a20 2020 2020 2020  egion} '.       
+00016830: 2020 2020 2020 6627 2d2d 6669 6c74 6572        f'--filter
+00016840: 7320 4e61 6d65 3d74 6167 3a72 6179 2d63  s Name=tag:ray-c
+00016850: 6c75 7374 6572 2d6e 616d 652c 5661 6c75  luster-name,Valu
+00016860: 6573 3d7b 6e61 6d65 7d2d 332d 2a20 270a  es={name}-3-* '.
+00016870: 2020 2020 2020 2020 2020 2020 2066 272d               f'-
+00016880: 2d71 7565 7279 2052 6573 6572 7661 7469  -query Reservati
+00016890: 6f6e 735b 5d2e 496e 7374 616e 6365 735b  ons[].Instances[
+000168a0: 5d2e 496e 7374 616e 6365 4964 2027 0a20  ].InstanceId '. 
+000168b0: 2020 2020 2020 2020 2020 2020 272d 2d6f              '--o
+000168c0: 7574 7075 7420 7465 7874 2927 292c 0a20  utput text)'),. 
+000168d0: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+000168e0: 7020 3132 3027 2c0a 2020 2020 2020 2020  p 120',.        
+000168f0: 2020 2020 6627 7b5f 5350 4f54 5f51 5545      f'{_SPOT_QUE
+00016900: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
+00016910: 6e61 6d65 7d2d 3320 7c20 6865 6164 202d  name}-3 | head -
+00016920: 6e31 207c 2067 7265 7020 2252 4543 4f56  n1 | grep "RECOV
+00016930: 4552 494e 4722 272c 0a20 2020 2020 2020  ERING"',.       
+00016940: 2020 2020 205f 5350 4f54 5f43 414e 4345       _SPOT_CANCE
+00016950: 4c5f 5741 4954 2e66 6f72 6d61 7428 6a6f  L_WAIT.format(jo
+00016960: 625f 6e61 6d65 3d66 277b 6e61 6d65 7d2d  b_name=f'{name}-
+00016970: 3327 292c 0a20 2020 2020 2020 2020 2020  3'),.           
+00016980: 2027 736c 6565 7020 3527 2c0a 2020 2020   'sleep 5',.    
+00016990: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
+000169a0: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
+000169b0: 6570 207b 6e61 6d65 7d2d 3320 7c20 6865  ep {name}-3 | he
+000169c0: 6164 202d 6e31 207c 2067 7265 7020 2243  ad -n1 | grep "C
+000169d0: 414e 4345 4c4c 494e 475c 7c43 414e 4345  ANCELLING\|CANCE
+000169e0: 4c4c 4544 2227 2c0a 2020 2020 2020 2020  LLED"',.        
+000169f0: 2020 2020 2773 6c65 6570 2031 3230 272c      'sleep 120',
+00016a00: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+00016a10: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
+00016a20: 7d7c 2067 7265 7020 7b6e 616d 657d 2d33  }| grep {name}-3
+00016a30: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
+00016a40: 6570 2022 4341 4e43 454c 4c45 4422 272c  ep "CANCELLED"',
+00016a50: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
+00016a60: 6865 2063 6c75 7374 6572 2073 686f 756c  he cluster shoul
+00016a70: 6420 6265 2074 6572 6d69 6e61 7465 6420  d be terminated 
+00016a80: 2873 6875 7474 696e 672d 646f 776e 2920  (shutting-down) 
+00016a90: 6166 7465 7220 6361 6e63 656c 6c61 7469  after cancellati
+00016aa0: 6f6e 2e20 5765 2064 6f6e 2774 2075 7365  on. We don't use
+00016ab0: 2074 6865 2060 3d60 206f 7065 7261 746f   the `=` operato
+00016ac0: 7220 6865 7265 2062 6563 6175 7365 0a20  r here because. 
+00016ad0: 2020 2020 2020 2020 2020 2023 2074 6865             # the
+00016ae0: 7265 2063 616e 2062 6520 6d75 6c74 6970  re can be multip
+00016af0: 6c65 2056 4d20 7769 7468 2074 6865 2073  le VM with the s
+00016b00: 616d 6520 6e61 6d65 2064 7565 2074 6f20  ame name due to 
+00016b10: 7468 6520 7265 636f 7665 7279 2e0a 2020  the recovery..  
+00016b20: 2020 2020 2020 2020 2020 2866 2773 3d24            (f's=$
+00016b30: 2861 7773 2065 6332 2064 6573 6372 6962  (aws ec2 describ
+00016b40: 652d 696e 7374 616e 6365 7320 2d2d 7265  e-instances --re
+00016b50: 6769 6f6e 207b 7265 6769 6f6e 7d20 270a  gion {region} '.
+00016b60: 2020 2020 2020 2020 2020 2020 2066 272d               f'-
+00016b70: 2d66 696c 7465 7273 204e 616d 653d 7461  -filters Name=ta
+00016b80: 673a 7261 792d 636c 7573 7465 722d 6e61  g:ray-cluster-na
+00016b90: 6d65 2c56 616c 7565 733d 7b6e 616d 657d  me,Values={name}
+00016ba0: 2d33 2d2a 2027 0a20 2020 2020 2020 2020  -3-* '.         
+00016bb0: 2020 2020 6627 2d2d 7175 6572 7920 5265      f'--query Re
+00016bc0: 7365 7276 6174 696f 6e73 5b5d 2e49 6e73  servations[].Ins
+00016bd0: 7461 6e63 6573 5b5d 2e53 7461 7465 5b5d  tances[].State[]
+00016be0: 2e4e 616d 6520 270a 2020 2020 2020 2020  .Name '.        
+00016bf0: 2020 2020 2027 2d2d 6f75 7470 7574 2074       '--output t
+00016c00: 6578 7429 2026 2620 6563 686f 2022 2473  ext) && echo "$s
+00016c10: 2220 2626 2065 6368 6f3b 205b 5b20 2d7a  " && echo; [[ -z
+00016c20: 2022 2473 2220 5d5d 207c 7c20 6563 686f   "$s" ]] || echo
+00016c30: 2022 2473 2220 7c20 6772 6570 202d 7620   "$s" | grep -v 
+00016c40: 2d45 2022 7065 6e64 696e 677c 7275 6e6e  -E "pending|runn
+00016c50: 696e 677c 7374 6f70 7065 647c 7374 6f70  ing|stopped|stop
+00016c60: 7069 6e67 2227 0a20 2020 2020 2020 2020  ping"'.         
+00016c70: 2020 2029 2c0a 2020 2020 2020 2020 5d2c     ),.        ],
+00016c80: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
+00016c90: 3d32 3520 2a20 3630 290a 2020 2020 7275  =25 * 60).    ru
+00016ca0: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+00016cb0: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
+00016cc0: 6763 700a 4070 7974 6573 742e 6d61 726b  gcp.@pytest.mark
+00016cd0: 2e6d 616e 6167 6564 5f73 706f 740a 6465  .managed_spot.de
+00016ce0: 6620 7465 7374 5f73 706f 745f 6361 6e63  f test_spot_canc
+00016cf0: 656c 6c61 7469 6f6e 5f67 6370 2829 3a0a  ellation_gcp():.
+00016d00: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+00016d10: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+00016d20: 2020 207a 6f6e 6520 3d20 2775 732d 7765     zone = 'us-we
+00016d30: 7374 332d 6227 0a20 2020 2071 7565 7279  st3-b'.    query
+00016d40: 5f73 7461 7465 5f63 6d64 203d 2028 2767  _state_cmd = ('g
+00016d50: 636c 6f75 6420 636f 6d70 7574 6520 696e  cloud compute in
+00016d60: 7374 616e 6365 7320 6c69 7374 2027 0a20  stances list '. 
+00016d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016d80: 2020 2020 2020 6627 2d2d 6669 6c74 6572        f'--filter
+00016d90: 3d22 286c 6162 656c 732e 7261 792d 636c  ="(labels.ray-cl
+00016da0: 7573 7465 722d 6e61 6d65 3a7b 6e61 6d65  uster-name:{name
+00016db0: 7d29 2220 270a 2020 2020 2020 2020 2020  })" '.          
+00016dc0: 2020 2020 2020 2020 2020 2020 2027 2d2d               '--
+00016dd0: 666f 726d 6174 3d22 7661 6c75 6528 7374  format="value(st
+00016de0: 6174 7573 2922 2729 0a20 2020 2071 7565  atus)"').    que
+00016df0: 7279 5f63 6d64 203d 2028 6627 6763 6c6f  ry_cmd = (f'gclo
+00016e00: 7564 2063 6f6d 7075 7465 2069 6e73 7461  ud compute insta
+00016e10: 6e63 6573 206c 6973 7420 2d2d 6669 6c74  nces list --filt
+00016e20: 6572 3d27 0a20 2020 2020 2020 2020 2020  er='.           
+00016e30: 2020 2020 2020 6627 2228 6c61 6265 6c73        f'"(labels
+00016e40: 2e72 6179 2d63 6c75 7374 6572 2d6e 616d  .ray-cluster-nam
+00016e50: 653a 7b6e 616d 657d 2922 2027 0a20 2020  e:{name})" '.   
+00016e60: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+00016e70: 2d2d 7a6f 6e65 733d 7b7a 6f6e 657d 202d  --zones={zone} -
+00016e80: 2d66 6f72 6d61 743d 2276 616c 7565 286e  -format="value(n
+00016e90: 616d 6529 2227 290a 2020 2020 7465 726d  ame)"').    term
+00016ea0: 696e 6174 655f 636d 6420 3d20 2866 2767  inate_cmd = (f'g
+00016eb0: 636c 6f75 6420 636f 6d70 7574 6520 696e  cloud compute in
+00016ec0: 7374 616e 6365 7320 6465 6c65 7465 202d  stances delete -
+00016ed0: 2d7a 6f6e 653d 7b7a 6f6e 657d 270a 2020  -zone={zone}'.  
+00016ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016ef0: 2020 2066 2720 2d2d 7175 6965 7420 2428     f' --quiet $(
+00016f00: 7b71 7565 7279 5f63 6d64 7d29 2729 0a20  {query_cmd})'). 
+00016f10: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+00016f20: 2020 2020 2020 2020 2773 706f 745f 6361          'spot_ca
+00016f30: 6e63 656c 6c61 7469 6f6e 5f67 6370 272c  ncellation_gcp',
+00016f40: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+00016f50: 2020 2020 2020 2023 2054 6573 7420 6361         # Test ca
+00016f60: 6e63 656c 6c61 7469 6f6e 2064 7572 696e  ncellation durin
+00016f70: 6720 7370 6f74 2063 6c75 7374 6572 2062  g spot cluster b
+00016f80: 6569 6e67 206c 6175 6e63 6865 642e 0a20  eing launched.. 
+00016f90: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00016fa0: 2073 706f 7420 6c61 756e 6368 202d 2d63   spot launch --c
+00016fb0: 6c6f 7564 2067 6370 202d 2d7a 6f6e 6520  loud gcp --zone 
+00016fc0: 7b7a 6f6e 657d 202d 6e20 7b6e 616d 657d  {zone} -n {name}
+00016fd0: 2022 736c 6565 7020 3130 3030 2220 202d   "sleep 1000"  -
+00016fe0: 7920 2d64 272c 0a20 2020 2020 2020 2020  y -d',.         
+00016ff0: 2020 2027 736c 6565 7020 3630 272c 0a20     'sleep 60',. 
+00017000: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
+00017010: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
+00017020: 2067 7265 7020 7b6e 616d 657d 207c 2068   grep {name} | h
+00017030: 6561 6420 2d6e 3120 7c20 6772 6570 2022  ead -n1 | grep "
+00017040: 5354 4152 5449 4e47 2227 2c0a 2020 2020  STARTING"',.    
+00017050: 2020 2020 2020 2020 5f53 504f 545f 4341          _SPOT_CA
+00017060: 4e43 454c 5f57 4149 542e 666f 726d 6174  NCEL_WAIT.format
+00017070: 286a 6f62 5f6e 616d 653d 6e61 6d65 292c  (job_name=name),
+00017080: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+00017090: 6565 7020 3527 2c0a 2020 2020 2020 2020  eep 5',.        
+000170a0: 2020 2020 6627 7b5f 5350 4f54 5f51 5545      f'{_SPOT_QUE
+000170b0: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
+000170c0: 6e61 6d65 7d20 7c20 6865 6164 202d 6e31  name} | head -n1
+000170d0: 207c 2067 7265 7020 2243 414e 4345 4c4c   | grep "CANCELL
+000170e0: 494e 475c 7c43 414e 4345 4c4c 4544 2227  ING\|CANCELLED"'
+000170f0: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
+00017100: 6c65 6570 2031 3230 272c 0a20 2020 2020  leep 120',.     
+00017110: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
+00017120: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
+00017130: 7020 7b6e 616d 657d 207c 2068 6561 6420  p {name} | head 
+00017140: 2d6e 3120 7c20 6772 6570 2022 4341 4e43  -n1 | grep "CANC
+00017150: 454c 4c45 4422 272c 0a20 2020 2020 2020  ELLED"',.       
+00017160: 2020 2020 2023 2054 6573 7420 6361 6e63       # Test canc
+00017170: 656c 6c69 6e67 2074 6865 2073 706f 7420  elling the spot 
+00017180: 636c 7573 7465 7220 6475 7269 6e67 2073  cluster during s
+00017190: 706f 7420 6a6f 6220 6265 696e 6720 7365  pot job being se
+000171a0: 7475 702e 0a20 2020 2020 2020 2020 2020  tup..           
+000171b0: 2066 2773 6b79 2073 706f 7420 6c61 756e   f'sky spot laun
+000171c0: 6368 202d 2d63 6c6f 7564 2067 6370 202d  ch --cloud gcp -
+000171d0: 2d7a 6f6e 6520 7b7a 6f6e 657d 202d 6e20  -zone {zone} -n 
+000171e0: 7b6e 616d 657d 2d32 2074 6573 7473 2f74  {name}-2 tests/t
+000171f0: 6573 745f 7961 6d6c 732f 7465 7374 5f6c  est_yamls/test_l
+00017200: 6f6e 675f 7365 7475 702e 7961 6d6c 2020  ong_setup.yaml  
+00017210: 2d79 202d 6427 2c0a 2020 2020 2020 2020  -y -d',.        
+00017220: 2020 2020 2773 6c65 6570 2033 3030 272c      'sleep 300',
+00017230: 0a20 2020 2020 2020 2020 2020 205f 5350  .            _SP
+00017240: 4f54 5f43 414e 4345 4c5f 5741 4954 2e66  OT_CANCEL_WAIT.f
+00017250: 6f72 6d61 7428 6a6f 625f 6e61 6d65 3d66  ormat(job_name=f
+00017260: 277b 6e61 6d65 7d2d 3227 292c 0a20 2020  '{name}-2'),.   
+00017270: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+00017280: 3527 2c0a 2020 2020 2020 2020 2020 2020  5',.            
+00017290: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
+000172a0: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
+000172b0: 7d2d 3220 7c20 6865 6164 202d 6e31 207c  }-2 | head -n1 |
+000172c0: 2067 7265 7020 2243 414e 4345 4c4c 494e   grep "CANCELLIN
+000172d0: 475c 7c43 414e 4345 4c4c 4544 2227 2c0a  G\|CANCELLED"',.
+000172e0: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+000172f0: 6570 2031 3230 272c 0a20 2020 2020 2020  ep 120',.       
+00017300: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
+00017310: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
+00017320: 7b6e 616d 657d 2d32 207c 2068 6561 6420  {name}-2 | head 
+00017330: 2d6e 3120 7c20 6772 6570 2022 4341 4e43  -n1 | grep "CANC
+00017340: 454c 4c45 4422 272c 0a20 2020 2020 2020  ELLED"',.       
+00017350: 2020 2020 2023 2054 6573 7420 6361 6e63       # Test canc
+00017360: 656c 6c61 7469 6f6e 2064 7572 696e 6720  ellation during 
+00017370: 7370 6f74 206a 6f62 2069 7320 7265 636f  spot job is reco
+00017380: 7665 7269 6e67 2e0a 2020 2020 2020 2020  vering..        
+00017390: 2020 2020 6627 736b 7920 7370 6f74 206c      f'sky spot l
+000173a0: 6175 6e63 6820 2d2d 636c 6f75 6420 6763  aunch --cloud gc
+000173b0: 7020 2d2d 7a6f 6e65 207b 7a6f 6e65 7d20  p --zone {zone} 
+000173c0: 2d6e 207b 6e61 6d65 7d2d 3320 2273 6c65  -n {name}-3 "sle
+000173d0: 6570 2031 3030 3022 2020 2d79 202d 6427  ep 1000"  -y -d'
+000173e0: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
+000173f0: 6c65 6570 2033 3030 272c 0a20 2020 2020  leep 300',.     
+00017400: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
+00017410: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
+00017420: 7020 7b6e 616d 657d 2d33 207c 2068 6561  p {name}-3 | hea
+00017430: 6420 2d6e 3120 7c20 6772 6570 2022 5255  d -n1 | grep "RU
+00017440: 4e4e 494e 4722 272c 0a20 2020 2020 2020  NNING"',.       
+00017450: 2020 2020 2023 2054 6572 6d69 6e61 7465       # Terminate
+00017460: 2074 6865 2063 6c75 7374 6572 206d 616e   the cluster man
+00017470: 7561 6c6c 792e 0a20 2020 2020 2020 2020  ually..         
+00017480: 2020 2074 6572 6d69 6e61 7465 5f63 6d64     terminate_cmd
+00017490: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
+000174a0: 6c65 6570 2031 3030 272c 0a20 2020 2020  leep 100',.     
+000174b0: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
+000174c0: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
+000174d0: 7020 7b6e 616d 657d 2d33 207c 2068 6561  p {name}-3 | hea
+000174e0: 6420 2d6e 3120 7c20 6772 6570 2022 5245  d -n1 | grep "RE
+000174f0: 434f 5645 5249 4e47 2227 2c0a 2020 2020  COVERING"',.    
+00017500: 2020 2020 2020 2020 5f53 504f 545f 4341          _SPOT_CA
+00017510: 4e43 454c 5f57 4149 542e 666f 726d 6174  NCEL_WAIT.format
+00017520: 286a 6f62 5f6e 616d 653d 6627 7b6e 616d  (job_name=f'{nam
+00017530: 657d 2d33 2729 2c0a 2020 2020 2020 2020  e}-3'),.        
+00017540: 2020 2020 2773 6c65 6570 2035 272c 0a20      'sleep 5',. 
+00017550: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
+00017560: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
+00017570: 2067 7265 7020 7b6e 616d 657d 2d33 207c   grep {name}-3 |
+00017580: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
+00017590: 2022 4341 4e43 454c 4c49 4e47 5c7c 4341   "CANCELLING\|CA
+000175a0: 4e43 454c 4c45 4422 272c 0a20 2020 2020  NCELLED"',.     
+000175b0: 2020 2020 2020 2027 736c 6565 7020 3132         'sleep 12
+000175c0: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
+000175d0: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
+000175e0: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
+000175f0: 7d2d 3320 7c20 6865 6164 202d 6e31 207c  }-3 | head -n1 |
+00017600: 2067 7265 7020 2243 414e 4345 4c4c 4544   grep "CANCELLED
 00017610: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-00017620: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-00017630: 7d20 3120 2d2d 7374 6174 7573 272c 0a20  } 1 --status',. 
-00017640: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00017650: 2065 7865 6320 7b6e 616d 657d 202d 2d65   exec {name} --e
-00017660: 6e76 2d66 696c 6520 6578 616d 706c 6573  nv-file examples
-00017670: 2f73 616d 706c 655f 646f 7465 6e76 2022  /sample_dotenv "
-00017680: 285b 5b20 2120 2d7a 205c 5c22 5c24 5445  ([[ ! -z \\"\$TE
-00017690: 5354 5f45 4e56 325c 5c22 205d 5d20 2626  ST_ENV2\\" ]] &&
-000176a0: 205b 5b20 2120 2d7a 205c 5c22 5c24 534b   [[ ! -z \\"\$SK
-000176b0: 5950 494c 4f54 5f4e 4f44 455f 4950 535c  YPILOT_NODE_IPS\
-000176c0: 5c22 205d 5d20 2626 205b 5b20 2120 2d7a  \" ]] && [[ ! -z
-000176d0: 205c 5c22 5c24 534b 5950 494c 4f54 5f4e   \\"\$SKYPILOT_N
-000176e0: 4f44 455f 5241 4e4b 5c5c 2220 5d5d 2920  ODE_RANK\\" ]]) 
-000176f0: 7c7c 2065 7869 7420 3122 272c 0a20 2020  || exit 1"',.   
-00017700: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00017710: 6f67 7320 7b6e 616d 657d 2032 202d 2d73  ogs {name} 2 --s
-00017720: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
-00017730: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
-00017740: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
-00017750: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
-00017760: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-00017770: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465  .# ---------- Te
-00017780: 7374 696e 6720 6375 7374 6f6d 2069 6d61  sting custom ima
-00017790: 6765 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070  ge ----------.@p
-000177a0: 7974 6573 742e 6d61 726b 2e61 7773 0a64  ytest.mark.aws.d
-000177b0: 6566 2074 6573 745f 6375 7374 6f6d 5f69  ef test_custom_i
-000177c0: 6d61 6765 2829 3a0a 2020 2020 2222 2254  mage():.    """T
-000177d0: 6573 7420 6375 7374 6f6d 2069 6d61 6765  est custom image
-000177e0: 2222 220a 2020 2020 6e61 6d65 203d 205f  """.    name = _
-000177f0: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-00017800: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
-00017810: 7374 280a 2020 2020 2020 2020 2774 6573  st(.        'tes
-00017820: 742d 6375 7374 6f6d 2d69 6d61 6765 272c  t-custom-image',
-00017830: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
-00017840: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-00017850: 6e63 6820 2d63 207b 6e61 6d65 7d20 2d2d  nch -c {name} --
-00017860: 7265 7472 792d 756e 7469 6c2d 7570 202d  retry-until-up -
-00017870: 7920 6578 616d 706c 6573 2f63 7573 746f  y examples/custo
-00017880: 6d5f 696d 6167 652e 7961 6d6c 272c 0a20  m_image.yaml',. 
-00017890: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-000178a0: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
-000178b0: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
-000178c0: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
-000178d0: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
-000178e0: 7d27 2c0a 2020 2020 2020 2020 7469 6d65  }',.        time
-000178f0: 6f75 743d 3330 202a 2036 302c 0a20 2020  out=30 * 60,.   
-00017900: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
-00017910: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
-00017920: 6573 742e 6d61 726b 2e73 6c6f 770a 6465  est.mark.slow.de
-00017930: 6620 7465 7374 5f61 7a75 7265 5f73 7461  f test_azure_sta
-00017940: 7274 5f73 746f 705f 7477 6f5f 6e6f 6465  rt_stop_two_node
-00017950: 7328 293a 0a20 2020 206e 616d 6520 3d20  s():.    name = 
-00017960: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-00017970: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
-00017980: 6573 7428 0a20 2020 2020 2020 2027 617a  est(.        'az
-00017990: 7572 652d 7374 6172 742d 7374 6f70 2d74  ure-start-stop-t
-000179a0: 776f 2d6e 6f64 6573 272c 0a20 2020 2020  wo-nodes',.     
-000179b0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-000179c0: 2066 2773 6b79 206c 6175 6e63 6820 2d2d   f'sky launch --
-000179d0: 6e75 6d2d 6e6f 6465 733d 3220 2d79 202d  num-nodes=2 -y -
-000179e0: 6320 7b6e 616d 657d 2065 7861 6d70 6c65  c {name} example
-000179f0: 732f 617a 7572 655f 7374 6172 745f 7374  s/azure_start_st
-00017a00: 6f70 2e79 616d 6c27 2c0a 2020 2020 2020  op.yaml',.      
-00017a10: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
-00017a20: 202d 2d6e 756d 2d6e 6f64 6573 3d32 207b   --num-nodes=2 {
-00017a30: 6e61 6d65 7d20 6578 616d 706c 6573 2f61  name} examples/a
-00017a40: 7a75 7265 5f73 7461 7274 5f73 746f 702e  zure_start_stop.
-00017a50: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-00017a60: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-00017a70: 616d 657d 2031 202d 2d73 7461 7475 7327  ame} 1 --status'
-00017a80: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
-00017a90: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
-00017aa0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00017ab0: 2073 746f 7020 2d79 207b 6e61 6d65 7d27   stop -y {name}'
-00017ac0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00017ad0: 736b 7920 7374 6172 7420 2d79 207b 6e61  sky start -y {na
-00017ae0: 6d65 7d27 2c0a 2020 2020 2020 2020 2020  me}',.          
-00017af0: 2020 6627 736b 7920 6578 6563 202d 2d6e    f'sky exec --n
-00017b00: 756d 2d6e 6f64 6573 3d32 207b 6e61 6d65  um-nodes=2 {name
-00017b10: 7d20 6578 616d 706c 6573 2f61 7a75 7265  } examples/azure
-00017b20: 5f73 7461 7274 5f73 746f 702e 7961 6d6c  _start_stop.yaml
-00017b30: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00017b40: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-00017b50: 2032 202d 2d73 7461 7475 7327 2c20 2023   2 --status',  #
-00017b60: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
-00017b70: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
-00017b80: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
-00017b90: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
-00017ba0: 657d 272c 0a20 2020 2020 2020 2074 696d  e}',.        tim
-00017bb0: 656f 7574 3d33 3020 2a20 3630 2c20 2023  eout=30 * 60,  #
-00017bc0: 2033 3020 6d69 6e73 2020 2869 7420 7461   30 mins  (it ta
-00017bd0: 6b65 7320 6172 6f75 6e64 207e 3233 206d  kes around ~23 m
-00017be0: 696e 7329 0a20 2020 2029 0a20 2020 2072  ins).    ).    r
-00017bf0: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-00017c00: 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d  )...# ----------
-00017c10: 2054 6573 7469 6e67 2065 6e76 2066 6f72   Testing env for
-00017c20: 2064 6973 6b20 7469 6572 202d 2d2d 2d2d   disk tier -----
-00017c30: 2d2d 2d2d 2d0a 4070 7974 6573 742e 6d61  -----.@pytest.ma
-00017c40: 726b 2e61 7773 0a64 6566 2074 6573 745f  rk.aws.def test_
-00017c50: 6177 735f 6469 736b 5f74 6965 7228 293a  aws_disk_tier():
-00017c60: 0a0a 2020 2020 6465 6620 5f67 6574 5f61  ..    def _get_a
-00017c70: 7773 5f71 7565 7279 5f63 6f6d 6d61 6e64  ws_query_command
-00017c80: 2872 6567 696f 6e2c 2069 6e73 7461 6e63  (region, instanc
-00017c90: 655f 6964 2c20 6669 656c 642c 2065 7870  e_id, field, exp
-00017ca0: 6563 7465 6429 3a0a 2020 2020 2020 2020  ected):.        
-00017cb0: 7265 7475 726e 2028 6627 6177 7320 6563  return (f'aws ec
-00017cc0: 3220 6465 7363 7269 6265 2d76 6f6c 756d  2 describe-volum
-00017cd0: 6573 202d 2d72 6567 696f 6e20 7b72 6567  es --region {reg
-00017ce0: 696f 6e7d 2027 0a20 2020 2020 2020 2020  ion} '.         
-00017cf0: 2020 2020 2020 2066 272d 2d66 696c 7465         f'--filte
-00017d00: 7273 204e 616d 653d 6174 7461 6368 6d65  rs Name=attachme
-00017d10: 6e74 2e69 6e73 7461 6e63 652d 6964 2c56  nt.instance-id,V
-00017d20: 616c 7565 733d 7b69 6e73 7461 6e63 655f  alues={instance_
-00017d30: 6964 7d20 270a 2020 2020 2020 2020 2020  id} '.          
-00017d40: 2020 2020 2020 6627 2d2d 7175 6572 7920        f'--query 
-00017d50: 566f 6c75 6d65 735b 2a5d 2e7b 6669 656c  Volumes[*].{fiel
-00017d60: 647d 207c 2067 7265 7020 7b65 7870 6563  d} | grep {expec
-00017d70: 7465 647d 203b 2027 290a 0a20 2020 2066  ted} ; ')..    f
-00017d80: 6f72 2064 6973 6b5f 7469 6572 2069 6e20  or disk_tier in 
-00017d90: 5b27 6c6f 7727 2c20 276d 6564 6975 6d27  ['low', 'medium'
-00017da0: 2c20 2768 6967 6827 5d3a 0a20 2020 2020  , 'high']:.     
-00017db0: 2020 2073 7065 6373 203d 2041 5753 2e5f     specs = AWS._
-00017dc0: 6765 745f 6469 736b 5f73 7065 6373 2864  get_disk_specs(d
-00017dd0: 6973 6b5f 7469 6572 290a 2020 2020 2020  isk_tier).      
-00017de0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-00017df0: 7573 7465 725f 6e61 6d65 2829 202b 2027  uster_name() + '
-00017e00: 2d27 202b 2064 6973 6b5f 7469 6572 0a20  -' + disk_tier. 
-00017e10: 2020 2020 2020 2072 6567 696f 6e20 3d20         region = 
-00017e20: 2775 732d 7765 7374 2d32 270a 2020 2020  'us-west-2'.    
-00017e30: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-00017e40: 0a20 2020 2020 2020 2020 2020 2027 6177  .            'aw
-00017e50: 732d 6469 736b 2d74 6965 7227 2c0a 2020  s-disk-tier',.  
-00017e60: 2020 2020 2020 2020 2020 5b0a 2020 2020            [.    
-00017e70: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00017e80: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
-00017e90: 6e61 6d65 7d20 2d2d 636c 6f75 6420 6177  name} --cloud aw
-00017ea0: 7320 2d2d 7265 6769 6f6e 207b 7265 6769  s --region {regi
-00017eb0: 6f6e 7d20 270a 2020 2020 2020 2020 2020  on} '.          
-00017ec0: 2020 2020 2020 6627 2d2d 6469 736b 2d74        f'--disk-t
-00017ed0: 6965 7220 7b64 6973 6b5f 7469 6572 7d20  ier {disk_tier} 
-00017ee0: 6563 686f 2022 6865 6c6c 6f20 736b 7922  echo "hello sky"
-00017ef0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00017f00: 2020 2066 2769 643d 6061 7773 2065 6332     f'id=`aws ec2
-00017f10: 2064 6573 6372 6962 652d 696e 7374 616e   describe-instan
-00017f20: 6365 7320 2d2d 7265 6769 6f6e 207b 7265  ces --region {re
-00017f30: 6769 6f6e 7d20 2d2d 6669 6c74 6572 7320  gion} --filters 
-00017f40: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00017f50: 2020 6627 4e61 6d65 3d74 6167 3a72 6179    f'Name=tag:ray
-00017f60: 2d63 6c75 7374 6572 2d6e 616d 652c 5661  -cluster-name,Va
-00017f70: 6c75 6573 3d7b 6e61 6d65 7d20 2d2d 7175  lues={name} --qu
-00017f80: 6572 7920 270a 2020 2020 2020 2020 2020  ery '.          
-00017f90: 2020 2020 2020 6627 5265 7365 7276 6174        f'Reservat
-00017fa0: 696f 6e73 5b5d 2e49 6e73 7461 6e63 6573  ions[].Instances
-00017fb0: 5b5d 2e49 6e73 7461 6e63 6549 6420 2d2d  [].InstanceId --
-00017fc0: 6f75 7470 7574 2074 6578 7460 3b20 2720  output text`; ' 
-00017fd0: 2b0a 2020 2020 2020 2020 2020 2020 2020  +.              
-00017fe0: 2020 5f67 6574 5f61 7773 5f71 7565 7279    _get_aws_query
-00017ff0: 5f63 6f6d 6d61 6e64 2872 6567 696f 6e2c  _command(region,
-00018000: 2027 2469 6427 2c20 2756 6f6c 756d 6554   '$id', 'VolumeT
-00018010: 7970 6527 2c0a 2020 2020 2020 2020 2020  ype',.          
-00018020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018030: 2020 2020 2020 2020 2020 2020 2073 7065               spe
-00018040: 6373 5b27 6469 736b 5f74 6965 7227 5d29  cs['disk_tier'])
-00018050: 202b 0a20 2020 2020 2020 2020 2020 2020   +.             
-00018060: 2020 2028 2727 2069 6620 6469 736b 5f74     ('' if disk_t
-00018070: 6965 7220 3d3d 2027 6c6f 7727 2065 6c73  ier == 'low' els
-00018080: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-00018090: 2020 2028 5f67 6574 5f61 7773 5f71 7565     (_get_aws_que
-000180a0: 7279 5f63 6f6d 6d61 6e64 2872 6567 696f  ry_command(regio
-000180b0: 6e2c 2027 2469 6427 2c20 2749 6f70 7327  n, '$id', 'Iops'
-000180c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000180d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000180e0: 2020 2020 2020 2020 2020 2073 7065 6373             specs
-000180f0: 5b27 6469 736b 5f69 6f70 7327 5d29 202b  ['disk_iops']) +
-00018100: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018110: 2020 205f 6765 745f 6177 735f 7175 6572     _get_aws_quer
-00018120: 795f 636f 6d6d 616e 6428 7265 6769 6f6e  y_command(region
-00018130: 2c20 2724 6964 272c 2027 5468 726f 7567  , '$id', 'Throug
-00018140: 6870 7574 272c 0a20 2020 2020 2020 2020  hput',.         
-00018150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018170: 7370 6563 735b 2764 6973 6b5f 7468 726f  specs['disk_thro
-00018180: 7567 6870 7574 275d 2929 292c 0a20 2020  ughput']))),.   
-00018190: 2020 2020 2020 2020 205d 2c0a 2020 2020           ],.    
-000181a0: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
-000181b0: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
-000181c0: 2020 2020 2020 2020 2020 2074 696d 656f             timeo
-000181d0: 7574 3d31 3020 2a20 3630 2c20 2023 2031  ut=10 * 60,  # 1
-000181e0: 3020 6d69 6e73 2020 2869 7420 7461 6b65  0 mins  (it take
-000181f0: 7320 6172 6f75 6e64 207e 3620 6d69 6e73  s around ~6 mins
-00018200: 290a 2020 2020 2020 2020 290a 2020 2020  ).        ).    
-00018210: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-00018220: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
-00018230: 2e6d 6172 6b2e 6763 700a 6465 6620 7465  .mark.gcp.def te
-00018240: 7374 5f67 6370 5f64 6973 6b5f 7469 6572  st_gcp_disk_tier
-00018250: 2829 3a0a 2020 2020 666f 7220 6469 736b  ():.    for disk
-00018260: 5f74 6965 7220 696e 205b 276c 6f77 272c  _tier in ['low',
-00018270: 2027 6d65 6469 756d 272c 2027 6869 6768   'medium', 'high
-00018280: 275d 3a0a 2020 2020 2020 2020 7479 7065  ']:.        type
-00018290: 203d 2047 4350 2e5f 6765 745f 6469 736b   = GCP._get_disk
-000182a0: 5f74 7970 6528 6469 736b 5f74 6965 7229  _type(disk_tier)
-000182b0: 0a20 2020 2020 2020 206e 616d 6520 3d20  .        name = 
-000182c0: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-000182d0: 6528 2920 2b20 272d 2720 2b20 6469 736b  e() + '-' + disk
-000182e0: 5f74 6965 720a 2020 2020 2020 2020 7265  _tier.        re
-000182f0: 6769 6f6e 203d 2027 7573 2d77 6573 7432  gion = 'us-west2
-00018300: 270a 2020 2020 2020 2020 7465 7374 203d  '.        test =
-00018310: 2054 6573 7428 0a20 2020 2020 2020 2020   Test(.         
-00018320: 2020 2027 6763 702d 6469 736b 2d74 6965     'gcp-disk-tie
-00018330: 7227 2c0a 2020 2020 2020 2020 2020 2020  r',.            
-00018340: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
-00018350: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-00018360: 7920 2d63 207b 6e61 6d65 7d20 2d2d 636c  y -c {name} --cl
-00018370: 6f75 6420 6763 7020 2d2d 7265 6769 6f6e  oud gcp --region
-00018380: 207b 7265 6769 6f6e 7d20 270a 2020 2020   {region} '.    
-00018390: 2020 2020 2020 2020 2020 2020 6627 2d2d              f'--
-000183a0: 6469 736b 2d74 6965 7220 7b64 6973 6b5f  disk-tier {disk_
-000183b0: 7469 6572 7d20 6563 686f 2022 6865 6c6c  tier} echo "hell
-000183c0: 6f20 736b 7922 272c 0a20 2020 2020 2020  o sky"',.       
-000183d0: 2020 2020 2020 2020 2066 276e 616d 653d           f'name=
-000183e0: 6067 636c 6f75 6420 636f 6d70 7574 6520  `gcloud compute 
-000183f0: 696e 7374 616e 6365 7320 6c69 7374 202d  instances list -
-00018400: 2d66 696c 7465 723d 270a 2020 2020 2020  -filter='.      
-00018410: 2020 2020 2020 2020 2020 6627 226c 6162            f'"lab
-00018420: 656c 732e 7261 792d 636c 7573 7465 722d  els.ray-cluster-
-00018430: 6e61 6d65 3a7b 6e61 6d65 7d22 202d 2d66  name:{name}" --f
-00018440: 6f72 6d61 743d 2276 616c 7565 286e 616d  ormat="value(nam
-00018450: 6529 2260 3b20 270a 2020 2020 2020 2020  e)"`; '.        
-00018460: 2020 2020 2020 2020 6627 6763 6c6f 7564          f'gcloud
-00018470: 2063 6f6d 7075 7465 2064 6973 6b73 206c   compute disks l
-00018480: 6973 7420 2d2d 6669 6c74 6572 3d22 6e61  ist --filter="na
-00018490: 6d65 3d24 6e61 6d65 2220 270a 2020 2020  me=$name" '.    
-000184a0: 2020 2020 2020 2020 2020 2020 6627 2d2d              f'--
-000184b0: 666f 726d 6174 3d22 7661 6c75 6528 7479  format="value(ty
-000184c0: 7065 2922 207c 2067 7265 7020 7b74 7970  pe)" | grep {typ
-000184d0: 657d 2027 0a20 2020 2020 2020 2020 2020  e} '.           
-000184e0: 205d 2c0a 2020 2020 2020 2020 2020 2020   ],.            
-000184f0: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
-00018500: 616d 657d 272c 0a20 2020 2020 2020 2020  ame}',.         
-00018510: 2020 2074 696d 656f 7574 3d36 202a 2036     timeout=6 * 6
-00018520: 302c 2020 2320 3620 6d69 6e73 2020 2869  0,  # 6 mins  (i
-00018530: 7420 7461 6b65 7320 6172 6f75 6e64 207e  t takes around ~
-00018540: 3320 6d69 6e73 290a 2020 2020 2020 2020  3 mins).        
-00018550: 290a 2020 2020 2020 2020 7275 6e5f 6f6e  ).        run_on
-00018560: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
-00018570: 7079 7465 7374 2e6d 6172 6b2e 617a 7572  pytest.mark.azur
-00018580: 650a 6465 6620 7465 7374 5f61 7a75 7265  e.def test_azure
-00018590: 5f64 6973 6b5f 7469 6572 2829 3a0a 2020  _disk_tier():.  
-000185a0: 2020 666f 7220 6469 736b 5f74 6965 7220    for disk_tier 
-000185b0: 696e 205b 276c 6f77 272c 2027 6d65 6469  in ['low', 'medi
-000185c0: 756d 275d 3a0a 2020 2020 2020 2020 7479  um']:.        ty
-000185d0: 7065 203d 2041 7a75 7265 2e5f 6765 745f  pe = Azure._get_
-000185e0: 6469 736b 5f74 7970 6528 6469 736b 5f74  disk_type(disk_t
-000185f0: 6965 7229 0a20 2020 2020 2020 206e 616d  ier).        nam
-00018600: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-00018610: 5f6e 616d 6528 2920 2b20 272d 2720 2b20  _name() + '-' + 
-00018620: 6469 736b 5f74 6965 720a 2020 2020 2020  disk_tier.      
-00018630: 2020 7265 6769 6f6e 203d 2027 7765 7374    region = 'west
-00018640: 7573 3227 0a20 2020 2020 2020 2074 6573  us2'.        tes
-00018650: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-00018660: 2020 2020 2020 2761 7a75 7265 2d64 6973        'azure-dis
-00018670: 6b2d 7469 6572 272c 0a20 2020 2020 2020  k-tier',.       
-00018680: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-00018690: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-000186a0: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
-000186b0: 202d 2d63 6c6f 7564 2061 7a75 7265 202d   --cloud azure -
-000186c0: 2d72 6567 696f 6e20 7b72 6567 696f 6e7d  -region {region}
-000186d0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-000186e0: 2020 2066 272d 2d64 6973 6b2d 7469 6572     f'--disk-tier
-000186f0: 207b 6469 736b 5f74 6965 727d 2065 6368   {disk_tier} ech
-00018700: 6f20 2268 656c 6c6f 2073 6b79 2227 2c0a  o "hello sky"',.
-00018710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018720: 6627 617a 2072 6573 6f75 7263 6520 6c69  f'az resource li
-00018730: 7374 202d 2d74 6167 2072 6179 2d63 6c75  st --tag ray-clu
-00018740: 7374 6572 2d6e 616d 653d 7b6e 616d 657d  ster-name={name}
-00018750: 202d 2d71 7565 7279 2027 0a20 2020 2020   --query '.     
-00018760: 2020 2020 2020 2020 2020 2066 2722 5b3f             f'"[?
-00018770: 7479 7065 3d3d 5c27 4d69 6372 6f73 6f66  type==\'Microsof
-00018780: 742e 436f 6d70 7574 652f 6469 736b 735c  t.Compute/disks\
-00018790: 275d 2e73 6b75 2e6e 616d 6522 2027 0a20  '].sku.name" '. 
-000187a0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-000187b0: 272d 2d6f 7574 7075 7420 7473 7620 7c20  '--output tsv | 
-000187c0: 6772 6570 207b 7479 7065 7d27 0a20 2020  grep {type}'.   
-000187d0: 2020 2020 2020 2020 205d 2c0a 2020 2020           ],.    
-000187e0: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
-000187f0: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
-00018800: 2020 2020 2020 2020 2020 2074 696d 656f             timeo
-00018810: 7574 3d32 3020 2a20 3630 2c20 2023 2032  ut=20 * 60,  # 2
-00018820: 3020 6d69 6e73 2020 2869 7420 7461 6b65  0 mins  (it take
-00018830: 7320 6172 6f75 6e64 207e 3132 206d 696e  s around ~12 min
-00018840: 7329 0a20 2020 2020 2020 2029 0a20 2020  s).        ).   
-00018850: 2020 2020 2072 756e 5f6f 6e65 5f74 6573       run_one_tes
-00018860: 7428 7465 7374 290a 0a0a 2320 2d2d 2d2d  t(test)...# ----
-00018870: 2d2d 2054 6573 7469 6e67 205a 6572 6f20  -- Testing Zero 
-00018880: 5175 6f74 6120 4661 696c 6f76 6572 202d  Quota Failover -
-00018890: 2d2d 2d2d 2d0a 4070 7974 6573 742e 6d61  -----.@pytest.ma
-000188a0: 726b 2e61 7773 0a64 6566 2074 6573 745f  rk.aws.def test_
-000188b0: 6177 735f 7a65 726f 5f71 756f 7461 5f66  aws_zero_quota_f
-000188c0: 6169 6c6f 7665 7228 293a 0a0a 2020 2020  ailover():..    
-000188d0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
-000188e0: 7465 725f 6e61 6d65 2829 0a20 2020 2072  ter_name().    r
-000188f0: 6567 696f 6e20 3d20 6765 745f 6177 735f  egion = get_aws_
-00018900: 7265 6769 6f6e 5f66 6f72 5f71 756f 7461  region_for_quota
-00018910: 5f66 6169 6c6f 7665 7228 290a 0a20 2020  _failover()..   
-00018920: 2069 6620 6e6f 7420 7265 6769 6f6e 3a0a   if not region:.
-00018930: 2020 2020 2020 2020 7079 7465 7374 2e78          pytest.x
-00018940: 6661 696c 280a 2020 2020 2020 2020 2020  fail(.          
-00018950: 2020 2755 6e61 626c 6520 746f 2074 6573    'Unable to tes
-00018960: 7420 7a65 726f 2071 756f 7461 2066 6169  t zero quota fai
-00018970: 6c6f 7665 7220 6f70 7469 6d69 7a61 7469  lover optimizati
-00018980: 6f6e 20e2 8094 2071 756f 7461 7320 270a  on ... quotas '.
-00018990: 2020 2020 2020 2020 2020 2020 2766 6f72              'for
-000189a0: 2045 4332 2050 3320 696e 7374 616e 6365   EC2 P3 instance
-000189b0: 7320 7765 7265 2066 6f75 6e64 206f 6e20  s were found on 
-000189c0: 616c 6c20 4157 5320 7265 6769 6f6e 732e  all AWS regions.
-000189d0: 2049 7320 7468 6973 2027 0a20 2020 2020   Is this '.     
-000189e0: 2020 2020 2020 2027 6578 7065 6374 6564         'expected
-000189f0: 2066 6f72 2079 6f75 7220 6163 636f 756e   for your accoun
-00018a00: 743f 2729 0a20 2020 2020 2020 2072 6574  t?').        ret
-00018a10: 7572 6e0a 0a20 2020 2074 6573 7420 3d20  urn..    test = 
-00018a20: 5465 7374 280a 2020 2020 2020 2020 2761  Test(.        'a
-00018a30: 7773 2d7a 6572 6f2d 7175 6f74 612d 6661  ws-zero-quota-fa
-00018a40: 696c 6f76 6572 272c 0a20 2020 2020 2020  ilover',.       
-00018a50: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-00018a60: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
-00018a70: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
-00018a80: 2061 7773 202d 2d72 6567 696f 6e20 7b72   aws --region {r
-00018a90: 6567 696f 6e7d 202d 2d67 7075 7320 5631  egion} --gpus V1
-00018aa0: 3030 3a38 202d 2d75 7365 2d73 706f 7420  00:8 --use-spot 
-00018ab0: 7c20 6772 6570 2022 466f 756e 6420 6e6f  | grep "Found no
-00018ac0: 2071 756f 7461 2227 2c0a 2020 2020 2020   quota"',.      
-00018ad0: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
-00018ae0: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
-00018af0: 7d27 2c0a 2020 2020 290a 2020 2020 7275  }',.    ).    ru
-00018b00: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-00018b10: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
-00018b20: 6763 700a 6465 6620 7465 7374 5f67 6370  gcp.def test_gcp
-00018b30: 5f7a 6572 6f5f 7175 6f74 615f 6661 696c  _zero_quota_fail
-00018b40: 6f76 6572 2829 3a0a 0a20 2020 206e 616d  over():..    nam
-00018b50: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-00018b60: 5f6e 616d 6528 290a 2020 2020 7265 6769  _name().    regi
-00018b70: 6f6e 203d 2067 6574 5f67 6370 5f72 6567  on = get_gcp_reg
-00018b80: 696f 6e5f 666f 725f 7175 6f74 615f 6661  ion_for_quota_fa
-00018b90: 696c 6f76 6572 2829 0a0a 2020 2020 6966  ilover()..    if
-00018ba0: 206e 6f74 2072 6567 696f 6e3a 0a20 2020   not region:.   
-00018bb0: 2020 2020 2070 7974 6573 742e 7866 6169       pytest.xfai
-00018bc0: 6c28 0a20 2020 2020 2020 2020 2020 2027  l(.            '
-00018bd0: 556e 6162 6c65 2074 6f20 7465 7374 207a  Unable to test z
-00018be0: 6572 6f20 7175 6f74 6120 6661 696c 6f76  ero quota failov
-00018bf0: 6572 206f 7074 696d 697a 6174 696f 6e20  er optimization 
-00018c00: e280 9420 7175 6f74 6173 2027 0a20 2020  ... quotas '.   
-00018c10: 2020 2020 2020 2020 2027 666f 7220 4131           'for A1
-00018c20: 3030 2d38 3047 4220 4750 5573 2077 6572  00-80GB GPUs wer
-00018c30: 6520 666f 756e 6420 6f6e 2061 6c6c 2047  e found on all G
-00018c40: 4350 2072 6567 696f 6e73 2e20 4973 2074  CP regions. Is t
-00018c50: 6869 7320 270a 2020 2020 2020 2020 2020  his '.          
-00018c60: 2020 2765 7870 6563 7465 6420 666f 7220    'expected for 
-00018c70: 796f 7572 2061 6363 6f75 6e74 3f27 290a  your account?').
-00018c80: 2020 2020 2020 2020 7265 7475 726e 0a0a          return..
-00018c90: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-00018ca0: 0a20 2020 2020 2020 2027 6763 702d 7a65  .        'gcp-ze
-00018cb0: 726f 2d71 756f 7461 2d66 6169 6c6f 7665  ro-quota-failove
-00018cc0: 7227 2c0a 2020 2020 2020 2020 5b0a 2020  r',.        [.  
-00018cd0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00018ce0: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
-00018cf0: 6d65 7d20 2d2d 636c 6f75 6420 6763 7020  me} --cloud gcp 
-00018d00: 2d2d 7265 6769 6f6e 207b 7265 6769 6f6e  --region {region
-00018d10: 7d20 2d2d 6770 7573 2041 3130 302d 3830  } --gpus A100-80
-00018d20: 4742 3a31 202d 2d75 7365 2d73 706f 7420  GB:1 --use-spot 
-00018d30: 7c20 6772 6570 2022 466f 756e 6420 6e6f  | grep "Found no
-00018d40: 2071 756f 7461 2227 2c0a 2020 2020 2020   quota"',.      
-00018d50: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
-00018d60: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
-00018d70: 7d27 2c0a 2020 2020 290a 2020 2020 7275  }',.    ).    ru
-00018d80: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-00018d90: 0a0a 0a23 202d 2d2d 2d2d 2d2d 2054 6573  ...# ------- Tes
-00018da0: 7469 6e67 2075 7365 7220 7261 7920 636c  ting user ray cl
-00018db0: 7573 7465 7220 2d2d 2d2d 2d2d 2d2d 0a64  uster --------.d
-00018dc0: 6566 2074 6573 745f 7573 6572 5f72 6179  ef test_user_ray
-00018dd0: 5f63 6c75 7374 6572 2829 3a0a 2020 2020  _cluster():.    
-00018de0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
-00018df0: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
-00018e00: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-00018e10: 2020 2020 2775 7365 722d 7261 792d 636c      'user-ray-cl
-00018e20: 7573 7465 7227 2c0a 2020 2020 2020 2020  uster',.        
-00018e30: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
-00018e40: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
-00018e50: 207b 6e61 6d65 7d20 2272 6179 2073 7461   {name} "ray sta
-00018e60: 7274 202d 2d68 6561 6422 272c 0a20 2020  rt --head"',.   
-00018e70: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
-00018e80: 7865 6320 7b6e 616d 657d 2022 6563 686f  xec {name} "echo
-00018e90: 2068 6922 272c 0a20 2020 2020 2020 2020   hi"',.         
-00018ea0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-00018eb0: 616d 657d 2031 202d 2d73 7461 7475 7327  ame} 1 --status'
-00018ec0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00018ed0: 736b 7920 7374 6174 7573 202d 7220 7c20  sky status -r | 
-00018ee0: 6772 6570 207b 6e61 6d65 7d20 7c20 6772  grep {name} | gr
-00018ef0: 6570 2055 5027 2c0a 2020 2020 2020 2020  ep UP',.        
-00018f00: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
-00018f10: 6e61 6d65 7d20 2265 6368 6f20 6279 6522  name} "echo bye"
-00018f20: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00018f30: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-00018f40: 2032 202d 2d73 7461 7475 7327 2c0a 2020   2 --status',.  
-00018f50: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-00018f60: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
-00018f70: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
-00018f80: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-00018f90: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
-00018fa0: 2054 6573 7469 6e67 2074 6865 2063 6f72   Testing the cor
-00018fb0: 6520 4150 4920 2d2d 2d2d 2d2d 2d2d 0a23  e API --------.#
-00018fc0: 204d 6f73 7420 6f66 2074 6865 2063 6f72   Most of the cor
-00018fd0: 6520 4150 4973 2068 6176 6520 6265 656e  e APIs have been
-00018fe0: 2074 6573 7465 6420 696e 2074 6865 2043   tested in the C
-00018ff0: 4c49 2074 6573 7473 2e0a 2320 5468 6573  LI tests..# Thes
-00019000: 6520 7465 7374 7320 6172 6520 666f 7220  e tests are for 
-00019010: 7465 7374 696e 6720 7468 6520 7265 7475  testing the retu
-00019020: 726e 2076 616c 7565 206f 6620 7468 6520  rn value of the 
-00019030: 4150 4973 206e 6f74 2066 756c 6c79 2075  APIs not fully u
-00019040: 7365 6420 696e 2043 4c49 2e0a 6465 6620  sed in CLI..def 
-00019050: 7465 7374 5f63 6f72 655f 6170 6928 293a  test_core_api():
-00019060: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-00019070: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
-00019080: 2020 2020 736b 792e 6c61 756e 6368 0a20      sky.launch. 
-00019090: 2020 2023 2054 4f44 4f28 7a68 7775 293a     # TODO(zhwu):
-000190a0: 2041 6464 2061 2074 6573 7420 666f 7220   Add a test for 
-000190b0: 636f 7265 2061 7069 2e0a 0a0a 2320 2d2d  core api....# --
-000190c0: 2d2d 2d2d 2d2d 2d2d 2054 6573 7469 6e67  -------- Testing
-000190d0: 2053 746f 7261 6765 202d 2d2d 2d2d 2d2d   Storage -------
-000190e0: 2d2d 2d0a 636c 6173 7320 5465 7374 5374  ---.class TestSt
-000190f0: 6f72 6167 6557 6974 6843 7265 6465 6e74  orageWithCredent
-00019100: 6961 6c73 3a0a 2020 2020 2222 2253 746f  ials:.    """Sto
-00019110: 7261 6765 2074 6573 7473 2077 6869 6368  rage tests which
-00019120: 2072 6571 7569 7265 2063 7265 6465 6e74   require credent
-00019130: 6961 6c73 2061 6e64 206e 6574 776f 726b  ials and network
-00019140: 2063 6f6e 6e65 6374 696f 6e22 2222 0a0a   connection"""..
-00019150: 2020 2020 4157 535f 494e 5641 4c49 445f      AWS_INVALID_
-00019160: 4e41 4d45 5320 3d20 5b0a 2020 2020 2020  NAMES = [.      
-00019170: 2020 2761 6227 2c20 2023 206c 6573 7320    'ab',  # less 
-00019180: 7468 616e 2033 2063 6861 7261 6374 6572  than 3 character
-00019190: 730a 2020 2020 2020 2020 2761 6263 6465  s.        'abcde
-000191a0: 6667 6869 6a6b 6c6d 6e6f 7071 7273 7475  fghijklmnopqrstu
-000191b0: 7677 7879 7a61 6263 6465 6667 6869 6a6b  vwxyzabcdefghijk
-000191c0: 6c6d 6e6f 7071 7273 7475 7677 7879 7a61  lmnopqrstuvwxyza
-000191d0: 6263 6465 6667 6869 6a6b 6c6d 6e6f 7071  bcdefghijklmnopq
-000191e0: 7273 7475 7677 7879 7a31 272c 0a20 2020  rstuvwxyz1',.   
-000191f0: 2020 2020 2023 206d 6f72 6520 7468 616e       # more than
-00019200: 2036 3320 6368 6172 6163 7465 7273 0a20   63 characters. 
-00019210: 2020 2020 2020 2027 4162 6364 6566 272c         'Abcdef',
-00019220: 2020 2320 636f 6e74 6169 6e73 2061 6e20    # contains an 
-00019230: 7570 7065 7263 6173 6520 6c65 7474 6572  uppercase letter
-00019240: 0a20 2020 2020 2020 2027 6162 6320 6465  .        'abc de
-00019250: 6627 2c20 2023 2063 6f6e 7461 696e 7320  f',  # contains 
-00019260: 6120 7370 6163 650a 2020 2020 2020 2020  a space.        
-00019270: 2761 6263 2e2e 6465 6627 2c20 2023 2074  'abc..def',  # t
-00019280: 776f 2061 646a 6163 656e 7420 7065 7269  wo adjacent peri
-00019290: 6f64 730a 2020 2020 2020 2020 2731 3932  ods.        '192
-000192a0: 2e31 3638 2e35 2e34 272c 2020 2320 666f  .168.5.4',  # fo
-000192b0: 726d 6174 7465 6420 6173 2061 6e20 4950  rmatted as an IP
-000192c0: 2061 6464 7265 7373 0a20 2020 2020 2020   address.       
-000192d0: 2027 786e 2d2d 6275 636b 6574 272c 2020   'xn--bucket',  
-000192e0: 2320 7374 6172 7473 2077 6974 6820 2778  # starts with 'x
-000192f0: 6e2d 2d27 2070 7265 6669 780a 2020 2020  n--' prefix.    
-00019300: 2020 2020 2762 7563 6b65 742d 7333 616c      'bucket-s3al
-00019310: 6961 7327 2c20 2023 2065 6e64 7320 7769  ias',  # ends wi
-00019320: 7468 2027 2d73 3361 6c69 6173 2720 7375  th '-s3alias' su
-00019330: 6666 6978 0a20 2020 2020 2020 2027 6275  ffix.        'bu
-00019340: 636b 6574 2d2d 6f6c 2d73 3327 2c20 2023  cket--ol-s3',  #
-00019350: 2065 6e64 7320 7769 7468 2027 2d2d 6f6c   ends with '--ol
-00019360: 2d73 3327 2073 7566 6669 780a 2020 2020  -s3' suffix.    
-00019370: 2020 2020 272e 6162 6327 2c20 2023 2073      '.abc',  # s
-00019380: 7461 7274 7320 7769 7468 2061 2064 6f74  tarts with a dot
-00019390: 0a20 2020 2020 2020 2027 6162 632e 272c  .        'abc.',
-000193a0: 2020 2320 656e 6473 2077 6974 6820 6120    # ends with a 
-000193b0: 646f 740a 2020 2020 2020 2020 272d 6162  dot.        '-ab
-000193c0: 6327 2c20 2023 2073 7461 7274 7320 7769  c',  # starts wi
-000193d0: 7468 2061 2068 7970 6865 6e0a 2020 2020  th a hyphen.    
-000193e0: 2020 2020 2761 6263 2d27 2c20 2023 2065      'abc-',  # e
-000193f0: 6e64 7320 7769 7468 2061 2068 7970 6865  nds with a hyphe
-00019400: 6e0a 2020 2020 5d0a 0a20 2020 2047 4353  n.    ]..    GCS
-00019410: 5f49 4e56 414c 4944 5f4e 414d 4553 203d  _INVALID_NAMES =
-00019420: 205b 0a20 2020 2020 2020 2027 6162 272c   [.        'ab',
-00019430: 2020 2320 6c65 7373 2074 6861 6e20 3320    # less than 3 
-00019440: 6368 6172 6163 7465 7273 0a20 2020 2020  characters.     
-00019450: 2020 2027 6162 6364 6566 6768 696a 6b6c     'abcdefghijkl
-00019460: 6d6e 6f70 7172 7374 7576 7778 797a 6162  mnopqrstuvwxyzab
-00019470: 6364 6566 6768 696a 6b6c 6d6e 6f70 7172  cdefghijklmnopqr
-00019480: 7374 7576 7778 797a 6162 6364 6566 6768  stuvwxyzabcdefgh
-00019490: 696a 6b6c 6d6e 6f70 7172 7374 7576 7778  ijklmnopqrstuvwx
-000194a0: 797a 3127 2c0a 2020 2020 2020 2020 2320  yz1',.        # 
-000194b0: 6d6f 7265 2074 6861 6e20 3633 2063 6861  more than 63 cha
-000194c0: 7261 6374 6572 7320 2877 6974 686f 7574  racters (without
-000194d0: 2064 6f74 7329 0a20 2020 2020 2020 2027   dots).        '
-000194e0: 4162 6364 6566 272c 2020 2320 636f 6e74  Abcdef',  # cont
-000194f0: 6169 6e73 2061 6e20 7570 7065 7263 6173  ains an uppercas
-00019500: 6520 6c65 7474 6572 0a20 2020 2020 2020  e letter.       
-00019510: 2027 6162 6320 6465 6627 2c20 2023 2063   'abc def',  # c
-00019520: 6f6e 7461 696e 7320 6120 7370 6163 650a  ontains a space.
-00019530: 2020 2020 2020 2020 2761 6263 2e2e 6465          'abc..de
-00019540: 6627 2c20 2023 2074 776f 2061 646a 6163  f',  # two adjac
-00019550: 656e 7420 7065 7269 6f64 730a 2020 2020  ent periods.    
-00019560: 2020 2020 2761 6263 5f2e 6465 662e 6768      'abc_.def.gh
-00019570: 692e 6a6b 6c6d 6e6f 7071 7273 7475 7677  i.jklmnopqrstuvw
-00019580: 7879 7a61 6263 6465 6667 6869 6a6b 6c6d  xyzabcdefghijklm
-00019590: 6e6f 7071 7273 7475 7677 7879 7a61 6263  nopqrstuvwxyzabc
-000195a0: 6465 6667 6869 6a6b 6c6d 6e6f 7071 7273  defghijklmnopqrs
-000195b0: 7475 7677 7879 7a31 270a 2020 2020 2020  tuvwxyz1'.      
-000195c0: 2020 2320 4d6f 7265 2074 6861 6e20 3633    # More than 63
-000195d0: 2063 6861 7261 6374 6572 7320 6265 7477   characters betw
-000195e0: 6565 6e20 646f 7473 0a20 2020 2020 2020  een dots.       
-000195f0: 2027 6162 635f 2e64 6566 2e67 6869 2e6a   'abc_.def.ghi.j
-00019600: 6b6c 6d6e 6f70 7172 7374 7576 7778 797a  klmnopqrstuvwxyz
-00019610: 6162 6364 6566 6768 696a 6b6c 6d6e 6f70  abcdefghijklmnop
-00019620: 7166 6768 696a 6b6c 6d6e 6f70 7172 7374  qfghijklmnopqrst
-00019630: 7576 7727 202a 2035 2c0a 2020 2020 2020  uvw' * 5,.      
-00019640: 2020 2320 6d6f 7265 2074 6861 6e20 3232    # more than 22
-00019650: 3220 6368 6172 6163 7465 7273 2028 7769  2 characters (wi
-00019660: 7468 2064 6f74 7329 0a20 2020 2020 2020  th dots).       
-00019670: 2027 3139 322e 3136 382e 352e 3427 2c20   '192.168.5.4', 
-00019680: 2023 2066 6f72 6d61 7474 6564 2061 7320   # formatted as 
-00019690: 616e 2049 5020 6164 6472 6573 730a 2020  an IP address.  
-000196a0: 2020 2020 2020 2767 6f6f 6762 7563 6b65        'googbucke
-000196b0: 7427 2c20 2023 2073 7461 7274 7320 7769  t',  # starts wi
-000196c0: 7468 2027 676f 6f67 2720 7072 6566 6978  th 'goog' prefix
-000196d0: 0a20 2020 2020 2020 2027 676f 6f67 6c65  .        'google
-000196e0: 6275 636b 6574 272c 2020 2320 636f 6e74  bucket',  # cont
-000196f0: 6169 6e73 2027 676f 6f67 6c65 270a 2020  ains 'google'.  
-00019700: 2020 2020 2020 2767 3030 676c 6562 7563        'g00glebuc
-00019710: 6b65 7427 2c20 2023 2076 6172 6961 6e74  ket',  # variant
-00019720: 206f 6620 2767 6f6f 676c 6527 0a20 2020   of 'google'.   
-00019730: 2020 2020 2027 676f 3067 6c65 6275 636b       'go0glebuck
-00019740: 6574 272c 2020 2320 7661 7269 616e 7420  et',  # variant 
-00019750: 6f66 2027 676f 6f67 6c65 270a 2020 2020  of 'google'.    
-00019760: 2020 2020 2767 306f 676c 6562 7563 6b65      'g0oglebucke
-00019770: 7427 2c20 2023 2076 6172 6961 6e74 206f  t',  # variant o
-00019780: 6620 2767 6f6f 676c 6527 0a20 2020 2020  f 'google'.     
-00019790: 2020 2027 2e61 6263 272c 2020 2320 7374     '.abc',  # st
-000197a0: 6172 7473 2077 6974 6820 6120 646f 740a  arts with a dot.
-000197b0: 2020 2020 2020 2020 2761 6263 2e27 2c20          'abc.', 
-000197c0: 2023 2065 6e64 7320 7769 7468 2061 2064   # ends with a d
-000197d0: 6f74 0a20 2020 2020 2020 2027 5f61 6263  ot.        '_abc
-000197e0: 272c 2020 2320 7374 6172 7473 2077 6974  ',  # starts wit
-000197f0: 6820 616e 2075 6e64 6572 7363 6f72 650a  h an underscore.
-00019800: 2020 2020 2020 2020 2761 6263 5f27 2c20          'abc_', 
-00019810: 2023 2065 6e64 7320 7769 7468 2061 6e20   # ends with an 
-00019820: 756e 6465 7273 636f 7265 0a20 2020 205d  underscore.    ]
-00019830: 0a0a 2020 2020 4942 4d5f 494e 5641 4c49  ..    IBM_INVALI
-00019840: 445f 4e41 4d45 5320 3d20 5b0a 2020 2020  D_NAMES = [.    
-00019850: 2020 2020 2761 6227 2c20 2023 206c 6573      'ab',  # les
-00019860: 7320 7468 616e 2033 2063 6861 7261 6374  s than 3 charact
-00019870: 6572 730a 2020 2020 2020 2020 2761 6263  ers.        'abc
-00019880: 6465 6667 6869 6a6b 6c6d 6e6f 7071 7273  defghijklmnopqrs
-00019890: 7475 7677 7879 7a61 6263 6465 6667 6869  tuvwxyzabcdefghi
-000198a0: 6a6b 6c6d 6e6f 7071 7273 7475 7677 7879  jklmnopqrstuvwxy
-000198b0: 7a61 6263 6465 6667 6869 6a6b 6c6d 6e6f  zabcdefghijklmno
-000198c0: 7071 7273 7475 7677 7879 7a31 272c 0a20  pqrstuvwxyz1',. 
-000198d0: 2020 2020 2020 2023 206d 6f72 6520 7468         # more th
-000198e0: 616e 2036 3320 6368 6172 6163 7465 7273  an 63 characters
-000198f0: 0a20 2020 2020 2020 2027 4162 6364 6566  .        'Abcdef
-00019900: 272c 2020 2320 636f 6e74 6169 6e73 2061  ',  # contains a
-00019910: 6e20 7570 7065 7263 6173 6520 6c65 7474  n uppercase lett
-00019920: 6572 0a20 2020 2020 2020 2027 6162 6320  er.        'abc 
-00019930: 6465 6627 2c20 2023 2063 6f6e 7461 696e  def',  # contain
-00019940: 7320 6120 7370 6163 650a 2020 2020 2020  s a space.      
-00019950: 2020 2761 6263 2e2e 6465 6627 2c20 2023    'abc..def',  #
-00019960: 2074 776f 2061 646a 6163 656e 7420 7065   two adjacent pe
-00019970: 7269 6f64 730a 2020 2020 2020 2020 2731  riods.        '1
-00019980: 3932 2e31 3638 2e35 2e34 272c 2020 2320  92.168.5.4',  # 
-00019990: 666f 726d 6174 7465 6420 6173 2061 6e20  formatted as an 
-000199a0: 4950 2061 6464 7265 7373 0a20 2020 2020  IP address.     
-000199b0: 2020 2027 786e 2d2d 6275 636b 6574 272c     'xn--bucket',
-000199c0: 2020 2320 7374 6172 7473 2077 6974 6820    # starts with 
-000199d0: 2778 6e2d 2d27 2070 7265 6669 780a 2020  'xn--' prefix.  
-000199e0: 2020 2020 2020 272e 6162 6327 2c20 2023        '.abc',  #
-000199f0: 2073 7461 7274 7320 7769 7468 2061 2064   starts with a d
-00019a00: 6f74 0a20 2020 2020 2020 2027 6162 632e  ot.        'abc.
-00019a10: 272c 2020 2320 656e 6473 2077 6974 6820  ',  # ends with 
-00019a20: 6120 646f 740a 2020 2020 2020 2020 272d  a dot.        '-
-00019a30: 6162 6327 2c20 2023 2073 7461 7274 7320  abc',  # starts 
-00019a40: 7769 7468 2061 2068 7970 6865 6e0a 2020  with a hyphen.  
-00019a50: 2020 2020 2020 2761 6263 2d27 2c20 2023        'abc-',  #
-00019a60: 2065 6e64 7320 7769 7468 2061 2068 7970   ends with a hyp
-00019a70: 6865 6e0a 2020 2020 2020 2020 2761 2e2d  hen.        'a.-
-00019a80: 6263 272c 2020 2320 636f 6e74 6169 6e73  bc',  # contains
-00019a90: 2074 6865 2073 6571 7565 6e63 6520 272e   the sequence '.
-00019aa0: 2d27 0a20 2020 2020 2020 2027 612d 2e62  -'.        'a-.b
-00019ab0: 6327 2c20 2023 2063 6f6e 7461 696e 7320  c',  # contains 
-00019ac0: 7468 6520 7365 7175 656e 6365 2027 2d2e  the sequence '-.
-00019ad0: 270a 2020 2020 2020 2020 2761 2662 6327  '.        'a&bc'
-00019ae0: 2020 2320 636f 6e74 6169 6e73 2073 7065    # contains spe
-00019af0: 6369 616c 2063 6861 7261 6374 6572 730a  cial characters.
-00019b00: 2020 2020 2020 2020 2761 625e 6327 2020          'ab^c'  
-00019b10: 2320 636f 6e74 6169 6e73 2073 7065 6369  # contains speci
-00019b20: 616c 2063 6861 7261 6374 6572 730a 2020  al characters.  
-00019b30: 2020 5d0a 2020 2020 4749 5449 474e 4f52    ].    GITIGNOR
-00019b40: 455f 5359 4e43 5f54 4553 545f 4449 525f  E_SYNC_TEST_DIR_
-00019b50: 5354 5255 4354 5552 4520 3d20 7b0a 2020  STRUCTURE = {.  
-00019b60: 2020 2020 2020 2764 6f75 626c 655f 6173        'double_as
-00019b70: 7465 7269 736b 273a 207b 0a20 2020 2020  terisk': {.     
-00019b80: 2020 2020 2020 2027 646f 7562 6c65 5f61         'double_a
-00019b90: 7374 6572 6973 6b5f 6578 636c 7564 6564  sterisk_excluded
-00019ba0: 273a 204e 6f6e 652c 0a20 2020 2020 2020  ': None,.       
-00019bb0: 2020 2020 2027 646f 7562 6c65 5f61 7374       'double_ast
-00019bc0: 6572 6973 6b5f 6578 636c 7564 6564 5f64  erisk_excluded_d
-00019bd0: 6972 273a 207b 0a20 2020 2020 2020 2020  ir': {.         
-00019be0: 2020 2020 2020 2027 6469 725f 6578 636c         'dir_excl
-00019bf0: 7564 6564 273a 204e 6f6e 652c 0a20 2020  uded': None,.   
-00019c00: 2020 2020 2020 2020 207d 2c0a 2020 2020           },.    
-00019c10: 2020 2020 7d2c 0a20 2020 2020 2020 2027      },.        '
-00019c20: 646f 7562 6c65 5f61 7374 6572 6973 6b5f  double_asterisk_
-00019c30: 7061 7265 6e74 273a 207b 0a20 2020 2020  parent': {.     
-00019c40: 2020 2020 2020 2027 7061 7265 6e74 273a         'parent':
-00019c50: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00019c60: 2020 2027 616c 736f 5f65 7863 6c75 6465     'also_exclude
-00019c70: 642e 7478 7427 3a20 4e6f 6e65 2c0a 2020  d.txt': None,.  
-00019c80: 2020 2020 2020 2020 2020 2020 2020 2763                'c
-00019c90: 6869 6c64 273a 207b 0a20 2020 2020 2020  hild': {.       
-00019ca0: 2020 2020 2020 2020 2020 2020 2027 646f               'do
-00019cb0: 7562 6c65 5f61 7374 6572 6973 6b5f 7061  uble_asterisk_pa
-00019cc0: 7265 6e74 5f63 6869 6c64 5f65 7863 6c75  rent_child_exclu
-00019cd0: 6465 642e 7478 7427 3a20 4e6f 6e65 2c0a  ded.txt': None,.
-00019ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019cf0: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
-00019d00: 2020 2027 646f 7562 6c65 5f61 7374 6572     'double_aster
-00019d10: 6973 6b5f 7061 7265 6e74 5f65 7863 6c75  isk_parent_exclu
-00019d20: 6465 642e 7478 7427 3a20 4e6f 6e65 2c0a  ded.txt': None,.
-00019d30: 2020 2020 2020 2020 2020 2020 7d2c 0a20              },. 
-00019d40: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
-00019d50: 2020 2765 7863 6c75 6465 642e 6c6f 6727    'excluded.log'
-00019d60: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
-00019d70: 2765 7863 6c75 6465 645f 6469 7227 3a20  'excluded_dir': 
-00019d80: 7b0a 2020 2020 2020 2020 2020 2020 2765  {.            'e
-00019d90: 7863 6c75 6465 642e 7478 7427 3a20 4e6f  xcluded.txt': No
-00019da0: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
-00019db0: 276e 6573 7465 645f 6578 636c 7564 6564  'nested_excluded
-00019dc0: 273a 207b 0a20 2020 2020 2020 2020 2020  ': {.           
-00019dd0: 2020 2020 2027 6578 636c 7564 6564 273a       'excluded':
-00019de0: 204e 6f6e 652c 0a20 2020 2020 2020 2020   None,.         
-00019df0: 2020 207d 2c0a 2020 2020 2020 2020 7d2c     },.        },
-00019e00: 0a20 2020 2020 2020 2027 6578 702d 3127  .        'exp-1'
-00019e10: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
-00019e20: 2762 655f 6578 636c 7564 6564 273a 204e  'be_excluded': N
-00019e30: 6f6e 652c 0a20 2020 2020 2020 207d 2c0a  one,.        },.
-00019e40: 2020 2020 2020 2020 2765 7870 2d32 273a          'exp-2':
-00019e50: 207b 0a20 2020 2020 2020 2020 2020 2027   {.            '
-00019e60: 6265 5f65 7863 6c75 6465 6427 3a20 4e6f  be_excluded': No
-00019e70: 6e65 2c0a 2020 2020 2020 2020 7d2c 0a20  ne,.        },. 
-00019e80: 2020 2020 2020 2027 6672 6f6e 745f 736c         'front_sl
-00019e90: 6173 685f 6578 636c 7564 6564 273a 204e  ash_excluded': N
-00019ea0: 6f6e 652c 0a20 2020 2020 2020 2027 696e  one,.        'in
-00019eb0: 636c 7564 6564 2e6c 6f67 273a 204e 6f6e  cluded.log': Non
-00019ec0: 652c 0a20 2020 2020 2020 2027 696e 636c  e,.        'incl
-00019ed0: 7564 6564 2e74 7874 273a 204e 6f6e 652c  uded.txt': None,
-00019ee0: 0a20 2020 2020 2020 2027 696e 636c 7564  .        'includ
-00019ef0: 655f 6469 7227 3a20 7b0a 2020 2020 2020  e_dir': {.      
-00019f00: 2020 2020 2020 2765 7863 6c75 6465 642e        'excluded.
-00019f10: 6c6f 6727 3a20 4e6f 6e65 2c0a 2020 2020  log': None,.    
-00019f20: 2020 2020 2020 2020 2769 6e63 6c75 6465          'include
-00019f30: 642e 6c6f 6727 3a20 4e6f 6e65 2c0a 2020  d.log': None,.  
-00019f40: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
-00019f50: 2027 6e65 7374 6564 5f64 6f75 626c 655f   'nested_double_
-00019f60: 6173 7465 7269 736b 273a 207b 0a20 2020  asterisk': {.   
-00019f70: 2020 2020 2020 2020 2027 6f6e 6527 3a20           'one': 
-00019f80: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00019f90: 2020 2761 6c73 6f5f 6578 636c 7564 652e    'also_exclude.
-00019fa0: 7478 7427 3a20 4e6f 6e65 2c0a 2020 2020  txt': None,.    
-00019fb0: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
-00019fc0: 2020 2020 2020 2027 7477 6f27 3a20 7b0a         'two': {.
-00019fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019fe0: 2761 6c73 6f5f 6578 636c 7564 652e 7478  'also_exclude.tx
-00019ff0: 7427 3a20 4e6f 6e65 2c0a 2020 2020 2020  t': None,.      
-0001a000: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
-0001a010: 207d 2c0a 2020 2020 2020 2020 276e 6573   },.        'nes
-0001a020: 7465 645f 7769 6c64 6361 7264 5f64 6972  ted_wildcard_dir
-0001a030: 273a 207b 0a20 2020 2020 2020 2020 2020  ': {.           
-0001a040: 2027 6d6f 6e64 6179 273a 207b 0a20 2020   'monday': {.   
-0001a050: 2020 2020 2020 2020 2020 2020 2027 616c               'al
-0001a060: 736f 5f65 7863 6c75 6465 2e74 7874 273a  so_exclude.txt':
-0001a070: 204e 6f6e 652c 0a20 2020 2020 2020 2020   None,.         
-0001a080: 2020 207d 2c0a 2020 2020 2020 2020 2020     },.          
-0001a090: 2020 2774 7565 7364 6179 273a 207b 0a20    'tuesday': {. 
-0001a0a0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-0001a0b0: 616c 736f 5f65 7863 6c75 6465 2e74 7874  also_exclude.txt
-0001a0c0: 273a 204e 6f6e 652c 0a20 2020 2020 2020  ': None,.       
-0001a0d0: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
-0001a0e0: 7d2c 0a20 2020 2020 2020 2027 6e6f 5f73  },.        'no_s
-0001a0f0: 6c61 7368 5f65 7863 6c75 6465 6427 3a20  lash_excluded': 
-0001a100: 4e6f 6e65 2c0a 2020 2020 2020 2020 276e  None,.        'n
-0001a110: 6f5f 736c 6173 685f 7465 7374 7327 3a20  o_slash_tests': 
-0001a120: 7b0a 2020 2020 2020 2020 2020 2020 276e  {.            'n
-0001a130: 6f5f 736c 6173 685f 6578 636c 7564 6564  o_slash_excluded
-0001a140: 273a 207b 0a20 2020 2020 2020 2020 2020  ': {.           
-0001a150: 2020 2020 2027 616c 736f 5f65 7863 6c75       'also_exclu
-0001a160: 6465 642e 7478 7427 3a20 4e6f 6e65 2c0a  ded.txt': None,.
-0001a170: 2020 2020 2020 2020 2020 2020 7d2c 0a20              },. 
-0001a180: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
-0001a190: 2020 2771 7565 7374 696f 6e5f 6d61 726b    'question_mark
-0001a1a0: 273a 207b 0a20 2020 2020 2020 2020 2020  ': {.           
-0001a1b0: 2027 6578 636c 7564 6564 312e 7478 7427   'excluded1.txt'
-0001a1c0: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
-0001a1d0: 2020 2020 2765 7863 6c75 6465 6440 2e74      'excluded@.t
-0001a1e0: 7874 273a 204e 6f6e 652c 0a20 2020 2020  xt': None,.     
-0001a1f0: 2020 207d 2c0a 2020 2020 2020 2020 2773     },.        's
-0001a200: 7175 6172 655f 6272 6163 6b65 7427 3a20  quare_bracket': 
-0001a210: 7b0a 2020 2020 2020 2020 2020 2020 2765  {.            'e
-0001a220: 7863 6c75 6465 6431 2e74 7874 273a 204e  xcluded1.txt': N
-0001a230: 6f6e 652c 0a20 2020 2020 2020 207d 2c0a  one,.        },.
-0001a240: 2020 2020 2020 2020 2773 7175 6172 655f          'square_
-0001a250: 6272 6163 6b65 745f 616c 7068 6127 3a20  bracket_alpha': 
-0001a260: 7b0a 2020 2020 2020 2020 2020 2020 2765  {.            'e
-0001a270: 7863 6c75 6465 647a 2e74 7874 273a 204e  xcludedz.txt': N
-0001a280: 6f6e 652c 0a20 2020 2020 2020 207d 2c0a  one,.        },.
-0001a290: 2020 2020 2020 2020 2773 7175 6172 655f          'square_
-0001a2a0: 6272 6163 6b65 745f 6578 636c 6127 3a20  bracket_excla': 
-0001a2b0: 7b0a 2020 2020 2020 2020 2020 2020 2765  {.            'e
-0001a2c0: 7863 6c75 6465 6432 2e74 7874 273a 204e  xcluded2.txt': N
-0001a2d0: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
-0001a2e0: 2027 6578 636c 7564 6564 402e 7478 7427   'excluded@.txt'
-0001a2f0: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
-0001a300: 7d2c 0a20 2020 2020 2020 2027 7371 7561  },.        'squa
-0001a310: 7265 5f62 7261 636b 6574 5f73 696e 676c  re_bracket_singl
-0001a320: 6527 3a20 7b0a 2020 2020 2020 2020 2020  e': {.          
-0001a330: 2020 2765 7863 6c75 6465 6430 2e74 7874    'excluded0.txt
-0001a340: 273a 204e 6f6e 652c 0a20 2020 2020 2020  ': None,.       
-0001a350: 207d 2c0a 2020 2020 7d0a 0a20 2020 2040   },.    }..    @
-0001a360: 7374 6174 6963 6d65 7468 6f64 0a20 2020  staticmethod.   
-0001a370: 2064 6566 2063 7265 6174 655f 6469 725f   def create_dir_
-0001a380: 7374 7275 6374 7572 6528 6261 7365 5f70  structure(base_p
-0001a390: 6174 682c 2073 7472 7563 7475 7265 293a  ath, structure):
-0001a3a0: 0a20 2020 2020 2020 2023 2063 7265 6174  .        # creat
-0001a3b0: 6573 2061 2067 6976 656e 2066 696c 6520  es a given file 
-0001a3c0: 5354 5255 4354 5552 4520 696e 2042 4153  STRUCTURE in BAS
-0001a3d0: 455f 5041 5448 0a20 2020 2020 2020 2066  E_PATH.        f
-0001a3e0: 6f72 206e 616d 652c 2073 7562 7374 7275  or name, substru
-0001a3f0: 6374 7572 6520 696e 2073 7472 7563 7475  cture in structu
-0001a400: 7265 2e69 7465 6d73 2829 3a0a 2020 2020  re.items():.    
-0001a410: 2020 2020 2020 2020 7061 7468 203d 206f          path = o
-0001a420: 732e 7061 7468 2e6a 6f69 6e28 6261 7365  s.path.join(base
-0001a430: 5f70 6174 682c 206e 616d 6529 0a20 2020  _path, name).   
-0001a440: 2020 2020 2020 2020 2069 6620 7375 6273           if subs
-0001a450: 7472 7563 7475 7265 2069 7320 4e6f 6e65  tructure is None
-0001a460: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001a470: 2020 2320 4372 6561 7465 2061 2066 696c    # Create a fil
-0001a480: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-0001a490: 2020 6f70 656e 2870 6174 682c 2027 6127    open(path, 'a'
-0001a4a0: 292e 636c 6f73 6528 290a 2020 2020 2020  ).close().      
-0001a4b0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0001a4c0: 2020 2020 2020 2020 2020 2020 2320 4372              # Cr
-0001a4d0: 6561 7465 2061 2073 7562 6469 7265 6374  eate a subdirect
-0001a4e0: 6f72 790a 2020 2020 2020 2020 2020 2020  ory.            
-0001a4f0: 2020 2020 6f73 2e6d 6b64 6972 2870 6174      os.mkdir(pat
-0001a500: 6829 0a20 2020 2020 2020 2020 2020 2020  h).             
-0001a510: 2020 2054 6573 7453 746f 7261 6765 5769     TestStorageWi
-0001a520: 7468 4372 6564 656e 7469 616c 732e 6372  thCredentials.cr
-0001a530: 6561 7465 5f64 6972 5f73 7472 7563 7475  eate_dir_structu
-0001a540: 7265 280a 2020 2020 2020 2020 2020 2020  re(.            
-0001a550: 2020 2020 2020 2020 7061 7468 2c20 7375          path, su
-0001a560: 6273 7472 7563 7475 7265 290a 0a20 2020  bstructure)..   
-0001a570: 2040 7374 6174 6963 6d65 7468 6f64 0a20   @staticmethod. 
-0001a580: 2020 2064 6566 2063 6c69 5f64 656c 6574     def cli_delet
-0001a590: 655f 636d 6428 7374 6f72 655f 7479 7065  e_cmd(store_type
-0001a5a0: 2c20 6275 636b 6574 5f6e 616d 6529 3a0a  , bucket_name):.
-0001a5b0: 2020 2020 2020 2020 6966 2073 746f 7265          if store
-0001a5c0: 5f74 7970 6520 3d3d 2073 746f 7261 6765  _type == storage
-0001a5d0: 5f6c 6962 2e53 746f 7265 5479 7065 2e53  _lib.StoreType.S
-0001a5e0: 333a 0a20 2020 2020 2020 2020 2020 2075  3:.            u
-0001a5f0: 726c 203d 2066 2773 333a 2f2f 7b62 7563  rl = f's3://{buc
-0001a600: 6b65 745f 6e61 6d65 7d27 0a20 2020 2020  ket_name}'.     
-0001a610: 2020 2020 2020 2072 6574 7572 6e20 6627         return f'
-0001a620: 6177 7320 7333 2072 6220 7b75 726c 7d20  aws s3 rb {url} 
-0001a630: 2d2d 666f 7263 6527 0a20 2020 2020 2020  --force'.       
-0001a640: 2069 6620 7374 6f72 655f 7479 7065 203d   if store_type =
-0001a650: 3d20 7374 6f72 6167 655f 6c69 622e 5374  = storage_lib.St
-0001a660: 6f72 6554 7970 652e 4743 533a 0a20 2020  oreType.GCS:.   
-0001a670: 2020 2020 2020 2020 2075 726c 203d 2066           url = f
-0001a680: 2767 733a 2f2f 7b62 7563 6b65 745f 6e61  'gs://{bucket_na
-0001a690: 6d65 7d27 0a20 2020 2020 2020 2020 2020  me}'.           
-0001a6a0: 2067 7375 7469 6c5f 616c 6961 732c 2061   gsutil_alias, a
-0001a6b0: 6c69 6173 5f67 656e 203d 2064 6174 615f  lias_gen = data_
-0001a6c0: 7574 696c 732e 6765 745f 6773 7574 696c  utils.get_gsutil
-0001a6d0: 5f63 6f6d 6d61 6e64 2829 0a20 2020 2020  _command().     
-0001a6e0: 2020 2020 2020 2072 6574 7572 6e20 6627         return f'
-0001a6f0: 7b61 6c69 6173 5f67 656e 7d3b 207b 6773  {alias_gen}; {gs
-0001a700: 7574 696c 5f61 6c69 6173 7d20 726d 202d  util_alias} rm -
-0001a710: 7220 7b75 726c 7d27 0a20 2020 2020 2020  r {url}'.       
-0001a720: 2069 6620 7374 6f72 655f 7479 7065 203d   if store_type =
-0001a730: 3d20 7374 6f72 6167 655f 6c69 622e 5374  = storage_lib.St
-0001a740: 6f72 6554 7970 652e 5232 3a0a 2020 2020  oreType.R2:.    
-0001a750: 2020 2020 2020 2020 656e 6470 6f69 6e74          endpoint
-0001a760: 5f75 726c 203d 2063 6c6f 7564 666c 6172  _url = cloudflar
-0001a770: 652e 6372 6561 7465 5f65 6e64 706f 696e  e.create_endpoin
-0001a780: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
-0001a790: 7572 6c20 3d20 6627 7333 3a2f 2f7b 6275  url = f's3://{bu
-0001a7a0: 636b 6574 5f6e 616d 657d 270a 2020 2020  cket_name}'.    
-0001a7b0: 2020 2020 2020 2020 7265 7475 726e 2066          return f
-0001a7c0: 2741 5753 5f53 4841 5245 445f 4352 4544  'AWS_SHARED_CRED
-0001a7d0: 454e 5449 414c 535f 4649 4c45 3d7b 636c  ENTIALS_FILE={cl
-0001a7e0: 6f75 6466 6c61 7265 2e52 325f 4352 4544  oudflare.R2_CRED
-0001a7f0: 454e 5449 414c 535f 5041 5448 7d20 6177  ENTIALS_PATH} aw
-0001a800: 7320 7333 2072 6220 7b75 726c 7d20 2d2d  s s3 rb {url} --
-0001a810: 666f 7263 6520 2d2d 656e 6470 6f69 6e74  force --endpoint
-0001a820: 207b 656e 6470 6f69 6e74 5f75 726c 7d20   {endpoint_url} 
-0001a830: 2d2d 7072 6f66 696c 653d 7232 270a 2020  --profile=r2'.  
-0001a840: 2020 2020 2020 6966 2073 746f 7265 5f74        if store_t
-0001a850: 7970 6520 3d3d 2073 746f 7261 6765 5f6c  ype == storage_l
-0001a860: 6962 2e53 746f 7265 5479 7065 2e49 424d  ib.StoreType.IBM
-0001a870: 3a0a 2020 2020 2020 2020 2020 2020 6275  :.            bu
-0001a880: 636b 6574 5f72 636c 6f6e 655f 7072 6f66  cket_rclone_prof
-0001a890: 696c 6520 3d20 5263 6c6f 6e65 2e67 656e  ile = Rclone.gen
-0001a8a0: 6572 6174 655f 7263 6c6f 6e65 5f62 7563  erate_rclone_buc
-0001a8b0: 6b65 745f 7072 6f66 696c 655f 6e61 6d65  ket_profile_name
-0001a8c0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0001a8d0: 2020 6275 636b 6574 5f6e 616d 652c 2052    bucket_name, R
-0001a8e0: 636c 6f6e 652e 5263 6c6f 6e65 436c 6f75  clone.RcloneClou
-0001a8f0: 6473 2e49 424d 290a 2020 2020 2020 2020  ds.IBM).        
-0001a900: 2020 2020 7265 7475 726e 2066 2772 636c      return f'rcl
-0001a910: 6f6e 6520 7075 7267 6520 7b62 7563 6b65  one purge {bucke
-0001a920: 745f 7263 6c6f 6e65 5f70 726f 6669 6c65  t_rclone_profile
-0001a930: 7d3a 7b62 7563 6b65 745f 6e61 6d65 7d20  }:{bucket_name} 
-0001a940: 2626 2072 636c 6f6e 6520 636f 6e66 6967  && rclone config
-0001a950: 2064 656c 6574 6520 7b62 7563 6b65 745f   delete {bucket_
-0001a960: 7263 6c6f 6e65 5f70 726f 6669 6c65 7d27  rclone_profile}'
-0001a970: 0a0a 2020 2020 4073 7461 7469 636d 6574  ..    @staticmet
-0001a980: 686f 640a 2020 2020 6465 6620 636c 695f  hod.    def cli_
-0001a990: 6c73 5f63 6d64 2873 746f 7265 5f74 7970  ls_cmd(store_typ
-0001a9a0: 652c 2062 7563 6b65 745f 6e61 6d65 2c20  e, bucket_name, 
-0001a9b0: 7375 6666 6978 3d27 2729 3a0a 2020 2020  suffix=''):.    
-0001a9c0: 2020 2020 6966 2073 746f 7265 5f74 7970      if store_typ
-0001a9d0: 6520 3d3d 2073 746f 7261 6765 5f6c 6962  e == storage_lib
-0001a9e0: 2e53 746f 7265 5479 7065 2e53 333a 0a20  .StoreType.S3:. 
-0001a9f0: 2020 2020 2020 2020 2020 2069 6620 7375             if su
-0001aa00: 6666 6978 3a0a 2020 2020 2020 2020 2020  ffix:.          
-0001aa10: 2020 2020 2020 7572 6c20 3d20 6627 7333        url = f's3
-0001aa20: 3a2f 2f7b 6275 636b 6574 5f6e 616d 657d  ://{bucket_name}
-0001aa30: 2f7b 7375 6666 6978 7d27 0a20 2020 2020  /{suffix}'.     
-0001aa40: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0001aa50: 2020 2020 2020 2020 2020 2020 2075 726c               url
-0001aa60: 203d 2066 2773 333a 2f2f 7b62 7563 6b65   = f's3://{bucke
-0001aa70: 745f 6e61 6d65 7d27 0a20 2020 2020 2020  t_name}'.       
-0001aa80: 2020 2020 2072 6574 7572 6e20 6627 6177       return f'aw
-0001aa90: 7320 7333 206c 7320 7b75 726c 7d27 0a20  s s3 ls {url}'. 
-0001aaa0: 2020 2020 2020 2069 6620 7374 6f72 655f         if store_
-0001aab0: 7479 7065 203d 3d20 7374 6f72 6167 655f  type == storage_
-0001aac0: 6c69 622e 5374 6f72 6554 7970 652e 4743  lib.StoreType.GC
-0001aad0: 533a 0a20 2020 2020 2020 2020 2020 2069  S:.            i
-0001aae0: 6620 7375 6666 6978 3a0a 2020 2020 2020  f suffix:.      
-0001aaf0: 2020 2020 2020 2020 2020 7572 6c20 3d20            url = 
-0001ab00: 6627 6773 3a2f 2f7b 6275 636b 6574 5f6e  f'gs://{bucket_n
-0001ab10: 616d 657d 2f7b 7375 6666 6978 7d27 0a20  ame}/{suffix}'. 
-0001ab20: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0001ab30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001ab40: 2075 726c 203d 2066 2767 733a 2f2f 7b62   url = f'gs://{b
-0001ab50: 7563 6b65 745f 6e61 6d65 7d27 0a20 2020  ucket_name}'.   
-0001ab60: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0001ab70: 6627 6773 7574 696c 206c 7320 7b75 726c  f'gsutil ls {url
-0001ab80: 7d27 0a20 2020 2020 2020 2069 6620 7374  }'.        if st
-0001ab90: 6f72 655f 7479 7065 203d 3d20 7374 6f72  ore_type == stor
-0001aba0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-0001abb0: 652e 5232 3a0a 2020 2020 2020 2020 2020  e.R2:.          
-0001abc0: 2020 656e 6470 6f69 6e74 5f75 726c 203d    endpoint_url =
-0001abd0: 2063 6c6f 7564 666c 6172 652e 6372 6561   cloudflare.crea
-0001abe0: 7465 5f65 6e64 706f 696e 7428 290a 2020  te_endpoint().  
-0001abf0: 2020 2020 2020 2020 2020 6966 2073 7566            if suf
-0001ac00: 6669 783a 0a20 2020 2020 2020 2020 2020  fix:.           
-0001ac10: 2020 2020 2075 726c 203d 2066 2773 333a       url = f's3:
-0001ac20: 2f2f 7b62 7563 6b65 745f 6e61 6d65 7d2f  //{bucket_name}/
-0001ac30: 7b73 7566 6669 787d 270a 2020 2020 2020  {suffix}'.      
-0001ac40: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0001ac50: 2020 2020 2020 2020 2020 2020 7572 6c20              url 
-0001ac60: 3d20 6627 7333 3a2f 2f7b 6275 636b 6574  = f's3://{bucket
-0001ac70: 5f6e 616d 657d 270a 2020 2020 2020 2020  _name}'.        
-0001ac80: 2020 2020 7265 7475 726e 2066 2741 5753      return f'AWS
-0001ac90: 5f53 4841 5245 445f 4352 4544 454e 5449  _SHARED_CREDENTI
-0001aca0: 414c 535f 4649 4c45 3d7b 636c 6f75 6466  ALS_FILE={cloudf
-0001acb0: 6c61 7265 2e52 325f 4352 4544 454e 5449  lare.R2_CREDENTI
-0001acc0: 414c 535f 5041 5448 7d20 6177 7320 7333  ALS_PATH} aws s3
-0001acd0: 206c 7320 7b75 726c 7d20 2d2d 656e 6470   ls {url} --endp
-0001ace0: 6f69 6e74 207b 656e 6470 6f69 6e74 5f75  oint {endpoint_u
-0001acf0: 726c 7d20 2d2d 7072 6f66 696c 653d 7232  rl} --profile=r2
-0001ad00: 270a 2020 2020 2020 2020 6966 2073 746f  '.        if sto
-0001ad10: 7265 5f74 7970 6520 3d3d 2073 746f 7261  re_type == stora
-0001ad20: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
-0001ad30: 2e49 424d 3a0a 2020 2020 2020 2020 2020  .IBM:.          
-0001ad40: 2020 6275 636b 6574 5f72 636c 6f6e 655f    bucket_rclone_
-0001ad50: 7072 6f66 696c 6520 3d20 5263 6c6f 6e65  profile = Rclone
-0001ad60: 2e67 656e 6572 6174 655f 7263 6c6f 6e65  .generate_rclone
-0001ad70: 5f62 7563 6b65 745f 7072 6f66 696c 655f  _bucket_profile_
-0001ad80: 6e61 6d65 280a 2020 2020 2020 2020 2020  name(.          
-0001ad90: 2020 2020 2020 6275 636b 6574 5f6e 616d        bucket_nam
-0001ada0: 652c 2052 636c 6f6e 652e 5263 6c6f 6e65  e, Rclone.Rclone
-0001adb0: 436c 6f75 6473 2e49 424d 290a 2020 2020  Clouds.IBM).    
-0001adc0: 2020 2020 2020 2020 7265 7475 726e 2066          return f
-0001add0: 2772 636c 6f6e 6520 6c73 207b 6275 636b  'rclone ls {buck
-0001ade0: 6574 5f72 636c 6f6e 655f 7072 6f66 696c  et_rclone_profil
-0001adf0: 657d 3a7b 6275 636b 6574 5f6e 616d 657d  e}:{bucket_name}
-0001ae00: 2f7b 7375 6666 6978 7d27 0a0a 2020 2020  /{suffix}'..    
-0001ae10: 4073 7461 7469 636d 6574 686f 640a 2020  @staticmethod.  
-0001ae20: 2020 6465 6620 636c 695f 636f 756e 745f    def cli_count_
-0001ae30: 6e61 6d65 5f69 6e5f 6275 636b 6574 2873  name_in_bucket(s
-0001ae40: 746f 7265 5f74 7970 652c 2062 7563 6b65  tore_type, bucke
-0001ae50: 745f 6e61 6d65 2c20 6669 6c65 5f6e 616d  t_name, file_nam
-0001ae60: 652c 2073 7566 6669 783d 2727 293a 0a20  e, suffix=''):. 
-0001ae70: 2020 2020 2020 2069 6620 7374 6f72 655f         if store_
-0001ae80: 7479 7065 203d 3d20 7374 6f72 6167 655f  type == storage_
-0001ae90: 6c69 622e 5374 6f72 6554 7970 652e 5333  lib.StoreType.S3
-0001aea0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-0001aeb0: 2073 7566 6669 783a 0a20 2020 2020 2020   suffix:.       
-0001aec0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0001aed0: 6627 6177 7320 7333 6170 6920 6c69 7374  f'aws s3api list
-0001aee0: 2d6f 626a 6563 7473 202d 2d62 7563 6b65  -objects --bucke
-0001aef0: 7420 227b 6275 636b 6574 5f6e 616d 657d  t "{bucket_name}
-0001af00: 2220 2d2d 7072 6566 6978 207b 7375 6666  " --prefix {suff
-0001af10: 6978 7d20 2d2d 7175 6572 7920 226c 656e  ix} --query "len
-0001af20: 6774 6828 436f 6e74 656e 7473 5b3f 636f  gth(Contents[?co
-0001af30: 6e74 6169 6e73 284b 6579 2c5c 277b 6669  ntains(Key,\'{fi
-0001af40: 6c65 5f6e 616d 657d 5c27 295d 2e4b 6579  le_name}\')].Key
-0001af50: 2922 270a 2020 2020 2020 2020 2020 2020  )"'.            
-0001af60: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0001af70: 2020 2020 2020 7265 7475 726e 2066 2761        return f'a
-0001af80: 7773 2073 3361 7069 206c 6973 742d 6f62  ws s3api list-ob
-0001af90: 6a65 6374 7320 2d2d 6275 636b 6574 2022  jects --bucket "
-0001afa0: 7b62 7563 6b65 745f 6e61 6d65 7d22 202d  {bucket_name}" -
-0001afb0: 2d71 7565 7279 2022 6c65 6e67 7468 2843  -query "length(C
-0001afc0: 6f6e 7465 6e74 735b 3f63 6f6e 7461 696e  ontents[?contain
-0001afd0: 7328 4b65 792c 5c27 7b66 696c 655f 6e61  s(Key,\'{file_na
-0001afe0: 6d65 7d5c 2729 5d2e 4b65 7929 2227 0a20  me}\')].Key)"'. 
-0001aff0: 2020 2020 2020 2065 6c69 6620 7374 6f72         elif stor
-0001b000: 655f 7479 7065 203d 3d20 7374 6f72 6167  e_type == storag
-0001b010: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
-0001b020: 4743 533a 0a20 2020 2020 2020 2020 2020  GCS:.           
-0001b030: 2069 6620 7375 6666 6978 3a0a 2020 2020   if suffix:.    
-0001b040: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0001b050: 726e 2066 2767 7375 7469 6c20 6c73 202d  rn f'gsutil ls -
-0001b060: 7220 6773 3a2f 2f7b 6275 636b 6574 5f6e  r gs://{bucket_n
-0001b070: 616d 657d 2f7b 7375 6666 6978 7d20 7c20  ame}/{suffix} | 
-0001b080: 6772 6570 2022 7b66 696c 655f 6e61 6d65  grep "{file_name
-0001b090: 7d22 207c 2077 6320 2d6c 270a 2020 2020  }" | wc -l'.    
-0001b0a0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0001b0b0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0001b0c0: 7475 726e 2066 2767 7375 7469 6c20 6c73  turn f'gsutil ls
-0001b0d0: 202d 7220 6773 3a2f 2f7b 6275 636b 6574   -r gs://{bucket
-0001b0e0: 5f6e 616d 657d 207c 2067 7265 7020 227b  _name} | grep "{
-0001b0f0: 6669 6c65 5f6e 616d 657d 2220 7c20 7763  file_name}" | wc
-0001b100: 202d 6c27 0a20 2020 2020 2020 2065 6c69   -l'.        eli
-0001b110: 6620 7374 6f72 655f 7479 7065 203d 3d20  f store_type == 
-0001b120: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
-0001b130: 6554 7970 652e 5232 3a0a 2020 2020 2020  eType.R2:.      
-0001b140: 2020 2020 2020 656e 6470 6f69 6e74 5f75        endpoint_u
-0001b150: 726c 203d 2063 6c6f 7564 666c 6172 652e  rl = cloudflare.
-0001b160: 6372 6561 7465 5f65 6e64 706f 696e 7428  create_endpoint(
-0001b170: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-0001b180: 2073 7566 6669 783a 0a20 2020 2020 2020   suffix:.       
-0001b190: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0001b1a0: 6627 4157 535f 5348 4152 4544 5f43 5245  f'AWS_SHARED_CRE
-0001b1b0: 4445 4e54 4941 4c53 5f46 494c 453d 7b63  DENTIALS_FILE={c
-0001b1c0: 6c6f 7564 666c 6172 652e 5232 5f43 5245  loudflare.R2_CRE
-0001b1d0: 4445 4e54 4941 4c53 5f50 4154 487d 2061  DENTIALS_PATH} a
-0001b1e0: 7773 2073 3361 7069 206c 6973 742d 6f62  ws s3api list-ob
-0001b1f0: 6a65 6374 7320 2d2d 6275 636b 6574 2022  jects --bucket "
-0001b200: 7b62 7563 6b65 745f 6e61 6d65 7d22 202d  {bucket_name}" -
-0001b210: 2d70 7265 6669 7820 7b73 7566 6669 787d  -prefix {suffix}
-0001b220: 202d 2d71 7565 7279 2022 6c65 6e67 7468   --query "length
-0001b230: 2843 6f6e 7465 6e74 735b 3f63 6f6e 7461  (Contents[?conta
-0001b240: 696e 7328 4b65 792c 5c27 7b66 696c 655f  ins(Key,\'{file_
-0001b250: 6e61 6d65 7d5c 2729 5d2e 4b65 7929 2220  name}\')].Key)" 
-0001b260: 2d2d 656e 6470 6f69 6e74 207b 656e 6470  --endpoint {endp
-0001b270: 6f69 6e74 5f75 726c 7d20 2d2d 7072 6f66  oint_url} --prof
-0001b280: 696c 653d 7232 270a 2020 2020 2020 2020  ile=r2'.        
-0001b290: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0001b2a0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0001b2b0: 2066 2741 5753 5f53 4841 5245 445f 4352   f'AWS_SHARED_CR
-0001b2c0: 4544 454e 5449 414c 535f 4649 4c45 3d7b  EDENTIALS_FILE={
-0001b2d0: 636c 6f75 6466 6c61 7265 2e52 325f 4352  cloudflare.R2_CR
-0001b2e0: 4544 454e 5449 414c 535f 5041 5448 7d20  EDENTIALS_PATH} 
-0001b2f0: 6177 7320 7333 6170 6920 6c69 7374 2d6f  aws s3api list-o
-0001b300: 626a 6563 7473 202d 2d62 7563 6b65 7420  bjects --bucket 
-0001b310: 227b 6275 636b 6574 5f6e 616d 657d 2220  "{bucket_name}" 
-0001b320: 2d2d 7175 6572 7920 226c 656e 6774 6828  --query "length(
-0001b330: 436f 6e74 656e 7473 5b3f 636f 6e74 6169  Contents[?contai
-0001b340: 6e73 284b 6579 2c5c 277b 6669 6c65 5f6e  ns(Key,\'{file_n
-0001b350: 616d 657d 5c27 295d 2e4b 6579 2922 202d  ame}\')].Key)" -
-0001b360: 2d65 6e64 706f 696e 7420 7b65 6e64 706f  -endpoint {endpo
-0001b370: 696e 745f 7572 6c7d 202d 2d70 726f 6669  int_url} --profi
-0001b380: 6c65 3d72 3227 0a0a 2020 2020 4073 7461  le=r2'..    @sta
-0001b390: 7469 636d 6574 686f 640a 2020 2020 6465  ticmethod.    de
-0001b3a0: 6620 636c 695f 636f 756e 745f 6669 6c65  f cli_count_file
-0001b3b0: 5f69 6e5f 6275 636b 6574 2873 746f 7265  _in_bucket(store
-0001b3c0: 5f74 7970 652c 2062 7563 6b65 745f 6e61  _type, bucket_na
-0001b3d0: 6d65 293a 0a20 2020 2020 2020 2069 6620  me):.        if 
-0001b3e0: 7374 6f72 655f 7479 7065 203d 3d20 7374  store_type == st
-0001b3f0: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
-0001b400: 7970 652e 5333 3a0a 2020 2020 2020 2020  ype.S3:.        
-0001b410: 2020 2020 7265 7475 726e 2066 2761 7773      return f'aws
-0001b420: 2073 3320 6c73 2073 333a 2f2f 7b62 7563   s3 ls s3://{buc
-0001b430: 6b65 745f 6e61 6d65 7d20 2d2d 7265 6375  ket_name} --recu
-0001b440: 7273 6976 6520 7c20 7763 202d 6c27 0a20  rsive | wc -l'. 
-0001b450: 2020 2020 2020 2065 6c69 6620 7374 6f72         elif stor
-0001b460: 655f 7479 7065 203d 3d20 7374 6f72 6167  e_type == storag
-0001b470: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
-0001b480: 4743 533a 0a20 2020 2020 2020 2020 2020  GCS:.           
-0001b490: 2072 6574 7572 6e20 6627 6773 7574 696c   return f'gsutil
-0001b4a0: 206c 7320 2d72 2067 733a 2f2f 7b62 7563   ls -r gs://{buc
-0001b4b0: 6b65 745f 6e61 6d65 7d2f 2a2a 207c 2077  ket_name}/** | w
-0001b4c0: 6320 2d6c 270a 2020 2020 2020 2020 656c  c -l'.        el
-0001b4d0: 6966 2073 746f 7265 5f74 7970 6520 3d3d  if store_type ==
-0001b4e0: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
-0001b4f0: 7265 5479 7065 2e52 323a 0a20 2020 2020  reType.R2:.     
-0001b500: 2020 2020 2020 2065 6e64 706f 696e 745f         endpoint_
-0001b510: 7572 6c20 3d20 636c 6f75 6466 6c61 7265  url = cloudflare
-0001b520: 2e63 7265 6174 655f 656e 6470 6f69 6e74  .create_endpoint
-0001b530: 2829 0a20 2020 2020 2020 2020 2020 2072  ().            r
-0001b540: 6574 7572 6e20 6627 4157 535f 5348 4152  eturn f'AWS_SHAR
-0001b550: 4544 5f43 5245 4445 4e54 4941 4c53 5f46  ED_CREDENTIALS_F
-0001b560: 494c 453d 7b63 6c6f 7564 666c 6172 652e  ILE={cloudflare.
-0001b570: 5232 5f43 5245 4445 4e54 4941 4c53 5f50  R2_CREDENTIALS_P
-0001b580: 4154 487d 2061 7773 2073 3320 6c73 2073  ATH} aws s3 ls s
-0001b590: 333a 2f2f 7b62 7563 6b65 745f 6e61 6d65  3://{bucket_name
-0001b5a0: 7d20 2d2d 7265 6375 7273 6976 6520 2d2d  } --recursive --
-0001b5b0: 656e 6470 6f69 6e74 207b 656e 6470 6f69  endpoint {endpoi
-0001b5c0: 6e74 5f75 726c 7d20 2d2d 7072 6f66 696c  nt_url} --profil
-0001b5d0: 653d 7232 207c 2077 6320 2d6c 270a 0a20  e=r2 | wc -l'.. 
-0001b5e0: 2020 2040 7079 7465 7374 2e66 6978 7475     @pytest.fixtu
-0001b5f0: 7265 0a20 2020 2064 6566 2074 6d70 5f73  re.    def tmp_s
-0001b600: 6f75 7263 6528 7365 6c66 2c20 746d 705f  ource(self, tmp_
-0001b610: 7061 7468 293a 0a20 2020 2020 2020 2023  path):.        #
-0001b620: 2043 7265 6174 6573 2061 2074 656d 706f   Creates a tempo
-0001b630: 7261 7279 2064 6972 6563 746f 7279 2077  rary directory w
-0001b640: 6974 6820 6120 6669 6c65 2069 6e20 6974  ith a file in it
-0001b650: 0a20 2020 2020 2020 2074 6d70 5f64 6972  .        tmp_dir
-0001b660: 203d 2074 6d70 5f70 6174 6820 2f20 2774   = tmp_path / 't
-0001b670: 6d70 2d73 6f75 7263 6527 0a20 2020 2020  mp-source'.     
-0001b680: 2020 2074 6d70 5f64 6972 2e6d 6b64 6972     tmp_dir.mkdir
-0001b690: 2829 0a20 2020 2020 2020 2074 6d70 5f66  ().        tmp_f
-0001b6a0: 696c 6520 3d20 746d 705f 6469 7220 2f20  ile = tmp_dir / 
-0001b6b0: 2774 6d70 2d66 696c 6527 0a20 2020 2020  'tmp-file'.     
-0001b6c0: 2020 2074 6d70 5f66 696c 652e 7772 6974     tmp_file.writ
-0001b6d0: 655f 7465 7874 2827 7465 7374 2729 0a20  e_text('test'). 
-0001b6e0: 2020 2020 2020 2063 6972 636c 655f 6c69         circle_li
-0001b6f0: 6e6b 203d 2074 6d70 5f64 6972 202f 2027  nk = tmp_dir / '
-0001b700: 6369 7263 6c65 2d6c 696e 6b27 0a20 2020  circle-link'.   
-0001b710: 2020 2020 2063 6972 636c 655f 6c69 6e6b       circle_link
-0001b720: 2e73 796d 6c69 6e6b 5f74 6f28 746d 705f  .symlink_to(tmp_
-0001b730: 6469 722c 2074 6172 6765 745f 6973 5f64  dir, target_is_d
-0001b740: 6972 6563 746f 7279 3d54 7275 6529 0a20  irectory=True). 
-0001b750: 2020 2020 2020 2079 6965 6c64 2073 7472         yield str
-0001b760: 2874 6d70 5f64 6972 290a 0a20 2020 2040  (tmp_dir)..    @
-0001b770: 7079 7465 7374 2e66 6978 7475 7265 0a20  pytest.fixture. 
-0001b780: 2020 2064 6566 2074 6d70 5f62 7563 6b65     def tmp_bucke
-0001b790: 745f 6e61 6d65 2873 656c 6629 3a0a 2020  t_name(self):.  
-0001b7a0: 2020 2020 2020 2320 4372 6561 7465 7320        # Creates 
-0001b7b0: 6120 7465 6d70 6f72 6172 7920 6275 636b  a temporary buck
-0001b7c0: 6574 206e 616d 650a 2020 2020 2020 2020  et name.        
-0001b7d0: 2320 7469 6d65 2e74 696d 6528 2920 7265  # time.time() re
-0001b7e0: 7475 726e 7320 7661 7279 696e 6720 7072  turns varying pr
-0001b7f0: 6563 6973 696f 6e20 6f6e 2064 6966 6665  ecision on diffe
-0001b800: 7265 6e74 2073 7973 7465 6d73 2c20 736f  rent systems, so
-0001b810: 2077 650a 2020 2020 2020 2020 2320 7265   we.        # re
-0001b820: 706c 6163 6520 7468 6520 6465 6369 6d61  place the decima
-0001b830: 6c20 706f 696e 7420 616e 6420 7573 6520  l point and use 
-0001b840: 7768 6174 6576 6572 2070 7265 6369 7369  whatever precisi
-0001b850: 6f6e 2077 6520 6361 6e20 6765 742e 0a20  on we can get.. 
-0001b860: 2020 2020 2020 2074 696d 6573 7461 6d70         timestamp
-0001b870: 203d 2073 7472 2874 696d 652e 7469 6d65   = str(time.time
-0001b880: 2829 292e 7265 706c 6163 6528 272e 272c  ()).replace('.',
-0001b890: 2027 2729 0a20 2020 2020 2020 2079 6965   '').        yie
-0001b8a0: 6c64 2066 2773 6b79 2d74 6573 742d 7b74  ld f'sky-test-{t
-0001b8b0: 696d 6573 7461 6d70 7d27 0a0a 2020 2020  imestamp}'..    
-0001b8c0: 4073 7461 7469 636d 6574 686f 640a 2020  @staticmethod.  
-0001b8d0: 2020 6465 6620 7969 656c 645f 7374 6f72    def yield_stor
-0001b8e0: 6167 655f 6f62 6a65 6374 280a 2020 2020  age_object(.    
-0001b8f0: 2020 2020 2020 2020 6e61 6d65 3a20 4f70          name: Op
-0001b900: 7469 6f6e 616c 5b73 7472 5d20 3d20 4e6f  tional[str] = No
-0001b910: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
-0001b920: 736f 7572 6365 3a20 4f70 7469 6f6e 616c  source: Optional
-0001b930: 5b73 746f 7261 6765 5f6c 6962 2e50 6174  [storage_lib.Pat
-0001b940: 685d 203d 204e 6f6e 652c 0a20 2020 2020  h] = None,.     
-0001b950: 2020 2020 2020 2073 746f 7265 733a 204f         stores: O
-0001b960: 7074 696f 6e61 6c5b 4469 6374 5b73 746f  ptional[Dict[sto
+00017620: 2320 5468 6520 636c 7573 7465 7220 7368  # The cluster sh
+00017630: 6f75 6c64 2062 6520 7465 726d 696e 6174  ould be terminat
+00017640: 6564 2028 5354 4f50 5049 4e47 2920 6166  ed (STOPPING) af
+00017650: 7465 7220 6361 6e63 656c 6c61 7469 6f6e  ter cancellation
+00017660: 2e20 5765 2064 6f6e 2774 2075 7365 2074  . We don't use t
+00017670: 6865 2060 3d60 206f 7065 7261 746f 7220  he `=` operator 
+00017680: 6865 7265 2062 6563 6175 7365 0a20 2020  here because.   
+00017690: 2020 2020 2020 2020 2023 2074 6865 7265           # there
+000176a0: 2063 616e 2062 6520 6d75 6c74 6970 6c65   can be multiple
+000176b0: 2056 4d20 7769 7468 2074 6865 2073 616d   VM with the sam
+000176c0: 6520 6e61 6d65 2064 7565 2074 6f20 7468  e name due to th
+000176d0: 6520 7265 636f 7665 7279 2e0a 2020 2020  e recovery..    
+000176e0: 2020 2020 2020 2020 2866 2773 3d24 287b          (f's=$({
+000176f0: 7175 6572 795f 7374 6174 655f 636d 647d  query_state_cmd}
+00017700: 2920 2626 2065 6368 6f20 2224 7322 2026  ) && echo "$s" &
+00017710: 2620 6563 686f 3b20 5b5b 202d 7a20 2224  & echo; [[ -z "$
+00017720: 7322 205d 5d20 7c7c 2065 6368 6f20 2224  s" ]] || echo "$
+00017730: 7322 207c 2067 7265 7020 2d76 202d 4520  s" | grep -v -E 
+00017740: 2250 524f 5649 5349 4f4e 494e 477c 5354  "PROVISIONING|ST
+00017750: 4147 494e 477c 5255 4e4e 494e 477c 5245  AGING|RUNNING|RE
+00017760: 5041 4952 494e 477c 5445 524d 494e 4154  PAIRING|TERMINAT
+00017770: 4544 7c53 5553 5045 4e44 494e 477c 5355  ED|SUSPENDING|SU
+00017780: 5350 454e 4445 447c 5355 5350 454e 4445  SPENDED|SUSPENDE
+00017790: 4422 270a 2020 2020 2020 2020 2020 2020  D"'.            
+000177a0: 292c 0a20 2020 2020 2020 205d 2c0a 2020  ),.        ],.  
+000177b0: 2020 2020 2020 7469 6d65 6f75 743d 3235        timeout=25
+000177c0: 202a 2036 3029 0a20 2020 2072 756e 5f6f   * 60).    run_o
+000177d0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+000177e0: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573  # ---------- Tes
+000177f0: 7469 6e67 2073 746f 7261 6765 2066 6f72  ting storage for
+00017800: 206d 616e 6167 6564 2073 706f 7420 2d2d   managed spot --
+00017810: 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465 7374  --------.@pytest
+00017820: 2e6d 6172 6b2e 6e6f 5f6c 616d 6264 615f  .mark.no_lambda_
+00017830: 636c 6f75 6420 2023 204c 616d 6264 6120  cloud  # Lambda 
+00017840: 436c 6f75 6420 646f 6573 206e 6f74 2073  Cloud does not s
+00017850: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
+00017860: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
+00017870: 726b 2e6e 6f5f 6962 6d20 2023 2049 424d  rk.no_ibm  # IBM
+00017880: 2043 6c6f 7564 2064 6f65 7320 6e6f 7420   Cloud does not 
+00017890: 7375 7070 6f72 7420 7370 6f74 2069 6e73  support spot ins
+000178a0: 7461 6e63 6573 0a40 7079 7465 7374 2e6d  tances.@pytest.m
+000178b0: 6172 6b2e 6e6f 5f73 6370 2020 2320 5343  ark.no_scp  # SC
+000178c0: 5020 646f 6573 206e 6f74 2073 7570 706f  P does not suppo
+000178d0: 7274 2073 706f 7420 696e 7374 616e 6365  rt spot instance
+000178e0: 730a 4070 7974 6573 742e 6d61 726b 2e6e  s.@pytest.mark.n
+000178f0: 6f5f 6b75 6265 726e 6574 6573 2020 2320  o_kubernetes  # 
+00017900: 4b75 6265 726e 6574 6573 2064 6f65 7320  Kubernetes does 
+00017910: 6e6f 7420 6861 7665 2061 206e 6f74 696f  not have a notio
+00017920: 6e20 6f66 2073 706f 7420 696e 7374 616e  n of spot instan
+00017930: 6365 730a 4070 7974 6573 742e 6d61 726b  ces.@pytest.mark
+00017940: 2e6d 616e 6167 6564 5f73 706f 740a 6465  .managed_spot.de
+00017950: 6620 7465 7374 5f73 706f 745f 7374 6f72  f test_spot_stor
+00017960: 6167 6528 6765 6e65 7269 635f 636c 6f75  age(generic_clou
+00017970: 643a 2073 7472 293a 0a20 2020 2022 2222  d: str):.    """
+00017980: 5465 7374 2073 746f 7261 6765 2077 6974  Test storage wit
+00017990: 6820 6d61 6e61 6765 6420 7370 6f74 2222  h managed spot""
+000179a0: 220a 2020 2020 6e61 6d65 203d 205f 6765  ".    name = _ge
+000179b0: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+000179c0: 0a20 2020 2079 616d 6c5f 7374 7220 3d20  .    yaml_str = 
+000179d0: 7061 7468 6c69 622e 5061 7468 280a 2020  pathlib.Path(.  
+000179e0: 2020 2020 2020 2765 7861 6d70 6c65 732f        'examples/
+000179f0: 6d61 6e61 6765 645f 7370 6f74 5f77 6974  managed_spot_wit
+00017a00: 685f 7374 6f72 6167 652e 7961 6d6c 2729  h_storage.yaml')
+00017a10: 2e72 6561 645f 7465 7874 2829 0a20 2020  .read_text().   
+00017a20: 2073 746f 7261 6765 5f6e 616d 6520 3d20   storage_name = 
+00017a30: 6627 736b 792d 7465 7374 2d7b 696e 7428  f'sky-test-{int(
+00017a40: 7469 6d65 2e74 696d 6528 2929 7d27 0a20  time.time())}'. 
+00017a50: 2020 2079 616d 6c5f 7374 7220 3d20 7961     yaml_str = ya
+00017a60: 6d6c 5f73 7472 2e72 6570 6c61 6365 2827  ml_str.replace('
+00017a70: 736b 792d 776f 726b 6469 722d 7a68 7775  sky-workdir-zhwu
+00017a80: 272c 2073 746f 7261 6765 5f6e 616d 6529  ', storage_name)
+00017a90: 0a20 2020 2077 6974 6820 7465 6d70 6669  .    with tempfi
+00017aa0: 6c65 2e4e 616d 6564 5465 6d70 6f72 6172  le.NamedTemporar
+00017ab0: 7946 696c 6528 7375 6666 6978 3d27 2e79  yFile(suffix='.y
+00017ac0: 616d 6c27 2c20 6d6f 6465 3d27 7727 2920  aml', mode='w') 
+00017ad0: 6173 2066 3a0a 2020 2020 2020 2020 662e  as f:.        f.
+00017ae0: 7772 6974 6528 7961 6d6c 5f73 7472 290a  write(yaml_str).
+00017af0: 2020 2020 2020 2020 662e 666c 7573 6828          f.flush(
+00017b00: 290a 2020 2020 2020 2020 6669 6c65 5f70  ).        file_p
+00017b10: 6174 6820 3d20 662e 6e61 6d65 0a20 2020  ath = f.name.   
+00017b20: 2020 2020 2074 6573 7420 3d20 5465 7374       test = Test
+00017b30: 280a 2020 2020 2020 2020 2020 2020 2773  (.            's
+00017b40: 706f 745f 7374 6f72 6167 6527 2c0a 2020  pot_storage',.  
+00017b50: 2020 2020 2020 2020 2020 5b0a 2020 2020            [.    
+00017b60: 2020 2020 2020 2020 2020 2020 2a73 746f              *sto
+00017b70: 7261 6765 5f73 6574 7570 5f63 6f6d 6d61  rage_setup_comma
+00017b80: 6e64 732c 0a20 2020 2020 2020 2020 2020  nds,.           
+00017b90: 2020 2020 2066 2773 6b79 2073 706f 7420       f'sky spot 
+00017ba0: 6c61 756e 6368 202d 6e20 7b6e 616d 657d  launch -n {name}
+00017bb0: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
+00017bc0: 635f 636c 6f75 647d 207b 6669 6c65 5f70  c_cloud} {file_p
+00017bd0: 6174 687d 202d 7927 2c0a 2020 2020 2020  ath} -y',.      
+00017be0: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+00017bf0: 2036 3027 2c20 2023 2057 6169 7420 7468   60',  # Wait th
+00017c00: 6520 7370 6f74 2071 7565 7565 2074 6f20  e spot queue to 
+00017c10: 6265 2075 7064 6174 6564 0a20 2020 2020  be updated.     
+00017c20: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
+00017c30: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
+00017c40: 2067 7265 7020 7b6e 616d 657d 207c 2067   grep {name} | g
+00017c50: 7265 7020 5355 4343 4545 4445 4427 2c0a  rep SUCCEEDED',.
+00017c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017c70: 6627 5b20 2428 6177 7320 7333 6170 6920  f'[ $(aws s3api 
+00017c80: 6c69 7374 2d62 7563 6b65 7473 202d 2d71  list-buckets --q
+00017c90: 7565 7279 2022 4275 636b 6574 735b 3f63  uery "Buckets[?c
+00017ca0: 6f6e 7461 696e 7328 4e61 6d65 2c20 5c27  ontains(Name, \'
+00017cb0: 7b73 746f 7261 6765 5f6e 616d 657d 5c27  {storage_name}\'
+00017cc0: 295d 2e4e 616d 6522 202d 2d6f 7574 7075  )].Name" --outpu
+00017cd0: 7420 7465 7874 207c 2077 6320 2d6c 2920  t text | wc -l) 
+00017ce0: 2d65 7120 3020 5d27 0a20 2020 2020 2020  -eq 0 ]'.       
+00017cf0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+00017d00: 2020 2020 5f53 504f 545f 4341 4e43 454c      _SPOT_CANCEL
+00017d10: 5f57 4149 542e 666f 726d 6174 286a 6f62  _WAIT.format(job
+00017d20: 5f6e 616d 653d 6e61 6d65 292c 0a20 2020  _name=name),.   
+00017d30: 2020 2020 2020 2020 2023 2049 6e63 7265           # Incre
+00017d40: 6173 6520 7469 6d65 6f75 7420 7369 6e63  ase timeout sinc
+00017d50: 6520 736b 7920 7370 6f74 2071 7565 7565  e sky spot queue
+00017d60: 202d 7220 6361 6e20 6265 2062 6c6f 636b   -r can be block
+00017d70: 6564 2062 7920 6f74 6865 7220 7370 6f74  ed by other spot
+00017d80: 2074 6573 7473 2e0a 2020 2020 2020 2020   tests..        
+00017d90: 2020 2020 7469 6d65 6f75 743d 3230 202a      timeout=20 *
+00017da0: 2036 302c 0a20 2020 2020 2020 2029 0a20   60,.        ). 
+00017db0: 2020 2020 2020 2072 756e 5f6f 6e65 5f74         run_one_t
+00017dc0: 6573 7428 7465 7374 290a 0a0a 2320 2d2d  est(test)...# --
+00017dd0: 2d2d 2d2d 2d2d 2d2d 2054 6573 7469 6e67  -------- Testing
+00017de0: 2073 706f 7420 5450 5520 2d2d 2d2d 2d2d   spot TPU ------
+00017df0: 2d2d 2d2d 0a40 7079 7465 7374 2e6d 6172  ----.@pytest.mar
+00017e00: 6b2e 6763 700a 4070 7974 6573 742e 6d61  k.gcp.@pytest.ma
+00017e10: 726b 2e6d 616e 6167 6564 5f73 706f 740a  rk.managed_spot.
+00017e20: 6465 6620 7465 7374 5f73 706f 745f 7470  def test_spot_tp
+00017e30: 7528 293a 0a20 2020 2022 2222 5465 7374  u():.    """Test
+00017e40: 206d 616e 6167 6564 2073 706f 7420 6f6e   managed spot on
+00017e50: 2054 5055 2e22 2222 0a20 2020 206e 616d   TPU.""".    nam
+00017e60: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+00017e70: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
+00017e80: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
+00017e90: 2027 7465 7374 2d73 706f 742d 7470 7527   'test-spot-tpu'
+00017ea0: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+00017eb0: 2020 2020 2020 2020 6627 736b 7920 7370          f'sky sp
+00017ec0: 6f74 206c 6175 6e63 6820 2d6e 207b 6e61  ot launch -n {na
+00017ed0: 6d65 7d20 6578 616d 706c 6573 2f74 7075  me} examples/tpu
+00017ee0: 2f74 7075 766d 5f6d 6e69 7374 2e79 616d  /tpuvm_mnist.yam
+00017ef0: 6c20 2d79 202d 6427 2c0a 2020 2020 2020  l -y -d',.      
+00017f00: 2020 2020 2020 2773 6c65 6570 2035 272c        'sleep 5',
+00017f10: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+00017f20: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
+00017f30: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
+00017f40: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
+00017f50: 2053 5441 5254 494e 4727 2c0a 2020 2020   STARTING',.    
+00017f60: 2020 2020 2020 2020 2773 6c65 6570 2038          'sleep 8
+00017f70: 3430 272c 2020 2320 5450 5520 7461 6b65  40',  # TPU take
+00017f80: 7320 6120 7768 696c 6520 746f 206c 6175  s a while to lau
+00017f90: 6e63 680a 2020 2020 2020 2020 2020 2020  nch.            
+00017fa0: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
+00017fb0: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
+00017fc0: 7d20 7c20 6865 6164 202d 6e31 207c 2067  } | head -n1 | g
+00017fd0: 7265 7020 2252 554e 4e49 4e47 5c7c 5355  rep "RUNNING\|SU
+00017fe0: 4343 4545 4445 4422 272c 0a20 2020 2020  CCEEDED"',.     
+00017ff0: 2020 205d 2c0a 2020 2020 2020 2020 5f53     ],.        _S
+00018000: 504f 545f 4341 4e43 454c 5f57 4149 542e  POT_CANCEL_WAIT.
+00018010: 666f 726d 6174 286a 6f62 5f6e 616d 653d  format(job_name=
+00018020: 6e61 6d65 292c 0a20 2020 2020 2020 2023  name),.        #
+00018030: 2049 6e63 7265 6173 6520 7469 6d65 6f75   Increase timeou
+00018040: 7420 7369 6e63 6520 736b 7920 7370 6f74  t since sky spot
+00018050: 2071 7565 7565 202d 7220 6361 6e20 6265   queue -r can be
+00018060: 2062 6c6f 636b 6564 2062 7920 6f74 6865   blocked by othe
+00018070: 7220 7370 6f74 2074 6573 7473 2e0a 2020  r spot tests..  
+00018080: 2020 2020 2020 7469 6d65 6f75 743d 3230        timeout=20
+00018090: 202a 2036 302c 0a20 2020 2029 0a20 2020   * 60,.    ).   
+000180a0: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+000180b0: 7374 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d  st)...# --------
+000180c0: 2d2d 2054 6573 7469 6e67 2065 6e76 2066  -- Testing env f
+000180d0: 6f72 2073 706f 7420 2d2d 2d2d 2d2d 2d2d  or spot --------
+000180e0: 2d2d 0a40 7079 7465 7374 2e6d 6172 6b2e  --.@pytest.mark.
+000180f0: 6e6f 5f6c 616d 6264 615f 636c 6f75 6420  no_lambda_cloud 
+00018100: 2023 204c 616d 6264 6120 436c 6f75 6420   # Lambda Cloud 
+00018110: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
+00018120: 2073 706f 7420 696e 7374 616e 6365 730a   spot instances.
+00018130: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+00018140: 6962 6d20 2023 2049 424d 2043 6c6f 7564  ibm  # IBM Cloud
+00018150: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
+00018160: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
+00018170: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+00018180: 5f73 6370 2020 2320 5343 5020 646f 6573  _scp  # SCP does
+00018190: 206e 6f74 2073 7570 706f 7274 2073 706f   not support spo
+000181a0: 7420 696e 7374 616e 6365 730a 4070 7974  t instances.@pyt
+000181b0: 6573 742e 6d61 726b 2e6e 6f5f 6b75 6265  est.mark.no_kube
+000181c0: 726e 6574 6573 2020 2320 4b75 6265 726e  rnetes  # Kubern
+000181d0: 6574 6573 2064 6f65 7320 6e6f 7420 6861  etes does not ha
+000181e0: 7665 2061 206e 6f74 696f 6e20 6f66 2073  ve a notion of s
+000181f0: 706f 7420 696e 7374 616e 6365 730a 4070  pot instances.@p
+00018200: 7974 6573 742e 6d61 726b 2e6d 616e 6167  ytest.mark.manag
+00018210: 6564 5f73 706f 740a 6465 6620 7465 7374  ed_spot.def test
+00018220: 5f73 706f 745f 696e 6c69 6e65 5f65 6e76  _spot_inline_env
+00018230: 2867 656e 6572 6963 5f63 6c6f 7564 3a20  (generic_cloud: 
+00018240: 7374 7229 3a0a 2020 2020 2222 2254 6573  str):.    """Tes
+00018250: 7420 7370 6f74 2065 6e76 2222 220a 2020  t spot env""".  
+00018260: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+00018270: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+00018280: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+00018290: 2020 2020 2020 2774 6573 742d 7370 6f74        'test-spot
+000182a0: 2d69 6e6c 696e 652d 656e 7627 2c0a 2020  -inline-env',.  
+000182b0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+000182c0: 2020 2020 6627 736b 7920 7370 6f74 206c      f'sky spot l
+000182d0: 6175 6e63 6820 2d6e 207b 6e61 6d65 7d20  aunch -n {name} 
+000182e0: 2d79 202d 2d63 6c6f 7564 207b 6765 6e65  -y --cloud {gene
+000182f0: 7269 635f 636c 6f75 647d 202d 2d65 6e76  ric_cloud} --env
+00018300: 2054 4553 545f 454e 563d 2268 656c 6c6f   TEST_ENV="hello
+00018310: 2077 6f72 6c64 2220 2d2d 2022 285b 5b20   world" -- "([[ 
+00018320: 2120 2d7a 205c 5c22 5c24 5445 5354 5f45  ! -z \\"\$TEST_E
+00018330: 4e56 5c5c 2220 5d5d 2026 2620 5b5b 2021  NV\\" ]] && [[ !
+00018340: 202d 7a20 5c5c 225c 2453 4b59 5049 4c4f   -z \\"\$SKYPILO
+00018350: 545f 4e4f 4445 5f49 5053 5c5c 2220 5d5d  T_NODE_IPS\\" ]]
+00018360: 2026 2620 5b5b 2021 202d 7a20 5c5c 225c   && [[ ! -z \\"\
+00018370: 2453 4b59 5049 4c4f 545f 4e4f 4445 5f52  $SKYPILOT_NODE_R
+00018380: 414e 4b5c 5c22 205d 5d29 207c 7c20 6578  ANK\\" ]]) || ex
+00018390: 6974 2031 2227 2c0a 2020 2020 2020 2020  it 1"',.        
+000183a0: 2020 2020 2773 6c65 6570 2032 3027 2c0a      'sleep 20',.
+000183b0: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+000183c0: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
+000183d0: 207c 2067 7265 7020 7b6e 616d 657d 207c   | grep {name} |
+000183e0: 2067 7265 7020 5355 4343 4545 4445 4427   grep SUCCEEDED'
+000183f0: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
+00018400: 2020 2020 205f 5350 4f54 5f43 414e 4345       _SPOT_CANCE
+00018410: 4c5f 5741 4954 2e66 6f72 6d61 7428 6a6f  L_WAIT.format(jo
+00018420: 625f 6e61 6d65 3d6e 616d 6529 2c0a 2020  b_name=name),.  
+00018430: 2020 2020 2020 2320 496e 6372 6561 7365        # Increase
+00018440: 2074 696d 656f 7574 2073 696e 6365 2073   timeout since s
+00018450: 6b79 2073 706f 7420 7175 6575 6520 2d72  ky spot queue -r
+00018460: 2063 616e 2062 6520 626c 6f63 6b65 6420   can be blocked 
+00018470: 6279 206f 7468 6572 2073 706f 7420 7465  by other spot te
+00018480: 7374 732e 0a20 2020 2020 2020 2074 696d  sts..        tim
+00018490: 656f 7574 3d32 3020 2a20 3630 2c0a 2020  eout=20 * 60,.  
+000184a0: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
+000184b0: 7465 7374 2874 6573 7429 0a0a 0a23 202d  test(test)...# -
+000184c0: 2d2d 2d2d 2d2d 2d2d 2d20 5465 7374 696e  --------- Testin
+000184d0: 6720 656e 7620 2d2d 2d2d 2d2d 2d2d 2d2d  g env ----------
+000184e0: 0a64 6566 2074 6573 745f 696e 6c69 6e65  .def test_inline
+000184f0: 5f65 6e76 2867 656e 6572 6963 5f63 6c6f  _env(generic_clo
+00018500: 7564 3a20 7374 7229 3a0a 2020 2020 2222  ud: str):.    ""
+00018510: 2254 6573 7420 656e 7622 2222 0a20 2020  "Test env""".   
+00018520: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
+00018530: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
+00018540: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+00018550: 2020 2020 2027 7465 7374 2d69 6e6c 696e       'test-inlin
+00018560: 652d 656e 7627 2c0a 2020 2020 2020 2020  e-env',.        
+00018570: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+00018580: 736b 7920 6c61 756e 6368 202d 6320 7b6e  sky launch -c {n
+00018590: 616d 657d 202d 7920 2d2d 636c 6f75 6420  ame} -y --cloud 
+000185a0: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
+000185b0: 2d2d 656e 7620 5445 5354 5f45 4e56 3d22  --env TEST_ENV="
+000185c0: 6865 6c6c 6f20 776f 726c 6422 202d 2d20  hello world" -- 
+000185d0: 2228 5b5b 2021 202d 7a20 5c5c 225c 2454  "([[ ! -z \\"\$T
+000185e0: 4553 545f 454e 565c 5c22 205d 5d20 2626  EST_ENV\\" ]] &&
+000185f0: 205b 5b20 2120 2d7a 205c 5c22 5c24 534b   [[ ! -z \\"\$SK
+00018600: 5950 494c 4f54 5f4e 4f44 455f 4950 535c  YPILOT_NODE_IPS\
+00018610: 5c22 205d 5d20 2626 205b 5b20 2120 2d7a  \" ]] && [[ ! -z
+00018620: 205c 5c22 5c24 534b 5950 494c 4f54 5f4e   \\"\$SKYPILOT_N
+00018630: 4f44 455f 5241 4e4b 5c5c 2220 5d5d 2920  ODE_RANK\\" ]]) 
+00018640: 7c7c 2065 7869 7420 3122 272c 0a20 2020  || exit 1"',.   
+00018650: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00018660: 6f67 7320 7b6e 616d 657d 2031 202d 2d73  ogs {name} 1 --s
+00018670: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
+00018680: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
+00018690: 6e61 6d65 7d20 2d2d 656e 7620 5445 5354  name} --env TEST
+000186a0: 5f45 4e56 323d 2273 7563 6365 7373 2220  _ENV2="success" 
+000186b0: 2228 5b5b 2021 202d 7a20 5c5c 225c 2454  "([[ ! -z \\"\$T
+000186c0: 4553 545f 454e 5632 5c5c 2220 5d5d 2026  EST_ENV2\\" ]] &
+000186d0: 2620 5b5b 2021 202d 7a20 5c5c 225c 2453  & [[ ! -z \\"\$S
+000186e0: 4b59 5049 4c4f 545f 4e4f 4445 5f49 5053  KYPILOT_NODE_IPS
+000186f0: 5c5c 2220 5d5d 2026 2620 5b5b 2021 202d  \\" ]] && [[ ! -
+00018700: 7a20 5c5c 225c 2453 4b59 5049 4c4f 545f  z \\"\$SKYPILOT_
+00018710: 4e4f 4445 5f52 414e 4b5c 5c22 205d 5d29  NODE_RANK\\" ]])
+00018720: 207c 7c20 6578 6974 2031 2227 2c0a 2020   || exit 1"',.  
+00018730: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00018740: 6c6f 6773 207b 6e61 6d65 7d20 3220 2d2d  logs {name} 2 --
+00018750: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
+00018760: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
+00018770: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
+00018780: 272c 0a20 2020 2029 0a20 2020 2072 756e  ',.    ).    run
+00018790: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+000187a0: 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054  ..# ---------- T
+000187b0: 6573 7469 6e67 2065 6e76 2066 696c 6520  esting env file 
+000187c0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a64 6566 2074  ----------.def t
+000187d0: 6573 745f 696e 6c69 6e65 5f65 6e76 5f66  est_inline_env_f
+000187e0: 696c 6528 6765 6e65 7269 635f 636c 6f75  ile(generic_clou
+000187f0: 643a 2073 7472 293a 0a20 2020 2022 2222  d: str):.    """
+00018800: 5465 7374 2065 6e76 2222 220a 2020 2020  Test env""".    
+00018810: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+00018820: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
+00018830: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+00018840: 2020 2020 2774 6573 742d 696e 6c69 6e65      'test-inline
+00018850: 2d65 6e76 2d66 696c 6527 2c0a 2020 2020  -env-file',.    
+00018860: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+00018870: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
+00018880: 6320 7b6e 616d 657d 202d 7920 2d2d 636c  c {name} -y --cl
+00018890: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
+000188a0: 7564 7d20 2d2d 656e 7620 5445 5354 5f45  ud} --env TEST_E
+000188b0: 4e56 3d22 6865 6c6c 6f20 776f 726c 6422  NV="hello world"
+000188c0: 202d 2d20 2228 5b5b 2021 202d 7a20 5c5c   -- "([[ ! -z \\
+000188d0: 225c 2454 4553 545f 454e 565c 5c22 205d  "\$TEST_ENV\\" ]
+000188e0: 5d20 2626 205b 5b20 2120 2d7a 205c 5c22  ] && [[ ! -z \\"
+000188f0: 5c24 534b 5950 494c 4f54 5f4e 4f44 455f  \$SKYPILOT_NODE_
+00018900: 4950 535c 5c22 205d 5d20 2626 205b 5b20  IPS\\" ]] && [[ 
+00018910: 2120 2d7a 205c 5c22 5c24 534b 5950 494c  ! -z \\"\$SKYPIL
+00018920: 4f54 5f4e 4f44 455f 5241 4e4b 5c5c 2220  OT_NODE_RANK\\" 
+00018930: 5d5d 2920 7c7c 2065 7869 7420 3122 272c  ]]) || exit 1"',
+00018940: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00018950: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
+00018960: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
+00018970: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+00018980: 6563 207b 6e61 6d65 7d20 2d2d 656e 762d  ec {name} --env-
+00018990: 6669 6c65 2065 7861 6d70 6c65 732f 7361  file examples/sa
+000189a0: 6d70 6c65 5f64 6f74 656e 7620 2228 5b5b  mple_dotenv "([[
+000189b0: 2021 202d 7a20 5c5c 225c 2454 4553 545f   ! -z \\"\$TEST_
+000189c0: 454e 5632 5c5c 2220 5d5d 2026 2620 5b5b  ENV2\\" ]] && [[
+000189d0: 2021 202d 7a20 5c5c 225c 2453 4b59 5049   ! -z \\"\$SKYPI
+000189e0: 4c4f 545f 4e4f 4445 5f49 5053 5c5c 2220  LOT_NODE_IPS\\" 
+000189f0: 5d5d 2026 2620 5b5b 2021 202d 7a20 5c5c  ]] && [[ ! -z \\
+00018a00: 225c 2453 4b59 5049 4c4f 545f 4e4f 4445  "\$SKYPILOT_NODE
+00018a10: 5f52 414e 4b5c 5c22 205d 5d29 207c 7c20  _RANK\\" ]]) || 
+00018a20: 6578 6974 2031 2227 2c0a 2020 2020 2020  exit 1"',.      
+00018a30: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+00018a40: 207b 6e61 6d65 7d20 3220 2d2d 7374 6174   {name} 2 --stat
+00018a50: 7573 272c 0a20 2020 2020 2020 205d 2c0a  us',.        ],.
+00018a60: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
+00018a70: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
+00018a80: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+00018a90: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
+00018aa0: 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573 7469  ---------- Testi
+00018ab0: 6e67 2063 7573 746f 6d20 696d 6167 6520  ng custom image 
+00018ac0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465  ----------.@pyte
+00018ad0: 7374 2e6d 6172 6b2e 6177 730a 6465 6620  st.mark.aws.def 
+00018ae0: 7465 7374 5f63 7573 746f 6d5f 696d 6167  test_custom_imag
+00018af0: 6528 293a 0a20 2020 2022 2222 5465 7374  e():.    """Test
+00018b00: 2063 7573 746f 6d20 696d 6167 6522 2222   custom image"""
+00018b10: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+00018b20: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+00018b30: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+00018b40: 0a20 2020 2020 2020 2027 7465 7374 2d63  .        'test-c
+00018b50: 7573 746f 6d2d 696d 6167 6527 2c0a 2020  ustom-image',.  
+00018b60: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+00018b70: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+00018b80: 202d 6320 7b6e 616d 657d 202d 2d72 6574   -c {name} --ret
+00018b90: 7279 2d75 6e74 696c 2d75 7020 2d79 2065  ry-until-up -y e
+00018ba0: 7861 6d70 6c65 732f 6375 7374 6f6d 5f69  xamples/custom_i
+00018bb0: 6d61 6765 2e79 616d 6c27 2c0a 2020 2020  mage.yaml',.    
+00018bc0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+00018bd0: 6773 207b 6e61 6d65 7d20 3120 2d2d 7374  gs {name} 1 --st
+00018be0: 6174 7573 272c 0a20 2020 2020 2020 205d  atus',.        ]
+00018bf0: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+00018c00: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
+00018c10: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
+00018c20: 3d33 3020 2a20 3630 2c0a 2020 2020 290a  =30 * 60,.    ).
+00018c30: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+00018c40: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
+00018c50: 2e6d 6172 6b2e 736c 6f77 0a64 6566 2074  .mark.slow.def t
+00018c60: 6573 745f 617a 7572 655f 7374 6172 745f  est_azure_start_
+00018c70: 7374 6f70 5f74 776f 5f6e 6f64 6573 2829  stop_two_nodes()
+00018c80: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
+00018c90: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+00018ca0: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+00018cb0: 280a 2020 2020 2020 2020 2761 7a75 7265  (.        'azure
+00018cc0: 2d73 7461 7274 2d73 746f 702d 7477 6f2d  -start-stop-two-
+00018cd0: 6e6f 6465 7327 2c0a 2020 2020 2020 2020  nodes',.        
+00018ce0: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+00018cf0: 736b 7920 6c61 756e 6368 202d 2d6e 756d  sky launch --num
+00018d00: 2d6e 6f64 6573 3d32 202d 7920 2d63 207b  -nodes=2 -y -c {
+00018d10: 6e61 6d65 7d20 6578 616d 706c 6573 2f61  name} examples/a
+00018d20: 7a75 7265 5f73 7461 7274 5f73 746f 702e  zure_start_stop.
+00018d30: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+00018d40: 2020 2066 2773 6b79 2065 7865 6320 2d2d     f'sky exec --
+00018d50: 6e75 6d2d 6e6f 6465 733d 3220 7b6e 616d  num-nodes=2 {nam
+00018d60: 657d 2065 7861 6d70 6c65 732f 617a 7572  e} examples/azur
+00018d70: 655f 7374 6172 745f 7374 6f70 2e79 616d  e_start_stop.yam
+00018d80: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+00018d90: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+00018da0: 7d20 3120 2d2d 7374 6174 7573 272c 2020  } 1 --status',  
+00018db0: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
+00018dc0: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
+00018dd0: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
+00018de0: 6f70 202d 7920 7b6e 616d 657d 272c 0a20  op -y {name}',. 
+00018df0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00018e00: 2073 7461 7274 202d 7920 7b6e 616d 657d   start -y {name}
+00018e10: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00018e20: 2773 6b79 2065 7865 6320 2d2d 6e75 6d2d  'sky exec --num-
+00018e30: 6e6f 6465 733d 3220 7b6e 616d 657d 2065  nodes=2 {name} e
+00018e40: 7861 6d70 6c65 732f 617a 7572 655f 7374  xamples/azure_st
+00018e50: 6172 745f 7374 6f70 2e79 616d 6c27 2c0a  art_stop.yaml',.
+00018e60: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00018e70: 7920 6c6f 6773 207b 6e61 6d65 7d20 3220  y logs {name} 2 
+00018e80: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
+00018e90: 7375 7265 2074 6865 206a 6f62 2073 7563  sure the job suc
+00018ea0: 6365 6564 6564 2e0a 2020 2020 2020 2020  ceeded..        
+00018eb0: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
+00018ec0: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
+00018ed0: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
+00018ee0: 743d 3330 202a 2036 302c 2020 2320 3330  t=30 * 60,  # 30
+00018ef0: 206d 696e 7320 2028 6974 2074 616b 6573   mins  (it takes
+00018f00: 2061 726f 756e 6420 7e32 3320 6d69 6e73   around ~23 mins
+00018f10: 290a 2020 2020 290a 2020 2020 7275 6e5f  ).    ).    run_
+00018f20: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+00018f30: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465  .# ---------- Te
+00018f40: 7374 696e 6720 656e 7620 666f 7220 6469  sting env for di
+00018f50: 736b 2074 6965 7220 2d2d 2d2d 2d2d 2d2d  sk tier --------
+00018f60: 2d2d 0a40 7079 7465 7374 2e6d 6172 6b2e  --.@pytest.mark.
+00018f70: 6177 730a 6465 6620 7465 7374 5f61 7773  aws.def test_aws
+00018f80: 5f64 6973 6b5f 7469 6572 2829 3a0a 0a20  _disk_tier():.. 
+00018f90: 2020 2064 6566 205f 6765 745f 6177 735f     def _get_aws_
+00018fa0: 7175 6572 795f 636f 6d6d 616e 6428 7265  query_command(re
+00018fb0: 6769 6f6e 2c20 696e 7374 616e 6365 5f69  gion, instance_i
+00018fc0: 642c 2066 6965 6c64 2c20 6578 7065 6374  d, field, expect
+00018fd0: 6564 293a 0a20 2020 2020 2020 2072 6574  ed):.        ret
+00018fe0: 7572 6e20 2866 2761 7773 2065 6332 2064  urn (f'aws ec2 d
+00018ff0: 6573 6372 6962 652d 766f 6c75 6d65 7320  escribe-volumes 
+00019000: 2d2d 7265 6769 6f6e 207b 7265 6769 6f6e  --region {region
+00019010: 7d20 270a 2020 2020 2020 2020 2020 2020  } '.            
+00019020: 2020 2020 6627 2d2d 6669 6c74 6572 7320      f'--filters 
+00019030: 4e61 6d65 3d61 7474 6163 686d 656e 742e  Name=attachment.
+00019040: 696e 7374 616e 6365 2d69 642c 5661 6c75  instance-id,Valu
+00019050: 6573 3d7b 696e 7374 616e 6365 5f69 647d  es={instance_id}
+00019060: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+00019070: 2020 2066 272d 2d71 7565 7279 2056 6f6c     f'--query Vol
+00019080: 756d 6573 5b2a 5d2e 7b66 6965 6c64 7d20  umes[*].{field} 
+00019090: 7c20 6772 6570 207b 6578 7065 6374 6564  | grep {expected
+000190a0: 7d20 3b20 2729 0a0a 2020 2020 666f 7220  } ; ')..    for 
+000190b0: 6469 736b 5f74 6965 7220 696e 205b 276c  disk_tier in ['l
+000190c0: 6f77 272c 2027 6d65 6469 756d 272c 2027  ow', 'medium', '
+000190d0: 6869 6768 275d 3a0a 2020 2020 2020 2020  high']:.        
+000190e0: 7370 6563 7320 3d20 4157 532e 5f67 6574  specs = AWS._get
+000190f0: 5f64 6973 6b5f 7370 6563 7328 6469 736b  _disk_specs(disk
+00019100: 5f74 6965 7229 0a20 2020 2020 2020 206e  _tier).        n
+00019110: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
+00019120: 6572 5f6e 616d 6528 2920 2b20 272d 2720  er_name() + '-' 
+00019130: 2b20 6469 736b 5f74 6965 720a 2020 2020  + disk_tier.    
+00019140: 2020 2020 7265 6769 6f6e 203d 2027 7573      region = 'us
+00019150: 2d77 6573 742d 3227 0a20 2020 2020 2020  -west-2'.       
+00019160: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+00019170: 2020 2020 2020 2020 2020 2761 7773 2d64            'aws-d
+00019180: 6973 6b2d 7469 6572 272c 0a20 2020 2020  isk-tier',.     
+00019190: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+000191a0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+000191b0: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
+000191c0: 657d 202d 2d63 6c6f 7564 2061 7773 202d  e} --cloud aws -
+000191d0: 2d72 6567 696f 6e20 7b72 6567 696f 6e7d  -region {region}
+000191e0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+000191f0: 2020 2066 272d 2d64 6973 6b2d 7469 6572     f'--disk-tier
+00019200: 207b 6469 736b 5f74 6965 727d 2065 6368   {disk_tier} ech
+00019210: 6f20 2268 656c 6c6f 2073 6b79 2227 2c0a  o "hello sky"',.
+00019220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019230: 6627 6964 3d60 6177 7320 6563 3220 6465  f'id=`aws ec2 de
+00019240: 7363 7269 6265 2d69 6e73 7461 6e63 6573  scribe-instances
+00019250: 202d 2d72 6567 696f 6e20 7b72 6567 696f   --region {regio
+00019260: 6e7d 202d 2d66 696c 7465 7273 2027 0a20  n} --filters '. 
+00019270: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00019280: 274e 616d 653d 7461 673a 7261 792d 636c  'Name=tag:ray-cl
+00019290: 7573 7465 722d 6e61 6d65 2c56 616c 7565  uster-name,Value
+000192a0: 733d 7b6e 616d 657d 202d 2d71 7565 7279  s={name} --query
+000192b0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+000192c0: 2020 2066 2752 6573 6572 7661 7469 6f6e     f'Reservation
+000192d0: 735b 5d2e 496e 7374 616e 6365 735b 5d2e  s[].Instances[].
+000192e0: 496e 7374 616e 6365 4964 202d 2d6f 7574  InstanceId --out
+000192f0: 7075 7420 7465 7874 603b 2027 202b 0a20  put text`; ' +. 
+00019300: 2020 2020 2020 2020 2020 2020 2020 205f                 _
+00019310: 6765 745f 6177 735f 7175 6572 795f 636f  get_aws_query_co
+00019320: 6d6d 616e 6428 7265 6769 6f6e 2c20 2724  mmand(region, '$
+00019330: 6964 272c 2027 566f 6c75 6d65 5479 7065  id', 'VolumeType
+00019340: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+00019350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019360: 2020 2020 2020 2020 2020 7370 6563 735b            specs[
+00019370: 2764 6973 6b5f 7469 6572 275d 2920 2b0a  'disk_tier']) +.
+00019380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019390: 2827 2720 6966 2064 6973 6b5f 7469 6572  ('' if disk_tier
+000193a0: 203d 3d20 276c 6f77 2720 656c 7365 0a20   == 'low' else. 
+000193b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000193c0: 285f 6765 745f 6177 735f 7175 6572 795f  (_get_aws_query_
+000193d0: 636f 6d6d 616e 6428 7265 6769 6f6e 2c20  command(region, 
+000193e0: 2724 6964 272c 2027 496f 7073 272c 0a20  '$id', 'Iops',. 
+000193f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019410: 2020 2020 2020 2020 7370 6563 735b 2764          specs['d
+00019420: 6973 6b5f 696f 7073 275d 2920 2b0a 2020  isk_iops']) +.  
+00019430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019440: 5f67 6574 5f61 7773 5f71 7565 7279 5f63  _get_aws_query_c
+00019450: 6f6d 6d61 6e64 2872 6567 696f 6e2c 2027  ommand(region, '
+00019460: 2469 6427 2c20 2754 6872 6f75 6768 7075  $id', 'Throughpu
+00019470: 7427 2c0a 2020 2020 2020 2020 2020 2020  t',.            
+00019480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019490: 2020 2020 2020 2020 2020 2020 2073 7065               spe
+000194a0: 6373 5b27 6469 736b 5f74 6872 6f75 6768  cs['disk_through
+000194b0: 7075 7427 5d29 2929 2c0a 2020 2020 2020  put']))),.      
+000194c0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+000194d0: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
+000194e0: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
+000194f0: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
+00019500: 3130 202a 2036 302c 2020 2320 3130 206d  10 * 60,  # 10 m
+00019510: 696e 7320 2028 6974 2074 616b 6573 2061  ins  (it takes a
+00019520: 726f 756e 6420 7e36 206d 696e 7329 0a20  round ~6 mins). 
+00019530: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00019540: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+00019550: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
+00019560: 726b 2e67 6370 0a64 6566 2074 6573 745f  rk.gcp.def test_
+00019570: 6763 705f 6469 736b 5f74 6965 7228 293a  gcp_disk_tier():
+00019580: 0a20 2020 2066 6f72 2064 6973 6b5f 7469  .    for disk_ti
+00019590: 6572 2069 6e20 5b27 6c6f 7727 2c20 276d  er in ['low', 'm
+000195a0: 6564 6975 6d27 2c20 2768 6967 6827 5d3a  edium', 'high']:
+000195b0: 0a20 2020 2020 2020 2074 7970 6520 3d20  .        type = 
+000195c0: 4743 502e 5f67 6574 5f64 6973 6b5f 7479  GCP._get_disk_ty
+000195d0: 7065 2864 6973 6b5f 7469 6572 290a 2020  pe(disk_tier).  
+000195e0: 2020 2020 2020 6e61 6d65 203d 205f 6765        name = _ge
+000195f0: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+00019600: 202b 2027 2d27 202b 2064 6973 6b5f 7469   + '-' + disk_ti
+00019610: 6572 0a20 2020 2020 2020 2072 6567 696f  er.        regio
+00019620: 6e20 3d20 2775 732d 7765 7374 3227 0a20  n = 'us-west2'. 
+00019630: 2020 2020 2020 2074 6573 7420 3d20 5465         test = Te
+00019640: 7374 280a 2020 2020 2020 2020 2020 2020  st(.            
+00019650: 2767 6370 2d64 6973 6b2d 7469 6572 272c  'gcp-disk-tier',
+00019660: 0a20 2020 2020 2020 2020 2020 205b 0a20  .            [. 
+00019670: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00019680: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
+00019690: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
+000196a0: 2067 6370 202d 2d72 6567 696f 6e20 7b72   gcp --region {r
+000196b0: 6567 696f 6e7d 2027 0a20 2020 2020 2020  egion} '.       
+000196c0: 2020 2020 2020 2020 2066 272d 2d64 6973           f'--dis
+000196d0: 6b2d 7469 6572 207b 6469 736b 5f74 6965  k-tier {disk_tie
+000196e0: 727d 2065 6368 6f20 2268 656c 6c6f 2073  r} echo "hello s
+000196f0: 6b79 2227 2c0a 2020 2020 2020 2020 2020  ky"',.          
+00019700: 2020 2020 2020 6627 6e61 6d65 3d60 6763        f'name=`gc
+00019710: 6c6f 7564 2063 6f6d 7075 7465 2069 6e73  loud compute ins
+00019720: 7461 6e63 6573 206c 6973 7420 2d2d 6669  tances list --fi
+00019730: 6c74 6572 3d27 0a20 2020 2020 2020 2020  lter='.         
+00019740: 2020 2020 2020 2066 2722 6c61 6265 6c73         f'"labels
+00019750: 2e72 6179 2d63 6c75 7374 6572 2d6e 616d  .ray-cluster-nam
+00019760: 653a 7b6e 616d 657d 2220 2d2d 666f 726d  e:{name}" --form
+00019770: 6174 3d22 7661 6c75 6528 6e61 6d65 2922  at="value(name)"
+00019780: 603b 2027 0a20 2020 2020 2020 2020 2020  `; '.           
+00019790: 2020 2020 2066 2767 636c 6f75 6420 636f       f'gcloud co
+000197a0: 6d70 7574 6520 6469 736b 7320 6c69 7374  mpute disks list
+000197b0: 202d 2d66 696c 7465 723d 226e 616d 653d   --filter="name=
+000197c0: 246e 616d 6522 2027 0a20 2020 2020 2020  $name" '.       
+000197d0: 2020 2020 2020 2020 2066 272d 2d66 6f72           f'--for
+000197e0: 6d61 743d 2276 616c 7565 2874 7970 6529  mat="value(type)
+000197f0: 2220 7c20 6772 6570 207b 7479 7065 7d20  " | grep {type} 
+00019800: 270a 2020 2020 2020 2020 2020 2020 5d2c  '.            ],
+00019810: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00019820: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
+00019830: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
+00019840: 7469 6d65 6f75 743d 3620 2a20 3630 2c20  timeout=6 * 60, 
+00019850: 2023 2036 206d 696e 7320 2028 6974 2074   # 6 mins  (it t
+00019860: 616b 6573 2061 726f 756e 6420 7e33 206d  akes around ~3 m
+00019870: 696e 7329 0a20 2020 2020 2020 2029 0a20  ins).        ). 
+00019880: 2020 2020 2020 2072 756e 5f6f 6e65 5f74         run_one_t
+00019890: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
+000198a0: 6573 742e 6d61 726b 2e61 7a75 7265 0a64  est.mark.azure.d
+000198b0: 6566 2074 6573 745f 617a 7572 655f 6469  ef test_azure_di
+000198c0: 736b 5f74 6965 7228 293a 0a20 2020 2066  sk_tier():.    f
+000198d0: 6f72 2064 6973 6b5f 7469 6572 2069 6e20  or disk_tier in 
+000198e0: 5b27 6c6f 7727 2c20 276d 6564 6975 6d27  ['low', 'medium'
+000198f0: 5d3a 0a20 2020 2020 2020 2074 7970 6520  ]:.        type 
+00019900: 3d20 417a 7572 652e 5f67 6574 5f64 6973  = Azure._get_dis
+00019910: 6b5f 7479 7065 2864 6973 6b5f 7469 6572  k_type(disk_tier
+00019920: 290a 2020 2020 2020 2020 6e61 6d65 203d  ).        name =
+00019930: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+00019940: 6d65 2829 202b 2027 2d27 202b 2064 6973  me() + '-' + dis
+00019950: 6b5f 7469 6572 0a20 2020 2020 2020 2072  k_tier.        r
+00019960: 6567 696f 6e20 3d20 2777 6573 7475 7332  egion = 'westus2
+00019970: 270a 2020 2020 2020 2020 7465 7374 203d  '.        test =
+00019980: 2054 6573 7428 0a20 2020 2020 2020 2020   Test(.         
+00019990: 2020 2027 617a 7572 652d 6469 736b 2d74     'azure-disk-t
+000199a0: 6965 7227 2c0a 2020 2020 2020 2020 2020  ier',.          
+000199b0: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+000199c0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+000199d0: 202d 7920 2d63 207b 6e61 6d65 7d20 2d2d   -y -c {name} --
+000199e0: 636c 6f75 6420 617a 7572 6520 2d2d 7265  cloud azure --re
+000199f0: 6769 6f6e 207b 7265 6769 6f6e 7d20 270a  gion {region} '.
+00019a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019a10: 6627 2d2d 6469 736b 2d74 6965 7220 7b64  f'--disk-tier {d
+00019a20: 6973 6b5f 7469 6572 7d20 6563 686f 2022  isk_tier} echo "
+00019a30: 6865 6c6c 6f20 736b 7922 272c 0a20 2020  hello sky"',.   
+00019a40: 2020 2020 2020 2020 2020 2020 2066 2761               f'a
+00019a50: 7a20 7265 736f 7572 6365 206c 6973 7420  z resource list 
+00019a60: 2d2d 7461 6720 7261 792d 636c 7573 7465  --tag ray-cluste
+00019a70: 722d 6e61 6d65 3d7b 6e61 6d65 7d20 2d2d  r-name={name} --
+00019a80: 7175 6572 7920 270a 2020 2020 2020 2020  query '.        
+00019a90: 2020 2020 2020 2020 6627 225b 3f74 7970          f'"[?typ
+00019aa0: 653d 3d5c 274d 6963 726f 736f 6674 2e43  e==\'Microsoft.C
+00019ab0: 6f6d 7075 7465 2f64 6973 6b73 5c27 5d2e  ompute/disks\'].
+00019ac0: 736b 752e 6e61 6d65 2220 270a 2020 2020  sku.name" '.    
+00019ad0: 2020 2020 2020 2020 2020 2020 6627 2d2d              f'--
+00019ae0: 6f75 7470 7574 2074 7376 207c 2067 7265  output tsv | gre
+00019af0: 7020 7b74 7970 657d 270a 2020 2020 2020  p {type}'.      
+00019b00: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+00019b10: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
+00019b20: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
+00019b30: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
+00019b40: 3230 202a 2036 302c 2020 2320 3230 206d  20 * 60,  # 20 m
+00019b50: 696e 7320 2028 6974 2074 616b 6573 2061  ins  (it takes a
+00019b60: 726f 756e 6420 7e31 3220 6d69 6e73 290a  round ~12 mins).
+00019b70: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00019b80: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+00019b90: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d20  est)...# ------ 
+00019ba0: 5465 7374 696e 6720 5a65 726f 2051 756f  Testing Zero Quo
+00019bb0: 7461 2046 6169 6c6f 7665 7220 2d2d 2d2d  ta Failover ----
+00019bc0: 2d2d 0a40 7079 7465 7374 2e6d 6172 6b2e  --.@pytest.mark.
+00019bd0: 6177 730a 6465 6620 7465 7374 5f61 7773  aws.def test_aws
+00019be0: 5f7a 6572 6f5f 7175 6f74 615f 6661 696c  _zero_quota_fail
+00019bf0: 6f76 6572 2829 3a0a 0a20 2020 206e 616d  over():..    nam
+00019c00: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+00019c10: 5f6e 616d 6528 290a 2020 2020 7265 6769  _name().    regi
+00019c20: 6f6e 203d 2067 6574 5f61 7773 5f72 6567  on = get_aws_reg
+00019c30: 696f 6e5f 666f 725f 7175 6f74 615f 6661  ion_for_quota_fa
+00019c40: 696c 6f76 6572 2829 0a0a 2020 2020 6966  ilover()..    if
+00019c50: 206e 6f74 2072 6567 696f 6e3a 0a20 2020   not region:.   
+00019c60: 2020 2020 2070 7974 6573 742e 7866 6169       pytest.xfai
+00019c70: 6c28 0a20 2020 2020 2020 2020 2020 2027  l(.            '
+00019c80: 556e 6162 6c65 2074 6f20 7465 7374 207a  Unable to test z
+00019c90: 6572 6f20 7175 6f74 6120 6661 696c 6f76  ero quota failov
+00019ca0: 6572 206f 7074 696d 697a 6174 696f 6e20  er optimization 
+00019cb0: e280 9420 7175 6f74 6173 2027 0a20 2020  ... quotas '.   
+00019cc0: 2020 2020 2020 2020 2027 666f 7220 4543           'for EC
+00019cd0: 3220 5033 2069 6e73 7461 6e63 6573 2077  2 P3 instances w
+00019ce0: 6572 6520 666f 756e 6420 6f6e 2061 6c6c  ere found on all
+00019cf0: 2041 5753 2072 6567 696f 6e73 2e20 4973   AWS regions. Is
+00019d00: 2074 6869 7320 270a 2020 2020 2020 2020   this '.        
+00019d10: 2020 2020 2765 7870 6563 7465 6420 666f      'expected fo
+00019d20: 7220 796f 7572 2061 6363 6f75 6e74 3f27  r your account?'
+00019d30: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+00019d40: 0a0a 2020 2020 7465 7374 203d 2054 6573  ..    test = Tes
+00019d50: 7428 0a20 2020 2020 2020 2027 6177 732d  t(.        'aws-
+00019d60: 7a65 726f 2d71 756f 7461 2d66 6169 6c6f  zero-quota-failo
+00019d70: 7665 7227 2c0a 2020 2020 2020 2020 5b0a  ver',.        [.
+00019d80: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00019d90: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
+00019da0: 6e61 6d65 7d20 2d2d 636c 6f75 6420 6177  name} --cloud aw
+00019db0: 7320 2d2d 7265 6769 6f6e 207b 7265 6769  s --region {regi
+00019dc0: 6f6e 7d20 2d2d 6770 7573 2056 3130 303a  on} --gpus V100:
+00019dd0: 3820 2d2d 7573 652d 7370 6f74 207c 2067  8 --use-spot | g
+00019de0: 7265 7020 2246 6f75 6e64 206e 6f20 7175  rep "Found no qu
+00019df0: 6f74 6122 272c 0a20 2020 2020 2020 205d  ota"',.        ]
+00019e00: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+00019e10: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
+00019e20: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+00019e30: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+00019e40: 4070 7974 6573 742e 6d61 726b 2e67 6370  @pytest.mark.gcp
+00019e50: 0a64 6566 2074 6573 745f 6763 705f 7a65  .def test_gcp_ze
+00019e60: 726f 5f71 756f 7461 5f66 6169 6c6f 7665  ro_quota_failove
+00019e70: 7228 293a 0a0a 2020 2020 6e61 6d65 203d  r():..    name =
+00019e80: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+00019e90: 6d65 2829 0a20 2020 2072 6567 696f 6e20  me().    region 
+00019ea0: 3d20 6765 745f 6763 705f 7265 6769 6f6e  = get_gcp_region
+00019eb0: 5f66 6f72 5f71 756f 7461 5f66 6169 6c6f  _for_quota_failo
+00019ec0: 7665 7228 290a 0a20 2020 2069 6620 6e6f  ver()..    if no
+00019ed0: 7420 7265 6769 6f6e 3a0a 2020 2020 2020  t region:.      
+00019ee0: 2020 7079 7465 7374 2e78 6661 696c 280a    pytest.xfail(.
+00019ef0: 2020 2020 2020 2020 2020 2020 2755 6e61              'Una
+00019f00: 626c 6520 746f 2074 6573 7420 7a65 726f  ble to test zero
+00019f10: 2071 756f 7461 2066 6169 6c6f 7665 7220   quota failover 
+00019f20: 6f70 7469 6d69 7a61 7469 6f6e 20e2 8094  optimization ...
+00019f30: 2071 756f 7461 7320 270a 2020 2020 2020   quotas '.      
+00019f40: 2020 2020 2020 2766 6f72 2041 3130 302d        'for A100-
+00019f50: 3830 4742 2047 5055 7320 7765 7265 2066  80GB GPUs were f
+00019f60: 6f75 6e64 206f 6e20 616c 6c20 4743 5020  ound on all GCP 
+00019f70: 7265 6769 6f6e 732e 2049 7320 7468 6973  regions. Is this
+00019f80: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
+00019f90: 6578 7065 6374 6564 2066 6f72 2079 6f75  expected for you
+00019fa0: 7220 6163 636f 756e 743f 2729 0a20 2020  r account?').   
+00019fb0: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
+00019fc0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+00019fd0: 2020 2020 2020 2767 6370 2d7a 6572 6f2d        'gcp-zero-
+00019fe0: 7175 6f74 612d 6661 696c 6f76 6572 272c  quota-failover',
+00019ff0: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+0001a000: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
+0001a010: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
+0001a020: 202d 2d63 6c6f 7564 2067 6370 202d 2d72   --cloud gcp --r
+0001a030: 6567 696f 6e20 7b72 6567 696f 6e7d 202d  egion {region} -
+0001a040: 2d67 7075 7320 4131 3030 2d38 3047 423a  -gpus A100-80GB:
+0001a050: 3120 2d2d 7573 652d 7370 6f74 207c 2067  1 --use-spot | g
+0001a060: 7265 7020 2246 6f75 6e64 206e 6f20 7175  rep "Found no qu
+0001a070: 6f74 6122 272c 0a20 2020 2020 2020 205d  ota"',.        ]
+0001a080: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+0001a090: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
+0001a0a0: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+0001a0b0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+0001a0c0: 2320 2d2d 2d2d 2d2d 2d20 5465 7374 696e  # ------- Testin
+0001a0d0: 6720 7573 6572 2072 6179 2063 6c75 7374  g user ray clust
+0001a0e0: 6572 202d 2d2d 2d2d 2d2d 2d0a 4070 7974  er --------.@pyt
+0001a0f0: 6573 742e 6d61 726b 2e6e 6f5f 6b75 6265  est.mark.no_kube
+0001a100: 726e 6574 6573 2020 2320 4b75 6265 726e  rnetes  # Kubern
+0001a110: 6574 6573 2064 6f65 7320 6e6f 7420 7375  etes does not su
+0001a120: 7070 6f72 7420 736b 7920 7374 6174 7573  pport sky status
+0001a130: 202d 7220 7965 742e 0a64 6566 2074 6573   -r yet..def tes
+0001a140: 745f 7573 6572 5f72 6179 5f63 6c75 7374  t_user_ray_clust
+0001a150: 6572 2867 656e 6572 6963 5f63 6c6f 7564  er(generic_cloud
+0001a160: 3a20 7374 7229 3a0a 2020 2020 6e61 6d65  : str):.    name
+0001a170: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+0001a180: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
+0001a190: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+0001a1a0: 2775 7365 722d 7261 792d 636c 7573 7465  'user-ray-cluste
+0001a1b0: 7227 2c0a 2020 2020 2020 2020 5b0a 2020  r',.        [.  
+0001a1c0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0001a1d0: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
+0001a1e0: 6d65 7d20 2d2d 636c 6f75 6420 7b67 656e  me} --cloud {gen
+0001a1f0: 6572 6963 5f63 6c6f 7564 7d20 2272 6179  eric_cloud} "ray
+0001a200: 2073 7461 7274 202d 2d68 6561 6422 272c   start --head"',
+0001a210: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0001a220: 6b79 2065 7865 6320 7b6e 616d 657d 2022  ky exec {name} "
+0001a230: 6563 686f 2068 6922 272c 0a20 2020 2020  echo hi"',.     
+0001a240: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+0001a250: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
+0001a260: 7475 7327 2c0a 2020 2020 2020 2020 2020  tus',.          
+0001a270: 2020 6627 736b 7920 7374 6174 7573 202d    f'sky status -
+0001a280: 7220 7c20 6772 6570 207b 6e61 6d65 7d20  r | grep {name} 
+0001a290: 7c20 6772 6570 2055 5027 2c0a 2020 2020  | grep UP',.    
+0001a2a0: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+0001a2b0: 6563 207b 6e61 6d65 7d20 2265 6368 6f20  ec {name} "echo 
+0001a2c0: 6279 6522 272c 0a20 2020 2020 2020 2020  bye"',.         
+0001a2d0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+0001a2e0: 616d 657d 2032 202d 2d73 7461 7475 7327  ame} 2 --status'
+0001a2f0: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
+0001a300: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
+0001a310: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
+0001a320: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
+0001a330: 7374 2874 6573 7429 0a0a 0a23 202d 2d2d  st(test)...# ---
+0001a340: 2d2d 2d2d 2054 6573 7469 6e67 2074 6865  ---- Testing the
+0001a350: 2063 6f72 6520 4150 4920 2d2d 2d2d 2d2d   core API ------
+0001a360: 2d2d 0a23 204d 6f73 7420 6f66 2074 6865  --.# Most of the
+0001a370: 2063 6f72 6520 4150 4973 2068 6176 6520   core APIs have 
+0001a380: 6265 656e 2074 6573 7465 6420 696e 2074  been tested in t
+0001a390: 6865 2043 4c49 2074 6573 7473 2e0a 2320  he CLI tests..# 
+0001a3a0: 5468 6573 6520 7465 7374 7320 6172 6520  These tests are 
+0001a3b0: 666f 7220 7465 7374 696e 6720 7468 6520  for testing the 
+0001a3c0: 7265 7475 726e 2076 616c 7565 206f 6620  return value of 
+0001a3d0: 7468 6520 4150 4973 206e 6f74 2066 756c  the APIs not ful
+0001a3e0: 6c79 2075 7365 6420 696e 2043 4c49 2e0a  ly used in CLI..
+0001a3f0: 6465 6620 7465 7374 5f63 6f72 655f 6170  def test_core_ap
+0001a400: 6928 293a 0a20 2020 206e 616d 6520 3d20  i():.    name = 
+0001a410: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+0001a420: 6528 290a 2020 2020 736b 792e 6c61 756e  e().    sky.laun
+0001a430: 6368 0a20 2020 2023 2054 4f44 4f28 7a68  ch.    # TODO(zh
+0001a440: 7775 293a 2041 6464 2061 2074 6573 7420  wu): Add a test 
+0001a450: 666f 7220 636f 7265 2061 7069 2e0a 0a0a  for core api....
+0001a460: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573  # ---------- Tes
+0001a470: 7469 6e67 2053 746f 7261 6765 202d 2d2d  ting Storage ---
+0001a480: 2d2d 2d2d 2d2d 2d0a 636c 6173 7320 5465  -------.class Te
+0001a490: 7374 5374 6f72 6167 6557 6974 6843 7265  stStorageWithCre
+0001a4a0: 6465 6e74 6961 6c73 3a0a 2020 2020 2222  dentials:.    ""
+0001a4b0: 2253 746f 7261 6765 2074 6573 7473 2077  "Storage tests w
+0001a4c0: 6869 6368 2072 6571 7569 7265 2063 7265  hich require cre
+0001a4d0: 6465 6e74 6961 6c73 2061 6e64 206e 6574  dentials and net
+0001a4e0: 776f 726b 2063 6f6e 6e65 6374 696f 6e22  work connection"
+0001a4f0: 2222 0a0a 2020 2020 4157 535f 494e 5641  ""..    AWS_INVA
+0001a500: 4c49 445f 4e41 4d45 5320 3d20 5b0a 2020  LID_NAMES = [.  
+0001a510: 2020 2020 2020 2761 6227 2c20 2023 206c        'ab',  # l
+0001a520: 6573 7320 7468 616e 2033 2063 6861 7261  ess than 3 chara
+0001a530: 6374 6572 730a 2020 2020 2020 2020 2761  cters.        'a
+0001a540: 6263 6465 6667 6869 6a6b 6c6d 6e6f 7071  bcdefghijklmnopq
+0001a550: 7273 7475 7677 7879 7a61 6263 6465 6667  rstuvwxyzabcdefg
+0001a560: 6869 6a6b 6c6d 6e6f 7071 7273 7475 7677  hijklmnopqrstuvw
+0001a570: 7879 7a61 6263 6465 6667 6869 6a6b 6c6d  xyzabcdefghijklm
+0001a580: 6e6f 7071 7273 7475 7677 7879 7a31 272c  nopqrstuvwxyz1',
+0001a590: 0a20 2020 2020 2020 2023 206d 6f72 6520  .        # more 
+0001a5a0: 7468 616e 2036 3320 6368 6172 6163 7465  than 63 characte
+0001a5b0: 7273 0a20 2020 2020 2020 2027 4162 6364  rs.        'Abcd
+0001a5c0: 6566 272c 2020 2320 636f 6e74 6169 6e73  ef',  # contains
+0001a5d0: 2061 6e20 7570 7065 7263 6173 6520 6c65   an uppercase le
+0001a5e0: 7474 6572 0a20 2020 2020 2020 2027 6162  tter.        'ab
+0001a5f0: 6320 6465 6627 2c20 2023 2063 6f6e 7461  c def',  # conta
+0001a600: 696e 7320 6120 7370 6163 650a 2020 2020  ins a space.    
+0001a610: 2020 2020 2761 6263 2e2e 6465 6627 2c20      'abc..def', 
+0001a620: 2023 2074 776f 2061 646a 6163 656e 7420   # two adjacent 
+0001a630: 7065 7269 6f64 730a 2020 2020 2020 2020  periods.        
+0001a640: 2731 3932 2e31 3638 2e35 2e34 272c 2020  '192.168.5.4',  
+0001a650: 2320 666f 726d 6174 7465 6420 6173 2061  # formatted as a
+0001a660: 6e20 4950 2061 6464 7265 7373 0a20 2020  n IP address.   
+0001a670: 2020 2020 2027 786e 2d2d 6275 636b 6574       'xn--bucket
+0001a680: 272c 2020 2320 7374 6172 7473 2077 6974  ',  # starts wit
+0001a690: 6820 2778 6e2d 2d27 2070 7265 6669 780a  h 'xn--' prefix.
+0001a6a0: 2020 2020 2020 2020 2762 7563 6b65 742d          'bucket-
+0001a6b0: 7333 616c 6961 7327 2c20 2023 2065 6e64  s3alias',  # end
+0001a6c0: 7320 7769 7468 2027 2d73 3361 6c69 6173  s with '-s3alias
+0001a6d0: 2720 7375 6666 6978 0a20 2020 2020 2020  ' suffix.       
+0001a6e0: 2027 6275 636b 6574 2d2d 6f6c 2d73 3327   'bucket--ol-s3'
+0001a6f0: 2c20 2023 2065 6e64 7320 7769 7468 2027  ,  # ends with '
+0001a700: 2d2d 6f6c 2d73 3327 2073 7566 6669 780a  --ol-s3' suffix.
+0001a710: 2020 2020 2020 2020 272e 6162 6327 2c20          '.abc', 
+0001a720: 2023 2073 7461 7274 7320 7769 7468 2061   # starts with a
+0001a730: 2064 6f74 0a20 2020 2020 2020 2027 6162   dot.        'ab
+0001a740: 632e 272c 2020 2320 656e 6473 2077 6974  c.',  # ends wit
+0001a750: 6820 6120 646f 740a 2020 2020 2020 2020  h a dot.        
+0001a760: 272d 6162 6327 2c20 2023 2073 7461 7274  '-abc',  # start
+0001a770: 7320 7769 7468 2061 2068 7970 6865 6e0a  s with a hyphen.
+0001a780: 2020 2020 2020 2020 2761 6263 2d27 2c20          'abc-', 
+0001a790: 2023 2065 6e64 7320 7769 7468 2061 2068   # ends with a h
+0001a7a0: 7970 6865 6e0a 2020 2020 5d0a 0a20 2020  yphen.    ]..   
+0001a7b0: 2047 4353 5f49 4e56 414c 4944 5f4e 414d   GCS_INVALID_NAM
+0001a7c0: 4553 203d 205b 0a20 2020 2020 2020 2027  ES = [.        '
+0001a7d0: 6162 272c 2020 2320 6c65 7373 2074 6861  ab',  # less tha
+0001a7e0: 6e20 3320 6368 6172 6163 7465 7273 0a20  n 3 characters. 
+0001a7f0: 2020 2020 2020 2027 6162 6364 6566 6768         'abcdefgh
+0001a800: 696a 6b6c 6d6e 6f70 7172 7374 7576 7778  ijklmnopqrstuvwx
+0001a810: 797a 6162 6364 6566 6768 696a 6b6c 6d6e  yzabcdefghijklmn
+0001a820: 6f70 7172 7374 7576 7778 797a 6162 6364  opqrstuvwxyzabcd
+0001a830: 6566 6768 696a 6b6c 6d6e 6f70 7172 7374  efghijklmnopqrst
+0001a840: 7576 7778 797a 3127 2c0a 2020 2020 2020  uvwxyz1',.      
+0001a850: 2020 2320 6d6f 7265 2074 6861 6e20 3633    # more than 63
+0001a860: 2063 6861 7261 6374 6572 7320 2877 6974   characters (wit
+0001a870: 686f 7574 2064 6f74 7329 0a20 2020 2020  hout dots).     
+0001a880: 2020 2027 4162 6364 6566 272c 2020 2320     'Abcdef',  # 
+0001a890: 636f 6e74 6169 6e73 2061 6e20 7570 7065  contains an uppe
+0001a8a0: 7263 6173 6520 6c65 7474 6572 0a20 2020  rcase letter.   
+0001a8b0: 2020 2020 2027 6162 6320 6465 6627 2c20       'abc def', 
+0001a8c0: 2023 2063 6f6e 7461 696e 7320 6120 7370   # contains a sp
+0001a8d0: 6163 650a 2020 2020 2020 2020 2761 6263  ace.        'abc
+0001a8e0: 2e2e 6465 6627 2c20 2023 2074 776f 2061  ..def',  # two a
+0001a8f0: 646a 6163 656e 7420 7065 7269 6f64 730a  djacent periods.
+0001a900: 2020 2020 2020 2020 2761 6263 5f2e 6465          'abc_.de
+0001a910: 662e 6768 692e 6a6b 6c6d 6e6f 7071 7273  f.ghi.jklmnopqrs
+0001a920: 7475 7677 7879 7a61 6263 6465 6667 6869  tuvwxyzabcdefghi
+0001a930: 6a6b 6c6d 6e6f 7071 7273 7475 7677 7879  jklmnopqrstuvwxy
+0001a940: 7a61 6263 6465 6667 6869 6a6b 6c6d 6e6f  zabcdefghijklmno
+0001a950: 7071 7273 7475 7677 7879 7a31 270a 2020  pqrstuvwxyz1'.  
+0001a960: 2020 2020 2020 2320 4d6f 7265 2074 6861        # More tha
+0001a970: 6e20 3633 2063 6861 7261 6374 6572 7320  n 63 characters 
+0001a980: 6265 7477 6565 6e20 646f 7473 0a20 2020  between dots.   
+0001a990: 2020 2020 2027 6162 635f 2e64 6566 2e67       'abc_.def.g
+0001a9a0: 6869 2e6a 6b6c 6d6e 6f70 7172 7374 7576  hi.jklmnopqrstuv
+0001a9b0: 7778 797a 6162 6364 6566 6768 696a 6b6c  wxyzabcdefghijkl
+0001a9c0: 6d6e 6f70 7166 6768 696a 6b6c 6d6e 6f70  mnopqfghijklmnop
+0001a9d0: 7172 7374 7576 7727 202a 2035 2c0a 2020  qrstuvw' * 5,.  
+0001a9e0: 2020 2020 2020 2320 6d6f 7265 2074 6861        # more tha
+0001a9f0: 6e20 3232 3220 6368 6172 6163 7465 7273  n 222 characters
+0001aa00: 2028 7769 7468 2064 6f74 7329 0a20 2020   (with dots).   
+0001aa10: 2020 2020 2027 3139 322e 3136 382e 352e       '192.168.5.
+0001aa20: 3427 2c20 2023 2066 6f72 6d61 7474 6564  4',  # formatted
+0001aa30: 2061 7320 616e 2049 5020 6164 6472 6573   as an IP addres
+0001aa40: 730a 2020 2020 2020 2020 2767 6f6f 6762  s.        'googb
+0001aa50: 7563 6b65 7427 2c20 2023 2073 7461 7274  ucket',  # start
+0001aa60: 7320 7769 7468 2027 676f 6f67 2720 7072  s with 'goog' pr
+0001aa70: 6566 6978 0a20 2020 2020 2020 2027 676f  efix.        'go
+0001aa80: 6f67 6c65 6275 636b 6574 272c 2020 2320  oglebucket',  # 
+0001aa90: 636f 6e74 6169 6e73 2027 676f 6f67 6c65  contains 'google
+0001aaa0: 270a 2020 2020 2020 2020 2767 3030 676c  '.        'g00gl
+0001aab0: 6562 7563 6b65 7427 2c20 2023 2076 6172  ebucket',  # var
+0001aac0: 6961 6e74 206f 6620 2767 6f6f 676c 6527  iant of 'google'
+0001aad0: 0a20 2020 2020 2020 2027 676f 3067 6c65  .        'go0gle
+0001aae0: 6275 636b 6574 272c 2020 2320 7661 7269  bucket',  # vari
+0001aaf0: 616e 7420 6f66 2027 676f 6f67 6c65 270a  ant of 'google'.
+0001ab00: 2020 2020 2020 2020 2767 306f 676c 6562          'g0ogleb
+0001ab10: 7563 6b65 7427 2c20 2023 2076 6172 6961  ucket',  # varia
+0001ab20: 6e74 206f 6620 2767 6f6f 676c 6527 0a20  nt of 'google'. 
+0001ab30: 2020 2020 2020 2027 2e61 6263 272c 2020         '.abc',  
+0001ab40: 2320 7374 6172 7473 2077 6974 6820 6120  # starts with a 
+0001ab50: 646f 740a 2020 2020 2020 2020 2761 6263  dot.        'abc
+0001ab60: 2e27 2c20 2023 2065 6e64 7320 7769 7468  .',  # ends with
+0001ab70: 2061 2064 6f74 0a20 2020 2020 2020 2027   a dot.        '
+0001ab80: 5f61 6263 272c 2020 2320 7374 6172 7473  _abc',  # starts
+0001ab90: 2077 6974 6820 616e 2075 6e64 6572 7363   with an undersc
+0001aba0: 6f72 650a 2020 2020 2020 2020 2761 6263  ore.        'abc
+0001abb0: 5f27 2c20 2023 2065 6e64 7320 7769 7468  _',  # ends with
+0001abc0: 2061 6e20 756e 6465 7273 636f 7265 0a20   an underscore. 
+0001abd0: 2020 205d 0a0a 2020 2020 4942 4d5f 494e     ]..    IBM_IN
+0001abe0: 5641 4c49 445f 4e41 4d45 5320 3d20 5b0a  VALID_NAMES = [.
+0001abf0: 2020 2020 2020 2020 2761 6227 2c20 2023          'ab',  #
+0001ac00: 206c 6573 7320 7468 616e 2033 2063 6861   less than 3 cha
+0001ac10: 7261 6374 6572 730a 2020 2020 2020 2020  racters.        
+0001ac20: 2761 6263 6465 6667 6869 6a6b 6c6d 6e6f  'abcdefghijklmno
+0001ac30: 7071 7273 7475 7677 7879 7a61 6263 6465  pqrstuvwxyzabcde
+0001ac40: 6667 6869 6a6b 6c6d 6e6f 7071 7273 7475  fghijklmnopqrstu
+0001ac50: 7677 7879 7a61 6263 6465 6667 6869 6a6b  vwxyzabcdefghijk
+0001ac60: 6c6d 6e6f 7071 7273 7475 7677 7879 7a31  lmnopqrstuvwxyz1
+0001ac70: 272c 0a20 2020 2020 2020 2023 206d 6f72  ',.        # mor
+0001ac80: 6520 7468 616e 2036 3320 6368 6172 6163  e than 63 charac
+0001ac90: 7465 7273 0a20 2020 2020 2020 2027 4162  ters.        'Ab
+0001aca0: 6364 6566 272c 2020 2320 636f 6e74 6169  cdef',  # contai
+0001acb0: 6e73 2061 6e20 7570 7065 7263 6173 6520  ns an uppercase 
+0001acc0: 6c65 7474 6572 0a20 2020 2020 2020 2027  letter.        '
+0001acd0: 6162 6320 6465 6627 2c20 2023 2063 6f6e  abc def',  # con
+0001ace0: 7461 696e 7320 6120 7370 6163 650a 2020  tains a space.  
+0001acf0: 2020 2020 2020 2761 6263 2e2e 6465 6627        'abc..def'
+0001ad00: 2c20 2023 2074 776f 2061 646a 6163 656e  ,  # two adjacen
+0001ad10: 7420 7065 7269 6f64 730a 2020 2020 2020  t periods.      
+0001ad20: 2020 2731 3932 2e31 3638 2e35 2e34 272c    '192.168.5.4',
+0001ad30: 2020 2320 666f 726d 6174 7465 6420 6173    # formatted as
+0001ad40: 2061 6e20 4950 2061 6464 7265 7373 0a20   an IP address. 
+0001ad50: 2020 2020 2020 2027 786e 2d2d 6275 636b         'xn--buck
+0001ad60: 6574 272c 2020 2320 7374 6172 7473 2077  et',  # starts w
+0001ad70: 6974 6820 2778 6e2d 2d27 2070 7265 6669  ith 'xn--' prefi
+0001ad80: 780a 2020 2020 2020 2020 272e 6162 6327  x.        '.abc'
+0001ad90: 2c20 2023 2073 7461 7274 7320 7769 7468  ,  # starts with
+0001ada0: 2061 2064 6f74 0a20 2020 2020 2020 2027   a dot.        '
+0001adb0: 6162 632e 272c 2020 2320 656e 6473 2077  abc.',  # ends w
+0001adc0: 6974 6820 6120 646f 740a 2020 2020 2020  ith a dot.      
+0001add0: 2020 272d 6162 6327 2c20 2023 2073 7461    '-abc',  # sta
+0001ade0: 7274 7320 7769 7468 2061 2068 7970 6865  rts with a hyphe
+0001adf0: 6e0a 2020 2020 2020 2020 2761 6263 2d27  n.        'abc-'
+0001ae00: 2c20 2023 2065 6e64 7320 7769 7468 2061  ,  # ends with a
+0001ae10: 2068 7970 6865 6e0a 2020 2020 2020 2020   hyphen.        
+0001ae20: 2761 2e2d 6263 272c 2020 2320 636f 6e74  'a.-bc',  # cont
+0001ae30: 6169 6e73 2074 6865 2073 6571 7565 6e63  ains the sequenc
+0001ae40: 6520 272e 2d27 0a20 2020 2020 2020 2027  e '.-'.        '
+0001ae50: 612d 2e62 6327 2c20 2023 2063 6f6e 7461  a-.bc',  # conta
+0001ae60: 696e 7320 7468 6520 7365 7175 656e 6365  ins the sequence
+0001ae70: 2027 2d2e 270a 2020 2020 2020 2020 2761   '-.'.        'a
+0001ae80: 2662 6327 2020 2320 636f 6e74 6169 6e73  &bc'  # contains
+0001ae90: 2073 7065 6369 616c 2063 6861 7261 6374   special charact
+0001aea0: 6572 730a 2020 2020 2020 2020 2761 625e  ers.        'ab^
+0001aeb0: 6327 2020 2320 636f 6e74 6169 6e73 2073  c'  # contains s
+0001aec0: 7065 6369 616c 2063 6861 7261 6374 6572  pecial character
+0001aed0: 730a 2020 2020 5d0a 2020 2020 4749 5449  s.    ].    GITI
+0001aee0: 474e 4f52 455f 5359 4e43 5f54 4553 545f  GNORE_SYNC_TEST_
+0001aef0: 4449 525f 5354 5255 4354 5552 4520 3d20  DIR_STRUCTURE = 
+0001af00: 7b0a 2020 2020 2020 2020 2764 6f75 626c  {.        'doubl
+0001af10: 655f 6173 7465 7269 736b 273a 207b 0a20  e_asterisk': {. 
+0001af20: 2020 2020 2020 2020 2020 2027 646f 7562             'doub
+0001af30: 6c65 5f61 7374 6572 6973 6b5f 6578 636c  le_asterisk_excl
+0001af40: 7564 6564 273a 204e 6f6e 652c 0a20 2020  uded': None,.   
+0001af50: 2020 2020 2020 2020 2027 646f 7562 6c65           'double
+0001af60: 5f61 7374 6572 6973 6b5f 6578 636c 7564  _asterisk_exclud
+0001af70: 6564 5f64 6972 273a 207b 0a20 2020 2020  ed_dir': {.     
+0001af80: 2020 2020 2020 2020 2020 2027 6469 725f             'dir_
+0001af90: 6578 636c 7564 6564 273a 204e 6f6e 652c  excluded': None,
+0001afa0: 0a20 2020 2020 2020 2020 2020 207d 2c0a  .            },.
+0001afb0: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
+0001afc0: 2020 2027 646f 7562 6c65 5f61 7374 6572     'double_aster
+0001afd0: 6973 6b5f 7061 7265 6e74 273a 207b 0a20  isk_parent': {. 
+0001afe0: 2020 2020 2020 2020 2020 2027 7061 7265             'pare
+0001aff0: 6e74 273a 207b 0a20 2020 2020 2020 2020  nt': {.         
+0001b000: 2020 2020 2020 2027 616c 736f 5f65 7863         'also_exc
+0001b010: 6c75 6465 642e 7478 7427 3a20 4e6f 6e65  luded.txt': None
+0001b020: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001b030: 2020 2763 6869 6c64 273a 207b 0a20 2020    'child': {.   
+0001b040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b050: 2027 646f 7562 6c65 5f61 7374 6572 6973   'double_asteris
+0001b060: 6b5f 7061 7265 6e74 5f63 6869 6c64 5f65  k_parent_child_e
+0001b070: 7863 6c75 6465 642e 7478 7427 3a20 4e6f  xcluded.txt': No
+0001b080: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
+0001b090: 2020 2020 7d2c 0a20 2020 2020 2020 2020      },.         
+0001b0a0: 2020 2020 2020 2027 646f 7562 6c65 5f61         'double_a
+0001b0b0: 7374 6572 6973 6b5f 7061 7265 6e74 5f65  sterisk_parent_e
+0001b0c0: 7863 6c75 6465 642e 7478 7427 3a20 4e6f  xcluded.txt': No
+0001b0d0: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
+0001b0e0: 7d2c 0a20 2020 2020 2020 207d 2c0a 2020  },.        },.  
+0001b0f0: 2020 2020 2020 2765 7863 6c75 6465 642e        'excluded.
+0001b100: 6c6f 6727 3a20 4e6f 6e65 2c0a 2020 2020  log': None,.    
+0001b110: 2020 2020 2765 7863 6c75 6465 645f 6469      'excluded_di
+0001b120: 7227 3a20 7b0a 2020 2020 2020 2020 2020  r': {.          
+0001b130: 2020 2765 7863 6c75 6465 642e 7478 7427    'excluded.txt'
+0001b140: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
+0001b150: 2020 2020 276e 6573 7465 645f 6578 636c      'nested_excl
+0001b160: 7564 6564 273a 207b 0a20 2020 2020 2020  uded': {.       
+0001b170: 2020 2020 2020 2020 2027 6578 636c 7564           'exclud
+0001b180: 6564 273a 204e 6f6e 652c 0a20 2020 2020  ed': None,.     
+0001b190: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
+0001b1a0: 2020 7d2c 0a20 2020 2020 2020 2027 6578    },.        'ex
+0001b1b0: 702d 3127 3a20 7b0a 2020 2020 2020 2020  p-1': {.        
+0001b1c0: 2020 2020 2762 655f 6578 636c 7564 6564      'be_excluded
+0001b1d0: 273a 204e 6f6e 652c 0a20 2020 2020 2020  ': None,.       
+0001b1e0: 207d 2c0a 2020 2020 2020 2020 2765 7870   },.        'exp
+0001b1f0: 2d32 273a 207b 0a20 2020 2020 2020 2020  -2': {.         
+0001b200: 2020 2027 6265 5f65 7863 6c75 6465 6427     'be_excluded'
+0001b210: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
+0001b220: 7d2c 0a20 2020 2020 2020 2027 6672 6f6e  },.        'fron
+0001b230: 745f 736c 6173 685f 6578 636c 7564 6564  t_slash_excluded
+0001b240: 273a 204e 6f6e 652c 0a20 2020 2020 2020  ': None,.       
+0001b250: 2027 696e 636c 7564 6564 2e6c 6f67 273a   'included.log':
+0001b260: 204e 6f6e 652c 0a20 2020 2020 2020 2027   None,.        '
+0001b270: 696e 636c 7564 6564 2e74 7874 273a 204e  included.txt': N
+0001b280: 6f6e 652c 0a20 2020 2020 2020 2027 696e  one,.        'in
+0001b290: 636c 7564 655f 6469 7227 3a20 7b0a 2020  clude_dir': {.  
+0001b2a0: 2020 2020 2020 2020 2020 2765 7863 6c75            'exclu
+0001b2b0: 6465 642e 6c6f 6727 3a20 4e6f 6e65 2c0a  ded.log': None,.
+0001b2c0: 2020 2020 2020 2020 2020 2020 2769 6e63              'inc
+0001b2d0: 6c75 6465 642e 6c6f 6727 3a20 4e6f 6e65  luded.log': None
+0001b2e0: 2c0a 2020 2020 2020 2020 7d2c 0a20 2020  ,.        },.   
+0001b2f0: 2020 2020 2027 6e65 7374 6564 5f64 6f75       'nested_dou
+0001b300: 626c 655f 6173 7465 7269 736b 273a 207b  ble_asterisk': {
+0001b310: 0a20 2020 2020 2020 2020 2020 2027 6f6e  .            'on
+0001b320: 6527 3a20 7b0a 2020 2020 2020 2020 2020  e': {.          
+0001b330: 2020 2020 2020 2761 6c73 6f5f 6578 636c        'also_excl
+0001b340: 7564 652e 7478 7427 3a20 4e6f 6e65 2c0a  ude.txt': None,.
+0001b350: 2020 2020 2020 2020 2020 2020 7d2c 0a20              },. 
+0001b360: 2020 2020 2020 2020 2020 2027 7477 6f27             'two'
+0001b370: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
+0001b380: 2020 2020 2761 6c73 6f5f 6578 636c 7564      'also_exclud
+0001b390: 652e 7478 7427 3a20 4e6f 6e65 2c0a 2020  e.txt': None,.  
+0001b3a0: 2020 2020 2020 2020 2020 7d2c 0a20 2020            },.   
+0001b3b0: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
+0001b3c0: 276e 6573 7465 645f 7769 6c64 6361 7264  'nested_wildcard
+0001b3d0: 5f64 6972 273a 207b 0a20 2020 2020 2020  _dir': {.       
+0001b3e0: 2020 2020 2027 6d6f 6e64 6179 273a 207b       'monday': {
+0001b3f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001b400: 2027 616c 736f 5f65 7863 6c75 6465 2e74   'also_exclude.t
+0001b410: 7874 273a 204e 6f6e 652c 0a20 2020 2020  xt': None,.     
+0001b420: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
+0001b430: 2020 2020 2020 2774 7565 7364 6179 273a        'tuesday':
+0001b440: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0001b450: 2020 2027 616c 736f 5f65 7863 6c75 6465     'also_exclude
+0001b460: 2e74 7874 273a 204e 6f6e 652c 0a20 2020  .txt': None,.   
+0001b470: 2020 2020 2020 2020 207d 2c0a 2020 2020           },.    
+0001b480: 2020 2020 7d2c 0a20 2020 2020 2020 2027      },.        '
+0001b490: 6e6f 5f73 6c61 7368 5f65 7863 6c75 6465  no_slash_exclude
+0001b4a0: 6427 3a20 4e6f 6e65 2c0a 2020 2020 2020  d': None,.      
+0001b4b0: 2020 276e 6f5f 736c 6173 685f 7465 7374    'no_slash_test
+0001b4c0: 7327 3a20 7b0a 2020 2020 2020 2020 2020  s': {.          
+0001b4d0: 2020 276e 6f5f 736c 6173 685f 6578 636c    'no_slash_excl
+0001b4e0: 7564 6564 273a 207b 0a20 2020 2020 2020  uded': {.       
+0001b4f0: 2020 2020 2020 2020 2027 616c 736f 5f65           'also_e
+0001b500: 7863 6c75 6465 642e 7478 7427 3a20 4e6f  xcluded.txt': No
+0001b510: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
+0001b520: 7d2c 0a20 2020 2020 2020 207d 2c0a 2020  },.        },.  
+0001b530: 2020 2020 2020 2771 7565 7374 696f 6e5f        'question_
+0001b540: 6d61 726b 273a 207b 0a20 2020 2020 2020  mark': {.       
+0001b550: 2020 2020 2027 6578 636c 7564 6564 312e       'excluded1.
+0001b560: 7478 7427 3a20 4e6f 6e65 2c0a 2020 2020  txt': None,.    
+0001b570: 2020 2020 2020 2020 2765 7863 6c75 6465          'exclude
+0001b580: 6440 2e74 7874 273a 204e 6f6e 652c 0a20  d@.txt': None,. 
+0001b590: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
+0001b5a0: 2020 2773 7175 6172 655f 6272 6163 6b65    'square_bracke
+0001b5b0: 7427 3a20 7b0a 2020 2020 2020 2020 2020  t': {.          
+0001b5c0: 2020 2765 7863 6c75 6465 6431 2e74 7874    'excluded1.txt
+0001b5d0: 273a 204e 6f6e 652c 0a20 2020 2020 2020  ': None,.       
+0001b5e0: 207d 2c0a 2020 2020 2020 2020 2773 7175   },.        'squ
+0001b5f0: 6172 655f 6272 6163 6b65 745f 616c 7068  are_bracket_alph
+0001b600: 6127 3a20 7b0a 2020 2020 2020 2020 2020  a': {.          
+0001b610: 2020 2765 7863 6c75 6465 647a 2e74 7874    'excludedz.txt
+0001b620: 273a 204e 6f6e 652c 0a20 2020 2020 2020  ': None,.       
+0001b630: 207d 2c0a 2020 2020 2020 2020 2773 7175   },.        'squ
+0001b640: 6172 655f 6272 6163 6b65 745f 6578 636c  are_bracket_excl
+0001b650: 6127 3a20 7b0a 2020 2020 2020 2020 2020  a': {.          
+0001b660: 2020 2765 7863 6c75 6465 6432 2e74 7874    'excluded2.txt
+0001b670: 273a 204e 6f6e 652c 0a20 2020 2020 2020  ': None,.       
+0001b680: 2020 2020 2027 6578 636c 7564 6564 402e       'excluded@.
+0001b690: 7478 7427 3a20 4e6f 6e65 2c0a 2020 2020  txt': None,.    
+0001b6a0: 2020 2020 7d2c 0a20 2020 2020 2020 2027      },.        '
+0001b6b0: 7371 7561 7265 5f62 7261 636b 6574 5f73  square_bracket_s
+0001b6c0: 696e 676c 6527 3a20 7b0a 2020 2020 2020  ingle': {.      
+0001b6d0: 2020 2020 2020 2765 7863 6c75 6465 6430        'excluded0
+0001b6e0: 2e74 7874 273a 204e 6f6e 652c 0a20 2020  .txt': None,.   
+0001b6f0: 2020 2020 207d 2c0a 2020 2020 7d0a 0a20       },.    }.. 
+0001b700: 2020 2040 7374 6174 6963 6d65 7468 6f64     @staticmethod
+0001b710: 0a20 2020 2064 6566 2063 7265 6174 655f  .    def create_
+0001b720: 6469 725f 7374 7275 6374 7572 6528 6261  dir_structure(ba
+0001b730: 7365 5f70 6174 682c 2073 7472 7563 7475  se_path, structu
+0001b740: 7265 293a 0a20 2020 2020 2020 2023 2063  re):.        # c
+0001b750: 7265 6174 6573 2061 2067 6976 656e 2066  reates a given f
+0001b760: 696c 6520 5354 5255 4354 5552 4520 696e  ile STRUCTURE in
+0001b770: 2042 4153 455f 5041 5448 0a20 2020 2020   BASE_PATH.     
+0001b780: 2020 2066 6f72 206e 616d 652c 2073 7562     for name, sub
+0001b790: 7374 7275 6374 7572 6520 696e 2073 7472  structure in str
+0001b7a0: 7563 7475 7265 2e69 7465 6d73 2829 3a0a  ucture.items():.
+0001b7b0: 2020 2020 2020 2020 2020 2020 7061 7468              path
+0001b7c0: 203d 206f 732e 7061 7468 2e6a 6f69 6e28   = os.path.join(
+0001b7d0: 6261 7365 5f70 6174 682c 206e 616d 6529  base_path, name)
+0001b7e0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0001b7f0: 7375 6273 7472 7563 7475 7265 2069 7320  substructure is 
+0001b800: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0001b810: 2020 2020 2020 2320 4372 6561 7465 2061        # Create a
+0001b820: 2066 696c 650a 2020 2020 2020 2020 2020   file.          
+0001b830: 2020 2020 2020 6f70 656e 2870 6174 682c        open(path,
+0001b840: 2027 6127 292e 636c 6f73 6528 290a 2020   'a').close().  
+0001b850: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+0001b860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b870: 2320 4372 6561 7465 2061 2073 7562 6469  # Create a subdi
+0001b880: 7265 6374 6f72 790a 2020 2020 2020 2020  rectory.        
+0001b890: 2020 2020 2020 2020 6f73 2e6d 6b64 6972          os.mkdir
+0001b8a0: 2870 6174 6829 0a20 2020 2020 2020 2020  (path).         
+0001b8b0: 2020 2020 2020 2054 6573 7453 746f 7261         TestStora
+0001b8c0: 6765 5769 7468 4372 6564 656e 7469 616c  geWithCredential
+0001b8d0: 732e 6372 6561 7465 5f64 6972 5f73 7472  s.create_dir_str
+0001b8e0: 7563 7475 7265 280a 2020 2020 2020 2020  ucture(.        
+0001b8f0: 2020 2020 2020 2020 2020 2020 7061 7468              path
+0001b900: 2c20 7375 6273 7472 7563 7475 7265 290a  , substructure).
+0001b910: 0a20 2020 2040 7374 6174 6963 6d65 7468  .    @staticmeth
+0001b920: 6f64 0a20 2020 2064 6566 2063 6c69 5f64  od.    def cli_d
+0001b930: 656c 6574 655f 636d 6428 7374 6f72 655f  elete_cmd(store_
+0001b940: 7479 7065 2c20 6275 636b 6574 5f6e 616d  type, bucket_nam
+0001b950: 6529 3a0a 2020 2020 2020 2020 6966 2073  e):.        if s
+0001b960: 746f 7265 5f74 7970 6520 3d3d 2073 746f  tore_type == sto
 0001b970: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
-0001b980: 7065 2c0a 2020 2020 2020 2020 2020 2020  pe,.            
-0001b990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b9a0: 2020 2020 2020 7374 6f72 6167 655f 6c69        storage_li
-0001b9b0: 622e 4162 7374 7261 6374 5374 6f72 655d  b.AbstractStore]
-0001b9c0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
-0001b9d0: 2020 2020 2020 7065 7273 6973 7465 6e74        persistent
-0001b9e0: 3a20 4f70 7469 6f6e 616c 5b62 6f6f 6c5d  : Optional[bool]
-0001b9f0: 203d 2054 7275 652c 0a20 2020 2020 2020   = True,.       
-0001ba00: 2020 2020 206d 6f64 653a 2073 746f 7261       mode: stora
-0001ba10: 6765 5f6c 6962 2e53 746f 7261 6765 4d6f  ge_lib.StorageMo
-0001ba20: 6465 203d 2073 746f 7261 6765 5f6c 6962  de = storage_lib
-0001ba30: 2e53 746f 7261 6765 4d6f 6465 2e4d 4f55  .StorageMode.MOU
-0001ba40: 4e54 293a 0a20 2020 2020 2020 2023 2043  NT):.        # C
-0001ba50: 7265 6174 6573 2061 2074 656d 706f 7261  reates a tempora
-0001ba60: 7279 2073 746f 7261 6765 206f 626a 6563  ry storage objec
-0001ba70: 742e 2053 746f 7265 7320 6d75 7374 2062  t. Stores must b
-0001ba80: 6520 6164 6465 6420 696e 2074 6865 2074  e added in the t
-0001ba90: 6573 742e 0a20 2020 2020 2020 2073 746f  est..        sto
-0001baa0: 7261 6765 5f6f 626a 203d 2073 746f 7261  rage_obj = stora
-0001bab0: 6765 5f6c 6962 2e53 746f 7261 6765 286e  ge_lib.Storage(n
-0001bac0: 616d 653d 6e61 6d65 2c0a 2020 2020 2020  ame=name,.      
-0001bad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001baf0: 2020 2020 736f 7572 6365 3d73 6f75 7263      source=sourc
-0001bb00: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-0001bb10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bb20: 2020 2020 2020 2020 2020 2020 2073 746f               sto
-0001bb30: 7265 733d 7374 6f72 6573 2c0a 2020 2020  res=stores,.    
-0001bb40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bb60: 2020 2020 2020 7065 7273 6973 7465 6e74        persistent
-0001bb70: 3d70 6572 7369 7374 656e 742c 0a20 2020  =persistent,.   
-0001bb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bb90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bba0: 2020 2020 2020 206d 6f64 653d 6d6f 6465         mode=mode
-0001bbb0: 290a 2020 2020 2020 2020 7969 656c 6420  ).        yield 
-0001bbc0: 7374 6f72 6167 655f 6f62 6a0a 2020 2020  storage_obj.    
-0001bbd0: 2020 2020 6861 6e64 6c65 203d 2067 6c6f      handle = glo
-0001bbe0: 6261 6c5f 7573 6572 5f73 7461 7465 2e67  bal_user_state.g
-0001bbf0: 6574 5f68 616e 646c 655f 6672 6f6d 5f73  et_handle_from_s
-0001bc00: 746f 7261 6765 5f6e 616d 6528 0a20 2020  torage_name(.   
-0001bc10: 2020 2020 2020 2020 2073 746f 7261 6765           storage
-0001bc20: 5f6f 626a 2e6e 616d 6529 0a20 2020 2020  _obj.name).     
-0001bc30: 2020 2069 6620 6861 6e64 6c65 3a0a 2020     if handle:.  
-0001bc40: 2020 2020 2020 2020 2020 2320 4966 2068            # If h
-0001bc50: 616e 646c 6520 6578 6973 7473 2c20 6465  andle exists, de
-0001bc60: 6c65 7465 206d 616e 7561 6c6c 790a 2020  lete manually.  
-0001bc70: 2020 2020 2020 2020 2020 2320 544f 444f            # TODO
-0001bc80: 2872 6f6d 696c 6229 3a20 5468 6973 2069  (romilb): This i
-0001bc90: 7320 706f 7465 6e74 6961 6c6c 7920 7269  s potentially ri
-0001bca0: 736b 7920 2d20 6966 2074 6865 2064 656c  sky - if the del
-0001bcb0: 6574 6520 6d65 7468 6f64 2068 6173 0a20  ete method has. 
-0001bcc0: 2020 2020 2020 2020 2020 2023 2020 2062             #   b
-0001bcd0: 7567 732c 2074 6869 7320 6361 6e20 6361  ugs, this can ca
-0001bce0: 7573 6520 7265 736f 7572 6365 206c 6561  use resource lea
-0001bcf0: 6b73 2e20 4964 6561 6c6c 7920 7765 2073  ks. Ideally we s
-0001bd00: 686f 756c 6420 6d61 6e75 616c 6c79 0a20  hould manually. 
-0001bd10: 2020 2020 2020 2020 2020 2023 2020 2065             #   e
-0001bd20: 6a65 6374 2073 746f 7261 6765 2066 726f  ject storage fro
-0001bd30: 6d20 676c 6f62 616c 5f75 7365 725f 7374  m global_user_st
-0001bd40: 6174 6520 616e 6420 6465 6c65 7465 2074  ate and delete t
-0001bd50: 6865 2062 7563 6b65 7420 7573 696e 670a  he bucket using.
-0001bd60: 2020 2020 2020 2020 2020 2020 2320 2020              #   
-0001bd70: 626f 746f 3320 6469 7265 6374 6c79 2e0a  boto3 directly..
-0001bd80: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
-0001bd90: 6167 655f 6f62 6a2e 6465 6c65 7465 2829  age_obj.delete()
-0001bda0: 0a0a 2020 2020 4070 7974 6573 742e 6669  ..    @pytest.fi
-0001bdb0: 7874 7572 650a 2020 2020 6465 6620 746d  xture.    def tm
-0001bdc0: 705f 7363 7261 7463 685f 7374 6f72 6167  p_scratch_storag
-0001bdd0: 655f 6f62 6a28 7365 6c66 2c20 746d 705f  e_obj(self, tmp_
-0001bde0: 6275 636b 6574 5f6e 616d 6529 3a0a 2020  bucket_name):.  
-0001bdf0: 2020 2020 2020 2320 4372 6561 7465 7320        # Creates 
-0001be00: 6120 7374 6f72 6167 6520 6f62 6a65 6374  a storage object
-0001be10: 2077 6974 6820 6e6f 2073 6f75 7263 6520   with no source 
-0001be20: 746f 2063 7265 6174 6520 6120 7363 7261  to create a scra
-0001be30: 7463 6820 7374 6f72 6167 652e 0a20 2020  tch storage..   
-0001be40: 2020 2020 2023 2053 746f 7265 7320 6d75       # Stores mu
-0001be50: 7374 2062 6520 6164 6465 6420 696e 2074  st be added in t
-0001be60: 6865 2074 6573 742e 0a20 2020 2020 2020  he test..       
-0001be70: 2079 6965 6c64 2066 726f 6d20 7365 6c66   yield from self
-0001be80: 2e79 6965 6c64 5f73 746f 7261 6765 5f6f  .yield_storage_o
-0001be90: 626a 6563 7428 6e61 6d65 3d74 6d70 5f62  bject(name=tmp_b
-0001bea0: 7563 6b65 745f 6e61 6d65 290a 0a20 2020  ucket_name)..   
-0001beb0: 2040 7079 7465 7374 2e66 6978 7475 7265   @pytest.fixture
-0001bec0: 0a20 2020 2064 6566 2074 6d70 5f6d 756c  .    def tmp_mul
-0001bed0: 7469 706c 655f 7363 7261 7463 685f 7374  tiple_scratch_st
-0001bee0: 6f72 6167 655f 6f62 6a28 7365 6c66 293a  orage_obj(self):
-0001bef0: 0a20 2020 2020 2020 2023 2043 7265 6174  .        # Creat
-0001bf00: 6573 2061 206c 6973 7420 6f66 2035 2073  es a list of 5 s
-0001bf10: 746f 7261 6765 206f 626a 6563 7473 2077  torage objects w
-0001bf20: 6974 6820 6e6f 2073 6f75 7263 6520 746f  ith no source to
-0001bf30: 2063 7265 6174 650a 2020 2020 2020 2020   create.        
-0001bf40: 2320 6d75 6c74 6970 6c65 2073 6372 6174  # multiple scrat
-0001bf50: 6368 2073 746f 7261 6765 732e 0a20 2020  ch storages..   
-0001bf60: 2020 2020 2023 2053 746f 7265 7320 666f       # Stores fo
-0001bf70: 7220 6561 6368 206f 626a 6563 7420 696e  r each object in
-0001bf80: 2074 6865 206c 6973 7420 6d75 7374 2062   the list must b
-0001bf90: 6520 6164 6465 6420 696e 2074 6865 2074  e added in the t
-0001bfa0: 6573 742e 0a20 2020 2020 2020 2073 746f  est..        sto
-0001bfb0: 7261 6765 5f6d 756c 745f 6f62 6a20 3d20  rage_mult_obj = 
-0001bfc0: 5b5d 0a20 2020 2020 2020 2066 6f72 205f  [].        for _
-0001bfd0: 2069 6e20 7261 6e67 6528 3529 3a0a 2020   in range(5):.  
-0001bfe0: 2020 2020 2020 2020 2020 7469 6d65 7374            timest
-0001bff0: 616d 7020 3d20 7374 7228 7469 6d65 2e74  amp = str(time.t
-0001c000: 696d 6528 2929 2e72 6570 6c61 6365 2827  ime()).replace('
-0001c010: 2e27 2c20 2727 290a 2020 2020 2020 2020  .', '').        
-0001c020: 2020 2020 7374 6f72 655f 6f62 6a20 3d20      store_obj = 
-0001c030: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
-0001c040: 6167 6528 6e61 6d65 3d66 2773 6b79 2d74  age(name=f'sky-t
-0001c050: 6573 742d 7b74 696d 6573 7461 6d70 7d27  est-{timestamp}'
-0001c060: 290a 2020 2020 2020 2020 2020 2020 7374  ).            st
-0001c070: 6f72 6167 655f 6d75 6c74 5f6f 626a 2e61  orage_mult_obj.a
-0001c080: 7070 656e 6428 7374 6f72 655f 6f62 6a29  ppend(store_obj)
-0001c090: 0a20 2020 2020 2020 2079 6965 6c64 2073  .        yield s
-0001c0a0: 746f 7261 6765 5f6d 756c 745f 6f62 6a0a  torage_mult_obj.
-0001c0b0: 2020 2020 2020 2020 666f 7220 7374 6f72          for stor
-0001c0c0: 6167 655f 6f62 6a20 696e 2073 746f 7261  age_obj in stora
-0001c0d0: 6765 5f6d 756c 745f 6f62 6a3a 0a20 2020  ge_mult_obj:.   
-0001c0e0: 2020 2020 2020 2020 2068 616e 646c 6520           handle 
-0001c0f0: 3d20 676c 6f62 616c 5f75 7365 725f 7374  = global_user_st
-0001c100: 6174 652e 6765 745f 6861 6e64 6c65 5f66  ate.get_handle_f
-0001c110: 726f 6d5f 7374 6f72 6167 655f 6e61 6d65  rom_storage_name
-0001c120: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0001c130: 2020 7374 6f72 6167 655f 6f62 6a2e 6e61    storage_obj.na
-0001c140: 6d65 290a 2020 2020 2020 2020 2020 2020  me).            
-0001c150: 6966 2068 616e 646c 653a 0a20 2020 2020  if handle:.     
-0001c160: 2020 2020 2020 2020 2020 2023 2049 6620             # If 
-0001c170: 6861 6e64 6c65 2065 7869 7374 732c 2064  handle exists, d
-0001c180: 656c 6574 6520 6d61 6e75 616c 6c79 0a20  elete manually. 
-0001c190: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0001c1a0: 2054 4f44 4f28 726f 6d69 6c62 293a 2054   TODO(romilb): T
-0001c1b0: 6869 7320 6973 2070 6f74 656e 7469 616c  his is potential
-0001c1c0: 6c79 2072 6973 6b79 202d 2069 6620 7468  ly risky - if th
-0001c1d0: 6520 6465 6c65 7465 206d 6574 686f 6420  e delete method 
-0001c1e0: 6861 730a 2020 2020 2020 2020 2020 2020  has.            
-0001c1f0: 2020 2020 2320 6275 6773 2c20 7468 6973      # bugs, this
-0001c200: 2063 616e 2063 6175 7365 2072 6573 6f75   can cause resou
-0001c210: 7263 6520 6c65 616b 732e 2049 6465 616c  rce leaks. Ideal
-0001c220: 6c79 2077 6520 7368 6f75 6c64 206d 616e  ly we should man
-0001c230: 7561 6c6c 790a 2020 2020 2020 2020 2020  ually.          
-0001c240: 2020 2020 2020 2320 656a 6563 7420 7374        # eject st
-0001c250: 6f72 6167 6520 6672 6f6d 2067 6c6f 6261  orage from globa
-0001c260: 6c5f 7573 6572 5f73 7461 7465 2061 6e64  l_user_state and
-0001c270: 2064 656c 6574 6520 7468 6520 6275 636b   delete the buck
-0001c280: 6574 2075 7369 6e67 0a20 2020 2020 2020  et using.       
-0001c290: 2020 2020 2020 2020 2023 2062 6f74 6f33           # boto3
-0001c2a0: 2064 6972 6563 746c 792e 0a20 2020 2020   directly..     
-0001c2b0: 2020 2020 2020 2020 2020 2073 746f 7261             stora
-0001c2c0: 6765 5f6f 626a 2e64 656c 6574 6528 290a  ge_obj.delete().
-0001c2d0: 0a20 2020 2040 7079 7465 7374 2e66 6978  .    @pytest.fix
-0001c2e0: 7475 7265 0a20 2020 2064 6566 2074 6d70  ture.    def tmp
-0001c2f0: 5f6c 6f63 616c 5f73 746f 7261 6765 5f6f  _local_storage_o
-0001c300: 626a 2873 656c 662c 2074 6d70 5f62 7563  bj(self, tmp_buc
-0001c310: 6b65 745f 6e61 6d65 2c20 746d 705f 736f  ket_name, tmp_so
-0001c320: 7572 6365 293a 0a20 2020 2020 2020 2023  urce):.        #
-0001c330: 2043 7265 6174 6573 2061 2074 656d 706f   Creates a tempo
-0001c340: 7261 7279 2073 746f 7261 6765 206f 626a  rary storage obj
-0001c350: 6563 742e 2053 746f 7265 7320 6d75 7374  ect. Stores must
-0001c360: 2062 6520 6164 6465 6420 696e 2074 6865   be added in the
-0001c370: 2074 6573 742e 0a20 2020 2020 2020 2079   test..        y
-0001c380: 6965 6c64 2066 726f 6d20 7365 6c66 2e79  ield from self.y
-0001c390: 6965 6c64 5f73 746f 7261 6765 5f6f 626a  ield_storage_obj
-0001c3a0: 6563 7428 6e61 6d65 3d74 6d70 5f62 7563  ect(name=tmp_buc
-0001c3b0: 6b65 745f 6e61 6d65 2c0a 2020 2020 2020  ket_name,.      
-0001c3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c3e0: 2020 2020 2020 2073 6f75 7263 653d 746d         source=tm
-0001c3f0: 705f 736f 7572 6365 290a 0a20 2020 2040  p_source)..    @
-0001c400: 7079 7465 7374 2e66 6978 7475 7265 0a20  pytest.fixture. 
-0001c410: 2020 2064 6566 2074 6d70 5f6c 6f63 616c     def tmp_local
-0001c420: 5f6c 6973 745f 7374 6f72 6167 655f 6f62  _list_storage_ob
-0001c430: 6a28 7365 6c66 2c20 746d 705f 6275 636b  j(self, tmp_buck
-0001c440: 6574 5f6e 616d 652c 2074 6d70 5f73 6f75  et_name, tmp_sou
-0001c450: 7263 6529 3a0a 2020 2020 2020 2020 2320  rce):.        # 
-0001c460: 4372 6561 7465 7320 6120 7465 6d70 2073  Creates a temp s
-0001c470: 746f 7261 6765 206f 626a 6563 7420 7768  torage object wh
-0001c480: 6963 6820 7573 6573 2061 206c 6973 7420  ich uses a list 
-0001c490: 6f66 2070 6174 6873 2061 7320 736f 7572  of paths as sour
-0001c4a0: 6365 2e0a 2020 2020 2020 2020 2320 5374  ce..        # St
-0001c4b0: 6f72 6573 206d 7573 7420 6265 2061 6464  ores must be add
-0001c4c0: 6564 2069 6e20 7468 6520 7465 7374 2e20  ed in the test. 
-0001c4d0: 4166 7465 7220 7570 6c6f 6164 2c20 7468  After upload, th
-0001c4e0: 6520 6275 636b 6574 2073 686f 756c 640a  e bucket should.
-0001c4f0: 2020 2020 2020 2020 2320 6861 7665 2074          # have t
-0001c500: 776f 2066 696c 6573 202d 202f 746d 702d  wo files - /tmp-
-0001c510: 6669 6c65 2061 6e64 202f 746d 702d 736f  file and /tmp-so
-0001c520: 7572 6365 2f74 6d70 2d66 696c 650a 2020  urce/tmp-file.  
-0001c530: 2020 2020 2020 6c69 7374 5f73 6f75 7263        list_sourc
-0001c540: 6520 3d20 5b74 6d70 5f73 6f75 7263 652c  e = [tmp_source,
-0001c550: 2074 6d70 5f73 6f75 7263 6520 2b20 272f   tmp_source + '/
-0001c560: 746d 702d 6669 6c65 275d 0a20 2020 2020  tmp-file'].     
-0001c570: 2020 2079 6965 6c64 2066 726f 6d20 7365     yield from se
-0001c580: 6c66 2e79 6965 6c64 5f73 746f 7261 6765  lf.yield_storage
-0001c590: 5f6f 626a 6563 7428 6e61 6d65 3d74 6d70  _object(name=tmp
-0001c5a0: 5f62 7563 6b65 745f 6e61 6d65 2c0a 2020  _bucket_name,.  
-0001c5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c5d0: 2020 2020 2020 2020 2020 2073 6f75 7263             sourc
-0001c5e0: 653d 6c69 7374 5f73 6f75 7263 6529 0a0a  e=list_source)..
-0001c5f0: 2020 2020 4070 7974 6573 742e 6669 7874      @pytest.fixt
-0001c600: 7572 650a 2020 2020 6465 6620 746d 705f  ure.    def tmp_
-0001c610: 6275 6c6b 5f64 656c 5f73 746f 7261 6765  bulk_del_storage
-0001c620: 5f6f 626a 2873 656c 662c 2074 6d70 5f62  _obj(self, tmp_b
-0001c630: 7563 6b65 745f 6e61 6d65 293a 0a20 2020  ucket_name):.   
-0001c640: 2020 2020 2023 2043 7265 6174 6573 2061       # Creates a
-0001c650: 2074 656d 706f 7261 7279 2073 746f 7261   temporary stora
-0001c660: 6765 206f 626a 6563 7420 666f 7220 7465  ge object for te
-0001c670: 7374 696e 6720 6275 6c6b 2064 656c 6574  sting bulk delet
-0001c680: 696f 6e2e 0a20 2020 2020 2020 2023 2053  ion..        # S
-0001c690: 746f 7265 7320 6d75 7374 2062 6520 6164  tores must be ad
-0001c6a0: 6465 6420 696e 2074 6865 2074 6573 742e  ded in the test.
-0001c6b0: 0a20 2020 2020 2020 2077 6974 6820 7465  .        with te
-0001c6c0: 6d70 6669 6c65 2e54 656d 706f 7261 7279  mpfile.Temporary
-0001c6d0: 4469 7265 6374 6f72 7928 2920 6173 2074  Directory() as t
-0001c6e0: 6d70 6469 723a 0a20 2020 2020 2020 2020  mpdir:.         
-0001c6f0: 2020 2073 7562 7072 6f63 6573 732e 6368     subprocess.ch
-0001c700: 6563 6b5f 6f75 7470 7574 2866 276d 6b64  eck_output(f'mkd
-0001c710: 6972 202d 7020 7b74 6d70 6469 727d 2f66  ir -p {tmpdir}/f
-0001c720: 6f6c 6465 727b 7b30 3030 2e2e 3235 357d  older{{000..255}
-0001c730: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
-0001c740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c750: 2020 2020 2020 2020 7368 656c 6c3d 5472          shell=Tr
-0001c760: 7565 290a 2020 2020 2020 2020 2020 2020  ue).            
-0001c770: 7375 6270 726f 6365 7373 2e63 6865 636b  subprocess.check
-0001c780: 5f6f 7574 7075 7428 6627 746f 7563 6820  _output(f'touch 
-0001c790: 7b74 6d70 6469 727d 2f74 6573 747b 7b30  {tmpdir}/test{{0
-0001c7a0: 3030 2e2e 3235 357d 7d2e 7478 7427 2c0a  00..255}}.txt',.
-0001c7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c7d0: 2020 2020 7368 656c 6c3d 5472 7565 290a      shell=True).
-0001c7e0: 2020 2020 2020 2020 2020 2020 7375 6270              subp
-0001c7f0: 726f 6365 7373 2e63 6865 636b 5f6f 7574  rocess.check_out
-0001c800: 7075 7428 0a20 2020 2020 2020 2020 2020  put(.           
-0001c810: 2020 2020 2066 2774 6f75 6368 207b 746d       f'touch {tm
-0001c820: 7064 6972 7d2f 666f 6c64 6572 7b7b 3030  pdir}/folder{{00
-0001c830: 302e 2e32 3535 7d7d 2f74 6573 742e 7478  0..255}}/test.tx
-0001c840: 7427 2c20 7368 656c 6c3d 5472 7565 290a  t', shell=True).
-0001c850: 2020 2020 2020 2020 2020 2020 7969 656c              yiel
-0001c860: 6420 6672 6f6d 2073 656c 662e 7969 656c  d from self.yiel
-0001c870: 645f 7374 6f72 6167 655f 6f62 6a65 6374  d_storage_object
-0001c880: 286e 616d 653d 746d 705f 6275 636b 6574  (name=tmp_bucket
-0001c890: 5f6e 616d 652c 0a20 2020 2020 2020 2020  _name,.         
-0001c8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c8c0: 2020 2020 2020 2020 736f 7572 6365 3d74          source=t
-0001c8d0: 6d70 6469 7229 0a0a 2020 2020 4070 7974  mpdir)..    @pyt
-0001c8e0: 6573 742e 6669 7874 7572 650a 2020 2020  est.fixture.    
-0001c8f0: 6465 6620 746d 705f 636f 7079 5f6d 6e74  def tmp_copy_mnt
-0001c900: 5f65 7869 7374 696e 675f 7374 6f72 6167  _existing_storag
-0001c910: 655f 6f62 6a28 7365 6c66 2c20 746d 705f  e_obj(self, tmp_
-0001c920: 7363 7261 7463 685f 7374 6f72 6167 655f  scratch_storage_
-0001c930: 6f62 6a29 3a0a 2020 2020 2020 2020 2320  obj):.        # 
-0001c940: 4372 6561 7465 7320 6120 636f 7079 206d  Creates a copy m
-0001c950: 6f75 6e74 2073 746f 7261 6765 2077 6869  ount storage whi
-0001c960: 6368 2072 6575 7365 7320 616e 2065 7869  ch reuses an exi
-0001c970: 7374 696e 6720 7374 6f72 6167 6520 6f62  sting storage ob
-0001c980: 6a65 6374 2e0a 2020 2020 2020 2020 746d  ject..        tm
-0001c990: 705f 7363 7261 7463 685f 7374 6f72 6167  p_scratch_storag
-0001c9a0: 655f 6f62 6a2e 6164 645f 7374 6f72 6528  e_obj.add_store(
-0001c9b0: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
-0001c9c0: 6554 7970 652e 5333 290a 2020 2020 2020  eType.S3).      
-0001c9d0: 2020 7374 6f72 6167 655f 6e61 6d65 203d    storage_name =
-0001c9e0: 2074 6d70 5f73 6372 6174 6368 5f73 746f   tmp_scratch_sto
-0001c9f0: 7261 6765 5f6f 626a 2e6e 616d 650a 0a20  rage_obj.name.. 
-0001ca00: 2020 2020 2020 2023 2054 7279 2074 6f20         # Try to 
-0001ca10: 696e 6974 6961 6c69 7a65 2061 6e6f 7468  initialize anoth
-0001ca20: 6572 2073 746f 7261 6765 2077 6974 6820  er storage with 
-0001ca30: 7468 6520 7374 6f72 6167 6520 6f62 6a65  the storage obje
-0001ca40: 6374 2063 7265 6174 6564 0a20 2020 2020  ct created.     
-0001ca50: 2020 2023 2061 626f 7665 2c20 6275 7420     # above, but 
-0001ca60: 6e6f 7720 696e 2043 4f50 5920 6d6f 6465  now in COPY mode
-0001ca70: 2e20 5468 6973 2073 686f 756c 6420 7375  . This should su
-0001ca80: 6363 6565 642e 0a20 2020 2020 2020 2079  cceed..        y
-0001ca90: 6965 6c64 2066 726f 6d20 7365 6c66 2e79  ield from self.y
-0001caa0: 6965 6c64 5f73 746f 7261 6765 5f6f 626a  ield_storage_obj
-0001cab0: 6563 7428 6e61 6d65 3d73 746f 7261 6765  ect(name=storage
-0001cac0: 5f6e 616d 652c 0a20 2020 2020 2020 2020  _name,.         
-0001cad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001caf0: 2020 2020 6d6f 6465 3d73 746f 7261 6765      mode=storage
-0001cb00: 5f6c 6962 2e53 746f 7261 6765 4d6f 6465  _lib.StorageMode
-0001cb10: 2e43 4f50 5929 0a0a 2020 2020 4070 7974  .COPY)..    @pyt
-0001cb20: 6573 742e 6669 7874 7572 650a 2020 2020  est.fixture.    
-0001cb30: 6465 6620 746d 705f 6769 7469 676e 6f72  def tmp_gitignor
-0001cb40: 655f 7374 6f72 6167 655f 6f62 6a28 7365  e_storage_obj(se
-0001cb50: 6c66 2c20 746d 705f 6275 636b 6574 5f6e  lf, tmp_bucket_n
-0001cb60: 616d 652c 2067 6974 6967 6e6f 7265 5f73  ame, gitignore_s
-0001cb70: 7472 7563 7475 7265 293a 0a20 2020 2020  tructure):.     
-0001cb80: 2020 2023 2043 7265 6174 6573 2061 2074     # Creates a t
-0001cb90: 656d 706f 7261 7279 2073 746f 7261 6765  emporary storage
-0001cba0: 206f 626a 6563 7420 666f 7220 7465 7374   object for test
-0001cbb0: 696e 6720 2e67 6974 6967 6e6f 7265 2066  ing .gitignore f
-0001cbc0: 696c 7465 722e 0a20 2020 2020 2020 2023  ilter..        #
-0001cbd0: 2047 4954 4947 494e 4f52 455f 5354 5255   GITIGINORE_STRU
-0001cbe0: 4354 5552 4520 6973 2072 6570 7265 7365  CTURE is represe
-0001cbf0: 6e74 696e 6720 6120 6669 6c65 2073 7472  nting a file str
-0001cc00: 7563 7475 7265 2069 6e20 6120 6469 6374  ucture in a dict
-0001cc10: 696f 6e61 7279 0a20 2020 2020 2020 2023  ionary.        #
-0001cc20: 2066 6f72 616d 742e 2043 7265 6174 6564   foramt. Created
-0001cc30: 2073 746f 7261 6765 206f 626a 6563 7420   storage object 
-0001cc40: 7769 6c6c 2063 6f6e 7461 696e 2074 6865  will contain the
-0001cc50: 2066 696c 6520 7374 7275 6374 7572 6520   file structure 
-0001cc60: 616c 6f6e 670a 2020 2020 2020 2020 2320  along.        # 
-0001cc70: 7769 7468 202e 6769 7469 676e 6f72 6520  with .gitignore 
-0001cc80: 616e 6420 2e67 6974 2f69 6e66 6f2f 6578  and .git/info/ex
-0001cc90: 636c 7564 6520 6669 6c65 7320 746f 2074  clude files to t
-0001cca0: 6573 7420 6578 636c 7564 6520 6669 6c74  est exclude filt
-0001ccb0: 6572 2e0a 2020 2020 2020 2020 2320 5374  er..        # St
-0001ccc0: 6f72 6573 206d 7573 7420 6265 2061 6464  ores must be add
-0001ccd0: 6564 2069 6e20 7468 6520 7465 7374 2e0a  ed in the test..
-0001cce0: 2020 2020 2020 2020 7769 7468 2074 656d          with tem
-0001ccf0: 7066 696c 652e 5465 6d70 6f72 6172 7944  pfile.TemporaryD
-0001cd00: 6972 6563 746f 7279 2829 2061 7320 746d  irectory() as tm
-0001cd10: 7064 6972 3a0a 2020 2020 2020 2020 2020  pdir:.          
-0001cd20: 2020 2320 4372 6561 7465 7320 6669 6c65    # Creates file
-0001cd30: 2073 7472 7563 7475 7265 2074 6f20 6265   structure to be
-0001cd40: 2075 706c 6f61 6465 6420 696e 2074 6865   uploaded in the
-0001cd50: 2053 746f 7261 6765 0a20 2020 2020 2020   Storage.       
-0001cd60: 2020 2020 2073 656c 662e 6372 6561 7465       self.create
-0001cd70: 5f64 6972 5f73 7472 7563 7475 7265 2874  _dir_structure(t
-0001cd80: 6d70 6469 722c 2067 6974 6967 6e6f 7265  mpdir, gitignore
-0001cd90: 5f73 7472 7563 7475 7265 290a 0a20 2020  _structure)..   
-0001cda0: 2020 2020 2020 2020 2023 2043 7265 6174           # Creat
-0001cdb0: 6520 2e67 6974 6967 6e6f 7265 2061 6e64  e .gitignore and
-0001cdc0: 206c 6973 7420 6669 6c65 732f 6469 7273   list files/dirs
-0001cdd0: 2074 6f20 6265 2065 7863 6c75 6465 6420   to be excluded 
-0001cde0: 696e 2069 740a 2020 2020 2020 2020 2020  in it.          
-0001cdf0: 2020 736b 7970 696c 6f74 5f70 6174 6820    skypilot_path 
-0001ce00: 3d20 6f73 2e70 6174 682e 6469 726e 616d  = os.path.dirnam
-0001ce10: 6528 6f73 2e70 6174 682e 6469 726e 616d  e(os.path.dirnam
-0001ce20: 6528 736b 792e 5f5f 6669 6c65 5f5f 2929  e(sky.__file__))
-0001ce30: 0a20 2020 2020 2020 2020 2020 2074 656d  .            tem
-0001ce40: 705f 7061 7468 203d 2066 277b 746d 7064  p_path = f'{tmpd
-0001ce50: 6972 7d2f 2e67 6974 6967 6e6f 7265 270a  ir}/.gitignore'.
-0001ce60: 2020 2020 2020 2020 2020 2020 6669 6c65              file
-0001ce70: 5f70 6174 6820 3d20 6f73 2e70 6174 682e  _path = os.path.
-0001ce80: 6a6f 696e 2873 6b79 7069 6c6f 745f 7061  join(skypilot_pa
-0001ce90: 7468 2c20 2774 6573 7473 2f67 6974 6967  th, 'tests/gitig
-0001cea0: 6e6f 7265 5f74 6573 7427 290a 2020 2020  nore_test').    
-0001ceb0: 2020 2020 2020 2020 7368 7574 696c 2e63          shutil.c
-0001cec0: 6f70 7966 696c 6528 6669 6c65 5f70 6174  opyfile(file_pat
-0001ced0: 682c 2074 656d 705f 7061 7468 290a 0a20  h, temp_path).. 
-0001cee0: 2020 2020 2020 2020 2020 2023 2043 7265             # Cre
-0001cef0: 6174 6520 2e67 6974 2f69 6e66 6f2f 6578  ate .git/info/ex
-0001cf00: 636c 7564 6520 616e 6420 6c69 7374 2066  clude and list f
-0001cf10: 696c 6573 2f64 6972 7320 746f 2062 6520  iles/dirs to be 
-0001cf20: 6578 636c 7564 6564 2069 6e20 6974 0a20  excluded in it. 
-0001cf30: 2020 2020 2020 2020 2020 2074 656d 705f             temp_
-0001cf40: 7061 7468 203d 2066 277b 746d 7064 6972  path = f'{tmpdir
-0001cf50: 7d2f 2e67 6974 2f69 6e66 6f2f 270a 2020  }/.git/info/'.  
-0001cf60: 2020 2020 2020 2020 2020 6f73 2e6d 616b            os.mak
-0001cf70: 6564 6972 7328 7465 6d70 5f70 6174 6829  edirs(temp_path)
-0001cf80: 0a20 2020 2020 2020 2020 2020 2074 656d  .            tem
-0001cf90: 705f 6578 636c 7564 655f 7061 7468 203d  p_exclude_path =
-0001cfa0: 206f 732e 7061 7468 2e6a 6f69 6e28 7465   os.path.join(te
-0001cfb0: 6d70 5f70 6174 682c 2027 6578 636c 7564  mp_path, 'exclud
-0001cfc0: 6527 290a 2020 2020 2020 2020 2020 2020  e').            
-0001cfd0: 6669 6c65 5f70 6174 6820 3d20 6f73 2e70  file_path = os.p
-0001cfe0: 6174 682e 6a6f 696e 2873 6b79 7069 6c6f  ath.join(skypilo
-0001cff0: 745f 7061 7468 2c0a 2020 2020 2020 2020  t_path,.        
-0001d000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d010: 2020 2020 2020 2020 2020 2020 2027 7465               'te
-0001d020: 7374 732f 6769 745f 696e 666f 5f65 7863  sts/git_info_exc
-0001d030: 6c75 6465 5f74 6573 7427 290a 2020 2020  lude_test').    
-0001d040: 2020 2020 2020 2020 7368 7574 696c 2e63          shutil.c
-0001d050: 6f70 7966 696c 6528 6669 6c65 5f70 6174  opyfile(file_pat
-0001d060: 682c 2074 656d 705f 6578 636c 7564 655f  h, temp_exclude_
-0001d070: 7061 7468 290a 0a20 2020 2020 2020 2020  path)..         
-0001d080: 2020 2023 2043 7265 6174 6520 736b 7920     # Create sky 
-0001d090: 5374 6f72 6167 6520 7769 7468 2074 6865  Storage with the
-0001d0a0: 2066 696c 6573 2063 7265 6174 6564 0a20   files created. 
-0001d0b0: 2020 2020 2020 2020 2020 2079 6965 6c64             yield
-0001d0c0: 2066 726f 6d20 7365 6c66 2e79 6965 6c64   from self.yield
-0001d0d0: 5f73 746f 7261 6765 5f6f 626a 6563 7428  _storage_object(
-0001d0e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001d0f0: 206e 616d 653d 746d 705f 6275 636b 6574   name=tmp_bucket
-0001d100: 5f6e 616d 652c 0a20 2020 2020 2020 2020  _name,.         
-0001d110: 2020 2020 2020 2073 6f75 7263 653d 746d         source=tm
-0001d120: 7064 6972 2c0a 2020 2020 2020 2020 2020  pdir,.          
-0001d130: 2020 2020 2020 6d6f 6465 3d73 746f 7261        mode=stora
-0001d140: 6765 5f6c 6962 2e53 746f 7261 6765 4d6f  ge_lib.StorageMo
-0001d150: 6465 2e43 4f50 5929 0a0a 2020 2020 4070  de.COPY)..    @p
-0001d160: 7974 6573 742e 6669 7874 7572 650a 2020  ytest.fixture.  
-0001d170: 2020 6465 6620 746d 705f 6177 7363 6c69    def tmp_awscli
-0001d180: 5f62 7563 6b65 7428 7365 6c66 2c20 746d  _bucket(self, tm
-0001d190: 705f 6275 636b 6574 5f6e 616d 6529 3a0a  p_bucket_name):.
-0001d1a0: 2020 2020 2020 2020 2320 4372 6561 7465          # Create
-0001d1b0: 7320 6120 7465 6d70 6f72 6172 7920 6275  s a temporary bu
-0001d1c0: 636b 6574 2075 7369 6e67 2061 7773 636c  cket using awscl
-0001d1d0: 690a 2020 2020 2020 2020 7375 6270 726f  i.        subpro
-0001d1e0: 6365 7373 2e63 6865 636b 5f63 616c 6c28  cess.check_call(
-0001d1f0: 5b27 6177 7327 2c20 2773 3327 2c20 276d  ['aws', 's3', 'm
-0001d200: 6227 2c20 6627 7333 3a2f 2f7b 746d 705f  b', f's3://{tmp_
-0001d210: 6275 636b 6574 5f6e 616d 657d 275d 290a  bucket_name}']).
-0001d220: 2020 2020 2020 2020 7969 656c 6420 746d          yield tm
-0001d230: 705f 6275 636b 6574 5f6e 616d 650a 2020  p_bucket_name.  
-0001d240: 2020 2020 2020 7375 6270 726f 6365 7373        subprocess
-0001d250: 2e63 6865 636b 5f63 616c 6c28 0a20 2020  .check_call(.   
-0001d260: 2020 2020 2020 2020 205b 2761 7773 272c           ['aws',
-0001d270: 2027 7333 272c 2027 7262 272c 2066 2773   's3', 'rb', f's
-0001d280: 333a 2f2f 7b74 6d70 5f62 7563 6b65 745f  3://{tmp_bucket_
-0001d290: 6e61 6d65 7d27 2c20 272d 2d66 6f72 6365  name}', '--force
-0001d2a0: 275d 290a 0a20 2020 2040 7079 7465 7374  '])..    @pytest
-0001d2b0: 2e66 6978 7475 7265 0a20 2020 2064 6566  .fixture.    def
-0001d2c0: 2074 6d70 5f67 7375 7469 6c5f 6275 636b   tmp_gsutil_buck
-0001d2d0: 6574 2873 656c 662c 2074 6d70 5f62 7563  et(self, tmp_buc
-0001d2e0: 6b65 745f 6e61 6d65 293a 0a20 2020 2020  ket_name):.     
-0001d2f0: 2020 2023 2043 7265 6174 6573 2061 2074     # Creates a t
-0001d300: 656d 706f 7261 7279 2062 7563 6b65 7420  emporary bucket 
-0001d310: 7573 696e 6720 6773 7574 696c 0a20 2020  using gsutil.   
-0001d320: 2020 2020 2073 7562 7072 6f63 6573 732e       subprocess.
-0001d330: 6368 6563 6b5f 6361 6c6c 285b 2767 7375  check_call(['gsu
-0001d340: 7469 6c27 2c20 276d 6227 2c20 6627 6773  til', 'mb', f'gs
-0001d350: 3a2f 2f7b 746d 705f 6275 636b 6574 5f6e  ://{tmp_bucket_n
-0001d360: 616d 657d 275d 290a 2020 2020 2020 2020  ame}']).        
-0001d370: 7969 656c 6420 746d 705f 6275 636b 6574  yield tmp_bucket
-0001d380: 5f6e 616d 650a 2020 2020 2020 2020 7375  _name.        su
-0001d390: 6270 726f 6365 7373 2e63 6865 636b 5f63  bprocess.check_c
-0001d3a0: 616c 6c28 5b27 6773 7574 696c 272c 2027  all(['gsutil', '
-0001d3b0: 726d 272c 2027 2d72 272c 2066 2767 733a  rm', '-r', f'gs:
-0001d3c0: 2f2f 7b74 6d70 5f62 7563 6b65 745f 6e61  //{tmp_bucket_na
-0001d3d0: 6d65 7d27 5d29 0a0a 2020 2020 4070 7974  me}'])..    @pyt
-0001d3e0: 6573 742e 6669 7874 7572 650a 2020 2020  est.fixture.    
-0001d3f0: 6465 6620 746d 705f 6177 7363 6c69 5f62  def tmp_awscli_b
-0001d400: 7563 6b65 745f 7232 2873 656c 662c 2074  ucket_r2(self, t
-0001d410: 6d70 5f62 7563 6b65 745f 6e61 6d65 293a  mp_bucket_name):
-0001d420: 0a20 2020 2020 2020 2023 2043 7265 6174  .        # Creat
-0001d430: 6573 2061 2074 656d 706f 7261 7279 2062  es a temporary b
-0001d440: 7563 6b65 7420 7573 696e 6720 6177 7363  ucket using awsc
-0001d450: 6c69 0a20 2020 2020 2020 2065 6e64 706f  li.        endpo
-0001d460: 696e 745f 7572 6c20 3d20 636c 6f75 6466  int_url = cloudf
-0001d470: 6c61 7265 2e63 7265 6174 655f 656e 6470  lare.create_endp
-0001d480: 6f69 6e74 2829 0a20 2020 2020 2020 2073  oint().        s
-0001d490: 7562 7072 6f63 6573 732e 6368 6563 6b5f  ubprocess.check_
-0001d4a0: 6361 6c6c 280a 2020 2020 2020 2020 2020  call(.          
-0001d4b0: 2020 6627 4157 535f 5348 4152 4544 5f43    f'AWS_SHARED_C
-0001d4c0: 5245 4445 4e54 4941 4c53 5f46 494c 453d  REDENTIALS_FILE=
-0001d4d0: 7b63 6c6f 7564 666c 6172 652e 5232 5f43  {cloudflare.R2_C
-0001d4e0: 5245 4445 4e54 4941 4c53 5f50 4154 487d  REDENTIALS_PATH}
-0001d4f0: 2061 7773 2073 3320 6d62 2073 333a 2f2f   aws s3 mb s3://
-0001d500: 7b74 6d70 5f62 7563 6b65 745f 6e61 6d65  {tmp_bucket_name
-0001d510: 7d20 2d2d 656e 6470 6f69 6e74 207b 656e  } --endpoint {en
-0001d520: 6470 6f69 6e74 5f75 726c 7d20 2d2d 7072  dpoint_url} --pr
-0001d530: 6f66 696c 653d 7232 272c 0a20 2020 2020  ofile=r2',.     
-0001d540: 2020 2020 2020 2073 6865 6c6c 3d54 7275         shell=Tru
-0001d550: 6529 0a20 2020 2020 2020 2079 6965 6c64  e).        yield
-0001d560: 2074 6d70 5f62 7563 6b65 745f 6e61 6d65   tmp_bucket_name
-0001d570: 0a20 2020 2020 2020 2073 7562 7072 6f63  .        subproc
-0001d580: 6573 732e 6368 6563 6b5f 6361 6c6c 280a  ess.check_call(.
-0001d590: 2020 2020 2020 2020 2020 2020 6627 4157              f'AW
-0001d5a0: 535f 5348 4152 4544 5f43 5245 4445 4e54  S_SHARED_CREDENT
-0001d5b0: 4941 4c53 5f46 494c 453d 7b63 6c6f 7564  IALS_FILE={cloud
-0001d5c0: 666c 6172 652e 5232 5f43 5245 4445 4e54  flare.R2_CREDENT
-0001d5d0: 4941 4c53 5f50 4154 487d 2061 7773 2073  IALS_PATH} aws s
-0001d5e0: 3320 7262 2073 333a 2f2f 7b74 6d70 5f62  3 rb s3://{tmp_b
-0001d5f0: 7563 6b65 745f 6e61 6d65 7d20 2d2d 666f  ucket_name} --fo
-0001d600: 7263 6520 2d2d 656e 6470 6f69 6e74 207b  rce --endpoint {
-0001d610: 656e 6470 6f69 6e74 5f75 726c 7d20 2d2d  endpoint_url} --
-0001d620: 7072 6f66 696c 653d 7232 272c 0a20 2020  profile=r2',.   
-0001d630: 2020 2020 2020 2020 2073 6865 6c6c 3d54           shell=T
-0001d640: 7275 6529 0a0a 2020 2020 4070 7974 6573  rue)..    @pytes
-0001d650: 742e 6669 7874 7572 650a 2020 2020 6465  t.fixture.    de
-0001d660: 6620 746d 705f 6962 6d5f 636f 735f 6275  f tmp_ibm_cos_bu
-0001d670: 636b 6574 2873 656c 662c 2074 6d70 5f62  cket(self, tmp_b
-0001d680: 7563 6b65 745f 6e61 6d65 293a 0a20 2020  ucket_name):.   
-0001d690: 2020 2020 2023 2043 7265 6174 6573 2061       # Creates a
-0001d6a0: 2074 656d 706f 7261 7279 2062 7563 6b65   temporary bucke
-0001d6b0: 7420 7573 696e 6720 4942 4d20 434f 5320  t using IBM COS 
-0001d6c0: 4150 490a 2020 2020 2020 2020 7374 6f72  API.        stor
-0001d6d0: 6167 655f 6f62 6a20 3d20 7374 6f72 6167  age_obj = storag
-0001d6e0: 655f 6c69 622e 4942 4d43 6f73 5374 6f72  e_lib.IBMCosStor
-0001d6f0: 6528 736f 7572 6365 3d22 222c 206e 616d  e(source="", nam
-0001d700: 653d 746d 705f 6275 636b 6574 5f6e 616d  e=tmp_bucket_nam
-0001d710: 6529 0a20 2020 2020 2020 2079 6965 6c64  e).        yield
-0001d720: 2074 6d70 5f62 7563 6b65 745f 6e61 6d65   tmp_bucket_name
-0001d730: 0a20 2020 2020 2020 2073 746f 7261 6765  .        storage
-0001d740: 5f6f 626a 2e64 656c 6574 6528 290a 0a20  _obj.delete().. 
-0001d750: 2020 2040 7079 7465 7374 2e66 6978 7475     @pytest.fixtu
-0001d760: 7265 0a20 2020 2064 6566 2074 6d70 5f70  re.    def tmp_p
-0001d770: 7562 6c69 635f 7374 6f72 6167 655f 6f62  ublic_storage_ob
-0001d780: 6a28 7365 6c66 2c20 7265 7175 6573 7429  j(self, request)
-0001d790: 3a0a 2020 2020 2020 2020 2320 496e 6974  :.        # Init
-0001d7a0: 6961 6c69 7a65 7320 6120 7374 6f72 6167  ializes a storag
-0001d7b0: 6520 6f62 6a65 6374 2077 6974 6820 6120  e object with a 
-0001d7c0: 7075 626c 6963 2062 7563 6b65 740a 2020  public bucket.  
-0001d7d0: 2020 2020 2020 7374 6f72 6167 655f 6f62        storage_ob
-0001d7e0: 6a20 3d20 7374 6f72 6167 655f 6c69 622e  j = storage_lib.
-0001d7f0: 5374 6f72 6167 6528 736f 7572 6365 3d72  Storage(source=r
-0001d800: 6571 7565 7374 2e70 6172 616d 290a 2020  equest.param).  
-0001d810: 2020 2020 2020 7969 656c 6420 7374 6f72        yield stor
-0001d820: 6167 655f 6f62 6a0a 2020 2020 2020 2020  age_obj.        
-0001d830: 2320 5468 6973 2064 6f65 7320 6e6f 7420  # This does not 
-0001d840: 7265 7175 6972 6520 616e 7920 6465 6c65  require any dele
-0001d850: 7469 6f6e 206c 6f67 6963 2062 6563 6175  tion logic becau
-0001d860: 7365 2069 7420 6973 2061 2070 7562 6c69  se it is a publi
-0001d870: 6320 6275 636b 6574 0a20 2020 2020 2020  c bucket.       
-0001d880: 2023 2061 6e64 2073 686f 756c 6420 6e6f   # and should no
-0001d890: 7420 6765 7420 6164 6465 6420 746f 2067  t get added to g
-0001d8a0: 6c6f 6261 6c5f 7573 6572 5f73 7461 7465  lobal_user_state
-0001d8b0: 2e0a 0a20 2020 2040 7079 7465 7374 2e6d  ...    @pytest.m
-0001d8c0: 6172 6b2e 7061 7261 6d65 7472 697a 6528  ark.parametrize(
-0001d8d0: 2773 746f 7265 5f74 7970 6527 2c20 5b0a  'store_type', [.
-0001d8e0: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
-0001d8f0: 6c69 622e 5374 6f72 6554 7970 652e 5333  lib.StoreType.S3
-0001d900: 2c20 7374 6f72 6167 655f 6c69 622e 5374  , storage_lib.St
-0001d910: 6f72 6554 7970 652e 4743 532c 0a20 2020  oreType.GCS,.   
-0001d920: 2020 2020 2070 7974 6573 742e 7061 7261       pytest.para
-0001d930: 6d28 7374 6f72 6167 655f 6c69 622e 5374  m(storage_lib.St
-0001d940: 6f72 6554 7970 652e 4942 4d2c 206d 6172  oreType.IBM, mar
-0001d950: 6b73 3d70 7974 6573 742e 6d61 726b 2e69  ks=pytest.mark.i
-0001d960: 626d 292c 0a20 2020 2020 2020 2070 7974  bm),.        pyt
-0001d970: 6573 742e 7061 7261 6d28 7374 6f72 6167  est.param(storag
-0001d980: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
-0001d990: 5232 2c20 6d61 726b 733d 7079 7465 7374  R2, marks=pytest
-0001d9a0: 2e6d 6172 6b2e 636c 6f75 6466 6c61 7265  .mark.cloudflare
-0001d9b0: 290a 2020 2020 5d29 0a20 2020 2064 6566  ).    ]).    def
-0001d9c0: 2074 6573 745f 6e65 775f 6275 636b 6574   test_new_bucket
-0001d9d0: 5f63 7265 6174 696f 6e5f 616e 645f 6465  _creation_and_de
-0001d9e0: 6c65 7469 6f6e 2873 656c 662c 2074 6d70  letion(self, tmp
-0001d9f0: 5f6c 6f63 616c 5f73 746f 7261 6765 5f6f  _local_storage_o
-0001da00: 626a 2c0a 2020 2020 2020 2020 2020 2020  bj,.            
-0001da10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001da20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001da30: 2020 7374 6f72 655f 7479 7065 293a 0a20    store_type):. 
-0001da40: 2020 2020 2020 2023 2043 7265 6174 6573         # Creates
-0001da50: 2061 206e 6577 2062 7563 6b65 7420 7769   a new bucket wi
-0001da60: 7468 2061 206c 6f63 616c 2073 6f75 7263  th a local sourc
-0001da70: 652c 2075 706c 6f61 6473 2066 696c 6573  e, uploads files
-0001da80: 2074 6f20 6974 0a20 2020 2020 2020 2023   to it.        #
-0001da90: 2061 6e64 2064 656c 6574 6573 2069 742e   and deletes it.
-0001daa0: 0a20 2020 2020 2020 2074 6d70 5f6c 6f63  .        tmp_loc
-0001dab0: 616c 5f73 746f 7261 6765 5f6f 626a 2e61  al_storage_obj.a
-0001dac0: 6464 5f73 746f 7265 2873 746f 7265 5f74  dd_store(store_t
-0001dad0: 7970 6529 0a0a 2020 2020 2020 2020 2320  ype)..        # 
-0001dae0: 5275 6e20 736b 7920 7374 6f72 6167 6520  Run sky storage 
-0001daf0: 6c73 2074 6f20 6368 6563 6b20 6966 2073  ls to check if s
-0001db00: 746f 7261 6765 206f 626a 6563 7420 6578  torage object ex
-0001db10: 6973 7473 2069 6e20 7468 6520 6f75 7470  ists in the outp
-0001db20: 7574 0a20 2020 2020 2020 206f 7574 203d  ut.        out =
-0001db30: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
-0001db40: 6b5f 6f75 7470 7574 285b 2773 6b79 272c  k_output(['sky',
-0001db50: 2027 7374 6f72 6167 6527 2c20 276c 7327   'storage', 'ls'
-0001db60: 5d29 0a20 2020 2020 2020 2061 7373 6572  ]).        asser
-0001db70: 7420 746d 705f 6c6f 6361 6c5f 7374 6f72  t tmp_local_stor
-0001db80: 6167 655f 6f62 6a2e 6e61 6d65 2069 6e20  age_obj.name in 
-0001db90: 6f75 742e 6465 636f 6465 2827 7574 662d  out.decode('utf-
-0001dba0: 3827 290a 0a20 2020 2020 2020 2023 2052  8')..        # R
-0001dbb0: 756e 2073 6b79 2073 746f 7261 6765 2064  un sky storage d
-0001dbc0: 656c 6574 6520 746f 2064 656c 6574 6520  elete to delete 
-0001dbd0: 7468 6520 7374 6f72 6167 6520 6f62 6a65  the storage obje
-0001dbe0: 6374 0a20 2020 2020 2020 2073 7562 7072  ct.        subpr
-0001dbf0: 6f63 6573 732e 6368 6563 6b5f 6f75 7470  ocess.check_outp
-0001dc00: 7574 280a 2020 2020 2020 2020 2020 2020  ut(.            
-0001dc10: 5b27 736b 7927 2c20 2773 746f 7261 6765  ['sky', 'storage
-0001dc20: 272c 2027 6465 6c65 7465 272c 2074 6d70  ', 'delete', tmp
-0001dc30: 5f6c 6f63 616c 5f73 746f 7261 6765 5f6f  _local_storage_o
-0001dc40: 626a 2e6e 616d 655d 290a 0a20 2020 2020  bj.name])..     
-0001dc50: 2020 2023 2052 756e 2073 6b79 2073 746f     # Run sky sto
-0001dc60: 7261 6765 206c 7320 746f 2063 6865 636b  rage ls to check
-0001dc70: 2069 6620 7374 6f72 6167 6520 6f62 6a65   if storage obje
-0001dc80: 6374 2069 7320 6465 6c65 7465 640a 2020  ct is deleted.  
-0001dc90: 2020 2020 2020 6f75 7420 3d20 7375 6270        out = subp
-0001dca0: 726f 6365 7373 2e63 6865 636b 5f6f 7574  rocess.check_out
-0001dcb0: 7075 7428 5b27 736b 7927 2c20 2773 746f  put(['sky', 'sto
-0001dcc0: 7261 6765 272c 2027 6c73 275d 290a 2020  rage', 'ls']).  
-0001dcd0: 2020 2020 2020 6173 7365 7274 2074 6d70        assert tmp
-0001dce0: 5f6c 6f63 616c 5f73 746f 7261 6765 5f6f  _local_storage_o
-0001dcf0: 626a 2e6e 616d 6520 6e6f 7420 696e 206f  bj.name not in o
-0001dd00: 7574 2e64 6563 6f64 6528 2775 7466 2d38  ut.decode('utf-8
-0001dd10: 2729 0a0a 2020 2020 4070 7974 6573 742e  ')..    @pytest.
-0001dd20: 6d61 726b 2e78 6469 7374 5f67 726f 7570  mark.xdist_group
-0001dd30: 2827 6d75 6c74 6970 6c65 5f62 7563 6b65  ('multiple_bucke
-0001dd40: 745f 6465 6c65 7469 6f6e 2729 0a20 2020  t_deletion').   
-0001dd50: 2040 7079 7465 7374 2e6d 6172 6b2e 7061   @pytest.mark.pa
-0001dd60: 7261 6d65 7472 697a 6528 2773 746f 7265  rametrize('store
-0001dd70: 5f74 7970 6527 2c20 5b0a 2020 2020 2020  _type', [.      
-0001dd80: 2020 7374 6f72 6167 655f 6c69 622e 5374    storage_lib.St
-0001dd90: 6f72 6554 7970 652e 5333 2c20 7374 6f72  oreType.S3, stor
-0001dda0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-0001ddb0: 652e 4743 532c 0a20 2020 2020 2020 2070  e.GCS,.        p
-0001ddc0: 7974 6573 742e 7061 7261 6d28 7374 6f72  ytest.param(stor
-0001ddd0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-0001dde0: 652e 5232 2c20 6d61 726b 733d 7079 7465  e.R2, marks=pyte
-0001ddf0: 7374 2e6d 6172 6b2e 636c 6f75 6466 6c61  st.mark.cloudfla
-0001de00: 7265 292c 0a20 2020 2020 2020 2070 7974  re),.        pyt
-0001de10: 6573 742e 7061 7261 6d28 7374 6f72 6167  est.param(storag
-0001de20: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
-0001de30: 4942 4d2c 206d 6172 6b73 3d70 7974 6573  IBM, marks=pytes
-0001de40: 742e 6d61 726b 2e69 626d 290a 2020 2020  t.mark.ibm).    
-0001de50: 5d29 0a20 2020 2064 6566 2074 6573 745f  ]).    def test_
-0001de60: 6d75 6c74 6970 6c65 5f62 7563 6b65 7473  multiple_buckets
-0001de70: 5f63 7265 6174 696f 6e5f 616e 645f 6465  _creation_and_de
-0001de80: 6c65 7469 6f6e 280a 2020 2020 2020 2020  letion(.        
-0001de90: 2020 2020 7365 6c66 2c20 746d 705f 6d75      self, tmp_mu
-0001dea0: 6c74 6970 6c65 5f73 6372 6174 6368 5f73  ltiple_scratch_s
-0001deb0: 746f 7261 6765 5f6f 626a 2c20 7374 6f72  torage_obj, stor
-0001dec0: 655f 7479 7065 293a 0a20 2020 2020 2020  e_type):.       
-0001ded0: 2023 2043 7265 6174 6573 206d 756c 7469   # Creates multi
-0001dee0: 706c 6520 6e65 7720 6275 636b 6574 7328  ple new buckets(
-0001def0: 3520 6275 636b 6574 7329 2077 6974 6820  5 buckets) with 
-0001df00: 6120 6c6f 6361 6c20 736f 7572 6365 0a20  a local source. 
-0001df10: 2020 2020 2020 2023 2061 6e64 2064 656c         # and del
-0001df20: 6574 6573 2074 6865 6d2e 0a20 2020 2020  etes them..     
-0001df30: 2020 2073 746f 7261 6765 5f6f 626a 5f6e     storage_obj_n
-0001df40: 616d 6520 3d20 5b5d 0a20 2020 2020 2020  ame = [].       
-0001df50: 2066 6f72 2073 746f 7265 5f6f 626a 2069   for store_obj i
-0001df60: 6e20 746d 705f 6d75 6c74 6970 6c65 5f73  n tmp_multiple_s
-0001df70: 6372 6174 6368 5f73 746f 7261 6765 5f6f  cratch_storage_o
-0001df80: 626a 3a0a 2020 2020 2020 2020 2020 2020  bj:.            
-0001df90: 7374 6f72 655f 6f62 6a2e 6164 645f 7374  store_obj.add_st
-0001dfa0: 6f72 6528 7374 6f72 655f 7479 7065 290a  ore(store_type).
-0001dfb0: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
-0001dfc0: 6167 655f 6f62 6a5f 6e61 6d65 2e61 7070  age_obj_name.app
-0001dfd0: 656e 6428 7374 6f72 655f 6f62 6a2e 6e61  end(store_obj.na
-0001dfe0: 6d65 290a 0a20 2020 2020 2020 2023 2052  me)..        # R
-0001dff0: 756e 2073 6b79 2073 746f 7261 6765 206c  un sky storage l
-0001e000: 7320 746f 2063 6865 636b 2069 6620 616c  s to check if al
-0001e010: 6c20 7374 6f72 6167 6520 6f62 6a65 6374  l storage object
-0001e020: 7320 6578 6973 7473 2069 6e20 7468 650a  s exists in the.
-0001e030: 2020 2020 2020 2020 2320 6f75 7470 7574          # output
-0001e040: 2066 696c 7465 7265 6420 6279 2073 746f   filtered by sto
-0001e050: 7265 2074 7970 650a 2020 2020 2020 2020  re type.        
-0001e060: 6f75 745f 616c 6c20 3d20 7375 6270 726f  out_all = subpro
-0001e070: 6365 7373 2e63 6865 636b 5f6f 7574 7075  cess.check_outpu
-0001e080: 7428 5b27 736b 7927 2c20 2773 746f 7261  t(['sky', 'stora
-0001e090: 6765 272c 2027 6c73 275d 290a 2020 2020  ge', 'ls']).    
-0001e0a0: 2020 2020 6f75 7420 3d20 5b0a 2020 2020      out = [.    
-0001e0b0: 2020 2020 2020 2020 6974 656d 2e73 706c          item.spl
-0001e0c0: 6974 2829 5b30 5d0a 2020 2020 2020 2020  it()[0].        
-0001e0d0: 2020 2020 666f 7220 6974 656d 2069 6e20      for item in 
-0001e0e0: 6f75 745f 616c 6c2e 6465 636f 6465 2827  out_all.decode('
-0001e0f0: 7574 662d 3827 292e 7370 6c69 746c 696e  utf-8').splitlin
-0001e100: 6573 2829 0a20 2020 2020 2020 2020 2020  es().           
-0001e110: 2069 6620 7374 6f72 655f 7479 7065 2e76   if store_type.v
-0001e120: 616c 7565 2069 6e20 6974 656d 0a20 2020  alue in item.   
-0001e130: 2020 2020 205d 0a20 2020 2020 2020 2061       ].        a
-0001e140: 7373 6572 7420 616c 6c28 5b69 7465 6d20  ssert all([item 
-0001e150: 696e 206f 7574 2066 6f72 2069 7465 6d20  in out for item 
-0001e160: 696e 2073 746f 7261 6765 5f6f 626a 5f6e  in storage_obj_n
-0001e170: 616d 655d 290a 0a20 2020 2020 2020 2023  ame])..        #
-0001e180: 2052 756e 2073 6b79 2073 746f 7261 6765   Run sky storage
-0001e190: 2064 656c 6574 6520 616c 6c20 746f 2064   delete all to d
-0001e1a0: 656c 6574 6520 616c 6c20 7374 6f72 6167  elete all storag
-0001e1b0: 6520 6f62 6a65 6374 730a 2020 2020 2020  e objects.      
-0001e1c0: 2020 6465 6c65 7465 5f63 6d64 203d 205b    delete_cmd = [
-0001e1d0: 2773 6b79 272c 2027 7374 6f72 6167 6527  'sky', 'storage'
-0001e1e0: 2c20 2764 656c 6574 6527 5d0a 2020 2020  , 'delete'].    
-0001e1f0: 2020 2020 6465 6c65 7465 5f63 6d64 202b      delete_cmd +
-0001e200: 3d20 7374 6f72 6167 655f 6f62 6a5f 6e61  = storage_obj_na
-0001e210: 6d65 0a20 2020 2020 2020 2073 7562 7072  me.        subpr
-0001e220: 6f63 6573 732e 6368 6563 6b5f 6f75 7470  ocess.check_outp
-0001e230: 7574 2864 656c 6574 655f 636d 6429 0a0a  ut(delete_cmd)..
-0001e240: 2020 2020 2020 2020 2320 5275 6e20 736b          # Run sk
-0001e250: 7920 7374 6f72 6167 6520 6c73 2074 6f20  y storage ls to 
-0001e260: 6368 6563 6b20 6966 2061 6c6c 2073 746f  check if all sto
-0001e270: 7261 6765 206f 626a 6563 7473 2066 696c  rage objects fil
-0001e280: 7465 7265 6420 6279 2073 746f 7265 0a20  tered by store. 
-0001e290: 2020 2020 2020 2023 2074 7970 6520 6172         # type ar
-0001e2a0: 6520 6465 6c65 7465 640a 2020 2020 2020  e deleted.      
-0001e2b0: 2020 6f75 745f 616c 6c20 3d20 7375 6270    out_all = subp
-0001e2c0: 726f 6365 7373 2e63 6865 636b 5f6f 7574  rocess.check_out
-0001e2d0: 7075 7428 5b27 736b 7927 2c20 2773 746f  put(['sky', 'sto
-0001e2e0: 7261 6765 272c 2027 6c73 275d 290a 2020  rage', 'ls']).  
-0001e2f0: 2020 2020 2020 6f75 7420 3d20 5b0a 2020        out = [.  
-0001e300: 2020 2020 2020 2020 2020 6974 656d 2e73            item.s
-0001e310: 706c 6974 2829 5b30 5d0a 2020 2020 2020  plit()[0].      
-0001e320: 2020 2020 2020 666f 7220 6974 656d 2069        for item i
-0001e330: 6e20 6f75 745f 616c 6c2e 6465 636f 6465  n out_all.decode
-0001e340: 2827 7574 662d 3827 292e 7370 6c69 746c  ('utf-8').splitl
-0001e350: 696e 6573 2829 0a20 2020 2020 2020 2020  ines().         
-0001e360: 2020 2069 6620 7374 6f72 655f 7479 7065     if store_type
-0001e370: 2e76 616c 7565 2069 6e20 6974 656d 0a20  .value in item. 
-0001e380: 2020 2020 2020 205d 0a20 2020 2020 2020         ].       
-0001e390: 2061 7373 6572 7420 616c 6c28 5b69 7465   assert all([ite
-0001e3a0: 6d20 6e6f 7420 696e 206f 7574 2066 6f72  m not in out for
-0001e3b0: 2069 7465 6d20 696e 2073 746f 7261 6765   item in storage
-0001e3c0: 5f6f 626a 5f6e 616d 655d 290a 0a20 2020  _obj_name])..   
-0001e3d0: 2040 7079 7465 7374 2e6d 6172 6b2e 7061   @pytest.mark.pa
-0001e3e0: 7261 6d65 7472 697a 6528 2773 746f 7265  rametrize('store
-0001e3f0: 5f74 7970 6527 2c20 5b0a 2020 2020 2020  _type', [.      
-0001e400: 2020 7374 6f72 6167 655f 6c69 622e 5374    storage_lib.St
-0001e410: 6f72 6554 7970 652e 5333 2c20 7374 6f72  oreType.S3, stor
-0001e420: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-0001e430: 652e 4743 532c 0a20 2020 2020 2020 2070  e.GCS,.        p
-0001e440: 7974 6573 742e 7061 7261 6d28 7374 6f72  ytest.param(stor
-0001e450: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-0001e460: 652e 4942 4d2c 206d 6172 6b73 3d70 7974  e.IBM, marks=pyt
-0001e470: 6573 742e 6d61 726b 2e69 626d 292c 0a20  est.mark.ibm),. 
-0001e480: 2020 2020 2020 2070 7974 6573 742e 7061         pytest.pa
-0001e490: 7261 6d28 7374 6f72 6167 655f 6c69 622e  ram(storage_lib.
-0001e4a0: 5374 6f72 6554 7970 652e 5232 2c20 6d61  StoreType.R2, ma
-0001e4b0: 726b 733d 7079 7465 7374 2e6d 6172 6b2e  rks=pytest.mark.
-0001e4c0: 636c 6f75 6466 6c61 7265 290a 2020 2020  cloudflare).    
-0001e4d0: 5d29 0a20 2020 2064 6566 2074 6573 745f  ]).    def test_
-0001e4e0: 6275 636b 6574 5f65 7874 6572 6e61 6c5f  bucket_external_
-0001e4f0: 6465 6c65 7469 6f6e 2873 656c 662c 2074  deletion(self, t
-0001e500: 6d70 5f73 6372 6174 6368 5f73 746f 7261  mp_scratch_stora
-0001e510: 6765 5f6f 626a 2c0a 2020 2020 2020 2020  ge_obj,.        
-0001e520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e530: 2020 2020 2020 2020 2020 2020 2020 7374                st
-0001e540: 6f72 655f 7479 7065 293a 0a20 2020 2020  ore_type):.     
-0001e550: 2020 2023 2043 7265 6174 6573 2061 2062     # Creates a b
-0001e560: 7563 6b65 742c 2064 656c 6574 6573 2069  ucket, deletes i
-0001e570: 7420 6578 7465 726e 616c 6c79 2075 7369  t externally usi
-0001e580: 6e67 2063 6c6f 7564 2063 6c69 2063 6f6d  ng cloud cli com
-0001e590: 6d61 6e64 730a 2020 2020 2020 2020 2320  mands.        # 
-0001e5a0: 616e 6420 7468 656e 2074 7269 6573 2074  and then tries t
-0001e5b0: 6f20 6465 6c65 7465 2069 7420 7573 696e  o delete it usin
-0001e5c0: 6720 736b 7920 7374 6f72 6167 6520 6465  g sky storage de
-0001e5d0: 6c65 7465 2e0a 2020 2020 2020 2020 746d  lete..        tm
-0001e5e0: 705f 7363 7261 7463 685f 7374 6f72 6167  p_scratch_storag
-0001e5f0: 655f 6f62 6a2e 6164 645f 7374 6f72 6528  e_obj.add_store(
-0001e600: 7374 6f72 655f 7479 7065 290a 0a20 2020  store_type)..   
-0001e610: 2020 2020 2023 2052 756e 2073 6b79 2073       # Run sky s
-0001e620: 746f 7261 6765 206c 7320 746f 2063 6865  torage ls to che
-0001e630: 636b 2069 6620 7374 6f72 6167 6520 6f62  ck if storage ob
-0001e640: 6a65 6374 2065 7869 7374 7320 696e 2074  ject exists in t
-0001e650: 6865 206f 7574 7075 740a 2020 2020 2020  he output.      
-0001e660: 2020 6f75 7420 3d20 7375 6270 726f 6365    out = subproce
-0001e670: 7373 2e63 6865 636b 5f6f 7574 7075 7428  ss.check_output(
-0001e680: 5b27 736b 7927 2c20 2773 746f 7261 6765  ['sky', 'storage
-0001e690: 272c 2027 6c73 275d 290a 2020 2020 2020  ', 'ls']).      
-0001e6a0: 2020 6173 7365 7274 2074 6d70 5f73 6372    assert tmp_scr
-0001e6b0: 6174 6368 5f73 746f 7261 6765 5f6f 626a  atch_storage_obj
-0001e6c0: 2e6e 616d 6520 696e 206f 7574 2e64 6563  .name in out.dec
-0001e6d0: 6f64 6528 2775 7466 2d38 2729 0a0a 2020  ode('utf-8')..  
-0001e6e0: 2020 2020 2020 2320 4465 6c65 7465 2062        # Delete b
-0001e6f0: 7563 6b65 7420 6578 7465 726e 616c 6c79  ucket externally
-0001e700: 0a20 2020 2020 2020 2063 6d64 203d 2073  .        cmd = s
-0001e710: 656c 662e 636c 695f 6465 6c65 7465 5f63  elf.cli_delete_c
-0001e720: 6d64 2873 746f 7265 5f74 7970 652c 2074  md(store_type, t
-0001e730: 6d70 5f73 6372 6174 6368 5f73 746f 7261  mp_scratch_stora
-0001e740: 6765 5f6f 626a 2e6e 616d 6529 0a20 2020  ge_obj.name).   
-0001e750: 2020 2020 2073 7562 7072 6f63 6573 732e       subprocess.
-0001e760: 6368 6563 6b5f 6f75 7470 7574 2863 6d64  check_output(cmd
-0001e770: 2c20 7368 656c 6c3d 5472 7565 290a 0a20  , shell=True).. 
-0001e780: 2020 2020 2020 2023 2052 756e 2073 6b79         # Run sky
-0001e790: 2073 746f 7261 6765 2064 656c 6574 6520   storage delete 
-0001e7a0: 746f 2064 656c 6574 6520 7468 6520 7374  to delete the st
-0001e7b0: 6f72 6167 6520 6f62 6a65 6374 0a20 2020  orage object.   
-0001e7c0: 2020 2020 206f 7574 203d 2073 7562 7072       out = subpr
-0001e7d0: 6f63 6573 732e 6368 6563 6b5f 6f75 7470  ocess.check_outp
-0001e7e0: 7574 280a 2020 2020 2020 2020 2020 2020  ut(.            
-0001e7f0: 5b27 736b 7927 2c20 2773 746f 7261 6765  ['sky', 'storage
-0001e800: 272c 2027 6465 6c65 7465 272c 2074 6d70  ', 'delete', tmp
-0001e810: 5f73 6372 6174 6368 5f73 746f 7261 6765  _scratch_storage
-0001e820: 5f6f 626a 2e6e 616d 655d 290a 2020 2020  _obj.name]).    
-0001e830: 2020 2020 2320 4d61 6b65 2073 7572 6520      # Make sure 
-0001e840: 6275 636b 6574 2077 6173 206e 6f74 2063  bucket was not c
-0001e850: 7265 6174 6564 2064 7572 696e 6720 6465  reated during de
-0001e860: 6c65 7469 6f6e 2028 7365 6520 6973 7375  letion (see issu
-0001e870: 6520 2331 3332 3229 0a20 2020 2020 2020  e #1322).       
-0001e880: 2061 7373 6572 7420 2763 7265 6174 6564   assert 'created
-0001e890: 2720 6e6f 7420 696e 206f 7574 2e64 6563  ' not in out.dec
-0001e8a0: 6f64 6528 2775 7466 2d38 2729 2e6c 6f77  ode('utf-8').low
-0001e8b0: 6572 2829 0a0a 2020 2020 2020 2020 2320  er()..        # 
-0001e8c0: 5275 6e20 736b 7920 7374 6f72 6167 6520  Run sky storage 
-0001e8d0: 6c73 2074 6f20 6368 6563 6b20 6966 2073  ls to check if s
-0001e8e0: 746f 7261 6765 206f 626a 6563 7420 6973  torage object is
-0001e8f0: 2064 656c 6574 6564 0a20 2020 2020 2020   deleted.       
-0001e900: 206f 7574 203d 2073 7562 7072 6f63 6573   out = subproces
-0001e910: 732e 6368 6563 6b5f 6f75 7470 7574 285b  s.check_output([
-0001e920: 2773 6b79 272c 2027 7374 6f72 6167 6527  'sky', 'storage'
-0001e930: 2c20 276c 7327 5d29 0a20 2020 2020 2020  , 'ls']).       
-0001e940: 2061 7373 6572 7420 746d 705f 7363 7261   assert tmp_scra
-0001e950: 7463 685f 7374 6f72 6167 655f 6f62 6a2e  tch_storage_obj.
-0001e960: 6e61 6d65 206e 6f74 2069 6e20 6f75 742e  name not in out.
-0001e970: 6465 636f 6465 2827 7574 662d 3827 290a  decode('utf-8').
-0001e980: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
-0001e990: 6b2e 7061 7261 6d65 7472 697a 6528 2773  k.parametrize('s
-0001e9a0: 746f 7265 5f74 7970 6527 2c20 5b0a 2020  tore_type', [.  
-0001e9b0: 2020 2020 2020 7374 6f72 6167 655f 6c69        storage_li
-0001e9c0: 622e 5374 6f72 6554 7970 652e 5333 2c20  b.StoreType.S3, 
-0001e9d0: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
-0001e9e0: 6554 7970 652e 4743 532c 0a20 2020 2020  eType.GCS,.     
-0001e9f0: 2020 2070 7974 6573 742e 7061 7261 6d28     pytest.param(
-0001ea00: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
-0001ea10: 6554 7970 652e 4942 4d2c 206d 6172 6b73  eType.IBM, marks
-0001ea20: 3d70 7974 6573 742e 6d61 726b 2e69 626d  =pytest.mark.ibm
-0001ea30: 292c 0a20 2020 2020 2020 2070 7974 6573  ),.        pytes
-0001ea40: 742e 7061 7261 6d28 7374 6f72 6167 655f  t.param(storage_
-0001ea50: 6c69 622e 5374 6f72 6554 7970 652e 5232  lib.StoreType.R2
-0001ea60: 2c20 6d61 726b 733d 7079 7465 7374 2e6d  , marks=pytest.m
-0001ea70: 6172 6b2e 636c 6f75 6466 6c61 7265 290a  ark.cloudflare).
-0001ea80: 2020 2020 5d29 0a20 2020 2064 6566 2074      ]).    def t
-0001ea90: 6573 745f 6275 636b 6574 5f62 756c 6b5f  est_bucket_bulk_
-0001eaa0: 6465 6c65 7469 6f6e 2873 656c 662c 2073  deletion(self, s
-0001eab0: 746f 7265 5f74 7970 652c 2074 6d70 5f62  tore_type, tmp_b
-0001eac0: 756c 6b5f 6465 6c5f 7374 6f72 6167 655f  ulk_del_storage_
-0001ead0: 6f62 6a29 3a0a 2020 2020 2020 2020 2320  obj):.        # 
-0001eae0: 4372 6561 7465 7320 6120 7465 6d70 2066  Creates a temp f
-0001eaf0: 6f6c 6465 7220 7769 7468 206f 7665 7220  older with over 
-0001eb00: 3235 3620 6669 6c65 7320 616e 6420 666f  256 files and fo
-0001eb10: 6c64 6572 732c 2075 706c 6f61 640a 2020  lders, upload.  
-0001eb20: 2020 2020 2020 2320 6669 6c65 7320 616e        # files an
-0001eb30: 6420 666f 6c64 6572 7320 746f 2061 206e  d folders to a n
-0001eb40: 6577 2062 7563 6b65 742c 2074 6865 6e20  ew bucket, then 
-0001eb50: 6465 6c65 7465 2062 7563 6b65 742e 0a20  delete bucket.. 
-0001eb60: 2020 2020 2020 2074 6d70 5f62 756c 6b5f         tmp_bulk_
-0001eb70: 6465 6c5f 7374 6f72 6167 655f 6f62 6a2e  del_storage_obj.
-0001eb80: 6164 645f 7374 6f72 6528 7374 6f72 655f  add_store(store_
-0001eb90: 7479 7065 290a 0a20 2020 2020 2020 2073  type)..        s
-0001eba0: 7562 7072 6f63 6573 732e 6368 6563 6b5f  ubprocess.check_
-0001ebb0: 6f75 7470 7574 280a 2020 2020 2020 2020  output(.        
-0001ebc0: 2020 2020 5b27 736b 7927 2c20 2773 746f      ['sky', 'sto
-0001ebd0: 7261 6765 272c 2027 6465 6c65 7465 272c  rage', 'delete',
-0001ebe0: 2074 6d70 5f62 756c 6b5f 6465 6c5f 7374   tmp_bulk_del_st
-0001ebf0: 6f72 6167 655f 6f62 6a2e 6e61 6d65 5d29  orage_obj.name])
-0001ec00: 0a0a 2020 2020 2020 2020 6f75 7470 7574  ..        output
-0001ec10: 203d 2073 7562 7072 6f63 6573 732e 6368   = subprocess.ch
-0001ec20: 6563 6b5f 6f75 7470 7574 285b 2773 6b79  eck_output(['sky
-0001ec30: 272c 2027 7374 6f72 6167 6527 2c20 276c  ', 'storage', 'l
-0001ec40: 7327 5d29 0a20 2020 2020 2020 2061 7373  s']).        ass
-0001ec50: 6572 7420 746d 705f 6275 6c6b 5f64 656c  ert tmp_bulk_del
-0001ec60: 5f73 746f 7261 6765 5f6f 626a 2e6e 616d  _storage_obj.nam
-0001ec70: 6520 6e6f 7420 696e 206f 7574 7075 742e  e not in output.
-0001ec80: 6465 636f 6465 2827 7574 662d 3827 290a  decode('utf-8').
-0001ec90: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
-0001eca0: 6b2e 7061 7261 6d65 7472 697a 6528 0a20  k.parametrize(. 
-0001ecb0: 2020 2020 2020 2027 746d 705f 7075 626c         'tmp_publ
-0001ecc0: 6963 5f73 746f 7261 6765 5f6f 626a 2c20  ic_storage_obj, 
-0001ecd0: 7374 6f72 655f 7479 7065 272c 0a20 2020  store_type',.   
-0001ece0: 2020 2020 205b 2827 7333 3a2f 2f74 6367       [('s3://tcg
-0001ecf0: 612d 322d 6f70 656e 272c 2073 746f 7261  a-2-open', stora
-0001ed00: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
-0001ed10: 2e53 3329 2c0a 2020 2020 2020 2020 2028  .S3),.         (
-0001ed20: 2773 333a 2f2f 6469 6769 7461 6c63 6f72  's3://digitalcor
-0001ed30: 706f 7261 272c 2073 746f 7261 6765 5f6c  pora', storage_l
-0001ed40: 6962 2e53 746f 7265 5479 7065 2e53 3329  ib.StoreType.S3)
-0001ed50: 2c0a 2020 2020 2020 2020 2028 2767 733a  ,.         ('gs:
-0001ed60: 2f2f 6763 702d 7075 626c 6963 2d64 6174  //gcp-public-dat
-0001ed70: 612d 7365 6e74 696e 656c 2d32 272c 2073  a-sentinel-2', s
-0001ed80: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
-0001ed90: 5479 7065 2e47 4353 295d 2c0a 2020 2020  Type.GCS)],.    
-0001eda0: 2020 2020 696e 6469 7265 6374 3d5b 2774      indirect=['t
-0001edb0: 6d70 5f70 7562 6c69 635f 7374 6f72 6167  mp_public_storag
-0001edc0: 655f 6f62 6a27 5d29 0a20 2020 2064 6566  e_obj']).    def
-0001edd0: 2074 6573 745f 7075 626c 6963 5f62 7563   test_public_buc
-0001ede0: 6b65 7428 7365 6c66 2c20 746d 705f 7075  ket(self, tmp_pu
-0001edf0: 626c 6963 5f73 746f 7261 6765 5f6f 626a  blic_storage_obj
-0001ee00: 2c20 7374 6f72 655f 7479 7065 293a 0a20  , store_type):. 
-0001ee10: 2020 2020 2020 2023 2043 7265 6174 6573         # Creates
-0001ee20: 2061 206e 6577 2062 7563 6b65 7420 7769   a new bucket wi
-0001ee30: 7468 2061 2070 7562 6c69 6320 736f 7572  th a public sour
-0001ee40: 6365 2061 6e64 2076 6572 6966 6965 7320  ce and verifies 
-0001ee50: 7468 6174 2069 7420 6973 206e 6f74 0a20  that it is not. 
-0001ee60: 2020 2020 2020 2023 2061 6464 6564 2074         # added t
-0001ee70: 6f20 676c 6f62 616c 5f75 7365 725f 7374  o global_user_st
-0001ee80: 6174 652e 0a20 2020 2020 2020 2074 6d70  ate..        tmp
-0001ee90: 5f70 7562 6c69 635f 7374 6f72 6167 655f  _public_storage_
-0001eea0: 6f62 6a2e 6164 645f 7374 6f72 6528 7374  obj.add_store(st
-0001eeb0: 6f72 655f 7479 7065 290a 0a20 2020 2020  ore_type)..     
-0001eec0: 2020 2023 2052 756e 2073 6b79 2073 746f     # Run sky sto
-0001eed0: 7261 6765 206c 7320 746f 2063 6865 636b  rage ls to check
-0001eee0: 2069 6620 7374 6f72 6167 6520 6f62 6a65   if storage obje
-0001eef0: 6374 2065 7869 7374 7320 696e 2074 6865  ct exists in the
-0001ef00: 206f 7574 7075 740a 2020 2020 2020 2020   output.        
-0001ef10: 6f75 7420 3d20 7375 6270 726f 6365 7373  out = subprocess
-0001ef20: 2e63 6865 636b 5f6f 7574 7075 7428 5b27  .check_output(['
-0001ef30: 736b 7927 2c20 2773 746f 7261 6765 272c  sky', 'storage',
-0001ef40: 2027 6c73 275d 290a 2020 2020 2020 2020   'ls']).        
-0001ef50: 6173 7365 7274 2074 6d70 5f70 7562 6c69  assert tmp_publi
-0001ef60: 635f 7374 6f72 6167 655f 6f62 6a2e 6e61  c_storage_obj.na
-0001ef70: 6d65 206e 6f74 2069 6e20 6f75 742e 6465  me not in out.de
-0001ef80: 636f 6465 2827 7574 662d 3827 290a 0a20  code('utf-8').. 
-0001ef90: 2020 2040 7079 7465 7374 2e6d 6172 6b2e     @pytest.mark.
-0001efa0: 7061 7261 6d65 7472 697a 6528 276e 6f6e  parametrize('non
-0001efb0: 6578 6973 745f 6275 636b 6574 5f75 726c  exist_bucket_url
-0001efc0: 272c 205b 0a20 2020 2020 2020 2027 7333  ', [.        's3
-0001efd0: 3a2f 2f7b 7261 6e64 6f6d 5f6e 616d 657d  ://{random_name}
-0001efe0: 272c 2027 6773 3a2f 2f7b 7261 6e64 6f6d  ', 'gs://{random
-0001eff0: 5f6e 616d 657d 272c 0a20 2020 2020 2020  _name}',.       
-0001f000: 2070 7974 6573 742e 7061 7261 6d28 2763   pytest.param('c
-0001f010: 6f73 3a2f 2f75 732d 6561 7374 2f7b 7261  os://us-east/{ra
-0001f020: 6e64 6f6d 5f6e 616d 657d 272c 206d 6172  ndom_name}', mar
-0001f030: 6b73 3d70 7974 6573 742e 6d61 726b 2e69  ks=pytest.mark.i
-0001f040: 626d 292c 0a20 2020 2020 2020 2070 7974  bm),.        pyt
-0001f050: 6573 742e 7061 7261 6d28 2772 323a 2f2f  est.param('r2://
-0001f060: 7b72 616e 646f 6d5f 6e61 6d65 7d27 2c20  {random_name}', 
-0001f070: 6d61 726b 733d 7079 7465 7374 2e6d 6172  marks=pytest.mar
-0001f080: 6b2e 636c 6f75 6466 6c61 7265 290a 2020  k.cloudflare).  
-0001f090: 2020 5d29 0a20 2020 2064 6566 2074 6573    ]).    def tes
-0001f0a0: 745f 6e6f 6e65 7869 7374 656e 745f 6275  t_nonexistent_bu
-0001f0b0: 636b 6574 2873 656c 662c 206e 6f6e 6578  cket(self, nonex
-0001f0c0: 6973 745f 6275 636b 6574 5f75 726c 293a  ist_bucket_url):
-0001f0d0: 0a20 2020 2020 2020 2023 2041 7474 656d  .        # Attem
-0001f0e0: 7074 7320 746f 2063 7265 6174 6520 6665  pts to create fe
-0001f0f0: 7463 6820 6120 7374 726f 6167 6520 7769  tch a stroage wi
-0001f100: 7468 2061 206e 6f6e 2d65 7869 7374 656e  th a non-existen
-0001f110: 7420 736f 7572 6365 2e0a 2020 2020 2020  t source..      
-0001f120: 2020 2320 4765 6e65 7261 7465 2061 2072    # Generate a r
-0001f130: 616e 646f 6d20 6275 636b 6574 206e 616d  andom bucket nam
-0001f140: 6520 616e 6420 7665 7269 6679 2069 7420  e and verify it 
-0001f150: 646f 6573 6e27 7420 6578 6973 743a 0a20  doesn't exist:. 
-0001f160: 2020 2020 2020 2072 6574 7279 5f63 6f75         retry_cou
-0001f170: 6e74 203d 2030 0a20 2020 2020 2020 2077  nt = 0.        w
-0001f180: 6869 6c65 2054 7275 653a 0a20 2020 2020  hile True:.     
-0001f190: 2020 2020 2020 206e 6f6e 6578 6973 745f         nonexist_
-0001f1a0: 6275 636b 6574 5f6e 616d 6520 3d20 7374  bucket_name = st
-0001f1b0: 7228 7575 6964 2e75 7569 6434 2829 290a  r(uuid.uuid4()).
-0001f1c0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-0001f1d0: 6f6e 6578 6973 745f 6275 636b 6574 5f75  onexist_bucket_u
-0001f1e0: 726c 2e73 7461 7274 7377 6974 6828 2773  rl.startswith('s
-0001f1f0: 3327 293a 0a20 2020 2020 2020 2020 2020  3'):.           
-0001f200: 2020 2020 2063 6f6d 6d61 6e64 203d 2066       command = f
-0001f210: 2761 7773 2073 3361 7069 2068 6561 642d  'aws s3api head-
-0001f220: 6275 636b 6574 202d 2d62 7563 6b65 7420  bucket --bucket 
-0001f230: 7b6e 6f6e 6578 6973 745f 6275 636b 6574  {nonexist_bucket
-0001f240: 5f6e 616d 657d 270a 2020 2020 2020 2020  _name}'.        
-0001f250: 2020 2020 2020 2020 6578 7065 6374 6564          expected
-0001f260: 5f6f 7574 7075 7420 3d20 2734 3034 270a  _output = '404'.
-0001f270: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-0001f280: 206e 6f6e 6578 6973 745f 6275 636b 6574   nonexist_bucket
-0001f290: 5f75 726c 2e73 7461 7274 7377 6974 6828  _url.startswith(
-0001f2a0: 2767 7327 293a 0a20 2020 2020 2020 2020  'gs'):.         
-0001f2b0: 2020 2020 2020 2063 6f6d 6d61 6e64 203d         command =
-0001f2c0: 2066 2767 7375 7469 6c20 6c73 207b 6e6f   f'gsutil ls {no
-0001f2d0: 6e65 7869 7374 5f62 7563 6b65 745f 7572  nexist_bucket_ur
-0001f2e0: 6c2e 666f 726d 6174 2872 616e 646f 6d5f  l.format(random_
-0001f2f0: 6e61 6d65 3d6e 6f6e 6578 6973 745f 6275  name=nonexist_bu
-0001f300: 636b 6574 5f6e 616d 6529 7d27 0a20 2020  cket_name)}'.   
-0001f310: 2020 2020 2020 2020 2020 2020 2065 7870               exp
-0001f320: 6563 7465 645f 6f75 7470 7574 203d 2027  ected_output = '
-0001f330: 4275 636b 6574 4e6f 7446 6f75 6e64 4578  BucketNotFoundEx
-0001f340: 6365 7074 696f 6e27 0a20 2020 2020 2020  ception'.       
-0001f350: 2020 2020 2065 6c69 6620 6e6f 6e65 7869       elif nonexi
-0001f360: 7374 5f62 7563 6b65 745f 7572 6c2e 7374  st_bucket_url.st
-0001f370: 6172 7473 7769 7468 2827 7232 2729 3a0a  artswith('r2'):.
-0001f380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f390: 656e 6470 6f69 6e74 5f75 726c 203d 2063  endpoint_url = c
-0001f3a0: 6c6f 7564 666c 6172 652e 6372 6561 7465  loudflare.create
-0001f3b0: 5f65 6e64 706f 696e 7428 290a 2020 2020  _endpoint().    
-0001f3c0: 2020 2020 2020 2020 2020 2020 636f 6d6d              comm
-0001f3d0: 616e 6420 3d20 6627 4157 535f 5348 4152  and = f'AWS_SHAR
-0001f3e0: 4544 5f43 5245 4445 4e54 4941 4c53 5f46  ED_CREDENTIALS_F
-0001f3f0: 494c 453d 7b63 6c6f 7564 666c 6172 652e  ILE={cloudflare.
-0001f400: 5232 5f43 5245 4445 4e54 4941 4c53 5f50  R2_CREDENTIALS_P
-0001f410: 4154 487d 2061 7773 2073 3361 7069 2068  ATH} aws s3api h
-0001f420: 6561 642d 6275 636b 6574 202d 2d62 7563  ead-bucket --buc
-0001f430: 6b65 7420 7b6e 6f6e 6578 6973 745f 6275  ket {nonexist_bu
-0001f440: 636b 6574 5f6e 616d 657d 202d 2d65 6e64  cket_name} --end
-0001f450: 706f 696e 7420 7b65 6e64 706f 696e 745f  point {endpoint_
-0001f460: 7572 6c7d 202d 2d70 726f 6669 6c65 3d72  url} --profile=r
-0001f470: 3227 0a20 2020 2020 2020 2020 2020 2020  2'.             
-0001f480: 2020 2065 7870 6563 7465 645f 6f75 7470     expected_outp
-0001f490: 7574 203d 2027 3430 3427 0a20 2020 2020  ut = '404'.     
-0001f4a0: 2020 2020 2020 2065 6c69 6620 6e6f 6e65         elif none
-0001f4b0: 7869 7374 5f62 7563 6b65 745f 7572 6c2e  xist_bucket_url.
-0001f4c0: 7374 6172 7473 7769 7468 2827 636f 7327  startswith('cos'
-0001f4d0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0001f4e0: 2020 2023 2055 7369 6e67 2041 5049 2063     # Using API c
-0001f4f0: 616c 6c73 2c20 7369 6e63 6520 7573 696e  alls, since usin
-0001f500: 6720 7263 6c6f 6e65 2072 6571 7569 7265  g rclone require
-0001f510: 7320 6120 7072 6f66 696c 6527 7320 6e61  s a profile's na
-0001f520: 6d65 0a20 2020 2020 2020 2020 2020 2020  me.             
-0001f530: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-0001f540: 2020 2020 2020 2020 2020 2020 6578 7065              expe
-0001f550: 6374 6564 5f6f 7574 7075 7420 3d20 636f  cted_output = co
-0001f560: 6d6d 616e 6420 3d20 2265 6368 6f22 2020  mmand = "echo"  
-0001f570: 2320 6176 6f69 6420 756e 7265 6c61 7465  # avoid unrelate
-0001f580: 6420 6578 6365 7074 696f 6e20 696e 2063  d exception in c
-0001f590: 6173 6520 6f66 2066 6169 6c75 7265 2e0a  ase of failure..
-0001f5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f5b0: 2020 2020 6275 636b 6574 5f6e 616d 6520      bucket_name 
-0001f5c0: 3d20 7572 6c6c 6962 2e70 6172 7365 2e75  = urllib.parse.u
-0001f5d0: 726c 7370 6c69 7428 0a20 2020 2020 2020  rlsplit(.       
-0001f5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f5f0: 206e 6f6e 6578 6973 745f 6275 636b 6574   nonexist_bucket
-0001f600: 5f75 726c 2e66 6f72 6d61 7428 0a20 2020  _url.format(.   
-0001f610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f620: 2020 2020 2020 2020 2072 616e 646f 6d5f           random_
-0001f630: 6e61 6d65 3d6e 6f6e 6578 6973 745f 6275  name=nonexist_bu
-0001f640: 636b 6574 5f6e 616d 6529 292e 7061 7468  cket_name)).path
-0001f650: 2e73 7472 6970 2827 2f27 290a 2020 2020  .strip('/').    
-0001f660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f670: 636c 6965 6e74 203d 2069 626d 2e67 6574  client = ibm.get
-0001f680: 5f63 6f73 5f63 6c69 656e 7428 2775 732d  _cos_client('us-
-0001f690: 6561 7374 2729 0a20 2020 2020 2020 2020  east').         
-0001f6a0: 2020 2020 2020 2020 2020 2063 6c69 656e             clien
-0001f6b0: 742e 6865 6164 5f62 7563 6b65 7428 4275  t.head_bucket(Bu
-0001f6c0: 636b 6574 3d62 7563 6b65 745f 6e61 6d65  cket=bucket_name
-0001f6d0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001f6e0: 2020 6578 6365 7074 2069 626d 2e69 626d    except ibm.ibm
-0001f6f0: 5f62 6f74 6f63 6f72 652e 6578 6365 7074  _botocore.except
-0001f700: 696f 6e73 2e43 6c69 656e 7445 7272 6f72  ions.ClientError
-0001f710: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
-0001f720: 2020 2020 2020 2020 2020 2069 6620 652e             if e.
-0001f730: 7265 7370 6f6e 7365 5b27 4572 726f 7227  response['Error'
-0001f740: 5d5b 2743 6f64 6527 5d20 3d3d 2027 3430  ]['Code'] == '40
-0001f750: 3427 3a0a 2020 2020 2020 2020 2020 2020  4':.            
-0001f760: 2020 2020 2020 2020 2020 2020 2320 7375              # su
-0001f770: 6363 6573 730a 2020 2020 2020 2020 2020  ccess.          
-0001f780: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0001f790: 7475 726e 0a20 2020 2020 2020 2020 2020  turn.           
-0001f7a0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0001f7b0: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
-0001f7c0: 7565 4572 726f 7228 2755 6e73 7570 706f  ueError('Unsuppo
-0001f7d0: 7274 6564 2062 7563 6b65 7420 7479 7065  rted bucket type
-0001f7e0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-0001f7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f800: 2020 2020 6627 7b6e 6f6e 6578 6973 745f      f'{nonexist_
-0001f810: 6275 636b 6574 5f75 726c 7d27 290a 0a20  bucket_url}').. 
-0001f820: 2020 2020 2020 2020 2020 2023 2043 6865             # Che
-0001f830: 636b 2069 6620 6275 636b 6574 2065 7869  ck if bucket exi
-0001f840: 7374 7320 7573 696e 6720 7468 6520 636c  sts using the cl
-0001f850: 693a 0a20 2020 2020 2020 2020 2020 2074  i:.            t
-0001f860: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-0001f870: 2020 2020 6f75 7420 3d20 7375 6270 726f      out = subpro
-0001f880: 6365 7373 2e63 6865 636b 5f6f 7574 7075  cess.check_outpu
-0001f890: 7428 636f 6d6d 616e 642c 0a20 2020 2020  t(command,.     
-0001f8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f8c0: 2020 2020 2020 2020 2073 7464 6572 723d           stderr=
-0001f8d0: 7375 6270 726f 6365 7373 2e53 5444 4f55  subprocess.STDOU
-0001f8e0: 542c 0a20 2020 2020 2020 2020 2020 2020  T,.             
-0001f8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f910: 2073 6865 6c6c 3d54 7275 6529 0a20 2020   shell=True).   
-0001f920: 2020 2020 2020 2020 2065 7863 6570 7420           except 
-0001f930: 7375 6270 726f 6365 7373 2e43 616c 6c65  subprocess.Calle
-0001f940: 6450 726f 6365 7373 4572 726f 7220 6173  dProcessError as
-0001f950: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
-0001f960: 2020 2020 6f75 7420 3d20 652e 6f75 7470      out = e.outp
-0001f970: 7574 0a20 2020 2020 2020 2020 2020 206f  ut.            o
-0001f980: 7574 203d 206f 7574 2e64 6563 6f64 6528  ut = out.decode(
-0001f990: 2775 7466 2d38 2729 0a20 2020 2020 2020  'utf-8').       
-0001f9a0: 2020 2020 2069 6620 6578 7065 6374 6564       if expected
-0001f9b0: 5f6f 7574 7075 7420 696e 206f 7574 3a0a  _output in out:.
-0001f9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f9d0: 6272 6561 6b0a 2020 2020 2020 2020 2020  break.          
-0001f9e0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0001f9f0: 2020 2020 2020 2020 7265 7472 795f 636f          retry_co
-0001fa00: 756e 7420 2b3d 2031 0a20 2020 2020 2020  unt += 1.       
-0001fa10: 2020 2020 2020 2020 2069 6620 7265 7472           if retr
-0001fa20: 795f 636f 756e 7420 3e20 333a 0a20 2020  y_count > 3:.   
-0001fa30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fa40: 2072 6169 7365 2052 756e 7469 6d65 4572   raise RuntimeEr
-0001fa50: 726f 7228 2755 6e61 626c 6520 746f 2066  ror('Unable to f
-0001fa60: 696e 6420 6120 6e6f 6e65 7869 7374 656e  ind a nonexisten
-0001fa70: 7420 6275 636b 6574 2027 0a20 2020 2020  t bucket '.     
-0001fa80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fa90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001faa0: 2020 2774 6f20 7573 652e 2054 6869 7320    'to use. This 
-0001fab0: 6973 2068 6967 6c79 2075 6e6c 696b 656c  is higly unlikel
-0001fac0: 7920 2d20 270a 2020 2020 2020 2020 2020  y - '.          
-0001fad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fae0: 2020 2020 2020 2020 2020 2020 2027 6368               'ch
-0001faf0: 6563 6b20 6966 2074 6865 2074 6573 7473  eck if the tests
-0001fb00: 2061 7265 2063 6f72 7265 6374 2e27 290a   are correct.').
-0001fb10: 0a20 2020 2020 2020 2077 6974 6820 7079  .        with py
-0001fb20: 7465 7374 2e72 6169 7365 7328 0a20 2020  test.raises(.   
-0001fb30: 2020 2020 2020 2020 2020 2020 2073 6b79               sky
-0001fb40: 2e65 7863 6570 7469 6f6e 732e 5374 6f72  .exceptions.Stor
-0001fb50: 6167 6542 7563 6b65 7447 6574 4572 726f  ageBucketGetErro
-0001fb60: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
-0001fb70: 2020 206d 6174 6368 3d27 4174 7465 6d70     match='Attemp
-0001fb80: 7465 6420 746f 2063 6f6e 6e65 6374 2074  ted to connect t
-0001fb90: 6f20 6120 6e6f 6e2d 6578 6973 7465 6e74  o a non-existent
-0001fba0: 2062 7563 6b65 7427 293a 0a20 2020 2020   bucket'):.     
-0001fbb0: 2020 2020 2020 2073 746f 7261 6765 5f6f         storage_o
-0001fbc0: 626a 203d 2073 746f 7261 6765 5f6c 6962  bj = storage_lib
-0001fbd0: 2e53 746f 7261 6765 2873 6f75 7263 653d  .Storage(source=
-0001fbe0: 6e6f 6e65 7869 7374 5f62 7563 6b65 745f  nonexist_bucket_
-0001fbf0: 7572 6c2e 666f 726d 6174 280a 2020 2020  url.format(.    
-0001fc00: 2020 2020 2020 2020 2020 2020 7261 6e64              rand
-0001fc10: 6f6d 5f6e 616d 653d 6e6f 6e65 7869 7374  om_name=nonexist
-0001fc20: 5f62 7563 6b65 745f 6e61 6d65 2929 0a0a  _bucket_name))..
-0001fc30: 2020 2020 4070 7974 6573 742e 6d61 726b      @pytest.mark
-0001fc40: 2e70 6172 616d 6574 7269 7a65 2827 7072  .parametrize('pr
-0001fc50: 6976 6174 655f 6275 636b 6574 272c 205b  ivate_bucket', [
-0001fc60: 0a20 2020 2020 2020 2066 2773 333a 2f2f  .        f's3://
-0001fc70: 696d 6167 656e 6574 272c 2066 2767 733a  imagenet', f'gs:
-0001fc80: 2f2f 696d 6167 656e 6574 272c 0a20 2020  //imagenet',.   
-0001fc90: 2020 2020 2070 7974 6573 742e 7061 7261       pytest.para
-0001fca0: 6d28 2763 6f73 3a2f 2f75 732d 6561 7374  m('cos://us-east
-0001fcb0: 2f62 7563 6b65 7431 272c 206d 6172 6b73  /bucket1', marks
-0001fcc0: 3d70 7974 6573 742e 6d61 726b 2e69 626d  =pytest.mark.ibm
-0001fcd0: 290a 2020 2020 5d29 0a20 2020 2064 6566  ).    ]).    def
-0001fce0: 2074 6573 745f 7072 6976 6174 655f 6275   test_private_bu
-0001fcf0: 636b 6574 2873 656c 662c 2070 7269 7661  cket(self, priva
-0001fd00: 7465 5f62 7563 6b65 7429 3a0a 2020 2020  te_bucket):.    
-0001fd10: 2020 2020 2320 4174 7465 6d70 7473 2074      # Attempts t
-0001fd20: 6f20 6163 6365 7373 2070 7269 7661 7465  o access private
-0001fd30: 2062 7563 6b65 7473 206e 6f74 2062 656c   buckets not bel
-0001fd40: 6f6e 6769 6e67 2074 6f20 7468 6520 7573  onging to the us
-0001fd50: 6572 2e0a 2020 2020 2020 2020 2320 5468  er..        # Th
-0001fd60: 6573 6520 6275 636b 6574 7320 6172 6520  ese buckets are 
-0001fd70: 6b6e 6f77 6e20 746f 2062 6520 7072 6976  known to be priv
-0001fd80: 6174 652c 2062 7574 206d 6179 206e 6565  ate, but may nee
-0001fd90: 6420 746f 2062 6520 7570 6461 7465 6420  d to be updated 
-0001fda0: 6966 0a20 2020 2020 2020 2023 2074 6865  if.        # the
-0001fdb0: 7920 6172 6520 7265 6d6f 7665 6420 6279  y are removed by
-0001fdc0: 2074 6865 6972 206f 776e 6572 732e 0a20   their owners.. 
-0001fdd0: 2020 2020 2020 2070 7269 7661 7465 5f62         private_b
-0001fde0: 7563 6b65 745f 6e61 6d65 203d 2075 726c  ucket_name = url
-0001fdf0: 6c69 622e 7061 7273 652e 7572 6c73 706c  lib.parse.urlspl
-0001fe00: 6974 2870 7269 7661 7465 5f62 7563 6b65  it(private_bucke
-0001fe10: 7429 2e6e 6574 6c6f 6320 6966 205c 0a20  t).netloc if \. 
-0001fe20: 2020 2020 2020 2020 2020 2020 2075 726c               url
-0001fe30: 6c69 622e 7061 7273 652e 7572 6c73 706c  lib.parse.urlspl
-0001fe40: 6974 2870 7269 7661 7465 5f62 7563 6b65  it(private_bucke
-0001fe50: 7429 2e73 6368 656d 6520 213d 2027 636f  t).scheme != 'co
-0001fe60: 7327 2065 6c73 6520 5c0a 2020 2020 2020  s' else \.      
-0001fe70: 2020 2020 2020 2020 2020 2020 7572 6c6c              urll
-0001fe80: 6962 2e70 6172 7365 2e75 726c 7370 6c69  ib.parse.urlspli
-0001fe90: 7428 7072 6976 6174 655f 6275 636b 6574  t(private_bucket
-0001fea0: 292e 7061 7468 2e73 7472 6970 2827 2f27  ).path.strip('/'
-0001feb0: 290a 2020 2020 2020 2020 7769 7468 2070  ).        with p
-0001fec0: 7974 6573 742e 7261 6973 6573 280a 2020  ytest.raises(.  
-0001fed0: 2020 2020 2020 2020 2020 2020 2020 736b                sk
-0001fee0: 792e 6578 6365 7074 696f 6e73 2e53 746f  y.exceptions.Sto
-0001fef0: 7261 6765 4275 636b 6574 4765 7445 7272  rageBucketGetErr
-0001ff00: 6f72 2c0a 2020 2020 2020 2020 2020 2020  or,.            
-0001ff10: 2020 2020 6d61 7463 683d 7374 6f72 6167      match=storag
-0001ff20: 655f 6c69 622e 5f42 5543 4b45 545f 4641  e_lib._BUCKET_FA
-0001ff30: 494c 5f54 4f5f 434f 4e4e 4543 545f 4d45  IL_TO_CONNECT_ME
-0001ff40: 5353 4147 452e 666f 726d 6174 280a 2020  SSAGE.format(.  
-0001ff50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ff60: 2020 6e61 6d65 3d70 7269 7661 7465 5f62    name=private_b
-0001ff70: 7563 6b65 745f 6e61 6d65 2929 3a0a 2020  ucket_name)):.  
-0001ff80: 2020 2020 2020 2020 2020 7374 6f72 6167            storag
-0001ff90: 655f 6f62 6a20 3d20 7374 6f72 6167 655f  e_obj = storage_
-0001ffa0: 6c69 622e 5374 6f72 6167 6528 736f 7572  lib.Storage(sour
-0001ffb0: 6365 3d70 7269 7661 7465 5f62 7563 6b65  ce=private_bucke
-0001ffc0: 7429 0a0a 2020 2020 4070 7974 6573 742e  t)..    @pytest.
-0001ffd0: 6d61 726b 2e70 6172 616d 6574 7269 7a65  mark.parametrize
-0001ffe0: 2827 6578 745f 6275 636b 6574 5f66 6978  ('ext_bucket_fix
-0001fff0: 7475 7265 2c20 7374 6f72 655f 7479 7065  ture, store_type
-00020000: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00020010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020020: 5b28 2774 6d70 5f61 7773 636c 695f 6275  [('tmp_awscli_bu
-00020030: 636b 6574 272c 2073 746f 7261 6765 5f6c  cket', storage_l
-00020040: 6962 2e53 746f 7265 5479 7065 2e53 3329  ib.StoreType.S3)
-00020050: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00020060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020070: 2827 746d 705f 6773 7574 696c 5f62 7563  ('tmp_gsutil_buc
-00020080: 6b65 7427 2c20 7374 6f72 6167 655f 6c69  ket', storage_li
-00020090: 622e 5374 6f72 6554 7970 652e 4743 5329  b.StoreType.GCS)
-000200a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000200b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000200c0: 7079 7465 7374 2e70 6172 616d 2827 746d  pytest.param('tm
-000200d0: 705f 6962 6d5f 636f 735f 6275 636b 6574  p_ibm_cos_bucket
-000200e0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-000200f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020100: 2020 2020 2020 2020 2020 2020 2020 7374                st
-00020110: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
-00020120: 7970 652e 4942 4d2c 0a20 2020 2020 2020  ype.IBM,.       
-00020130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020150: 2020 2020 6d61 726b 733d 7079 7465 7374      marks=pytest
-00020160: 2e6d 6172 6b2e 6962 6d29 2c0a 2020 2020  .mark.ibm),.    
-00020170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020180: 2020 2020 2020 2020 2020 7079 7465 7374            pytest
-00020190: 2e70 6172 616d 2827 746d 705f 6177 7363  .param('tmp_awsc
-000201a0: 6c69 5f62 7563 6b65 745f 7232 272c 0a20  li_bucket_r2',. 
-000201b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000201c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000201d0: 2020 2020 2020 2020 2020 7374 6f72 6167            storag
-000201e0: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
-000201f0: 5232 2c0a 2020 2020 2020 2020 2020 2020  R2,.            
-00020200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020210: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00020220: 6172 6b73 3d70 7974 6573 742e 6d61 726b  arks=pytest.mark
-00020230: 2e63 6c6f 7564 666c 6172 6529 5d29 0a20  .cloudflare)]). 
-00020240: 2020 2064 6566 2074 6573 745f 7570 6c6f     def test_uplo
-00020250: 6164 5f74 6f5f 6578 6973 7469 6e67 5f62  ad_to_existing_b
-00020260: 7563 6b65 7428 7365 6c66 2c20 6578 745f  ucket(self, ext_
-00020270: 6275 636b 6574 5f66 6978 7475 7265 2c20  bucket_fixture, 
-00020280: 7265 7175 6573 742c 0a20 2020 2020 2020  request,.       
-00020290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000202a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000202b0: 746d 705f 736f 7572 6365 2c20 7374 6f72  tmp_source, stor
-000202c0: 655f 7479 7065 293a 0a20 2020 2020 2020  e_type):.       
-000202d0: 2023 2054 7269 6573 2075 706c 6f61 6469   # Tries uploadi
-000202e0: 6e67 2065 7869 7374 696e 6720 6669 6c65  ng existing file
-000202f0: 7320 746f 206e 6577 6c79 2063 7265 6174  s to newly creat
-00020300: 6564 2062 7563 6b65 7420 286f 7574 7369  ed bucket (outsi
-00020310: 6465 206f 660a 2020 2020 2020 2020 2320  de of.        # 
-00020320: 736b 7929 2061 6e64 2076 6572 6966 6965  sky) and verifie
-00020330: 7320 7468 6174 2066 696c 6573 2061 7265  s that files are
-00020340: 2077 7269 7474 656e 2e0a 2020 2020 2020   written..      
-00020350: 2020 6275 636b 6574 5f6e 616d 6520 3d20    bucket_name = 
-00020360: 7265 7175 6573 742e 6765 7466 6978 7475  request.getfixtu
-00020370: 7265 7661 6c75 6528 6578 745f 6275 636b  revalue(ext_buck
-00020380: 6574 5f66 6978 7475 7265 290a 2020 2020  et_fixture).    
-00020390: 2020 2020 7374 6f72 6167 655f 6f62 6a20      storage_obj 
-000203a0: 3d20 7374 6f72 6167 655f 6c69 622e 5374  = storage_lib.St
-000203b0: 6f72 6167 6528 6e61 6d65 3d62 7563 6b65  orage(name=bucke
-000203c0: 745f 6e61 6d65 2c20 736f 7572 6365 3d74  t_name, source=t
-000203d0: 6d70 5f73 6f75 7263 6529 0a20 2020 2020  mp_source).     
-000203e0: 2020 2073 746f 7261 6765 5f6f 626a 2e61     storage_obj.a
-000203f0: 6464 5f73 746f 7265 2873 746f 7265 5f74  dd_store(store_t
-00020400: 7970 6529 0a0a 2020 2020 2020 2020 2320  ype)..        # 
-00020410: 4368 6563 6b20 6966 2074 6d70 5f73 6f75  Check if tmp_sou
-00020420: 7263 652f 746d 702d 6669 6c65 2065 7869  rce/tmp-file exi
-00020430: 7374 7320 696e 2074 6865 2062 7563 6b65  sts in the bucke
-00020440: 7420 7573 696e 6720 6177 7320 636c 690a  t using aws cli.
-00020450: 2020 2020 2020 2020 6f75 7420 3d20 7375          out = su
-00020460: 6270 726f 6365 7373 2e63 6865 636b 5f6f  bprocess.check_o
-00020470: 7574 7075 7428 7365 6c66 2e63 6c69 5f6c  utput(self.cli_l
-00020480: 735f 636d 6428 7374 6f72 655f 7479 7065  s_cmd(store_type
-00020490: 2c20 6275 636b 6574 5f6e 616d 6529 2c0a  , bucket_name),.
-000204a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000204b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000204c0: 2020 2020 2020 7368 656c 6c3d 5472 7565        shell=True
-000204d0: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
-000204e0: 2027 746d 702d 6669 6c65 2720 696e 206f   'tmp-file' in o
-000204f0: 7574 2e64 6563 6f64 6528 2775 7466 2d38  ut.decode('utf-8
-00020500: 2729 2c20 5c0a 2020 2020 2020 2020 2020  '), \.          
-00020510: 2020 2746 696c 6520 6e6f 7420 666f 756e    'File not foun
-00020520: 6420 696e 2062 7563 6b65 7420 2d20 6f75  d in bucket - ou
-00020530: 7470 7574 2077 6173 203a 207b 7d27 2e66  tput was : {}'.f
-00020540: 6f72 6d61 7428 6f75 742e 6465 636f 6465  ormat(out.decode
-00020550: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00020560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020590: 2028 2775 7466 2d38 2729 290a 0a20 2020   ('utf-8'))..   
-000205a0: 2020 2020 2023 2043 6865 636b 2073 796d       # Check sym
-000205b0: 6c69 6e6b 7320 2d20 7379 6d6c 696e 6b73  links - symlinks
-000205c0: 2064 6f6e 2774 2067 6574 2063 6f70 6965   don't get copie
-000205d0: 6420 6279 2073 6b79 2073 746f 7261 6765  d by sky storage
-000205e0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-000205f0: 2870 6174 686c 6962 2e50 6174 6828 746d  (pathlib.Path(tm
-00020600: 705f 736f 7572 6365 2920 2f20 2763 6972  p_source) / 'cir
-00020610: 636c 652d 6c69 6e6b 2729 2e69 735f 7379  cle-link').is_sy
-00020620: 6d6c 696e 6b28 292c 2028 0a20 2020 2020  mlink(), (.     
-00020630: 2020 2020 2020 2027 6369 7263 6c65 2d6c         'circle-l
-00020640: 696e 6b20 7761 7320 6e6f 7420 666f 756e  ink was not foun
-00020650: 6420 696e 2074 6865 2075 706c 6f61 6420  d in the upload 
-00020660: 736f 7572 6365 202d 2027 0a20 2020 2020  source - '.     
-00020670: 2020 2020 2020 2027 6172 6520 7468 6520         'are the 
-00020680: 7465 7374 2066 6978 7475 7265 7320 636f  test fixtures co
-00020690: 7272 6563 743f 2729 0a20 2020 2020 2020  rrect?').       
-000206a0: 2061 7373 6572 7420 2763 6972 636c 652d   assert 'circle-
-000206b0: 6c69 6e6b 2720 6e6f 7420 696e 206f 7574  link' not in out
-000206c0: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
-000206d0: 2c20 280a 2020 2020 2020 2020 2020 2020  , (.            
-000206e0: 2753 796d 6c69 6e6b 2066 6f75 6e64 2069  'Symlink found i
-000206f0: 6e20 6275 636b 6574 202d 206c 7320 6f75  n bucket - ls ou
-00020700: 7470 7574 2077 6173 203a 207b 7d27 2e66  tput was : {}'.f
-00020710: 6f72 6d61 7428 0a20 2020 2020 2020 2020  ormat(.         
-00020720: 2020 2020 2020 206f 7574 2e64 6563 6f64         out.decod
-00020730: 6528 2775 7466 2d38 2729 2929 0a0a 2020  e('utf-8')))..  
-00020740: 2020 2020 2020 2320 5275 6e20 736b 7920        # Run sky 
-00020750: 7374 6f72 6167 6520 6c73 2074 6f20 6368  storage ls to ch
-00020760: 6563 6b20 6966 2073 746f 7261 6765 206f  eck if storage o
-00020770: 626a 6563 7420 6578 6973 7473 2069 6e20  bject exists in 
-00020780: 7468 6520 6f75 7470 7574 2e0a 2020 2020  the output..    
-00020790: 2020 2020 2320 4974 2073 686f 756c 6420      # It should 
-000207a0: 6e6f 7420 6578 6973 7420 6265 6361 7573  not exist becaus
-000207b0: 6520 7468 6520 6275 636b 6574 2077 6173  e the bucket was
-000207c0: 2063 7265 6174 6564 2065 7874 6572 6e61   created externa
-000207d0: 6c6c 792e 0a20 2020 2020 2020 206f 7574  lly..        out
-000207e0: 203d 2073 7562 7072 6f63 6573 732e 6368   = subprocess.ch
-000207f0: 6563 6b5f 6f75 7470 7574 285b 2773 6b79  eck_output(['sky
-00020800: 272c 2027 7374 6f72 6167 6527 2c20 276c  ', 'storage', 'l
-00020810: 7327 5d29 0a20 2020 2020 2020 2061 7373  s']).        ass
-00020820: 6572 7420 7374 6f72 6167 655f 6f62 6a2e  ert storage_obj.
-00020830: 6e61 6d65 206e 6f74 2069 6e20 6f75 742e  name not in out.
-00020840: 6465 636f 6465 2827 7574 662d 3827 290a  decode('utf-8').
-00020850: 0a20 2020 2064 6566 2074 6573 745f 636f  .    def test_co
-00020860: 7079 5f6d 6f75 6e74 5f65 7869 7374 696e  py_mount_existin
-00020870: 675f 7374 6f72 6167 6528 7365 6c66 2c0a  g_storage(self,.
-00020880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000208a0: 2020 2020 2020 2020 2074 6d70 5f63 6f70           tmp_cop
-000208b0: 795f 6d6e 745f 6578 6973 7469 6e67 5f73  y_mnt_existing_s
-000208c0: 746f 7261 6765 5f6f 626a 293a 0a20 2020  torage_obj):.   
-000208d0: 2020 2020 2023 2043 7265 6174 6573 2061       # Creates a
-000208e0: 2062 7563 6b65 7420 7769 7468 206e 6f20   bucket with no 
-000208f0: 736f 7572 6365 2069 6e20 4d4f 554e 5420  source in MOUNT 
-00020900: 6d6f 6465 2028 656d 7074 7920 6275 636b  mode (empty buck
-00020910: 6574 292c 2061 6e64 0a20 2020 2020 2020  et), and.       
-00020920: 2023 2074 6865 6e20 7472 6965 7320 746f   # then tries to
-00020930: 206c 6f61 6420 7468 6520 7361 6d65 2073   load the same s
-00020940: 746f 7261 6765 2069 6e20 434f 5059 206d  torage in COPY m
-00020950: 6f64 652e 0a20 2020 2020 2020 2074 6d70  ode..        tmp
-00020960: 5f63 6f70 795f 6d6e 745f 6578 6973 7469  _copy_mnt_existi
-00020970: 6e67 5f73 746f 7261 6765 5f6f 626a 2e61  ng_storage_obj.a
-00020980: 6464 5f73 746f 7265 2873 746f 7261 6765  dd_store(storage
-00020990: 5f6c 6962 2e53 746f 7265 5479 7065 2e53  _lib.StoreType.S
-000209a0: 3329 0a20 2020 2020 2020 2073 746f 7261  3).        stora
-000209b0: 6765 5f6e 616d 6520 3d20 746d 705f 636f  ge_name = tmp_co
-000209c0: 7079 5f6d 6e74 5f65 7869 7374 696e 675f  py_mnt_existing_
-000209d0: 7374 6f72 6167 655f 6f62 6a2e 6e61 6d65  storage_obj.name
-000209e0: 0a0a 2020 2020 2020 2020 2320 4368 6563  ..        # Chec
-000209f0: 6b20 6073 6b79 2073 746f 7261 6765 206c  k `sky storage l
-00020a00: 7360 2074 6f20 656e 7375 7265 2073 746f  s` to ensure sto
-00020a10: 7261 6765 206f 626a 6563 7420 6578 6973  rage object exis
-00020a20: 7473 0a20 2020 2020 2020 206f 7574 203d  ts.        out =
-00020a30: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
-00020a40: 6b5f 6f75 7470 7574 285b 2773 6b79 272c  k_output(['sky',
-00020a50: 2027 7374 6f72 6167 6527 2c20 276c 7327   'storage', 'ls'
-00020a60: 5d29 2e64 6563 6f64 6528 2775 7466 2d38  ]).decode('utf-8
-00020a70: 2729 0a20 2020 2020 2020 2061 7373 6572  ').        asser
-00020a80: 7420 7374 6f72 6167 655f 6e61 6d65 2069  t storage_name i
-00020a90: 6e20 6f75 742c 2066 2753 746f 7261 6765  n out, f'Storage
-00020aa0: 207b 7374 6f72 6167 655f 6e61 6d65 7d20   {storage_name} 
-00020ab0: 6e6f 7420 666f 756e 6420 696e 2073 6b79  not found in sky
-00020ac0: 2073 746f 7261 6765 206c 732e 270a 0a20   storage ls.'.. 
-00020ad0: 2020 2040 7079 7465 7374 2e6d 6172 6b2e     @pytest.mark.
-00020ae0: 7061 7261 6d65 7472 697a 6528 2773 746f  parametrize('sto
-00020af0: 7265 5f74 7970 6527 2c20 5b0a 2020 2020  re_type', [.    
-00020b00: 2020 2020 7374 6f72 6167 655f 6c69 622e      storage_lib.
-00020b10: 5374 6f72 6554 7970 652e 5333 2c20 7374  StoreType.S3, st
-00020b20: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
-00020b30: 7970 652e 4743 532c 0a20 2020 2020 2020  ype.GCS,.       
-00020b40: 2070 7974 6573 742e 7061 7261 6d28 7374   pytest.param(st
-00020b50: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
-00020b60: 7970 652e 4942 4d2c 206d 6172 6b73 3d70  ype.IBM, marks=p
-00020b70: 7974 6573 742e 6d61 726b 2e69 626d 292c  ytest.mark.ibm),
-00020b80: 0a20 2020 2020 2020 2070 7974 6573 742e  .        pytest.
-00020b90: 7061 7261 6d28 7374 6f72 6167 655f 6c69  param(storage_li
-00020ba0: 622e 5374 6f72 6554 7970 652e 5232 2c20  b.StoreType.R2, 
-00020bb0: 6d61 726b 733d 7079 7465 7374 2e6d 6172  marks=pytest.mar
-00020bc0: 6b2e 636c 6f75 6466 6c61 7265 290a 2020  k.cloudflare).  
-00020bd0: 2020 5d29 0a20 2020 2064 6566 2074 6573    ]).    def tes
-00020be0: 745f 6c69 7374 5f73 6f75 7263 6528 7365  t_list_source(se
-00020bf0: 6c66 2c20 746d 705f 6c6f 6361 6c5f 6c69  lf, tmp_local_li
-00020c00: 7374 5f73 746f 7261 6765 5f6f 626a 2c20  st_storage_obj, 
-00020c10: 7374 6f72 655f 7479 7065 293a 0a20 2020  store_type):.   
-00020c20: 2020 2020 2023 2055 7365 7320 6120 6c69       # Uses a li
-00020c30: 7374 2069 6e20 7468 6520 736f 7572 6365  st in the source
-00020c40: 2066 6965 6c64 2074 6f20 7370 6563 6966   field to specif
-00020c50: 7920 6120 6669 6c65 2061 6e64 2061 2064  y a file and a d
-00020c60: 6972 6563 746f 7279 2074 6f0a 2020 2020  irectory to.    
-00020c70: 2020 2020 2320 6265 2075 706c 6f61 6465      # be uploade
-00020c80: 6420 746f 2074 6865 2073 746f 7261 6765  d to the storage
-00020c90: 206f 626a 6563 742e 0a20 2020 2020 2020   object..       
-00020ca0: 2074 6d70 5f6c 6f63 616c 5f6c 6973 745f   tmp_local_list_
-00020cb0: 7374 6f72 6167 655f 6f62 6a2e 6164 645f  storage_obj.add_
-00020cc0: 7374 6f72 6528 7374 6f72 655f 7479 7065  store(store_type
-00020cd0: 290a 0a20 2020 2020 2020 2023 2043 6865  )..        # Che
-00020ce0: 636b 2069 6620 746d 702d 6669 6c65 2065  ck if tmp-file e
-00020cf0: 7869 7374 7320 696e 2074 6865 2062 7563  xists in the buc
-00020d00: 6b65 7420 726f 6f74 2075 7369 6e67 2063  ket root using c
-00020d10: 6c69 0a20 2020 2020 2020 206f 7574 203d  li.        out =
-00020d20: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
-00020d30: 6b5f 6f75 7470 7574 2873 656c 662e 636c  k_output(self.cl
-00020d40: 695f 6c73 5f63 6d64 280a 2020 2020 2020  i_ls_cmd(.      
-00020d50: 2020 2020 2020 7374 6f72 655f 7479 7065        store_type
-00020d60: 2c20 746d 705f 6c6f 6361 6c5f 6c69 7374  , tmp_local_list
-00020d70: 5f73 746f 7261 6765 5f6f 626a 2e6e 616d  _storage_obj.nam
-00020d80: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
-00020d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020da0: 2020 2020 2020 2020 2020 7368 656c 6c3d            shell=
-00020db0: 5472 7565 290a 2020 2020 2020 2020 6173  True).        as
-00020dc0: 7365 7274 2027 746d 702d 6669 6c65 2720  sert 'tmp-file' 
-00020dd0: 696e 206f 7574 2e64 6563 6f64 6528 2775  in out.decode('u
-00020de0: 7466 2d38 2729 2c20 5c0a 2020 2020 2020  tf-8'), \.      
-00020df0: 2020 2020 2020 2746 696c 6520 6e6f 7420        'File not 
-00020e00: 666f 756e 6420 696e 2062 7563 6b65 7420  found in bucket 
-00020e10: 2d20 6f75 7470 7574 2077 6173 203a 207b  - output was : {
-00020e20: 7d27 2e66 6f72 6d61 7428 6f75 742e 6465  }'.format(out.de
-00020e30: 636f 6465 0a20 2020 2020 2020 2020 2020  code.           
-00020e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020e70: 2020 2020 2028 2775 7466 2d38 2729 290a       ('utf-8')).
-00020e80: 0a20 2020 2020 2020 2023 2043 6865 636b  .        # Check
-00020e90: 2069 6620 746d 702d 6669 6c65 2065 7869   if tmp-file exi
-00020ea0: 7374 7320 696e 2074 6865 2062 7563 6b65  sts in the bucke
-00020eb0: 742f 746d 702d 736f 7572 6365 2075 7369  t/tmp-source usi
-00020ec0: 6e67 2063 6c69 0a20 2020 2020 2020 206f  ng cli.        o
-00020ed0: 7574 203d 2073 7562 7072 6f63 6573 732e  ut = subprocess.
-00020ee0: 6368 6563 6b5f 6f75 7470 7574 2873 656c  check_output(sel
-00020ef0: 662e 636c 695f 6c73 5f63 6d64 280a 2020  f.cli_ls_cmd(.  
-00020f00: 2020 2020 2020 2020 2020 7374 6f72 655f            store_
-00020f10: 7479 7065 2c20 746d 705f 6c6f 6361 6c5f  type, tmp_local_
-00020f20: 6c69 7374 5f73 746f 7261 6765 5f6f 626a  list_storage_obj
-00020f30: 2e6e 616d 652c 2027 746d 702d 736f 7572  .name, 'tmp-sour
-00020f40: 6365 2f27 292c 0a20 2020 2020 2020 2020  ce/'),.         
-00020f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020f60: 2020 2020 2020 2020 2020 2020 2073 6865               she
-00020f70: 6c6c 3d54 7275 6529 0a20 2020 2020 2020  ll=True).       
-00020f80: 2061 7373 6572 7420 2774 6d70 2d66 696c   assert 'tmp-fil
-00020f90: 6527 2069 6e20 6f75 742e 6465 636f 6465  e' in out.decode
-00020fa0: 2827 7574 662d 3827 292c 205c 0a20 2020  ('utf-8'), \.   
-00020fb0: 2020 2020 2020 2020 2027 4669 6c65 206e           'File n
-00020fc0: 6f74 2066 6f75 6e64 2069 6e20 6275 636b  ot found in buck
-00020fd0: 6574 202d 206f 7574 7075 7420 7761 7320  et - output was 
-00020fe0: 3a20 7b7d 272e 666f 726d 6174 286f 7574  : {}'.format(out
-00020ff0: 2e64 6563 6f64 650a 2020 2020 2020 2020  .decode.        
-00021000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021030: 2020 2020 2020 2020 2827 7574 662d 3827          ('utf-8'
-00021040: 2929 0a0a 2020 2020 4070 7974 6573 742e  ))..    @pytest.
-00021050: 6d61 726b 2e70 6172 616d 6574 7269 7a65  mark.parametrize
-00021060: 2827 696e 7661 6c69 645f 6e61 6d65 5f6c  ('invalid_name_l
-00021070: 6973 742c 2073 746f 7265 5f74 7970 6527  ist, store_type'
-00021080: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00021090: 2020 2020 2020 2020 2020 2020 2020 205b                 [
-000210a0: 2841 5753 5f49 4e56 414c 4944 5f4e 414d  (AWS_INVALID_NAM
-000210b0: 4553 2c20 7374 6f72 6167 655f 6c69 622e  ES, storage_lib.
-000210c0: 5374 6f72 6554 7970 652e 5333 292c 0a20  StoreType.S3),. 
-000210d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000210e0: 2020 2020 2020 2020 2020 2020 2028 4743               (GC
-000210f0: 535f 494e 5641 4c49 445f 4e41 4d45 532c  S_INVALID_NAMES,
-00021100: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
-00021110: 7265 5479 7065 2e47 4353 292c 0a20 2020  reType.GCS),.   
-00021120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021130: 2020 2020 2020 2020 2020 2070 7974 6573             pytes
-00021140: 742e 7061 7261 6d28 4942 4d5f 494e 5641  t.param(IBM_INVA
-00021150: 4c49 445f 4e41 4d45 532c 0a20 2020 2020  LID_NAMES,.     
-00021160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021180: 2020 2020 2020 7374 6f72 6167 655f 6c69        storage_li
-00021190: 622e 5374 6f72 6554 7970 652e 4942 4d2c  b.StoreType.IBM,
-000211a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000211b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000211c0: 2020 2020 2020 2020 2020 2020 6d61 726b              mark
-000211d0: 733d 7079 7465 7374 2e6d 6172 6b2e 6962  s=pytest.mark.ib
-000211e0: 6d29 2c0a 2020 2020 2020 2020 2020 2020  m),.            
-000211f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021200: 2020 7079 7465 7374 2e70 6172 616d 2841    pytest.param(A
-00021210: 5753 5f49 4e56 414c 4944 5f4e 414d 4553  WS_INVALID_NAMES
-00021220: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00021230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021240: 2020 2020 2020 2020 2020 2020 2073 746f               sto
-00021250: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
-00021260: 7065 2e52 322c 0a20 2020 2020 2020 2020  pe.R2,.         
-00021270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021290: 2020 6d61 726b 733d 7079 7465 7374 2e6d    marks=pytest.m
-000212a0: 6172 6b2e 636c 6f75 6466 6c61 7265 295d  ark.cloudflare)]
-000212b0: 290a 2020 2020 6465 6620 7465 7374 5f69  ).    def test_i
-000212c0: 6e76 616c 6964 5f6e 616d 6573 2873 656c  nvalid_names(sel
-000212d0: 662c 2069 6e76 616c 6964 5f6e 616d 655f  f, invalid_name_
-000212e0: 6c69 7374 2c20 7374 6f72 655f 7479 7065  list, store_type
-000212f0: 293a 0a20 2020 2020 2020 2023 2055 7365  ):.        # Use
-00021300: 7320 6120 6c69 7374 2069 6e20 7468 6520  s a list in the 
-00021310: 736f 7572 6365 2066 6965 6c64 2074 6f20  source field to 
-00021320: 7370 6563 6966 7920 6120 6669 6c65 2061  specify a file a
-00021330: 6e64 2061 2064 6972 6563 746f 7279 2074  nd a directory t
-00021340: 6f0a 2020 2020 2020 2020 2320 6265 2075  o.        # be u
-00021350: 706c 6f61 6465 6420 746f 2074 6865 2073  ploaded to the s
-00021360: 746f 7261 6765 206f 626a 6563 742e 0a20  torage object.. 
-00021370: 2020 2020 2020 2066 6f72 206e 616d 6520         for name 
-00021380: 696e 2069 6e76 616c 6964 5f6e 616d 655f  in invalid_name_
-00021390: 6c69 7374 3a0a 2020 2020 2020 2020 2020  list:.          
-000213a0: 2020 7769 7468 2070 7974 6573 742e 7261    with pytest.ra
-000213b0: 6973 6573 2873 6b79 2e65 7863 6570 7469  ises(sky.excepti
-000213c0: 6f6e 732e 5374 6f72 6167 654e 616d 6545  ons.StorageNameE
-000213d0: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
-000213e0: 2020 2020 2020 2073 746f 7261 6765 5f6f         storage_o
-000213f0: 626a 203d 2073 746f 7261 6765 5f6c 6962  bj = storage_lib
-00021400: 2e53 746f 7261 6765 286e 616d 653d 6e61  .Storage(name=na
-00021410: 6d65 290a 2020 2020 2020 2020 2020 2020  me).            
-00021420: 2020 2020 7374 6f72 6167 655f 6f62 6a2e      storage_obj.
-00021430: 6164 645f 7374 6f72 6528 7374 6f72 655f  add_store(store_
-00021440: 7479 7065 290a 0a20 2020 2040 7079 7465  type)..    @pyte
-00021450: 7374 2e6d 6172 6b2e 7061 7261 6d65 7472  st.mark.parametr
-00021460: 697a 6528 0a20 2020 2020 2020 2027 6769  ize(.        'gi
-00021470: 7469 676e 6f72 655f 7374 7275 6374 7572  tignore_structur
-00021480: 652c 2073 746f 7265 5f74 7970 6527 2c0a  e, store_type',.
-00021490: 2020 2020 2020 2020 5b28 4749 5449 474e          [(GITIGN
-000214a0: 4f52 455f 5359 4e43 5f54 4553 545f 4449  ORE_SYNC_TEST_DI
-000214b0: 525f 5354 5255 4354 5552 452c 2073 746f  R_STRUCTURE, sto
-000214c0: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
-000214d0: 7065 2e53 3329 2c0a 2020 2020 2020 2020  pe.S3),.        
-000214e0: 2028 4749 5449 474e 4f52 455f 5359 4e43   (GITIGNORE_SYNC
-000214f0: 5f54 4553 545f 4449 525f 5354 5255 4354  _TEST_DIR_STRUCT
-00021500: 5552 452c 2073 746f 7261 6765 5f6c 6962  URE, storage_lib
-00021510: 2e53 746f 7265 5479 7065 2e47 4353 292c  .StoreType.GCS),
-00021520: 0a20 2020 2020 2020 2020 7079 7465 7374  .         pytest
-00021530: 2e70 6172 616d 2847 4954 4947 4e4f 5245  .param(GITIGNORE
-00021540: 5f53 594e 435f 5445 5354 5f44 4952 5f53  _SYNC_TEST_DIR_S
-00021550: 5452 5543 5455 5245 2c0a 2020 2020 2020  TRUCTURE,.      
+0001b980: 7065 2e53 333a 0a20 2020 2020 2020 2020  pe.S3:.         
+0001b990: 2020 2075 726c 203d 2066 2773 333a 2f2f     url = f's3://
+0001b9a0: 7b62 7563 6b65 745f 6e61 6d65 7d27 0a20  {bucket_name}'. 
+0001b9b0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0001b9c0: 6e20 6627 6177 7320 7333 2072 6220 7b75  n f'aws s3 rb {u
+0001b9d0: 726c 7d20 2d2d 666f 7263 6527 0a20 2020  rl} --force'.   
+0001b9e0: 2020 2020 2069 6620 7374 6f72 655f 7479       if store_ty
+0001b9f0: 7065 203d 3d20 7374 6f72 6167 655f 6c69  pe == storage_li
+0001ba00: 622e 5374 6f72 6554 7970 652e 4743 533a  b.StoreType.GCS:
+0001ba10: 0a20 2020 2020 2020 2020 2020 2075 726c  .            url
+0001ba20: 203d 2066 2767 733a 2f2f 7b62 7563 6b65   = f'gs://{bucke
+0001ba30: 745f 6e61 6d65 7d27 0a20 2020 2020 2020  t_name}'.       
+0001ba40: 2020 2020 2067 7375 7469 6c5f 616c 6961       gsutil_alia
+0001ba50: 732c 2061 6c69 6173 5f67 656e 203d 2064  s, alias_gen = d
+0001ba60: 6174 615f 7574 696c 732e 6765 745f 6773  ata_utils.get_gs
+0001ba70: 7574 696c 5f63 6f6d 6d61 6e64 2829 0a20  util_command(). 
+0001ba80: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0001ba90: 6e20 6627 7b61 6c69 6173 5f67 656e 7d3b  n f'{alias_gen};
+0001baa0: 207b 6773 7574 696c 5f61 6c69 6173 7d20   {gsutil_alias} 
+0001bab0: 726d 202d 7220 7b75 726c 7d27 0a20 2020  rm -r {url}'.   
+0001bac0: 2020 2020 2069 6620 7374 6f72 655f 7479       if store_ty
+0001bad0: 7065 203d 3d20 7374 6f72 6167 655f 6c69  pe == storage_li
+0001bae0: 622e 5374 6f72 6554 7970 652e 5232 3a0a  b.StoreType.R2:.
+0001baf0: 2020 2020 2020 2020 2020 2020 656e 6470              endp
+0001bb00: 6f69 6e74 5f75 726c 203d 2063 6c6f 7564  oint_url = cloud
+0001bb10: 666c 6172 652e 6372 6561 7465 5f65 6e64  flare.create_end
+0001bb20: 706f 696e 7428 290a 2020 2020 2020 2020  point().        
+0001bb30: 2020 2020 7572 6c20 3d20 6627 7333 3a2f      url = f's3:/
+0001bb40: 2f7b 6275 636b 6574 5f6e 616d 657d 270a  /{bucket_name}'.
+0001bb50: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0001bb60: 726e 2066 2741 5753 5f53 4841 5245 445f  rn f'AWS_SHARED_
+0001bb70: 4352 4544 454e 5449 414c 535f 4649 4c45  CREDENTIALS_FILE
+0001bb80: 3d7b 636c 6f75 6466 6c61 7265 2e52 325f  ={cloudflare.R2_
+0001bb90: 4352 4544 454e 5449 414c 535f 5041 5448  CREDENTIALS_PATH
+0001bba0: 7d20 6177 7320 7333 2072 6220 7b75 726c  } aws s3 rb {url
+0001bbb0: 7d20 2d2d 666f 7263 6520 2d2d 656e 6470  } --force --endp
+0001bbc0: 6f69 6e74 207b 656e 6470 6f69 6e74 5f75  oint {endpoint_u
+0001bbd0: 726c 7d20 2d2d 7072 6f66 696c 653d 7232  rl} --profile=r2
+0001bbe0: 270a 2020 2020 2020 2020 6966 2073 746f  '.        if sto
+0001bbf0: 7265 5f74 7970 6520 3d3d 2073 746f 7261  re_type == stora
+0001bc00: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
+0001bc10: 2e49 424d 3a0a 2020 2020 2020 2020 2020  .IBM:.          
+0001bc20: 2020 6275 636b 6574 5f72 636c 6f6e 655f    bucket_rclone_
+0001bc30: 7072 6f66 696c 6520 3d20 5263 6c6f 6e65  profile = Rclone
+0001bc40: 2e67 656e 6572 6174 655f 7263 6c6f 6e65  .generate_rclone
+0001bc50: 5f62 7563 6b65 745f 7072 6f66 696c 655f  _bucket_profile_
+0001bc60: 6e61 6d65 280a 2020 2020 2020 2020 2020  name(.          
+0001bc70: 2020 2020 2020 6275 636b 6574 5f6e 616d        bucket_nam
+0001bc80: 652c 2052 636c 6f6e 652e 5263 6c6f 6e65  e, Rclone.Rclone
+0001bc90: 436c 6f75 6473 2e49 424d 290a 2020 2020  Clouds.IBM).    
+0001bca0: 2020 2020 2020 2020 7265 7475 726e 2066          return f
+0001bcb0: 2772 636c 6f6e 6520 7075 7267 6520 7b62  'rclone purge {b
+0001bcc0: 7563 6b65 745f 7263 6c6f 6e65 5f70 726f  ucket_rclone_pro
+0001bcd0: 6669 6c65 7d3a 7b62 7563 6b65 745f 6e61  file}:{bucket_na
+0001bce0: 6d65 7d20 2626 2072 636c 6f6e 6520 636f  me} && rclone co
+0001bcf0: 6e66 6967 2064 656c 6574 6520 7b62 7563  nfig delete {buc
+0001bd00: 6b65 745f 7263 6c6f 6e65 5f70 726f 6669  ket_rclone_profi
+0001bd10: 6c65 7d27 0a0a 2020 2020 4073 7461 7469  le}'..    @stati
+0001bd20: 636d 6574 686f 640a 2020 2020 6465 6620  cmethod.    def 
+0001bd30: 636c 695f 6c73 5f63 6d64 2873 746f 7265  cli_ls_cmd(store
+0001bd40: 5f74 7970 652c 2062 7563 6b65 745f 6e61  _type, bucket_na
+0001bd50: 6d65 2c20 7375 6666 6978 3d27 2729 3a0a  me, suffix=''):.
+0001bd60: 2020 2020 2020 2020 6966 2073 746f 7265          if store
+0001bd70: 5f74 7970 6520 3d3d 2073 746f 7261 6765  _type == storage
+0001bd80: 5f6c 6962 2e53 746f 7265 5479 7065 2e53  _lib.StoreType.S
+0001bd90: 333a 0a20 2020 2020 2020 2020 2020 2069  3:.            i
+0001bda0: 6620 7375 6666 6978 3a0a 2020 2020 2020  f suffix:.      
+0001bdb0: 2020 2020 2020 2020 2020 7572 6c20 3d20            url = 
+0001bdc0: 6627 7333 3a2f 2f7b 6275 636b 6574 5f6e  f's3://{bucket_n
+0001bdd0: 616d 657d 2f7b 7375 6666 6978 7d27 0a20  ame}/{suffix}'. 
+0001bde0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0001bdf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001be00: 2075 726c 203d 2066 2773 333a 2f2f 7b62   url = f's3://{b
+0001be10: 7563 6b65 745f 6e61 6d65 7d27 0a20 2020  ucket_name}'.   
+0001be20: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0001be30: 6627 6177 7320 7333 206c 7320 7b75 726c  f'aws s3 ls {url
+0001be40: 7d27 0a20 2020 2020 2020 2069 6620 7374  }'.        if st
+0001be50: 6f72 655f 7479 7065 203d 3d20 7374 6f72  ore_type == stor
+0001be60: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+0001be70: 652e 4743 533a 0a20 2020 2020 2020 2020  e.GCS:.         
+0001be80: 2020 2069 6620 7375 6666 6978 3a0a 2020     if suffix:.  
+0001be90: 2020 2020 2020 2020 2020 2020 2020 7572                ur
+0001bea0: 6c20 3d20 6627 6773 3a2f 2f7b 6275 636b  l = f'gs://{buck
+0001beb0: 6574 5f6e 616d 657d 2f7b 7375 6666 6978  et_name}/{suffix
+0001bec0: 7d27 0a20 2020 2020 2020 2020 2020 2065  }'.            e
+0001bed0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0001bee0: 2020 2020 2075 726c 203d 2066 2767 733a       url = f'gs:
+0001bef0: 2f2f 7b62 7563 6b65 745f 6e61 6d65 7d27  //{bucket_name}'
+0001bf00: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0001bf10: 7572 6e20 6627 6773 7574 696c 206c 7320  urn f'gsutil ls 
+0001bf20: 7b75 726c 7d27 0a20 2020 2020 2020 2069  {url}'.        i
+0001bf30: 6620 7374 6f72 655f 7479 7065 203d 3d20  f store_type == 
+0001bf40: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+0001bf50: 6554 7970 652e 5232 3a0a 2020 2020 2020  eType.R2:.      
+0001bf60: 2020 2020 2020 656e 6470 6f69 6e74 5f75        endpoint_u
+0001bf70: 726c 203d 2063 6c6f 7564 666c 6172 652e  rl = cloudflare.
+0001bf80: 6372 6561 7465 5f65 6e64 706f 696e 7428  create_endpoint(
+0001bf90: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+0001bfa0: 2073 7566 6669 783a 0a20 2020 2020 2020   suffix:.       
+0001bfb0: 2020 2020 2020 2020 2075 726c 203d 2066           url = f
+0001bfc0: 2773 333a 2f2f 7b62 7563 6b65 745f 6e61  's3://{bucket_na
+0001bfd0: 6d65 7d2f 7b73 7566 6669 787d 270a 2020  me}/{suffix}'.  
+0001bfe0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+0001bff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c000: 7572 6c20 3d20 6627 7333 3a2f 2f7b 6275  url = f's3://{bu
+0001c010: 636b 6574 5f6e 616d 657d 270a 2020 2020  cket_name}'.    
+0001c020: 2020 2020 2020 2020 7265 7475 726e 2066          return f
+0001c030: 2741 5753 5f53 4841 5245 445f 4352 4544  'AWS_SHARED_CRED
+0001c040: 454e 5449 414c 535f 4649 4c45 3d7b 636c  ENTIALS_FILE={cl
+0001c050: 6f75 6466 6c61 7265 2e52 325f 4352 4544  oudflare.R2_CRED
+0001c060: 454e 5449 414c 535f 5041 5448 7d20 6177  ENTIALS_PATH} aw
+0001c070: 7320 7333 206c 7320 7b75 726c 7d20 2d2d  s s3 ls {url} --
+0001c080: 656e 6470 6f69 6e74 207b 656e 6470 6f69  endpoint {endpoi
+0001c090: 6e74 5f75 726c 7d20 2d2d 7072 6f66 696c  nt_url} --profil
+0001c0a0: 653d 7232 270a 2020 2020 2020 2020 6966  e=r2'.        if
+0001c0b0: 2073 746f 7265 5f74 7970 6520 3d3d 2073   store_type == s
+0001c0c0: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
+0001c0d0: 5479 7065 2e49 424d 3a0a 2020 2020 2020  Type.IBM:.      
+0001c0e0: 2020 2020 2020 6275 636b 6574 5f72 636c        bucket_rcl
+0001c0f0: 6f6e 655f 7072 6f66 696c 6520 3d20 5263  one_profile = Rc
+0001c100: 6c6f 6e65 2e67 656e 6572 6174 655f 7263  lone.generate_rc
+0001c110: 6c6f 6e65 5f62 7563 6b65 745f 7072 6f66  lone_bucket_prof
+0001c120: 696c 655f 6e61 6d65 280a 2020 2020 2020  ile_name(.      
+0001c130: 2020 2020 2020 2020 2020 6275 636b 6574            bucket
+0001c140: 5f6e 616d 652c 2052 636c 6f6e 652e 5263  _name, Rclone.Rc
+0001c150: 6c6f 6e65 436c 6f75 6473 2e49 424d 290a  loneClouds.IBM).
+0001c160: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0001c170: 726e 2066 2772 636c 6f6e 6520 6c73 207b  rn f'rclone ls {
+0001c180: 6275 636b 6574 5f72 636c 6f6e 655f 7072  bucket_rclone_pr
+0001c190: 6f66 696c 657d 3a7b 6275 636b 6574 5f6e  ofile}:{bucket_n
+0001c1a0: 616d 657d 2f7b 7375 6666 6978 7d27 0a0a  ame}/{suffix}'..
+0001c1b0: 2020 2020 4073 7461 7469 636d 6574 686f      @staticmetho
+0001c1c0: 640a 2020 2020 6465 6620 636c 695f 636f  d.    def cli_co
+0001c1d0: 756e 745f 6e61 6d65 5f69 6e5f 6275 636b  unt_name_in_buck
+0001c1e0: 6574 2873 746f 7265 5f74 7970 652c 2062  et(store_type, b
+0001c1f0: 7563 6b65 745f 6e61 6d65 2c20 6669 6c65  ucket_name, file
+0001c200: 5f6e 616d 652c 2073 7566 6669 783d 2727  _name, suffix=''
+0001c210: 293a 0a20 2020 2020 2020 2069 6620 7374  ):.        if st
+0001c220: 6f72 655f 7479 7065 203d 3d20 7374 6f72  ore_type == stor
+0001c230: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+0001c240: 652e 5333 3a0a 2020 2020 2020 2020 2020  e.S3:.          
+0001c250: 2020 6966 2073 7566 6669 783a 0a20 2020    if suffix:.   
+0001c260: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+0001c270: 7572 6e20 6627 6177 7320 7333 6170 6920  urn f'aws s3api 
+0001c280: 6c69 7374 2d6f 626a 6563 7473 202d 2d62  list-objects --b
+0001c290: 7563 6b65 7420 227b 6275 636b 6574 5f6e  ucket "{bucket_n
+0001c2a0: 616d 657d 2220 2d2d 7072 6566 6978 207b  ame}" --prefix {
+0001c2b0: 7375 6666 6978 7d20 2d2d 7175 6572 7920  suffix} --query 
+0001c2c0: 226c 656e 6774 6828 436f 6e74 656e 7473  "length(Contents
+0001c2d0: 5b3f 636f 6e74 6169 6e73 284b 6579 2c5c  [?contains(Key,\
+0001c2e0: 277b 6669 6c65 5f6e 616d 657d 5c27 295d  '{file_name}\')]
+0001c2f0: 2e4b 6579 2922 270a 2020 2020 2020 2020  .Key)"'.        
+0001c300: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0001c310: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0001c320: 2066 2761 7773 2073 3361 7069 206c 6973   f'aws s3api lis
+0001c330: 742d 6f62 6a65 6374 7320 2d2d 6275 636b  t-objects --buck
+0001c340: 6574 2022 7b62 7563 6b65 745f 6e61 6d65  et "{bucket_name
+0001c350: 7d22 202d 2d71 7565 7279 2022 6c65 6e67  }" --query "leng
+0001c360: 7468 2843 6f6e 7465 6e74 735b 3f63 6f6e  th(Contents[?con
+0001c370: 7461 696e 7328 4b65 792c 5c27 7b66 696c  tains(Key,\'{fil
+0001c380: 655f 6e61 6d65 7d5c 2729 5d2e 4b65 7929  e_name}\')].Key)
+0001c390: 2227 0a20 2020 2020 2020 2065 6c69 6620  "'.        elif 
+0001c3a0: 7374 6f72 655f 7479 7065 203d 3d20 7374  store_type == st
+0001c3b0: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+0001c3c0: 7970 652e 4743 533a 0a20 2020 2020 2020  ype.GCS:.       
+0001c3d0: 2020 2020 2069 6620 7375 6666 6978 3a0a       if suffix:.
+0001c3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c3f0: 7265 7475 726e 2066 2767 7375 7469 6c20  return f'gsutil 
+0001c400: 6c73 202d 7220 6773 3a2f 2f7b 6275 636b  ls -r gs://{buck
+0001c410: 6574 5f6e 616d 657d 2f7b 7375 6666 6978  et_name}/{suffix
+0001c420: 7d20 7c20 6772 6570 2022 7b66 696c 655f  } | grep "{file_
+0001c430: 6e61 6d65 7d22 207c 2077 6320 2d6c 270a  name}" | wc -l'.
+0001c440: 2020 2020 2020 2020 2020 2020 656c 7365              else
+0001c450: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001c460: 2020 7265 7475 726e 2066 2767 7375 7469    return f'gsuti
+0001c470: 6c20 6c73 202d 7220 6773 3a2f 2f7b 6275  l ls -r gs://{bu
+0001c480: 636b 6574 5f6e 616d 657d 207c 2067 7265  cket_name} | gre
+0001c490: 7020 227b 6669 6c65 5f6e 616d 657d 2220  p "{file_name}" 
+0001c4a0: 7c20 7763 202d 6c27 0a20 2020 2020 2020  | wc -l'.       
+0001c4b0: 2065 6c69 6620 7374 6f72 655f 7479 7065   elif store_type
+0001c4c0: 203d 3d20 7374 6f72 6167 655f 6c69 622e   == storage_lib.
+0001c4d0: 5374 6f72 6554 7970 652e 5232 3a0a 2020  StoreType.R2:.  
+0001c4e0: 2020 2020 2020 2020 2020 656e 6470 6f69            endpoi
+0001c4f0: 6e74 5f75 726c 203d 2063 6c6f 7564 666c  nt_url = cloudfl
+0001c500: 6172 652e 6372 6561 7465 5f65 6e64 706f  are.create_endpo
+0001c510: 696e 7428 290a 2020 2020 2020 2020 2020  int().          
+0001c520: 2020 6966 2073 7566 6669 783a 0a20 2020    if suffix:.   
+0001c530: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+0001c540: 7572 6e20 6627 4157 535f 5348 4152 4544  urn f'AWS_SHARED
+0001c550: 5f43 5245 4445 4e54 4941 4c53 5f46 494c  _CREDENTIALS_FIL
+0001c560: 453d 7b63 6c6f 7564 666c 6172 652e 5232  E={cloudflare.R2
+0001c570: 5f43 5245 4445 4e54 4941 4c53 5f50 4154  _CREDENTIALS_PAT
+0001c580: 487d 2061 7773 2073 3361 7069 206c 6973  H} aws s3api lis
+0001c590: 742d 6f62 6a65 6374 7320 2d2d 6275 636b  t-objects --buck
+0001c5a0: 6574 2022 7b62 7563 6b65 745f 6e61 6d65  et "{bucket_name
+0001c5b0: 7d22 202d 2d70 7265 6669 7820 7b73 7566  }" --prefix {suf
+0001c5c0: 6669 787d 202d 2d71 7565 7279 2022 6c65  fix} --query "le
+0001c5d0: 6e67 7468 2843 6f6e 7465 6e74 735b 3f63  ngth(Contents[?c
+0001c5e0: 6f6e 7461 696e 7328 4b65 792c 5c27 7b66  ontains(Key,\'{f
+0001c5f0: 696c 655f 6e61 6d65 7d5c 2729 5d2e 4b65  ile_name}\')].Ke
+0001c600: 7929 2220 2d2d 656e 6470 6f69 6e74 207b  y)" --endpoint {
+0001c610: 656e 6470 6f69 6e74 5f75 726c 7d20 2d2d  endpoint_url} --
+0001c620: 7072 6f66 696c 653d 7232 270a 2020 2020  profile=r2'.    
+0001c630: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0001c640: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0001c650: 7475 726e 2066 2741 5753 5f53 4841 5245  turn f'AWS_SHARE
+0001c660: 445f 4352 4544 454e 5449 414c 535f 4649  D_CREDENTIALS_FI
+0001c670: 4c45 3d7b 636c 6f75 6466 6c61 7265 2e52  LE={cloudflare.R
+0001c680: 325f 4352 4544 454e 5449 414c 535f 5041  2_CREDENTIALS_PA
+0001c690: 5448 7d20 6177 7320 7333 6170 6920 6c69  TH} aws s3api li
+0001c6a0: 7374 2d6f 626a 6563 7473 202d 2d62 7563  st-objects --buc
+0001c6b0: 6b65 7420 227b 6275 636b 6574 5f6e 616d  ket "{bucket_nam
+0001c6c0: 657d 2220 2d2d 7175 6572 7920 226c 656e  e}" --query "len
+0001c6d0: 6774 6828 436f 6e74 656e 7473 5b3f 636f  gth(Contents[?co
+0001c6e0: 6e74 6169 6e73 284b 6579 2c5c 277b 6669  ntains(Key,\'{fi
+0001c6f0: 6c65 5f6e 616d 657d 5c27 295d 2e4b 6579  le_name}\')].Key
+0001c700: 2922 202d 2d65 6e64 706f 696e 7420 7b65  )" --endpoint {e
+0001c710: 6e64 706f 696e 745f 7572 6c7d 202d 2d70  ndpoint_url} --p
+0001c720: 726f 6669 6c65 3d72 3227 0a0a 2020 2020  rofile=r2'..    
+0001c730: 4073 7461 7469 636d 6574 686f 640a 2020  @staticmethod.  
+0001c740: 2020 6465 6620 636c 695f 636f 756e 745f    def cli_count_
+0001c750: 6669 6c65 5f69 6e5f 6275 636b 6574 2873  file_in_bucket(s
+0001c760: 746f 7265 5f74 7970 652c 2062 7563 6b65  tore_type, bucke
+0001c770: 745f 6e61 6d65 293a 0a20 2020 2020 2020  t_name):.       
+0001c780: 2069 6620 7374 6f72 655f 7479 7065 203d   if store_type =
+0001c790: 3d20 7374 6f72 6167 655f 6c69 622e 5374  = storage_lib.St
+0001c7a0: 6f72 6554 7970 652e 5333 3a0a 2020 2020  oreType.S3:.    
+0001c7b0: 2020 2020 2020 2020 7265 7475 726e 2066          return f
+0001c7c0: 2761 7773 2073 3320 6c73 2073 333a 2f2f  'aws s3 ls s3://
+0001c7d0: 7b62 7563 6b65 745f 6e61 6d65 7d20 2d2d  {bucket_name} --
+0001c7e0: 7265 6375 7273 6976 6520 7c20 7763 202d  recursive | wc -
+0001c7f0: 6c27 0a20 2020 2020 2020 2065 6c69 6620  l'.        elif 
+0001c800: 7374 6f72 655f 7479 7065 203d 3d20 7374  store_type == st
+0001c810: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+0001c820: 7970 652e 4743 533a 0a20 2020 2020 2020  ype.GCS:.       
+0001c830: 2020 2020 2072 6574 7572 6e20 6627 6773       return f'gs
+0001c840: 7574 696c 206c 7320 2d72 2067 733a 2f2f  util ls -r gs://
+0001c850: 7b62 7563 6b65 745f 6e61 6d65 7d2f 2a2a  {bucket_name}/**
+0001c860: 207c 2077 6320 2d6c 270a 2020 2020 2020   | wc -l'.      
+0001c870: 2020 656c 6966 2073 746f 7265 5f74 7970    elif store_typ
+0001c880: 6520 3d3d 2073 746f 7261 6765 5f6c 6962  e == storage_lib
+0001c890: 2e53 746f 7265 5479 7065 2e52 323a 0a20  .StoreType.R2:. 
+0001c8a0: 2020 2020 2020 2020 2020 2065 6e64 706f             endpo
+0001c8b0: 696e 745f 7572 6c20 3d20 636c 6f75 6466  int_url = cloudf
+0001c8c0: 6c61 7265 2e63 7265 6174 655f 656e 6470  lare.create_endp
+0001c8d0: 6f69 6e74 2829 0a20 2020 2020 2020 2020  oint().         
+0001c8e0: 2020 2072 6574 7572 6e20 6627 4157 535f     return f'AWS_
+0001c8f0: 5348 4152 4544 5f43 5245 4445 4e54 4941  SHARED_CREDENTIA
+0001c900: 4c53 5f46 494c 453d 7b63 6c6f 7564 666c  LS_FILE={cloudfl
+0001c910: 6172 652e 5232 5f43 5245 4445 4e54 4941  are.R2_CREDENTIA
+0001c920: 4c53 5f50 4154 487d 2061 7773 2073 3320  LS_PATH} aws s3 
+0001c930: 6c73 2073 333a 2f2f 7b62 7563 6b65 745f  ls s3://{bucket_
+0001c940: 6e61 6d65 7d20 2d2d 7265 6375 7273 6976  name} --recursiv
+0001c950: 6520 2d2d 656e 6470 6f69 6e74 207b 656e  e --endpoint {en
+0001c960: 6470 6f69 6e74 5f75 726c 7d20 2d2d 7072  dpoint_url} --pr
+0001c970: 6f66 696c 653d 7232 207c 2077 6320 2d6c  ofile=r2 | wc -l
+0001c980: 270a 0a20 2020 2040 7079 7465 7374 2e66  '..    @pytest.f
+0001c990: 6978 7475 7265 0a20 2020 2064 6566 2074  ixture.    def t
+0001c9a0: 6d70 5f73 6f75 7263 6528 7365 6c66 2c20  mp_source(self, 
+0001c9b0: 746d 705f 7061 7468 293a 0a20 2020 2020  tmp_path):.     
+0001c9c0: 2020 2023 2043 7265 6174 6573 2061 2074     # Creates a t
+0001c9d0: 656d 706f 7261 7279 2064 6972 6563 746f  emporary directo
+0001c9e0: 7279 2077 6974 6820 6120 6669 6c65 2069  ry with a file i
+0001c9f0: 6e20 6974 0a20 2020 2020 2020 2074 6d70  n it.        tmp
+0001ca00: 5f64 6972 203d 2074 6d70 5f70 6174 6820  _dir = tmp_path 
+0001ca10: 2f20 2774 6d70 2d73 6f75 7263 6527 0a20  / 'tmp-source'. 
+0001ca20: 2020 2020 2020 2074 6d70 5f64 6972 2e6d         tmp_dir.m
+0001ca30: 6b64 6972 2829 0a20 2020 2020 2020 2074  kdir().        t
+0001ca40: 6d70 5f66 696c 6520 3d20 746d 705f 6469  mp_file = tmp_di
+0001ca50: 7220 2f20 2774 6d70 2d66 696c 6527 0a20  r / 'tmp-file'. 
+0001ca60: 2020 2020 2020 2074 6d70 5f66 696c 652e         tmp_file.
+0001ca70: 7772 6974 655f 7465 7874 2827 7465 7374  write_text('test
+0001ca80: 2729 0a20 2020 2020 2020 2063 6972 636c  ').        circl
+0001ca90: 655f 6c69 6e6b 203d 2074 6d70 5f64 6972  e_link = tmp_dir
+0001caa0: 202f 2027 6369 7263 6c65 2d6c 696e 6b27   / 'circle-link'
+0001cab0: 0a20 2020 2020 2020 2063 6972 636c 655f  .        circle_
+0001cac0: 6c69 6e6b 2e73 796d 6c69 6e6b 5f74 6f28  link.symlink_to(
+0001cad0: 746d 705f 6469 722c 2074 6172 6765 745f  tmp_dir, target_
+0001cae0: 6973 5f64 6972 6563 746f 7279 3d54 7275  is_directory=Tru
+0001caf0: 6529 0a20 2020 2020 2020 2079 6965 6c64  e).        yield
+0001cb00: 2073 7472 2874 6d70 5f64 6972 290a 0a20   str(tmp_dir).. 
+0001cb10: 2020 2040 7079 7465 7374 2e66 6978 7475     @pytest.fixtu
+0001cb20: 7265 0a20 2020 2064 6566 2074 6d70 5f62  re.    def tmp_b
+0001cb30: 7563 6b65 745f 6e61 6d65 2873 656c 6629  ucket_name(self)
+0001cb40: 3a0a 2020 2020 2020 2020 2320 4372 6561  :.        # Crea
+0001cb50: 7465 7320 6120 7465 6d70 6f72 6172 7920  tes a temporary 
+0001cb60: 6275 636b 6574 206e 616d 650a 2020 2020  bucket name.    
+0001cb70: 2020 2020 2320 7469 6d65 2e74 696d 6528      # time.time(
+0001cb80: 2920 7265 7475 726e 7320 7661 7279 696e  ) returns varyin
+0001cb90: 6720 7072 6563 6973 696f 6e20 6f6e 2064  g precision on d
+0001cba0: 6966 6665 7265 6e74 2073 7973 7465 6d73  ifferent systems
+0001cbb0: 2c20 736f 2077 650a 2020 2020 2020 2020  , so we.        
+0001cbc0: 2320 7265 706c 6163 6520 7468 6520 6465  # replace the de
+0001cbd0: 6369 6d61 6c20 706f 696e 7420 616e 6420  cimal point and 
+0001cbe0: 7573 6520 7768 6174 6576 6572 2070 7265  use whatever pre
+0001cbf0: 6369 7369 6f6e 2077 6520 6361 6e20 6765  cision we can ge
+0001cc00: 742e 0a20 2020 2020 2020 2074 696d 6573  t..        times
+0001cc10: 7461 6d70 203d 2073 7472 2874 696d 652e  tamp = str(time.
+0001cc20: 7469 6d65 2829 292e 7265 706c 6163 6528  time()).replace(
+0001cc30: 272e 272c 2027 2729 0a20 2020 2020 2020  '.', '').       
+0001cc40: 2079 6965 6c64 2066 2773 6b79 2d74 6573   yield f'sky-tes
+0001cc50: 742d 7b74 696d 6573 7461 6d70 7d27 0a0a  t-{timestamp}'..
+0001cc60: 2020 2020 4073 7461 7469 636d 6574 686f      @staticmetho
+0001cc70: 640a 2020 2020 6465 6620 7969 656c 645f  d.    def yield_
+0001cc80: 7374 6f72 6167 655f 6f62 6a65 6374 280a  storage_object(.
+0001cc90: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
+0001cca0: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d20  : Optional[str] 
+0001ccb0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+0001ccc0: 2020 2020 736f 7572 6365 3a20 4f70 7469      source: Opti
+0001ccd0: 6f6e 616c 5b73 746f 7261 6765 5f6c 6962  onal[storage_lib
+0001cce0: 2e50 6174 685d 203d 204e 6f6e 652c 0a20  .Path] = None,. 
+0001ccf0: 2020 2020 2020 2020 2020 2073 746f 7265             store
+0001cd00: 733a 204f 7074 696f 6e61 6c5b 4469 6374  s: Optional[Dict
+0001cd10: 5b73 746f 7261 6765 5f6c 6962 2e53 746f  [storage_lib.Sto
+0001cd20: 7265 5479 7065 2c0a 2020 2020 2020 2020  reType,.        
+0001cd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cd40: 2020 2020 2020 2020 2020 7374 6f72 6167            storag
+0001cd50: 655f 6c69 622e 4162 7374 7261 6374 5374  e_lib.AbstractSt
+0001cd60: 6f72 655d 5d20 3d20 4e6f 6e65 2c0a 2020  ore]] = None,.  
+0001cd70: 2020 2020 2020 2020 2020 7065 7273 6973            persis
+0001cd80: 7465 6e74 3a20 4f70 7469 6f6e 616c 5b62  tent: Optional[b
+0001cd90: 6f6f 6c5d 203d 2054 7275 652c 0a20 2020  ool] = True,.   
+0001cda0: 2020 2020 2020 2020 206d 6f64 653a 2073           mode: s
+0001cdb0: 746f 7261 6765 5f6c 6962 2e53 746f 7261  torage_lib.Stora
+0001cdc0: 6765 4d6f 6465 203d 2073 746f 7261 6765  geMode = storage
+0001cdd0: 5f6c 6962 2e53 746f 7261 6765 4d6f 6465  _lib.StorageMode
+0001cde0: 2e4d 4f55 4e54 293a 0a20 2020 2020 2020  .MOUNT):.       
+0001cdf0: 2023 2043 7265 6174 6573 2061 2074 656d   # Creates a tem
+0001ce00: 706f 7261 7279 2073 746f 7261 6765 206f  porary storage o
+0001ce10: 626a 6563 742e 2053 746f 7265 7320 6d75  bject. Stores mu
+0001ce20: 7374 2062 6520 6164 6465 6420 696e 2074  st be added in t
+0001ce30: 6865 2074 6573 742e 0a20 2020 2020 2020  he test..       
+0001ce40: 2073 746f 7261 6765 5f6f 626a 203d 2073   storage_obj = s
+0001ce50: 746f 7261 6765 5f6c 6962 2e53 746f 7261  torage_lib.Stora
+0001ce60: 6765 286e 616d 653d 6e61 6d65 2c0a 2020  ge(name=name,.  
+0001ce70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ce80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ce90: 2020 2020 2020 2020 736f 7572 6365 3d73          source=s
+0001cea0: 6f75 7263 652c 0a20 2020 2020 2020 2020  ource,.         
+0001ceb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ced0: 2073 746f 7265 733d 7374 6f72 6573 2c0a   stores=stores,.
+0001cee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cf00: 2020 2020 2020 2020 2020 7065 7273 6973            persis
+0001cf10: 7465 6e74 3d70 6572 7369 7374 656e 742c  tent=persistent,
+0001cf20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001cf30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cf40: 2020 2020 2020 2020 2020 206d 6f64 653d             mode=
+0001cf50: 6d6f 6465 290a 2020 2020 2020 2020 7969  mode).        yi
+0001cf60: 656c 6420 7374 6f72 6167 655f 6f62 6a0a  eld storage_obj.
+0001cf70: 2020 2020 2020 2020 6861 6e64 6c65 203d          handle =
+0001cf80: 2067 6c6f 6261 6c5f 7573 6572 5f73 7461   global_user_sta
+0001cf90: 7465 2e67 6574 5f68 616e 646c 655f 6672  te.get_handle_fr
+0001cfa0: 6f6d 5f73 746f 7261 6765 5f6e 616d 6528  om_storage_name(
+0001cfb0: 0a20 2020 2020 2020 2020 2020 2073 746f  .            sto
+0001cfc0: 7261 6765 5f6f 626a 2e6e 616d 6529 0a20  rage_obj.name). 
+0001cfd0: 2020 2020 2020 2069 6620 6861 6e64 6c65         if handle
+0001cfe0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+0001cff0: 4966 2068 616e 646c 6520 6578 6973 7473  If handle exists
+0001d000: 2c20 6465 6c65 7465 206d 616e 7561 6c6c  , delete manuall
+0001d010: 790a 2020 2020 2020 2020 2020 2020 2320  y.            # 
+0001d020: 544f 444f 2872 6f6d 696c 6229 3a20 5468  TODO(romilb): Th
+0001d030: 6973 2069 7320 706f 7465 6e74 6961 6c6c  is is potentiall
+0001d040: 7920 7269 736b 7920 2d20 6966 2074 6865  y risky - if the
+0001d050: 2064 656c 6574 6520 6d65 7468 6f64 2068   delete method h
+0001d060: 6173 0a20 2020 2020 2020 2020 2020 2023  as.            #
+0001d070: 2020 2062 7567 732c 2074 6869 7320 6361     bugs, this ca
+0001d080: 6e20 6361 7573 6520 7265 736f 7572 6365  n cause resource
+0001d090: 206c 6561 6b73 2e20 4964 6561 6c6c 7920   leaks. Ideally 
+0001d0a0: 7765 2073 686f 756c 6420 6d61 6e75 616c  we should manual
+0001d0b0: 6c79 0a20 2020 2020 2020 2020 2020 2023  ly.            #
+0001d0c0: 2020 2065 6a65 6374 2073 746f 7261 6765     eject storage
+0001d0d0: 2066 726f 6d20 676c 6f62 616c 5f75 7365   from global_use
+0001d0e0: 725f 7374 6174 6520 616e 6420 6465 6c65  r_state and dele
+0001d0f0: 7465 2074 6865 2062 7563 6b65 7420 7573  te the bucket us
+0001d100: 696e 670a 2020 2020 2020 2020 2020 2020  ing.            
+0001d110: 2320 2020 626f 746f 3320 6469 7265 6374  #   boto3 direct
+0001d120: 6c79 2e0a 2020 2020 2020 2020 2020 2020  ly..            
+0001d130: 7374 6f72 6167 655f 6f62 6a2e 6465 6c65  storage_obj.dele
+0001d140: 7465 2829 0a0a 2020 2020 4070 7974 6573  te()..    @pytes
+0001d150: 742e 6669 7874 7572 650a 2020 2020 6465  t.fixture.    de
+0001d160: 6620 746d 705f 7363 7261 7463 685f 7374  f tmp_scratch_st
+0001d170: 6f72 6167 655f 6f62 6a28 7365 6c66 2c20  orage_obj(self, 
+0001d180: 746d 705f 6275 636b 6574 5f6e 616d 6529  tmp_bucket_name)
+0001d190: 3a0a 2020 2020 2020 2020 2320 4372 6561  :.        # Crea
+0001d1a0: 7465 7320 6120 7374 6f72 6167 6520 6f62  tes a storage ob
+0001d1b0: 6a65 6374 2077 6974 6820 6e6f 2073 6f75  ject with no sou
+0001d1c0: 7263 6520 746f 2063 7265 6174 6520 6120  rce to create a 
+0001d1d0: 7363 7261 7463 6820 7374 6f72 6167 652e  scratch storage.
+0001d1e0: 0a20 2020 2020 2020 2023 2053 746f 7265  .        # Store
+0001d1f0: 7320 6d75 7374 2062 6520 6164 6465 6420  s must be added 
+0001d200: 696e 2074 6865 2074 6573 742e 0a20 2020  in the test..   
+0001d210: 2020 2020 2079 6965 6c64 2066 726f 6d20       yield from 
+0001d220: 7365 6c66 2e79 6965 6c64 5f73 746f 7261  self.yield_stora
+0001d230: 6765 5f6f 626a 6563 7428 6e61 6d65 3d74  ge_object(name=t
+0001d240: 6d70 5f62 7563 6b65 745f 6e61 6d65 290a  mp_bucket_name).
+0001d250: 0a20 2020 2040 7079 7465 7374 2e66 6978  .    @pytest.fix
+0001d260: 7475 7265 0a20 2020 2064 6566 2074 6d70  ture.    def tmp
+0001d270: 5f6d 756c 7469 706c 655f 7363 7261 7463  _multiple_scratc
+0001d280: 685f 7374 6f72 6167 655f 6f62 6a28 7365  h_storage_obj(se
+0001d290: 6c66 293a 0a20 2020 2020 2020 2023 2043  lf):.        # C
+0001d2a0: 7265 6174 6573 2061 206c 6973 7420 6f66  reates a list of
+0001d2b0: 2035 2073 746f 7261 6765 206f 626a 6563   5 storage objec
+0001d2c0: 7473 2077 6974 6820 6e6f 2073 6f75 7263  ts with no sourc
+0001d2d0: 6520 746f 2063 7265 6174 650a 2020 2020  e to create.    
+0001d2e0: 2020 2020 2320 6d75 6c74 6970 6c65 2073      # multiple s
+0001d2f0: 6372 6174 6368 2073 746f 7261 6765 732e  cratch storages.
+0001d300: 0a20 2020 2020 2020 2023 2053 746f 7265  .        # Store
+0001d310: 7320 666f 7220 6561 6368 206f 626a 6563  s for each objec
+0001d320: 7420 696e 2074 6865 206c 6973 7420 6d75  t in the list mu
+0001d330: 7374 2062 6520 6164 6465 6420 696e 2074  st be added in t
+0001d340: 6865 2074 6573 742e 0a20 2020 2020 2020  he test..       
+0001d350: 2073 746f 7261 6765 5f6d 756c 745f 6f62   storage_mult_ob
+0001d360: 6a20 3d20 5b5d 0a20 2020 2020 2020 2066  j = [].        f
+0001d370: 6f72 205f 2069 6e20 7261 6e67 6528 3529  or _ in range(5)
+0001d380: 3a0a 2020 2020 2020 2020 2020 2020 7469  :.            ti
+0001d390: 6d65 7374 616d 7020 3d20 7374 7228 7469  mestamp = str(ti
+0001d3a0: 6d65 2e74 696d 6528 2929 2e72 6570 6c61  me.time()).repla
+0001d3b0: 6365 2827 2e27 2c20 2727 290a 2020 2020  ce('.', '').    
+0001d3c0: 2020 2020 2020 2020 7374 6f72 655f 6f62          store_ob
+0001d3d0: 6a20 3d20 7374 6f72 6167 655f 6c69 622e  j = storage_lib.
+0001d3e0: 5374 6f72 6167 6528 6e61 6d65 3d66 2773  Storage(name=f's
+0001d3f0: 6b79 2d74 6573 742d 7b74 696d 6573 7461  ky-test-{timesta
+0001d400: 6d70 7d27 290a 2020 2020 2020 2020 2020  mp}').          
+0001d410: 2020 7374 6f72 6167 655f 6d75 6c74 5f6f    storage_mult_o
+0001d420: 626a 2e61 7070 656e 6428 7374 6f72 655f  bj.append(store_
+0001d430: 6f62 6a29 0a20 2020 2020 2020 2079 6965  obj).        yie
+0001d440: 6c64 2073 746f 7261 6765 5f6d 756c 745f  ld storage_mult_
+0001d450: 6f62 6a0a 2020 2020 2020 2020 666f 7220  obj.        for 
+0001d460: 7374 6f72 6167 655f 6f62 6a20 696e 2073  storage_obj in s
+0001d470: 746f 7261 6765 5f6d 756c 745f 6f62 6a3a  torage_mult_obj:
+0001d480: 0a20 2020 2020 2020 2020 2020 2068 616e  .            han
+0001d490: 646c 6520 3d20 676c 6f62 616c 5f75 7365  dle = global_use
+0001d4a0: 725f 7374 6174 652e 6765 745f 6861 6e64  r_state.get_hand
+0001d4b0: 6c65 5f66 726f 6d5f 7374 6f72 6167 655f  le_from_storage_
+0001d4c0: 6e61 6d65 280a 2020 2020 2020 2020 2020  name(.          
+0001d4d0: 2020 2020 2020 7374 6f72 6167 655f 6f62        storage_ob
+0001d4e0: 6a2e 6e61 6d65 290a 2020 2020 2020 2020  j.name).        
+0001d4f0: 2020 2020 6966 2068 616e 646c 653a 0a20      if handle:. 
+0001d500: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0001d510: 2049 6620 6861 6e64 6c65 2065 7869 7374   If handle exist
+0001d520: 732c 2064 656c 6574 6520 6d61 6e75 616c  s, delete manual
+0001d530: 6c79 0a20 2020 2020 2020 2020 2020 2020  ly.             
+0001d540: 2020 2023 2054 4f44 4f28 726f 6d69 6c62     # TODO(romilb
+0001d550: 293a 2054 6869 7320 6973 2070 6f74 656e  ): This is poten
+0001d560: 7469 616c 6c79 2072 6973 6b79 202d 2069  tially risky - i
+0001d570: 6620 7468 6520 6465 6c65 7465 206d 6574  f the delete met
+0001d580: 686f 6420 6861 730a 2020 2020 2020 2020  hod has.        
+0001d590: 2020 2020 2020 2020 2320 6275 6773 2c20          # bugs, 
+0001d5a0: 7468 6973 2063 616e 2063 6175 7365 2072  this can cause r
+0001d5b0: 6573 6f75 7263 6520 6c65 616b 732e 2049  esource leaks. I
+0001d5c0: 6465 616c 6c79 2077 6520 7368 6f75 6c64  deally we should
+0001d5d0: 206d 616e 7561 6c6c 790a 2020 2020 2020   manually.      
+0001d5e0: 2020 2020 2020 2020 2020 2320 656a 6563            # ejec
+0001d5f0: 7420 7374 6f72 6167 6520 6672 6f6d 2067  t storage from g
+0001d600: 6c6f 6261 6c5f 7573 6572 5f73 7461 7465  lobal_user_state
+0001d610: 2061 6e64 2064 656c 6574 6520 7468 6520   and delete the 
+0001d620: 6275 636b 6574 2075 7369 6e67 0a20 2020  bucket using.   
+0001d630: 2020 2020 2020 2020 2020 2020 2023 2062               # b
+0001d640: 6f74 6f33 2064 6972 6563 746c 792e 0a20  oto3 directly.. 
+0001d650: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0001d660: 746f 7261 6765 5f6f 626a 2e64 656c 6574  torage_obj.delet
+0001d670: 6528 290a 0a20 2020 2040 7079 7465 7374  e()..    @pytest
+0001d680: 2e66 6978 7475 7265 0a20 2020 2064 6566  .fixture.    def
+0001d690: 2074 6d70 5f6c 6f63 616c 5f73 746f 7261   tmp_local_stora
+0001d6a0: 6765 5f6f 626a 2873 656c 662c 2074 6d70  ge_obj(self, tmp
+0001d6b0: 5f62 7563 6b65 745f 6e61 6d65 2c20 746d  _bucket_name, tm
+0001d6c0: 705f 736f 7572 6365 293a 0a20 2020 2020  p_source):.     
+0001d6d0: 2020 2023 2043 7265 6174 6573 2061 2074     # Creates a t
+0001d6e0: 656d 706f 7261 7279 2073 746f 7261 6765  emporary storage
+0001d6f0: 206f 626a 6563 742e 2053 746f 7265 7320   object. Stores 
+0001d700: 6d75 7374 2062 6520 6164 6465 6420 696e  must be added in
+0001d710: 2074 6865 2074 6573 742e 0a20 2020 2020   the test..     
+0001d720: 2020 2079 6965 6c64 2066 726f 6d20 7365     yield from se
+0001d730: 6c66 2e79 6965 6c64 5f73 746f 7261 6765  lf.yield_storage
+0001d740: 5f6f 626a 6563 7428 6e61 6d65 3d74 6d70  _object(name=tmp
+0001d750: 5f62 7563 6b65 745f 6e61 6d65 2c0a 2020  _bucket_name,.  
+0001d760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d780: 2020 2020 2020 2020 2020 2073 6f75 7263             sourc
+0001d790: 653d 746d 705f 736f 7572 6365 290a 0a20  e=tmp_source).. 
+0001d7a0: 2020 2040 7079 7465 7374 2e66 6978 7475     @pytest.fixtu
+0001d7b0: 7265 0a20 2020 2064 6566 2074 6d70 5f6c  re.    def tmp_l
+0001d7c0: 6f63 616c 5f6c 6973 745f 7374 6f72 6167  ocal_list_storag
+0001d7d0: 655f 6f62 6a28 7365 6c66 2c20 746d 705f  e_obj(self, tmp_
+0001d7e0: 6275 636b 6574 5f6e 616d 652c 2074 6d70  bucket_name, tmp
+0001d7f0: 5f73 6f75 7263 6529 3a0a 2020 2020 2020  _source):.      
+0001d800: 2020 2320 4372 6561 7465 7320 6120 7465    # Creates a te
+0001d810: 6d70 2073 746f 7261 6765 206f 626a 6563  mp storage objec
+0001d820: 7420 7768 6963 6820 7573 6573 2061 206c  t which uses a l
+0001d830: 6973 7420 6f66 2070 6174 6873 2061 7320  ist of paths as 
+0001d840: 736f 7572 6365 2e0a 2020 2020 2020 2020  source..        
+0001d850: 2320 5374 6f72 6573 206d 7573 7420 6265  # Stores must be
+0001d860: 2061 6464 6564 2069 6e20 7468 6520 7465   added in the te
+0001d870: 7374 2e20 4166 7465 7220 7570 6c6f 6164  st. After upload
+0001d880: 2c20 7468 6520 6275 636b 6574 2073 686f  , the bucket sho
+0001d890: 756c 640a 2020 2020 2020 2020 2320 6861  uld.        # ha
+0001d8a0: 7665 2074 776f 2066 696c 6573 202d 202f  ve two files - /
+0001d8b0: 746d 702d 6669 6c65 2061 6e64 202f 746d  tmp-file and /tm
+0001d8c0: 702d 736f 7572 6365 2f74 6d70 2d66 696c  p-source/tmp-fil
+0001d8d0: 650a 2020 2020 2020 2020 6c69 7374 5f73  e.        list_s
+0001d8e0: 6f75 7263 6520 3d20 5b74 6d70 5f73 6f75  ource = [tmp_sou
+0001d8f0: 7263 652c 2074 6d70 5f73 6f75 7263 6520  rce, tmp_source 
+0001d900: 2b20 272f 746d 702d 6669 6c65 275d 0a20  + '/tmp-file']. 
+0001d910: 2020 2020 2020 2079 6965 6c64 2066 726f         yield fro
+0001d920: 6d20 7365 6c66 2e79 6965 6c64 5f73 746f  m self.yield_sto
+0001d930: 7261 6765 5f6f 626a 6563 7428 6e61 6d65  rage_object(name
+0001d940: 3d74 6d70 5f62 7563 6b65 745f 6e61 6d65  =tmp_bucket_name
+0001d950: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001d960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d970: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0001d980: 6f75 7263 653d 6c69 7374 5f73 6f75 7263  ource=list_sourc
+0001d990: 6529 0a0a 2020 2020 4070 7974 6573 742e  e)..    @pytest.
+0001d9a0: 6669 7874 7572 650a 2020 2020 6465 6620  fixture.    def 
+0001d9b0: 746d 705f 6275 6c6b 5f64 656c 5f73 746f  tmp_bulk_del_sto
+0001d9c0: 7261 6765 5f6f 626a 2873 656c 662c 2074  rage_obj(self, t
+0001d9d0: 6d70 5f62 7563 6b65 745f 6e61 6d65 293a  mp_bucket_name):
+0001d9e0: 0a20 2020 2020 2020 2023 2043 7265 6174  .        # Creat
+0001d9f0: 6573 2061 2074 656d 706f 7261 7279 2073  es a temporary s
+0001da00: 746f 7261 6765 206f 626a 6563 7420 666f  torage object fo
+0001da10: 7220 7465 7374 696e 6720 6275 6c6b 2064  r testing bulk d
+0001da20: 656c 6574 696f 6e2e 0a20 2020 2020 2020  eletion..       
+0001da30: 2023 2053 746f 7265 7320 6d75 7374 2062   # Stores must b
+0001da40: 6520 6164 6465 6420 696e 2074 6865 2074  e added in the t
+0001da50: 6573 742e 0a20 2020 2020 2020 2077 6974  est..        wit
+0001da60: 6820 7465 6d70 6669 6c65 2e54 656d 706f  h tempfile.Tempo
+0001da70: 7261 7279 4469 7265 6374 6f72 7928 2920  raryDirectory() 
+0001da80: 6173 2074 6d70 6469 723a 0a20 2020 2020  as tmpdir:.     
+0001da90: 2020 2020 2020 2073 7562 7072 6f63 6573         subproces
+0001daa0: 732e 6368 6563 6b5f 6f75 7470 7574 2866  s.check_output(f
+0001dab0: 276d 6b64 6972 202d 7020 7b74 6d70 6469  'mkdir -p {tmpdi
+0001dac0: 727d 2f66 6f6c 6465 727b 7b30 3030 2e2e  r}/folder{{000..
+0001dad0: 3235 357d 7d27 2c0a 2020 2020 2020 2020  255}}',.        
+0001dae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001daf0: 2020 2020 2020 2020 2020 2020 7368 656c              shel
+0001db00: 6c3d 5472 7565 290a 2020 2020 2020 2020  l=True).        
+0001db10: 2020 2020 7375 6270 726f 6365 7373 2e63      subprocess.c
+0001db20: 6865 636b 5f6f 7574 7075 7428 6627 746f  heck_output(f'to
+0001db30: 7563 6820 7b74 6d70 6469 727d 2f74 6573  uch {tmpdir}/tes
+0001db40: 747b 7b30 3030 2e2e 3235 357d 7d2e 7478  t{{000..255}}.tx
+0001db50: 7427 2c0a 2020 2020 2020 2020 2020 2020  t',.            
+0001db60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001db70: 2020 2020 2020 2020 7368 656c 6c3d 5472          shell=Tr
+0001db80: 7565 290a 2020 2020 2020 2020 2020 2020  ue).            
+0001db90: 7375 6270 726f 6365 7373 2e63 6865 636b  subprocess.check
+0001dba0: 5f6f 7574 7075 7428 0a20 2020 2020 2020  _output(.       
+0001dbb0: 2020 2020 2020 2020 2066 2774 6f75 6368           f'touch
+0001dbc0: 207b 746d 7064 6972 7d2f 666f 6c64 6572   {tmpdir}/folder
+0001dbd0: 7b7b 3030 302e 2e32 3535 7d7d 2f74 6573  {{000..255}}/tes
+0001dbe0: 742e 7478 7427 2c20 7368 656c 6c3d 5472  t.txt', shell=Tr
+0001dbf0: 7565 290a 2020 2020 2020 2020 2020 2020  ue).            
+0001dc00: 7969 656c 6420 6672 6f6d 2073 656c 662e  yield from self.
+0001dc10: 7969 656c 645f 7374 6f72 6167 655f 6f62  yield_storage_ob
+0001dc20: 6a65 6374 286e 616d 653d 746d 705f 6275  ject(name=tmp_bu
+0001dc30: 636b 6574 5f6e 616d 652c 0a20 2020 2020  cket_name,.     
+0001dc40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dc50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dc60: 2020 2020 2020 2020 2020 2020 736f 7572              sour
+0001dc70: 6365 3d74 6d70 6469 7229 0a0a 2020 2020  ce=tmpdir)..    
+0001dc80: 4070 7974 6573 742e 6669 7874 7572 650a  @pytest.fixture.
+0001dc90: 2020 2020 6465 6620 746d 705f 636f 7079      def tmp_copy
+0001dca0: 5f6d 6e74 5f65 7869 7374 696e 675f 7374  _mnt_existing_st
+0001dcb0: 6f72 6167 655f 6f62 6a28 7365 6c66 2c20  orage_obj(self, 
+0001dcc0: 746d 705f 7363 7261 7463 685f 7374 6f72  tmp_scratch_stor
+0001dcd0: 6167 655f 6f62 6a29 3a0a 2020 2020 2020  age_obj):.      
+0001dce0: 2020 2320 4372 6561 7465 7320 6120 636f    # Creates a co
+0001dcf0: 7079 206d 6f75 6e74 2073 746f 7261 6765  py mount storage
+0001dd00: 2077 6869 6368 2072 6575 7365 7320 616e   which reuses an
+0001dd10: 2065 7869 7374 696e 6720 7374 6f72 6167   existing storag
+0001dd20: 6520 6f62 6a65 6374 2e0a 2020 2020 2020  e object..      
+0001dd30: 2020 746d 705f 7363 7261 7463 685f 7374    tmp_scratch_st
+0001dd40: 6f72 6167 655f 6f62 6a2e 6164 645f 7374  orage_obj.add_st
+0001dd50: 6f72 6528 7374 6f72 6167 655f 6c69 622e  ore(storage_lib.
+0001dd60: 5374 6f72 6554 7970 652e 5333 290a 2020  StoreType.S3).  
+0001dd70: 2020 2020 2020 7374 6f72 6167 655f 6e61        storage_na
+0001dd80: 6d65 203d 2074 6d70 5f73 6372 6174 6368  me = tmp_scratch
+0001dd90: 5f73 746f 7261 6765 5f6f 626a 2e6e 616d  _storage_obj.nam
+0001dda0: 650a 0a20 2020 2020 2020 2023 2054 7279  e..        # Try
+0001ddb0: 2074 6f20 696e 6974 6961 6c69 7a65 2061   to initialize a
+0001ddc0: 6e6f 7468 6572 2073 746f 7261 6765 2077  nother storage w
+0001ddd0: 6974 6820 7468 6520 7374 6f72 6167 6520  ith the storage 
+0001dde0: 6f62 6a65 6374 2063 7265 6174 6564 0a20  object created. 
+0001ddf0: 2020 2020 2020 2023 2061 626f 7665 2c20         # above, 
+0001de00: 6275 7420 6e6f 7720 696e 2043 4f50 5920  but now in COPY 
+0001de10: 6d6f 6465 2e20 5468 6973 2073 686f 756c  mode. This shoul
+0001de20: 6420 7375 6363 6565 642e 0a20 2020 2020  d succeed..     
+0001de30: 2020 2079 6965 6c64 2066 726f 6d20 7365     yield from se
+0001de40: 6c66 2e79 6965 6c64 5f73 746f 7261 6765  lf.yield_storage
+0001de50: 5f6f 626a 6563 7428 6e61 6d65 3d73 746f  _object(name=sto
+0001de60: 7261 6765 5f6e 616d 652c 0a20 2020 2020  rage_name,.     
+0001de70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001de80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001de90: 2020 2020 2020 2020 6d6f 6465 3d73 746f          mode=sto
+0001dea0: 7261 6765 5f6c 6962 2e53 746f 7261 6765  rage_lib.Storage
+0001deb0: 4d6f 6465 2e43 4f50 5929 0a0a 2020 2020  Mode.COPY)..    
+0001dec0: 4070 7974 6573 742e 6669 7874 7572 650a  @pytest.fixture.
+0001ded0: 2020 2020 6465 6620 746d 705f 6769 7469      def tmp_giti
+0001dee0: 676e 6f72 655f 7374 6f72 6167 655f 6f62  gnore_storage_ob
+0001def0: 6a28 7365 6c66 2c20 746d 705f 6275 636b  j(self, tmp_buck
+0001df00: 6574 5f6e 616d 652c 2067 6974 6967 6e6f  et_name, gitigno
+0001df10: 7265 5f73 7472 7563 7475 7265 293a 0a20  re_structure):. 
+0001df20: 2020 2020 2020 2023 2043 7265 6174 6573         # Creates
+0001df30: 2061 2074 656d 706f 7261 7279 2073 746f   a temporary sto
+0001df40: 7261 6765 206f 626a 6563 7420 666f 7220  rage object for 
+0001df50: 7465 7374 696e 6720 2e67 6974 6967 6e6f  testing .gitigno
+0001df60: 7265 2066 696c 7465 722e 0a20 2020 2020  re filter..     
+0001df70: 2020 2023 2047 4954 4947 494e 4f52 455f     # GITIGINORE_
+0001df80: 5354 5255 4354 5552 4520 6973 2072 6570  STRUCTURE is rep
+0001df90: 7265 7365 6e74 696e 6720 6120 6669 6c65  resenting a file
+0001dfa0: 2073 7472 7563 7475 7265 2069 6e20 6120   structure in a 
+0001dfb0: 6469 6374 696f 6e61 7279 0a20 2020 2020  dictionary.     
+0001dfc0: 2020 2023 2066 6f72 616d 742e 2043 7265     # foramt. Cre
+0001dfd0: 6174 6564 2073 746f 7261 6765 206f 626a  ated storage obj
+0001dfe0: 6563 7420 7769 6c6c 2063 6f6e 7461 696e  ect will contain
+0001dff0: 2074 6865 2066 696c 6520 7374 7275 6374   the file struct
+0001e000: 7572 6520 616c 6f6e 670a 2020 2020 2020  ure along.      
+0001e010: 2020 2320 7769 7468 202e 6769 7469 676e    # with .gitign
+0001e020: 6f72 6520 616e 6420 2e67 6974 2f69 6e66  ore and .git/inf
+0001e030: 6f2f 6578 636c 7564 6520 6669 6c65 7320  o/exclude files 
+0001e040: 746f 2074 6573 7420 6578 636c 7564 6520  to test exclude 
+0001e050: 6669 6c74 6572 2e0a 2020 2020 2020 2020  filter..        
+0001e060: 2320 5374 6f72 6573 206d 7573 7420 6265  # Stores must be
+0001e070: 2061 6464 6564 2069 6e20 7468 6520 7465   added in the te
+0001e080: 7374 2e0a 2020 2020 2020 2020 7769 7468  st..        with
+0001e090: 2074 656d 7066 696c 652e 5465 6d70 6f72   tempfile.Tempor
+0001e0a0: 6172 7944 6972 6563 746f 7279 2829 2061  aryDirectory() a
+0001e0b0: 7320 746d 7064 6972 3a0a 2020 2020 2020  s tmpdir:.      
+0001e0c0: 2020 2020 2020 2320 4372 6561 7465 7320        # Creates 
+0001e0d0: 6669 6c65 2073 7472 7563 7475 7265 2074  file structure t
+0001e0e0: 6f20 6265 2075 706c 6f61 6465 6420 696e  o be uploaded in
+0001e0f0: 2074 6865 2053 746f 7261 6765 0a20 2020   the Storage.   
+0001e100: 2020 2020 2020 2020 2073 656c 662e 6372           self.cr
+0001e110: 6561 7465 5f64 6972 5f73 7472 7563 7475  eate_dir_structu
+0001e120: 7265 2874 6d70 6469 722c 2067 6974 6967  re(tmpdir, gitig
+0001e130: 6e6f 7265 5f73 7472 7563 7475 7265 290a  nore_structure).
+0001e140: 0a20 2020 2020 2020 2020 2020 2023 2043  .            # C
+0001e150: 7265 6174 6520 2e67 6974 6967 6e6f 7265  reate .gitignore
+0001e160: 2061 6e64 206c 6973 7420 6669 6c65 732f   and list files/
+0001e170: 6469 7273 2074 6f20 6265 2065 7863 6c75  dirs to be exclu
+0001e180: 6465 6420 696e 2069 740a 2020 2020 2020  ded in it.      
+0001e190: 2020 2020 2020 736b 7970 696c 6f74 5f70        skypilot_p
+0001e1a0: 6174 6820 3d20 6f73 2e70 6174 682e 6469  ath = os.path.di
+0001e1b0: 726e 616d 6528 6f73 2e70 6174 682e 6469  rname(os.path.di
+0001e1c0: 726e 616d 6528 736b 792e 5f5f 6669 6c65  rname(sky.__file
+0001e1d0: 5f5f 2929 0a20 2020 2020 2020 2020 2020  __)).           
+0001e1e0: 2074 656d 705f 7061 7468 203d 2066 277b   temp_path = f'{
+0001e1f0: 746d 7064 6972 7d2f 2e67 6974 6967 6e6f  tmpdir}/.gitigno
+0001e200: 7265 270a 2020 2020 2020 2020 2020 2020  re'.            
+0001e210: 6669 6c65 5f70 6174 6820 3d20 6f73 2e70  file_path = os.p
+0001e220: 6174 682e 6a6f 696e 2873 6b79 7069 6c6f  ath.join(skypilo
+0001e230: 745f 7061 7468 2c20 2774 6573 7473 2f67  t_path, 'tests/g
+0001e240: 6974 6967 6e6f 7265 5f74 6573 7427 290a  itignore_test').
+0001e250: 2020 2020 2020 2020 2020 2020 7368 7574              shut
+0001e260: 696c 2e63 6f70 7966 696c 6528 6669 6c65  il.copyfile(file
+0001e270: 5f70 6174 682c 2074 656d 705f 7061 7468  _path, temp_path
+0001e280: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
+0001e290: 2043 7265 6174 6520 2e67 6974 2f69 6e66   Create .git/inf
+0001e2a0: 6f2f 6578 636c 7564 6520 616e 6420 6c69  o/exclude and li
+0001e2b0: 7374 2066 696c 6573 2f64 6972 7320 746f  st files/dirs to
+0001e2c0: 2062 6520 6578 636c 7564 6564 2069 6e20   be excluded in 
+0001e2d0: 6974 0a20 2020 2020 2020 2020 2020 2074  it.            t
+0001e2e0: 656d 705f 7061 7468 203d 2066 277b 746d  emp_path = f'{tm
+0001e2f0: 7064 6972 7d2f 2e67 6974 2f69 6e66 6f2f  pdir}/.git/info/
+0001e300: 270a 2020 2020 2020 2020 2020 2020 6f73  '.            os
+0001e310: 2e6d 616b 6564 6972 7328 7465 6d70 5f70  .makedirs(temp_p
+0001e320: 6174 6829 0a20 2020 2020 2020 2020 2020  ath).           
+0001e330: 2074 656d 705f 6578 636c 7564 655f 7061   temp_exclude_pa
+0001e340: 7468 203d 206f 732e 7061 7468 2e6a 6f69  th = os.path.joi
+0001e350: 6e28 7465 6d70 5f70 6174 682c 2027 6578  n(temp_path, 'ex
+0001e360: 636c 7564 6527 290a 2020 2020 2020 2020  clude').        
+0001e370: 2020 2020 6669 6c65 5f70 6174 6820 3d20      file_path = 
+0001e380: 6f73 2e70 6174 682e 6a6f 696e 2873 6b79  os.path.join(sky
+0001e390: 7069 6c6f 745f 7061 7468 2c0a 2020 2020  pilot_path,.    
+0001e3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e3c0: 2027 7465 7374 732f 6769 745f 696e 666f   'tests/git_info
+0001e3d0: 5f65 7863 6c75 6465 5f74 6573 7427 290a  _exclude_test').
+0001e3e0: 2020 2020 2020 2020 2020 2020 7368 7574              shut
+0001e3f0: 696c 2e63 6f70 7966 696c 6528 6669 6c65  il.copyfile(file
+0001e400: 5f70 6174 682c 2074 656d 705f 6578 636c  _path, temp_excl
+0001e410: 7564 655f 7061 7468 290a 0a20 2020 2020  ude_path)..     
+0001e420: 2020 2020 2020 2023 2043 7265 6174 6520         # Create 
+0001e430: 736b 7920 5374 6f72 6167 6520 7769 7468  sky Storage with
+0001e440: 2074 6865 2066 696c 6573 2063 7265 6174   the files creat
+0001e450: 6564 0a20 2020 2020 2020 2020 2020 2079  ed.            y
+0001e460: 6965 6c64 2066 726f 6d20 7365 6c66 2e79  ield from self.y
+0001e470: 6965 6c64 5f73 746f 7261 6765 5f6f 626a  ield_storage_obj
+0001e480: 6563 7428 0a20 2020 2020 2020 2020 2020  ect(.           
+0001e490: 2020 2020 206e 616d 653d 746d 705f 6275       name=tmp_bu
+0001e4a0: 636b 6574 5f6e 616d 652c 0a20 2020 2020  cket_name,.     
+0001e4b0: 2020 2020 2020 2020 2020 2073 6f75 7263             sourc
+0001e4c0: 653d 746d 7064 6972 2c0a 2020 2020 2020  e=tmpdir,.      
+0001e4d0: 2020 2020 2020 2020 2020 6d6f 6465 3d73            mode=s
+0001e4e0: 746f 7261 6765 5f6c 6962 2e53 746f 7261  torage_lib.Stora
+0001e4f0: 6765 4d6f 6465 2e43 4f50 5929 0a0a 2020  geMode.COPY)..  
+0001e500: 2020 4070 7974 6573 742e 6669 7874 7572    @pytest.fixtur
+0001e510: 650a 2020 2020 6465 6620 746d 705f 6177  e.    def tmp_aw
+0001e520: 7363 6c69 5f62 7563 6b65 7428 7365 6c66  scli_bucket(self
+0001e530: 2c20 746d 705f 6275 636b 6574 5f6e 616d  , tmp_bucket_nam
+0001e540: 6529 3a0a 2020 2020 2020 2020 2320 4372  e):.        # Cr
+0001e550: 6561 7465 7320 6120 7465 6d70 6f72 6172  eates a temporar
+0001e560: 7920 6275 636b 6574 2075 7369 6e67 2061  y bucket using a
+0001e570: 7773 636c 690a 2020 2020 2020 2020 7375  wscli.        su
+0001e580: 6270 726f 6365 7373 2e63 6865 636b 5f63  bprocess.check_c
+0001e590: 616c 6c28 5b27 6177 7327 2c20 2773 3327  all(['aws', 's3'
+0001e5a0: 2c20 276d 6227 2c20 6627 7333 3a2f 2f7b  , 'mb', f's3://{
+0001e5b0: 746d 705f 6275 636b 6574 5f6e 616d 657d  tmp_bucket_name}
+0001e5c0: 275d 290a 2020 2020 2020 2020 7969 656c  ']).        yiel
+0001e5d0: 6420 746d 705f 6275 636b 6574 5f6e 616d  d tmp_bucket_nam
+0001e5e0: 650a 2020 2020 2020 2020 7375 6270 726f  e.        subpro
+0001e5f0: 6365 7373 2e63 6865 636b 5f63 616c 6c28  cess.check_call(
+0001e600: 0a20 2020 2020 2020 2020 2020 205b 2761  .            ['a
+0001e610: 7773 272c 2027 7333 272c 2027 7262 272c  ws', 's3', 'rb',
+0001e620: 2066 2773 333a 2f2f 7b74 6d70 5f62 7563   f's3://{tmp_buc
+0001e630: 6b65 745f 6e61 6d65 7d27 2c20 272d 2d66  ket_name}', '--f
+0001e640: 6f72 6365 275d 290a 0a20 2020 2040 7079  orce'])..    @py
+0001e650: 7465 7374 2e66 6978 7475 7265 0a20 2020  test.fixture.   
+0001e660: 2064 6566 2074 6d70 5f67 7375 7469 6c5f   def tmp_gsutil_
+0001e670: 6275 636b 6574 2873 656c 662c 2074 6d70  bucket(self, tmp
+0001e680: 5f62 7563 6b65 745f 6e61 6d65 293a 0a20  _bucket_name):. 
+0001e690: 2020 2020 2020 2023 2043 7265 6174 6573         # Creates
+0001e6a0: 2061 2074 656d 706f 7261 7279 2062 7563   a temporary buc
+0001e6b0: 6b65 7420 7573 696e 6720 6773 7574 696c  ket using gsutil
+0001e6c0: 0a20 2020 2020 2020 2073 7562 7072 6f63  .        subproc
+0001e6d0: 6573 732e 6368 6563 6b5f 6361 6c6c 285b  ess.check_call([
+0001e6e0: 2767 7375 7469 6c27 2c20 276d 6227 2c20  'gsutil', 'mb', 
+0001e6f0: 6627 6773 3a2f 2f7b 746d 705f 6275 636b  f'gs://{tmp_buck
+0001e700: 6574 5f6e 616d 657d 275d 290a 2020 2020  et_name}']).    
+0001e710: 2020 2020 7969 656c 6420 746d 705f 6275      yield tmp_bu
+0001e720: 636b 6574 5f6e 616d 650a 2020 2020 2020  cket_name.      
+0001e730: 2020 7375 6270 726f 6365 7373 2e63 6865    subprocess.che
+0001e740: 636b 5f63 616c 6c28 5b27 6773 7574 696c  ck_call(['gsutil
+0001e750: 272c 2027 726d 272c 2027 2d72 272c 2066  ', 'rm', '-r', f
+0001e760: 2767 733a 2f2f 7b74 6d70 5f62 7563 6b65  'gs://{tmp_bucke
+0001e770: 745f 6e61 6d65 7d27 5d29 0a0a 2020 2020  t_name}'])..    
+0001e780: 4070 7974 6573 742e 6669 7874 7572 650a  @pytest.fixture.
+0001e790: 2020 2020 6465 6620 746d 705f 6177 7363      def tmp_awsc
+0001e7a0: 6c69 5f62 7563 6b65 745f 7232 2873 656c  li_bucket_r2(sel
+0001e7b0: 662c 2074 6d70 5f62 7563 6b65 745f 6e61  f, tmp_bucket_na
+0001e7c0: 6d65 293a 0a20 2020 2020 2020 2023 2043  me):.        # C
+0001e7d0: 7265 6174 6573 2061 2074 656d 706f 7261  reates a tempora
+0001e7e0: 7279 2062 7563 6b65 7420 7573 696e 6720  ry bucket using 
+0001e7f0: 6177 7363 6c69 0a20 2020 2020 2020 2065  awscli.        e
+0001e800: 6e64 706f 696e 745f 7572 6c20 3d20 636c  ndpoint_url = cl
+0001e810: 6f75 6466 6c61 7265 2e63 7265 6174 655f  oudflare.create_
+0001e820: 656e 6470 6f69 6e74 2829 0a20 2020 2020  endpoint().     
+0001e830: 2020 2073 7562 7072 6f63 6573 732e 6368     subprocess.ch
+0001e840: 6563 6b5f 6361 6c6c 280a 2020 2020 2020  eck_call(.      
+0001e850: 2020 2020 2020 6627 4157 535f 5348 4152        f'AWS_SHAR
+0001e860: 4544 5f43 5245 4445 4e54 4941 4c53 5f46  ED_CREDENTIALS_F
+0001e870: 494c 453d 7b63 6c6f 7564 666c 6172 652e  ILE={cloudflare.
+0001e880: 5232 5f43 5245 4445 4e54 4941 4c53 5f50  R2_CREDENTIALS_P
+0001e890: 4154 487d 2061 7773 2073 3320 6d62 2073  ATH} aws s3 mb s
+0001e8a0: 333a 2f2f 7b74 6d70 5f62 7563 6b65 745f  3://{tmp_bucket_
+0001e8b0: 6e61 6d65 7d20 2d2d 656e 6470 6f69 6e74  name} --endpoint
+0001e8c0: 207b 656e 6470 6f69 6e74 5f75 726c 7d20   {endpoint_url} 
+0001e8d0: 2d2d 7072 6f66 696c 653d 7232 272c 0a20  --profile=r2',. 
+0001e8e0: 2020 2020 2020 2020 2020 2073 6865 6c6c             shell
+0001e8f0: 3d54 7275 6529 0a20 2020 2020 2020 2079  =True).        y
+0001e900: 6965 6c64 2074 6d70 5f62 7563 6b65 745f  ield tmp_bucket_
+0001e910: 6e61 6d65 0a20 2020 2020 2020 2073 7562  name.        sub
+0001e920: 7072 6f63 6573 732e 6368 6563 6b5f 6361  process.check_ca
+0001e930: 6c6c 280a 2020 2020 2020 2020 2020 2020  ll(.            
+0001e940: 6627 4157 535f 5348 4152 4544 5f43 5245  f'AWS_SHARED_CRE
+0001e950: 4445 4e54 4941 4c53 5f46 494c 453d 7b63  DENTIALS_FILE={c
+0001e960: 6c6f 7564 666c 6172 652e 5232 5f43 5245  loudflare.R2_CRE
+0001e970: 4445 4e54 4941 4c53 5f50 4154 487d 2061  DENTIALS_PATH} a
+0001e980: 7773 2073 3320 7262 2073 333a 2f2f 7b74  ws s3 rb s3://{t
+0001e990: 6d70 5f62 7563 6b65 745f 6e61 6d65 7d20  mp_bucket_name} 
+0001e9a0: 2d2d 666f 7263 6520 2d2d 656e 6470 6f69  --force --endpoi
+0001e9b0: 6e74 207b 656e 6470 6f69 6e74 5f75 726c  nt {endpoint_url
+0001e9c0: 7d20 2d2d 7072 6f66 696c 653d 7232 272c  } --profile=r2',
+0001e9d0: 0a20 2020 2020 2020 2020 2020 2073 6865  .            she
+0001e9e0: 6c6c 3d54 7275 6529 0a0a 2020 2020 4070  ll=True)..    @p
+0001e9f0: 7974 6573 742e 6669 7874 7572 650a 2020  ytest.fixture.  
+0001ea00: 2020 6465 6620 746d 705f 6962 6d5f 636f    def tmp_ibm_co
+0001ea10: 735f 6275 636b 6574 2873 656c 662c 2074  s_bucket(self, t
+0001ea20: 6d70 5f62 7563 6b65 745f 6e61 6d65 293a  mp_bucket_name):
+0001ea30: 0a20 2020 2020 2020 2023 2043 7265 6174  .        # Creat
+0001ea40: 6573 2061 2074 656d 706f 7261 7279 2062  es a temporary b
+0001ea50: 7563 6b65 7420 7573 696e 6720 4942 4d20  ucket using IBM 
+0001ea60: 434f 5320 4150 490a 2020 2020 2020 2020  COS API.        
+0001ea70: 7374 6f72 6167 655f 6f62 6a20 3d20 7374  storage_obj = st
+0001ea80: 6f72 6167 655f 6c69 622e 4942 4d43 6f73  orage_lib.IBMCos
+0001ea90: 5374 6f72 6528 736f 7572 6365 3d22 222c  Store(source="",
+0001eaa0: 206e 616d 653d 746d 705f 6275 636b 6574   name=tmp_bucket
+0001eab0: 5f6e 616d 6529 0a20 2020 2020 2020 2079  _name).        y
+0001eac0: 6965 6c64 2074 6d70 5f62 7563 6b65 745f  ield tmp_bucket_
+0001ead0: 6e61 6d65 0a20 2020 2020 2020 2073 746f  name.        sto
+0001eae0: 7261 6765 5f6f 626a 2e64 656c 6574 6528  rage_obj.delete(
+0001eaf0: 290a 0a20 2020 2040 7079 7465 7374 2e66  )..    @pytest.f
+0001eb00: 6978 7475 7265 0a20 2020 2064 6566 2074  ixture.    def t
+0001eb10: 6d70 5f70 7562 6c69 635f 7374 6f72 6167  mp_public_storag
+0001eb20: 655f 6f62 6a28 7365 6c66 2c20 7265 7175  e_obj(self, requ
+0001eb30: 6573 7429 3a0a 2020 2020 2020 2020 2320  est):.        # 
+0001eb40: 496e 6974 6961 6c69 7a65 7320 6120 7374  Initializes a st
+0001eb50: 6f72 6167 6520 6f62 6a65 6374 2077 6974  orage object wit
+0001eb60: 6820 6120 7075 626c 6963 2062 7563 6b65  h a public bucke
+0001eb70: 740a 2020 2020 2020 2020 7374 6f72 6167  t.        storag
+0001eb80: 655f 6f62 6a20 3d20 7374 6f72 6167 655f  e_obj = storage_
+0001eb90: 6c69 622e 5374 6f72 6167 6528 736f 7572  lib.Storage(sour
+0001eba0: 6365 3d72 6571 7565 7374 2e70 6172 616d  ce=request.param
+0001ebb0: 290a 2020 2020 2020 2020 7969 656c 6420  ).        yield 
+0001ebc0: 7374 6f72 6167 655f 6f62 6a0a 2020 2020  storage_obj.    
+0001ebd0: 2020 2020 2320 5468 6973 2064 6f65 7320      # This does 
+0001ebe0: 6e6f 7420 7265 7175 6972 6520 616e 7920  not require any 
+0001ebf0: 6465 6c65 7469 6f6e 206c 6f67 6963 2062  deletion logic b
+0001ec00: 6563 6175 7365 2069 7420 6973 2061 2070  ecause it is a p
+0001ec10: 7562 6c69 6320 6275 636b 6574 0a20 2020  ublic bucket.   
+0001ec20: 2020 2020 2023 2061 6e64 2073 686f 756c       # and shoul
+0001ec30: 6420 6e6f 7420 6765 7420 6164 6465 6420  d not get added 
+0001ec40: 746f 2067 6c6f 6261 6c5f 7573 6572 5f73  to global_user_s
+0001ec50: 7461 7465 2e0a 0a20 2020 2040 7079 7465  tate...    @pyte
+0001ec60: 7374 2e6d 6172 6b2e 7061 7261 6d65 7472  st.mark.parametr
+0001ec70: 697a 6528 2773 746f 7265 5f74 7970 6527  ize('store_type'
+0001ec80: 2c20 5b0a 2020 2020 2020 2020 7374 6f72  , [.        stor
+0001ec90: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+0001eca0: 652e 5333 2c20 7374 6f72 6167 655f 6c69  e.S3, storage_li
+0001ecb0: 622e 5374 6f72 6554 7970 652e 4743 532c  b.StoreType.GCS,
+0001ecc0: 0a20 2020 2020 2020 2070 7974 6573 742e  .        pytest.
+0001ecd0: 7061 7261 6d28 7374 6f72 6167 655f 6c69  param(storage_li
+0001ece0: 622e 5374 6f72 6554 7970 652e 4942 4d2c  b.StoreType.IBM,
+0001ecf0: 206d 6172 6b73 3d70 7974 6573 742e 6d61   marks=pytest.ma
+0001ed00: 726b 2e69 626d 292c 0a20 2020 2020 2020  rk.ibm),.       
+0001ed10: 2070 7974 6573 742e 7061 7261 6d28 7374   pytest.param(st
+0001ed20: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+0001ed30: 7970 652e 5232 2c20 6d61 726b 733d 7079  ype.R2, marks=py
+0001ed40: 7465 7374 2e6d 6172 6b2e 636c 6f75 6466  test.mark.cloudf
+0001ed50: 6c61 7265 290a 2020 2020 5d29 0a20 2020  lare).    ]).   
+0001ed60: 2064 6566 2074 6573 745f 6e65 775f 6275   def test_new_bu
+0001ed70: 636b 6574 5f63 7265 6174 696f 6e5f 616e  cket_creation_an
+0001ed80: 645f 6465 6c65 7469 6f6e 2873 656c 662c  d_deletion(self,
+0001ed90: 2074 6d70 5f6c 6f63 616c 5f73 746f 7261   tmp_local_stora
+0001eda0: 6765 5f6f 626a 2c0a 2020 2020 2020 2020  ge_obj,.        
+0001edb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001edc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001edd0: 2020 2020 2020 7374 6f72 655f 7479 7065        store_type
+0001ede0: 293a 0a20 2020 2020 2020 2023 2043 7265  ):.        # Cre
+0001edf0: 6174 6573 2061 206e 6577 2062 7563 6b65  ates a new bucke
+0001ee00: 7420 7769 7468 2061 206c 6f63 616c 2073  t with a local s
+0001ee10: 6f75 7263 652c 2075 706c 6f61 6473 2066  ource, uploads f
+0001ee20: 696c 6573 2074 6f20 6974 0a20 2020 2020  iles to it.     
+0001ee30: 2020 2023 2061 6e64 2064 656c 6574 6573     # and deletes
+0001ee40: 2069 742e 0a20 2020 2020 2020 2074 6d70   it..        tmp
+0001ee50: 5f6c 6f63 616c 5f73 746f 7261 6765 5f6f  _local_storage_o
+0001ee60: 626a 2e61 6464 5f73 746f 7265 2873 746f  bj.add_store(sto
+0001ee70: 7265 5f74 7970 6529 0a0a 2020 2020 2020  re_type)..      
+0001ee80: 2020 2320 5275 6e20 736b 7920 7374 6f72    # Run sky stor
+0001ee90: 6167 6520 6c73 2074 6f20 6368 6563 6b20  age ls to check 
+0001eea0: 6966 2073 746f 7261 6765 206f 626a 6563  if storage objec
+0001eeb0: 7420 6578 6973 7473 2069 6e20 7468 6520  t exists in the 
+0001eec0: 6f75 7470 7574 0a20 2020 2020 2020 206f  output.        o
+0001eed0: 7574 203d 2073 7562 7072 6f63 6573 732e  ut = subprocess.
+0001eee0: 6368 6563 6b5f 6f75 7470 7574 285b 2773  check_output(['s
+0001eef0: 6b79 272c 2027 7374 6f72 6167 6527 2c20  ky', 'storage', 
+0001ef00: 276c 7327 5d29 0a20 2020 2020 2020 2061  'ls']).        a
+0001ef10: 7373 6572 7420 746d 705f 6c6f 6361 6c5f  ssert tmp_local_
+0001ef20: 7374 6f72 6167 655f 6f62 6a2e 6e61 6d65  storage_obj.name
+0001ef30: 2069 6e20 6f75 742e 6465 636f 6465 2827   in out.decode('
+0001ef40: 7574 662d 3827 290a 0a20 2020 2020 2020  utf-8')..       
+0001ef50: 2023 2052 756e 2073 6b79 2073 746f 7261   # Run sky stora
+0001ef60: 6765 2064 656c 6574 6520 746f 2064 656c  ge delete to del
+0001ef70: 6574 6520 7468 6520 7374 6f72 6167 6520  ete the storage 
+0001ef80: 6f62 6a65 6374 0a20 2020 2020 2020 2073  object.        s
+0001ef90: 7562 7072 6f63 6573 732e 6368 6563 6b5f  ubprocess.check_
+0001efa0: 6f75 7470 7574 280a 2020 2020 2020 2020  output(.        
+0001efb0: 2020 2020 5b27 736b 7927 2c20 2773 746f      ['sky', 'sto
+0001efc0: 7261 6765 272c 2027 6465 6c65 7465 272c  rage', 'delete',
+0001efd0: 2074 6d70 5f6c 6f63 616c 5f73 746f 7261   tmp_local_stora
+0001efe0: 6765 5f6f 626a 2e6e 616d 655d 290a 0a20  ge_obj.name]).. 
+0001eff0: 2020 2020 2020 2023 2052 756e 2073 6b79         # Run sky
+0001f000: 2073 746f 7261 6765 206c 7320 746f 2063   storage ls to c
+0001f010: 6865 636b 2069 6620 7374 6f72 6167 6520  heck if storage 
+0001f020: 6f62 6a65 6374 2069 7320 6465 6c65 7465  object is delete
+0001f030: 640a 2020 2020 2020 2020 6f75 7420 3d20  d.        out = 
+0001f040: 7375 6270 726f 6365 7373 2e63 6865 636b  subprocess.check
+0001f050: 5f6f 7574 7075 7428 5b27 736b 7927 2c20  _output(['sky', 
+0001f060: 2773 746f 7261 6765 272c 2027 6c73 275d  'storage', 'ls']
+0001f070: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
+0001f080: 2074 6d70 5f6c 6f63 616c 5f73 746f 7261   tmp_local_stora
+0001f090: 6765 5f6f 626a 2e6e 616d 6520 6e6f 7420  ge_obj.name not 
+0001f0a0: 696e 206f 7574 2e64 6563 6f64 6528 2775  in out.decode('u
+0001f0b0: 7466 2d38 2729 0a0a 2020 2020 4070 7974  tf-8')..    @pyt
+0001f0c0: 6573 742e 6d61 726b 2e78 6469 7374 5f67  est.mark.xdist_g
+0001f0d0: 726f 7570 2827 6d75 6c74 6970 6c65 5f62  roup('multiple_b
+0001f0e0: 7563 6b65 745f 6465 6c65 7469 6f6e 2729  ucket_deletion')
+0001f0f0: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
+0001f100: 6b2e 7061 7261 6d65 7472 697a 6528 2773  k.parametrize('s
+0001f110: 746f 7265 5f74 7970 6527 2c20 5b0a 2020  tore_type', [.  
+0001f120: 2020 2020 2020 7374 6f72 6167 655f 6c69        storage_li
+0001f130: 622e 5374 6f72 6554 7970 652e 5333 2c20  b.StoreType.S3, 
+0001f140: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+0001f150: 6554 7970 652e 4743 532c 0a20 2020 2020  eType.GCS,.     
+0001f160: 2020 2070 7974 6573 742e 7061 7261 6d28     pytest.param(
+0001f170: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+0001f180: 6554 7970 652e 5232 2c20 6d61 726b 733d  eType.R2, marks=
+0001f190: 7079 7465 7374 2e6d 6172 6b2e 636c 6f75  pytest.mark.clou
+0001f1a0: 6466 6c61 7265 292c 0a20 2020 2020 2020  dflare),.       
+0001f1b0: 2070 7974 6573 742e 7061 7261 6d28 7374   pytest.param(st
+0001f1c0: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+0001f1d0: 7970 652e 4942 4d2c 206d 6172 6b73 3d70  ype.IBM, marks=p
+0001f1e0: 7974 6573 742e 6d61 726b 2e69 626d 290a  ytest.mark.ibm).
+0001f1f0: 2020 2020 5d29 0a20 2020 2064 6566 2074      ]).    def t
+0001f200: 6573 745f 6d75 6c74 6970 6c65 5f62 7563  est_multiple_buc
+0001f210: 6b65 7473 5f63 7265 6174 696f 6e5f 616e  kets_creation_an
+0001f220: 645f 6465 6c65 7469 6f6e 280a 2020 2020  d_deletion(.    
+0001f230: 2020 2020 2020 2020 7365 6c66 2c20 746d          self, tm
+0001f240: 705f 6d75 6c74 6970 6c65 5f73 6372 6174  p_multiple_scrat
+0001f250: 6368 5f73 746f 7261 6765 5f6f 626a 2c20  ch_storage_obj, 
+0001f260: 7374 6f72 655f 7479 7065 293a 0a20 2020  store_type):.   
+0001f270: 2020 2020 2023 2043 7265 6174 6573 206d       # Creates m
+0001f280: 756c 7469 706c 6520 6e65 7720 6275 636b  ultiple new buck
+0001f290: 6574 7328 3520 6275 636b 6574 7329 2077  ets(5 buckets) w
+0001f2a0: 6974 6820 6120 6c6f 6361 6c20 736f 7572  ith a local sour
+0001f2b0: 6365 0a20 2020 2020 2020 2023 2061 6e64  ce.        # and
+0001f2c0: 2064 656c 6574 6573 2074 6865 6d2e 0a20   deletes them.. 
+0001f2d0: 2020 2020 2020 2073 746f 7261 6765 5f6f         storage_o
+0001f2e0: 626a 5f6e 616d 6520 3d20 5b5d 0a20 2020  bj_name = [].   
+0001f2f0: 2020 2020 2066 6f72 2073 746f 7265 5f6f       for store_o
+0001f300: 626a 2069 6e20 746d 705f 6d75 6c74 6970  bj in tmp_multip
+0001f310: 6c65 5f73 6372 6174 6368 5f73 746f 7261  le_scratch_stora
+0001f320: 6765 5f6f 626a 3a0a 2020 2020 2020 2020  ge_obj:.        
+0001f330: 2020 2020 7374 6f72 655f 6f62 6a2e 6164      store_obj.ad
+0001f340: 645f 7374 6f72 6528 7374 6f72 655f 7479  d_store(store_ty
+0001f350: 7065 290a 2020 2020 2020 2020 2020 2020  pe).            
+0001f360: 7374 6f72 6167 655f 6f62 6a5f 6e61 6d65  storage_obj_name
+0001f370: 2e61 7070 656e 6428 7374 6f72 655f 6f62  .append(store_ob
+0001f380: 6a2e 6e61 6d65 290a 0a20 2020 2020 2020  j.name)..       
+0001f390: 2023 2052 756e 2073 6b79 2073 746f 7261   # Run sky stora
+0001f3a0: 6765 206c 7320 746f 2063 6865 636b 2069  ge ls to check i
+0001f3b0: 6620 616c 6c20 7374 6f72 6167 6520 6f62  f all storage ob
+0001f3c0: 6a65 6374 7320 6578 6973 7473 2069 6e20  jects exists in 
+0001f3d0: 7468 650a 2020 2020 2020 2020 2320 6f75  the.        # ou
+0001f3e0: 7470 7574 2066 696c 7465 7265 6420 6279  tput filtered by
+0001f3f0: 2073 746f 7265 2074 7970 650a 2020 2020   store type.    
+0001f400: 2020 2020 6f75 745f 616c 6c20 3d20 7375      out_all = su
+0001f410: 6270 726f 6365 7373 2e63 6865 636b 5f6f  bprocess.check_o
+0001f420: 7574 7075 7428 5b27 736b 7927 2c20 2773  utput(['sky', 's
+0001f430: 746f 7261 6765 272c 2027 6c73 275d 290a  torage', 'ls']).
+0001f440: 2020 2020 2020 2020 6f75 7420 3d20 5b0a          out = [.
+0001f450: 2020 2020 2020 2020 2020 2020 6974 656d              item
+0001f460: 2e73 706c 6974 2829 5b30 5d0a 2020 2020  .split()[0].    
+0001f470: 2020 2020 2020 2020 666f 7220 6974 656d          for item
+0001f480: 2069 6e20 6f75 745f 616c 6c2e 6465 636f   in out_all.deco
+0001f490: 6465 2827 7574 662d 3827 292e 7370 6c69  de('utf-8').spli
+0001f4a0: 746c 696e 6573 2829 0a20 2020 2020 2020  tlines().       
+0001f4b0: 2020 2020 2069 6620 7374 6f72 655f 7479       if store_ty
+0001f4c0: 7065 2e76 616c 7565 2069 6e20 6974 656d  pe.value in item
+0001f4d0: 0a20 2020 2020 2020 205d 0a20 2020 2020  .        ].     
+0001f4e0: 2020 2061 7373 6572 7420 616c 6c28 5b69     assert all([i
+0001f4f0: 7465 6d20 696e 206f 7574 2066 6f72 2069  tem in out for i
+0001f500: 7465 6d20 696e 2073 746f 7261 6765 5f6f  tem in storage_o
+0001f510: 626a 5f6e 616d 655d 290a 0a20 2020 2020  bj_name])..     
+0001f520: 2020 2023 2052 756e 2073 6b79 2073 746f     # Run sky sto
+0001f530: 7261 6765 2064 656c 6574 6520 616c 6c20  rage delete all 
+0001f540: 746f 2064 656c 6574 6520 616c 6c20 7374  to delete all st
+0001f550: 6f72 6167 6520 6f62 6a65 6374 730a 2020  orage objects.  
+0001f560: 2020 2020 2020 6465 6c65 7465 5f63 6d64        delete_cmd
+0001f570: 203d 205b 2773 6b79 272c 2027 7374 6f72   = ['sky', 'stor
+0001f580: 6167 6527 2c20 2764 656c 6574 6527 5d0a  age', 'delete'].
+0001f590: 2020 2020 2020 2020 6465 6c65 7465 5f63          delete_c
+0001f5a0: 6d64 202b 3d20 7374 6f72 6167 655f 6f62  md += storage_ob
+0001f5b0: 6a5f 6e61 6d65 0a20 2020 2020 2020 2073  j_name.        s
+0001f5c0: 7562 7072 6f63 6573 732e 6368 6563 6b5f  ubprocess.check_
+0001f5d0: 6f75 7470 7574 2864 656c 6574 655f 636d  output(delete_cm
+0001f5e0: 6429 0a0a 2020 2020 2020 2020 2320 5275  d)..        # Ru
+0001f5f0: 6e20 736b 7920 7374 6f72 6167 6520 6c73  n sky storage ls
+0001f600: 2074 6f20 6368 6563 6b20 6966 2061 6c6c   to check if all
+0001f610: 2073 746f 7261 6765 206f 626a 6563 7473   storage objects
+0001f620: 2066 696c 7465 7265 6420 6279 2073 746f   filtered by sto
+0001f630: 7265 0a20 2020 2020 2020 2023 2074 7970  re.        # typ
+0001f640: 6520 6172 6520 6465 6c65 7465 640a 2020  e are deleted.  
+0001f650: 2020 2020 2020 6f75 745f 616c 6c20 3d20        out_all = 
+0001f660: 7375 6270 726f 6365 7373 2e63 6865 636b  subprocess.check
+0001f670: 5f6f 7574 7075 7428 5b27 736b 7927 2c20  _output(['sky', 
+0001f680: 2773 746f 7261 6765 272c 2027 6c73 275d  'storage', 'ls']
+0001f690: 290a 2020 2020 2020 2020 6f75 7420 3d20  ).        out = 
+0001f6a0: 5b0a 2020 2020 2020 2020 2020 2020 6974  [.            it
+0001f6b0: 656d 2e73 706c 6974 2829 5b30 5d0a 2020  em.split()[0].  
+0001f6c0: 2020 2020 2020 2020 2020 666f 7220 6974            for it
+0001f6d0: 656d 2069 6e20 6f75 745f 616c 6c2e 6465  em in out_all.de
+0001f6e0: 636f 6465 2827 7574 662d 3827 292e 7370  code('utf-8').sp
+0001f6f0: 6c69 746c 696e 6573 2829 0a20 2020 2020  litlines().     
+0001f700: 2020 2020 2020 2069 6620 7374 6f72 655f         if store_
+0001f710: 7479 7065 2e76 616c 7565 2069 6e20 6974  type.value in it
+0001f720: 656d 0a20 2020 2020 2020 205d 0a20 2020  em.        ].   
+0001f730: 2020 2020 2061 7373 6572 7420 616c 6c28       assert all(
+0001f740: 5b69 7465 6d20 6e6f 7420 696e 206f 7574  [item not in out
+0001f750: 2066 6f72 2069 7465 6d20 696e 2073 746f   for item in sto
+0001f760: 7261 6765 5f6f 626a 5f6e 616d 655d 290a  rage_obj_name]).
+0001f770: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
+0001f780: 6b2e 7061 7261 6d65 7472 697a 6528 2773  k.parametrize('s
+0001f790: 746f 7265 5f74 7970 6527 2c20 5b0a 2020  tore_type', [.  
+0001f7a0: 2020 2020 2020 7374 6f72 6167 655f 6c69        storage_li
+0001f7b0: 622e 5374 6f72 6554 7970 652e 5333 2c20  b.StoreType.S3, 
+0001f7c0: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+0001f7d0: 6554 7970 652e 4743 532c 0a20 2020 2020  eType.GCS,.     
+0001f7e0: 2020 2070 7974 6573 742e 7061 7261 6d28     pytest.param(
+0001f7f0: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+0001f800: 6554 7970 652e 4942 4d2c 206d 6172 6b73  eType.IBM, marks
+0001f810: 3d70 7974 6573 742e 6d61 726b 2e69 626d  =pytest.mark.ibm
+0001f820: 292c 0a20 2020 2020 2020 2070 7974 6573  ),.        pytes
+0001f830: 742e 7061 7261 6d28 7374 6f72 6167 655f  t.param(storage_
+0001f840: 6c69 622e 5374 6f72 6554 7970 652e 5232  lib.StoreType.R2
+0001f850: 2c20 6d61 726b 733d 7079 7465 7374 2e6d  , marks=pytest.m
+0001f860: 6172 6b2e 636c 6f75 6466 6c61 7265 290a  ark.cloudflare).
+0001f870: 2020 2020 5d29 0a20 2020 2064 6566 2074      ]).    def t
+0001f880: 6573 745f 6275 636b 6574 5f65 7874 6572  est_bucket_exter
+0001f890: 6e61 6c5f 6465 6c65 7469 6f6e 2873 656c  nal_deletion(sel
+0001f8a0: 662c 2074 6d70 5f73 6372 6174 6368 5f73  f, tmp_scratch_s
+0001f8b0: 746f 7261 6765 5f6f 626a 2c0a 2020 2020  torage_obj,.    
+0001f8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f8e0: 2020 7374 6f72 655f 7479 7065 293a 0a20    store_type):. 
+0001f8f0: 2020 2020 2020 2023 2043 7265 6174 6573         # Creates
+0001f900: 2061 2062 7563 6b65 742c 2064 656c 6574   a bucket, delet
+0001f910: 6573 2069 7420 6578 7465 726e 616c 6c79  es it externally
+0001f920: 2075 7369 6e67 2063 6c6f 7564 2063 6c69   using cloud cli
+0001f930: 2063 6f6d 6d61 6e64 730a 2020 2020 2020   commands.      
+0001f940: 2020 2320 616e 6420 7468 656e 2074 7269    # and then tri
+0001f950: 6573 2074 6f20 6465 6c65 7465 2069 7420  es to delete it 
+0001f960: 7573 696e 6720 736b 7920 7374 6f72 6167  using sky storag
+0001f970: 6520 6465 6c65 7465 2e0a 2020 2020 2020  e delete..      
+0001f980: 2020 746d 705f 7363 7261 7463 685f 7374    tmp_scratch_st
+0001f990: 6f72 6167 655f 6f62 6a2e 6164 645f 7374  orage_obj.add_st
+0001f9a0: 6f72 6528 7374 6f72 655f 7479 7065 290a  ore(store_type).
+0001f9b0: 0a20 2020 2020 2020 2023 2052 756e 2073  .        # Run s
+0001f9c0: 6b79 2073 746f 7261 6765 206c 7320 746f  ky storage ls to
+0001f9d0: 2063 6865 636b 2069 6620 7374 6f72 6167   check if storag
+0001f9e0: 6520 6f62 6a65 6374 2065 7869 7374 7320  e object exists 
+0001f9f0: 696e 2074 6865 206f 7574 7075 740a 2020  in the output.  
+0001fa00: 2020 2020 2020 6f75 7420 3d20 7375 6270        out = subp
+0001fa10: 726f 6365 7373 2e63 6865 636b 5f6f 7574  rocess.check_out
+0001fa20: 7075 7428 5b27 736b 7927 2c20 2773 746f  put(['sky', 'sto
+0001fa30: 7261 6765 272c 2027 6c73 275d 290a 2020  rage', 'ls']).  
+0001fa40: 2020 2020 2020 6173 7365 7274 2074 6d70        assert tmp
+0001fa50: 5f73 6372 6174 6368 5f73 746f 7261 6765  _scratch_storage
+0001fa60: 5f6f 626a 2e6e 616d 6520 696e 206f 7574  _obj.name in out
+0001fa70: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
+0001fa80: 0a0a 2020 2020 2020 2020 2320 4465 6c65  ..        # Dele
+0001fa90: 7465 2062 7563 6b65 7420 6578 7465 726e  te bucket extern
+0001faa0: 616c 6c79 0a20 2020 2020 2020 2063 6d64  ally.        cmd
+0001fab0: 203d 2073 656c 662e 636c 695f 6465 6c65   = self.cli_dele
+0001fac0: 7465 5f63 6d64 2873 746f 7265 5f74 7970  te_cmd(store_typ
+0001fad0: 652c 2074 6d70 5f73 6372 6174 6368 5f73  e, tmp_scratch_s
+0001fae0: 746f 7261 6765 5f6f 626a 2e6e 616d 6529  torage_obj.name)
+0001faf0: 0a20 2020 2020 2020 2073 7562 7072 6f63  .        subproc
+0001fb00: 6573 732e 6368 6563 6b5f 6f75 7470 7574  ess.check_output
+0001fb10: 2863 6d64 2c20 7368 656c 6c3d 5472 7565  (cmd, shell=True
+0001fb20: 290a 0a20 2020 2020 2020 2023 2052 756e  )..        # Run
+0001fb30: 2073 6b79 2073 746f 7261 6765 2064 656c   sky storage del
+0001fb40: 6574 6520 746f 2064 656c 6574 6520 7468  ete to delete th
+0001fb50: 6520 7374 6f72 6167 6520 6f62 6a65 6374  e storage object
+0001fb60: 0a20 2020 2020 2020 206f 7574 203d 2073  .        out = s
+0001fb70: 7562 7072 6f63 6573 732e 6368 6563 6b5f  ubprocess.check_
+0001fb80: 6f75 7470 7574 280a 2020 2020 2020 2020  output(.        
+0001fb90: 2020 2020 5b27 736b 7927 2c20 2773 746f      ['sky', 'sto
+0001fba0: 7261 6765 272c 2027 6465 6c65 7465 272c  rage', 'delete',
+0001fbb0: 2074 6d70 5f73 6372 6174 6368 5f73 746f   tmp_scratch_sto
+0001fbc0: 7261 6765 5f6f 626a 2e6e 616d 655d 290a  rage_obj.name]).
+0001fbd0: 2020 2020 2020 2020 2320 4d61 6b65 2073          # Make s
+0001fbe0: 7572 6520 6275 636b 6574 2077 6173 206e  ure bucket was n
+0001fbf0: 6f74 2063 7265 6174 6564 2064 7572 696e  ot created durin
+0001fc00: 6720 6465 6c65 7469 6f6e 2028 7365 6520  g deletion (see 
+0001fc10: 6973 7375 6520 2331 3332 3229 0a20 2020  issue #1322).   
+0001fc20: 2020 2020 2061 7373 6572 7420 2763 7265       assert 'cre
+0001fc30: 6174 6564 2720 6e6f 7420 696e 206f 7574  ated' not in out
+0001fc40: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
+0001fc50: 2e6c 6f77 6572 2829 0a0a 2020 2020 2020  .lower()..      
+0001fc60: 2020 2320 5275 6e20 736b 7920 7374 6f72    # Run sky stor
+0001fc70: 6167 6520 6c73 2074 6f20 6368 6563 6b20  age ls to check 
+0001fc80: 6966 2073 746f 7261 6765 206f 626a 6563  if storage objec
+0001fc90: 7420 6973 2064 656c 6574 6564 0a20 2020  t is deleted.   
+0001fca0: 2020 2020 206f 7574 203d 2073 7562 7072       out = subpr
+0001fcb0: 6f63 6573 732e 6368 6563 6b5f 6f75 7470  ocess.check_outp
+0001fcc0: 7574 285b 2773 6b79 272c 2027 7374 6f72  ut(['sky', 'stor
+0001fcd0: 6167 6527 2c20 276c 7327 5d29 0a20 2020  age', 'ls']).   
+0001fce0: 2020 2020 2061 7373 6572 7420 746d 705f       assert tmp_
+0001fcf0: 7363 7261 7463 685f 7374 6f72 6167 655f  scratch_storage_
+0001fd00: 6f62 6a2e 6e61 6d65 206e 6f74 2069 6e20  obj.name not in 
+0001fd10: 6f75 742e 6465 636f 6465 2827 7574 662d  out.decode('utf-
+0001fd20: 3827 290a 0a20 2020 2040 7079 7465 7374  8')..    @pytest
+0001fd30: 2e6d 6172 6b2e 7061 7261 6d65 7472 697a  .mark.parametriz
+0001fd40: 6528 2773 746f 7265 5f74 7970 6527 2c20  e('store_type', 
+0001fd50: 5b0a 2020 2020 2020 2020 7374 6f72 6167  [.        storag
+0001fd60: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
+0001fd70: 5333 2c20 7374 6f72 6167 655f 6c69 622e  S3, storage_lib.
+0001fd80: 5374 6f72 6554 7970 652e 4743 532c 0a20  StoreType.GCS,. 
+0001fd90: 2020 2020 2020 2070 7974 6573 742e 7061         pytest.pa
+0001fda0: 7261 6d28 7374 6f72 6167 655f 6c69 622e  ram(storage_lib.
+0001fdb0: 5374 6f72 6554 7970 652e 4942 4d2c 206d  StoreType.IBM, m
+0001fdc0: 6172 6b73 3d70 7974 6573 742e 6d61 726b  arks=pytest.mark
+0001fdd0: 2e69 626d 292c 0a20 2020 2020 2020 2070  .ibm),.        p
+0001fde0: 7974 6573 742e 7061 7261 6d28 7374 6f72  ytest.param(stor
+0001fdf0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+0001fe00: 652e 5232 2c20 6d61 726b 733d 7079 7465  e.R2, marks=pyte
+0001fe10: 7374 2e6d 6172 6b2e 636c 6f75 6466 6c61  st.mark.cloudfla
+0001fe20: 7265 290a 2020 2020 5d29 0a20 2020 2064  re).    ]).    d
+0001fe30: 6566 2074 6573 745f 6275 636b 6574 5f62  ef test_bucket_b
+0001fe40: 756c 6b5f 6465 6c65 7469 6f6e 2873 656c  ulk_deletion(sel
+0001fe50: 662c 2073 746f 7265 5f74 7970 652c 2074  f, store_type, t
+0001fe60: 6d70 5f62 756c 6b5f 6465 6c5f 7374 6f72  mp_bulk_del_stor
+0001fe70: 6167 655f 6f62 6a29 3a0a 2020 2020 2020  age_obj):.      
+0001fe80: 2020 2320 4372 6561 7465 7320 6120 7465    # Creates a te
+0001fe90: 6d70 2066 6f6c 6465 7220 7769 7468 206f  mp folder with o
+0001fea0: 7665 7220 3235 3620 6669 6c65 7320 616e  ver 256 files an
+0001feb0: 6420 666f 6c64 6572 732c 2075 706c 6f61  d folders, uploa
+0001fec0: 640a 2020 2020 2020 2020 2320 6669 6c65  d.        # file
+0001fed0: 7320 616e 6420 666f 6c64 6572 7320 746f  s and folders to
+0001fee0: 2061 206e 6577 2062 7563 6b65 742c 2074   a new bucket, t
+0001fef0: 6865 6e20 6465 6c65 7465 2062 7563 6b65  hen delete bucke
+0001ff00: 742e 0a20 2020 2020 2020 2074 6d70 5f62  t..        tmp_b
+0001ff10: 756c 6b5f 6465 6c5f 7374 6f72 6167 655f  ulk_del_storage_
+0001ff20: 6f62 6a2e 6164 645f 7374 6f72 6528 7374  obj.add_store(st
+0001ff30: 6f72 655f 7479 7065 290a 0a20 2020 2020  ore_type)..     
+0001ff40: 2020 2073 7562 7072 6f63 6573 732e 6368     subprocess.ch
+0001ff50: 6563 6b5f 6f75 7470 7574 280a 2020 2020  eck_output(.    
+0001ff60: 2020 2020 2020 2020 5b27 736b 7927 2c20          ['sky', 
+0001ff70: 2773 746f 7261 6765 272c 2027 6465 6c65  'storage', 'dele
+0001ff80: 7465 272c 2074 6d70 5f62 756c 6b5f 6465  te', tmp_bulk_de
+0001ff90: 6c5f 7374 6f72 6167 655f 6f62 6a2e 6e61  l_storage_obj.na
+0001ffa0: 6d65 5d29 0a0a 2020 2020 2020 2020 6f75  me])..        ou
+0001ffb0: 7470 7574 203d 2073 7562 7072 6f63 6573  tput = subproces
+0001ffc0: 732e 6368 6563 6b5f 6f75 7470 7574 285b  s.check_output([
+0001ffd0: 2773 6b79 272c 2027 7374 6f72 6167 6527  'sky', 'storage'
+0001ffe0: 2c20 276c 7327 5d29 0a20 2020 2020 2020  , 'ls']).       
+0001fff0: 2061 7373 6572 7420 746d 705f 6275 6c6b   assert tmp_bulk
+00020000: 5f64 656c 5f73 746f 7261 6765 5f6f 626a  _del_storage_obj
+00020010: 2e6e 616d 6520 6e6f 7420 696e 206f 7574  .name not in out
+00020020: 7075 742e 6465 636f 6465 2827 7574 662d  put.decode('utf-
+00020030: 3827 290a 0a20 2020 2040 7079 7465 7374  8')..    @pytest
+00020040: 2e6d 6172 6b2e 7061 7261 6d65 7472 697a  .mark.parametriz
+00020050: 6528 0a20 2020 2020 2020 2027 746d 705f  e(.        'tmp_
+00020060: 7075 626c 6963 5f73 746f 7261 6765 5f6f  public_storage_o
+00020070: 626a 2c20 7374 6f72 655f 7479 7065 272c  bj, store_type',
+00020080: 0a20 2020 2020 2020 205b 2827 7333 3a2f  .        [('s3:/
+00020090: 2f74 6367 612d 322d 6f70 656e 272c 2073  /tcga-2-open', s
+000200a0: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
+000200b0: 5479 7065 2e53 3329 2c0a 2020 2020 2020  Type.S3),.      
+000200c0: 2020 2028 2773 333a 2f2f 6469 6769 7461     ('s3://digita
+000200d0: 6c63 6f72 706f 7261 272c 2073 746f 7261  lcorpora', stora
+000200e0: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
+000200f0: 2e53 3329 2c0a 2020 2020 2020 2020 2028  .S3),.         (
+00020100: 2767 733a 2f2f 6763 702d 7075 626c 6963  'gs://gcp-public
+00020110: 2d64 6174 612d 7365 6e74 696e 656c 2d32  -data-sentinel-2
+00020120: 272c 2073 746f 7261 6765 5f6c 6962 2e53  ', storage_lib.S
+00020130: 746f 7265 5479 7065 2e47 4353 295d 2c0a  toreType.GCS)],.
+00020140: 2020 2020 2020 2020 696e 6469 7265 6374          indirect
+00020150: 3d5b 2774 6d70 5f70 7562 6c69 635f 7374  =['tmp_public_st
+00020160: 6f72 6167 655f 6f62 6a27 5d29 0a20 2020  orage_obj']).   
+00020170: 2064 6566 2074 6573 745f 7075 626c 6963   def test_public
+00020180: 5f62 7563 6b65 7428 7365 6c66 2c20 746d  _bucket(self, tm
+00020190: 705f 7075 626c 6963 5f73 746f 7261 6765  p_public_storage
+000201a0: 5f6f 626a 2c20 7374 6f72 655f 7479 7065  _obj, store_type
+000201b0: 293a 0a20 2020 2020 2020 2023 2043 7265  ):.        # Cre
+000201c0: 6174 6573 2061 206e 6577 2062 7563 6b65  ates a new bucke
+000201d0: 7420 7769 7468 2061 2070 7562 6c69 6320  t with a public 
+000201e0: 736f 7572 6365 2061 6e64 2076 6572 6966  source and verif
+000201f0: 6965 7320 7468 6174 2069 7420 6973 206e  ies that it is n
+00020200: 6f74 0a20 2020 2020 2020 2023 2061 6464  ot.        # add
+00020210: 6564 2074 6f20 676c 6f62 616c 5f75 7365  ed to global_use
+00020220: 725f 7374 6174 652e 0a20 2020 2020 2020  r_state..       
+00020230: 2074 6d70 5f70 7562 6c69 635f 7374 6f72   tmp_public_stor
+00020240: 6167 655f 6f62 6a2e 6164 645f 7374 6f72  age_obj.add_stor
+00020250: 6528 7374 6f72 655f 7479 7065 290a 0a20  e(store_type).. 
+00020260: 2020 2020 2020 2023 2052 756e 2073 6b79         # Run sky
+00020270: 2073 746f 7261 6765 206c 7320 746f 2063   storage ls to c
+00020280: 6865 636b 2069 6620 7374 6f72 6167 6520  heck if storage 
+00020290: 6f62 6a65 6374 2065 7869 7374 7320 696e  object exists in
+000202a0: 2074 6865 206f 7574 7075 740a 2020 2020   the output.    
+000202b0: 2020 2020 6f75 7420 3d20 7375 6270 726f      out = subpro
+000202c0: 6365 7373 2e63 6865 636b 5f6f 7574 7075  cess.check_outpu
+000202d0: 7428 5b27 736b 7927 2c20 2773 746f 7261  t(['sky', 'stora
+000202e0: 6765 272c 2027 6c73 275d 290a 2020 2020  ge', 'ls']).    
+000202f0: 2020 2020 6173 7365 7274 2074 6d70 5f70      assert tmp_p
+00020300: 7562 6c69 635f 7374 6f72 6167 655f 6f62  ublic_storage_ob
+00020310: 6a2e 6e61 6d65 206e 6f74 2069 6e20 6f75  j.name not in ou
+00020320: 742e 6465 636f 6465 2827 7574 662d 3827  t.decode('utf-8'
+00020330: 290a 0a20 2020 2040 7079 7465 7374 2e6d  )..    @pytest.m
+00020340: 6172 6b2e 7061 7261 6d65 7472 697a 6528  ark.parametrize(
+00020350: 276e 6f6e 6578 6973 745f 6275 636b 6574  'nonexist_bucket
+00020360: 5f75 726c 272c 205b 0a20 2020 2020 2020  _url', [.       
+00020370: 2027 7333 3a2f 2f7b 7261 6e64 6f6d 5f6e   's3://{random_n
+00020380: 616d 657d 272c 2027 6773 3a2f 2f7b 7261  ame}', 'gs://{ra
+00020390: 6e64 6f6d 5f6e 616d 657d 272c 0a20 2020  ndom_name}',.   
+000203a0: 2020 2020 2070 7974 6573 742e 7061 7261       pytest.para
+000203b0: 6d28 2763 6f73 3a2f 2f75 732d 6561 7374  m('cos://us-east
+000203c0: 2f7b 7261 6e64 6f6d 5f6e 616d 657d 272c  /{random_name}',
+000203d0: 206d 6172 6b73 3d70 7974 6573 742e 6d61   marks=pytest.ma
+000203e0: 726b 2e69 626d 292c 0a20 2020 2020 2020  rk.ibm),.       
+000203f0: 2070 7974 6573 742e 7061 7261 6d28 2772   pytest.param('r
+00020400: 323a 2f2f 7b72 616e 646f 6d5f 6e61 6d65  2://{random_name
+00020410: 7d27 2c20 6d61 726b 733d 7079 7465 7374  }', marks=pytest
+00020420: 2e6d 6172 6b2e 636c 6f75 6466 6c61 7265  .mark.cloudflare
+00020430: 290a 2020 2020 5d29 0a20 2020 2064 6566  ).    ]).    def
+00020440: 2074 6573 745f 6e6f 6e65 7869 7374 656e   test_nonexisten
+00020450: 745f 6275 636b 6574 2873 656c 662c 206e  t_bucket(self, n
+00020460: 6f6e 6578 6973 745f 6275 636b 6574 5f75  onexist_bucket_u
+00020470: 726c 293a 0a20 2020 2020 2020 2023 2041  rl):.        # A
+00020480: 7474 656d 7074 7320 746f 2063 7265 6174  ttempts to creat
+00020490: 6520 6665 7463 6820 6120 7374 726f 6167  e fetch a stroag
+000204a0: 6520 7769 7468 2061 206e 6f6e 2d65 7869  e with a non-exi
+000204b0: 7374 656e 7420 736f 7572 6365 2e0a 2020  stent source..  
+000204c0: 2020 2020 2020 2320 4765 6e65 7261 7465        # Generate
+000204d0: 2061 2072 616e 646f 6d20 6275 636b 6574   a random bucket
+000204e0: 206e 616d 6520 616e 6420 7665 7269 6679   name and verify
+000204f0: 2069 7420 646f 6573 6e27 7420 6578 6973   it doesn't exis
+00020500: 743a 0a20 2020 2020 2020 2072 6574 7279  t:.        retry
+00020510: 5f63 6f75 6e74 203d 2030 0a20 2020 2020  _count = 0.     
+00020520: 2020 2077 6869 6c65 2054 7275 653a 0a20     while True:. 
+00020530: 2020 2020 2020 2020 2020 206e 6f6e 6578             nonex
+00020540: 6973 745f 6275 636b 6574 5f6e 616d 6520  ist_bucket_name 
+00020550: 3d20 7374 7228 7575 6964 2e75 7569 6434  = str(uuid.uuid4
+00020560: 2829 290a 2020 2020 2020 2020 2020 2020  ()).            
+00020570: 6966 206e 6f6e 6578 6973 745f 6275 636b  if nonexist_buck
+00020580: 6574 5f75 726c 2e73 7461 7274 7377 6974  et_url.startswit
+00020590: 6828 2773 3327 293a 0a20 2020 2020 2020  h('s3'):.       
+000205a0: 2020 2020 2020 2020 2063 6f6d 6d61 6e64           command
+000205b0: 203d 2066 2761 7773 2073 3361 7069 2068   = f'aws s3api h
+000205c0: 6561 642d 6275 636b 6574 202d 2d62 7563  ead-bucket --buc
+000205d0: 6b65 7420 7b6e 6f6e 6578 6973 745f 6275  ket {nonexist_bu
+000205e0: 636b 6574 5f6e 616d 657d 270a 2020 2020  cket_name}'.    
+000205f0: 2020 2020 2020 2020 2020 2020 6578 7065              expe
+00020600: 6374 6564 5f6f 7574 7075 7420 3d20 2734  cted_output = '4
+00020610: 3034 270a 2020 2020 2020 2020 2020 2020  04'.            
+00020620: 656c 6966 206e 6f6e 6578 6973 745f 6275  elif nonexist_bu
+00020630: 636b 6574 5f75 726c 2e73 7461 7274 7377  cket_url.startsw
+00020640: 6974 6828 2767 7327 293a 0a20 2020 2020  ith('gs'):.     
+00020650: 2020 2020 2020 2020 2020 2063 6f6d 6d61             comma
+00020660: 6e64 203d 2066 2767 7375 7469 6c20 6c73  nd = f'gsutil ls
+00020670: 207b 6e6f 6e65 7869 7374 5f62 7563 6b65   {nonexist_bucke
+00020680: 745f 7572 6c2e 666f 726d 6174 2872 616e  t_url.format(ran
+00020690: 646f 6d5f 6e61 6d65 3d6e 6f6e 6578 6973  dom_name=nonexis
+000206a0: 745f 6275 636b 6574 5f6e 616d 6529 7d27  t_bucket_name)}'
+000206b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000206c0: 2065 7870 6563 7465 645f 6f75 7470 7574   expected_output
+000206d0: 203d 2027 4275 636b 6574 4e6f 7446 6f75   = 'BucketNotFou
+000206e0: 6e64 4578 6365 7074 696f 6e27 0a20 2020  ndException'.   
+000206f0: 2020 2020 2020 2020 2065 6c69 6620 6e6f           elif no
+00020700: 6e65 7869 7374 5f62 7563 6b65 745f 7572  nexist_bucket_ur
+00020710: 6c2e 7374 6172 7473 7769 7468 2827 7232  l.startswith('r2
+00020720: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
+00020730: 2020 2020 656e 6470 6f69 6e74 5f75 726c      endpoint_url
+00020740: 203d 2063 6c6f 7564 666c 6172 652e 6372   = cloudflare.cr
+00020750: 6561 7465 5f65 6e64 706f 696e 7428 290a  eate_endpoint().
+00020760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020770: 636f 6d6d 616e 6420 3d20 6627 4157 535f  command = f'AWS_
+00020780: 5348 4152 4544 5f43 5245 4445 4e54 4941  SHARED_CREDENTIA
+00020790: 4c53 5f46 494c 453d 7b63 6c6f 7564 666c  LS_FILE={cloudfl
+000207a0: 6172 652e 5232 5f43 5245 4445 4e54 4941  are.R2_CREDENTIA
+000207b0: 4c53 5f50 4154 487d 2061 7773 2073 3361  LS_PATH} aws s3a
+000207c0: 7069 2068 6561 642d 6275 636b 6574 202d  pi head-bucket -
+000207d0: 2d62 7563 6b65 7420 7b6e 6f6e 6578 6973  -bucket {nonexis
+000207e0: 745f 6275 636b 6574 5f6e 616d 657d 202d  t_bucket_name} -
+000207f0: 2d65 6e64 706f 696e 7420 7b65 6e64 706f  -endpoint {endpo
+00020800: 696e 745f 7572 6c7d 202d 2d70 726f 6669  int_url} --profi
+00020810: 6c65 3d72 3227 0a20 2020 2020 2020 2020  le=r2'.         
+00020820: 2020 2020 2020 2065 7870 6563 7465 645f         expected_
+00020830: 6f75 7470 7574 203d 2027 3430 3427 0a20  output = '404'. 
+00020840: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+00020850: 6e6f 6e65 7869 7374 5f62 7563 6b65 745f  nonexist_bucket_
+00020860: 7572 6c2e 7374 6172 7473 7769 7468 2827  url.startswith('
+00020870: 636f 7327 293a 0a20 2020 2020 2020 2020  cos'):.         
+00020880: 2020 2020 2020 2023 2055 7369 6e67 2041         # Using A
+00020890: 5049 2063 616c 6c73 2c20 7369 6e63 6520  PI calls, since 
+000208a0: 7573 696e 6720 7263 6c6f 6e65 2072 6571  using rclone req
+000208b0: 7569 7265 7320 6120 7072 6f66 696c 6527  uires a profile'
+000208c0: 7320 6e61 6d65 0a20 2020 2020 2020 2020  s name.         
+000208d0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+000208e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000208f0: 6578 7065 6374 6564 5f6f 7574 7075 7420  expected_output 
+00020900: 3d20 636f 6d6d 616e 6420 3d20 2265 6368  = command = "ech
+00020910: 6f22 2020 2320 6176 6f69 6420 756e 7265  o"  # avoid unre
+00020920: 6c61 7465 6420 6578 6365 7074 696f 6e20  lated exception 
+00020930: 696e 2063 6173 6520 6f66 2066 6169 6c75  in case of failu
+00020940: 7265 2e0a 2020 2020 2020 2020 2020 2020  re..            
+00020950: 2020 2020 2020 2020 6275 636b 6574 5f6e          bucket_n
+00020960: 616d 6520 3d20 7572 6c6c 6962 2e70 6172  ame = urllib.par
+00020970: 7365 2e75 726c 7370 6c69 7428 0a20 2020  se.urlsplit(.   
+00020980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020990: 2020 2020 206e 6f6e 6578 6973 745f 6275       nonexist_bu
+000209a0: 636b 6574 5f75 726c 2e66 6f72 6d61 7428  cket_url.format(
+000209b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000209c0: 2020 2020 2020 2020 2020 2020 2072 616e               ran
+000209d0: 646f 6d5f 6e61 6d65 3d6e 6f6e 6578 6973  dom_name=nonexis
+000209e0: 745f 6275 636b 6574 5f6e 616d 6529 292e  t_bucket_name)).
+000209f0: 7061 7468 2e73 7472 6970 2827 2f27 290a  path.strip('/').
+00020a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020a10: 2020 2020 636c 6965 6e74 203d 2069 626d      client = ibm
+00020a20: 2e67 6574 5f63 6f73 5f63 6c69 656e 7428  .get_cos_client(
+00020a30: 2775 732d 6561 7374 2729 0a20 2020 2020  'us-east').     
+00020a40: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00020a50: 6c69 656e 742e 6865 6164 5f62 7563 6b65  lient.head_bucke
+00020a60: 7428 4275 636b 6574 3d62 7563 6b65 745f  t(Bucket=bucket_
+00020a70: 6e61 6d65 290a 2020 2020 2020 2020 2020  name).          
+00020a80: 2020 2020 2020 6578 6365 7074 2069 626d        except ibm
+00020a90: 2e69 626d 5f62 6f74 6f63 6f72 652e 6578  .ibm_botocore.ex
+00020aa0: 6365 7074 696f 6e73 2e43 6c69 656e 7445  ceptions.ClientE
+00020ab0: 7272 6f72 2061 7320 653a 0a20 2020 2020  rror as e:.     
+00020ac0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00020ad0: 6620 652e 7265 7370 6f6e 7365 5b27 4572  f e.response['Er
+00020ae0: 726f 7227 5d5b 2743 6f64 6527 5d20 3d3d  ror']['Code'] ==
+00020af0: 2027 3430 3427 3a0a 2020 2020 2020 2020   '404':.        
+00020b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020b10: 2320 7375 6363 6573 730a 2020 2020 2020  # success.      
+00020b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020b30: 2020 7265 7475 726e 0a20 2020 2020 2020    return.       
+00020b40: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00020b50: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00020b60: 2056 616c 7565 4572 726f 7228 2755 6e73   ValueError('Uns
+00020b70: 7570 706f 7274 6564 2062 7563 6b65 7420  upported bucket 
+00020b80: 7479 7065 2027 0a20 2020 2020 2020 2020  type '.         
+00020b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020ba0: 2020 2020 2020 2020 6627 7b6e 6f6e 6578          f'{nonex
+00020bb0: 6973 745f 6275 636b 6574 5f75 726c 7d27  ist_bucket_url}'
+00020bc0: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
+00020bd0: 2043 6865 636b 2069 6620 6275 636b 6574   Check if bucket
+00020be0: 2065 7869 7374 7320 7573 696e 6720 7468   exists using th
+00020bf0: 6520 636c 693a 0a20 2020 2020 2020 2020  e cli:.         
+00020c00: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+00020c10: 2020 2020 2020 2020 6f75 7420 3d20 7375          out = su
+00020c20: 6270 726f 6365 7373 2e63 6865 636b 5f6f  bprocess.check_o
+00020c30: 7574 7075 7428 636f 6d6d 616e 642c 0a20  utput(command,. 
+00020c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020c60: 2020 2020 2020 2020 2020 2020 2073 7464               std
+00020c70: 6572 723d 7375 6270 726f 6365 7373 2e53  err=subprocess.S
+00020c80: 5444 4f55 542c 0a20 2020 2020 2020 2020  TDOUT,.         
+00020c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020cb0: 2020 2020 2073 6865 6c6c 3d54 7275 6529       shell=True)
+00020cc0: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
+00020cd0: 6570 7420 7375 6270 726f 6365 7373 2e43  ept subprocess.C
+00020ce0: 616c 6c65 6450 726f 6365 7373 4572 726f  alledProcessErro
+00020cf0: 7220 6173 2065 3a0a 2020 2020 2020 2020  r as e:.        
+00020d00: 2020 2020 2020 2020 6f75 7420 3d20 652e          out = e.
+00020d10: 6f75 7470 7574 0a20 2020 2020 2020 2020  output.         
+00020d20: 2020 206f 7574 203d 206f 7574 2e64 6563     out = out.dec
+00020d30: 6f64 6528 2775 7466 2d38 2729 0a20 2020  ode('utf-8').   
+00020d40: 2020 2020 2020 2020 2069 6620 6578 7065           if expe
+00020d50: 6374 6564 5f6f 7574 7075 7420 696e 206f  cted_output in o
+00020d60: 7574 3a0a 2020 2020 2020 2020 2020 2020  ut:.            
+00020d70: 2020 2020 6272 6561 6b0a 2020 2020 2020      break.      
+00020d80: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00020d90: 2020 2020 2020 2020 2020 2020 7265 7472              retr
+00020da0: 795f 636f 756e 7420 2b3d 2031 0a20 2020  y_count += 1.   
+00020db0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00020dc0: 7265 7472 795f 636f 756e 7420 3e20 333a  retry_count > 3:
+00020dd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020de0: 2020 2020 2072 6169 7365 2052 756e 7469       raise Runti
+00020df0: 6d65 4572 726f 7228 2755 6e61 626c 6520  meError('Unable 
+00020e00: 746f 2066 696e 6420 6120 6e6f 6e65 7869  to find a nonexi
+00020e10: 7374 656e 7420 6275 636b 6574 2027 0a20  stent bucket '. 
+00020e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020e40: 2020 2020 2020 2774 6f20 7573 652e 2054        'to use. T
+00020e50: 6869 7320 6973 2068 6967 6c79 2075 6e6c  his is higly unl
+00020e60: 696b 656c 7920 2d20 270a 2020 2020 2020  ikely - '.      
+00020e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020e90: 2027 6368 6563 6b20 6966 2074 6865 2074   'check if the t
+00020ea0: 6573 7473 2061 7265 2063 6f72 7265 6374  ests are correct
+00020eb0: 2e27 290a 0a20 2020 2020 2020 2077 6974  .')..        wit
+00020ec0: 6820 7079 7465 7374 2e72 6169 7365 7328  h pytest.raises(
+00020ed0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020ee0: 2073 6b79 2e65 7863 6570 7469 6f6e 732e   sky.exceptions.
+00020ef0: 5374 6f72 6167 6542 7563 6b65 7447 6574  StorageBucketGet
+00020f00: 4572 726f 722c 0a20 2020 2020 2020 2020  Error,.         
+00020f10: 2020 2020 2020 206d 6174 6368 3d27 4174         match='At
+00020f20: 7465 6d70 7465 6420 746f 2063 6f6e 6e65  tempted to conne
+00020f30: 6374 2074 6f20 6120 6e6f 6e2d 6578 6973  ct to a non-exis
+00020f40: 7465 6e74 2062 7563 6b65 7427 293a 0a20  tent bucket'):. 
+00020f50: 2020 2020 2020 2020 2020 2073 746f 7261             stora
+00020f60: 6765 5f6f 626a 203d 2073 746f 7261 6765  ge_obj = storage
+00020f70: 5f6c 6962 2e53 746f 7261 6765 2873 6f75  _lib.Storage(sou
+00020f80: 7263 653d 6e6f 6e65 7869 7374 5f62 7563  rce=nonexist_buc
+00020f90: 6b65 745f 7572 6c2e 666f 726d 6174 280a  ket_url.format(.
+00020fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020fb0: 7261 6e64 6f6d 5f6e 616d 653d 6e6f 6e65  random_name=none
+00020fc0: 7869 7374 5f62 7563 6b65 745f 6e61 6d65  xist_bucket_name
+00020fd0: 2929 0a0a 2020 2020 4070 7974 6573 742e  ))..    @pytest.
+00020fe0: 6d61 726b 2e70 6172 616d 6574 7269 7a65  mark.parametrize
+00020ff0: 2827 7072 6976 6174 655f 6275 636b 6574  ('private_bucket
+00021000: 272c 205b 0a20 2020 2020 2020 2066 2773  ', [.        f's
+00021010: 333a 2f2f 696d 6167 656e 6574 272c 2066  3://imagenet', f
+00021020: 2767 733a 2f2f 696d 6167 656e 6574 272c  'gs://imagenet',
+00021030: 0a20 2020 2020 2020 2070 7974 6573 742e  .        pytest.
+00021040: 7061 7261 6d28 2763 6f73 3a2f 2f75 732d  param('cos://us-
+00021050: 6561 7374 2f62 7563 6b65 7431 272c 206d  east/bucket1', m
+00021060: 6172 6b73 3d70 7974 6573 742e 6d61 726b  arks=pytest.mark
+00021070: 2e69 626d 290a 2020 2020 5d29 0a20 2020  .ibm).    ]).   
+00021080: 2064 6566 2074 6573 745f 7072 6976 6174   def test_privat
+00021090: 655f 6275 636b 6574 2873 656c 662c 2070  e_bucket(self, p
+000210a0: 7269 7661 7465 5f62 7563 6b65 7429 3a0a  rivate_bucket):.
+000210b0: 2020 2020 2020 2020 2320 4174 7465 6d70          # Attemp
+000210c0: 7473 2074 6f20 6163 6365 7373 2070 7269  ts to access pri
+000210d0: 7661 7465 2062 7563 6b65 7473 206e 6f74  vate buckets not
+000210e0: 2062 656c 6f6e 6769 6e67 2074 6f20 7468   belonging to th
+000210f0: 6520 7573 6572 2e0a 2020 2020 2020 2020  e user..        
+00021100: 2320 5468 6573 6520 6275 636b 6574 7320  # These buckets 
+00021110: 6172 6520 6b6e 6f77 6e20 746f 2062 6520  are known to be 
+00021120: 7072 6976 6174 652c 2062 7574 206d 6179  private, but may
+00021130: 206e 6565 6420 746f 2062 6520 7570 6461   need to be upda
+00021140: 7465 6420 6966 0a20 2020 2020 2020 2023  ted if.        #
+00021150: 2074 6865 7920 6172 6520 7265 6d6f 7665   they are remove
+00021160: 6420 6279 2074 6865 6972 206f 776e 6572  d by their owner
+00021170: 732e 0a20 2020 2020 2020 2070 7269 7661  s..        priva
+00021180: 7465 5f62 7563 6b65 745f 6e61 6d65 203d  te_bucket_name =
+00021190: 2075 726c 6c69 622e 7061 7273 652e 7572   urllib.parse.ur
+000211a0: 6c73 706c 6974 2870 7269 7661 7465 5f62  lsplit(private_b
+000211b0: 7563 6b65 7429 2e6e 6574 6c6f 6320 6966  ucket).netloc if
+000211c0: 205c 0a20 2020 2020 2020 2020 2020 2020   \.             
+000211d0: 2075 726c 6c69 622e 7061 7273 652e 7572   urllib.parse.ur
+000211e0: 6c73 706c 6974 2870 7269 7661 7465 5f62  lsplit(private_b
+000211f0: 7563 6b65 7429 2e73 6368 656d 6520 213d  ucket).scheme !=
+00021200: 2027 636f 7327 2065 6c73 6520 5c0a 2020   'cos' else \.  
+00021210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021220: 7572 6c6c 6962 2e70 6172 7365 2e75 726c  urllib.parse.url
+00021230: 7370 6c69 7428 7072 6976 6174 655f 6275  split(private_bu
+00021240: 636b 6574 292e 7061 7468 2e73 7472 6970  cket).path.strip
+00021250: 2827 2f27 290a 2020 2020 2020 2020 7769  ('/').        wi
+00021260: 7468 2070 7974 6573 742e 7261 6973 6573  th pytest.raises
+00021270: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00021280: 2020 736b 792e 6578 6365 7074 696f 6e73    sky.exceptions
+00021290: 2e53 746f 7261 6765 4275 636b 6574 4765  .StorageBucketGe
+000212a0: 7445 7272 6f72 2c0a 2020 2020 2020 2020  tError,.        
+000212b0: 2020 2020 2020 2020 6d61 7463 683d 7374          match=st
+000212c0: 6f72 6167 655f 6c69 622e 5f42 5543 4b45  orage_lib._BUCKE
+000212d0: 545f 4641 494c 5f54 4f5f 434f 4e4e 4543  T_FAIL_TO_CONNEC
+000212e0: 545f 4d45 5353 4147 452e 666f 726d 6174  T_MESSAGE.format
+000212f0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00021300: 2020 2020 2020 6e61 6d65 3d70 7269 7661        name=priva
+00021310: 7465 5f62 7563 6b65 745f 6e61 6d65 2929  te_bucket_name))
+00021320: 3a0a 2020 2020 2020 2020 2020 2020 7374  :.            st
+00021330: 6f72 6167 655f 6f62 6a20 3d20 7374 6f72  orage_obj = stor
+00021340: 6167 655f 6c69 622e 5374 6f72 6167 6528  age_lib.Storage(
+00021350: 736f 7572 6365 3d70 7269 7661 7465 5f62  source=private_b
+00021360: 7563 6b65 7429 0a0a 2020 2020 4070 7974  ucket)..    @pyt
+00021370: 6573 742e 6d61 726b 2e70 6172 616d 6574  est.mark.paramet
+00021380: 7269 7a65 2827 6578 745f 6275 636b 6574  rize('ext_bucket
+00021390: 5f66 6978 7475 7265 2c20 7374 6f72 655f  _fixture, store_
+000213a0: 7479 7065 272c 0a20 2020 2020 2020 2020  type',.         
+000213b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000213c0: 2020 2020 5b28 2774 6d70 5f61 7773 636c      [('tmp_awscl
+000213d0: 695f 6275 636b 6574 272c 2073 746f 7261  i_bucket', stora
+000213e0: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
+000213f0: 2e53 3329 2c0a 2020 2020 2020 2020 2020  .S3),.          
+00021400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021410: 2020 2020 2827 746d 705f 6773 7574 696c      ('tmp_gsutil
+00021420: 5f62 7563 6b65 7427 2c20 7374 6f72 6167  _bucket', storag
+00021430: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
+00021440: 4743 5329 2c0a 2020 2020 2020 2020 2020  GCS),.          
+00021450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021460: 2020 2020 7079 7465 7374 2e70 6172 616d      pytest.param
+00021470: 2827 746d 705f 6962 6d5f 636f 735f 6275  ('tmp_ibm_cos_bu
+00021480: 636b 6574 272c 0a20 2020 2020 2020 2020  cket',.         
+00021490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000214a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000214b0: 2020 7374 6f72 6167 655f 6c69 622e 5374    storage_lib.St
+000214c0: 6f72 6554 7970 652e 4942 4d2c 0a20 2020  oreType.IBM,.   
+000214d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000214e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000214f0: 2020 2020 2020 2020 6d61 726b 733d 7079          marks=py
+00021500: 7465 7374 2e6d 6172 6b2e 6962 6d29 2c0a  test.mark.ibm),.
+00021510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021520: 2020 2020 2020 2020 2020 2020 2020 7079                py
+00021530: 7465 7374 2e70 6172 616d 2827 746d 705f  test.param('tmp_
+00021540: 6177 7363 6c69 5f62 7563 6b65 745f 7232  awscli_bucket_r2
+00021550: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
 00021560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021570: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
-00021580: 6554 7970 652e 5232 2c0a 2020 2020 2020  eType.R2,.      
-00021590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000215a0: 6d61 726b 733d 7079 7465 7374 2e6d 6172  marks=pytest.mar
-000215b0: 6b2e 636c 6f75 6466 6c61 7265 295d 290a  k.cloudflare)]).
-000215c0: 2020 2020 6465 6620 7465 7374 5f65 7863      def test_exc
-000215d0: 6c75 6465 645f 6669 6c65 5f63 6c6f 7564  luded_file_cloud
-000215e0: 5f73 746f 7261 6765 5f75 706c 6f61 645f  _storage_upload_
-000215f0: 636f 7079 2873 656c 662c 2067 6974 6967  copy(self, gitig
-00021600: 6e6f 7265 5f73 7472 7563 7475 7265 2c0a  nore_structure,.
-00021610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021570: 2020 2020 2020 2020 2020 2020 2020 7374                st
+00021580: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+00021590: 7970 652e 5232 2c0a 2020 2020 2020 2020  ype.R2,.        
+000215a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000215b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000215c0: 2020 206d 6172 6b73 3d70 7974 6573 742e     marks=pytest.
+000215d0: 6d61 726b 2e63 6c6f 7564 666c 6172 6529  mark.cloudflare)
+000215e0: 5d29 0a20 2020 2064 6566 2074 6573 745f  ]).    def test_
+000215f0: 7570 6c6f 6164 5f74 6f5f 6578 6973 7469  upload_to_existi
+00021600: 6e67 5f62 7563 6b65 7428 7365 6c66 2c20  ng_bucket(self, 
+00021610: 6578 745f 6275 636b 6574 5f66 6978 7475  ext_bucket_fixtu
+00021620: 7265 2c20 7265 7175 6573 742c 0a20 2020  re, request,.   
 00021630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021640: 2020 2020 2073 746f 7265 5f74 7970 652c       store_type,
-00021650: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00021660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021680: 2020 2020 2020 746d 705f 6769 7469 676e        tmp_gitign
-00021690: 6f72 655f 7374 6f72 6167 655f 6f62 6a29  ore_storage_obj)
-000216a0: 3a0a 2020 2020 2020 2020 2320 7465 7374  :.        # test
-000216b0: 7320 6966 2066 696c 6573 2069 6e63 6c75  s if files inclu
-000216c0: 6465 6420 696e 202e 6769 7469 676e 6f72  ded in .gitignor
-000216d0: 6520 616e 6420 2e67 6974 2f69 6e66 6f2f  e and .git/info/
-000216e0: 6578 636c 7564 6520 6172 650a 2020 2020  exclude are.    
-000216f0: 2020 2020 2320 6578 636c 7564 6564 2066      # excluded f
-00021700: 726f 6d20 6265 696e 6720 7472 616e 7366  rom being transf
-00021710: 6572 7265 6420 746f 2053 746f 7261 6765  erred to Storage
-00021720: 0a0a 2020 2020 2020 2020 746d 705f 6769  ..        tmp_gi
-00021730: 7469 676e 6f72 655f 7374 6f72 6167 655f  tignore_storage_
-00021740: 6f62 6a2e 6164 645f 7374 6f72 6528 7374  obj.add_store(st
-00021750: 6f72 655f 7479 7065 290a 0a20 2020 2020  ore_type)..     
-00021760: 2020 2075 706c 6f61 645f 6669 6c65 5f6e     upload_file_n
-00021770: 616d 6520 3d20 2769 6e63 6c75 6465 6427  ame = 'included'
-00021780: 0a20 2020 2020 2020 2023 2043 6f75 6e74  .        # Count
-00021790: 2074 6865 206e 756d 6265 7220 6f66 2066   the number of f
-000217a0: 696c 6573 2077 6974 6820 7468 6520 6769  iles with the gi
-000217b0: 7665 6e20 6669 6c65 206e 616d 650a 2020  ven file name.  
-000217c0: 2020 2020 2020 7570 5f63 6d64 203d 2073        up_cmd = s
-000217d0: 656c 662e 636c 695f 636f 756e 745f 6e61  elf.cli_count_na
-000217e0: 6d65 5f69 6e5f 6275 636b 6574 2873 746f  me_in_bucket(sto
-000217f0: 7265 5f74 7970 652c 205c 0a20 2020 2020  re_type, \.     
-00021800: 2020 2020 2020 2074 6d70 5f67 6974 6967         tmp_gitig
-00021810: 6e6f 7265 5f73 746f 7261 6765 5f6f 626a  nore_storage_obj
-00021820: 2e6e 616d 652c 2066 696c 655f 6e61 6d65  .name, file_name
-00021830: 3d75 706c 6f61 645f 6669 6c65 5f6e 616d  =upload_file_nam
-00021840: 6529 0a20 2020 2020 2020 2067 6974 5f65  e).        git_e
-00021850: 7863 6c75 6465 5f63 6d64 203d 2073 656c  xclude_cmd = sel
-00021860: 662e 636c 695f 636f 756e 745f 6e61 6d65  f.cli_count_name
-00021870: 5f69 6e5f 6275 636b 6574 2873 746f 7265  _in_bucket(store
-00021880: 5f74 7970 652c 205c 0a20 2020 2020 2020  _type, \.       
-00021890: 2020 2020 2074 6d70 5f67 6974 6967 6e6f       tmp_gitigno
-000218a0: 7265 5f73 746f 7261 6765 5f6f 626a 2e6e  re_storage_obj.n
-000218b0: 616d 652c 2066 696c 655f 6e61 6d65 3d27  ame, file_name='
-000218c0: 2e67 6974 2729 0a20 2020 2020 2020 2063  .git').        c
-000218d0: 6e74 5f6e 756d 5f66 696c 655f 636d 6420  nt_num_file_cmd 
-000218e0: 3d20 7365 6c66 2e63 6c69 5f63 6f75 6e74  = self.cli_count
-000218f0: 5f66 696c 655f 696e 5f62 7563 6b65 7428  _file_in_bucket(
-00021900: 0a20 2020 2020 2020 2020 2020 2073 746f  .            sto
-00021910: 7265 5f74 7970 652c 2074 6d70 5f67 6974  re_type, tmp_git
-00021920: 6967 6e6f 7265 5f73 746f 7261 6765 5f6f  ignore_storage_o
-00021930: 626a 2e6e 616d 6529 0a0a 2020 2020 2020  bj.name)..      
-00021940: 2020 7570 5f6f 7574 7075 7420 3d20 7375    up_output = su
-00021950: 6270 726f 6365 7373 2e63 6865 636b 5f6f  bprocess.check_o
-00021960: 7574 7075 7428 7570 5f63 6d64 2c20 7368  utput(up_cmd, sh
-00021970: 656c 6c3d 5472 7565 290a 2020 2020 2020  ell=True).      
-00021980: 2020 6769 745f 6578 636c 7564 655f 6f75    git_exclude_ou
-00021990: 7470 7574 203d 2073 7562 7072 6f63 6573  tput = subproces
-000219a0: 732e 6368 6563 6b5f 6f75 7470 7574 2867  s.check_output(g
-000219b0: 6974 5f65 7863 6c75 6465 5f63 6d64 2c0a  it_exclude_cmd,.
-000219c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000219d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000219e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000219f0: 2020 2020 2073 6865 6c6c 3d54 7275 6529       shell=True)
-00021a00: 0a20 2020 2020 2020 2063 6e74 5f6f 7574  .        cnt_out
-00021a10: 7075 7420 3d20 7375 6270 726f 6365 7373  put = subprocess
-00021a20: 2e63 6865 636b 5f6f 7574 7075 7428 636e  .check_output(cn
-00021a30: 745f 6e75 6d5f 6669 6c65 5f63 6d64 2c20  t_num_file_cmd, 
-00021a40: 7368 656c 6c3d 5472 7565 290a 0a20 2020  shell=True)..   
-00021a50: 2020 2020 2061 7373 6572 7420 2733 2720       assert '3' 
-00021a60: 696e 2075 705f 6f75 7470 7574 2e64 6563  in up_output.dec
-00021a70: 6f64 6528 2775 7466 2d38 2729 2c20 5c0a  ode('utf-8'), \.
-00021a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021a90: 2746 696c 6573 2074 6f20 6265 2069 6e63  'Files to be inc
-00021aa0: 6c75 6465 6420 6172 6520 6e6f 7420 636f  luded are not co
-00021ab0: 6d70 6c65 7465 6c79 2075 706c 6f61 6465  mpletely uploade
-00021ac0: 642e 270a 2020 2020 2020 2020 2320 3120  d.'.        # 1 
-00021ad0: 6973 2072 6561 6420 6173 202e 6769 7469  is read as .giti
-00021ae0: 676e 6f72 6520 6973 2075 706c 6f61 6465  gnore is uploade
-00021af0: 640a 2020 2020 2020 2020 6173 7365 7274  d.        assert
-00021b00: 2027 3127 2069 6e20 6769 745f 6578 636c   '1' in git_excl
-00021b10: 7564 655f 6f75 7470 7574 2e64 6563 6f64  ude_output.decod
-00021b20: 6528 2775 7466 2d38 2729 2c20 5c0a 2020  e('utf-8'), \.  
-00021b30: 2020 2020 2020 2020 2020 2020 2027 2e67               '.g
-00021b40: 6974 2064 6972 6563 746f 7279 2073 686f  it directory sho
-00021b50: 756c 6420 6e6f 7420 6265 2075 706c 6f61  uld not be uploa
-00021b60: 6465 642e 270a 2020 2020 2020 2020 2320  ded.'.        # 
-00021b70: 3420 6669 6c65 7320 696e 636c 7564 6520  4 files include 
-00021b80: 2e67 6974 6967 6e6f 7265 2c20 696e 636c  .gitignore, incl
-00021b90: 7564 6564 2e6c 6f67 2c20 696e 636c 7564  uded.log, includ
-00021ba0: 6564 2e74 7874 2c20 696e 636c 7564 655f  ed.txt, include_
-00021bb0: 6469 722f 696e 636c 7564 6564 2e6c 6f67  dir/included.log
-00021bc0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-00021bd0: 2734 2720 696e 2063 6e74 5f6f 7574 7075  '4' in cnt_outpu
-00021be0: 742e 6465 636f 6465 2827 7574 662d 3827  t.decode('utf-8'
-00021bf0: 292c 205c 0a20 2020 2020 2020 2020 2020  ), \.           
-00021c00: 2020 2020 2753 6f6d 6520 6974 656d 7320      'Some items 
-00021c10: 6c69 7374 6564 2069 6e20 2e67 6974 6967  listed in .gitig
-00021c20: 6e6f 7265 2061 6e64 202e 6769 742f 696e  nore and .git/in
-00021c30: 666f 2f65 7863 6c75 6465 2061 7265 206e  fo/exclude are n
-00021c40: 6f74 2065 7863 6c75 6465 642e 270a 0a0a  ot excluded.'...
-00021c50: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573  # ---------- Tes
-00021c60: 7469 6e67 2059 414d 4c20 5370 6563 7320  ting YAML Specs 
-00021c70: 2d2d 2d2d 2d2d 2d2d 2d2d 0a23 204f 7572  ----------.# Our
-00021c80: 2073 6b79 2073 746f 7261 6765 2072 6571   sky storage req
-00021c90: 7569 7265 7320 6372 6564 656e 7469 616c  uires credential
-00021ca0: 7320 746f 2063 6865 636b 2074 6865 2062  s to check the b
-00021cb0: 7563 6b65 7420 6578 6973 7461 6e63 6520  ucket existance 
-00021cc0: 7768 656e 0a23 206c 6f61 6469 6e67 2061  when.# loading a
-00021cd0: 2074 6173 6b20 6672 6f6d 2074 6865 2079   task from the y
-00021ce0: 616d 6c20 6669 6c65 2c20 736f 2077 6520  aml file, so we 
-00021cf0: 6361 6e6e 6f74 206d 616b 6520 6974 2061  cannot make it a
-00021d00: 2075 6e69 7420 7465 7374 2e0a 636c 6173   unit test..clas
-00021d10: 7320 5465 7374 5961 6d6c 5370 6563 733a  s TestYamlSpecs:
-00021d20: 0a20 2020 2023 2054 4f44 4f28 7a68 7775  .    # TODO(zhwu
-00021d30: 293a 2041 6464 2074 6573 7420 666f 7220  ): Add test for 
-00021d40: 6074 6f5f 7961 6d6c 5f63 6f6e 6669 6760  `to_yaml_config`
-00021d50: 2066 6f72 2074 6865 2053 746f 7261 6765   for the Storage
-00021d60: 206f 626a 6563 742e 0a20 2020 2023 2020   object..    #  
-00021d70: 5765 2073 686f 756c 6420 6e6f 7420 7573  We should not us
-00021d80: 6520 6065 7861 6d70 6c65 732f 7374 6f72  e `examples/stor
-00021d90: 6167 655f 6465 6d6f 2e79 616d 6c60 2068  age_demo.yaml` h
-00021da0: 6572 652c 2073 696e 6365 2069 7420 7265  ere, since it re
-00021db0: 7175 6972 6573 0a20 2020 2023 2020 7573  quires.    #  us
-00021dc0: 6572 7320 746f 2065 6e73 7572 6520 6275  ers to ensure bu
-00021dd0: 636b 6574 206e 616d 6573 2074 6f20 6e6f  cket names to no
-00021de0: 7420 6578 6973 7420 616e 642f 6f72 2062  t exist and/or b
-00021df0: 6520 756e 6971 7565 2e0a 2020 2020 5f54  e unique..    _T
-00021e00: 4553 545f 5941 4d4c 5f50 4154 4853 203d  EST_YAML_PATHS =
-00021e10: 205b 0a20 2020 2020 2020 2027 6578 616d   [.        'exam
-00021e20: 706c 6573 2f6d 696e 696d 616c 2e79 616d  ples/minimal.yam
-00021e30: 6c27 2c20 2765 7861 6d70 6c65 732f 6d61  l', 'examples/ma
-00021e40: 6e61 6765 645f 7370 6f74 2e79 616d 6c27  naged_spot.yaml'
-00021e50: 2c0a 2020 2020 2020 2020 2765 7861 6d70  ,.        'examp
-00021e60: 6c65 732f 7573 696e 675f 6669 6c65 5f6d  les/using_file_m
-00021e70: 6f75 6e74 732e 7961 6d6c 272c 2027 6578  ounts.yaml', 'ex
-00021e80: 616d 706c 6573 2f72 6573 6e65 745f 6170  amples/resnet_ap
-00021e90: 702e 7961 6d6c 272c 0a20 2020 2020 2020  p.yaml',.       
-00021ea0: 2027 6578 616d 706c 6573 2f6d 756c 7469   'examples/multi
-00021eb0: 5f68 6f73 746e 616d 652e 7961 6d6c 270a  _hostname.yaml'.
-00021ec0: 2020 2020 5d0a 0a20 2020 2064 6566 205f      ]..    def _
-00021ed0: 6973 5f64 6963 745f 7375 6273 6574 2873  is_dict_subset(s
-00021ee0: 656c 662c 2064 312c 2064 3229 3a0a 2020  elf, d1, d2):.  
-00021ef0: 2020 2020 2020 2222 2243 6865 636b 2069        """Check i
-00021f00: 6620 6431 2069 7320 7468 6520 7375 6273  f d1 is the subs
-00021f10: 6574 206f 6620 6432 2e22 2222 0a20 2020  et of d2.""".   
-00021f20: 2020 2020 2066 6f72 206b 2c20 7620 696e       for k, v in
-00021f30: 2064 312e 6974 656d 7328 293a 0a20 2020   d1.items():.   
-00021f40: 2020 2020 2020 2020 2069 6620 6b20 6e6f           if k no
-00021f50: 7420 696e 2064 323a 0a20 2020 2020 2020  t in d2:.       
-00021f60: 2020 2020 2020 2020 2069 6620 6973 696e           if isin
-00021f70: 7374 616e 6365 2876 2c20 6c69 7374 2920  stance(v, list) 
-00021f80: 6f72 2069 7369 6e73 7461 6e63 6528 762c  or isinstance(v,
-00021f90: 2064 6963 7429 3a0a 2020 2020 2020 2020   dict):.        
-00021fa0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00021fb0: 7274 206c 656e 2876 2920 3d3d 2030 2c20  rt len(v) == 0, 
-00021fc0: 286b 2c20 7629 0a20 2020 2020 2020 2020  (k, v).         
-00021fd0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00021fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021ff0: 2061 7373 6572 7420 4661 6c73 652c 2028   assert False, (
-00022000: 6b2c 2076 290a 2020 2020 2020 2020 2020  k, v).          
-00022010: 2020 656c 6966 2069 7369 6e73 7461 6e63    elif isinstanc
-00022020: 6528 762c 2064 6963 7429 3a0a 2020 2020  e(v, dict):.    
-00022030: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00022040: 7274 2069 7369 6e73 7461 6e63 6528 6432  rt isinstance(d2
-00022050: 5b6b 5d2c 2064 6963 7429 2c20 286b 2c20  [k], dict), (k, 
-00022060: 762c 2064 3229 0a20 2020 2020 2020 2020  v, d2).         
-00022070: 2020 2020 2020 2073 656c 662e 5f69 735f         self._is_
-00022080: 6469 6374 5f73 7562 7365 7428 762c 2064  dict_subset(v, d
-00022090: 325b 6b5d 290a 2020 2020 2020 2020 2020  2[k]).          
-000220a0: 2020 656c 6966 2069 7369 6e73 7461 6e63    elif isinstanc
-000220b0: 6528 762c 2073 7472 293a 0a20 2020 2020  e(v, str):.     
-000220c0: 2020 2020 2020 2020 2020 2069 6620 6b20             if k 
-000220d0: 3d3d 2027 6163 6365 6c65 7261 746f 7273  == 'accelerators
-000220e0: 273a 0a20 2020 2020 2020 2020 2020 2020  ':.             
-000220f0: 2020 2020 2020 2072 6573 6f75 7263 6573         resources
-00022100: 203d 2073 6b79 2e52 6573 6f75 7263 6573   = sky.Resources
-00022110: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
-00022120: 2020 2020 2020 2072 6573 6f75 7263 6573         resources
-00022130: 2e5f 7365 745f 6163 6365 6c65 7261 746f  ._set_accelerato
-00022140: 7273 2876 2c20 4e6f 6e65 290a 2020 2020  rs(v, None).    
-00022150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022160: 6173 7365 7274 2072 6573 6f75 7263 6573  assert resources
-00022170: 2e61 6363 656c 6572 6174 6f72 7320 3d3d  .accelerators ==
-00022180: 2064 325b 6b5d 2c20 286b 2c20 762c 2064   d2[k], (k, v, d
-00022190: 3229 0a20 2020 2020 2020 2020 2020 2020  2).             
-000221a0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000221b0: 2020 2020 2020 2020 2020 2020 2061 7373               ass
-000221c0: 6572 7420 762e 6c6f 7765 7228 2920 3d3d  ert v.lower() ==
-000221d0: 2064 325b 6b5d 2e6c 6f77 6572 2829 2c20   d2[k].lower(), 
-000221e0: 286b 2c20 762c 2064 325b 6b5d 290a 2020  (k, v, d2[k]).  
-000221f0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00021640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021650: 2020 2020 746d 705f 736f 7572 6365 2c20      tmp_source, 
+00021660: 7374 6f72 655f 7479 7065 293a 0a20 2020  store_type):.   
+00021670: 2020 2020 2023 2054 7269 6573 2075 706c       # Tries upl
+00021680: 6f61 6469 6e67 2065 7869 7374 696e 6720  oading existing 
+00021690: 6669 6c65 7320 746f 206e 6577 6c79 2063  files to newly c
+000216a0: 7265 6174 6564 2062 7563 6b65 7420 286f  reated bucket (o
+000216b0: 7574 7369 6465 206f 660a 2020 2020 2020  utside of.      
+000216c0: 2020 2320 736b 7929 2061 6e64 2076 6572    # sky) and ver
+000216d0: 6966 6965 7320 7468 6174 2066 696c 6573  ifies that files
+000216e0: 2061 7265 2077 7269 7474 656e 2e0a 2020   are written..  
+000216f0: 2020 2020 2020 6275 636b 6574 5f6e 616d        bucket_nam
+00021700: 6520 3d20 7265 7175 6573 742e 6765 7466  e = request.getf
+00021710: 6978 7475 7265 7661 6c75 6528 6578 745f  ixturevalue(ext_
+00021720: 6275 636b 6574 5f66 6978 7475 7265 290a  bucket_fixture).
+00021730: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
+00021740: 6f62 6a20 3d20 7374 6f72 6167 655f 6c69  obj = storage_li
+00021750: 622e 5374 6f72 6167 6528 6e61 6d65 3d62  b.Storage(name=b
+00021760: 7563 6b65 745f 6e61 6d65 2c20 736f 7572  ucket_name, sour
+00021770: 6365 3d74 6d70 5f73 6f75 7263 6529 0a20  ce=tmp_source). 
+00021780: 2020 2020 2020 2073 746f 7261 6765 5f6f         storage_o
+00021790: 626a 2e61 6464 5f73 746f 7265 2873 746f  bj.add_store(sto
+000217a0: 7265 5f74 7970 6529 0a0a 2020 2020 2020  re_type)..      
+000217b0: 2020 2320 4368 6563 6b20 6966 2074 6d70    # Check if tmp
+000217c0: 5f73 6f75 7263 652f 746d 702d 6669 6c65  _source/tmp-file
+000217d0: 2065 7869 7374 7320 696e 2074 6865 2062   exists in the b
+000217e0: 7563 6b65 7420 7573 696e 6720 6177 7320  ucket using aws 
+000217f0: 636c 690a 2020 2020 2020 2020 6f75 7420  cli.        out 
+00021800: 3d20 7375 6270 726f 6365 7373 2e63 6865  = subprocess.che
+00021810: 636b 5f6f 7574 7075 7428 7365 6c66 2e63  ck_output(self.c
+00021820: 6c69 5f6c 735f 636d 6428 7374 6f72 655f  li_ls_cmd(store_
+00021830: 7479 7065 2c20 6275 636b 6574 5f6e 616d  type, bucket_nam
+00021840: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
+00021850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021860: 2020 2020 2020 2020 2020 7368 656c 6c3d            shell=
+00021870: 5472 7565 290a 2020 2020 2020 2020 6173  True).        as
+00021880: 7365 7274 2027 746d 702d 6669 6c65 2720  sert 'tmp-file' 
+00021890: 696e 206f 7574 2e64 6563 6f64 6528 2775  in out.decode('u
+000218a0: 7466 2d38 2729 2c20 5c0a 2020 2020 2020  tf-8'), \.      
+000218b0: 2020 2020 2020 2746 696c 6520 6e6f 7420        'File not 
+000218c0: 666f 756e 6420 696e 2062 7563 6b65 7420  found in bucket 
+000218d0: 2d20 6f75 7470 7574 2077 6173 203a 207b  - output was : {
+000218e0: 7d27 2e66 6f72 6d61 7428 6f75 742e 6465  }'.format(out.de
+000218f0: 636f 6465 0a20 2020 2020 2020 2020 2020  code.           
+00021900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021930: 2020 2020 2028 2775 7466 2d38 2729 290a       ('utf-8')).
+00021940: 0a20 2020 2020 2020 2023 2043 6865 636b  .        # Check
+00021950: 2073 796d 6c69 6e6b 7320 2d20 7379 6d6c   symlinks - syml
+00021960: 696e 6b73 2064 6f6e 2774 2067 6574 2063  inks don't get c
+00021970: 6f70 6965 6420 6279 2073 6b79 2073 746f  opied by sky sto
+00021980: 7261 6765 0a20 2020 2020 2020 2061 7373  rage.        ass
+00021990: 6572 7420 2870 6174 686c 6962 2e50 6174  ert (pathlib.Pat
+000219a0: 6828 746d 705f 736f 7572 6365 2920 2f20  h(tmp_source) / 
+000219b0: 2763 6972 636c 652d 6c69 6e6b 2729 2e69  'circle-link').i
+000219c0: 735f 7379 6d6c 696e 6b28 292c 2028 0a20  s_symlink(), (. 
+000219d0: 2020 2020 2020 2020 2020 2027 6369 7263             'circ
+000219e0: 6c65 2d6c 696e 6b20 7761 7320 6e6f 7420  le-link was not 
+000219f0: 666f 756e 6420 696e 2074 6865 2075 706c  found in the upl
+00021a00: 6f61 6420 736f 7572 6365 202d 2027 0a20  oad source - '. 
+00021a10: 2020 2020 2020 2020 2020 2027 6172 6520             'are 
+00021a20: 7468 6520 7465 7374 2066 6978 7475 7265  the test fixture
+00021a30: 7320 636f 7272 6563 743f 2729 0a20 2020  s correct?').   
+00021a40: 2020 2020 2061 7373 6572 7420 2763 6972       assert 'cir
+00021a50: 636c 652d 6c69 6e6b 2720 6e6f 7420 696e  cle-link' not in
+00021a60: 206f 7574 2e64 6563 6f64 6528 2775 7466   out.decode('utf
+00021a70: 2d38 2729 2c20 280a 2020 2020 2020 2020  -8'), (.        
+00021a80: 2020 2020 2753 796d 6c69 6e6b 2066 6f75      'Symlink fou
+00021a90: 6e64 2069 6e20 6275 636b 6574 202d 206c  nd in bucket - l
+00021aa0: 7320 6f75 7470 7574 2077 6173 203a 207b  s output was : {
+00021ab0: 7d27 2e66 6f72 6d61 7428 0a20 2020 2020  }'.format(.     
+00021ac0: 2020 2020 2020 2020 2020 206f 7574 2e64             out.d
+00021ad0: 6563 6f64 6528 2775 7466 2d38 2729 2929  ecode('utf-8')))
+00021ae0: 0a0a 2020 2020 2020 2020 2320 5275 6e20  ..        # Run 
+00021af0: 736b 7920 7374 6f72 6167 6520 6c73 2074  sky storage ls t
+00021b00: 6f20 6368 6563 6b20 6966 2073 746f 7261  o check if stora
+00021b10: 6765 206f 626a 6563 7420 6578 6973 7473  ge object exists
+00021b20: 2069 6e20 7468 6520 6f75 7470 7574 2e0a   in the output..
+00021b30: 2020 2020 2020 2020 2320 4974 2073 686f          # It sho
+00021b40: 756c 6420 6e6f 7420 6578 6973 7420 6265  uld not exist be
+00021b50: 6361 7573 6520 7468 6520 6275 636b 6574  cause the bucket
+00021b60: 2077 6173 2063 7265 6174 6564 2065 7874   was created ext
+00021b70: 6572 6e61 6c6c 792e 0a20 2020 2020 2020  ernally..       
+00021b80: 206f 7574 203d 2073 7562 7072 6f63 6573   out = subproces
+00021b90: 732e 6368 6563 6b5f 6f75 7470 7574 285b  s.check_output([
+00021ba0: 2773 6b79 272c 2027 7374 6f72 6167 6527  'sky', 'storage'
+00021bb0: 2c20 276c 7327 5d29 0a20 2020 2020 2020  , 'ls']).       
+00021bc0: 2061 7373 6572 7420 7374 6f72 6167 655f   assert storage_
+00021bd0: 6f62 6a2e 6e61 6d65 206e 6f74 2069 6e20  obj.name not in 
+00021be0: 6f75 742e 6465 636f 6465 2827 7574 662d  out.decode('utf-
+00021bf0: 3827 290a 0a20 2020 2064 6566 2074 6573  8')..    def tes
+00021c00: 745f 636f 7079 5f6d 6f75 6e74 5f65 7869  t_copy_mount_exi
+00021c10: 7374 696e 675f 7374 6f72 6167 6528 7365  sting_storage(se
+00021c20: 6c66 2c0a 2020 2020 2020 2020 2020 2020  lf,.            
+00021c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021c40: 2020 2020 2020 2020 2020 2020 2074 6d70               tmp
+00021c50: 5f63 6f70 795f 6d6e 745f 6578 6973 7469  _copy_mnt_existi
+00021c60: 6e67 5f73 746f 7261 6765 5f6f 626a 293a  ng_storage_obj):
+00021c70: 0a20 2020 2020 2020 2023 2043 7265 6174  .        # Creat
+00021c80: 6573 2061 2062 7563 6b65 7420 7769 7468  es a bucket with
+00021c90: 206e 6f20 736f 7572 6365 2069 6e20 4d4f   no source in MO
+00021ca0: 554e 5420 6d6f 6465 2028 656d 7074 7920  UNT mode (empty 
+00021cb0: 6275 636b 6574 292c 2061 6e64 0a20 2020  bucket), and.   
+00021cc0: 2020 2020 2023 2074 6865 6e20 7472 6965       # then trie
+00021cd0: 7320 746f 206c 6f61 6420 7468 6520 7361  s to load the sa
+00021ce0: 6d65 2073 746f 7261 6765 2069 6e20 434f  me storage in CO
+00021cf0: 5059 206d 6f64 652e 0a20 2020 2020 2020  PY mode..       
+00021d00: 2074 6d70 5f63 6f70 795f 6d6e 745f 6578   tmp_copy_mnt_ex
+00021d10: 6973 7469 6e67 5f73 746f 7261 6765 5f6f  isting_storage_o
+00021d20: 626a 2e61 6464 5f73 746f 7265 2873 746f  bj.add_store(sto
+00021d30: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
+00021d40: 7065 2e53 3329 0a20 2020 2020 2020 2073  pe.S3).        s
+00021d50: 746f 7261 6765 5f6e 616d 6520 3d20 746d  torage_name = tm
+00021d60: 705f 636f 7079 5f6d 6e74 5f65 7869 7374  p_copy_mnt_exist
+00021d70: 696e 675f 7374 6f72 6167 655f 6f62 6a2e  ing_storage_obj.
+00021d80: 6e61 6d65 0a0a 2020 2020 2020 2020 2320  name..        # 
+00021d90: 4368 6563 6b20 6073 6b79 2073 746f 7261  Check `sky stora
+00021da0: 6765 206c 7360 2074 6f20 656e 7375 7265  ge ls` to ensure
+00021db0: 2073 746f 7261 6765 206f 626a 6563 7420   storage object 
+00021dc0: 6578 6973 7473 0a20 2020 2020 2020 206f  exists.        o
+00021dd0: 7574 203d 2073 7562 7072 6f63 6573 732e  ut = subprocess.
+00021de0: 6368 6563 6b5f 6f75 7470 7574 285b 2773  check_output(['s
+00021df0: 6b79 272c 2027 7374 6f72 6167 6527 2c20  ky', 'storage', 
+00021e00: 276c 7327 5d29 2e64 6563 6f64 6528 2775  'ls']).decode('u
+00021e10: 7466 2d38 2729 0a20 2020 2020 2020 2061  tf-8').        a
+00021e20: 7373 6572 7420 7374 6f72 6167 655f 6e61  ssert storage_na
+00021e30: 6d65 2069 6e20 6f75 742c 2066 2753 746f  me in out, f'Sto
+00021e40: 7261 6765 207b 7374 6f72 6167 655f 6e61  rage {storage_na
+00021e50: 6d65 7d20 6e6f 7420 666f 756e 6420 696e  me} not found in
+00021e60: 2073 6b79 2073 746f 7261 6765 206c 732e   sky storage ls.
+00021e70: 270a 0a20 2020 2040 7079 7465 7374 2e6d  '..    @pytest.m
+00021e80: 6172 6b2e 7061 7261 6d65 7472 697a 6528  ark.parametrize(
+00021e90: 2773 746f 7265 5f74 7970 6527 2c20 5b0a  'store_type', [.
+00021ea0: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
+00021eb0: 6c69 622e 5374 6f72 6554 7970 652e 5333  lib.StoreType.S3
+00021ec0: 2c20 7374 6f72 6167 655f 6c69 622e 5374  , storage_lib.St
+00021ed0: 6f72 6554 7970 652e 4743 532c 0a20 2020  oreType.GCS,.   
+00021ee0: 2020 2020 2070 7974 6573 742e 7061 7261       pytest.para
+00021ef0: 6d28 7374 6f72 6167 655f 6c69 622e 5374  m(storage_lib.St
+00021f00: 6f72 6554 7970 652e 4942 4d2c 206d 6172  oreType.IBM, mar
+00021f10: 6b73 3d70 7974 6573 742e 6d61 726b 2e69  ks=pytest.mark.i
+00021f20: 626d 292c 0a20 2020 2020 2020 2070 7974  bm),.        pyt
+00021f30: 6573 742e 7061 7261 6d28 7374 6f72 6167  est.param(storag
+00021f40: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
+00021f50: 5232 2c20 6d61 726b 733d 7079 7465 7374  R2, marks=pytest
+00021f60: 2e6d 6172 6b2e 636c 6f75 6466 6c61 7265  .mark.cloudflare
+00021f70: 290a 2020 2020 5d29 0a20 2020 2064 6566  ).    ]).    def
+00021f80: 2074 6573 745f 6c69 7374 5f73 6f75 7263   test_list_sourc
+00021f90: 6528 7365 6c66 2c20 746d 705f 6c6f 6361  e(self, tmp_loca
+00021fa0: 6c5f 6c69 7374 5f73 746f 7261 6765 5f6f  l_list_storage_o
+00021fb0: 626a 2c20 7374 6f72 655f 7479 7065 293a  bj, store_type):
+00021fc0: 0a20 2020 2020 2020 2023 2055 7365 7320  .        # Uses 
+00021fd0: 6120 6c69 7374 2069 6e20 7468 6520 736f  a list in the so
+00021fe0: 7572 6365 2066 6965 6c64 2074 6f20 7370  urce field to sp
+00021ff0: 6563 6966 7920 6120 6669 6c65 2061 6e64  ecify a file and
+00022000: 2061 2064 6972 6563 746f 7279 2074 6f0a   a directory to.
+00022010: 2020 2020 2020 2020 2320 6265 2075 706c          # be upl
+00022020: 6f61 6465 6420 746f 2074 6865 2073 746f  oaded to the sto
+00022030: 7261 6765 206f 626a 6563 742e 0a20 2020  rage object..   
+00022040: 2020 2020 2074 6d70 5f6c 6f63 616c 5f6c       tmp_local_l
+00022050: 6973 745f 7374 6f72 6167 655f 6f62 6a2e  ist_storage_obj.
+00022060: 6164 645f 7374 6f72 6528 7374 6f72 655f  add_store(store_
+00022070: 7479 7065 290a 0a20 2020 2020 2020 2023  type)..        #
+00022080: 2043 6865 636b 2069 6620 746d 702d 6669   Check if tmp-fi
+00022090: 6c65 2065 7869 7374 7320 696e 2074 6865  le exists in the
+000220a0: 2062 7563 6b65 7420 726f 6f74 2075 7369   bucket root usi
+000220b0: 6e67 2063 6c69 0a20 2020 2020 2020 206f  ng cli.        o
+000220c0: 7574 203d 2073 7562 7072 6f63 6573 732e  ut = subprocess.
+000220d0: 6368 6563 6b5f 6f75 7470 7574 2873 656c  check_output(sel
+000220e0: 662e 636c 695f 6c73 5f63 6d64 280a 2020  f.cli_ls_cmd(.  
+000220f0: 2020 2020 2020 2020 2020 7374 6f72 655f            store_
+00022100: 7479 7065 2c20 746d 705f 6c6f 6361 6c5f  type, tmp_local_
+00022110: 6c69 7374 5f73 746f 7261 6765 5f6f 626a  list_storage_obj
+00022120: 2e6e 616d 6529 2c0a 2020 2020 2020 2020  .name),.        
+00022130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022140: 2020 2020 2020 2020 2020 2020 2020 7368                sh
+00022150: 656c 6c3d 5472 7565 290a 2020 2020 2020  ell=True).      
+00022160: 2020 6173 7365 7274 2027 746d 702d 6669    assert 'tmp-fi
+00022170: 6c65 2720 696e 206f 7574 2e64 6563 6f64  le' in out.decod
+00022180: 6528 2775 7466 2d38 2729 2c20 5c0a 2020  e('utf-8'), \.  
+00022190: 2020 2020 2020 2020 2020 2746 696c 6520            'File 
+000221a0: 6e6f 7420 666f 756e 6420 696e 2062 7563  not found in buc
+000221b0: 6b65 7420 2d20 6f75 7470 7574 2077 6173  ket - output was
+000221c0: 203a 207b 7d27 2e66 6f72 6d61 7428 6f75   : {}'.format(ou
+000221d0: 742e 6465 636f 6465 0a20 2020 2020 2020  t.decode.       
+000221e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000221f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00022200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022210: 6173 7365 7274 2076 203d 3d20 6432 5b6b  assert v == d2[k
-00022220: 5d2c 2028 6b2c 2076 2c20 6432 5b6b 5d29  ], (k, v, d2[k])
-00022230: 0a0a 2020 2020 6465 6620 5f63 6865 636b  ..    def _check
-00022240: 5f65 7175 6976 616c 656e 7428 7365 6c66  _equivalent(self
-00022250: 2c20 7961 6d6c 5f70 6174 6829 3a0a 2020  , yaml_path):.  
-00022260: 2020 2020 2020 2222 2243 6865 636b 2069        """Check i
-00022270: 6620 7468 6520 7961 6d6c 2069 7320 6571  f the yaml is eq
-00022280: 7569 7661 6c65 6e74 2061 6674 6572 206c  uivalent after l
-00022290: 6f61 6420 616e 6420 6475 6d70 2061 6761  oad and dump aga
-000222a0: 696e 2e22 2222 0a20 2020 2020 2020 206f  in.""".        o
-000222b0: 7269 6769 6e5f 7461 736b 5f63 6f6e 6669  rigin_task_confi
-000222c0: 6720 3d20 636f 6d6d 6f6e 5f75 7469 6c73  g = common_utils
-000222d0: 2e72 6561 645f 7961 6d6c 2879 616d 6c5f  .read_yaml(yaml_
-000222e0: 7061 7468 290a 0a20 2020 2020 2020 2074  path)..        t
-000222f0: 6173 6b20 3d20 736b 792e 5461 736b 2e66  ask = sky.Task.f
-00022300: 726f 6d5f 7961 6d6c 2879 616d 6c5f 7061  rom_yaml(yaml_pa
-00022310: 7468 290a 2020 2020 2020 2020 6e65 775f  th).        new_
-00022320: 7461 736b 5f63 6f6e 6669 6720 3d20 7461  task_config = ta
-00022330: 736b 2e74 6f5f 7961 6d6c 5f63 6f6e 6669  sk.to_yaml_confi
-00022340: 6728 290a 2020 2020 2020 2020 2320 6431  g().        # d1
-00022350: 203c 3d20 6432 0a20 2020 2020 2020 2073   <= d2.        s
-00022360: 656c 662e 5f69 735f 6469 6374 5f73 7562  elf._is_dict_sub
-00022370: 7365 7428 6f72 6967 696e 5f74 6173 6b5f  set(origin_task_
-00022380: 636f 6e66 6967 2c20 6e65 775f 7461 736b  config, new_task
-00022390: 5f63 6f6e 6669 6729 0a0a 2020 2020 6465  _config)..    de
-000223a0: 6620 7465 7374 5f6c 6f61 645f 6475 6d70  f test_load_dump
-000223b0: 5f79 616d 6c5f 636f 6e66 6967 5f65 7175  _yaml_config_equ
-000223c0: 6976 616c 656e 7428 7365 6c66 293a 0a20  ivalent(self):. 
-000223d0: 2020 2020 2020 2022 2222 5465 7374 2069         """Test i
-000223e0: 6620 7468 6520 7961 6d6c 2063 6f6e 6669  f the yaml confi
-000223f0: 6720 6973 2065 7175 6976 616c 656e 7420  g is equivalent 
-00022400: 6166 7465 7220 6c6f 6164 2061 6e64 2064  after load and d
-00022410: 756d 7020 6167 6169 6e2e 2222 220a 2020  ump again.""".  
-00022420: 2020 2020 2020 7061 7468 6c69 622e 5061        pathlib.Pa
-00022430: 7468 2827 7e2f 6461 7461 7365 7473 2729  th('~/datasets')
-00022440: 2e65 7870 616e 6475 7365 7228 292e 6d6b  .expanduser().mk
-00022450: 6469 7228 6578 6973 745f 6f6b 3d54 7275  dir(exist_ok=Tru
-00022460: 6529 0a20 2020 2020 2020 2070 6174 686c  e).        pathl
-00022470: 6962 2e50 6174 6828 277e 2f74 6d70 6669  ib.Path('~/tmpfi
-00022480: 6c65 2729 2e65 7870 616e 6475 7365 7228  le').expanduser(
-00022490: 292e 746f 7563 6828 290a 2020 2020 2020  ).touch().      
-000224a0: 2020 7061 7468 6c69 622e 5061 7468 2827    pathlib.Path('
-000224b0: 7e2f 2e73 7368 2729 2e65 7870 616e 6475  ~/.ssh').expandu
-000224c0: 7365 7228 292e 6d6b 6469 7228 6578 6973  ser().mkdir(exis
-000224d0: 745f 6f6b 3d54 7275 6529 0a20 2020 2020  t_ok=True).     
-000224e0: 2020 2070 6174 686c 6962 2e50 6174 6828     pathlib.Path(
-000224f0: 277e 2f2e 7373 682f 6964 5f72 7361 2e70  '~/.ssh/id_rsa.p
-00022500: 7562 2729 2e65 7870 616e 6475 7365 7228  ub').expanduser(
-00022510: 292e 746f 7563 6828 290a 2020 2020 2020  ).touch().      
-00022520: 2020 7061 7468 6c69 622e 5061 7468 2827    pathlib.Path('
-00022530: 7e2f 746d 702d 776f 726b 6469 7227 292e  ~/tmp-workdir').
-00022540: 6578 7061 6e64 7573 6572 2829 2e6d 6b64  expanduser().mkd
-00022550: 6972 2865 7869 7374 5f6f 6b3d 5472 7565  ir(exist_ok=True
-00022560: 290a 2020 2020 2020 2020 7061 7468 6c69  ).        pathli
-00022570: 622e 5061 7468 2827 7e2f 446f 776e 6c6f  b.Path('~/Downlo
-00022580: 6164 732f 7470 7527 292e 6578 7061 6e64  ads/tpu').expand
-00022590: 7573 6572 2829 2e6d 6b64 6972 2870 6172  user().mkdir(par
-000225a0: 656e 7473 3d54 7275 652c 0a20 2020 2020  ents=True,.     
-000225b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000225c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022210: 2020 2020 2020 2020 2028 2775 7466 2d38           ('utf-8
+00022220: 2729 290a 0a20 2020 2020 2020 2023 2043  '))..        # C
+00022230: 6865 636b 2069 6620 746d 702d 6669 6c65  heck if tmp-file
+00022240: 2065 7869 7374 7320 696e 2074 6865 2062   exists in the b
+00022250: 7563 6b65 742f 746d 702d 736f 7572 6365  ucket/tmp-source
+00022260: 2075 7369 6e67 2063 6c69 0a20 2020 2020   using cli.     
+00022270: 2020 206f 7574 203d 2073 7562 7072 6f63     out = subproc
+00022280: 6573 732e 6368 6563 6b5f 6f75 7470 7574  ess.check_output
+00022290: 2873 656c 662e 636c 695f 6c73 5f63 6d64  (self.cli_ls_cmd
+000222a0: 280a 2020 2020 2020 2020 2020 2020 7374  (.            st
+000222b0: 6f72 655f 7479 7065 2c20 746d 705f 6c6f  ore_type, tmp_lo
+000222c0: 6361 6c5f 6c69 7374 5f73 746f 7261 6765  cal_list_storage
+000222d0: 5f6f 626a 2e6e 616d 652c 2027 746d 702d  _obj.name, 'tmp-
+000222e0: 736f 7572 6365 2f27 292c 0a20 2020 2020  source/'),.     
+000222f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022310: 2073 6865 6c6c 3d54 7275 6529 0a20 2020   shell=True).   
+00022320: 2020 2020 2061 7373 6572 7420 2774 6d70       assert 'tmp
+00022330: 2d66 696c 6527 2069 6e20 6f75 742e 6465  -file' in out.de
+00022340: 636f 6465 2827 7574 662d 3827 292c 205c  code('utf-8'), \
+00022350: 0a20 2020 2020 2020 2020 2020 2027 4669  .            'Fi
+00022360: 6c65 206e 6f74 2066 6f75 6e64 2069 6e20  le not found in 
+00022370: 6275 636b 6574 202d 206f 7574 7075 7420  bucket - output 
+00022380: 7761 7320 3a20 7b7d 272e 666f 726d 6174  was : {}'.format
+00022390: 286f 7574 2e64 6563 6f64 650a 2020 2020  (out.decode.    
+000223a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000223b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000223c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000223d0: 2020 2020 2020 2020 2020 2020 2827 7574              ('ut
+000223e0: 662d 3827 2929 0a0a 2020 2020 4070 7974  f-8'))..    @pyt
+000223f0: 6573 742e 6d61 726b 2e70 6172 616d 6574  est.mark.paramet
+00022400: 7269 7a65 2827 696e 7661 6c69 645f 6e61  rize('invalid_na
+00022410: 6d65 5f6c 6973 742c 2073 746f 7265 5f74  me_list, store_t
+00022420: 7970 6527 2c0a 2020 2020 2020 2020 2020  ype',.          
+00022430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022440: 2020 205b 2841 5753 5f49 4e56 414c 4944     [(AWS_INVALID
+00022450: 5f4e 414d 4553 2c20 7374 6f72 6167 655f  _NAMES, storage_
+00022460: 6c69 622e 5374 6f72 6554 7970 652e 5333  lib.StoreType.S3
+00022470: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00022480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022490: 2028 4743 535f 494e 5641 4c49 445f 4e41   (GCS_INVALID_NA
+000224a0: 4d45 532c 2073 746f 7261 6765 5f6c 6962  MES, storage_lib
+000224b0: 2e53 746f 7265 5479 7065 2e47 4353 292c  .StoreType.GCS),
+000224c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000224d0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+000224e0: 7974 6573 742e 7061 7261 6d28 4942 4d5f  ytest.param(IBM_
+000224f0: 494e 5641 4c49 445f 4e41 4d45 532c 0a20  INVALID_NAMES,. 
+00022500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022520: 2020 2020 2020 2020 2020 7374 6f72 6167            storag
+00022530: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
+00022540: 4942 4d2c 0a20 2020 2020 2020 2020 2020  IBM,.           
+00022550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022570: 6d61 726b 733d 7079 7465 7374 2e6d 6172  marks=pytest.mar
+00022580: 6b2e 6962 6d29 2c0a 2020 2020 2020 2020  k.ibm),.        
+00022590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000225a0: 2020 2020 2020 7079 7465 7374 2e70 6172        pytest.par
+000225b0: 616d 2841 5753 5f49 4e56 414c 4944 5f4e  am(AWS_INVALID_N
+000225c0: 414d 4553 2c0a 2020 2020 2020 2020 2020  AMES,.          
 000225d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000225e0: 2020 2020 2020 6578 6973 745f 6f6b 3d54        exist_ok=T
-000225f0: 7275 6529 0a20 2020 2020 2020 2066 6f72  rue).        for
-00022600: 2079 616d 6c5f 7061 7468 2069 6e20 7365   yaml_path in se
-00022610: 6c66 2e5f 5445 5354 5f59 414d 4c5f 5041  lf._TEST_YAML_PA
-00022620: 5448 533a 0a20 2020 2020 2020 2020 2020  THS:.           
-00022630: 2073 656c 662e 5f63 6865 636b 5f65 7175   self._check_equ
-00022640: 6976 616c 656e 7428 7961 6d6c 5f70 6174  ivalent(yaml_pat
-00022650: 6829 0a                                  h).
+000225e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000225f0: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
+00022600: 7265 5479 7065 2e52 322c 0a20 2020 2020  reType.R2,.     
+00022610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022630: 2020 2020 2020 6d61 726b 733d 7079 7465        marks=pyte
+00022640: 7374 2e6d 6172 6b2e 636c 6f75 6466 6c61  st.mark.cloudfla
+00022650: 7265 295d 290a 2020 2020 6465 6620 7465  re)]).    def te
+00022660: 7374 5f69 6e76 616c 6964 5f6e 616d 6573  st_invalid_names
+00022670: 2873 656c 662c 2069 6e76 616c 6964 5f6e  (self, invalid_n
+00022680: 616d 655f 6c69 7374 2c20 7374 6f72 655f  ame_list, store_
+00022690: 7479 7065 293a 0a20 2020 2020 2020 2023  type):.        #
+000226a0: 2055 7365 7320 6120 6c69 7374 2069 6e20   Uses a list in 
+000226b0: 7468 6520 736f 7572 6365 2066 6965 6c64  the source field
+000226c0: 2074 6f20 7370 6563 6966 7920 6120 6669   to specify a fi
+000226d0: 6c65 2061 6e64 2061 2064 6972 6563 746f  le and a directo
+000226e0: 7279 2074 6f0a 2020 2020 2020 2020 2320  ry to.        # 
+000226f0: 6265 2075 706c 6f61 6465 6420 746f 2074  be uploaded to t
+00022700: 6865 2073 746f 7261 6765 206f 626a 6563  he storage objec
+00022710: 742e 0a20 2020 2020 2020 2066 6f72 206e  t..        for n
+00022720: 616d 6520 696e 2069 6e76 616c 6964 5f6e  ame in invalid_n
+00022730: 616d 655f 6c69 7374 3a0a 2020 2020 2020  ame_list:.      
+00022740: 2020 2020 2020 7769 7468 2070 7974 6573        with pytes
+00022750: 742e 7261 6973 6573 2873 6b79 2e65 7863  t.raises(sky.exc
+00022760: 6570 7469 6f6e 732e 5374 6f72 6167 654e  eptions.StorageN
+00022770: 616d 6545 7272 6f72 293a 0a20 2020 2020  ameError):.     
+00022780: 2020 2020 2020 2020 2020 2073 746f 7261             stora
+00022790: 6765 5f6f 626a 203d 2073 746f 7261 6765  ge_obj = storage
+000227a0: 5f6c 6962 2e53 746f 7261 6765 286e 616d  _lib.Storage(nam
+000227b0: 653d 6e61 6d65 290a 2020 2020 2020 2020  e=name).        
+000227c0: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
+000227d0: 6f62 6a2e 6164 645f 7374 6f72 6528 7374  obj.add_store(st
+000227e0: 6f72 655f 7479 7065 290a 0a20 2020 2040  ore_type)..    @
+000227f0: 7079 7465 7374 2e6d 6172 6b2e 7061 7261  pytest.mark.para
+00022800: 6d65 7472 697a 6528 0a20 2020 2020 2020  metrize(.       
+00022810: 2027 6769 7469 676e 6f72 655f 7374 7275   'gitignore_stru
+00022820: 6374 7572 652c 2073 746f 7265 5f74 7970  cture, store_typ
+00022830: 6527 2c0a 2020 2020 2020 2020 5b28 4749  e',.        [(GI
+00022840: 5449 474e 4f52 455f 5359 4e43 5f54 4553  TIGNORE_SYNC_TES
+00022850: 545f 4449 525f 5354 5255 4354 5552 452c  T_DIR_STRUCTURE,
+00022860: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
+00022870: 7265 5479 7065 2e53 3329 2c0a 2020 2020  reType.S3),.    
+00022880: 2020 2020 2028 4749 5449 474e 4f52 455f       (GITIGNORE_
+00022890: 5359 4e43 5f54 4553 545f 4449 525f 5354  SYNC_TEST_DIR_ST
+000228a0: 5255 4354 5552 452c 2073 746f 7261 6765  RUCTURE, storage
+000228b0: 5f6c 6962 2e53 746f 7265 5479 7065 2e47  _lib.StoreType.G
+000228c0: 4353 292c 0a20 2020 2020 2020 2020 7079  CS),.         py
+000228d0: 7465 7374 2e70 6172 616d 2847 4954 4947  test.param(GITIG
+000228e0: 4e4f 5245 5f53 594e 435f 5445 5354 5f44  NORE_SYNC_TEST_D
+000228f0: 4952 5f53 5452 5543 5455 5245 2c0a 2020  IR_STRUCTURE,.  
+00022900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022910: 2020 2020 7374 6f72 6167 655f 6c69 622e      storage_lib.
+00022920: 5374 6f72 6554 7970 652e 5232 2c0a 2020  StoreType.R2,.  
+00022930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022940: 2020 2020 6d61 726b 733d 7079 7465 7374      marks=pytest
+00022950: 2e6d 6172 6b2e 636c 6f75 6466 6c61 7265  .mark.cloudflare
+00022960: 295d 290a 2020 2020 6465 6620 7465 7374  )]).    def test
+00022970: 5f65 7863 6c75 6465 645f 6669 6c65 5f63  _excluded_file_c
+00022980: 6c6f 7564 5f73 746f 7261 6765 5f75 706c  loud_storage_upl
+00022990: 6f61 645f 636f 7079 2873 656c 662c 2067  oad_copy(self, g
+000229a0: 6974 6967 6e6f 7265 5f73 7472 7563 7475  itignore_structu
+000229b0: 7265 2c0a 2020 2020 2020 2020 2020 2020  re,.            
+000229c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000229d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000229e0: 2020 2020 2020 2020 2073 746f 7265 5f74           store_t
+000229f0: 7970 652c 0a20 2020 2020 2020 2020 2020  ype,.           
+00022a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022a20: 2020 2020 2020 2020 2020 746d 705f 6769            tmp_gi
+00022a30: 7469 676e 6f72 655f 7374 6f72 6167 655f  tignore_storage_
+00022a40: 6f62 6a29 3a0a 2020 2020 2020 2020 2320  obj):.        # 
+00022a50: 7465 7374 7320 6966 2066 696c 6573 2069  tests if files i
+00022a60: 6e63 6c75 6465 6420 696e 202e 6769 7469  ncluded in .giti
+00022a70: 676e 6f72 6520 616e 6420 2e67 6974 2f69  gnore and .git/i
+00022a80: 6e66 6f2f 6578 636c 7564 6520 6172 650a  nfo/exclude are.
+00022a90: 2020 2020 2020 2020 2320 6578 636c 7564          # exclud
+00022aa0: 6564 2066 726f 6d20 6265 696e 6720 7472  ed from being tr
+00022ab0: 616e 7366 6572 7265 6420 746f 2053 746f  ansferred to Sto
+00022ac0: 7261 6765 0a0a 2020 2020 2020 2020 746d  rage..        tm
+00022ad0: 705f 6769 7469 676e 6f72 655f 7374 6f72  p_gitignore_stor
+00022ae0: 6167 655f 6f62 6a2e 6164 645f 7374 6f72  age_obj.add_stor
+00022af0: 6528 7374 6f72 655f 7479 7065 290a 0a20  e(store_type).. 
+00022b00: 2020 2020 2020 2075 706c 6f61 645f 6669         upload_fi
+00022b10: 6c65 5f6e 616d 6520 3d20 2769 6e63 6c75  le_name = 'inclu
+00022b20: 6465 6427 0a20 2020 2020 2020 2023 2043  ded'.        # C
+00022b30: 6f75 6e74 2074 6865 206e 756d 6265 7220  ount the number 
+00022b40: 6f66 2066 696c 6573 2077 6974 6820 7468  of files with th
+00022b50: 6520 6769 7665 6e20 6669 6c65 206e 616d  e given file nam
+00022b60: 650a 2020 2020 2020 2020 7570 5f63 6d64  e.        up_cmd
+00022b70: 203d 2073 656c 662e 636c 695f 636f 756e   = self.cli_coun
+00022b80: 745f 6e61 6d65 5f69 6e5f 6275 636b 6574  t_name_in_bucket
+00022b90: 2873 746f 7265 5f74 7970 652c 205c 0a20  (store_type, \. 
+00022ba0: 2020 2020 2020 2020 2020 2074 6d70 5f67             tmp_g
+00022bb0: 6974 6967 6e6f 7265 5f73 746f 7261 6765  itignore_storage
+00022bc0: 5f6f 626a 2e6e 616d 652c 2066 696c 655f  _obj.name, file_
+00022bd0: 6e61 6d65 3d75 706c 6f61 645f 6669 6c65  name=upload_file
+00022be0: 5f6e 616d 6529 0a20 2020 2020 2020 2067  _name).        g
+00022bf0: 6974 5f65 7863 6c75 6465 5f63 6d64 203d  it_exclude_cmd =
+00022c00: 2073 656c 662e 636c 695f 636f 756e 745f   self.cli_count_
+00022c10: 6e61 6d65 5f69 6e5f 6275 636b 6574 2873  name_in_bucket(s
+00022c20: 746f 7265 5f74 7970 652c 205c 0a20 2020  tore_type, \.   
+00022c30: 2020 2020 2020 2020 2074 6d70 5f67 6974           tmp_git
+00022c40: 6967 6e6f 7265 5f73 746f 7261 6765 5f6f  ignore_storage_o
+00022c50: 626a 2e6e 616d 652c 2066 696c 655f 6e61  bj.name, file_na
+00022c60: 6d65 3d27 2e67 6974 2729 0a20 2020 2020  me='.git').     
+00022c70: 2020 2063 6e74 5f6e 756d 5f66 696c 655f     cnt_num_file_
+00022c80: 636d 6420 3d20 7365 6c66 2e63 6c69 5f63  cmd = self.cli_c
+00022c90: 6f75 6e74 5f66 696c 655f 696e 5f62 7563  ount_file_in_buc
+00022ca0: 6b65 7428 0a20 2020 2020 2020 2020 2020  ket(.           
+00022cb0: 2073 746f 7265 5f74 7970 652c 2074 6d70   store_type, tmp
+00022cc0: 5f67 6974 6967 6e6f 7265 5f73 746f 7261  _gitignore_stora
+00022cd0: 6765 5f6f 626a 2e6e 616d 6529 0a0a 2020  ge_obj.name)..  
+00022ce0: 2020 2020 2020 7570 5f6f 7574 7075 7420        up_output 
+00022cf0: 3d20 7375 6270 726f 6365 7373 2e63 6865  = subprocess.che
+00022d00: 636b 5f6f 7574 7075 7428 7570 5f63 6d64  ck_output(up_cmd
+00022d10: 2c20 7368 656c 6c3d 5472 7565 290a 2020  , shell=True).  
+00022d20: 2020 2020 2020 6769 745f 6578 636c 7564        git_exclud
+00022d30: 655f 6f75 7470 7574 203d 2073 7562 7072  e_output = subpr
+00022d40: 6f63 6573 732e 6368 6563 6b5f 6f75 7470  ocess.check_outp
+00022d50: 7574 2867 6974 5f65 7863 6c75 6465 5f63  ut(git_exclude_c
+00022d60: 6d64 2c0a 2020 2020 2020 2020 2020 2020  md,.            
+00022d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022d90: 2020 2020 2020 2020 2073 6865 6c6c 3d54           shell=T
+00022da0: 7275 6529 0a20 2020 2020 2020 2063 6e74  rue).        cnt
+00022db0: 5f6f 7574 7075 7420 3d20 7375 6270 726f  _output = subpro
+00022dc0: 6365 7373 2e63 6865 636b 5f6f 7574 7075  cess.check_outpu
+00022dd0: 7428 636e 745f 6e75 6d5f 6669 6c65 5f63  t(cnt_num_file_c
+00022de0: 6d64 2c20 7368 656c 6c3d 5472 7565 290a  md, shell=True).
+00022df0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+00022e00: 2733 2720 696e 2075 705f 6f75 7470 7574  '3' in up_output
+00022e10: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
+00022e20: 2c20 5c0a 2020 2020 2020 2020 2020 2020  , \.            
+00022e30: 2020 2020 2746 696c 6573 2074 6f20 6265      'Files to be
+00022e40: 2069 6e63 6c75 6465 6420 6172 6520 6e6f   included are no
+00022e50: 7420 636f 6d70 6c65 7465 6c79 2075 706c  t completely upl
+00022e60: 6f61 6465 642e 270a 2020 2020 2020 2020  oaded.'.        
+00022e70: 2320 3120 6973 2072 6561 6420 6173 202e  # 1 is read as .
+00022e80: 6769 7469 676e 6f72 6520 6973 2075 706c  gitignore is upl
+00022e90: 6f61 6465 640a 2020 2020 2020 2020 6173  oaded.        as
+00022ea0: 7365 7274 2027 3127 2069 6e20 6769 745f  sert '1' in git_
+00022eb0: 6578 636c 7564 655f 6f75 7470 7574 2e64  exclude_output.d
+00022ec0: 6563 6f64 6528 2775 7466 2d38 2729 2c20  ecode('utf-8'), 
+00022ed0: 5c0a 2020 2020 2020 2020 2020 2020 2020  \.              
+00022ee0: 2027 2e67 6974 2064 6972 6563 746f 7279   '.git directory
+00022ef0: 2073 686f 756c 6420 6e6f 7420 6265 2075   should not be u
+00022f00: 706c 6f61 6465 642e 270a 2020 2020 2020  ploaded.'.      
+00022f10: 2020 2320 3420 6669 6c65 7320 696e 636c    # 4 files incl
+00022f20: 7564 6520 2e67 6974 6967 6e6f 7265 2c20  ude .gitignore, 
+00022f30: 696e 636c 7564 6564 2e6c 6f67 2c20 696e  included.log, in
+00022f40: 636c 7564 6564 2e74 7874 2c20 696e 636c  cluded.txt, incl
+00022f50: 7564 655f 6469 722f 696e 636c 7564 6564  ude_dir/included
+00022f60: 2e6c 6f67 0a20 2020 2020 2020 2061 7373  .log.        ass
+00022f70: 6572 7420 2734 2720 696e 2063 6e74 5f6f  ert '4' in cnt_o
+00022f80: 7574 7075 742e 6465 636f 6465 2827 7574  utput.decode('ut
+00022f90: 662d 3827 292c 205c 0a20 2020 2020 2020  f-8'), \.       
+00022fa0: 2020 2020 2020 2020 2753 6f6d 6520 6974          'Some it
+00022fb0: 656d 7320 6c69 7374 6564 2069 6e20 2e67  ems listed in .g
+00022fc0: 6974 6967 6e6f 7265 2061 6e64 202e 6769  itignore and .gi
+00022fd0: 742f 696e 666f 2f65 7863 6c75 6465 2061  t/info/exclude a
+00022fe0: 7265 206e 6f74 2065 7863 6c75 6465 642e  re not excluded.
+00022ff0: 270a 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d  '...# ----------
+00023000: 2054 6573 7469 6e67 2059 414d 4c20 5370   Testing YAML Sp
+00023010: 6563 7320 2d2d 2d2d 2d2d 2d2d 2d2d 0a23  ecs ----------.#
+00023020: 204f 7572 2073 6b79 2073 746f 7261 6765   Our sky storage
+00023030: 2072 6571 7569 7265 7320 6372 6564 656e   requires creden
+00023040: 7469 616c 7320 746f 2063 6865 636b 2074  tials to check t
+00023050: 6865 2062 7563 6b65 7420 6578 6973 7461  he bucket exista
+00023060: 6e63 6520 7768 656e 0a23 206c 6f61 6469  nce when.# loadi
+00023070: 6e67 2061 2074 6173 6b20 6672 6f6d 2074  ng a task from t
+00023080: 6865 2079 616d 6c20 6669 6c65 2c20 736f  he yaml file, so
+00023090: 2077 6520 6361 6e6e 6f74 206d 616b 6520   we cannot make 
+000230a0: 6974 2061 2075 6e69 7420 7465 7374 2e0a  it a unit test..
+000230b0: 636c 6173 7320 5465 7374 5961 6d6c 5370  class TestYamlSp
+000230c0: 6563 733a 0a20 2020 2023 2054 4f44 4f28  ecs:.    # TODO(
+000230d0: 7a68 7775 293a 2041 6464 2074 6573 7420  zhwu): Add test 
+000230e0: 666f 7220 6074 6f5f 7961 6d6c 5f63 6f6e  for `to_yaml_con
+000230f0: 6669 6760 2066 6f72 2074 6865 2053 746f  fig` for the Sto
+00023100: 7261 6765 206f 626a 6563 742e 0a20 2020  rage object..   
+00023110: 2023 2020 5765 2073 686f 756c 6420 6e6f   #  We should no
+00023120: 7420 7573 6520 6065 7861 6d70 6c65 732f  t use `examples/
+00023130: 7374 6f72 6167 655f 6465 6d6f 2e79 616d  storage_demo.yam
+00023140: 6c60 2068 6572 652c 2073 696e 6365 2069  l` here, since i
+00023150: 7420 7265 7175 6972 6573 0a20 2020 2023  t requires.    #
+00023160: 2020 7573 6572 7320 746f 2065 6e73 7572    users to ensur
+00023170: 6520 6275 636b 6574 206e 616d 6573 2074  e bucket names t
+00023180: 6f20 6e6f 7420 6578 6973 7420 616e 642f  o not exist and/
+00023190: 6f72 2062 6520 756e 6971 7565 2e0a 2020  or be unique..  
+000231a0: 2020 5f54 4553 545f 5941 4d4c 5f50 4154    _TEST_YAML_PAT
+000231b0: 4853 203d 205b 0a20 2020 2020 2020 2027  HS = [.        '
+000231c0: 6578 616d 706c 6573 2f6d 696e 696d 616c  examples/minimal
+000231d0: 2e79 616d 6c27 2c20 2765 7861 6d70 6c65  .yaml', 'example
+000231e0: 732f 6d61 6e61 6765 645f 7370 6f74 2e79  s/managed_spot.y
+000231f0: 616d 6c27 2c0a 2020 2020 2020 2020 2765  aml',.        'e
+00023200: 7861 6d70 6c65 732f 7573 696e 675f 6669  xamples/using_fi
+00023210: 6c65 5f6d 6f75 6e74 732e 7961 6d6c 272c  le_mounts.yaml',
+00023220: 2027 6578 616d 706c 6573 2f72 6573 6e65   'examples/resne
+00023230: 745f 6170 702e 7961 6d6c 272c 0a20 2020  t_app.yaml',.   
+00023240: 2020 2020 2027 6578 616d 706c 6573 2f6d       'examples/m
+00023250: 756c 7469 5f68 6f73 746e 616d 652e 7961  ulti_hostname.ya
+00023260: 6d6c 270a 2020 2020 5d0a 0a20 2020 2064  ml'.    ]..    d
+00023270: 6566 205f 6973 5f64 6963 745f 7375 6273  ef _is_dict_subs
+00023280: 6574 2873 656c 662c 2064 312c 2064 3229  et(self, d1, d2)
+00023290: 3a0a 2020 2020 2020 2020 2222 2243 6865  :.        """Che
+000232a0: 636b 2069 6620 6431 2069 7320 7468 6520  ck if d1 is the 
+000232b0: 7375 6273 6574 206f 6620 6432 2e22 2222  subset of d2."""
+000232c0: 0a20 2020 2020 2020 2066 6f72 206b 2c20  .        for k, 
+000232d0: 7620 696e 2064 312e 6974 656d 7328 293a  v in d1.items():
+000232e0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+000232f0: 6b20 6e6f 7420 696e 2064 323a 0a20 2020  k not in d2:.   
+00023300: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00023310: 6973 696e 7374 616e 6365 2876 2c20 6c69  isinstance(v, li
+00023320: 7374 2920 6f72 2069 7369 6e73 7461 6e63  st) or isinstanc
+00023330: 6528 762c 2064 6963 7429 3a0a 2020 2020  e(v, dict):.    
+00023340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023350: 6173 7365 7274 206c 656e 2876 2920 3d3d  assert len(v) ==
+00023360: 2030 2c20 286b 2c20 7629 0a20 2020 2020   0, (k, v).     
+00023370: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00023380: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023390: 2020 2020 2061 7373 6572 7420 4661 6c73       assert Fals
+000233a0: 652c 2028 6b2c 2076 290a 2020 2020 2020  e, (k, v).      
+000233b0: 2020 2020 2020 656c 6966 2069 7369 6e73        elif isins
+000233c0: 7461 6e63 6528 762c 2064 6963 7429 3a0a  tance(v, dict):.
+000233d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000233e0: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
+000233f0: 6528 6432 5b6b 5d2c 2064 6963 7429 2c20  e(d2[k], dict), 
+00023400: 286b 2c20 762c 2064 3229 0a20 2020 2020  (k, v, d2).     
+00023410: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00023420: 5f69 735f 6469 6374 5f73 7562 7365 7428  _is_dict_subset(
+00023430: 762c 2064 325b 6b5d 290a 2020 2020 2020  v, d2[k]).      
+00023440: 2020 2020 2020 656c 6966 2069 7369 6e73        elif isins
+00023450: 7461 6e63 6528 762c 2073 7472 293a 0a20  tance(v, str):. 
+00023460: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00023470: 6620 6b20 3d3d 2027 6163 6365 6c65 7261  f k == 'accelera
+00023480: 746f 7273 273a 0a20 2020 2020 2020 2020  tors':.         
+00023490: 2020 2020 2020 2020 2020 2072 6573 6f75             resou
+000234a0: 7263 6573 203d 2073 6b79 2e52 6573 6f75  rces = sky.Resou
+000234b0: 7263 6573 2829 0a20 2020 2020 2020 2020  rces().         
+000234c0: 2020 2020 2020 2020 2020 2072 6573 6f75             resou
+000234d0: 7263 6573 2e5f 7365 745f 6163 6365 6c65  rces._set_accele
+000234e0: 7261 746f 7273 2876 2c20 4e6f 6e65 290a  rators(v, None).
+000234f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023500: 2020 2020 6173 7365 7274 2072 6573 6f75      assert resou
+00023510: 7263 6573 2e61 6363 656c 6572 6174 6f72  rces.accelerator
+00023520: 7320 3d3d 2064 325b 6b5d 2c20 286b 2c20  s == d2[k], (k, 
+00023530: 762c 2064 3229 0a20 2020 2020 2020 2020  v, d2).         
+00023540: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00023550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023560: 2061 7373 6572 7420 762e 6c6f 7765 7228   assert v.lower(
+00023570: 2920 3d3d 2064 325b 6b5d 2e6c 6f77 6572  ) == d2[k].lower
+00023580: 2829 2c20 286b 2c20 762c 2064 325b 6b5d  (), (k, v, d2[k]
+00023590: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
+000235a0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+000235b0: 2020 2020 6173 7365 7274 2076 203d 3d20      assert v == 
+000235c0: 6432 5b6b 5d2c 2028 6b2c 2076 2c20 6432  d2[k], (k, v, d2
+000235d0: 5b6b 5d29 0a0a 2020 2020 6465 6620 5f63  [k])..    def _c
+000235e0: 6865 636b 5f65 7175 6976 616c 656e 7428  heck_equivalent(
+000235f0: 7365 6c66 2c20 7961 6d6c 5f70 6174 6829  self, yaml_path)
+00023600: 3a0a 2020 2020 2020 2020 2222 2243 6865  :.        """Che
+00023610: 636b 2069 6620 7468 6520 7961 6d6c 2069  ck if the yaml i
+00023620: 7320 6571 7569 7661 6c65 6e74 2061 6674  s equivalent aft
+00023630: 6572 206c 6f61 6420 616e 6420 6475 6d70  er load and dump
+00023640: 2061 6761 696e 2e22 2222 0a20 2020 2020   again.""".     
+00023650: 2020 206f 7269 6769 6e5f 7461 736b 5f63     origin_task_c
+00023660: 6f6e 6669 6720 3d20 636f 6d6d 6f6e 5f75  onfig = common_u
+00023670: 7469 6c73 2e72 6561 645f 7961 6d6c 2879  tils.read_yaml(y
+00023680: 616d 6c5f 7061 7468 290a 0a20 2020 2020  aml_path)..     
+00023690: 2020 2074 6173 6b20 3d20 736b 792e 5461     task = sky.Ta
+000236a0: 736b 2e66 726f 6d5f 7961 6d6c 2879 616d  sk.from_yaml(yam
+000236b0: 6c5f 7061 7468 290a 2020 2020 2020 2020  l_path).        
+000236c0: 6e65 775f 7461 736b 5f63 6f6e 6669 6720  new_task_config 
+000236d0: 3d20 7461 736b 2e74 6f5f 7961 6d6c 5f63  = task.to_yaml_c
+000236e0: 6f6e 6669 6728 290a 2020 2020 2020 2020  onfig().        
+000236f0: 2320 6431 203c 3d20 6432 0a20 2020 2020  # d1 <= d2.     
+00023700: 2020 2073 656c 662e 5f69 735f 6469 6374     self._is_dict
+00023710: 5f73 7562 7365 7428 6f72 6967 696e 5f74  _subset(origin_t
+00023720: 6173 6b5f 636f 6e66 6967 2c20 6e65 775f  ask_config, new_
+00023730: 7461 736b 5f63 6f6e 6669 6729 0a0a 2020  task_config)..  
+00023740: 2020 6465 6620 7465 7374 5f6c 6f61 645f    def test_load_
+00023750: 6475 6d70 5f79 616d 6c5f 636f 6e66 6967  dump_yaml_config
+00023760: 5f65 7175 6976 616c 656e 7428 7365 6c66  _equivalent(self
+00023770: 293a 0a20 2020 2020 2020 2022 2222 5465  ):.        """Te
+00023780: 7374 2069 6620 7468 6520 7961 6d6c 2063  st if the yaml c
+00023790: 6f6e 6669 6720 6973 2065 7175 6976 616c  onfig is equival
+000237a0: 656e 7420 6166 7465 7220 6c6f 6164 2061  ent after load a
+000237b0: 6e64 2064 756d 7020 6167 6169 6e2e 2222  nd dump again.""
+000237c0: 220a 2020 2020 2020 2020 7061 7468 6c69  ".        pathli
+000237d0: 622e 5061 7468 2827 7e2f 6461 7461 7365  b.Path('~/datase
+000237e0: 7473 2729 2e65 7870 616e 6475 7365 7228  ts').expanduser(
+000237f0: 292e 6d6b 6469 7228 6578 6973 745f 6f6b  ).mkdir(exist_ok
+00023800: 3d54 7275 6529 0a20 2020 2020 2020 2070  =True).        p
+00023810: 6174 686c 6962 2e50 6174 6828 277e 2f74  athlib.Path('~/t
+00023820: 6d70 6669 6c65 2729 2e65 7870 616e 6475  mpfile').expandu
+00023830: 7365 7228 292e 746f 7563 6828 290a 2020  ser().touch().  
+00023840: 2020 2020 2020 7061 7468 6c69 622e 5061        pathlib.Pa
+00023850: 7468 2827 7e2f 2e73 7368 2729 2e65 7870  th('~/.ssh').exp
+00023860: 616e 6475 7365 7228 292e 6d6b 6469 7228  anduser().mkdir(
+00023870: 6578 6973 745f 6f6b 3d54 7275 6529 0a20  exist_ok=True). 
+00023880: 2020 2020 2020 2070 6174 686c 6962 2e50         pathlib.P
+00023890: 6174 6828 277e 2f2e 7373 682f 6964 5f72  ath('~/.ssh/id_r
+000238a0: 7361 2e70 7562 2729 2e65 7870 616e 6475  sa.pub').expandu
+000238b0: 7365 7228 292e 746f 7563 6828 290a 2020  ser().touch().  
+000238c0: 2020 2020 2020 7061 7468 6c69 622e 5061        pathlib.Pa
+000238d0: 7468 2827 7e2f 746d 702d 776f 726b 6469  th('~/tmp-workdi
+000238e0: 7227 292e 6578 7061 6e64 7573 6572 2829  r').expanduser()
+000238f0: 2e6d 6b64 6972 2865 7869 7374 5f6f 6b3d  .mkdir(exist_ok=
+00023900: 5472 7565 290a 2020 2020 2020 2020 7061  True).        pa
+00023910: 7468 6c69 622e 5061 7468 2827 7e2f 446f  thlib.Path('~/Do
+00023920: 776e 6c6f 6164 732f 7470 7527 292e 6578  wnloads/tpu').ex
+00023930: 7061 6e64 7573 6572 2829 2e6d 6b64 6972  panduser().mkdir
+00023940: 2870 6172 656e 7473 3d54 7275 652c 0a20  (parents=True,. 
+00023950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023980: 2020 2020 2020 2020 2020 6578 6973 745f            exist_
+00023990: 6f6b 3d54 7275 6529 0a20 2020 2020 2020  ok=True).       
+000239a0: 2066 6f72 2079 616d 6c5f 7061 7468 2069   for yaml_path i
+000239b0: 6e20 7365 6c66 2e5f 5445 5354 5f59 414d  n self._TEST_YAM
+000239c0: 4c5f 5041 5448 533a 0a20 2020 2020 2020  L_PATHS:.       
+000239d0: 2020 2020 2073 656c 662e 5f63 6865 636b       self._check
+000239e0: 5f65 7175 6976 616c 656e 7428 7961 6d6c  _equivalent(yaml
+000239f0: 5f70 6174 6829 0a                        _path).
```

### Comparing `skypilot-nightly-1.0.0.dev20230802/tests/test_spot.py` & `skypilot-nightly-1.0.0.dev20230803/tests/test_spot.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/tests/test_storage.py` & `skypilot-nightly-1.0.0.dev20230803/tests/test_storage.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230802/tests/test_wheels.py` & `skypilot-nightly-1.0.0.dev20230803/tests/test_wheels.py`

 * *Files identical despite different names*

